(()=>{var ds=Object.defineProperty;var u=(t,e)=>ds(t,"name",{value:e,configurable:!0});var ps="Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo";async function it(t){function e(d){ChatMessage.create({user:game.user.id,content:d,speaker:ChatMessage.getSpeaker({actor:t})})}u(e,"toChat");let{name:i,attributes:s,system:n}=t,r=s.hp.sp,o=n.resources.resolve,c=C("hud.resolve.full",{name:i}),a=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:i});if(r.value===r.max)return ui.notifications.warn(c);if(o.value<1)return ui.notifications.warn(a);let l=t.itemTypes.feat.find(d=>d.sourceId===ps),m=await renderTemplate(F("dialogs/resolve"),{hasSteel:l,i18n:d=>C(`hud.resolve.${d}`)});new Dialog({title:C("hud.resolve.title"),content:m,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:C("hud.resolve.yes"),callback:async d=>{let{attributes:p,system:f}=t,g=p.hp.sp,w=f.resources.resolve;if(g.value===g.max)return e(c);if(w.value<1)return e(a);let h=d.find("input:checked").val(),v=`${g.value}/${g.max}`;if(h==="breather")e(C("hud.resolve.breather.used",{name:i,ratio:v})),await t.update({"system.attributes.hp.sp.value":g.max,"system.resources.resolve.value":w.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:i,ratio:v}));let b=g.value+Math.floor(g.max/2);await t.update({"system.attributes.hp.sp.value":Math.min(b,g.max),"system.resources.resolve.value":w.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:C("hud.resolve.no")}}}).render(!0)}u(it,"useResolve");function nt(){return CONFIG.Dice.rolls.find(t=>t.name==="DamageRoll")}u(nt,"getDamageRollClass");function Q(){return CONFIG.ChatMessage.documentClass}u(Q,"getChatMessageClass");function at(){return CONFIG.MeasuredTemplate.documentClass}u(at,"getMeasuredTemplateDocumentClass");function ot(){return CONFIG.MeasuredTemplate.objectClass}u(ot,"getMeasuredTemplateObjectClass");var ms=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),fs=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function gs(t,e="normal"){return t+(ms.get(e)??0)}u(gs,"adjustDC");function hs(t="common"){switch(t){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}u(hs,"rarityToDCAdjustment");function be(t,e="common"){return gs(t,hs(e))}u(be,"adjustDCByRarity");function we(t,{proficiencyWithoutLevel:e,rarity:i="common"}={}){let s=game.settings.get("pf2e","proficiencyVariant");e??=s==="ProficiencyWithoutLevel";let n=fs.get(t)??14;return be(e?n-Math.max(t,0):n,i)}u(we,"calculateDC");function le(t,e){return t instanceof Element||t instanceof Document?Array.from(t.querySelectorAll(e)):[]}u(le,"htmlQueryAll");function He(t,e){return t instanceof Element?t.closest(e):null}u(He,"htmlClosest");var rt={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"},ys={0:"F",free:"F",1:"A",2:"D",3:"T","1 or 2":"A/D","1 to 3":"A - T","2 or 3":"D/T",reaction:"R"};function ct(t,e="systems/pf2e/icons/actions/Empty.webp"){if(t===null)return rt.passive;let i=typeof t!="object"?t:t.type==="action"?t.value:t.type,s=String(i??"").toLowerCase().trim();return rt[s]??e}u(ct,"getActionIcon");function ve(t){if(!t&&t!==0)return"";let e=typeof t!="object"?t:t.type==="action"?t.value:t.type,i=String(e??"").toLowerCase().trim();return ys[i]??""}u(ve,"getActionGlyph");function ue(t){return Error(`PF2e System | ${t}`)}u(ue,"ErrorPF2e");function lt(t,e){return t.includes(e)}u(lt,"tupleHasValue");function bs(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}u(bs,"objectHasKey");var ke=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,_e=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,ws=new RegExp(_e,"gu"),ks=String.raw`(?:${ke})(?=${_e})|(?:${_e})(?=${ke})`,vs=String.raw`(?:${ke})(?=${ke})`,ut=String.raw`\p{Lowercase_Letter}`,dt=String.raw`\p{Uppercase_Letter}`,Is=new RegExp(`(${ut})(${dt}${vs})`,"gu"),Cs=/[^-\p{White_Space}\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]/gu,Ss=new RegExp(`${dt}|(?:${ks})${ut}`,"gu");function je(t,{camel:e=null}={}){if(typeof t!="string")return console.warn("Non-string argument passed to `sluggify`"),"";if(t==="-")return t;switch(e){case null:return t.replace(Is,"$1-$2").toLowerCase().replace(/['â€™]/g,"").replace(ws," ").trim().replace(/[-\s]+/g,"-");case"bactrian":{let i=je(t,{camel:"dromedary"});return i.charAt(0).toUpperCase()+i.slice(1)}case"dromedary":return t.replace(Cs,"").replace(/[-_]+/g," ").replace(Ss,(i,s)=>s===0?i.toLowerCase():i.toUpperCase()).replace(/\s+/g,"");default:throw ue("I don't think that's a real camel.")}}u(je,"sluggify");function pt(t,e){let i={name:t,label:game.i18n.localize(e[t]??t)};return bs(CONFIG.PF2E.traitsDescriptions,t)&&(i.description=CONFIG.PF2E.traitsDescriptions[t]),i}u(pt,"traitSlugToObject");function Ts(t){return!!t&&"ctrlKey"in t&&"metaKey"in t&&"shiftKey"in t}u(Ts,"isRelevantEvent");function Ie(t){let e=!game.user.settings.showRollDialogs;if(!Ts(t))return{skipDialog:e};let i={skipDialog:t.shiftKey?!e:e};return(t.ctrlKey||t.metaKey)&&(i.rollMode=game.user.isGM?"gmroll":"blindroll"),i}u(Ie,"eventToRollParams");var Es=["fortitude","reflex","will"],ft=["action","check","effect-area"].map(t=>`[data-pf2-${t}]`).join(",");function Ds(t,e){for(let i of t){(!e||e.isOwner)&&i.classList.add("with-repost");let s=le(i,"i[data-pf2-repost]");if(s.length>0){if(e&&!e.isOwner){for(let o of s)o.remove();i.classList.remove("with-repost")}continue}if(e&&!e.isOwner)continue;let n=document.createElement("i"),r=i.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";n.classList.add("fa-solid",r),n.dataset.pf2Repost="",n.title=game.i18n.localize("PF2E.Repost"),i.appendChild(n),n.addEventListener("click",o=>{o.stopPropagation();let c=o.target;if(!(c instanceof HTMLElement))return;let a=c?.parentElement;if(!a)return;let l=gt(c,e);As(a,l)})}}u(Ds,"injectRepostElement");function xs(t,e=null){for(let i of le(t,"a.inline-roll[data-damage-roll]")){let s=He(i,"[data-item-id]")?.dataset.itemId,n=e?.items.get(s??"");n&&(i.dataset.flavor||=n.name)}}u(xs,"flavorDamageRolls");function mt(t,e){let i=t.attributes.getNamedItem("data-pf2-repost-flavor")?.value??"";return`<span data-visibility="${t.attributes.getNamedItem("data-pf2-show-dc")?.value??e}">${i}</span> ${t.outerHTML}`.trim()}u(mt,"makeRepostHtml");function As(t,e=null){if(!["pf2Action","pf2Check","pf2EffectArea"].some(l=>l in t.dataset))return;let i=ht(e,t),s=(i??e)?.hasPlayerOwner?"all":"gm",n=(()=>t.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${le(t.parentElement,ft).map(m=>mt(m,s)).join("<br>")}</div>`:mt(t,s))(),r=Q(),o=i?r.getSpeaker({actor:i,token:i.getActiveTokens(!1,!0).shift()}):r.getSpeaker(),c=game.messages.get(He(t,"[data-message-id]")?.dataset.messageId??""),a=e instanceof JournalEntry?{pf2e:{journalEntry:e.uuid}}:c?.flags.pf2e.origin?{pf2e:{origin:deepClone(c.flags.pf2e.origin)}}:{};r.create({speaker:o,content:n,flags:a})}u(As,"repostAction");function Se(t,e){e??=gt(t,e);let i=le(t,ft).filter(n=>["A","SPAN"].includes(n.nodeName));Ds(i,e),xs(t,e instanceof Actor?e:null);for(let n of i.filter(r=>r.dataset.pf2Action)){let{pf2Action:r,pf2Glyph:o,pf2Variant:c,pf2Dc:a,pf2ShowDc:l,pf2Skill:m}=n.dataset;n.addEventListener("click",d=>{let p=game.pf2e.actions[r?je(r,{camel:"dromedary"}):""],f=l??"all";r&&p?p({event:d,glyph:o,variant:c,difficultyClass:a?{scope:"check",value:Number(a)||0,visibility:f}:void 0,skill:m}):console.warn(`PF2e System | Skip executing unknown action '${r}'`)})}for(let n of i.filter(r=>r.dataset.pf2Check&&!r.dataset.invalid)){let{pf2Check:r,pf2Dc:o,pf2Traits:c,pf2Label:a,pf2Defense:l,pf2Adjustment:m,pf2Roller:d,pf2RollOptions:p}=n.dataset;if(!r)return;n.addEventListener("click",async f=>{let g=ht(e,n),w=[g],h=[...c?.split(",").map(b=>b.trim())??[],...p?.split(",").map(b=>b.trim())??[]],v=Ie(f);switch(r){case"flat":{for(let b of w){let E=new Statistic(b,{label:"",slug:"flat",modifiers:[],check:{type:"flat-check"}}),D=Number.isInteger(Number(o))?{label:a,value:Number(o)}:null;E.roll({...v,extraRollOptions:h,dc:D})}break}default:{let b=lt(Es,r),E=b?[]:h.filter(D=>D in CONFIG.PF2E.actionTraits)??[];for(let D of w){let M=(()=>{if(r in CONFIG.PF2E.magicTraditions){let P=D.spellcasting.filter(J=>J.tradition===r).flatMap(J=>J.statistic??[]).sort((J,re)=>re.check.mod-J.check.mod).shift()??null;if(P)return P}return D.getStatistic(r)})();if(!M){console.warn(ue(`Skip rolling unknown statistic ${r}`).message);continue}let R=l?game.user.targets.first()?.actor:null,W=(()=>{let P=Number(m)||0;return o==="@self.level"?we(D.level)+P:Number(o??"NaN")+P})(),G=(()=>{if(Number.isInteger(W))return{label:a,value:W};if(l){let P=R?.getStatistic(l);return P?{statistic:P.dc,scope:"check",value:P.dc.value}:null}return null})(),N=(()=>{let P=e instanceof Item?e:e instanceof ChatMessage?e.item:null;return P?.isOfType("action","feat","campaignFeature")||b&&!P?.isOfType("weapon")?P:null})(),_={...v,extraRollOptions:h,origin:b&&g instanceof Actor?g:null,dc:G,target:!b&&G?.statistic?R:null,item:N,traits:E};if(!!(N?.isOfType("action","feat")&&N.actionCost)&&l){let P=r in CONFIG.PF2E.magicTraditions?"PF2E.ActionsCheck.spell":M.check.type==="attack-roll"?"PF2E.ActionsCheck.x-attack-roll":"PF2E.ActionsCheck.x";_.label=await renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:ve(N.actionCost),subtitle:game.i18n.format(P,{type:M.label}),title:N.name})}M.roll(_)}}}})}let s={burst:"circle",cone:"cone",cube:"rect",emanation:"circle",line:"ray",rect:"rect",square:"rect"};for(let n of i.filter(r=>r.hasAttribute("data-pf2-effect-area"))){let{pf2EffectArea:r,pf2Distance:o,pf2TemplateData:c,pf2Traits:a,pf2Width:l}=n.dataset;n.addEventListener("click",()=>{if(typeof r!="string"){console.warn("PF2e System | Could not create template'");return}let m=JSON.parse(c??"{}");switch(m.distance||=Number(o),m.fillColor||=game.user.color,m.t=s[r],m.t){case"ray":m.width=Number(l)||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1);break;case"cone":m.angle=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let p=m.distance??0;m.distance=Math.hypot(p,p),m.width=p,m.direction=45;break}}a&&(m.flags={pf2e:{origin:{traits:a.split(",")}}});let d=new(at())(m,{parent:canvas.scene});new(ot())(d).drawPreview()})}for(let n of t.querySelectorAll("a[data-damage-roll]"))n.dataset.itemUuid=e.uuid}u(Se,"listenInlineRoll");function gt(t,e){if(e)return e;let s=(ui.windows[Number(t.closest(".app.sheet")?.dataset.appid)]??null)?.document;return s instanceof Actor||s instanceof JournalEntry?s:null}u(gt,"resolveDocument");function ht(t,e){if(Ce(t,"ActorPF2e"))return t;if(Ce(t,"ItemPF2e")||Ce(t,"ChatMessagePF2e"))return t.actor;let i=e.dataset.itemUuid,s=i&&!i.startsWith("Compendium.")?fromUuidSync(i):null;return s instanceof Item?s.actor:null}u(ht,"resolveActor");var Te=["U","T","E","M","L"],Ls="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi";async function yt(t,e){let i=t.data(),s=i.itemId?e.items.get(i.itemId):await fromUuid(i.uuid),n=await s?.getChatData({secrets:e.isOwner},i);if(!n)return;let r=document.createElement("div");return r.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(r,s,n),Se(r,s),r}u(yt,"getItemSummary");function q(t){t.on("mouseenter",e=>{e.preventDefault();let i=e.currentTarget.querySelector(".name"),{width:s}=i.getBoundingClientRect();if(i.scrollWidth<=Math.ceil(s))return;let n=i.innerHTML.trim();game.tooltip.activate(e.currentTarget,{text:n})}),t.on("mouseleave",e=>{e.preventDefault(),game.tooltip.deactivate()}),t.on("mousedown",e=>{game.tooltip.deactivate()})}u(q,"addNameTooltipListeners");function bt(t,e){t.preventDefault(),z(t,e)?.sheet.render(!0,{focus:!0})}u(bt,"editItem");async function wt(t,e){t.preventDefault();let i=z(t,e);if(i){if(t.ctrlKey)return i.delete();new Dialog({title:C("deleteItem.title"),content:`<p>${game.i18n.format("PF2E.DeleteQuestion",{name:i.name})}</p>`,buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:C("deleteItem.ok"),callback:()=>i.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:C("deleteItem.cancel")}}}).render(!0)}}u(wt,"deleteItem");function z(t,e){let{itemId:i}=t.currentTarget.closest("[data-item-id]").dataset;return e.items.get(i)}u(z,"getItemFromEvent");function Ee(t){return t.isOwner?Y(t,`macros.${game.user.id}`)?.map(e=>{let i=fromUuidSync(e);return i?{img:i.img,name:i.name,uuid:e}:null}).filter(Boolean):void 0}u(Ee,"getMacros");function De(t,e){let{type:i,uuid:s}=TextEditor.getDragEventData(t.originalEvent)??{};if(i!=="Macro"||!fromUuidSync(s))return;let n=`macros.${game.user.id}`,r=Y(e,n)?.slice()??[];r.includes(s)||(r.push(s),se(e,n,r))}u(De,"onDroppedMacro");function xe(t,e){let i=`macros.${game.user.id}`,s=Y(e,i)?.slice();if(!s?.length)return;let{uuid:n}=t.currentTarget.closest(".macro").dataset,r=s.indexOf(n);r!==-1&&(s.splice(r,1),se(e,i,s))}u(xe,"deleteMacro");function Ae(t=()=>!0){let e=game.user.targets,i=e.size===1?e.first():null;return i&&t(i)?i:null}u(Ae,"getUniqueTarget");function U(t,e){return e?t.toLowerCase().includes(e):!0}u(U,"filterIn");function H(t,e){return t.localeCompare(e,game.i18n.lang)}u(H,"localeCompare");function ze(t){return t?.itemTypes.effect.find(e=>e.flags.core?.sourceId===Ls)}u(ze,"getCoverEffect");async function ie(t,e,i){let s=X(),n=s?.element;if(!n)return;n.find("> .popup").remove();let r=document.createElement("div");r.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${t}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${C("popup.close")}</a>
    </div>
</div>`;let o=r.firstElementChild;typeof e=="string"?(e=await te(e,i),o.insertAdjacentHTML("beforeend",e)):o.append(e),o.querySelector("[data-action=close-popup]").addEventListener("click",()=>o.remove()),n.append(o),s.lock()}u(ie,"popup");async function B(t,e,i){i??=t.find(".name").html();let s=await yt(t,e);s&&ie(i.trim(),s,e)}u(B,"showItemSummary");async function Le(t,e,i,{rollMode:s=void 0,create:n=!0,data:r={}}){let o=`systems/pf2e/templates/chat/${e.type}-card.hbs`,c=i.token,a=t?.currentTarget.closest(".item")??{},l=Q(),m=Object.keys(r).length>0?r:a.dataset||{},d={actor:i,tokenId:c?`${c.parent?.id}.${c.id}`:null,item:e,data:await e.getChatData(void 0,m)},p={speaker:l.getSpeaker({actor:i,token:i.getActiveTokens(!1,!0)[0]??null}),flags:{core:{canPopout:!0},pf2e:{origin:{uuid:e.uuid,type:e.type}}},type:CONST.CHAT_MESSAGE_TYPES.OTHER};return s??=t?.ctrlKey||t?.metaKey?"blindroll":game.settings.get("core","rollMode"),["gmroll","blindroll"].includes(s)&&(p.whisper=l.getWhisperRecipients("GM").map(f=>f.id)),s==="blindroll"&&(p.blind=!0),p.content=await renderTemplate(o,d),n?l.create(p,{renderSheet:!1}):new l(p)}u(Le,"unownedItemToMessage");async function kt(t){if(!t.system.selfEffect)throw ue(["Only actions with self-applied effects can be passed to `ActorPF2e#useAction`.","Support will be expanded at a later time."].join(" "));let{actor:e,actionCost:i}=t,s=e.getActiveTokens(!0,!0).shift()??null,n=Q(),r=n.getSpeaker({actor:e,token:s}),o=await renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{glyph:ve(i),title:t.name},item:t,traits:t.system.traits.value.map(p=>pt(p,CONFIG.PF2E.actionTraits))}),c=100,a=(()=>{if(t.actor.pack)return null;let p=document.createElement("div"),f=[...CONST.DOCUMENT_LINK_TYPES,"Compendium","UUID"],g=new RegExp(`@(${f.join("|")})\\[([^#\\]]+)(?:#([^\\]]+))?](?:{([^}]+)})?`,"g");return p.innerHTML=t.description.replace(g,(w,...h)=>h[3]),p.innerText.slice(0,c)})(),l={full:a&&a.length<c?t.description:null,preview:a},m=await renderTemplate("systems/pf2e/templates/chat/action/self-effect.hbs",{actor:t.actor,description:l}),d={pf2e:{context:{type:"self-effect",item:t.id}}};return n.create({speaker:r,flavor:o,content:m,flags:d})}u(kt,"createSelfEffectMessage");async function vt({weapon:t,trait:e,selection:i}){if(t.system.traits.toggles[e].selection===i)return!1;let n=t.actor?.items.get(t.id);return n?.isOfType("weapon")&&n===t?await n.update({[`system.traits.toggles.${e}.selection`]:i}):n?.isOfType("weapon")&&t.altUsageType==="melee"?await n.update({[`system.meleeUsage.traitToggles.${e}`]:i}):await n?.rules.find(o=>o.key==="Strike"&&!o.ignored&&o.slug===t.slug)?.toggleTrait({trait:e,selection:i}),!0}u(vt,"toggleWeaponTrait");var Oe={CRITICAL_FAILURE:0,FAILURE:1,SUCCESS:2,CRITICAL_SUCCESS:3},It={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"};function Ct(t,e){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(e+t,0,3)}}u(Ct,"adjustDegreeOfSuccess");function Fe(t,e){return t===20?Ct(It.INCREASE,e):t===1?Ct(It.LOWER,e):e}u(Fe,"adjustDegreeByDieValue");function St(t,e,i){return t-i>=10?Fe(e,Oe.CRITICAL_SUCCESS):i-t>=10?Fe(e,Oe.CRITICAL_FAILURE):t>=i?Fe(e,Oe.SUCCESS):Fe(e,Oe.FAILURE)}u(St,"calculateDegreeOfSuccess");var Os=["arcana","crafting","medicine","nature","occultism","religion","society"],Tt={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function Et(t){let i=(await new Roll("1d20").evaluate({async:!0})).dice[0].total,s=i===1?"0":i===20?"3":"",n=Object.values(t.skills).filter(a=>a.lore),r=Ae(a=>a.actor?.identificationDCs)?.actor,o={dieSuccess:s,dieResult:i,target:r,i18n:a=>C(`actions.recall-knowledge.${a}`)};if(r){let{standard:a,skills:l,lore:m}=r.identificationDCs,d=a.progression.slice();d.length=4,d=[...d];let p=m.map(({progression:f})=>{let g=f;return g.length=6,[...g]});o.skillsDCs=d,o.loresDCs=p,o.skills=await Promise.all(l.map(f=>{let g=t.skills[f];return Be(g,i,d)})),o.lores=await Promise.all(n.map(f=>Be(f,i)))}else o.skills=await Promise.all([...Os.map(a=>t.skills[a]),...n].map(a=>Be(a,i)));let c=await renderTemplate(F("chat/recall-knowledge"),o);ChatMessage.create({flavor:c,speaker:ChatMessage.getSpeaker({actor:t}),rollMode:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL})}u(Et,"rollRecallKnowledges");async function Be(t,e,i){let{rank:s,label:n}=t,r=await t.roll({createMessage:!1,skipDialog:!0,extraRollOptions:["action:recall-knowledge"]}),o=r.total-r.dice[0].total,c=e+o;return{mod:o,rank:s,label:n,total:c,modifier:K(o),rankLabel:Te[s],checks:i?.map(a=>{if(!a)return"-";let l=St(c,e,a);return{success:l,icon:Tt[l].icon,title:Tt[l].name}})}}u(Be,"rollSkill");var V="pf2e-token-hud",Fs="Compendium.pf2e.feats-srd.Item.9jGaBxLUtevZYcZO",Ps=new Set(["Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk"]),Dt="Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf",Ms="Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu",Ge="Compendium.pf2e.other-effects.Item.VCSpuc3Tf3XWMkd3",$s={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${V}.skills.actions.earnIncome`,treatWounds:`${V}.skills.actions.treatWounds`,"borrow-arcane-spell":`${V}.skills.actions.borrow-arcane-spell`,"identify-magic":`${V}.skills.actions.identify-magic`,"identify-alchemy":`${V}.skills.actions.identify-alchemy`,"learn-spell":`${V}.skills.actions.learn-spell`,"crafting-goods":`${V}.skills.actions.crafting-goods`,"staging-performance":`${V}.skills.actions.staging-performance`},xt={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW","sense-motive":"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","follow-the-expert":"Compendium.pf2e.actionspf2e.Item.tfa4Sh7wcxCEqL29","tumble-through":"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2",shove:"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X",bonMot:Dt,gatherInformation:"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H"},Ns={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},de=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:t=>!t.itemTypes.equipment.some(e=>e.isHeld&&Ps.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"shove",cost:"1",type:1,map:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0}]},{slug:"crafting",actions:[{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:t=>We(t,Dt)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"],rollOption:"administer-first-aid"},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"identify-magic","learn-spell",{slug:"treatWounds",type:1,trained:!0,condition:t=>We(t,Ms)}]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:[{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];de.forEach(t=>{t.actions=t.actions.map(s=>typeof s=="string"?Ns[s]:s);let{slug:e,actions:i}=t;for(let s of i){let n=s.slug.replace(/-(.)/g,(r,o)=>o.toUpperCase()).capitalize();s.skillSlug=e,s.uuid=xt[s.slug],s.label=$s[s.slug]??`PF2E.Actions.${n}.Title`,s.variants?s.variants=s.variants.map(r=>({slug:r,label:`${V}.skills.actions.${r}`})):s.map&&(s.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:-5},{label:"PF2E.MAPAbbreviationLabel",map:-10}]),s.modifiers?.forEach(({modifiers:r})=>{r.forEach(o=>{o.label=`${V}.skills.modifiers.${o.slug}`})})}});var Ke=de.map(t=>t.slug),Rs=de.reduce((t,{slug:e,actions:i})=>(t[e]={slug:e,actions:i.reduce((s,n)=>(s[n.slug]=n,s),{})},t),{}),At=new Set(Object.values(xt).filter(Boolean));function qe(t){return game.i18n.localize(t==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[t])}u(qe,"getSkillLabel");async function Lt(t,e,i){let s=[],n=t.isOfType("character"),r=n&&k("untrained")&&!t.itemTypes.feat.some(a=>a.sourceId===Fs);for(let a=0;a<de.length;a++){let{slug:l,actions:m}=de[a],{label:d,rank:p,mod:f}=t.getStatistic(l),g=game.i18n.localize(d),w=m.filter(({condition:b,trained:E})=>(!r||!n||!E||t.skills[l].rank>=1)&&(!b||b(t))).map(b=>({...b,name:game.i18n.localize(b.label),variants:b.variants?.map(E=>({...E,name:game.i18n.localize(E.label)}))})),h=U(g,i),v=w;!h&&(v=w.filter(({name:b,variants:E})=>U(b,i)||E?.some(D=>U(D.name,i))),!v.length)||(s[a]={slug:l,name:g,rank:p,modifier:K(f),actions:h?w:v})}s.sort((a,l)=>a.slug==="perception"?-1:l.slug==="perception"?1:H(a.name,l.name));let o=Object.values(t.skills).filter(({lore:a,label:l})=>a&&U(l,i)).map(({label:a,rank:l,mod:m,slug:d})=>({slug:d,label:a,rank:l,modifier:K(m)})),c=o.reduce((a,l)=>l.modifier.length>a?l.modifier.length:a,2);return{contentData:{follow:C(`skills.actions.${Ft(t)?"following":"follow"}`),skills:s,lores:o,loresModifierWidth:c},doubled:k("skills-columns")}}u(Lt,"getSkillsData");function Ot(t,e,i){t.find("[data-action=action-description]").on("click",s=>{s.preventDefault();let n=$(s.currentTarget).closest(".action");B(n,e,n.find(".name").children().html())}),e.isOwner&&(t.find("[data-action=follow-the-expert]").on("click",async s=>{s.preventDefault();let n=Ft(e);if(n)return await n.delete();let r=(await fromUuid(Ge)).toObject();setProperty(r,"flags.core.sourceId",Ge),await e.createEmbeddedDocuments("Item",[r])}),t.find("[data-action=roll-skill]").on("click",s=>{s.preventDefault();let{slug:n}=s.currentTarget.dataset;e.getStatistic(n)?.roll({event:s})}),t.find("[data-action=roll-action]").on("click contextmenu",async s=>{s.preventDefault();let n=$(s.currentTarget),{skillSlug:r,slug:o}=n.closest(".action").data(),{variant:c,map:a}=n.data(),l=s.type==="contextmenu"?await Pe(r):void 0;l!==null&&Us({event:s,actor:e,token:i,skillSlug:r,slug:o,variant:c,map:a,skill:l?.selected})}),t.find("[data-action=action-chat]").on("click",async s=>{s.preventDefault();let{uuid:n}=s.currentTarget.closest(".action").dataset,r=await fromUuid(n);r&&Le(s,r,e,{create:!0})}))}u(Ot,"addSkillsListeners");function Ft(t){return t.itemTypes.effect.find(e=>e.sourceId===Ge)}u(Ft,"isFollowingAnExpert");async function Pe(t,e){let i=Ke.map(n=>({slug:n,label:qe(n)})),s=await renderTemplate(F("dialogs/variant"),{i18n:n=>C(`skills.variant.${n}`),dc:e,skills:i,selected:t});return Dialog.prompt({title:C("skills.variant.title"),label:C("skills.variant.button"),callback:n=>({selected:n.find("select").val(),dc:n.find("input").val()}),rejectClose:!1,content:s,options:{width:280}})}u(Pe,"variantsDialog");function Us({event:t,actor:e,skillSlug:i,slug:s,variant:n,map:r,skill:o,token:c}){let a=Rs[i].actions[s],l=a.type===3?3:game.pf2e.actions.has(s)?2:1;o??=a.noSkill?void 0:i;let m=a.rollOption?[`action:${a.rollOption}`]:void 0;m&&n&&m.push(`action:${a.rollOption}:${n}`);let d={event:t,actors:[e],tokens:[c],variant:n,rollOptions:m,rollMode:a.secret?"blindroll":"roll"};if(d.modifiers=[],a.modifiers){for(let{condition:p,modifiers:f}of a.modifiers)if(!(p&&!p(e)))for(let g of f)d.modifiers.push(new game.pf2e.Modifier(g))}if(a.custom){a.custom(e,d);return}else if(!l){e.getStatistic(o)?.roll(d);return}l===1?(d.skill=o,r&&d.modifiers.push(new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:r})),game.pf2e.actions[s](d)):l===2?(d.statistic=o,r&&(d.multipleAttackPenalty=r/-5),game.pf2e.actions.get(s).use(d)):l===3&&game.pf2e.actions[s](e)}u(Us,"rollAction");var Ve={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","point-out":"Compendium.pf2e.actionspf2e.Item.sn2hIy1iIJX9Vpgj"};async function Pt(t,e,i){let{attributes:s}=t,{initiative:n}=s;return{contentData:{noMacro:C("extras.no-macro"),macros:Ee(t)?.filter(r=>U(r.name,i)),initiative:n&&{selected:n.statistic,skills:Ke.map(r=>({slug:r,label:qe(r)}))},hasDailies:game.modules.get("pf2e-dailies")?.active,hasPerception:game.modules.get("pf2e-perception")?.active,uuids:Ve}}}u(Pt,"getExtrasData");function Mt(t,e,i){function s(r,o,c="click"){t.find(`[data-action=${r}]`).on(c,a=>{a.preventDefault(),o(a)})}if(u(s,"action"),s("action-description",r=>{let o=$(r.currentTarget).closest(".row");B(o,e)}),!e.isOwner)return;q(t.find(".macro"));async function n(r){let{uuid:o}=r.currentTarget.closest(".macro").dataset;return fromUuid(o)}u(n,"getMacro"),s("delete-macro",r=>xe(r,e)),s("edit-macro",async r=>{(await n(r))?.sheet.render(!0)}),s("use-macro",async r=>{(await n(r))?.execute({actor:e,token:i})}),t.on("drop",r=>De(r,e)),s("action-chat",async r=>{let{uuid:o}=r.currentTarget.closest(".row").dataset,c=await fromUuid(o);c&&Le(r,c,e,{create:!0})}),t.find("input[name], select[name]").on("change",async r=>{let o=r.currentTarget,c=o.type==="number"?o.valueAsNumber:o.value;await e.update({[o.name]:c})}),s("roll-initiative",async r=>{await e.initiative.roll({event:r})}),s("prepare-dailies",r=>{let o=game.modules.get("pf2e-dailies");o?.active&&o.api.openDailiesInterface(e)}),s("rest-for-the-night",r=>{game.pf2e.actions.restForTheNight({actors:[e],tokens:[i]})}),s("roll-recall-knowledge",r=>{Et(e)}),s("roll-aid",async r=>{let o=await Pe(null,20),c={text:"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]"};o!==null&&game.pf2e.actions.get("aid").use({event:r,actors:[e],tokens:[i],statistic:o?.selected,difficultyClass:{value:o?.dc},notes:[c]})},"click contextmenu"),s("roll-point-out",r=>{game.pf2e.actions.get("point-out").use({event:r,actors:[e],tokens:[i]})}),s("roll-escape",async r=>{let o=r.type==="contextmenu"?await Pe():void 0,c=$(r.currentTarget).data().map;o!==null&&game.pf2e.actions.get("escape").use({event:r,actors:[e],tokens:[i],statistic:o?.selected,multipleAttackPenalty:c})},"click contextmenu")}u(Mt,"addExtrasListeners");var oe={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionsReactionsHeader",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionsFreeActionsHeader",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.NPC.PassivesLabel",actionLabel:"PF2E.ActionTypePassive"},exploration:{order:3,label:"PF2E.TravelSpeed.ExplorationActivity",actionLabel:"PF2E.TabActionsExplorationLabel"}},$t={delay:[500,0],position:"top",theme:"crb-hover",arrow:!1};async function Nt(t,e,i){let s=t.isOfType("character"),n=t.synthetics.toggles.slice(),r=k("actions"),o=(await Je()?.getStances(t))?.sort((h,v)=>H(h.name,v.name)),c=s?await ne()?.getHeroActions(t):void 0,a=c?t.heroPoints.value-c.length:void 0,l=t.isOwner,m=t.getRollData(),d=t.system.actions?await Promise.all(t.system.actions.map(async(h,v)=>({...h,index:v,visible:!s||h.visible,damageFormula:await h.damage?.({getFormula:!0}),criticalFormula:await h.critical?.({getFormula:!0}),description:h.description?await te(h.description,t,{rollData:m,isOwner:l}):void 0,altUsages:h.altUsages&&await Promise.all(h.altUsages.map(async b=>({...b,usage:b.item.isThrown?"thrown":"melee",damageFormula:await b.damage?.({getFormula:!0}),criticalFormula:await b.critical?.({getFormula:!0})})))}))):void 0,p=s?new game.pf2e.ElementalBlast(t):void 0,f=p?(await Promise.all(p.configs.map(async h=>{let v=h.damageTypes.find(E=>E.selected)?.value??"untyped",b=u((E,D=!0)=>p.damage({element:h.element,damageType:v,melee:D,outcome:E,getFormula:!0}),"formulaFor");return{...h,damageType:v,formula:{melee:{damage:await b("success"),critical:await b("criticalSuccess")},ranged:{damage:await b("success",!1),critical:await b("criticalSuccess",!1)}}}}))).sort((h,v)=>H(h.label,v.label)):void 0,g={},w=s?_s(t,o):js(t);for(let h of w)U(h.name,i)&&(r!=="split"?(g.action??=[],g.action.push(h)):(g[h.type]??=[],g[h.type].push(h)));if(g=Object.entries(g).map(([h,v])=>(v.forEach(b=>{b.img=ct(b.cost),b.typeLabel=oe[b.type].actionLabel}),r!=="type"?v.sort((b,E)=>H(b.name,E.name)):v.sort((b,E)=>{let D=oe[b.type].order,M=oe[E.type].order;return D===M?H(b.name,E.name):D-M}),{type:h,actions:v,label:oe[h].label})),r==="split"&&g.sort((h,v)=>oe[h.type].order-oe[v.type].order),n.length||o?.length||d?.length||f?.length||g.length||c?.length){let h=+((o?.length??0)>0)+ +((d?.length??0)>0)+ +((f?.length??0)>0)+g.length+ +((c?.length??0)>0);return{contentData:{toggles:n,stances:o,strikes:d,blasts:f,sections:g,heroActions:c&&{actions:c,draw:Math.max(a,0),discard:Math.abs(Math.min(a,0)),canTrade:c.length&&Hs()},i18n:v=>C(`actions.${v}`),variantLabel:v=>v.replace(/.+\((.+)\)/,"$1"),damageTypes:CONFIG.PF2E.damageTypes},doubled:h>1&&k("actions-columns"),classes:[k("actions-colors")?"attack-damage-system-colors":""]}}}u(Nt,"getActionsData");function Rt(t,e){q(t.find(".toggle")),q(t.find(".strike")),q(t.find(".action"));function i(o,c,a="click"){return o=typeof o=="string"?[o]:o,o=o.map(l=>`[data-action=${l}]`).join(", "),t.find(o).on(a,l=>{l.preventDefault(),c(l)})}u(i,"action");function s(o){let c=o.currentTarget.closest(".strike"),a=e.system.actions[c.dataset.index];if(!a)return null;let{altUsage:l}=o.currentTarget.dataset;return["melee","thrown"].includes(l)?a.altUsages?.find(m=>l==="thrown"?m.item.isThrown:m.item.isMelee)??null:a}u(s,"getStrike");function n(o){return $(o.currentTarget).closest(".action").data().uuid}if(u(n,"getUuid"),i("action-description",async o=>{let c=$(o.currentTarget).closest(".action");B(c,e)}),i("hero-action-description",async o=>{let c=n(o),{description:a,name:l}=await ne()?.getHeroActionDetails(c)??{};a&&ie(l,a,e)}),i("strike-description",async o=>{let c=s(o);if(!c)return;let a=document.createElement("div");a.classList.add("description"),a.innerHTML=await renderTemplate(F("strike-description"),c),ie(c.label,a,e)}),i("blast-description",async o=>{let c=o.currentTarget.closest(".blast");B($(c),e)}),i("trait-description",o=>{let c=s(o);if(!c)return;let{index:a}=o.currentTarget.dataset,l=c.traits[a];if(!l)return;let m=game.i18n.localize(l.description);m&&ie(game.i18n.localize(l.label),m,e)}),i("stance-description",o=>{let c=$(o.currentTarget).closest(".action");B(c,e,c.data().itemName)}),!e.isOwner||(i("use-action",o=>{let c=z(o,e);c?.isOfType("action","feat")&&kt(c)}),i("stance-chat",o=>{z(o,e)?.toMessage(o,{create:!0})}),i("stance-toggle",o=>{let{effectUuid:c}=o.currentTarget.closest(".action").dataset;Je()?.toggleStance(e,c)}),i("exploration-toggle",o=>{let c=o.currentTarget.closest(".action").dataset.itemId,a=e.system.exploration.filter(l=>e.items.has(l));a.findSplice(l=>l===c)||a.push(c),e.update({"system.exploration":a})}),i("action-chat",o=>{z(o,e)?.toMessage(o,{create:!0})}),i("hero-action-chat",async o=>{await ne()?.sendActionToChat(e,n(o))}),i("draw-hero-action",async o=>{await ne()?.drawHeroActions(e)}),i("use-hero-action",async o=>{await ne()?.useHeroAction(e,n(o))}),i("discard-hero-action",async o=>{await ne()?.discardHeroActions(e,n(o))}),i("trade-hero-action",async o=>{ne()?.tradeHeroAction(e)}),i("strike-attack",o=>{let{index:c,altUsage:a}=o.currentTarget.dataset;s(o)?.variants[c].roll({event:o,altUsage:a})}),i(["strike-damage","strike-critical"],o=>{let{action:c}=o.currentTarget.dataset;s(o)?.[c==="strike-damage"?"damage":"critical"]({event:o})}).tooltipster($t),i(["toggle-roll-option","set-suboption"],o=>{let c=o.currentTarget.closest(".toggle"),{domain:a,option:l,itemId:m}=c.dataset,d=c.querySelector("select")?.value??null;e.toggleRollOption(a,l,m??null,c.querySelector("input").checked,d)}),i("strike-auxiliary",o=>{if(o.currentTarget!==o.target)return;let c=s(o);if(!c)return;let{index:a}=o.currentTarget.dataset,l=o.currentTarget.querySelector("select")?.value??null;c.auxiliaryActions?.[a]?.execute({selection:l})}),i("toggle-versatile",o=>{let c=s(o)?.item;if(!c)return;let a=o.currentTarget,{value:l}=a.dataset,m=c?.system.damage.damageType??null,d=a.classList.contains("selected")||l===m?null:l;vt({trait:"versatile",weapon:c,selection:d})}).tooltipster($t),i("strike-ammo",async o=>{let c=s(o)?.item;if(!c)return;let a=e.items.get(o.currentTarget.value);await c.update({system:{selectedAmmoId:a?.id??null}})},"change"),!e.isOfType("character")))return;let r=["roll-attack","roll-damage","set-damage-type"].map(o=>`[data-action=${o}]`).join(",");t.find(".blast").each((o,c)=>{let{element:a,damageType:l}=c.dataset,m=new game.pf2e.ElementalBlast(e);$(c).find(r).on("click",async d=>{d.preventDefault();let p=d.currentTarget.dataset,f=p.melee==="true";switch(p.action){case"roll-attack":{let g=Math.clamped(Number(p.mapIncreases),0,2);await m.attack({mapIncreases:Math.clamped(g,0,2),element:a,damageType:l,melee:f,event:d});break}case"roll-damage":{await m.damage({element:a,damageType:l,melee:f,outcome:p.outcome,event:d});break}case"set-damage-type":await m.setDamageType({element:a,damageType:p.value})}})})}u(Rt,"addActionsListeners");function Ut(t){let e=game.modules.get("pf2e-toolbelt");return e?.active&&game.settings.get("pf2e-toolbelt",t)?e:void 0}u(Ut,"getToolBeltModule");function Ht(t){return Ut(t)?.api}u(Ht,"getToolBeltApi");function Je(){let t=game.modules.get("pf2e-stances");return t?.active?t.api:Ht("stances")?.stances}u(Je,"getStancesModuleApi");function ne(){let t=game.modules.get("pf2e-hero-actions");return t?.active?t.api:Ht("hero")?.heroActions}u(ne,"getHeroActionsApi");function Hs(){if(game.modules.get("pf2e-hero-actions")?.active)return game.settings.get("pf2e-hero-actions","trade");if(Ut("hero"))return game.settings.get("pf2e-toolbelt","hero-trade")}u(Hs,"canTradeHeroActions");function _s(t,e){let i=Je()?.getActionsUUIDS?.()??(e?.some(a=>a.actionUUID)?new Set(e.map(({actionUUID:a})=>a)):void 0)??new Set,s=new Set([...i,...At,...Object.values(Ve)]),n=t.itemTypes.action,r=t.itemTypes.feat.filter(a=>a.actionCost),o=t.parties.size>0,c=t.system.exploration;return[...n,...r].map(a=>{let l=a.sourceId,m=a.id,d=a.actionCost,p=a.system.traits.value,f=p.includes("exploration");return{sourceId:l,id:m,type:d?.type??(f?"exploration":"free"),cost:d,name:a.name,isExploration:f,isDowntime:p.includes("downtime"),isActive:f&&c.includes(m),hasEffect:!!a.system.selfEffect}}).filter(a=>!a.isDowntime&&(o||!a.isExploration)&&(a.isExploration||!s.has(a.sourceId)))}u(_s,"getCharacterActions");function js(t){return t.itemTypes.action.map(e=>{let i=e.actionCost,s=i?.type??"passive",n=s==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(r=>r.key==="Aura"));return{id:e.id,type:s,cost:i,name:e.name,hasDeathNote:e.system.deathNote,hasAura:n,hasEffect:!!e.system.selfEffect}})}u(js,"getNpcActions");async function _t(t){let{system:e}=t,{details:i,traits:s,attributes:n}=e,{stealth:r}=n,{description:o,disable:c,routine:a,reset:l,isComplex:m}=i,d=t.getRollData(),p=t.isOwner,f=u(async g=>te(g,t,{isOwner:p,rollData:d}),"enrich");return{contentData:{description:await f(o),disable:await f(c),routine:await f(a),reset:await f(l),isComplex:m,rarity:{value:s.rarity,label:CONFIG.PF2E.rarityTraits[s.rarity]},traits:s.value.map(g=>CONFIG.PF2E.hazardTraits[g]),stealth:K(r.value)},style:{["--max-width"]:k("hazard-width")+"em"}}}u(_t,"getHazardData");function jt(t,e){t.find("[data-action=action-description]").on("click",i=>{i.preventDefault();let s=$(i.currentTarget).closest(".action");B(s,e)}),Se(t[0],e),e.isOwner&&t.find("[data-action=roll-initiative").on("click",i=>{i.preventDefault(),e.initiative.roll({event:i})})}u(jt,"addHazardListeners");var zt=new Set(["arcane","divine","occult","primal"]);function zs(t,e){return t.has(e)}u(zs,"setHasElement");function Bs(t){return t.traits.has("cursed")?"unique":t.rarity}u(Bs,"getDcRarity");function Gs(t){let e=t.system.traits.value;return new Set(e.filter(i=>zs(zt,i)))}u(Gs,"getMagicTraditions");function Ws(t,e,i){let s={occult:e,primal:e,divine:e,arcane:e},n=Gs(t);for(let r of zt)n.size>0&&!n.has(r)&&(s[r]=e+i);return{arcana:s.arcane,nature:s.primal,religion:s.divine,occultism:s.occult}}u(Ws,"getIdentifyMagicDCs");function Ks(t,{proficiencyWithoutLevel:e=!1,notMatchingTraditionModifier:i}){let s=we(t.level,{proficiencyWithoutLevel:e}),n=Bs(t),r=be(s,n);return t.isMagical?Ws(t,r,i):t.isAlchemical?{crafting:r}:{dc:r}}u(Ks,"getItemIdentificationDCs");function qs(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}u(qs,"objectHasKey");var pe=class extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let e=this.object,i=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),s=game.settings.get("pf2e","proficiencyVariant")==="ProficiencyWithoutLevel",n=Ks(e,{proficiencyWithoutLevel:s,notMatchingTraditionModifier:i});return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:n}}activateListeners(e){e.find("button.update-identification").on("click",i=>{let s=$(i.delegateTarget);this.submit({updateData:{status:s.val()}})}),e.find("button.post-skill-checks").on("click",async()=>{let i=this.item,s=i.system.identification.unidentified.img,n=i.system.identification.unidentified.name,r=i.system.identification.identified.name,o=$("div#identify-item").find("tr").toArray().flatMap(l=>{let m=l.dataset.skill,d=Number(l.dataset.dc);if(!(Number.isInteger(d)&&qs(CONFIG.PF2E.skillList,m)))return[];let p=game.i18n.localize(CONFIG.PF2E.skillList[m]);return{slug:m,name:p,dc:d}}),c=i.isMagical?"action:identify-magic":i.isAlchemical?"action:identify-alchemy":null,a=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:s,itemName:n,identifiedName:r,rollOptions:["concentrate","exploration","secret",c].filter(Boolean),skills:o});await Q().create({user:game.user.id,content:a})})}async _updateObject(e,i){let s=i.status;s==="identified"&&await this.item.setIdentificationStatus(s)}};u(pe,"IdentifyItemPopup");var Me={weapon:{order:0,label:"PF2E.InventoryWeaponsHeader"},armor:{order:1,label:"PF2E.InventoryArmorHeader"},consumable:{order:2,label:"PF2E.InventoryConsumablesHeader"},equipment:{order:3,label:"PF2E.InventoryEquipmentHeader"},treasure:{order:4,label:"PF2E.InventoryTreasureHeader"},backpack:{order:5,label:"PF2E.InventoryBackpackHeader"}};async function Bt(t,e,i){let{contents:s,coins:n,totalWealth:r,bulk:o,invested:c}=t.inventory,a=k("containers")||(Y(t,`containers.${game.user.id}`)??[]),l={},m={};for(let d of s){if(!Me[d.type])continue;let p=d.system.containerId;d.type!=="backpack"&&p&&(a===!0||a.includes(p))?(l[p]??=[],l[p].push(d)):(m[d.type]??=[],m[d.type].push(d))}if(m=Object.entries(m).map(([d,p])=>{if(p.sort((f,g)=>H(f.name,g.name)),d==="backpack")for(let f=p.length-1;f>=0;f--){let g=p[f],w=l[g.id]?.filter(h=>U(h.name,i));if(!w?.length){U(g.name,i)||p.splice(f,1);continue}w.sort((h,v)=>H(h.name,v.name)),p.splice(f+1,0,...w)}else p=p.filter(f=>U(f.name,i));return{type:d,items:p,label:Me[d].label}}).filter(d=>d.items.length).sort((d,p)=>Me[d.type].order-Me[p.type].order),m.length)return{doubled:m.length>1&&k("items-columns"),contentData:{canCarry:!!t.adjustCarryType,categories:m,bulk:o,containers:a,i18n:d=>C(`items.${d}`),invested:c?`${game.i18n.localize("PF2E.InvestedLabel")}: ${c.value} / ${c.max}`:"",wealth:{coins:n.goldValue,total:r.goldValue}}}}u(Bt,"getItemsData");function Gt(t,e,i){let s=t.find(".item");q(s),s.find("[data-action=item-description]").on("click",async n=>{n.preventDefault();let r=$(n.currentTarget).closest(".item");await B(r,e)}),s.find("[data-action=toggle-contains-items]").on("click",async n=>{n.preventDefault();let r=`containers.${game.user.id}`,o=n.currentTarget.closest(".item").dataset.itemId,c=Y(e,r)?.slice()??[],a=c.indexOf(o);a===-1?c.push(o):c.splice(a,1),await se(e,r,c)}),e.isOwner&&(s.find("[data-action=item-chat]").on("click",async n=>{z(n,e)?.toMessage(n,{create:!0})}),s.on("dragstart",n=>{let r=n.target.closest(".item"),{itemType:o,uuid:c}=r.dataset,a=new Image;a.src=r.querySelector(".item-img img").src,a.style.width="32px",a.style.height="32px",a.style.borderRadius="4px",a.style.position="absolute",a.style.left="-1000px",document.body.append(a),n.originalEvent.dataTransfer.setDragImage(a,16,16),n.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:o,uuid:c})),r.addEventListener("dragend",()=>a.remove(),{once:!0})}),t.find(".quantity input").on("change",async n=>{await z(n,e)?.update({"system.quantity":n.currentTarget.valueAsNumber})}),t.find("[data-action=toggle-item-invest]").on("click",n=>{n.preventDefault();let{itemId:r}=n.currentTarget.closest(".item").dataset;e.toggleInvested(r)}),t.find("[data-action=repair-item]").on("click",n=>{n.preventDefault();let r=z(n,e);r&&game.pf2e.actions.repair({item:r,actors:[e],tokens:[i]})}),t.find("[data-action=toggle-identified]").on("click",n=>{n.preventDefault();let r=z(n,e);r&&(r.isIdentified?r.setIdentificationStatus("unidentified"):new pe(r).render(!0))}),t.find("[data-action=edit-item]").on("click",n=>{n.preventDefault(),bt(n,e)}),t.find("[data-action=delete-item]").on("click",n=>{n.preventDefault(),wt(n,e)}),t.find("[data-action=toggle-item-worn").tooltipster({animation:null,updateAnimation:null,animationDuration:0,delay:[0,0],trigger:"click",contentAsHTML:!0,interactive:!0,arrow:!1,side:["bottom","top"],theme:"crb-hover",minWidth:120,content:"",functionBefore:async function(n,{event:r,origin:o}){let c=z(r,e);if(!c)return;let a=document.createElement("div");a.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:c});let l=a.children[1],m=$(l);if(m.find("[data-carry-type]").on("click",async d=>{let p=c.system.equipped,{carryType:f,handsHeld:g=0,inSlot:w}=$(d.currentTarget).data();w=w==="true",(f!==p.carryType||w!==p.inSlot||f==="held"&&g!==p.handsHeld)&&await e.adjustCarryType(c,{carryType:f,handsHeld:g,inSlot:w})}),c.type!=="backpack"){let d=e.itemTypes.backpack.filter(p=>p.isIdentified);if(d.length){let p="";for(let f of d)p+='<li><a class="item-control item-location-option',f===c.container&&(p+=" selected"),p+=`" data-action="send-to-container" data-container-id="${f.id}">`,p+=`<i class="fas fa-box"></i>${f.name}</a></li>`;m.find("ul").append(p),m.find("[data-action=send-to-container]").on("click",async f=>{let{containerId:g}=f.currentTarget.dataset;e.items.has(g)&&(n.close(),await c.update({"system.containerId":g}))})}}n.content(l)}}))}u(Gt,"addItemsListeners");async function Wt(t,e,i){let s=t.system.resources.focus??{value:0,max:0},n=t.spellcasting.regular,r=k("tradition"),o=game.modules.get("pf2e-staves")?.active,c=[],a=[],l=!1;if(await Promise.all(n.map(async p=>{let f=p.id,g=r&&p.statistic.label[0],w=await p.getSheetData(),h=w.isFocusPool,v=p.system?.prepared?.value==="charge",b=getProperty(p,"flags.pf2e-staves.staveID")!==void 0,E={value:getProperty(p,"flags.pf2e-staves.charges")??0};for(let D of w.levels){if(!D.active.length||D.uses?.max===0)continue;let M=[],R=D.isCantrip,W=D.active.filter(G=>G&&G.uses?.max!==0);for(let G=0;G<W.length;G++){let{spell:N,expended:_,virtual:he,uses:P,castLevel:J}=W[G];U(N.name,i)&&M.push({name:N.name,img:N.img,tradition:g,castLevel:J??N.level,slotId:G,entryId:f,itemId:N.id,inputId:w.isInnate?N.id:w.id,inputPath:v?"flags.pf2e-staves.charges":w.isInnate?"system.location.uses.value":`system.slots.slot${D.level}.value`,isCharge:v,isActiveCharge:v&&o,isVirtual:he,isInnate:w.isInnate,isCantrip:R,isFocus:h,isPrepared:w.isPrepared,isSpontaneous:w.isSpontaneous||w.isFlexible,slotLevel:D.level,uses:P??(v?E:D.uses),expended:_??(h&&!R?s.value<=0:!1),action:N.system.time.value,type:v?b?`${L}.spells.staff`:`${L}.spells.charges`:w.isInnate?"PF2E.PreparationTypeInnate":w.isSpontaneous?"PF2E.PreparationTypeSpontaneous":w.isFlexible?"PF2E.SpellFlexibleLabel":h?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:v?0:w.isPrepared?1:h?2:w.isInnate?3:w.isSpontaneous?4:5})}if(M.length){if(h)if(R)l=!0;else{a.push(...M);continue}c[D.level]??=[],c[D.level].push(...M)}}})),c.length){let p=k("spells")?(f,g)=>f.order===g.order?H(f.name,g.name):f.order-g.order:(f,g)=>H(f.name,g.name);c.forEach(f=>f.sort(p))}a.length&&(a.sort((p,f)=>H(p.name,f.name)),c[12]=a,l=!1);let d=(await t.spellcasting.ritual?.getSheetData())?.levels.flatMap((p,f)=>p.active.map(({spell:g})=>{if(U(g.name,i))return{name:g.name,img:g.img,slotId:f,itemId:g.id,level:g.level,time:g.system.time.value}}).filter(Boolean));if(c.length||d?.length){let p=Kt(t),f=c.length+ +((d?.length??0)>0);return{contentData:{spells:c,rituals:d,focusPool:s,stavesActive:o,hasFocusCantrips:l,attackMod:qt(p)?p[0].mod:null},doubled:f>1&&k("spells-columns")}}}u(Wt,"getSpellsData");function Kt(t){return t.spellcasting.filter(e=>e.statistic).map(({statistic:e,name:i,id:s})=>({name:i,id:s,mod:K(e.mod),statistic:e}))}u(Kt,"getSpellAttacks");function qt(t){return new Set(t.map(({mod:e})=>e)).size===1}u(qt,"hasSingleSpellAttack");function Vt(t,e,i){q(t.find(".spell")),t.find("[data-action=spell-description]").on("click",async s=>{s.preventDefault();let n=$(s.currentTarget).closest(".spell");B(n,e)}),e.isOwner&&(t.find("[data-action=spell-attack]").on("click",async s=>{s.preventDefault();let n=Kt(e);if(!n.length)return;let r;if(qt(n))r=n[0].statistic;else{let a=await Dialog.wait({buttons:{ok:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:C("spells.attacks.ok"),callback:l=>l.find("input:checked").val()}},title:C("spells.attacks.title"),content:await renderTemplate(F("dialogs/spell-attacks"),{attacks:n}),close:()=>null});a&&(r=e.items.get(a)?.statistic)}let o=Ie(s),{map:c}=s.currentTarget.dataset;c&&(o.modifiers=[new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:Number(c)})]),r?.check.roll(o)}),t.find("[data-action=spell-chat]").on("click",async s=>{s.preventDefault(),z(s,e)?.toMessage(s,{create:!0})}),t.find("[data-action=toggle-pips]").on("click contextmenu",async s=>{s.preventDefault();let n=s.type==="click"?1:-1,r=(e.system.resources.focus?.value??0)+n;await e.update({"system.resources.focus.value":r})}),t.find("[data-action=toggle-prepared]").on("click",s=>{s.preventDefault();let{slotLevel:n,slotId:r,entryId:o,expended:c}=$(s.currentTarget).closest(".spell").data();e.spellcasting.collections.get(o)?.setSlotExpendedState(n??0,r??0,c!==!0)}),t.find("[data-action=cast-spell]").on("click",s=>{s.preventDefault();let{slotLevel:n,slotId:r,entryId:o,itemId:c}=$(s.currentTarget).closest(".spell").data(),a=e.spellcasting.collections.get(o,{strict:!0});if(!a)return;let l=a.get(c,{strict:!0});l&&a.entry.cast(l,{slot:r,level:n})}),t.find("[data-input-path]").on("change",async s=>{let{inputPath:n,entryId:r}=$(s.currentTarget).data(),o=s.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:r,[n]:o}])}))}u(Vt,"addSpellsListeners");var Jt={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},me={opposition:{icon:"fa-solid fa-face-angry-horns",label:"PF2E.Actor.Creature.Alliance.Opposition"},party:{icon:"fa-solid fa-face-smile-halo",label:"PF2E.Actor.Creature.Alliance.Party"},neutral:{icon:"fa-solid fa-face-meh",label:"PF2E.Actor.Creature.Alliance.Neutral"}},Vs=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],Js={actions:{getData:Nt,addListeners:Rt},items:{getData:Bt,addListeners:Gt},spells:{getData:Wt,addListeners:Vt},skills:{getData:Lt,addListeners:Ot},extras:{getData:Pt,addListeners:Mt},hazard:{getData:_t,addListeners:jt}},fe={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},Qs={perception:{icon:"fa-solid fa-eye",label:"PF2E.PerceptionLabel"},stealth:{icon:"fa-duotone fa-eye-slash",label:"PF2E.SkillStealth"},athletics:{icon:"fa-solid fa-hand-fist",label:"PF2E.SkillAthletics"}},ge=class extends Application{#e=null;#d=null;#s=null;#a=null;#l=!1;#o=null;#u=[!1,!1,!1];#t=!1;#i=!1;#n=!1;#p;#r;#m;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#p=(e,i)=>{i?this.#h(e):this.#y(e)},this.#r=e=>{let i=e.button;if(![0,2].includes(i))return;if(e.type==="mouseup"){this.#u[i]=!1;return}this.#u[i]=!0;let s=e.target,n=this.element[0];if(n){let r=n.querySelector(".popup");if(r&&!r.contains(s))if(!n.querySelector(".sidebar"))this.forceClose();else return r.remove();s.closest("canvas")&&this.forceClose();return}else this.#g();this.unlock(!0)},this.#m=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#r),window.addEventListener("mouseup",this.#r),Hooks.on("hoverToken",this.#p),Hooks.on("deleteToken",this.#m),Hooks.on("canvasPan",this.forceClose)}setToken(e,i){if(e!==this.#e){delete this.#e?.actor?.apps[this.appId],this.#e=e;let s=e?.actor;s&&(s.apps[this.appId]=this)}this.#n=i??this.#f(e)}setHolding(e){let i=k("use-holding");if(i!=="none"&&(this.#l=e,!(this.#i||this.#t)))if(e){if(!this.#s)return;let s=this.#f(this.#s);if(i==="half"&&!game.user.isGM&&!s){this.#g(),this.render();return}this.setToken(this.#s,s),this.render()}else i==="all"?this.close():game.user.isGM?(this.setToken(this.#s),this.render()):this.#n&&this.close()}#f(e){let i=e?.actor;if(!i)return!1;let s,n=i.system.details.alliance==="party";return game.user.isGM&&k("use-holding")==="half"&&!this.#l||i.isOfType("familiar")&&!i.master?s=!1:s=e.isOwner||k("observer")&&(e.observer||n&&k("party")),s}#h(e){if($(window.document).find(":hover").filter("#combat-popout, #sidebar, #mini-tracker, [id^=pf2e-perception]").length)return;let i=e.actor;if(!i||i.isOfType("loot","party")||e.document.disposition===CONST.TOKEN_DISPOSITIONS.SECRET&&!i.isOwner||(this.#s=e,e!==this.#d&&!this.#t&&this.close(),this.mousedown||this.#t||this.#i||e===this.#e))return;let s=k("use-holding"),n=this.#f(e);s!=="none"&&!this.#l&&(s==="all"||n)||(this.#b(!0),this.setToken(e,n),s==="none"||!this.#l?this.renderWithDelay():this.render())}#y(e){this.#s=null,!(this.mousedown||this.#t||this.#i)&&(this.#o=setTimeout(()=>{this.#o=null,!(this.#i||this.#t)&&this.close()},10))}renderWithDelay(){let e=k("delay");e?(e<10&&(e=10),this.#a=setTimeout(()=>{this.#a=null,this.render()},e)):this.render()}#b(e){this.#o!==null&&(clearTimeout(this.#o),this.#o=null,e&&this.close())}#g(){this.#a!==null&&(clearTimeout(this.#a),this.#a=null)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#r),window.removeEventListener("mouseup",this.#r),Hooks.off("hoverToken",this.#p),Hooks.off("deleteToken",this.#m),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,minimizable:!1,template:F("hud")})}get mousedown(){return this.#u[0]||this.#u[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return!!ze(this.actor)}get isCharacter(){return this.actor?.isOfType("character")}get sidebar(){return this.element?.find("> .sidebar")??[]}get popup(){return this.element?.find("> .popup")??[]}get inner(){return this.element?.find("> .inner")??[]}async getData(){let e=this.#e,i=this.#e?.actor;if(!i)return{};let s=null,n=k("saves"),r=k("others"),o=this.isCharacter,{attributes:c}=i,{hp:a,ac:l}=c,m=a.sp??{max:0,value:0},d=game.settings.get("pf2e","staminaVariant"),p=k("distance"),f=k("scale");if(p==="all"||p==="self"&&this.#n){let I=k("unit").split(","),A=Number(I[0]?.trim())||1,O=I[1]?.trim()||game.system.gridUnits,x=Number(I[2]?.trim())||0,j=canvas.tokens.controlled,Z=!1,ee=j.length===1?j[0]:null;(!ee||ee===e)&&(ee=Ae(),Z=!0),ee&&ee!==e&&(s={unit:O,icon:Z?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(ee)*A).toFixed(x)})}let g;if(!this.#n||k("see-status")){let I=k("status").split(",").map(A=>A.trim()).filter(Boolean);if(I.length&&a.max){let A=a.max+(d?m.max:0),O=a.value+(d?m.value:0),x=Math.clamped(O/A,0,1),j=(()=>{let Z=I.length;return k("last-status")?x===1?Z:Math.ceil(x*(Z-1)):Math.ceil(x*Z)})();g={hue:x*x*122+3,value:j===0?game.i18n.localize("EFFECT.StatusDead"):I.at(j-1)}}}let w={status:g,distance:s,fontSize:f,tokenId:e.id,type:i.isOfType("creature")?"creature":i.type};if(!this.#n||i.isOfType("familiar")&&!i.master)return w;let{level:h,saves:v,isOwner:b,system:E,itemTypes:D}=i,{resistances:M,weaknesses:R,immunities:W}=c;w={...w,isOwner:b,isObserver:this.#n,name:e.document.name,hp:a,ac:l.value,level:h,hasActions:D.action.length||E.actions?.filter(I=>I.visible!==!1).length};let G=k("ranks");function N(I,A,O){let x=I.slug,j=A==="bonus"?K(I.mod):I.dc.value;return{slug:x,value:j,label:O[x].label,icon:O[x].icon,rank:G&&Te[I.rank]}}u(N,"getStatistic");function _(I,A){if(!I.length)return"";let O=I.map(x=>Re(x.label.replace("-"," ").titleCase())).join("");return A?`<li>${game.i18n.localize(A)}<ul>`+O+"</ul></li>":O}if(u(_,"toIWR"),i.isOfType("hazard")){let{hardness:I,emitsSound:A,stealth:O}=c;return{...w,hardness:I,emitsSound:A.toString().capitalize(),immunities:_(W),weaknesses:_(R),resistances:_(M),stealth:{value:O.value,details:await te(O.details,i)},saves:n!=="none"&&["fortitude","reflex","will"].map(x=>{let j=v[x];return j?N(j,n,fe):{slug:x,label:fe[x].label,icon:fe[x].icon}})}}if(w={...w,sidebarTitles:{actions:`${L}.actions.title`,items:`${L}.items.title`,spells:`${L}.spells.title`,skills:`${L}.skills.title`,extras:`${L}.extras.title`},hasItems:i.inventory.size},i.isOfType("vehicle")){let{hardness:I,collisionDC:A,collisionDamage:O}=c,{details:x}=E,{crew:j,passengers:Z,pilotingCheck:ee,speed:us}=x;return{...w,hardness:I,crew:j,passengers:Z,pilotingCheck:ee,speed:us,collisionDC:A.value,collisionDamage:O.value,immunities:_(W),weaknesses:_(R),resistances:_(M),fortitude:N(v.fortitude,n,fe)}}let he=k("show-death"),{heroPoints:P,_source:J}=i,{traits:re,resources:ss}=E,{wounded:Ye,dying:Xe,shield:is,speed:ye,adjustment:ns}=c;function Re(I){return`<li>${I.trim()}</li>`}u(Re,"toInfo");function as(I,A){return H(I,A)}u(as,"sort");let os=re?.languages?.value.map(I=>game.i18n.localize(CONFIG.PF2E.languages[I])).filter(Boolean).sort(as).map(Re).join(""),rs=o?re.senses.map(I=>I.label):re.senses.value?.split(","),ce=Vs.map(({type:I,icon:A},O)=>({index:O,icon:A,label:game.i18n.localize(CONFIG.PF2E.speedTypes[I]??"PF2E.SpeedTypesLand"),value:(O===0?ye.total:ye.otherSpeeds.find(x=>x.type===I)?.total)||0})),Ze=Y(i,`speeds.selected.${game.user.id}`),cs=(()=>{let I=0;if(Ze!==void 0)I=Ze;else if(k("force-speed")||ce[0].value===0){let A={index:0,value:ce[0].value};I=ce.reduce((O,{value:x},j)=>x>O.value?{index:j,value:x}:O,A).index}return ce.splice(I,1)[0]})(),et=ce.map(({value:I,label:A,index:O})=>`<li><a data-index="${O}">${A}: ${I}</a></li>`).join("");ye.details&&(et+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${ye.details}</li>`);let tt=J.system.details?.alliance,Ue=tt===null?"neutral":tt??"default",st=i.hasPlayerOwner?"party":"opposition",ls=[{value:"default",label:game.i18n.format("PF2E.Actor.Creature.Alliance.Default",{alliance:game.i18n.localize(me[st].label)})},{value:"opposition",label:game.i18n.localize(me.opposition.label)},{value:"party",label:game.i18n.localize(me.party.label)},{value:"neutral",label:game.i18n.localize(me.neutral.label)}].filter(({value:I})=>I!==Ue).map(({value:I,label:A})=>`<li><a data-alliance="${I}">${A}</a></li>`).join("");return{...w,sp:d?m:{max:0},hero:P,dying:Xe,wounded:Ye,shield:is,resolve:ss.resolve,adjustment:ns,alliance:me[Ue==="default"?st:Ue],alliances:ls,isCharacter:o,showDeathLine:o&&(he==="always"||Xe.value||Ye.value),digitalPips:k("pips"),hasCover:this.hasCover,saves:n!=="none"&&["fortitude","reflex","will"].map(I=>N(v[I],n,fe)),others:r!=="none"&&["perception","stealth","athletics"].map(I=>N(i.getStatistic(I),r,Qs)),speeds:{main:cs,others:et},iwr:_(W,"PF2E.ImmunitiesLabel")+_(R,"PF2E.WeaknessesLabel")+_(M,"PF2E.ResistancesLabel"),senses:rs?.filter(Boolean).map(Re).join(""),languages:os,hasSpells:i.spellcasting.some(I=>I.category!=="items"),hasNotes:!o&&(E.details.publicNotes||E.details.privateNotes&&b)}}close(e={}){this.setToken(null),this.unlock(!0),this.#i=!1,this.#g();let i=Application.RENDER_STATES;if(!e.force&&![i.RENDERED,i.ERROR].includes(this._state))return;this._state=i.CLOSING;let s=this.element;if(!s)return this._state=i.CLOSED;s.css({minHeight:0});for(let n of this.constructor._getInheritanceChain())Hooks.call(`close${n.name}`,this,s);s.remove(),this._element=null,this._state=i.CLOSED,delete ui.windows[this.appId]}async _render(e=!1,i={}){let s,n,r,o,c;if(this.#d===this.#e){let a=this.sidebar[0];if(a){s=a.dataset.type,n=a.scrollTop;let l=a.querySelector(".sidebar-header");l.classList.contains("show")&&(c=l.querySelector(" input").value.trim())}r=this.popup[0],r&&(o=r.scrollTop)}if(await super._render(e,i),ui.windows[this.appId]=this,s){let a=await this.#c(s,c);n>0&&a.scrollTop(n)}r&&(this.element.append(r),o>0&&(r.scrollTop=o)),this.#d=this.#e,this.inner.length&&k("autolock")==="render"&&this.lock()}render(){this.actor&&super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let i=this.element[0],s=e.worldTransform.a,n=i.getBoundingClientRect(),r=canvas.clientCoordinatesFromCanvas(e.document._source),o={x:r.x,y:r.y,width:e.hitArea.width*s,height:e.hitArea.height*s,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},c,a=this.#n?Jt[k("position")].slice():Jt[k("small-position")].slice();for(;a.length&&!c;){let l=a.shift();l==="left"?(c={x:o.x-n.width,y:Qe(n,o)},c.x<0&&(c=void 0)):l==="right"?(c={x:o.right,y:Qe(n,o)},c.x+n.width>window.innerWidth&&(c=void 0)):l==="top"?(c={x:Qt(n,o),y:o.y-n.height},c.y<0&&(c=void 0)):l==="bottom"&&(c={x:Qt(n,o),y:o.bottom},c.y+n.height>window.innerHeight&&(c=void 0))}return c&&(i.style.left=`${c.x}px`,i.style.top=`${c.y}px`),c}lock(){this.#t=!0}unlock(e){!e&&(this.sidebar.length||k("autolock")!=="none")||(this.#t=!1)}activateListeners(e){let i=this.#e,s=i?.actor;if(!s)return;let n=i.isOwner,r=Q();k("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.find("[data-action=show-notes").on("click",async a=>{a.preventDefault();let{publicNotes:l,privateNotes:m,blurb:d}=s.system.details,p=s.system.traits.value.map(g=>({label:game.i18n.localize(CONFIG.PF2E.creatureTraits[g])??g,description:game.i18n.localize(CONFIG.PF2E.traitsDescriptions[g])??""})),f=await renderTemplate(F("show-notes"),{traits:p,blurb:d.trim(),publicNotes:l.trim(),privateNotes:n&&m.trim()});ie(`${s.name} - ${game.i18n.localize("PF2E.NPC.NotesTab")}`,f,s)}),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(k("autolock")==="hover"&&this.lock(),this.#i=!0)}),e.on("mouseleave",()=>{this.#i=!1,!(this.#t||this.#s)&&this.close()}),e.on("dragover",()=>{i.isOwner&&e.find("> .sidebar.extras").length&&!e.find("> .popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let o=e.find("[data-action=show-info]");o.tooltipster({position:["top","bottom","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click"}),o.filter(".stealth").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(a,{origin:l,tooltip:m})=>{this.lock(),$(m).find(".content-link").on("click",()=>setTimeout(()=>a.close(),10))}).tooltipster("option","functionAfter",()=>this.unlock()),(n?o.filter(":not(.speeds):not(.stealth)"):o).on("mouseleave",a=>{$(a.currentTarget).tooltipster("hide")}),e.find("[data-action=open-sidebar]").on("click",this.#c.bind(this)),n&&(e.find("[data-action=toggle-adjustment]").on("click contextmenu",a=>{a.preventDefault();let l=a.type==="click"?"elite":"weak";s.applyAdjustment(s.system.attributes.adjustment===l?null:l)}),e.find("[data-action=toggle-alliance]").tooltipster({position:["bottom","top","left","right"],theme:"crb-hover",arrow:!1,animationDuration:0,contentAsHTML:!0,trigger:"click",interactive:!0,functionReady:(a,{origin:l,tooltip:m})=>{this.lock(),m.querySelectorAll("[data-alliance]").forEach(d=>{d.addEventListener("click",async p=>{p.preventDefault();let f=d.dataset.alliance;f==="default"?s.update({"system.details.-=alliance":null}):s.update({"system.details.alliance":f==="neutral"?null:f})})})},functionAfter:()=>this.unlock()}),e.find("[data-action=collision-dc]").on("click",a=>{a.preventDefault();let l=s.system.attributes.collisionDC.value||15;r.create({content:`@Check[type:reflex|dc:${l}]`,speaker:r.getSpeaker({actor:s})})}),e.find("[data-action=collision-damage]").on("click",async a=>{a.preventDefault();let l=(s.system.attributes.collisionDamage.value||"1d6").trim();isNaN(Number(l.at(-1)))||(l+="[bludgeoning]");let m=nt(),d=await new m(l).evaluate({async:!0});r.create({flavor:`<strong>${game.i18n.localize("PF2E.vehicle.collisionDamageLabel")}</strong>`,speaker:r.getSpeaker({actor:s}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:"sounds/dice.wav",rolls:[d]})}),e.find("input").on("change",async a=>{let l=a.currentTarget,m=l.valueAsNumber,d=l.name;l.blur(),d!=="shield.value"?await s.update({[d]:m}):await s.heldShield.update({"system.hp.value":m})}),e.find("[data-action=toggle-hero]").on("click contextmenu",a=>{a.preventDefault();let{max:l,value:m}=s.heroPoints,d=a.type==="click"?1:-1,p=Math.clamped(m+d,0,l);p!==m&&s.update({"system.resources.heroPoints.value":p})}),e.find("[data-action=raise-shield]").on("click",a=>{a.preventDefault(),game.pf2e.actions.raiseAShield({actors:[s],tokens:[i]})}),e.find("[data-action=take-cover]").on("click",async a=>{a.preventDefault();let l=ze(s);l?l.delete():game.pf2e.actions.get("take-cover").use({actors:[s],tokens:[i]})}),e.find("[data-action=roll-save]").on("click",a=>{a.preventDefault();let l=a.currentTarget.dataset.save;s.saves[l].roll({event:a})}),e.find("[data-action=roll-other]").on("click",a=>{a.preventDefault();let l=a.currentTarget.dataset.slug;if(l!=="athletics"){let{ctrlKey:m,metaKey:d,shiftKey:p}=a;a=new MouseEvent("click",{ctrlKey:!m,metaKey:d,shiftKey:p})}s.getStatistic(l)?.roll({event:a})}),e.find("[data-action=recovery-check]").on("click",a=>{a.preventDefault(),s.rollRecovery(a)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",a=>{a.preventDefault();let l=a.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",m=s.system.attributes[l]?.max;m&&(a.type==="click"?s.increaseCondition(l,{max:m}):s.decreaseCondition(l))}),e.find("[data-action=use-resolve]").on("click",a=>{a.preventDefault(),it(s)}),o.filter(".speeds").tooltipster("option","interactive",!0).tooltipster("option","functionReady",(a,{origin:l,tooltip:m})=>{this.lock(),m.querySelectorAll("[data-index]").forEach(d=>{d.addEventListener("click",async p=>{p.preventDefault(),await se(s,`speeds.selected.${game.user.id}`,Number(d.dataset.index))})})}).tooltipster("option","functionAfter",()=>this.unlock()))}async showFilter(){let e=this.sidebar;e.length&&(e.find(".sidebar-header").hasClass("show")||(e=await this.#c(e.data().type,"")),e.find(".sidebar-header").find("input").focus().select(),e.scrollTop(0))}async#c(e,i){e=typeof e=="string"?e:e.currentTarget.dataset.type;let s=this.element,n=this.sidebar,r=n[0]?.dataset.type;if(n.remove(),s.find("[data-action=open-sidebar]").removeClass("active"),r===e&&i===void 0){this.unlock();return}let o=this.#e,c=o.actor,a=i!==void 0||k("filter"),{getData:l,addListeners:m}=Js[e],d=await l(c,o,i?.toLowerCase())??{};if(!d.contentData&&!a)return ui.notifications.warn(C(`${e}.empty`,{name:this.#e.name}));let p={...d.contentData??{},isGM:game.user.isGM,isCharacter:this.isCharacter,isOwner:c.isOwner};this.lock(),s.find(`[data-action=open-sidebar][data-type=${e}]`).addClass("active"),s=s[0];let f=d.classes??[];f.push(e),k("scrollbar")||f.push("no-scrollbar"),d.doubled&&f.push("doubled");let g=d.style??{};g["--max-height"]=k("height").trim()||"100%";let w=document.createElement("div");w.innerHTML=await renderTemplate(F("sidebar"),{classes:f.join(" "),style:Object.entries(g).map(([R,W])=>`${R}: ${W}`).join("; "),type:e,filter:i,filterLabel:C("filter"),showFilter:a,content:(await renderTemplate(F(`sidebars/${e}`),p)).trim()}),n=w.firstElementChild,s.append(n);let h=n.getBoundingClientRect(),v=s.getBoundingClientRect(),b;k("position")==="left"?(b=v.x-h.width,b<0&&(b=v.right)):(b=v.right,b+h.width>window.innerWidth&&(b=v.x-h.width));let D=parseInt(window.getComputedStyle(s).padding),M=Qe(h,v,D);return n.style.left=`${b}px`,n.style.top=`${M}px`,n=$(n),n.find(".sidebar-header [data-action=sidebar-filter-clear]").on("click",R=>{R.preventDefault(),n.find(".sidebar-header [data-action=sidebar-filter]").val(""),this.#c(e,"")}),n.find(".sidebar-header [data-action=sidebar-filter]").on("keydown",R=>{R.key==="Enter"&&this.#c(e,R.currentTarget.value.trim())}),m(n,c,o),Hooks.callAll("renderHUDSidebar",e,n,this),n}};u(ge,"HUD");function Qe(t,e,i=0){let s=e.y+e.height/2-t.height/2;return s+t.height>window.innerHeight&&(s=window.innerHeight-t.height-i),s<0&&(s=i),s}u(Qe,"postionFromTargetY");function Qt(t,e){let i=e.x+e.width/2-t.width/2;return i+t.width>window.innerWidth&&(y=window.innerWidth-t.width),i<0&&(i=0),i}u(Qt,"postionFromTargetX");var L="pf2e-token-hud",ae=null;function X(t=!1){return t?ae?.element:ae}u(X,"getHud");function $e(t){t&&!ae?ae=new ge:!t&&ae&&(ae.delete(),ae=null)}u($e,"enableModule");function k(t){return game.settings.get(L,t)}u(k,"getSetting");function C(...t){let e=t.at(-1),i=typeof e=="object",s=i?t.slice(0,-1):t;return s.unshift(L),game.i18n[i?"format":"localize"](s.join("."),e)}u(C,"localize");function We(t,e){return t.itemTypes.feat.some(i=>i.sourceId===e)}u(We,"hasFeat");function F(t){return`modules/${L}/templates/${t}.hbs`}u(F,"templatePath");function K(t){return t>=0?`+${t}`:t}u(K,"modifier");function Y(t,e){return t.getFlag(L,e)}u(Y,"getFlag");function se(t,e,i){return t.setFlag(L,e,i)}u(se,"setFlag");async function te(t,e,{isOwner:i=e.isOwner,rollData:s=e.getRollData()}={}){return t=t?.trim(),t?await TextEditor.enrichHTML(t,{async:!0,secrets:i,rollData:s}):""}u(te,"enrichHTML");function Ce(t,e){if(typeof t!="object")return!1;for(;t=Reflect.getPrototypeOf(t);)if(t.constructor.name===e)return!0;return!1}u(Ce,"isInstanceOf");function Zt(){Xt("hold",{onDown:()=>{k("use-holding")!=="none"&&X()?.setHolding(!0)},onUp:()=>{X()?.setHolding(!1)}}),Xt("filter",{onUp:()=>{X()?.showFilter()},editable:[{key:"KeyQ",modifiers:["Control"]}]})}u(Zt,"registerKeybindings");function Yt(t,e){return`${L}.keybinds.${t}.${e}`}u(Yt,"path");function Xt(t,e={}){game.keybindings.register(L,t,{name:Yt(t,"name"),hint:Yt(t,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}u(Xt,"register");function es(){let t=game.data.users.find(i=>i._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(i=>C(`settings.status.statuses.${i}`)).join(", ");S("status",String,e,{scope:"world"}),S("last-status",Boolean,!1,{scope:"world"}),S("party",Boolean,!1,{scope:"world"}),S("enabled",Boolean,!0,{onChange:$e}),S("position",String,"right",{choices:{left:T("position","choices.left"),right:T("position","choices.right"),top:T("position","choices.top"),bottom:T("position","choices.bottom")}}),S("small-position",String,"top",{choices:{left:T("position","choices.left"),right:T("position","choices.right"),top:T("position","choices.top"),bottom:T("position","choices.bottom")}}),S("delay",Number,250,{range:{min:0,max:2e3,step:50}}),S("scale",Number,14,{range:{min:10,max:30,step:1}}),S("use-holding",String,"none",{hint:T("use-holding",t?"choices.gm.hint":"choices.player.hint"),choices:{none:T("use-holding","choices.none"),half:T("use-holding",t?"choices.gm.half":"choices.player.half"),all:T("use-holding",t?"choices.gm.all":"choices.player.all")}}),S("autolock",String,"none",{choices:{none:T("autolock","choices.none"),hover:T("autolock","choices.hover"),render:T("autolock","choices.render")}}),S("observer",Boolean,!0),S("see-status",Boolean,!1),S("saves",String,"bonus",{choices:{none:T("saves","choices.none"),bonus:T("saves","choices.bonus"),dc:T("saves","choices.dc")}}),S("others",String,"none",{choices:{none:T("saves","choices.none"),bonus:T("saves","choices.bonus"),dc:T("saves","choices.dc")}}),S("ranks",Boolean,!1),S("show-death",String,"always",{choices:{none:T("show-death","choices.none"),always:T("show-death","choices.always"),only:T("show-death","choices.only")}}),S("force-speed",Boolean,!1),S("tooltips",Boolean,!1),S("pips",Boolean,!1),S("distance",String,"all",{choices:{none:T("distance","choices.none"),self:T("distance","choices.self"),all:T("distance","choices.all")}}),S("unit",String,""),S("height",String,""),S("filter",Boolean,!1),S("scrollbar",Boolean,!0),S("hazard-width",Number,32,{range:{min:14,max:50,step:1}}),S("actions-columns",Boolean,!1),S("items-columns",Boolean,!1),S("spells-columns",Boolean,!1),S("skills-columns",Boolean,!1),S("actions",String,"split",{choices:{name:T("actions","choices.name"),type:T("actions","choices.type"),split:T("actions","choices.split")}}),S("actions-colors",Boolean,!0),S("containers",Boolean,!1),S("spells",Boolean,!1),S("tradition",Boolean,!1),S("untrained",Boolean,!0)}u(es,"registerSettings");function ts(t,e){let i=e.find(`.tab[data-tab=${L}]`);function s(n,r,o="h3"){let c=C(`menu.${r}`);i.find(`[name="${L}.${n}"]`).closest(".form-group").before(`<${o}>${c}</${o}>`)}u(s,"beforeGroup"),game.user.isGM&&s("enabled","client.header","h2"),s("saves","client.tooltip"),s("distance","client.distance"),s("height","client.sidebar"),s("actions","client.actions"),s("containers","client.items"),s("spells","client.spells"),s("untrained","client.skills")}u(ts,"renderSettingsConfig");function T(t,e){return`${L}.settings.${t}.${e}`}u(T,"path");function S(t,e,i,s={}){game.settings.register(L,t,{name:T(t,"name"),hint:T(t,"hint"),scope:"client",config:!0,type:e,default:i,...s})}u(S,"register");Hooks.once("setup",async()=>{es(),Zt(),await loadTemplates({creature:F("tooltips/creature"),hazard:F("tooltips/hazard"),vehicle:F("tooltips/vehicle")})});Hooks.once("ready",()=>{k("enabled")&&$e(!0),game.modules.get("pf2e-token-hud").api={getHud:X}});Hooks.on("renderSettingsConfig",ts);Hooks.on("drawMeasuredTemplate",t=>{t.isPreview&&X()?.close()});Hooks.on("getActorDirectoryEntryContext",(t,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${L}.actor.macros.contextmenu`,condition:i=>{let{documentId:s}=i.data();return k("enabled")&&game.actors.get(s)?.isOwner},callback:i=>{let{documentId:s}=i.data();Ys(s)}})});var Ne=class extends Dialog{async getData(e={}){let i=super.getData(e);return typeof i.content=="function"&&(i.content=await i.content()),i}};u(Ne,"DataDialog");function Ys(t){let e=game.actors.get(t);if(!e)return;let i=new Ne({title:`${e.name} - ${C("actor.macros.title")}`,content:async()=>{let s=Ee(e)??[];return renderTemplate(F("dialogs/macros"),{macros:s,noMacro:C("extras.no-macro")})},buttons:{},render:s=>{e.apps[i.appId]=i,s.on("drop",n=>De(n,e)),s.find("[data-action=delete-macro]").on("click",n=>xe(n,e))},close:()=>{delete e.apps[i.appId]}},{height:"auto"}).render(!0)}u(Ys,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
