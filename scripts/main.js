(()=>{var Et=Object.defineProperty;var zn=(t,e,i)=>e in t?Et(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var l=(t,e)=>Et(t,"name",{value:e,configurable:!0});var Ie=(t,e,i)=>(zn(t,typeof e!="symbol"?e+"":e,i),i),Bn=(t,e,i)=>{if(!e.has(t))throw TypeError("Cannot "+i)};var Ee=(t,e,i)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,i)};var J=(t,e,i)=>(Bn(t,e,"access private method"),i);function Ct(t,e,i){let n={};for(let o of t){let s=Array.isArray(o)?o[i??0]:typeof o=="object"&&i!=null?o[i]:o;n[s]=e(o)}return n}l(Ct,"arrayToObject");var _i=(async()=>{}).constructor;var ct=null,K={get id(){if(!ct)throw new Error("Module id needs to be registered.");return ct},error(t){throw new Error(`[${this.id}] ${t}`)}};function At(t){ct=t}l(At,"registerModule");function Dt(t){t.key??=t.name,Array.isArray(t.choices)&&(t.choices=Ct(t.choices,e=>re(t.key,"choices",e))),t.name=re(t.key,"name"),t.hint=re(t.key,"hint"),t.scope??="world",t.config??=!0,game.settings.register(K.id,t.key,t)}l(Dt,"registerSetting");function re(...t){return`${K.id}.settings.${t.join(".")}`}l(re,"settingPath");function Ft(t){return game.settings.get(K.id,t)}l(Ft,"getSetting");async function Oe({target:t,selected:e,direction:i="DOWN",onCreate:n,onDismiss:o,onClick:s,content:r,cssClass:c=[],locked:a=!1}){return new Promise(u=>{let f=`${K.id}-tooltip`,p=document.body.querySelectorAll(`.${f}:not(#tooltip)`);for(let d of p)Ce(d);requestAnimationFrame(()=>{c=typeof c=="string"?[c]:c,e&&c.push("selection-tooltip"),Array.isArray(r)&&(r=r.map(({value:g,label:h})=>`<li><a ${g===e?'class="selected"':""} data-value="${g}">${h}</a></li>`).join(""));let d;if(r instanceof HTMLElement?d=r:(d=document.createElement("ul"),d.innerHTML=r),d.style.setProperty("--font-size",`${Ft("scale")}px`),c.length&&d.classList.add(...c.map(g=>`${K.id}-${g}`)),o&&new MutationObserver(function(){document.body.contains(d)||(o(),this.disconnect())}).observe(document.body,{childList:!0}),s){a=!0;for(let g of d.querySelectorAll("[data-value]"))g.addEventListener("click",async h=>{h.preventDefault(),Ce(h.currentTarget),s?.(h.currentTarget.dataset.value)})}game.tooltip.activate(t,{content:d,direction:i,locked:a,cssClass:f}),n?.(d),u(d)})})}l(Oe,"createTooltip");function Ce(t){let e=t.closest(`.${K.id}-tooltip`);game.tooltip.dismissLockedTooltip(e)}l(Ce,"dismissTooltip");var Gn=function(t,e,i){if(i||arguments.length===2)for(var n=0,o=e.length,s;n<o;n++)(s||!(n in e))&&(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return t.concat(s||Array.prototype.slice.call(e))};function Mt(t,e,i){var n=t.length-e.length,o=Array.from(e);if(n===0)return t.apply(void 0,o);if(n===1){var s=l(function(r){return t.apply(void 0,Gn([r],o,!1))},"ret");return(i||t.lazy)&&(s.lazy=i||t.lazy,s.lazyArgs=e),s}throw new Error("Wrong number of arguments")}l(Mt,"purry");function Pt(t){return!!t}l(Pt,"isTruthy");function lt(t){return t.filter(Pt)}l(lt,"compact");function Lt(t,e,i){for(var n=[],o=0;o<t.length;o++){var s=t[o],r=i?e(s,o,t):e(s);r.hasMany===!0?n.push.apply(n,r.next):r.hasNext&&n.push(r.next)}return n}l(Lt,"_reduceLazy");function Nt(t){return Array.isArray(t)}l(Nt,"isArray");function Rt(t){return!!t&&!Array.isArray(t)&&typeof t=="object"}l(Rt,"isObject");function $t(t){return typeof t=="string"}l($t,"isString");function jt(t){return t===void 0?!0:Nt(t)||$t(t)?t.length===0:Rt(t)?Object.keys(t).length===0:!1}l(jt,"isEmpty");function Ut(t){return t==null}l(Ut,"isNil");function ce(){return Mt(qn,arguments,ce.lazy)}l(ce,"uniq");function qn(t){return Lt(t,ce.lazy())}l(qn,"_uniq");(function(t){function e(){var i=new Set;return function(n){return i.has(n)?{done:!1,hasNext:!1}:(i.add(n),{done:!1,hasNext:!0,next:n})}}l(e,"lazy"),t.lazy=e})(ce||(ce={}));function Ht(t={}){let{include:e=actorTypes,exclude:i=[],assignedFallback:n=!1}=t,o=ce(game.user.getActiveTokens().flatMap(r=>r.actor&&(e.length===0||r.actor.isOfType(...e))&&(i.length===0||!r.actor.isOfType(...i))?r.actor:[])),s=game.user.character;return o.length>0||!n||!s?o:(e.length===0||s.isOfType(...e))&&(i.length===0||!s.isOfType(...i))?[s]:[]}l(Ht,"getSelectedActors");function Ae(t,e){return t instanceof Element||t instanceof Document?Array.from(t.querySelectorAll(e)):[]}l(Ae,"htmlQueryAll");function _t(t,{classes:e=[],dataset:i={},children:n=[],innerHTML:o}={}){let s=document.createElement(t);e.length>0&&s.classList.add(...e);for(let[r,c]of Object.entries(i).filter(([,a])=>!Ut(a)&&a!==!1))s.dataset[r]=c===!0?"":String(c);if(o)s.innerHTML=o;else for(let r of n){let c=r instanceof HTMLElement?r:new Text(r);s.appendChild(c)}return s}l(_t,"createHTMLElement");function we(t,e){return t instanceof Element?t.closest(e):null}l(we,"htmlClosest");function Bt(t){let e=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),i=game.i18n.localize(`PF2E.OrdinalSuffixes.${e.select(t)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:t,suffix:i})}l(Bt,"ordinalString");function pe(t){return Error(`PF2e System | ${t}`)}l(pe,"ErrorPF2e");function $e(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}l($e,"objectHasKey");function Gt(t){return(...[e,i])=>i?game.i18n.format(`${t}.${e}`,i):game.i18n.localize(`${t}.${e}`)}l(Gt,"localizer");var Wn={0:"F",free:"F",1:"A",2:"D",3:"T","1 or 2":"A/D","1 to 3":"A - T","2 or 3":"D/T",reaction:"R"};function je(t){if(!t&&t!==0)return"";let e=typeof t!="object"?t:t.type==="action"?t.value:t.type,i=String(e??"").toLowerCase().trim();return Wn[i]?.replace("-","\u2013")??""}l(je,"getActionGlyph");var zt={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"};function qt(t,e="systems/pf2e/icons/actions/Empty.webp"){if(t===null)return zt.passive;let i=typeof t!="object"?t:t.type==="action"?t.value:t.type,n=String(i??"").toLowerCase().trim();return zt[n]??e}l(qt,"getActionIcon");function de(t,e){return game.pf2e.system.sluggify(t,e)}l(de,"sluggify");function Ue(t,e){return t.has(e)}l(Ue,"setHasElement");function He(t,e){return t.includes(e)}l(He,"tupleHasValue");function Wt(t,e){let i={name:t,label:game.i18n.localize(e[t]??t),description:null};return $e(CONFIG.PF2E.traitsDescriptions,t)&&(i.description=CONFIG.PF2E.traitsDescriptions[t]),i}l(Wt,"traitSlugToObject");async function Vt(t,e="roll"){if(!t.system.selfEffect)throw pe(["Only actions with self-applied effects can be passed to `ActorPF2e#useAction`.","Support will be expanded at a later time."].join(" "));let{actor:i,actionCost:n}=t,o=i.getActiveTokens(!0,!0).shift()??null,s=ChatMessage.implementation,r=s.getSpeaker({actor:i,token:o}),c=await renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{title:t.name,glyph:je(n)},item:t,traits:t.system.traits.value.map(h=>Wt(h,CONFIG.PF2E.actionTraits))}),a=100,u=(()=>{if(t.actor.pack)return null;let h=document.createElement("div"),m=[...CONST.DOCUMENT_LINK_TYPES,"Compendium","UUID"],k=new RegExp(`@(${m.join("|")})\\[([^#\\]]+)(?:#([^\\]]+))?](?:{([^}]+)})?`,"g");return h.innerHTML=t.description.replace(k,(v,...x)=>x[3]),h.innerText.slice(0,a)})(),f={full:u&&u.length<a?t.description:null,preview:u},p=await renderTemplate("systems/pf2e/templates/chat/action/self-effect.hbs",{actor:t.actor,description:f}),d={pf2e:{context:{type:"self-effect",item:t.id}}},g=s.applyRollMode({speaker:r,flavor:c,content:p,flags:d},e);return s.create(g)}l(Vt,"createSelfEffectMessage");function Kt(){return CONFIG.Dice.rolls.find(t=>t.name==="DamageRoll")}l(Kt,"getDamageRollClass");var Kn=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),Yn=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function De(t,{pwol:e,rarity:i="common"}={}){e??=game.pf2e.settings.variants.pwol.enabled;let n=Yn.get(t)??14;return _e(e?n-Math.max(t,0):n,i)}l(De,"calculateDC");function _e(t,e="common"){return Qn(t,Xn(e))}l(_e,"adjustDCByRarity");function Qn(t,e="normal"){return t+(Kn.get(e)??0)}l(Qn,"adjustDC");function Xn(t="common"){switch(t){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}l(Xn,"rarityToDCAdjustment");var Yt=["burst","cone","cube","cylinder","emanation","line","square"],ze=new Set(["arcane","divine","occult","primal"]);function Qt(t){if(t==="cantrips")return 0;let e=Number(t??NaN);return e.between(0,10)?e:null}l(Qt,"spellSlotGroupIdToNumber");function Xt(t){if(t==="cantrips")return t;let e=Number(t)||NaN;return e.between(1,10)?e:null}l(Xt,"coerceToSpellGroupId");var Fe=class extends FormApplication{static get defaultOptions(){return{...FormApplication.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}dcs=Jn(this.object,{pwol:game.pf2e.settings.variants.pwol.enabled,notMatchingTraditionModifier:game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier")});async getData(){let e=this.object;return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:this.dcs}}activateListeners(e){let i=e[0],n=i.querySelector<HTMLButtonElement>"button.update-identification";n?.addEventListener("click",()=>{this.submit({updateData:{status:n.value}})}),i.querySelector("button.post-skill-checks")?.addEventListener("click",async()=>{let o=this.object,s=o.system.identification.identified.name,r=this.dcs,c=o.isMagical?"identify-magic":o.isAlchemical?"identify-alchemy":"recall-knowledge",a=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{identifiedName:s,action:c,skills:R.omit(r,["dc"]),unidentified:o.system.identification.unidentified,uuid:o.uuid});await ChatMessage.implementation.create({user:game.user.id,content:a})})}async _updateObject(e,i){let n=i.status;if(n==="identified")return this.object.setIdentificationStatus(n)}};l(Fe,"IdentifyItemPopup");function Jn(t,{pwol:e=!1,notMatchingTraditionModifier:i}){let n=De(t.level,{pwol:e}),o=Zn(t),s=_e(n,o);return t.isMagical?ei(t,s,i):{crafting:s}}l(Jn,"getItemIdentificationDCs");function Zn(t){return t.traits.has("cursed")?"unique":t.rarity}l(Zn,"getDcRarity");function ei(t,e,i){let n={occult:e,primal:e,divine:e,arcane:e},o=ti(t);for(let s of ze)o.size>0&&!o.has(s)&&(n[s]=e+i);return{arcana:n.arcane,nature:n.primal,religion:n.divine,occultism:n.occult}}l(ei,"getIdentifyMagicDCs");function ti(t){let e=t.system.traits.value;return new Set(e.filter(i=>Ue(ze,i)))}l(ti,"getMagicTraditions");function Jt(t){return!!t&&"ctrlKey"in t&&"metaKey"in t&&"shiftKey"in t}l(Jt,"isRelevantEvent");function Be(t,e){let i=e.type==="check"?"showCheckDialogs":"showDamageDialogs",n=!game.user.settings[i];if(!Jt(t))return{skipDialog:n};let o={skipDialog:t.shiftKey?!n:n};return(t.ctrlKey||t.metaKey)&&(o.rollMode=game.user.isGM?"gmroll":"blindroll"),o}l(Be,"eventToRollParams");function Ge(t){return!Jt(t)||!(t.ctrlKey||t.metaKey)?"roll":game.user.isGM?"gmroll":"blindroll"}l(Ge,"eventToRollMode");var Zt=["fortitude","reflex","will"],en=["action","check","effect-area"].map(t=>`[data-pf2-${t}]`).join(","),ee={injectRepostElement:(t,e)=>{for(let i of t){(!e||e.isOwner)&&i.classList.add("with-repost");let n=Ae(i,"i[data-pf2-repost]");if(n.length>0){if(e&&!e.isOwner){for(let r of n)r.remove();i.classList.remove("with-repost")}continue}if(e&&!e.isOwner)continue;let o=document.createElement("i"),s=i.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";o.classList.add("fa-solid",s),o.dataset.pf2Repost="",o.title=game.i18n.localize("PF2E.Repost"),i.appendChild(o),o.addEventListener("click",r=>{r.stopPropagation();let c=r.target;if(!(c instanceof HTMLElement))return;let a=c?.parentElement;if(!a)return;let u=tn(c,e);ee.repostAction(a,u)})}},listen:(t,e=tn(t))=>{let i=Ae(t,en).filter(o=>["A","SPAN"].includes(o.nodeName));ee.injectRepostElement(i,e),ee.flavorDamageRolls(t,e instanceof Actor?e:null);for(let o of i.filter(s=>s.dataset.pf2Action)){let{pf2Action:s,pf2Glyph:r,pf2Variant:c,pf2Dc:a,pf2ShowDc:u,pf2Skill:f}=o.dataset;o.addEventListener("click",p=>{let d=de(s??""),g=u??"all",h=Number.isNumeric(a)?{scope:"check",value:Number(a)||0,visibility:g}:a;if(d&&game.pf2e.actions.has(d))game.pf2e.actions.get(d)?.use({event:p,variant:c,difficultyClass:h,statistic:f}).catch(m=>ui.notifications.warn(m));else{let m=game.pf2e.actions[s?de(s,{camel:"dromedary"}):""];s&&m?m({event:p,glyph:r,variant:c,difficultyClass:h,skill:f}):console.warn(`PF2e System | Skip executing unknown action '${s}'`)}})}for(let o of i.filter(s=>s.dataset.pf2Check&&!s.dataset.invalid)){let{pf2Check:s,pf2Dc:r,pf2Traits:c,pf2Label:a,pf2Defense:u,pf2Adjustment:f,pf2Roller:p,pf2RollOptions:d}=o.dataset,g="overrideTraits"in o.dataset,h="targetOwner"in o.dataset;if(!s)return;o.addEventListener("click",async m=>{let k=ft(e,o),v=(()=>{switch(p){case"self":return k?.canUserModify(game.user,"update")?[k]:[];case"party":return k?.isOfType("party")?[k]:lt([game.actors.party])}let z=[(()=>{let O=e instanceof Actor?e:e instanceof Item&&e.actor?e.actor:null;return O?.isOwner&&!O.isOfType("loot","party")?O:null})()??Ht({exclude:["loot"],assignedFallback:!0})].flat(),U=He(Zt,s);return k?.isOfType("party")||z.length===0&&k&&!U?[k]:z})();if(v.length===0){ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected",{localize:!0});return}let x=[...c?.split(",").map(j=>j.trim())??[],...d?.split(",").map(j=>j.trim())??[]],C=Be(m,{type:"check"}),N=o.dataset.slug?de(o.dataset.slug):null;switch(s){case"flat":{for(let j of v){let z=new j.saves.reflex.constructor(j,{label:"",slug:"flat",modifiers:[],check:{type:"flat-check"}}),U=Number.isInteger(Number(r))?{label:a,value:Number(r)}:null;z.roll({...C,slug:N,extraRollOptions:x,dc:U})}break}default:{let j=He(Zt,s),z=j?[]:x.filter(U=>U in CONFIG.PF2E.actionTraits)??[];for(let U of v){let O=(()=>{if(s in CONFIG.PF2E.magicTraditions&&U.isOfType("creature")){let M=U.spellcasting.filter(B=>B.tradition===s).flatMap(B=>B.statistic??[]).sort((B,ke)=>ke.check.mod-B.check.mod).shift()??null;if(M)return M}return U.getStatistic(s)})();if(!O){console.warn(pe(`Skip rolling unknown statistic ${s}`).message);continue}let H=u?h?k:game.user.targets.first()?.actor:null,E=(()=>{let M=Number(f)||0;return r==="@self.level"?De(U.level)+M:Number(r??"NaN")+M})(),W=(()=>{if(Number.isInteger(E))return{label:a,value:E};if(u){let M=H?.getStatistic(u);return M?{statistic:M.dc,scope:"check",value:M.dc.value}:null}return null})(),D=(()=>{let M=e instanceof Item?e:e instanceof ChatMessage?e.item:null;return M?.isOfType("action","feat","campaignFeature")||j&&!M?.isOfType("weapon")?M:null})(),Q={...C,extraRollOptions:x,origin:j&&k instanceof Actor?k:null,dc:W,target:!j&&W?.statistic?H:null,item:D,traits:z};if(!g&&!!(D?.isOfType("action","feat")&&D.actionCost)&&!["flat-check","saving-throw"].includes(O.check.type)){let M=s in CONFIG.PF2E.magicTraditions?"PF2E.ActionsCheck.spell":O.check.type==="attack-roll"?"PF2E.ActionsCheck.x-attack-roll":"PF2E.ActionsCheck.x";Q.label=await renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:je(D.actionCost),subtitle:game.i18n.format(M,{type:O.label}),title:D.name}),x.push(...ni(D))}O.roll(Q)}}}})}let n={burst:"circle",cone:"cone",cube:"rect",emanation:"circle",line:"ray",rect:"rect",square:"rect"};for(let o of i.filter(s=>s.hasAttribute("data-pf2-effect-area"))){let{pf2EffectArea:s,pf2Distance:r,pf2TemplateData:c,pf2Traits:a,pf2Width:u}=o.dataset;o.addEventListener("click",()=>{if(!canvas.ready)return;if(typeof s!="string"){console.warn("PF2e System | Could not create template'");return}let f=JSON.parse(c??"{}");switch(f.distance||=Number(r),f.fillColor||=game.user.color,f.t=n[s],f.t){case"ray":f.width=Number(u)||CONFIG.MeasuredTemplate.defaults.width*canvas.dimensions.distance;break;case"cone":f.angle||=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let m=f.distance??0;f.distance=Math.hypot(m,m),f.width=m,f.direction=45;break}}let p={pf2e:{}},d=Math.ceil(f.distance)/5*5||5;He(Yt,s)&&f.distance===d&&(p.pf2e.areaShape=s);let g=e instanceof ChatMessage?e.id:we(t,"[data-message-id]")?.dataset.messageId??null;g&&(p.pf2e.messageId=g);let h=ft(e,o);if(h||a){let m={};h&&(m.actor=h.uuid),a&&(m.traits=a.split(",")),p.pf2e.origin=m}jt(p.pf2e)||(f.flags=p),canvas.templates.createPreview(f)})}for(let o of t.querySelectorAll("a[data-damage-roll]"))o.dataset.itemUuid=e.uuid},makeRepostHtml:(t,e)=>{let i=game.i18n.localize(t.dataset.pf2RepostFlavor??"");return`<span data-visibility="${t.dataset.pf2ShowDc??e}">${i}</span> ${t.outerHTML}`.trim()},repostAction:async(t,e=null)=>{if(!["pf2Action","pf2Check","pf2EffectArea"].some(u=>u in t.dataset))return;let i=ft(e,t),n=(i??e)?.hasPlayerOwner?"all":"gm",o=(()=>t.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${Ae(t.parentElement,en).map(f=>ee.makeRepostHtml(f,n)).join("<br>")}</div>`:ee.makeRepostHtml(t,n))(),s=ChatMessage.implementation,r=i?s.getSpeaker({actor:i,token:i.getActiveTokens(!0,!0).shift()}):s.getSpeaker(),c=game.messages.get(we(t,"[data-message-id]")?.dataset.messageId??""),a=e instanceof JournalEntry?{pf2e:{journalEntry:e.uuid}}:c?.flags.pf2e.origin?{pf2e:{origin:fu.deepClone(c.flags.pf2e.origin)}}:{};return s.create({speaker:r,content:o,flags:a})},flavorDamageRolls(t,e=null){for(let i of Ae(t,"a.inline-roll[data-damage-roll]")){let n=we(i,"[data-item-id]")?.dataset.itemId,o=e?.items.get(n??"");o&&(i.dataset.flavor||=o.name)}}};function tn(t,e){if(e)return e;let n=(ui.windows[Number(t.closest(".app.sheet")?.dataset.appid)]??null)?.document;return n instanceof Actor||n instanceof JournalEntry?n:null}l(tn,"resolveDocument");function ft(t,e){if(t instanceof Actor)return t;if(t instanceof Item||t instanceof ChatMessage)return t.actor;let i=e.dataset.itemUuid,n=i&&!i.startsWith("Compendium.")?fromUuidSync(i):null;return n instanceof Item?n.actor:null}l(ft,"resolveActor");function ni(t,e=[]){if(!t?.isOfType("action","feat")||!t.actionCost)return[];let i=t.slug??de(t.name),n=ce([t.system.traits.value,e.filter(s=>s in CONFIG.PF2E.actionTraits)].flat()),o=t.actionCost.value;return lt([`action:${i}`,`action:cost:${o}`,`self:action:slug:${i}`,`self:action:cost:${o}`,...n.map(s=>`self:action:trait:${s}`)])}l(ni,"createActionOptions");var pt=class extends FormApplication{constructor(e,i,n){super(e,i),this.onSubmitCallback=n}async getData(){let[e,i]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),quantity:{default:this.options.quantity.default,max:this.options.quantity.max},newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:e,buttonLabel:i}}static get defaultOptions(){return{...FormApplication.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",quantity:{default:1,max:1},newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(e,i){this.onSubmitCallback(i.quantity,i.newStack)}};l(pt,"MoveLootPopup");async function nn(t,e){let i=t.parentItem;if(!i)throw pe("Subitem has no parent item");let n=Gt("PF2E.Item.Physical.Attach.Detach");if(!(e||await Dialog.confirm({title:n("Label"),content:_t("p",{children:[n("Prompt",{attachable:t.name})]}).outerHTML})))return;let s=t.delete(),r=(async()=>{let c=t.isOfType("consumable")?i.actor?.inventory.findStackableItem(t.clone({"system.equipped.carryType":"worn"})):null,a=!!i.actor&&!i.actor.items.has(t.id);return c?.update({"system.quantity":c.quantity+1})??Item.implementation.create(mergeObject(t.toObject(),{"system.containerId":i.system.containerId}),{parent:i.actor,keepId:a})})();await Promise.all([s,r])}l(nn,"detachSubitem");async function qe(t,e,i,n={}){let o=ChatMessage.implementation,r=`systems/pf2e/templates/chat/${de(e.type)}-card.hbs`,c=i.token,a=we(t?.target,".item"),u=n.data??{...a?.dataset??{}},f={actor:i,tokenId:c?`${c.parent?.id}.${c.id}`:null,item:e,data:await e.getChatData(void 0,u)},p=t instanceof MouseEvent?t:t?.originalEvent,d=n.rollMode??Ge(p),g=o.applyRollMode({type:CONST.CHAT_MESSAGE_TYPES.OTHER,speaker:o.getSpeaker({actor:i,token:i.getActiveTokens(!1,!0).at(0)}),content:await renderTemplate(r,f),flags:{pf2e:{origin:e.getOriginData()}}},d);return n.create??!0?o.create(g,{rollMode:d,renderSheet:!1}):new o(g,{rollMode:d})}l(qe,"unownedItemToMessage");var We={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},sn=["criticalFailure","failure","success","criticalSuccess"],Ke,on,Se,Ve,me,Me,Ye,an,le=class{constructor(e,i,n=null){Ee(this,Ke);Ee(this,Se);Ee(this,me);Ee(this,Ye);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(o=>o instanceof NumericTerm):e.dice.find(o=>o instanceof Die&&o.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof i=="number"?{value:i}:i,this.unadjusted=J(this,Ye,an).call(this),this.adjustment=J(this,Ke,on).call(this,this.unadjusted,n),this.value=this.adjustment?J(this,Se,Ve).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},te=le;l(te,"DegreeOfSuccess"),Ke=new WeakSet,on=l(function(e,i){if(!i)return null;for(let n of["all",...sn]){let{label:o,amount:s}=i[n]??{};if(s&&o&&!(e===le.CRITICAL_SUCCESS&&s===We.INCREASE)&&!(e===le.CRITICAL_FAILURE&&s===We.LOWER)&&(n==="all"||sn.indexOf(n)===e))return{label:o,amount:s}}return null},"#getDegreeAdjustment"),Se=new WeakSet,Ve=l(function(e,i){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(i+e,0,3)}},"#adjustDegreeOfSuccess"),me=new WeakSet,Me=l(function(e){return this.dieResult===20?J(this,Se,Ve).call(this,We.INCREASE,e):this.dieResult===1?J(this,Se,Ve).call(this,We.LOWER,e):e},"#adjustDegreeByDieValue"),Ye=new WeakSet,an=l(function(){let e=this.dc.value;return this.rollTotal-e>=10?J(this,me,Me).call(this,le.CRITICAL_SUCCESS):e-this.rollTotal>=10?J(this,me,Me).call(this,le.CRITICAL_FAILURE):this.rollTotal>=e?J(this,me,Me).call(this,le.SUCCESS):J(this,me,Me).call(this,le.FAILURE)},"#calculateDegreeOfSuccess"),Ie(te,"CRITICAL_FAILURE",0),Ie(te,"FAILURE",1),Ie(te,"SUCCESS",2),Ie(te,"CRITICAL_SUCCESS",3);var ii="Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo";async function rn(t){function e(p){ChatMessage.create({user:game.user.id,content:p,speaker:ChatMessage.getSpeaker({actor:t})})}l(e,"toChat");let{name:i,attributes:n,system:o}=t,s=n.hp.sp,r=o.resources.resolve,c=I("hud.resolve.full",{name:i}),a=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:i});if(s.value===s.max)return ui.notifications.warn(c);if(r.value<1)return ui.notifications.warn(a);let u=t.itemTypes.feat.find(p=>p.sourceId===ii),f=await renderTemplate(P("dialogs/resolve"),{hasSteel:u,i18n:p=>I(`hud.resolve.${p}`)});new Dialog({title:I("hud.resolve.title"),content:f,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:I("hud.resolve.yes"),callback:async p=>{let{attributes:d,system:g}=t,h=d.hp.sp,m=g.resources.resolve;if(h.value===h.max)return e(c);if(m.value<1)return e(a);let k=p.find("input:checked").val(),v=`${h.value}/${h.max}`;if(k==="breather")e(I("hud.resolve.breather.used",{name:i,ratio:v})),await t.update({"system.attributes.hp.sp.value":h.max,"system.resources.resolve.value":m.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:i,ratio:v}));let x=h.value+Math.floor(h.max/2);await t.update({"system.attributes.hp.sp.value":Math.min(x,h.max),"system.resources.resolve.value":m.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:I("hud.resolve.no")}}}).render(!0)}l(rn,"useResolve");var Qe=["U","T","E","M","L"],si="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi";function Z(t){let e=t.find(".name");e.on("mouseenter",i=>{i.preventDefault();let n=i.currentTarget,{width:o}=n.getBoundingClientRect();if(n.scrollWidth<=Math.ceil(o))return;let s=n.innerHTML.trim();game.tooltip.activate(i.currentTarget,{text:s,direction:TooltipManager.TOOLTIP_DIRECTIONS.UP})}),e.on("mouseleave",i=>{i.preventDefault(),game.tooltip.deactivate()}),e.on("mousedown",i=>{game.tooltip.deactivate()})}l(Z,"addNameTooltipListeners");function dt(t,e){let{itemId:i,parentId:n,entryId:o,castRank:s}=t.dataset;if(o)return e.spellcasting.collections.get(o)?.get(i);let r=e.items.get(n??i);return n?r?.subitems.get(i):r}l(dt,"getItemFromElement");function G(t,e){let i=t.currentTarget.closest("[data-item-id]");return dt(i,e)}l(G,"getItemFromEvent");function Xe(t){return t.isOwner?ne(t,`macros.${game.user.id}`)?.map(e=>{let i=fromUuidSync(e);return i?{img:i.img,name:i.name,uuid:e}:null}).filter(Boolean):void 0}l(Xe,"getMacros");function Je(t,e){let{type:i,uuid:n}=TextEditor.getDragEventData(t.originalEvent)??{};if(i!=="Macro"||!fromUuidSync(n))return;let o=`macros.${game.user.id}`,s=ne(e,o)?.slice()??[];s.includes(n)||(s.push(n),ge(e,o,s))}l(Je,"onDroppedMacro");function Ze(t,e){let i=`macros.${game.user.id}`,n=ne(e,i)?.slice();if(!n?.length)return;let{uuid:o}=t.currentTarget.closest(".macro").dataset,s=n.indexOf(o);s!==-1&&(n.splice(s,1),ge(e,i,n))}l(Ze,"deleteMacro");function et(t=()=>!0){let e=game.user.targets,i=e.size===1?e.first():null;return i&&t(i)?i:null}l(et,"getUniqueTarget");function q(t,e){return e?t.toLowerCase().includes(e):!0}l(q,"filterIn");function _(t,e){return t.localeCompare(e,game.i18n.lang)}l(_,"localeCompare");function mt(t){return t?.itemTypes.effect.find(e=>e.flags.core?.sourceId===si)}l(mt,"getCoverEffect");async function he(t,e,i){let n=ie(),o=n?.element;if(!o)return;o.find("> .popup").remove();let s=document.createElement("div");s.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${t}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${I("popup.close")}</a>
    </div>
</div>`;let r=s.firstElementChild;if(typeof e=="string"){let a=await ue(e,i);r.insertAdjacentHTML("beforeend",a)}else r.append(e);r.querySelector("[data-action=close-popup]").addEventListener("click",()=>r.remove());let c=r.querySelectorAll("[data-action^='consume-']");for(let a of c)a.addEventListener("click",()=>r.remove());o.append(r),n.lock()}l(he,"popup");async function Y(t,e,i){let n=t.data(),o=n.itemId?dt(t[0],e):await fromUuid(n.uuid),s=await o?.getChatData({secrets:e.isOwner},n);if(!s)return;let r=document.createElement("div");if(r.classList.add("popup-description"),await e.sheet.itemRenderer.renderItemSummary(r,o,s),ee.listen(r,o),o.isOfType("consumable")){let a=r.querySelectorAll("[data-action='consume-item']");for(let u of a)u.addEventListener("click",()=>o.consume())}n.castRank&&(r.dataset.castRank=n.castRank);let c=i??t.find(".name").html();he(c.trim(),r,e)}l(Y,"showItemSummary");var oi=["arcana","crafting","medicine","nature","occultism","religion","society"],cn={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function ln(t){let e=await new Roll("1d20").evaluate({async:!0}),i=e.dice[0].total,n=i===1?"0":i===20?"3":"",o=Object.values(t.skills).filter(u=>u.lore),s=et(u=>u.actor?.identificationDCs)?.actor,r={dieSuccess:n,dieResult:i,target:s,i18n:u=>I(`actions.recall-knowledge.${u}`)};if(s){let{standard:u,skills:f,lore:p}=s.identificationDCs,d=u.progression.slice();d.length=4,d=[...d];let g=p.map(({progression:h})=>{let m=h;return m.length=6,[...m]});r.skillsDCs=d,r.loresDCs=g,r.skills=await Promise.all(f.map(h=>{let m=t.skills[h];return gt(m,i,d)})),r.lores=await Promise.all(o.map(h=>gt(h,i)))}else r.skills=await Promise.all([...oi.map(u=>t.skills[u]),...o].map(u=>gt(u,i)));let c=b("rk-dice"),a={speaker:ChatMessage.getSpeaker({actor:t}),rollMode:game.pf2e.settings.metagame.secretChecks?CONST.DICE_ROLL_MODES.PUBLIC:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL};c&&(a.rolls=[e],r.rkDice=!0),a.flavor=await renderTemplate(P("chat/recall-knowledge"),r),ChatMessage.create(a)}l(ln,"rollRecallKnowledges");async function gt(t,e,i){let{rank:n,label:o}=t,s=await t.roll({createMessage:!1,skipDialog:!0,extraRollOptions:["action:recall-knowledge"]}),r=s.total-s.dice[0].total,c={dieValue:e,modifier:r};return{mod:r,rank:n,label:o,total:e+r,modifier:X(r),rankLabel:Qe[n],checks:i?.map(a=>{if(!a)return"-";let u=new te(c,a).value;return{success:u,icon:cn[u].icon,title:cn[u].name}})}}l(gt,"rollSkill");var se="pf2e-token-hud",ai="Compendium.pf2e.feats-srd.Item.9jGaBxLUtevZYcZO",ri=new Set(["Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk"]),un="Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf",ci="Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu",ht="Compendium.pf2e.other-effects.Item.VCSpuc3Tf3XWMkd3",li={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${se}.skills.actions.earnIncome`,treatWounds:`${se}.skills.actions.treatWounds`,"borrow-arcane-spell":`${se}.skills.actions.borrow-arcane-spell`,"identify-magic":`${se}.skills.actions.identify-magic`,"identify-alchemy":`${se}.skills.actions.identify-alchemy`,"crafting-goods":`${se}.skills.actions.crafting-goods`,"staging-performance":`${se}.skills.actions.staging-performance`},fn={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW","sense-motive":"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","follow-the-expert":"Compendium.pf2e.actionspf2e.Item.tfa4Sh7wcxCEqL29","tumble-through":"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G","learn-a-spell":"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy","force-open":"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD","high-jump":"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h","long-jump":"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2",reposition:"Compendium.pf2e.actionspf2e.Item.lOE4yjUnETTdaf2T",shove:"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1","create-a-diversion":"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X",bonMot:un,"gather-information":"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8","make-an-impression":"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4","sense-direction":"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H"},fi={escape:{slug:"escape",cost:"1",noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-a-spell":{slug:"learn-a-spell",trained:!0}},Pe=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1"},{slug:"seek",cost:"1"}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1"},{slug:"tumble-through",cost:"1"},{slug:"maneuver-in-flight",cost:"1",trained:!0},{slug:"squeeze",trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-a-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1"},{slug:"force-open",cost:"1",map:!0,modifiers:[{condition:t=>!t.itemTypes.equipment.some(e=>e.isHeld&&ri.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",map:!0,agile:!0},{slug:"high-jump",cost:"1"},{slug:"long-jump",cost:"1"},{slug:"reposition",cost:"1",map:!0,agile:!0},{slug:"shove",cost:"1",map:!0,agile:!0},{slug:"swim",cost:"1"},{slug:"trip",cost:"1",map:!0,agile:!0},{slug:"disarm",cost:"1",map:!0,trained:!0,agile:!0}]},{slug:"crafting",actions:[{slug:"repair"},{slug:"craft",trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"create-a-diversion",cost:"1",variants:["distracting-words","gesture","trick"]},{slug:"impersonate"},{slug:"lie"},{slug:"feint",cost:"1",trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",condition:t=>yt(t,un)},{slug:"gather-information"},{slug:"make-an-impression"},{slug:"request",cost:"1"}]},{slug:"intimidation",actions:[{slug:"coerce"},{slug:"demoralize",cost:"1"}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",variants:["stabilize","stop-bleeding"],rollOption:"administer-first-aid"},{slug:"treat-disease",trained:!0},{slug:"treat-poison",cost:"1",trained:!0},{slug:"treatWounds",trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1"},"identify-magic","learn-a-spell",{slug:"treatWounds",trained:!0,condition:t=>yt(t,ci)}]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-a-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-a-spell"]},{slug:"society",actions:[{slug:"subsist"},{slug:"create-forgery",trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1"},{slug:"hide",cost:"1"},{slug:"sneak",cost:"1"}]},{slug:"survival",actions:[{slug:"sense-direction"},{slug:"subsist"},{slug:"cover-tracks",trained:!0},{slug:"track",trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1"},{slug:"steal",cost:"1"},{slug:"disable-device",cost:"2",trained:!0},{slug:"pick-a-lock",cost:"2",trained:!0}]}];for(let t of Pe){t.actions=t.actions.map(n=>typeof n=="string"?fi[n]:n);let{slug:e,actions:i}=t;for(let n of i){let o=n.slug.replace(/-(.)/g,(s,r)=>r.toUpperCase()).capitalize();if(n.skillSlug=e,n.uuid=fn[n.slug],n.label=li[n.slug]??`PF2E.Actions.${o}.Title`,n.variants)n.variants=n.variants.map(s=>({slug:s,label:`${se}.skills.actions.${s}`}));else if(n.map){let s=!!n.agile;n.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:1,agile:s,mapValue:s?-4:-5},{label:"PF2E.MAPAbbreviationLabel",map:2,agile:s,mapValue:s?-8:-10}]}for(let{modifiers:s}of n.modifiers??[])for(let r of s)r.label=`${se}.skills.modifiers.${r.slug}`}}var bt=Pe.map(t=>t.slug),pi=Pe.reduce((t,{slug:e,actions:i})=>(t[e]={slug:e,actions:i.reduce((n,o)=>(n[o.slug]=o,n),{})},t),{}),pn=new Set(Object.values(fn).filter(Boolean));function kt(t){return game.i18n.localize(t==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[t])}l(kt,"getSkillLabel");async function dn({actor:t,filter:e}){let i=[],n=t.isOfType("character"),o=n&&b("untrained")&&!t.itemTypes.feat.some(c=>c.sourceId===ai);for(let c=0;c<Pe.length;c++){let{slug:a,actions:u}=Pe[c],{label:f,rank:p,mod:d}=t.getStatistic(a),g=game.i18n.localize(f),h=u.filter(({condition:v,trained:x})=>(!o||!n||!x||t.skills[a].rank>=1)&&(!v||v(t))).map(v=>({...v,name:game.i18n.localize(v.label),variants:v.variants?.map(x=>({...x,name:game.i18n.localize(x.label)}))})),m=q(g,e),k=h;!m&&(k=h.filter(({name:v,variants:x})=>q(v,e)||x?.some(C=>q(C.name,e))),!k.length)||(i[c]={slug:a,name:g,rank:p,modifier:X(d),actions:m?h:k})}i.sort((c,a)=>c.slug==="perception"?-1:a.slug==="perception"?1:_(c.name,a.name));let s=Object.values(t.skills).filter(({lore:c,label:a})=>c&&q(a,e)).map(({label:c,rank:a,mod:u,slug:f})=>({slug:f,label:c,rank:a,modifier:X(u)})),r=s.reduce((c,a)=>a.modifier.length>c?a.modifier.length:c,2);return{contentData:{follow:I(`skills.actions.${gn(t)?"following":"follow"}`),skills:i,lores:s,loresModifierWidth:r},doubled:b("skills-columns")}}l(dn,"getSkillsData");function mn({el:t,actor:e,token:i,hud:n}){t.find("[data-action=action-description]").on("click",o=>{o.preventDefault();let s=$(o.currentTarget).closest(".action");Y(s,e,s.find(".name").children().html())}),e.isOwner&&(t.find("[data-action=follow-the-expert]").on("click",async o=>{o.preventDefault();let s=gn(e);if(s)return await s.delete();let r=(await fromUuid(ht)).toObject();setProperty(r,"flags.core.sourceId",ht),await e.createEmbeddedDocuments("Item",[r])}),t.find("[data-action=roll-skill]").on("click",o=>{o.preventDefault();let{slug:s}=o.currentTarget.dataset;e.getStatistic(s)?.roll({event:o}),b("skill-close")&&n.close()}),t.find("[data-action=roll-action]").on("click contextmenu",async o=>{o.preventDefault();let s=$(o.currentTarget),{skillSlug:r,slug:c,actionName:a}=s.closest(".action").data(),{variant:u,map:f,agile:p}=s.data(),d=o.type==="contextmenu"?await tt(a,{skill:r,agile:p}):void 0;d!==null&&(di({event:o,actor:e,token:i,skillSlug:r,slug:c,variant:u,map:f,skill:d?.skill,agile:d?.agile??p}),b("skill-close")&&n.close())}),t.find("[data-action=action-chat]").on("click",async o=>{o.preventDefault();let{uuid:s}=o.currentTarget.closest(".action").dataset,r=await fromUuid(s);r&&(qe(o,r,e,{create:!0}),b("chat-close")&&n.close())}))}l(mn,"addSkillsListeners");function gn(t){return t.itemTypes.effect.find(e=>e.sourceId===ht)}l(gn,"isFollowingAnExpert");async function tt(t,{dc:e,agile:i,skill:n}={}){let o=bt.map(r=>({slug:r,label:kt(r)})),s=await renderTemplate(P("dialogs/variant"),{i18n:r=>I(`skills.variant.${r}`),dc:e,skill:n,agile:i,skills:o});return Dialog.prompt({title:t,label:I("skills.variant.button"),callback:r=>({skill:r.find("select").val(),dc:Number(r.find("[name=dc]").val()),agile:r.find("[name=agile]").is(":checked")}),rejectClose:!1,content:s,options:{width:280}})}l(tt,"variantsDialog");function vt(t,e){let i=t===1?e?-4:-5:e?-8:-10;return new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:i})}l(vt,"getMapModifier");function di({event:t,actor:e,skillSlug:i,slug:n,variant:o,map:s,agile:r,skill:c,token:a}){let u=pi[i].actions[n],f=u.type===3?3:game.pf2e.actions.has(n)?2:n in game.pf2e.actions?1:void 0;c??=u.noSkill?void 0:i;let p=u.rollOption?[`action:${u.rollOption}`]:void 0;p&&o&&p.push(`action:${u.rollOption}:${o}`);let d={event:t,actors:[e],tokens:[a],variant:o,rollOptions:p,rollMode:u.secret?"blindroll":"roll"};if(d.modifiers=[],u.modifiers){for(let{condition:g,modifiers:h}of u.modifiers)if(!(g&&!g(e)))for(let m of h)d.modifiers.push(new game.pf2e.Modifier(m))}if(s){let g=vt(s,r);d.modifiers.push(g)}if(u.custom){u.custom(e,d);return}if(!f){e.getStatistic(c)?.roll(d);return}f===1?(d.skill=c,game.pf2e.actions[n](d)):f===2?(d.statistic=c,game.pf2e.actions.get(n).use(d)):f===3&&game.pf2e.actions[n](e)}l(di,"rollAction");var wt={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","point-out":"Compendium.pf2e.actionspf2e.Item.sn2hIy1iIJX9Vpgj"};async function hn({actor:t,filter:e}){let i=t.system.initiative;return{contentData:{noMacro:I("extras.no-macro"),macros:Xe(t)?.filter(n=>q(n.name,e)),initiative:i&&{selected:i.statistic,skills:bt.map(n=>({slug:n,label:kt(n)}))},hasDailies:game.modules.get("pf2e-dailies")?.active,hasPerception:game.modules.get("pf2e-perception")?.active,uuids:wt}}}l(hn,"getExtrasData");function yn({el:t,actor:e,token:i,hud:n}){function o(r,c,a="click"){t.find(`[data-action=${r}]`).on(a,u=>{u.preventDefault(),c(u)})}if(l(o,"action"),o("action-description",r=>{let c=$(r.currentTarget).closest(".row");Y(c,e)}),!e.isOwner)return;Z(t.find(".macro"));async function s(r){let{uuid:c}=r.currentTarget.closest(".macro").dataset;return fromUuid(c)}l(s,"getMacro"),o("delete-macro",r=>Ze(r,e)),o("edit-macro",async r=>{(await s(r))?.sheet.render(!0)}),o("use-macro",async r=>{(await s(r))?.execute({actor:e,token:i}),b("macro-close")&&n.close()}),t.on("drop",r=>Je(r,e)),o("action-chat",async r=>{let{uuid:c}=r.currentTarget.closest(".row").dataset,a=await fromUuid(c);a&&(qe(r,a,e,{create:!0}),b("chat-close")&&n.close())}),t.find("input[name], select[name]").on("change",async r=>{let c=r.currentTarget,a=c.type==="number"?c.valueAsNumber:c.value;await e.update({[c.name]:a})}),o("roll-initiative",async r=>{await e.initiative.roll({event:r}),b("skill-close")&&n.close()}),o("prepare-dailies",r=>{let c=game.modules.get("pf2e-dailies");c?.active&&c.api.openDailiesInterface(e)}),o("rest-for-the-night",r=>{game.pf2e.actions.restForTheNight({actors:[e],tokens:[i]})}),o("roll-recall-knowledge",r=>{ln(e),b("skill-close")&&n.close()}),o("roll-aid",async r=>{let c=await tt(game.i18n.localize("PF2E.Actions.Aid.Title"),{dc:15}),a={text:"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]"};c!==null&&(game.pf2e.actions.get("aid").use({event:r,actors:[e],tokens:[i],statistic:c?.skill,difficultyClass:{value:c?.dc},notes:[a]}),b("skill-close")&&n.close())},"click contextmenu"),o("roll-point-out",r=>{game.pf2e.actions.get("point-out").use({event:r,actors:[e],tokens:[i]}),b("skill-close")&&n.close()}),o("roll-escape",async r=>{let c=$(r.currentTarget).data().map,a=r.type==="contextmenu"?await tt(game.i18n.localize("PF2E.Actions.Escape.Title"),{agile:c?!1:void 0}):void 0;if(a===null)return;let u=[];if(c){let f=a?.agile,p=vt(c,f);u.push(p)}game.pf2e.actions.get("escape").use({event:r,actors:[e],tokens:[i],statistic:a?.skill,modifiers:u}),b("skill-close")&&n.close()},"click contextmenu")}l(yn,"addExtrasListeners");var xe={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionsReactionsHeader",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionsFreeActionsHeader",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.NPC.PassivesLabel",actionLabel:"PF2E.ActionTypePassive"},exploration:{order:3,label:"PF2E.TravelSpeed.ExplorationActivity",actionLabel:"PF2E.TabActionsExplorationLabel"}};async function bn({hud:t,actor:e,filter:i}){let n=e.isOfType("character"),o=b("actions"),s=(await St()?.getStances(e))?.sort((m,k)=>_(m.name,k.name)),r=n?await ye()?.getHeroActions(e):void 0,c=r?e.heroPoints.value-r.length:void 0,a=e.isOwner,u=e.getRollData(),f=e.system.actions?await Promise.all(e.system.actions.map(async(m,k)=>({...m,index:k,visible:!n||m.visible,damageFormula:await m.damage?.({getFormula:!0}),criticalFormula:await m.critical?.({getFormula:!0}),description:m.description?await ue(m.description,e,{rollData:u,isOwner:a}):void 0,altUsages:m.altUsages&&await Promise.all(m.altUsages.map(async v=>({...v,usage:v.item.isThrown?"thrown":"melee",damageFormula:await v.damage?.({getFormula:!0}),criticalFormula:await v.critical?.({getFormula:!0})})))}))):void 0,p=n?new game.pf2e.ElementalBlast(e):void 0,d=p?(await Promise.all(p.configs.map(async m=>{let k=m.damageTypes.find(x=>x.selected)?.value??"untyped",v=l((x,C=!0)=>p.damage({element:m.element,damageType:k,melee:C,outcome:x,getFormula:!0}),"formulaFor");return{...m,damageType:k,formula:{melee:{damage:await v("success"),critical:await v("criticalSuccess")},ranged:{damage:await v("success",!1),critical:await v("criticalSuccess",!1)}}}}))).sort((m,k)=>_(m.label,k.label)):void 0,g={},h=n?gi(e,s):hi(e);for(let m of h)q(m.name,i)&&(o!=="split"?(g.action??=[],g.action.push(m)):(g[m.type]??=[],g[m.type].push(m)));if(g=Object.entries(g).map(([m,k])=>{for(let v of k)v.img=qt(v.cost),v.typeLabel=xe[v.type].actionLabel;return o!=="type"?k.sort((v,x)=>_(v.name,x.name)):k.sort((v,x)=>{let C=xe[v.type].order,N=xe[x.type].order;return C===N?_(v.name,x.name):C-N}),{type:m,actions:k,label:xe[m].label}}),o==="split"&&g.sort((m,k)=>xe[m.type].order-xe[k.type].order),s?.length||f?.length||d?.length||g.length||r?.length){let m=+((s?.length??0)>0)+ +((f?.length??0)>0)+ +((d?.length??0)>0)+g.length+ +((r?.length??0)>0);return{contentData:{stances:s,strikes:f,blasts:d,sections:g,heroActions:r&&{actions:r,draw:Math.max(c,0),discard:Math.abs(Math.min(c,0)),canTrade:r.length&&mi()},i18n:k=>I(`actions.${k}`),variantLabel:k=>k.replace(/.+\((.+)\)/,"$1"),damageTypes:CONFIG.PF2E.damageTypes},doubled:m>1&&b("actions-columns")}}}l(bn,"getActionsData");function kn({el:t,actor:e,hud:i}){Z(t.find(".toggle")),Z(t.find(".strike")),Z(t.find(".action"));function n(c,a,u="click"){let p=(typeof c=="string"?[c]:c).map(d=>`[data-action=${d}]`).join(", ");return t.find(p).on(u,d=>{d.preventDefault(),a(d)})}l(n,"action");function o(c){let a=c.currentTarget.closest(".strike"),u=e.system.actions[a.dataset.index];if(!u)return null;let{altUsage:f}=c.currentTarget.dataset;return["melee","thrown"].includes(f)?u.altUsages?.find(p=>f==="thrown"?p.item.isThrown:p.item.isMelee)??null:u}l(o,"getStrike");function s(c){return $(c.currentTarget).closest(".action").data().uuid}if(l(s,"getUuid"),n("action-description",async c=>{let a=$(c.currentTarget).closest(".action");Y(a,e)}),n("hero-action-description",async c=>{let a=s(c),{description:u,name:f}=await ye()?.getHeroActionDetails(a)??{};u&&he(f,u,e)}),n("strike-description",async c=>{let a=o(c);if(!a)return;let u=document.createElement("div");u.classList.add("popup-description"),u.innerHTML=await renderTemplate(P("strike-description"),a),he(a.label,u,e)}),n("blast-description",async c=>{let a=c.currentTarget.closest(".blast");Y($(a),e)}),n("trait-description",c=>{let a=o(c);if(!a)return;let{index:u}=c.currentTarget.dataset,f=a.traits[u];if(!f)return;let p=game.i18n.localize(f.description);p&&he(game.i18n.localize(f.label),p,e)}),n("stance-description",c=>{let a=$(c.currentTarget).closest(".action");Y(a,e,a.data().itemName)}),!e.isOwner||(n("use-action",c=>{let a=G(c,e);a?.isOfType("action","feat")&&(Vt(a,Ge(c)),b("action-effect")&&yi(e,a),b("action-close")&&i.close())}),n("stance-chat",c=>{let a=G(c,e);a&&(a.toMessage(c,{create:!0}),b("chat-close")&&i.close())}),n("stance-toggle",c=>{let{effectUuid:a}=c.currentTarget.closest(".action").dataset;St()?.toggleStance(e,a)}),n("exploration-toggle",c=>{let a=c.currentTarget.closest(".action").dataset.itemId,u=e.system.exploration.filter(f=>e.items.has(f));u.findSplice(f=>f===a)||u.push(a),e.update({"system.exploration":u})}),n("action-chat",c=>{let a=G(c,e);a&&(a.toMessage(c,{create:!0}),b("chat-close")&&i.close())}),n("hero-action-chat",async c=>{let a=ye();a&&(a.sendActionToChat(e,s(c)),b("chat-close")&&i.close())}),n("draw-hero-action",async c=>{await ye()?.drawHeroActions(e)}),n("use-hero-action",async c=>{let a=ye();a&&(a.useHeroAction(e,s(c)),b("action-close")&&i.close())}),n("discard-hero-action",async c=>{await ye()?.discardHeroActions(e,s(c))}),n("trade-hero-action",async c=>{ye()?.tradeHeroAction(e)}),n("strike-attack",c=>{let{index:a,altUsage:u}=c.currentTarget.dataset;o(c)?.variants[a].roll({event:c,altUsage:u}),b("attack-close")&&i.close()}),n(["strike-damage","strike-critical"],c=>{let{action:a}=c.currentTarget.dataset;o(c)?.[a==="strike-damage"?"damage":"critical"]({event:c}),b("attack-close")&&i.close()}),n("strike-auxiliary",c=>{if(c.currentTarget!==c.target)return;let a=o(c);if(!a)return;let{index:u}=c.currentTarget.dataset,f=c.currentTarget.querySelector("select")?.value??null;a.auxiliaryActions?.[u]?.execute({selection:f})}),n("toggle-versatile",async c=>{let a=o(c)?.item;if(!a)return;let u=c.currentTarget,{value:f}=u.dataset,p=a.system.damage.damageType??null,d=u.classList.contains("selected")||f===p?null:f;($e(CONFIG.PF2E.damageTypes,d)||d===null)&&await a.system.traits.toggles.update({trait:"versatile",selected:d})}),n("strike-ammo",async c=>{let a=o(c)?.item;if(!a)return;let u=e.items.get(c.currentTarget.value);await a.update({system:{selectedAmmoId:u?.id??null}})},"change"),!e.isOfType("character")))return;let r=["roll-attack","roll-damage","set-damage-type"].map(c=>`[data-action=${c}]`).join(",");t.find(".blast").each((c,a)=>{let{element:u,damageType:f}=a.dataset,p=new game.pf2e.ElementalBlast(e);$(a).find(r).on("click",async d=>{d.preventDefault();let g=d.currentTarget.dataset,h=g.melee==="true";switch(g.action){case"roll-attack":{let m=Math.clamped(Number(g.mapIncreases),0,2);p.attack({mapIncreases:Math.clamped(m,0,2),element:u,damageType:f,melee:h,event:d});break}case"roll-damage":{p.damage({element:u,damageType:f,melee:h,outcome:g.outcome,event:d});break}case"set-damage-type":p.setDamageType({element:u,damageType:g.value})}["roll-attack","roll-damage"].includes(g.action)&&b("attack-close")&&i.close()})})}l(kn,"addActionsListeners");function vn(t){let e=game.modules.get("pf2e-toolbelt");return e?.active&&game.settings.get("pf2e-toolbelt",t)?e:void 0}l(vn,"getToolBeltModule");function wn(t){return vn(t)?.api}l(wn,"getToolBeltApi");function St(){let t=game.modules.get("pf2e-stances");return t?.active?t.api:wn("stances")?.stances}l(St,"getStancesModuleApi");function ye(){let t=game.modules.get("pf2e-hero-actions");return t?.active?t.api:wn("hero")?.heroActions}l(ye,"getHeroActionsApi");function mi(){if(game.modules.get("pf2e-hero-actions")?.active)return game.settings.get("pf2e-hero-actions","trade");if(vn("hero"))return game.settings.get("pf2e-toolbelt","hero-trade")}l(mi,"canTradeHeroActions");function gi(t,e){let i=St()?.getActionsUUIDS?.()??(e?.some(a=>a.actionUUID)?new Set(e.map(({actionUUID:a})=>a)):void 0)??new Set,n=new Set([...i,...pn,...Object.values(wt)]),o=t.itemTypes.action,s=t.itemTypes.feat.filter(a=>a.actionCost),r=t.parties.size>0,c=t.system.exploration;return[...o,...s].map(a=>{let u=a.sourceId,f=a.id,p=a.actionCost,d=a.system.traits.value,g=d.includes("exploration");return{sourceId:u,id:f,type:p?.type??(g?"exploration":"free"),cost:p,name:a.name,isExploration:g,isDowntime:d.includes("downtime"),isActive:g&&c.includes(f),hasEffect:!!a.system.selfEffect}}).filter(a=>!a.isDowntime&&(r||!a.isExploration)&&(a.isExploration||!n.has(a.sourceId)))}l(gi,"getCharacterActions");function hi(t){return t.itemTypes.action.map(e=>{let i=e.actionCost,n=i?.type??"passive",o=n==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(s=>s.key==="Aura"));return{id:e.id,type:n,cost:i,name:e.name,hasDeathNote:e.system.deathNote,hasAura:o,hasEffect:!!e.system.selfEffect}})}l(hi,"getNpcActions");async function yi(t,e){let i=e.system.selfEffect?.uuid;if(!i)return;let n=(await fromUuid(i))?.toObject();n&&t.createEmbeddedDocuments("Item",[n])}l(yi,"applyActionEffect");async function Sn({actor:t}){let{system:e}=t,{details:i,traits:n,attributes:o}=e,{stealth:s}=o,{description:r,disable:c,routine:a,reset:u,isComplex:f}=i,p=t.getRollData(),d=t.isOwner,g=l(async h=>ue(h,t,{isOwner:d,rollData:p}),"enrich");return{contentData:{description:await g(r),disable:await g(c),routine:await g(a),reset:await g(u),isComplex:f,rarity:{value:n.rarity,label:CONFIG.PF2E.rarityTraits[n.rarity]},traits:n.value.map(h=>CONFIG.PF2E.hazardTraits[h]),stealth:X(s.value)},style:{"--max-width":`${b("hazard-width")}em`}}}l(Sn,"getHazardData");function xn({el:t,actor:e}){t.find("[data-action=action-description]").on("click",i=>{i.preventDefault();let n=$(i.currentTarget).closest(".action");Y(n,e)}),ee.listen(t[0],e),e.isOwner&&t.find("[data-action=roll-initiative").on("click",i=>{i.preventDefault(),e.initiative.roll({event:i})})}l(xn,"addHazardListeners");var nt={weaponAndShield:{order:0,label:"PF2E.Actor.Inventory.Section.WeaponsAndShields"},armor:{order:1,label:"TYPES.Item.armor"},consumable:{order:2,label:"PF2E.Item.Consumable.Plural"},equipment:{order:3,label:"TYPES.Item.equipment"},treasure:{order:4,label:"TYPES.Item.treasure"},backpack:{order:5,label:"PF2E.Item.Container.Plural"}};async function Tn({actor:t,filter:e}){let{contents:i,coins:n,totalWealth:o,bulk:s,invested:r}=t.inventory,c=t.isOfType("creature"),a=b("containers")||(ne(t,`containers.${game.user.id}`)??[]),u={},f={};for(let p of i){let d=p.type==="shield"||p.type==="weapon"?"weaponAndShield":p.type;if(!nt[d])continue;let g=p.system.containerId;d!=="backpack"&&g&&(a===!0||a.includes(g))?(u[g]??=[],u[g].push(p)):(f[d]??=[],f[d].push(p))}if(f=Object.entries(f).map(([p,d])=>{if(d.sort((g,h)=>_(g.name,h.name)),p==="backpack")for(let g=d.length-1;g>=0;g--){let h=d[g],m=u[h.id]?.filter(k=>q(k.name,e));if(!m?.length){q(h.name,e)||d.splice(g,1);continue}m.sort((k,v)=>_(k.name,v.name)),d.splice(g+1,0,...m)}else d=d.filter(g=>q(g.name,e));return{type:p,items:d,label:nt[p].label}}).filter(p=>p.items.length).sort((p,d)=>nt[p.type].order-nt[d.type].order),f.length)return{doubled:f.length>1&&b("items-columns"),contentData:{canCarry:!!t.changeCarryType,categories:f,bulk:s,containers:a,i18n:p=>I(`items.${p}`),invested:r?`${game.i18n.localize("PF2E.InvestedLabel")}: ${r.value} / ${r.max}`:"",wealth:{coins:n.goldValue,total:o.goldValue},canUseItem:p=>c&&p.isOfType("consumable")&&p.isIdentified&&p.uses.max&&!p.isAmmo,itemDisabled:p=>!p.quantity||!p.uses.value||p.system.equipped.carryType==="dropped",isInContainer:(p,d)=>p.type!=="backpack"?!1:!d.isOfType("backpack")&&d.isInContainer}}}l(Tn,"getItemsData");function In({el:t,actor:e,token:i,hud:n}){let o=t.find(".item");Z(o),o.find("[data-action=item-description]").on("click",async s=>{s.preventDefault();let r=$(s.currentTarget).closest(".item");await Y(r,e)}),o.find("[data-action=toggle-contains-items]").on("click",async s=>{s.preventDefault();let r=`containers.${game.user.id}`,c=s.currentTarget.closest(".item").dataset.itemId,a=ne(e,r)?.slice()??[],u=a.indexOf(c);u===-1?a.push(c):a.splice(u,1),await ge(e,r,a)}),e.isOwner&&(o.find("[data-action=use-item]").on("click",s=>{let r=G(s,e);r&&(r.consume(),b("use-close")&&n.close())}),o.find("[data-action=item-chat]").on("click",async s=>{let r=G(s,e);r&&(r.toMessage(s,{create:!0}),b("chat-close")&&n.close())}),o.on("dragstart",s=>{let r=s.target.closest(".item"),{itemType:c,uuid:a}=r.dataset,u=new Image;u.src=r.querySelector(".item-img img").src,u.style.width="32px",u.style.height="32px",u.style.borderRadius="4px",u.style.position="absolute",u.style.left="-1000px",document.body.append(u),s.originalEvent.dataTransfer.setDragImage(u,16,16),s.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:c,uuid:a})),r.addEventListener("dragend",()=>u.remove(),{once:!0})}),t.find(".quantity input").on("change",async s=>{await G(s,e)?.update({"system.quantity":s.currentTarget.valueAsNumber})}),t.find("[data-action=toggle-item-invest]").on("click",s=>{s.preventDefault();let{itemId:r}=s.currentTarget.closest(".item").dataset;e.toggleInvested(r)}),t.find("[data-action=repair-item]").on("click",s=>{s.preventDefault();let r=G(s,e);r&&game.pf2e.actions.repair({item:r,actors:[e],tokens:[i]})}),t.find("[data-action=toggle-identified]").on("click",s=>{s.preventDefault();let r=G(s,e);r&&(r.isIdentified?r.setIdentificationStatus("unidentified"):new Fe(r).render(!0))}),t.find("[data-action=detach-item]").on("click",s=>{s.preventDefault();let{itemId:r,parentId:c}=s.currentTarget.closest("[data-item-id]").dataset,a=e.items.get(c);if(!a)return;let u=a.subitems.get(r);u&&nn(u,s.ctrlKey)}),t.find("[data-action=edit-item]").on("click",s=>{s.preventDefault(),G(s,e)?.sheet.render(!0,{focus:!0})}),t.find("[data-action=delete-item]").on("click",s=>{s.preventDefault();let r=G(s,e);r&&(s.ctrlKey?r.delete():r.deleteDialog())}),t.find("[data-action=toggle-item-worn]").on("click",async s=>{let r=G(s,e);if(!r)return;let c=document.createElement("div");c.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:r});for(let a of c.querySelectorAll("[data-carry-type]"))a.addEventListener("click",async u=>{let f=u.currentTarget,p=f.dataset.carryType,d=Number(f.dataset.handsHeld)||0,g=f.dataset.inSlot!==void 0,h=r.system.equipped;Ce(f),(p!==h.carryType||g!==h.inSlot||p==="held"&&d!==h.handsHeld)&&e.changeCarryType(r,{carryType:p,handsHeld:d,inSlot:g})});if(r.type!=="backpack"){let a=e.itemTypes.backpack.filter(u=>u.isIdentified);if(a.length){let u="";for(let p of a)u+='<li><a class="item-control item-location-option',p===r.container&&(u+=" selected"),u+=`" data-action="send-to-container" data-container-id="${p.id}">`,u+=`<i class="fas fa-box"></i>${p.name}</a></li>`;c.insertAdjacentHTML("beforeend",u);let f=c.querySelectorAll("[data-action=send-to-container]");for(let p of f)p.addEventListener("click",d=>{let g=d.currentTarget,h=g.dataset.containerId,m=e.items.get(h);m&&(Ce(g),e.stowOrUnstow(r,m))})}}Oe({target:s.currentTarget,content:c,locked:!0,direction:"UP",selected:!0,cssClass:"carry-type"})}))}l(In,"addItemsListeners");async function En({actor:t,filter:e}){let i=t.system.resources.focus??{value:0,max:0},n=b("tradition"),o=game.modules.get("pf2e-staves")?.active,s=game.modules.get("pf2e-dailies"),r=s?.active,c=o||r&&isNewerVersion(s.version,"2.14.0"),a=o?"flags.pf2e-staves.charges":r?"flags.pf2e-dailies.staff.charges":"",u=[],f=[],p,d=!1,g=await Promise.all(t.spellcasting.collections.map(async h=>({entry:h.entry,data:await h.entry.getSheetData({spells:h})})));for(let{entry:h,data:m}of g){if(m.isRitual){p=m.groups.flatMap((E,W)=>E.active.map(({spell:D})=>{if(q(D.name,e))return{name:D.name,img:D.img,slotId:W,itemId:D.id,rank:D.rank,time:D.system.time.value}}).filter(Boolean));continue}let k=m.id,v=n&&m.statistic.label[0],x=m.isFocusPool,C=h.system?.prepared?.value==="charge",N=m.isInnate,j=m.isPrepared,z=m.isSpontaneous,U=m.isFlexible,O=(()=>{if(m.category!=="items")return;let E=h.id.split("-")[0];return t.items.get(E)})(),H=(()=>{if(!C)return;let E=r&&s.api.getSpellcastingEntryStaffData(h),{charges:W,max:D,canPayCost:Q}=E??getProperty(h,"flags.pf2e-staves.charges")??{charges:0,max:0};return{value:W,max:D,noMax:!0,canPayCost:Q??(()=>!0)}})();for(let E of m.groups){if(!E.active.length||E.uses?.max===0)continue;let W=[],D=E.id==="cantrips",Q=Qt(E.id);for(let fe=0;fe<E.active.length;fe++){let M=E.active[fe];if(!M||M.uses?.max===0)continue;let{spell:B,expended:ke,virtual:ot,uses:ve,castRank:at}=M;q(B.name,e)&&W.push({name:B.name,img:B.img,tradition:v,castRank:at??B.rank,slotId:fe,entryId:k,itemId:B.id,inputId:N?B.id:m.id,inputPath:O?"system.uses.value":C?a:N?"system.location.uses.value":`system.slots.slot${Q}.value`,isCharge:C,isActiveCharge:C&&c,isVirtual:ot,isInnate:N,isCantrip:D,isFocus:x,isPrepared:j,isSpontaneous:z||U,groupId:E.id,consumable:O,uses:O?O.system.uses:C?H:ve??E.uses,expended:C?!H.canPayCost(Q):ke??(x&&!D?i.value<=0:!1),action:B.system.time.value,type:O?`PF2E.Item.Consumable.Category.${O.category}`:C?`${L}.spells.staff`:N?"PF2E.PreparationTypeInnate":z?"PF2E.PreparationTypeSpontaneous":U?"PF2E.SpellFlexibleLabel":x?"PF2E.TraitFocus":"PF2E.SpellPreparedLabel",order:C?0:j?1:x?2:N?3:z?4:5})}if(W.length){if(x)if(D)d=!0;else{f.push(...W);continue}u[Q]??=[],u[Q].push(...W)}}}if(u.length){let h=b("spells-sort"),m=h==="type"?(k,v)=>k.order===v.order?_(k.name,v.name):k.order-v.order:h==="entry"?(k,v)=>{let x=_(k.entryId,v.entryId);return x!==0?x:_(k.name,v.name)}:(k,v)=>_(k.name,v.name);for(let k of u)k&&k.sort(m)}if(f.length&&(f.sort((h,m)=>_(h.name,m.name)),u[12]=f,d=!1),u.length||p?.length){let h=Cn(t),m=u.length+ +((p?.length??0)>0);return{contentData:{spells:u,rituals:p,focusPool:i,hasFocusCantrips:d,i18n:k=>I(`spells.${k}`),attackMod:On(h)?h[0].mod:null,entryRank:k=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Bt(k)})},doubled:m>1&&b("spells-columns")}}}l(En,"getSpellsData");function Cn(t){return t.spellcasting.filter(e=>e.statistic).map(({statistic:e,name:i,id:n})=>({name:i,id:n,mod:X(e.mod),statistic:e}))}l(Cn,"getSpellAttacks");function On(t){return new Set(t.map(({mod:e})=>e)).size===1}l(On,"hasSingleSpellAttack");function An({el:t,actor:e,hud:i}){Z(t.find(".spell")),t.find("[data-action=spell-description]").on("click",async n=>{n.preventDefault();let o=$(n.currentTarget).closest(".spell");Y(o,e)}),e.isOwner&&(t.find("[data-action=spell-attack]").on("click",async n=>{n.preventDefault();let o=Cn(e);if(!o.length)return;let s;if(On(o))s=o[0].statistic;else{let a=await Dialog.wait({buttons:{ok:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:I("spells.attacks.ok"),callback:u=>u.find("input:checked").val()}},title:I("spells.attacks.title"),content:await renderTemplate(P("dialogs/spell-attacks"),{attacks:o}),close:()=>null});a&&(s=e.items.get(a)?.statistic)}let r=Be(n,{type:"check"}),{map:c}=n.currentTarget.dataset;c&&(r.modifiers=[new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:Number(c)})]),s?.check.roll(r)}),t.find("[data-action=draw-item]").on("click",async n=>{n.preventDefault();let o=G(n,e);o&&e.changeCarryType(o,{carryType:"held",handsHeld:1})}),t.find("[data-action=spell-chat]").on("click",async n=>{n.preventDefault();let o=G(n,e);o&&(o.toMessage(n),b("chat-close")&&i.close())}),t.find("[data-action=toggle-pips]").on("click contextmenu",async n=>{n.preventDefault();let o=n.type==="click"?1:-1,s=(e.system.resources.focus?.value??0)+o;await e.update({"system.resources.focus.value":s})}),t.find("[data-action=toggle-prepared]").on("click",n=>{n.preventDefault();let{groupId:o,slotId:s,entryId:r,expended:c}=$(n.currentTarget).closest(".spell").data();e.spellcasting.collections.get(r)?.setSlotExpendedState(Xt(o),s||0,c!==!0)}),t.find("[data-action=cast-spell]").on("click",n=>{n.preventDefault();let{castRank:o,slotId:s,entryId:r,itemId:c}=n.currentTarget.closest(".spell").dataset,a=e.spellcasting.collections.get(r);if(!a)return;let u=a.get(c);if(!u)return;let f=Number(o)||NaN;Number.isInteger(f)&&f.between(1,10)&&(u.parentItem?.consume()||a.entry.cast(u,{rank:f,slotId:Number(s)})),b("cast-close")&&i.close()}),t.find("[data-input-path]").on("change",async n=>{let{inputPath:o,entryId:s}=$(n.currentTarget).data(),r=n.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:s,[o]:r}])}))}l(An,"addSpellsListeners");var bi=["#combat-popout","#sidebar","#mini-tracker","#combat-dock","#combat-carousel","[id^=pf2e-perception]"].join(", "),ki={actions:"actions",spells:"spellcasting",items:"inventory",skills:"proficiencies"},Dn={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},Le={opposition:{icon:"fa-solid fa-face-angry-horns",label:"PF2E.Actor.Creature.Alliance.Opposition"},party:{icon:"fa-solid fa-face-smile-halo",label:"PF2E.Actor.Creature.Alliance.Party"},neutral:{icon:"fa-solid fa-face-meh",label:"PF2E.Actor.Creature.Alliance.Neutral"}},vi=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],wi={actions:{getData:bn,addListeners:kn},items:{getData:Tn,addListeners:In},spells:{getData:En,addListeners:An},skills:{getData:dn,addListeners:mn},extras:{getData:hn,addListeners:yn},hazard:{getData:Sn,addListeners:xn}},Ne={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},Si={perception:{icon:"fa-solid fa-eye",label:"PF2E.PerceptionLabel"},stealth:{icon:"fa-duotone fa-eye-slash",label:"PF2E.SkillStealth"},athletics:{icon:"fa-solid fa-hand-fist",label:"PF2E.SkillAthletics"}},Re=class extends Application{#e=null;#f=null;#n=null;#o=null;#l=!1;#a=null;#u=[!1,!1,!1];#t=!1;#i=!1;#s=!1;#p;#r;#d;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#p=(e,i)=>{i?this.#y(e):this.#b(e)},this.#r=e=>{let i=e.button;if(![0,2].includes(i))return;if(e.type==="mouseup"){this.#u[i]=!1;return}this.#u[i]=!0;let n=e.target,o=this.element[0];if(o){let s=o.querySelector(".popup");if(s&&!s.contains(n))if(!o.querySelector(".sidebar"))this.forceClose();else return s.remove();n.closest("canvas")&&this.forceClose();return}this.#g(),this.unlock(!0)},this.#d=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#r),window.addEventListener("mouseup",this.#r),Hooks.on("hoverToken",this.#p),Hooks.on("deleteToken",this.#d),Hooks.on("canvasPan",this.forceClose)}setToken(e,i){if(e!==this.#e){delete this.#e?.actor?.apps[this.appId],this.#e=e;let n=e?.actor;n&&(n.apps[this.appId]=this)}this.#s=i??this.#m(e)}setHolding(e){let i=b("key-holding");if(i!=="none"&&(this.#l=e,!(this.#i||this.#t)))if(e){if(!this.#n)return;let n=this.#m(this.#n);if(i==="half"&&!game.user.isGM&&!n){this.#g(),this.render();return}this.setToken(this.#n,n),this.render()}else i==="all"?this.close():game.user.isGM?(this.setToken(this.#n),this.render()):this.#s&&this.close()}#m(e){let i=e?.actor;if(!i)return!1;let n,o=i.system.details.alliance==="party";return game.user.isGM&&b("key-holding")==="half"&&!this.#l||i.isOfType("familiar")&&!i.master?n=!1:n=e.isOwner||b("observer")&&(e.observer||o&&b("party")),n}#y(e){if($(window.document).find(":hover").filter(bi).length)return;let i=e.actor;if(!i||i.isOfType("loot","party")||e.document.disposition===CONST.TOKEN_DISPOSITIONS.SECRET&&!i.isOwner||i.isOfType("npc")&&b("no-dead")&&i.isDead||(this.#n=e,e!==this.#f&&!this.#t&&this.close(),this.mousedown||this.#t||this.#i||e===this.#e))return;let n=b("key-holding"),o=this.#m(e);n!=="none"&&!this.#l&&(n==="all"||o)||(this.#k(!0),this.setToken(e,o),n==="none"||!this.#l?this.renderWithDelay():this.render())}#b(e){this.#n=null,!(this.mousedown||this.#t||this.#i)&&(this.#a=setTimeout(()=>{this.#a=null,!(this.#i||this.#t)&&this.close()},10))}renderWithDelay(){let e=b("delay");e?(e<10&&(e=10),this.#o=setTimeout(()=>{this.#o=null,this.render()},e)):this.render()}#k(e){this.#a!==null&&(clearTimeout(this.#a),this.#a=null,e&&this.close())}#g(){this.#o!==null&&(clearTimeout(this.#o),this.#o=null)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#r),window.removeEventListener("mouseup",this.#r),Hooks.off("hoverToken",this.#p),Hooks.off("deleteToken",this.#d),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(Application.defaultOptions,{popOut:!1,minimizable:!1,template:P("hud")})}get mousedown(){return this.#u[0]||this.#u[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return!!mt(this.actor)}get sidebar(){return this.element?.find("> .sidebar")??[]}get popup(){return this.element?.find("> .popup")??[]}get inner(){return this.element?.find("> .inner")??[]}async getData(){let e=this.#e,i=this.#e?.actor;if(!i)return{};let n=null,o=b("saves"),s=b("others"),r=i.isOfType("character"),{attributes:c}=i,{hp:a,ac:u}=c,f=a.sp??{max:0,value:0},p=game.settings.get("pf2e","staminaVariant"),d=b("distance"),g=b("scale");if(d==="all"||d==="self"&&this.#s){let w=b("unit").split(","),F=Number(w[0]?.trim())||1,A=w[1]?.trim()||game.system.gridUnits,T=Number(w[2]?.trim())||0,V=canvas.tokens.controlled,oe=!1,ae=V.length===1?V[0]:null;(!ae||ae===e)&&(ae=et(),oe=!0),ae&&ae!==e&&(n={unit:A,icon:oe?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(ae)*F).toFixed(T)})}let h;if(!this.#s||b("see-status")){let w=b("status").split(",").map(F=>F.trim()).filter(Boolean);if(w.length&&a.max){let F=a.max+(p?f.max:0),A=a.value+(p?f.value:0),T=Math.clamped(A/F,0,1),V=(()=>{let oe=w.length;return b("last-status")?T===1?oe:Math.ceil(T*(oe-1)):Math.ceil(T*oe)})();h={hue:T*T*122+3,value:V===0?game.i18n.localize("EFFECT.StatusDead"):w.at(V-1)}}}let m={status:h,distance:n,fontSize:g,tokenId:e.id,type:i.isOfType("creature")?"creature":i.type};if(!this.#s||i.isOfType("familiar")&&!i.master)return m;let{level:k,saves:v,isOwner:x,system:C,itemTypes:N}=i,{resistances:j,weaknesses:z,immunities:U}=c;if(m={...m,isOwner:x,isObserver:this.#s,name:e.document.name,hp:a,level:k},i.isOfType("army")){let w="Vqp8b64uH35zkncy",A=(await game.packs.get("pf2e.kingmaker-features")?.getDocuments({type:"campaignFeature"})??[]).filter(T=>T instanceof Item&&T.isOfType("campaignFeature"));return m={...m,basicWarActions:A.filter(T=>T.system.category==="army-war-action"&&T.folder?.id===w).map(T=>new CONFIG.Item.documentClass(T.toObject(!0),{parent:this.actor})).filter(T=>T.isOfType("campaignFeature"))},m}m={...m,ac:u.value,hasActions:N.action.length||C.actions?.filter(w=>w.visible!==!1).length};let O=b("ranks");function H(w,F,A){let T=w.slug,V=F==="bonus"?X(w.mod):w.dc.value;return{slug:T,value:V,label:A[T].label,icon:A[T].icon,rank:O&&Qe[w.rank]}}l(H,"getStatistic");function E(w,F){if(!w.length)return"";let A=w.map(T=>rt(T.label.replace("-"," ").titleCase())).join("");return F?`<li>${game.i18n.localize(F)}<ul>${A}</ul></li>`:A}if(l(E,"toIWR"),i.isOfType("hazard")){let{hardness:w,emitsSound:F,stealth:A}=c;return{...m,hardness:w,emitsSound:F.toString().capitalize(),immunities:E(U),weaknesses:E(z),resistances:E(j),stealth:{value:A.value,details:await ue(A.details,i)},saves:o!=="none"&&["fortitude","reflex","will"].map(T=>{let V=v[T];return V?H(V,o,Ne):{slug:T,label:Ne[T].label,icon:Ne[T].icon}})}}if(m={...m,sidebarTitles:{actions:`${L}.actions.title`,items:`${L}.items.title`,spells:`${L}.spells.title`,skills:`${L}.skills.title`,extras:`${L}.extras.title`},hasItems:i.inventory.size},i.isOfType("vehicle")){let{hardness:w,collisionDC:F,collisionDamage:A}=c,{details:T}=C,{crew:V,passengers:oe,pilotingCheck:ae,speed:_n}=T;return{...m,hardness:w,crew:V,passengers:oe,pilotingCheck:ae,speed:_n,collisionDC:F.value,collisionDamage:A.value,immunities:E(U),weaknesses:E(z),resistances:E(j),fortitude:H(v.fortitude,o,Ne)}}let W=b("show-death"),{heroPoints:D}=i,{resources:Q,perception:fe,details:M}=C,{wounded:B,dying:ke,shield:ot,speed:ve,adjustment:at}=c;function rt(w){return`<li>${w.trim()}</li>`}l(rt,"toInfo");function jn(w,F){return _(w,F)}l(jn,"sort");let Un=M?.languages?.value.map(w=>game.i18n.localize(CONFIG.PF2E.languages[w])).filter(Boolean).sort(jn).map(rt).join(""),Te=vi.map(({type:w,icon:F},A)=>({index:A,icon:F,label:game.i18n.localize(CONFIG.PF2E.speedTypes[w]??"PF2E.SpeedTypesLand"),value:(A===0?ve.total:ve.otherSpeeds.find(T=>T.type===w)?.total)||0})),Tt=ne(i,`speeds.selected.${game.user.id}`),Hn=(()=>{let w=0;if(Tt!==void 0)w=Tt;else if(b("force-speed")||Te[0].value===0){let F={index:0,value:Te[0].value};w=Te.reduce((A,{value:T},V)=>T>A.value?{index:V,value:T}:A,F).index}return Te.splice(w,1)[0]})(),It=Te.map(({value:w,label:F,index:A})=>`<li><a data-value="${A}">${F}: ${w}</a></li>`).join("");return ve.details&&(It+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${ve.details}</li>`),{...m,sp:p?f:{max:0},hero:D,dying:ke,wounded:B,shield:ot,resolve:Q.resolve,adjustment:at,alliance:Le[Mn(i).alliance],isCharacter:r,showDeathLine:r&&(W==="always"||ke.value||B.value),digitalPips:b("pips"),hasCover:this.hasCover,saves:o!=="none"&&["fortitude","reflex","will"].map(w=>H(v[w],o,Ne)),others:s!=="none"&&["perception","stealth","athletics"].map(w=>H(i.getStatistic(w),s,Si)),speeds:{main:Hn,others:It},iwr:E(U,"PF2E.ImmunitiesLabel")+E(z,"PF2E.WeaknessesLabel")+E(j,"PF2E.ResistancesLabel"),senses:fe.senses.map(w=>w.label)?.map(rt).join(""),languages:Un,hasSpells:i.spellcasting.some(w=>w.category!=="items"||w.id.endsWith("-casting")),hasNotes:!r&&(C.details.publicNotes||C.details.privateNotes&&x)}}close(e={}){this.setToken(null),this.unlock(!0),this.#i=!1,this.#g();let i=Application.RENDER_STATES;if(!e.force&&![i.RENDERED,i.ERROR].includes(this._state))return;this._state=i.CLOSING;let n=this.element;if(!n)return this._state=i.CLOSED,this._state;n.css({minHeight:0});for(let o of this.constructor._getInheritanceChain())Hooks.call(`close${o.name}`,this,n);n.remove(),this._element=null,this._state=i.CLOSED,delete ui.windows[this.appId]}async _render(e=!1,i={}){let n,o,s,r,c;if(this.#f===this.#e){let a=this.sidebar[0];if(a){n=a.dataset.type,o=a.scrollTop;let u=a.querySelector(".sidebar-header");u.classList.contains("show")&&(c=u.querySelector(" input").value.trim())}s=this.popup[0],s&&(r=s.scrollTop)}if(await super._render(e,i),ui.windows[this.appId]=this,n){let a=await this.#c(n,c);o>0&&a.scrollTop(o)}s&&(this.element.append(s),r>0&&(s.scrollTop=r)),this.#f=this.#e,this.inner.length&&b("autolock")==="render"&&this.lock()}render(){this.actor&&super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let i=this.element[0],n=e.worldTransform.a,o=i.getBoundingClientRect(),s=canvas.clientCoordinatesFromCanvas(e.document._source),r={x:s.x,y:s.y,width:e.hitArea.width*n,height:e.hitArea.height*n,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},c,a=this.#s?Dn[b("position")].slice():Dn[b("small-position")].slice();for(;a.length&&!c;){let u=a.shift();u==="left"?(c={x:r.x-o.width,y:xt(o,r)},c.x<0&&(c=void 0)):u==="right"?(c={x:r.right,y:xt(o,r)},c.x+o.width>window.innerWidth&&(c=void 0)):u==="top"?(c={x:Fn(o,r),y:r.y-o.height},c.y<0&&(c=void 0)):u==="bottom"&&(c={x:Fn(o,r),y:r.bottom},c.y+o.height>window.innerHeight&&(c=void 0))}return c&&(i.style.left=`${c.x}px`,i.style.top=`${c.y}px`),c}lock(){this.#t=!0}unlock(e){!e&&(this.sidebar.length||b("autolock")!=="none")||(this.#t=!1)}activateListeners(e){let i=this.#e,n=i?.actor;if(!n)return;let o=i.isOwner,s=ChatMessage.implementation;b("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.find("[data-action=show-notes").on("click",async a=>{a.preventDefault();let{publicNotes:u,privateNotes:f,blurb:p}=n.system.details,d=Object.keys(CONFIG.PF2E.creatureTraits),g=n.system.traits.value.filter(d.includes,d).map(m=>({label:game.i18n.localize(CONFIG.PF2E.creatureTraits[m])??m,description:game.i18n.localize(CONFIG.PF2E.traitsDescriptions[m])??""})),h=await renderTemplate(P("show-notes"),{traits:g,blurb:p.trim(),publicNotes:u.trim(),privateNotes:o&&f.trim()});he(`${n.name} - ${game.i18n.localize("PF2E.NPC.NotesTab")}`,h,n)}),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(b("autolock")==="hover"&&this.lock(),this.#i=!0)}),e.on("mouseleave",()=>{this.#i=!1,!(this.#t||this.#n)&&this.close()}),e.on("dragover",()=>{i.isOwner&&e.find("> .sidebar.extras").length&&!e.find("> .popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let r=e.find("[data-action=show-info]");(o?r.filter(":not(.speeds)"):r).on("click",a=>{let u=a.currentTarget,f=u.dataset.tooltipContent;u.classList.contains("stealth")?this.#h({content:f,event:a,direction:"DOWN"}):Oe({target:u,content:f,direction:"UP"})}),e.find("[data-action=open-sidebar]").on("click",this.#c.bind(this)),o&&(e.find("[data-action=toggle-adjustment]").on("click contextmenu",a=>{a.preventDefault();let u=a.type==="click"?"elite":"weak";n.applyAdjustment(n.system.attributes.adjustment===u?null:u)}),e.find("[data-action=toggle-alliance]").on("click",a=>{let{originalAlliance:u,defaultAlliance:f}=Mn(n),p=[{value:"default",label:game.i18n.format("PF2E.Actor.Creature.Alliance.Default",{alliance:game.i18n.localize(Le[f].label)})},{value:"opposition",label:game.i18n.localize(Le.opposition.label)},{value:"party",label:game.i18n.localize(Le.party.label)},{value:"neutral",label:game.i18n.localize(Le.neutral.label)}];this.#h({content:p,event:a,selected:u,onClick:d=>{d==="default"?n.update({"system.details.-=alliance":!0}):n.update({"system.details.alliance":d==="neutral"?null:d})}})}),e.find("[data-action=collision-dc]").on("click",a=>{a.preventDefault();let u=n.system.attributes.collisionDC.value||15;s.create({content:`@Check[type:reflex|dc:${u}]`,speaker:s.getSpeaker({actor:n})})}),e.find("[data-action=collision-damage]").on("click",async a=>{a.preventDefault();let u=(n.system.attributes.collisionDamage.value||"1d6").trim();Number.isNaN(Number(u.at(-1)))||(u+="[bludgeoning]");let f=Kt(),p=await new f(u).evaluate({async:!0});s.create({flavor:`<strong>${game.i18n.localize("PF2E.vehicle.collisionDamageLabel")}</strong>`,speaker:s.getSpeaker({actor:n}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:"sounds/dice.wav",rolls:[p]})}),e.find("input").on("change",async a=>{let u=a.currentTarget,f=u.valueAsNumber,p=u.name;u.blur(),p!=="shield.value"?await n.update({[p]:f}):await n.heldShield.update({"system.hp.value":f})}),e.find("[data-action=toggle-hero]").on("click contextmenu",a=>{a.preventDefault();let{max:u,value:f}=n.heroPoints,p=a.type==="click"?1:-1,d=Math.clamped(f+p,0,u);d!==f&&n.update({"system.resources.heroPoints.value":d})}),e.find("[data-action=raise-shield]").on("click",a=>{a.preventDefault(),game.pf2e.actions.raiseAShield({actors:[n],tokens:[i]})}),e.find("[data-action=take-cover]").on("click",async a=>{a.preventDefault();let u=mt(n);u?u.delete():game.pf2e.actions.get("take-cover").use({actors:[n],tokens:[i]})}),e.find("[data-action=roll-save]").on("click",a=>{a.preventDefault();let u=a.currentTarget.dataset.save;n.saves[u].roll({event:a})}),e.find("[data-action=roll-other]").on("click",a=>{a.preventDefault();let u=a.currentTarget.dataset.slug;if(u!=="athletics"){let{ctrlKey:f,metaKey:p,shiftKey:d}=a;a=new MouseEvent("click",{ctrlKey:!f,metaKey:p,shiftKey:d})}n.getStatistic(u)?.roll({event:a})}),e.find("[data-action=recovery-check]").on("click",a=>{a.preventDefault(),n.rollRecovery(a)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",a=>{a.preventDefault();let u=a.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",f=n.system.attributes[u]?.max;f&&(a.type==="click"?n.increaseCondition(u,{max:f}):n.decreaseCondition(u))}),e.find("[data-action=use-resolve]").on("click",a=>{a.preventDefault(),rn(n)}),r.filter(".speeds").on("click",a=>{this.#h({event:a,content:a.currentTarget.dataset.tooltipContent,direction:"UP",onClick:u=>{ge(n,`speeds.selected.${game.user.id}`,Number(u))}})}))}#h({content:e,event:i,onClick:n,selected:o,direction:s}){Oe({content:e,target:i.currentTarget,direction:s,selected:o,locked:!0,onCreate:()=>this.lock(),onClick:n,onDismiss:()=>this.unlock()})}async showFilter(){let e=this.sidebar;e.length&&(e.find(".sidebar-header").hasClass("show")||(e=await this.#c(e.data().type,"")),e.find(".sidebar-header").find("input").focus().select(),e.scrollTop(0))}async#c(e,i){let n=typeof e=="string"?e:e.currentTarget.dataset.type,o=this.element,s=this.sidebar,r=s[0]?.dataset.type;if(s.remove(),o.find("[data-action=open-sidebar]").removeClass("active"),r===n&&i===void 0){this.unlock();return}let c=this.#e,a=c.actor,u=i!==void 0||b("filter"),{getData:f,addListeners:p}=wi[n],d=(()=>{let O=ki[n];if(O)return Object.values(this.actor.synthetics.toggles).flatMap(H=>Object.values(H).filter(E=>E.placement===O))})(),g=await f({hud:this,actor:a,token:c,filter:i?.toLowerCase()})??{};if(!g.contentData&&!u&&!d.length)return ui.notifications.warn(I(`${n}.empty`,{name:this.#e.name}));let h={...g.contentData??{},isGM:game.user.isGM,isCharacter:a.isOfType("character"),isOwner:a.isOwner,isCreature:a.isOfType("creature")};this.lock(),o.find(`[data-action=open-sidebar][data-type=${n}]`).addClass("active"),o=o[0];let m=g.classes??[];m.push(n),b("scrollbar")||m.push("no-scrollbar"),g.doubled&&m.push("doubled");let k=g.style??{};k["--max-height"]=b("height").trim()||"100%";let v=document.createElement("div");v.innerHTML=await renderTemplate(P("sidebar"),{classes:m.join(" "),style:Object.entries(k).map(([O,H])=>`${O}: ${H}`).join("; "),type:n,filter:i,filterLabel:I("filter"),showFilter:u,toggles:d,isOwner:a.isOwner,content:(await renderTemplate(P(`sidebars/${n}`),h)).trim()}),s=v.firstElementChild,o.append(s);let x=s.getBoundingClientRect(),C=o.getBoundingClientRect(),N;b("position")==="left"?(N=C.x-x.width,N<0&&(N=C.right)):(N=C.right,N+x.width>window.innerWidth&&(N=C.x-x.width));let z=parseInt(window.getComputedStyle(o).padding),U=xt(x,C,z);return s.style.left=`${N}px`,s.style.top=`${U}px`,s=$(s),s.find(".sidebar-header [data-action=sidebar-filter-clear]").on("click",O=>{O.preventDefault(),s.find(".sidebar-header [data-action=sidebar-filter]").val(""),this.#c(n,"")}),s.find(".sidebar-header [data-action=sidebar-filter]").on("keydown",O=>{O.key==="Enter"&&this.#c(n,O.currentTarget.value.trim())}),s.find(".sidebar-toggles [data-action]").on("change",O=>{let H=O.currentTarget.closest(".toggle"),{domain:E,option:W,itemId:D}=H.dataset,Q=H.querySelector("select")?.value??null;a.toggleRollOption(E,W,D??null,H.querySelector("input").checked,Q)}),p({el:s,actor:a,token:c,hud:this}),Hooks.callAll("renderHUDSidebar",n,s,this),s}};l(Re,"HUD");function xt(t,e,i=0){let n=e.y+e.height/2-t.height/2;return n+t.height>window.innerHeight&&(n=window.innerHeight-t.height-i),n<0&&(n=i),n}l(xt,"postionFromTargetY");function Fn(t,e){let i=e.x+e.width/2-t.width/2;return i+t.width>window.innerWidth&&(y=window.innerWidth-t.width),i<0&&(i=0),i}l(Fn,"postionFromTargetX");function Mn(t){let e=t._source.system.details?.alliance,i=e===null?"neutral":e??"default",n=t.hasPlayerOwner?"party":"opposition";return{defaultAlliance:n,originalAlliance:i,alliance:i==="default"?n:i}}l(Mn,"getAlliance");var L="pf2e-token-hud",be=null;function ie(t=!1){return t?be?.element:be}l(ie,"getHud");function it(t){t&&!be?be=new Re:!t&&be&&(be.delete(),be=null)}l(it,"enableModule");function b(t){return game.settings.get(L,t)}l(b,"getSetting");function I(...t){let e=t.at(-1),i=typeof e=="object",n=i?t.slice(0,-1):t;return n.unshift(L),game.i18n[i?"format":"localize"](n.join("."),e)}l(I,"localize");function yt(t,e){return t.itemTypes.feat.some(i=>i.sourceId===e)}l(yt,"hasFeat");function P(t){return`modules/${L}/templates/${t}.hbs`}l(P,"templatePath");function X(t){return t>=0?`+${t}`:t}l(X,"modifier");function ne(t,e){return t.getFlag(L,e)}l(ne,"getFlag");function ge(t,e,i){return t.setFlag(L,e,i)}l(ge,"setFlag");async function ue(t,e,{isOwner:i=e.isOwner,rollData:n=e.getRollData()}={}){let o=t?.trim();return o?await TextEditor.enrichHTML(o,{async:!0,secrets:i,rollData:n}):""}l(ue,"enrichHTML");function Nn(){Ln("hold",{onDown:()=>{b("key-holding")!=="none"&&ie()?.setHolding(!0)},onUp:()=>{ie()?.setHolding(!1)}}),Ln("filter",{onUp:()=>{ie()?.showFilter()},editable:[{key:"KeyQ",modifiers:["Control"]}]})}l(Nn,"registerKeybindings");function Pn(t,e){return`${L}.keybinds.${t}.${e}`}l(Pn,"path");function Ln(t,e={}){game.keybindings.register(L,t,{name:Pn(t,"name"),hint:Pn(t,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}l(Ln,"register");function Rn(){let t=game.data.users.find(i=>i._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(i=>I(`settings.status.statuses.${i}`)).join(", ");S("status",String,e,{scope:"world"}),S("last-status",Boolean,!1,{scope:"world"}),S("party",Boolean,!1,{scope:"world"}),S("rk-dice",Boolean,!1,{scope:"world"}),S("enabled",Boolean,!0,{onChange:it}),S("position",String,"right",{choices:["left","right","top","bottom"]}),S("small-position",String,"top",{choices:["left","right","top","bottom"]}),S("delay",Number,250,{range:{min:0,max:2e3,step:50}}),S("scale",Number,14,{range:{min:10,max:30,step:1}}),S("key-holding",String,"none",{hint:re("key-holding",t?"choices.gm.hint":"choices.player.hint"),choices:{none:re("key-holding","choices.none"),half:re("key-holding",t?"choices.gm.half":"choices.player.half"),all:re("key-holding",t?"choices.gm.all":"choices.player.all")}}),S("autolock",String,"none",{choices:["none","hover","render"]}),S("chat-close",Boolean,!1),S("attack-close",Boolean,!1),S("action-close",Boolean,!1),S("cast-close",Boolean,!1),S("skill-close",Boolean,!1),S("macro-close",Boolean,!1),S("use-close",Boolean,!1),S("no-dead",Boolean,!1),S("observer",Boolean,!0),S("see-status",Boolean,!1),S("saves",String,"bonus",{choices:["none","bonus","dc"]}),S("others",String,"none",{choices:["none","bonus","dc"]}),S("ranks",Boolean,!1),S("show-death",String,"always",{choices:["none","always","only"]}),S("force-speed",Boolean,!1),S("tooltips",Boolean,!1),S("pips",Boolean,!1),S("distance",String,"all",{choices:["none","self","all"]}),S("unit",String,""),S("height",String,""),S("filter",Boolean,!1),S("scrollbar",Boolean,!0),S("hazard-width",Number,32,{range:{min:14,max:50,step:1}}),S("actions-columns",Boolean,!1),S("items-columns",Boolean,!1),S("spells-columns",Boolean,!1),S("skills-columns",Boolean,!1),S("actions",String,"split",{choices:["name","type","split"]}),S("action-effect",Boolean,!1),S("containers",Boolean,!1),S("spells-sort",String,"disabled",{choices:["disabled","type","entry"]}),S("tradition",Boolean,!1),S("untrained",Boolean,!0)}l(Rn,"registerSettings");function $n(t,e){let i=e.find(`.tab[data-tab=${L}]`);function n(o,s,r="h3"){let c=I(`menu.${s}`);i.find(`[name="${L}.${o}"]`).closest(".form-group").before(`<${r}>${c}</${r}>`)}l(n,"beforeGroup"),game.user.isGM&&n("enabled","client.header","h2"),n("saves","client.tooltip"),n("distance","client.distance"),n("height","client.sidebar"),n("actions","client.actions"),n("containers","client.items"),n("spells-sort","client.spells"),n("untrained","client.skills")}l($n,"renderSettingsConfig");function S(t,e,i,n={}){Dt({name:t,scope:"client",config:!0,type:e,default:i,...n})}l(S,"register");At("pf2e-token-hud");Hooks.once("setup",async()=>{Rn(),Nn(),await loadTemplates({creature:P("tooltips/creature"),hazard:P("tooltips/hazard"),vehicle:P("tooltips/vehicle"),army:P("tooltips/army")})});Hooks.once("ready",()=>{b("enabled")&&it(!0),game.modules.get("pf2e-token-hud").api={getHud:ie}});Hooks.on("renderSettingsConfig",$n);Hooks.on("drawMeasuredTemplate",t=>{t.isPreview&&ie()?.close()});Hooks.on("getActorDirectoryEntryContext",(t,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${L}.actor.macros.contextmenu`,condition:i=>{let{documentId:n}=i.data();return b("enabled")&&game.actors.get(n)?.isOwner},callback:i=>{let{documentId:n}=i.data();xi(n)}})});var st=class extends Dialog{async getData(e={}){let i=super.getData(e);return typeof i.content=="function"&&(i.content=await i.content()),i}};l(st,"DataDialog");function xi(t){let e=game.actors.get(t);if(!e)return;let i=new st({title:`${e.name} - ${I("actor.macros.title")}`,content:async()=>{let n=Xe(e)??[];return renderTemplate(P("dialogs/macros"),{macros:n,noMacro:I("extras.no-macro")})},buttons:{},render:n=>{e.apps[i.appId]=i,n.on("drop",o=>Je(o,e)),n.find("[data-action=delete-macro]").on("click",o=>Ze(o,e))},close:()=>{delete e.apps[i.appId]}},{height:"auto"}).render(!0)}l(xi,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
