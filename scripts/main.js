(()=>{var ds=Object.defineProperty;var u=(t,e)=>ds(t,"name",{value:e,configurable:!0});var ps="Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo";async function at(t){function e(p){ChatMessage.create({user:game.user.id,content:p,speaker:ChatMessage.getSpeaker({actor:t})})}u(e,"toChat");let{name:i,attributes:s,system:a}=t,r=s.hp.sp,l=a.resources.resolve,o=S("hud.resolve.full",{name:i}),n=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:i});if(r.value===r.max)return ui.notifications.warn(o);if(l.value<1)return ui.notifications.warn(n);let c=t.itemTypes.feat.find(p=>p.sourceId===ps),d=await renderTemplate(F("dialogs/resolve"),{hasSteel:c,i18n:p=>S(`hud.resolve.${p}`)});new Dialog({title:S("hud.resolve.title"),content:d,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:S("hud.resolve.yes"),callback:async p=>{let{attributes:f,system:k}=t,m=f.hp.sp,w=k.resources.resolve;if(m.value===m.max)return e(o);if(w.value<1)return e(n);let v=p.find("input:checked").val(),b=`${m.value}/${m.max}`;if(v==="breather")e(S("hud.resolve.breather.used",{name:i,ratio:b})),await t.update({"system.attributes.hp.sp.value":m.max,"system.resources.resolve.value":w.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:i,ratio:b}));let h=m.value+Math.floor(m.max/2);await t.update({"system.attributes.hp.sp.value":Math.min(h,m.max),"system.resources.resolve.value":w.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:S("hud.resolve.no")}}}).render(!0)}u(at,"useResolve");function ot(){return CONFIG.Dice.rolls.find(t=>t.name==="DamageRoll")}u(ot,"getDamageRollClass");function J(){return CONFIG.ChatMessage.documentClass}u(J,"getChatMessageClass");var fs=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),ms=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function gs(t,e="normal"){return t+(fs.get(e)??0)}u(gs,"adjustDC");function hs(t="common"){switch(t){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}u(hs,"rarityToDCAdjustment");function Se(t,e="common"){return gs(t,hs(e))}u(Se,"adjustDCByRarity");function Te(t,{proficiencyWithoutLevel:e,rarity:i="common"}={}){e??=game.settings.get("pf2e","proficiencyVariant");let s=ms.get(t)??14;return Se(e?s-Math.max(t,0):s,i)}u(Te,"calculateDC");function de(t,e){return t instanceof Element||t instanceof Document?Array.from(t.querySelectorAll(e)):[]}u(de,"htmlQueryAll");function re(t,e){return t instanceof Element?t.closest(e):null}u(re,"htmlClosest");var rt={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"},ys={0:"F",free:"F",1:"A",2:"D",3:"T","1 or 2":"A/D","1 to 3":"A - T","2 or 3":"D/T",reaction:"R"};function lt(t,e="systems/pf2e/icons/actions/Empty.webp"){if(t===null)return rt.passive;let i=typeof t!="object"?t:t.type==="action"?t.value:t.type,s=String(i??"").toLowerCase().trim();return rt[s]??e}u(lt,"getActionIcon");function De(t){if(!t&&t!==0)return"";let e=typeof t!="object"?t:t.type==="action"?t.value:t.type,i=String(e??"").toLowerCase().trim();return ys[i]??""}u(De,"getActionGlyph");function pe(t){return Error(`PF2e System | ${t}`)}u(pe,"ErrorPF2e");function ct(t,e){return t.includes(e)}u(ct,"tupleHasValue");function xe(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}u(xe,"objectHasKey");var Ee=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,qe=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,ks=new RegExp(qe,"gu"),bs=String.raw`(?:${Ee})(?=${qe})|(?:${qe})(?=${Ee})`,ws=String.raw`(?:${Ee})(?=${Ee})`,ut=String.raw`\p{Lowercase_Letter}`,dt=String.raw`\p{Uppercase_Letter}`,vs=new RegExp(`(${ut})(${dt}${ws})`,"gu"),Is=/[^-\p{White_Space}\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]/gu,Cs=new RegExp(`${dt}|(?:${bs})${ut}`,"gu");function fe(t,{camel:e=null}={}){if(typeof t!="string")return console.warn("Non-string argument passed to `sluggify`"),"";if(t==="-")return t;switch(e){case null:return t.replace(vs,"$1-$2").toLowerCase().replace(/['â€™]/g,"").replace(ks," ").trim().replace(/[-\s]+/g,"-");case"bactrian":{let i=fe(t,{camel:"dromedary"});return i.charAt(0).toUpperCase()+i.slice(1)}case"dromedary":return t.replace(Is,"").replace(/[-_]+/g," ").replace(Cs,(i,s)=>s===0?i.toLowerCase():i.toUpperCase()).replace(/\s+/g,"");default:throw pe("I don't think that's a real camel.")}}u(fe,"sluggify");function pt(t,e){return t.has(e)}u(pt,"setHasElement");function ft(t,e){let i={name:t,label:game.i18n.localize(e[t]??t)};return xe(CONFIG.PF2E.traitsDescriptions,t)&&(i.description=CONFIG.PF2E.traitsDescriptions[t]),i}u(ft,"traitSlugToObject");function mt(t){let e=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),i=game.i18n.localize(`PF2E.OrdinalSuffixes.${e.select(t)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:t,suffix:i})}u(mt,"ordinalString");function gt(t){return!!t&&"ctrlKey"in t&&"metaKey"in t&&"shiftKey"in t}u(gt,"isRelevantEvent");function Ae(t,e){let i=e.type==="check"?"showCheckDialogs":"showDamageDialogs",s=!game.user.settings[i];if(!gt(t))return{skipDialog:s};let a={skipDialog:t.shiftKey?!s:s};return(t.ctrlKey||t.metaKey)&&(a.rollMode=game.user.isGM?"gmroll":"blindroll"),a}u(Ae,"eventToRollParams");function Oe(t){return!gt(t)||!t.ctrlKey||!t.metaKey?"roll":game.user.isGM?"gmroll":"blindroll"}u(Oe,"eventToRollMode");var Ss=["fortitude","reflex","will"],yt=["action","check","effect-area"].map(t=>`[data-pf2-${t}]`).join(",");function Ts(t,e){for(let i of t){(!e||e.isOwner)&&i.classList.add("with-repost");let s=de(i,"i[data-pf2-repost]");if(s.length>0){if(e&&!e.isOwner){for(let l of s)l.remove();i.classList.remove("with-repost")}continue}if(e&&!e.isOwner)continue;let a=document.createElement("i"),r=i.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";a.classList.add("fa-solid",r),a.dataset.pf2Repost="",a.title=game.i18n.localize("PF2E.Repost"),i.appendChild(a),a.addEventListener("click",l=>{l.stopPropagation();let o=l.target;if(!(o instanceof HTMLElement))return;let n=o?.parentElement;if(!n)return;let c=kt(o,e);Ds(n,c)})}}u(Ts,"injectRepostElement");function Es(t,e=null){for(let i of de(t,"a.inline-roll[data-damage-roll]")){let s=re(i,"[data-item-id]")?.dataset.itemId,a=e?.items.get(s??"");a&&(i.dataset.flavor||=a.name)}}u(Es,"flavorDamageRolls");function ht(t,e){let i=t.attributes.getNamedItem("data-pf2-repost-flavor")?.value??"";return`<span data-visibility="${t.attributes.getNamedItem("data-pf2-show-dc")?.value??e}">${i}</span> ${t.outerHTML}`.trim()}u(ht,"makeRepostHtml");function Ds(t,e=null){if(!["pf2Action","pf2Check","pf2EffectArea"].some(c=>c in t.dataset))return;let i=We(e,t),s=(i??e)?.hasPlayerOwner?"all":"gm",a=(()=>t.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${de(t.parentElement,yt).map(d=>ht(d,s)).join("<br>")}</div>`:ht(t,s))(),r=J(),l=i?r.getSpeaker({actor:i,token:i.getActiveTokens(!1,!0).shift()}):r.getSpeaker(),o=game.messages.get(re(t,"[data-message-id]")?.dataset.messageId??""),n=e instanceof JournalEntry?{pf2e:{journalEntry:e.uuid}}:o?.flags.pf2e.origin?{pf2e:{origin:deepClone(o.flags.pf2e.origin)}}:{};r.create({speaker:l,content:a,flags:n})}u(Ds,"repostAction");function Le(t,e){e??=kt(t,e);let i=de(t,yt).filter(a=>["A","SPAN"].includes(a.nodeName));Ts(i,e),Es(t,e instanceof Actor?e:null);for(let a of i.filter(r=>r.dataset.pf2Action)){let{pf2Action:r,pf2Glyph:l,pf2Variant:o,pf2Dc:n,pf2ShowDc:c,pf2Skill:d}=a.dataset;a.addEventListener("click",p=>{let f=game.pf2e.actions[r?fe(r,{camel:"dromedary"}):""],k=c??"all";r&&f?f({event:p,glyph:l,variant:o,difficultyClass:n?{scope:"check",value:Number(n)||0,visibility:k}:void 0,skill:d}):console.warn(`PF2e System | Skip executing unknown action '${r}'`)})}for(let a of i.filter(r=>r.dataset.pf2Check&&!r.dataset.invalid)){let{pf2Check:r,pf2Dc:l,pf2Traits:o,pf2Label:n,pf2Defense:c,pf2Adjustment:d,pf2Roller:p,pf2RollOptions:f}=a.dataset;if(!r)return;a.addEventListener("click",async k=>{let m=We(e,a),w=[m],v=[...o?.split(",").map(h=>h.trim())??[],...f?.split(",").map(h=>h.trim())??[]],b=Ae(k,{type:"check"});switch(r){case"flat":{for(let h of w){let E=new Statistic(h,{label:"",slug:"flat",modifiers:[],check:{type:"flat-check"}}),A=Number.isInteger(Number(l))?{label:n,value:Number(l)}:null;E.roll({...b,extraRollOptions:v,dc:A})}break}default:{let h=ct(Ss,r),E=h?[]:v.filter(A=>A in CONFIG.PF2E.actionTraits)??[];for(let A of w){let R=(()=>{if(r in CONFIG.PF2E.magicTraditions){let P=A.spellcasting.filter(G=>G.tradition===r).flatMap(G=>G.statistic??[]).sort((G,ce)=>ce.check.mod-G.check.mod).shift()??null;if(P)return P}return A.getStatistic(r)})();if(!R){console.warn(pe(`Skip rolling unknown statistic ${r}`).message);continue}let D=c?game.user.targets.first()?.actor:null,_=(()=>{let P=Number(d)||0;return l==="@self.level"?Te(A.level)+P:Number(l??"NaN")+P})(),W=(()=>{if(Number.isInteger(_))return{label:n,value:_};if(c){let P=D?.getStatistic(c);return P?{statistic:P.dc,scope:"check",value:P.dc.value}:null}return null})(),N=(()=>{let P=e instanceof Item?e:e instanceof ChatMessage?e.item:null;return P?.isOfType("action","feat","campaignFeature")||h&&!P?.isOfType("weapon")?P:null})(),U={...b,extraRollOptions:v,origin:h&&m instanceof Actor?m:null,dc:W,target:!h&&W?.statistic?D:null,item:N,traits:E};if(!!(N?.isOfType("action","feat")&&N.actionCost)&&c){let P=r in CONFIG.PF2E.magicTraditions?"PF2E.ActionsCheck.spell":R.check.type==="attack-roll"?"PF2E.ActionsCheck.x-attack-roll":"PF2E.ActionsCheck.x";U.label=await renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:De(N.actionCost),subtitle:game.i18n.format(P,{type:R.label}),title:N.name})}R.roll(U)}}}})}let s={burst:"circle",cone:"cone",cube:"rect",emanation:"circle",line:"ray",rect:"rect",square:"rect"};for(let a of i.filter(r=>r.hasAttribute("data-pf2-effect-area"))){let{pf2EffectArea:r,pf2Distance:l,pf2TemplateData:o,pf2Traits:n,pf2Width:c}=a.dataset;a.addEventListener("click",()=>{if(!canvas.ready)return;if(typeof r!="string"){console.warn("PF2e System | Could not create template'");return}let d=JSON.parse(o??"{}");switch(d.distance||=Number(l),d.fillColor||=game.user.color,d.t=s[r],d.t){case"ray":d.width=Number(c)||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1);break;case"cone":d.angle=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let m=d.distance??0;d.distance=Math.hypot(m,m),d.width=m,d.direction=45;break}}let p={pf2e:{}};xe(CONFIG.PF2E.areaTypes,r)&&xe(CONFIG.PF2E.areaSizes,d.distance)&&(p.pf2e.areaType=r);let f=me(e,"ChatMessagePF2e")?e.id:re(t,"[data-message-id]")?.dataset.messageId??null;f&&(p.pf2e.messageId=f);let k=We(e,a);if(k||n){let m={};k&&(m.actor=k.uuid),n&&(m.traits=n.split(",")),p.pf2e.origin=m}isEmpty(p.pf2e)||(d.flags=p),canvas.templates.createPreview(d)})}for(let a of t.querySelectorAll("a[data-damage-roll]"))a.dataset.itemUuid=e.uuid}u(Le,"listenInlineRoll");function kt(t,e){if(e)return e;let s=(ui.windows[Number(t.closest(".app.sheet")?.dataset.appid)]??null)?.document;return s instanceof Actor||s instanceof JournalEntry?s:null}u(kt,"resolveDocument");function We(t,e){if(me(t,"ActorPF2e"))return t;if(me(t,"ItemPF2e")||me(t,"ChatMessagePF2e"))return t.actor;let i=e.dataset.itemUuid,s=i&&!i.startsWith("Compendium.")?fromUuidSync(i):null;return s instanceof Item?s.actor:null}u(We,"resolveActor");var Fe=["U","T","E","M","L"],xs="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi";async function bt(t,e){let i=t.data(),s=i.itemId?e.items.get(i.itemId):await fromUuid(i.uuid),a=await s?.getChatData({secrets:e.isOwner},i);if(!a)return;let r=document.createElement("div");return r.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(r,s,a),Le(r,s),r}u(bt,"getItemSummary");function V(t){let e=t.find(".name");e.on("mouseenter",i=>{i.preventDefault();let s=i.currentTarget,{width:a}=s.getBoundingClientRect();if(s.scrollWidth<=Math.ceil(a))return;let r=s.innerHTML.trim();game.tooltip.activate(i.currentTarget,{text:r,direction:TooltipManager.TOOLTIP_DIRECTIONS.UP})}),e.on("mouseleave",i=>{i.preventDefault(),game.tooltip.deactivate()}),e.on("mousedown",i=>{game.tooltip.deactivate()})}u(V,"addNameTooltipListeners");function wt(t,e){t.preventDefault(),B(t,e)?.sheet.render(!0,{focus:!0})}u(wt,"editItem");async function vt(t,e){t.preventDefault();let i=B(t,e);if(i){if(t.ctrlKey)return i.delete();new Dialog({title:S("deleteItem.title"),content:`<p>${game.i18n.format("PF2E.DeleteQuestion",{name:i.name})}</p>`,buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:S("deleteItem.ok"),callback:()=>i.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:S("deleteItem.cancel")}}}).render(!0)}}u(vt,"deleteItem");function B(t,e){let{itemId:i}=t.currentTarget.closest("[data-item-id]").dataset;return e.items.get(i)}u(B,"getItemFromEvent");function Pe(t){return t.isOwner?Q(t,`macros.${game.user.id}`)?.map(e=>{let i=fromUuidSync(e);return i?{img:i.img,name:i.name,uuid:e}:null}).filter(Boolean):void 0}u(Pe,"getMacros");function Me(t,e){let{type:i,uuid:s}=TextEditor.getDragEventData(t.originalEvent)??{};if(i!=="Macro"||!fromUuidSync(s))return;let a=`macros.${game.user.id}`,r=Q(e,a)?.slice()??[];r.includes(s)||(r.push(s),se(e,a,r))}u(Me,"onDroppedMacro");function Ne(t,e){let i=`macros.${game.user.id}`,s=Q(e,i)?.slice();if(!s?.length)return;let{uuid:a}=t.currentTarget.closest(".macro").dataset,r=s.indexOf(a);r!==-1&&(s.splice(r,1),se(e,i,s))}u(Ne,"deleteMacro");function $e(t=()=>!0){let e=game.user.targets,i=e.size===1?e.first():null;return i&&t(i)?i:null}u($e,"getUniqueTarget");function H(t,e){return e?t.toLowerCase().includes(e):!0}u(H,"filterIn");function M(t,e){return t.localeCompare(e,game.i18n.lang)}u(M,"localeCompare");function Ke(t){return t?.itemTypes.effect.find(e=>e.flags.core?.sourceId===xs)}u(Ke,"getCoverEffect");async function ie(t,e,i){let s=X(),a=s?.element;if(!a)return;a.find("> .popup").remove();let r=document.createElement("div");r.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${t}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${S("popup.close")}</a>
    </div>
</div>`;let l=r.firstElementChild;typeof e=="string"?(e=await te(e,i),l.insertAdjacentHTML("beforeend",e)):l.append(e),l.querySelector("[data-action=close-popup]").addEventListener("click",()=>l.remove()),a.append(l),s.lock()}u(ie,"popup");async function j(t,e,i){i??=t.find(".name").html();let s=await bt(t,e);s&&ie(i.trim(),s,e)}u(j,"showItemSummary");async function Re(t,e,i,s){let a=J(),r=`systems/pf2e/templates/chat/${fe(e.type)}-card.hbs`,l=i.token,o=re(t?.target,".item"),n=s.data??{...o?.dataset??{}},c={actor:i,tokenId:l?`${l.parent?.id}.${l.id}`:null,item:e,data:await e.getChatData(void 0,n)},d=t instanceof MouseEvent?t:t?.originalEvent,p=s.rollMode??Oe(d),f=a.applyRollMode({type:CONST.CHAT_MESSAGE_TYPES.OTHER,speaker:a.getSpeaker({actor:i,token:i.getActiveTokens(!1,!0).at(0)}),content:await renderTemplate(r,c),flags:{pf2e:{origin:e.getOriginData()}}},p);return s.create??!0?a.create(f,{rollMode:p,renderSheet:!1}):new a(f,{rollMode:p})}u(Re,"unownedItemToMessage");async function It(t,e="roll"){if(!t.system.selfEffect)throw pe(["Only actions with self-applied effects can be passed to `ActorPF2e#useAction`.","Support will be expanded at a later time."].join(" "));let{actor:i,actionCost:s}=t,a=i.getActiveTokens(!0,!0).shift()??null,r=J(),l=r.getSpeaker({actor:i,token:a}),o=await renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{title:t.name,glyph:De(s)},item:t,traits:t.system.traits.value.map(m=>ft(m,CONFIG.PF2E.actionTraits))}),n=100,c=(()=>{if(t.actor.pack)return null;let m=document.createElement("div"),w=[...CONST.DOCUMENT_LINK_TYPES,"Compendium","UUID"],v=new RegExp(`@(${w.join("|")})\\[([^#\\]]+)(?:#([^\\]]+))?](?:{([^}]+)})?`,"g");return m.innerHTML=t.description.replace(v,(b,...h)=>h[3]),m.innerText.slice(0,n)})(),d={full:c&&c.length<n?t.description:null,preview:c},p=await renderTemplate("systems/pf2e/templates/chat/action/self-effect.hbs",{actor:t.actor,description:d}),f={pf2e:{context:{type:"self-effect",item:t.id}}},k=r.applyRollMode({speaker:l,flavor:o,content:p,flags:f},e);return r.create(k)}u(It,"createSelfEffectMessage");async function Ct({weapon:t,trait:e,selection:i}){if(t.system.traits.toggles[e].selection===i)return!1;let a=t.actor?.items.get(t.id);return a?.isOfType("weapon")&&a===t?await a.update({[`system.traits.toggles.${e}.selection`]:i}):a?.isOfType("weapon")&&t.altUsageType==="melee"?a.update({[`system.meleeUsage.traitToggles.${e}`]:i}):e==="versatile"&&a?.isOfType("shield")?a.update({"system.traits.integrated.versatile.selection":i}):await a?.rules.find(l=>l.key==="Strike"&&!l.ignored&&l.slug===t.slug)?.toggleTrait({trait:e,selection:i}),!0}u(Ct,"toggleWeaponTrait");var Ue={CRITICAL_FAILURE:0,FAILURE:1,SUCCESS:2,CRITICAL_SUCCESS:3},St={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"};function Tt(t,e){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(e+t,0,3)}}u(Tt,"adjustDegreeOfSuccess");function He(t,e){return t===20?Tt(St.INCREASE,e):t===1?Tt(St.LOWER,e):e}u(He,"adjustDegreeByDieValue");function Et(t,e,i){return t-i>=10?He(e,Ue.CRITICAL_SUCCESS):i-t>=10?He(e,Ue.CRITICAL_FAILURE):t>=i?He(e,Ue.SUCCESS):He(e,Ue.FAILURE)}u(Et,"calculateDegreeOfSuccess");var As=["arcana","crafting","medicine","nature","occultism","religion","society"],Dt={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function xt(t){let e=await new Roll("1d20").evaluate({async:!0}),i=e.dice[0].total,s=i===1?"0":i===20?"3":"",a=Object.values(t.skills).filter(c=>c.lore),r=$e(c=>c.actor?.identificationDCs)?.actor,l={dieSuccess:s,dieResult:i,target:r,i18n:c=>S(`actions.recall-knowledge.${c}`)};if(r){let{standard:c,skills:d,lore:p}=r.identificationDCs,f=c.progression.slice();f.length=4,f=[...f];let k=p.map(({progression:m})=>{let w=m;return w.length=6,[...w]});l.skillsDCs=f,l.loresDCs=k,l.skills=await Promise.all(d.map(m=>{let w=t.skills[m];return Ve(w,i,f)})),l.lores=await Promise.all(a.map(m=>Ve(m,i)))}else l.skills=await Promise.all([...As.map(c=>t.skills[c]),...a].map(c=>Ve(c,i)));let o=g("rk-dice"),n={speaker:ChatMessage.getSpeaker({actor:t}),rollMode:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL};o&&(n.rolls=[e],l.rkDice=!0),n.flavor=await renderTemplate(F("chat/recall-knowledge"),l),ChatMessage.create(n)}u(xt,"rollRecallKnowledges");async function Ve(t,e,i){let{rank:s,label:a}=t,r=await t.roll({createMessage:!1,skipDialog:!0,extraRollOptions:["action:recall-knowledge"]}),l=r.total-r.dice[0].total,o=e+l;return{mod:l,rank:s,label:a,total:o,modifier:q(l),rankLabel:Fe[s],checks:i?.map(n=>{if(!n)return"-";let c=Et(o,e,n);return{success:c,icon:Dt[c].icon,title:Dt[c].name}})}}u(Ve,"rollSkill");var Y="pf2e-token-hud",Os="Compendium.pf2e.feats-srd.Item.9jGaBxLUtevZYcZO",Ls=new Set(["Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk"]),At="Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf",Fs="Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu",Ye="Compendium.pf2e.other-effects.Item.VCSpuc3Tf3XWMkd3",Ps={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${Y}.skills.actions.earnIncome`,treatWounds:`${Y}.skills.actions.treatWounds`,"borrow-arcane-spell":`${Y}.skills.actions.borrow-arcane-spell`,"identify-magic":`${Y}.skills.actions.identify-magic`,"identify-alchemy":`${Y}.skills.actions.identify-alchemy`,"learn-spell":`${Y}.skills.actions.learn-spell`,"crafting-goods":`${Y}.skills.actions.crafting-goods`,"staging-performance":`${Y}.skills.actions.staging-performance`},Ot={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW","sense-motive":"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","follow-the-expert":"Compendium.pf2e.actionspf2e.Item.tfa4Sh7wcxCEqL29","tumble-through":"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2",reposition:"Compendium.pf2e.actionspf2e.Item.lOE4yjUnETTdaf2T",shove:"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X",bonMot:At,gatherInformation:"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H"},Ms={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},ge=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:t=>!t.itemTypes.equipment.some(e=>e.isHeld&&Ls.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0,agile:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"reposition",cost:"1",type:2,map:!0,agile:!0},{slug:"shove",cost:"1",type:1,map:!0,agile:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0,agile:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0,agile:!0}]},{slug:"crafting",actions:[{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:t=>Je(t,At)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"],rollOption:"administer-first-aid"},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"identify-magic","learn-spell",{slug:"treatWounds",type:1,trained:!0,condition:t=>Je(t,Fs)}]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:[{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];ge.forEach(t=>{t.actions=t.actions.map(s=>typeof s=="string"?Ms[s]:s);let{slug:e,actions:i}=t;for(let s of i){let a=s.slug.replace(/-(.)/g,(r,l)=>l.toUpperCase()).capitalize();s.skillSlug=e,s.uuid=Ot[s.slug],s.label=Ps[s.slug]??`PF2E.Actions.${a}.Title`,s.variants?s.variants=s.variants.map(r=>({slug:r,label:`${Y}.skills.actions.${r}`})):s.map&&(s.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:s.agile?-4:-5},{label:"PF2E.MAPAbbreviationLabel",map:s.agile?-8:-10}]),s.modifiers?.forEach(({modifiers:r})=>{r.forEach(l=>{l.label=`${Y}.skills.modifiers.${l.slug}`})})}});var Qe=ge.map(t=>t.slug),Ns=ge.reduce((t,{slug:e,actions:i})=>(t[e]={slug:e,actions:i.reduce((s,a)=>(s[a.slug]=a,s),{})},t),{}),Lt=new Set(Object.values(Ot).filter(Boolean));function Xe(t){return game.i18n.localize(t==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[t])}u(Xe,"getSkillLabel");async function Ft({actor:t,filter:e}){let i=[],s=t.isOfType("character"),a=s&&g("untrained")&&!t.itemTypes.feat.some(o=>o.sourceId===Os);for(let o=0;o<ge.length;o++){let{slug:n,actions:c}=ge[o],{label:d,rank:p,mod:f}=t.getStatistic(n),k=game.i18n.localize(d),m=c.filter(({condition:b,trained:h})=>(!a||!s||!h||t.skills[n].rank>=1)&&(!b||b(t))).map(b=>({...b,name:game.i18n.localize(b.label),variants:b.variants?.map(h=>({...h,name:game.i18n.localize(h.label)}))})),w=H(k,e),v=m;!w&&(v=m.filter(({name:b,variants:h})=>H(b,e)||h?.some(E=>H(E.name,e))),!v.length)||(i[o]={slug:n,name:k,rank:p,modifier:q(f),actions:w?m:v})}i.sort((o,n)=>o.slug==="perception"?-1:n.slug==="perception"?1:M(o.name,n.name));let r=Object.values(t.skills).filter(({lore:o,label:n})=>o&&H(n,e)).map(({label:o,rank:n,mod:c,slug:d})=>({slug:d,label:o,rank:n,modifier:q(c)})),l=r.reduce((o,n)=>n.modifier.length>o?n.modifier.length:o,2);return{contentData:{follow:S(`skills.actions.${Mt(t)?"following":"follow"}`),skills:i,lores:r,loresModifierWidth:l},doubled:g("skills-columns")}}u(Ft,"getSkillsData");function Pt({el:t,actor:e,token:i,hud:s}){t.find("[data-action=action-description]").on("click",a=>{a.preventDefault();let r=$(a.currentTarget).closest(".action");j(r,e,r.find(".name").children().html())}),e.isOwner&&(t.find("[data-action=follow-the-expert]").on("click",async a=>{a.preventDefault();let r=Mt(e);if(r)return await r.delete();let l=(await fromUuid(Ye)).toObject();setProperty(l,"flags.core.sourceId",Ye),await e.createEmbeddedDocuments("Item",[l])}),t.find("[data-action=roll-skill]").on("click",a=>{a.preventDefault();let{slug:r}=a.currentTarget.dataset;e.getStatistic(r)?.roll({event:a}),g("skill-close")&&s.close()}),t.find("[data-action=roll-action]").on("click contextmenu",async a=>{a.preventDefault();let r=$(a.currentTarget),{skillSlug:l,slug:o}=r.closest(".action").data(),{variant:n,map:c}=r.data(),d=a.type==="contextmenu"?await _e(l):void 0;d!==null&&($s({event:a,actor:e,token:i,skillSlug:l,slug:o,variant:n,map:c,skill:d?.selected}),g("skill-close")&&s.close())}),t.find("[data-action=action-chat]").on("click",async a=>{a.preventDefault();let{uuid:r}=a.currentTarget.closest(".action").dataset,l=await fromUuid(r);l&&(Re(a,l,e,{create:!0}),g("chat-close")&&s.close())}))}u(Pt,"addSkillsListeners");function Mt(t){return t.itemTypes.effect.find(e=>e.sourceId===Ye)}u(Mt,"isFollowingAnExpert");async function _e(t,e){let i=Qe.map(a=>({slug:a,label:Xe(a)})),s=await renderTemplate(F("dialogs/variant"),{i18n:a=>S(`skills.variant.${a}`),dc:e,skills:i,selected:t});return Dialog.prompt({title:S("skills.variant.title"),label:S("skills.variant.button"),callback:a=>({selected:a.find("select").val(),dc:Number(a.find("input").val())}),rejectClose:!1,content:s,options:{width:280}})}u(_e,"variantsDialog");function $s({event:t,actor:e,skillSlug:i,slug:s,variant:a,map:r,skill:l,token:o}){let n=Ns[i].actions[s],c=n.type===3?3:game.pf2e.actions.has(s)?2:1;l??=n.noSkill?void 0:i;let d=n.rollOption?[`action:${n.rollOption}`]:void 0;d&&a&&d.push(`action:${n.rollOption}:${a}`);let p={event:t,actors:[e],tokens:[o],variant:a,rollOptions:d,rollMode:n.secret?"blindroll":"roll"};if(p.modifiers=[],n.modifiers){for(let{condition:f,modifiers:k}of n.modifiers)if(!(f&&!f(e)))for(let m of k)p.modifiers.push(new game.pf2e.Modifier(m))}if(n.custom){n.custom(e,p);return}else if(!c){e.getStatistic(l)?.roll(p);return}c===1?(p.skill=l,r&&p.modifiers.push(new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:r})),game.pf2e.actions[s](p)):c===2?(p.statistic=l,r&&(p.multipleAttackPenalty=r/-5),game.pf2e.actions.get(s).use(p)):c===3&&game.pf2e.actions[s](e)}u($s,"rollAction");var Ze={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","point-out":"Compendium.pf2e.actionspf2e.Item.sn2hIy1iIJX9Vpgj"};async function Nt({actor:t,filter:e}){let{attributes:i}=t,{initiative:s}=i;return{contentData:{noMacro:S("extras.no-macro"),macros:Pe(t)?.filter(a=>H(a.name,e)),initiative:s&&{selected:s.statistic,skills:Qe.map(a=>({slug:a,label:Xe(a)}))},hasDailies:game.modules.get("pf2e-dailies")?.active,hasPerception:game.modules.get("pf2e-perception")?.active,uuids:Ze}}}u(Nt,"getExtrasData");function $t({el:t,actor:e,token:i,hud:s}){function a(l,o,n="click"){t.find(`[data-action=${l}]`).on(n,c=>{c.preventDefault(),o(c)})}if(u(a,"action"),a("action-description",l=>{let o=$(l.currentTarget).closest(".row");j(o,e)}),!e.isOwner)return;V(t.find(".macro"));async function r(l){let{uuid:o}=l.currentTarget.closest(".macro").dataset;return fromUuid(o)}u(r,"getMacro"),a("delete-macro",l=>Ne(l,e)),a("edit-macro",async l=>{(await r(l))?.sheet.render(!0)}),a("use-macro",async l=>{(await r(l))?.execute({actor:e,token:i}),g("macro-close")&&s.close()}),t.on("drop",l=>Me(l,e)),a("action-chat",async l=>{let{uuid:o}=l.currentTarget.closest(".row").dataset,n=await fromUuid(o);n&&(Re(l,n,e,{create:!0}),g("chat-close")&&s.close())}),t.find("input[name], select[name]").on("change",async l=>{let o=l.currentTarget,n=o.type==="number"?o.valueAsNumber:o.value;await e.update({[o.name]:n})}),a("roll-initiative",async l=>{await e.initiative.roll({event:l}),g("skill-close")&&s.close()}),a("prepare-dailies",l=>{let o=game.modules.get("pf2e-dailies");o?.active&&o.api.openDailiesInterface(e)}),a("rest-for-the-night",l=>{game.pf2e.actions.restForTheNight({actors:[e],tokens:[i]})}),a("roll-recall-knowledge",l=>{xt(e),g("skill-close")&&s.close()}),a("roll-aid",async l=>{let o=await _e(null,15),n={text:"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]"};o!==null&&(game.pf2e.actions.get("aid").use({event:l,actors:[e],tokens:[i],statistic:o?.selected,difficultyClass:{value:o?.dc},notes:[n]}),g("skill-close")&&s.close())},"click contextmenu"),a("roll-point-out",l=>{game.pf2e.actions.get("point-out").use({event:l,actors:[e],tokens:[i]}),g("skill-close")&&s.close()}),a("roll-escape",async l=>{let o=l.type==="contextmenu"?await _e():void 0,n=$(l.currentTarget).data().map;o!==null&&(game.pf2e.actions.get("escape").use({event:l,actors:[e],tokens:[i],statistic:o?.selected,multipleAttackPenalty:n}),g("skill-close")&&s.close())},"click contextmenu")}u($t,"addExtrasListeners");var le={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionsReactionsHeader",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionsFreeActionsHeader",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.NPC.PassivesLabel",actionLabel:"PF2E.ActionTypePassive"},exploration:{order:3,label:"PF2E.TravelSpeed.ExplorationActivity",actionLabel:"PF2E.TabActionsExplorationLabel"}};async function Rt({hud:t,actor:e,filter:i}){let s=e.isOfType("character"),a=e.synthetics.toggles.slice(),r=g("actions"),l=(await et()?.getStances(e))?.sort((v,b)=>M(v.name,b.name)),o=s?await ne()?.getHeroActions(e):void 0,n=o?e.heroPoints.value-o.length:void 0,c=e.isOwner,d=e.getRollData(),p=e.system.actions?await Promise.all(e.system.actions.map(async(v,b)=>({...v,index:b,visible:!s||v.visible,damageFormula:await v.damage?.({getFormula:!0}),criticalFormula:await v.critical?.({getFormula:!0}),description:v.description?await te(v.description,e,{rollData:d,isOwner:c}):void 0,altUsages:v.altUsages&&await Promise.all(v.altUsages.map(async h=>({...h,usage:h.item.isThrown?"thrown":"melee",damageFormula:await h.damage?.({getFormula:!0}),criticalFormula:await h.critical?.({getFormula:!0})})))}))):void 0,f=s?new game.pf2e.ElementalBlast(e):void 0,k=f?(await Promise.all(f.configs.map(async v=>{let b=v.damageTypes.find(E=>E.selected)?.value??"untyped",h=u((E,A=!0)=>f.damage({element:v.element,damageType:b,melee:A,outcome:E,getFormula:!0}),"formulaFor");return{...v,damageType:b,formula:{melee:{damage:await h("success"),critical:await h("criticalSuccess")},ranged:{damage:await h("success",!1),critical:await h("criticalSuccess",!1)}}}}))).sort((v,b)=>M(v.label,b.label)):void 0,m={},w=s?Us(e,l):Hs(e);for(let v of w)H(v.name,i)&&(r!=="split"?(m.action??=[],m.action.push(v)):(m[v.type]??=[],m[v.type].push(v)));if(m=Object.entries(m).map(([v,b])=>(b.forEach(h=>{h.img=lt(h.cost),h.typeLabel=le[h.type].actionLabel}),r!=="type"?b.sort((h,E)=>M(h.name,E.name)):b.sort((h,E)=>{let A=le[h.type].order,R=le[E.type].order;return A===R?M(h.name,E.name):A-R}),{type:v,actions:b,label:le[v].label})),r==="split"&&m.sort((v,b)=>le[v.type].order-le[b.type].order),a.length||l?.length||p?.length||k?.length||m.length||o?.length){let v=+((l?.length??0)>0)+ +((p?.length??0)>0)+ +((k?.length??0)>0)+m.length+ +((o?.length??0)>0);return{contentData:{toggles:a,stances:l,strikes:p,blasts:k,sections:m,heroActions:o&&{actions:o,draw:Math.max(n,0),discard:Math.abs(Math.min(n,0)),canTrade:o.length&&Rs()},i18n:b=>S(`actions.${b}`),variantLabel:b=>b.replace(/.+\((.+)\)/,"$1"),damageTypes:CONFIG.PF2E.damageTypes},doubled:v>1&&g("actions-columns"),classes:[g("actions-colors")?"attack-damage-system-colors":""]}}}u(Rt,"getActionsData");function Ut({el:t,actor:e,hud:i}){V(t.find(".toggle")),V(t.find(".strike")),V(t.find(".action"));function s(o,n,c="click"){return o=typeof o=="string"?[o]:o,o=o.map(d=>`[data-action=${d}]`).join(", "),t.find(o).on(c,d=>{d.preventDefault(),n(d)})}u(s,"action");function a(o){let n=o.currentTarget.closest(".strike"),c=e.system.actions[n.dataset.index];if(!c)return null;let{altUsage:d}=o.currentTarget.dataset;return["melee","thrown"].includes(d)?c.altUsages?.find(p=>d==="thrown"?p.item.isThrown:p.item.isMelee)??null:c}u(a,"getStrike");function r(o){return $(o.currentTarget).closest(".action").data().uuid}if(u(r,"getUuid"),s("action-description",async o=>{let n=$(o.currentTarget).closest(".action");j(n,e)}),s("hero-action-description",async o=>{let n=r(o),{description:c,name:d}=await ne()?.getHeroActionDetails(n)??{};c&&ie(d,c,e)}),s("strike-description",async o=>{let n=a(o);if(!n)return;let c=document.createElement("div");c.classList.add("description"),c.innerHTML=await renderTemplate(F("strike-description"),n),ie(n.label,c,e)}),s("blast-description",async o=>{let n=o.currentTarget.closest(".blast");j($(n),e)}),s("trait-description",o=>{let n=a(o);if(!n)return;let{index:c}=o.currentTarget.dataset,d=n.traits[c];if(!d)return;let p=game.i18n.localize(d.description);p&&ie(game.i18n.localize(d.label),p,e)}),s("stance-description",o=>{let n=$(o.currentTarget).closest(".action");j(n,e,n.data().itemName)}),!e.isOwner||(s("use-action",o=>{let n=B(o,e);n?.isOfType("action","feat")&&(It(n,Oe(o)),g("action-effect")&&_s(e,n),g("action-close")&&i.close())}),s("stance-chat",o=>{let n=B(o,e);n&&(n.toMessage(o,{create:!0}),g("chat-close")&&i.close())}),s("stance-toggle",o=>{let{effectUuid:n}=o.currentTarget.closest(".action").dataset;et()?.toggleStance(e,n)}),s("exploration-toggle",o=>{let n=o.currentTarget.closest(".action").dataset.itemId,c=e.system.exploration.filter(d=>e.items.has(d));c.findSplice(d=>d===n)||c.push(n),e.update({"system.exploration":c})}),s("action-chat",o=>{let n=B(o,e);n&&(n.toMessage(o,{create:!0}),g("chat-close")&&i.close())}),s("hero-action-chat",async o=>{let n=ne();n&&(n.sendActionToChat(e,r(o)),g("chat-close")&&i.close())}),s("draw-hero-action",async o=>{await ne()?.drawHeroActions(e)}),s("use-hero-action",async o=>{let n=ne();n&&(n.useHeroAction(e,r(o)),g("action-close")&&i.close())}),s("discard-hero-action",async o=>{await ne()?.discardHeroActions(e,r(o))}),s("trade-hero-action",async o=>{ne()?.tradeHeroAction(e)}),s("strike-attack",o=>{let{index:n,altUsage:c}=o.currentTarget.dataset;a(o)?.variants[n].roll({event:o,altUsage:c}),g("attack-close")&&i.close()}),s(["strike-damage","strike-critical"],o=>{let{action:n}=o.currentTarget.dataset;a(o)?.[n==="strike-damage"?"damage":"critical"]({event:o}),g("attack-close")&&i.close()}),s(["toggle-roll-option","set-suboption"],o=>{let n=o.currentTarget.closest(".toggle"),{domain:c,option:d,itemId:p}=n.dataset,f=n.querySelector("select")?.value??null;e.toggleRollOption(c,d,p??null,n.querySelector("input").checked,f)}),s("strike-auxiliary",o=>{if(o.currentTarget!==o.target)return;let n=a(o);if(!n)return;let{index:c}=o.currentTarget.dataset,d=o.currentTarget.querySelector("select")?.value??null;n.auxiliaryActions?.[c]?.execute({selection:d})}),s("toggle-versatile",o=>{let n=a(o)?.item;if(!n)return;let c=o.currentTarget,{value:d}=c.dataset,p=n?.system.damage.damageType??null,f=c.classList.contains("selected")||d===p?null:d;Ct({trait:"versatile",weapon:n,selection:f})}),s("strike-ammo",async o=>{let n=a(o)?.item;if(!n)return;let c=e.items.get(o.currentTarget.value);await n.update({system:{selectedAmmoId:c?.id??null}})},"change"),!e.isOfType("character")))return;let l=["roll-attack","roll-damage","set-damage-type"].map(o=>`[data-action=${o}]`).join(",");t.find(".blast").each((o,n)=>{let{element:c,damageType:d}=n.dataset,p=new game.pf2e.ElementalBlast(e);$(n).find(l).on("click",async f=>{f.preventDefault();let k=f.currentTarget.dataset,m=k.melee==="true";switch(k.action){case"roll-attack":{let w=Math.clamped(Number(k.mapIncreases),0,2);p.attack({mapIncreases:Math.clamped(w,0,2),element:c,damageType:d,melee:m,event:f});break}case"roll-damage":{p.damage({element:c,damageType:d,melee:m,outcome:k.outcome,event:f});break}case"set-damage-type":p.setDamageType({element:c,damageType:k.value})}["roll-attack","roll-damage"].includes(k.action)&&g("attack-close")&&i.close()})})}u(Ut,"addActionsListeners");function Ht(t){let e=game.modules.get("pf2e-toolbelt");return e?.active&&game.settings.get("pf2e-toolbelt",t)?e:void 0}u(Ht,"getToolBeltModule");function _t(t){return Ht(t)?.api}u(_t,"getToolBeltApi");function et(){let t=game.modules.get("pf2e-stances");return t?.active?t.api:_t("stances")?.stances}u(et,"getStancesModuleApi");function ne(){let t=game.modules.get("pf2e-hero-actions");return t?.active?t.api:_t("hero")?.heroActions}u(ne,"getHeroActionsApi");function Rs(){if(game.modules.get("pf2e-hero-actions")?.active)return game.settings.get("pf2e-hero-actions","trade");if(Ht("hero"))return game.settings.get("pf2e-toolbelt","hero-trade")}u(Rs,"canTradeHeroActions");function Us(t,e){let i=et()?.getActionsUUIDS?.()??(e?.some(n=>n.actionUUID)?new Set(e.map(({actionUUID:n})=>n)):void 0)??new Set,s=new Set([...i,...Lt,...Object.values(Ze)]),a=t.itemTypes.action,r=t.itemTypes.feat.filter(n=>n.actionCost),l=t.parties.size>0,o=t.system.exploration;return[...a,...r].map(n=>{let c=n.sourceId,d=n.id,p=n.actionCost,f=n.system.traits.value,k=f.includes("exploration");return{sourceId:c,id:d,type:p?.type??(k?"exploration":"free"),cost:p,name:n.name,isExploration:k,isDowntime:f.includes("downtime"),isActive:k&&o.includes(d),hasEffect:!!n.system.selfEffect}}).filter(n=>!n.isDowntime&&(l||!n.isExploration)&&(n.isExploration||!s.has(n.sourceId)))}u(Us,"getCharacterActions");function Hs(t){return t.itemTypes.action.map(e=>{let i=e.actionCost,s=i?.type??"passive",a=s==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(r=>r.key==="Aura"));return{id:e.id,type:s,cost:i,name:e.name,hasDeathNote:e.system.deathNote,hasAura:a,hasEffect:!!e.system.selfEffect}})}u(Hs,"getNpcActions");async function _s(t,e){let i=e.system.selfEffect?.uuid;if(!i)return;let s=(await fromUuid(i))?.toObject();s&&t.createEmbeddedDocuments("Item",[s])}u(_s,"applyActionEffect");async function Bt({actor:t}){let{system:e}=t,{details:i,traits:s,attributes:a}=e,{stealth:r}=a,{description:l,disable:o,routine:n,reset:c,isComplex:d}=i,p=t.getRollData(),f=t.isOwner,k=u(async m=>te(m,t,{isOwner:f,rollData:p}),"enrich");return{contentData:{description:await k(l),disable:await k(o),routine:await k(n),reset:await k(c),isComplex:d,rarity:{value:s.rarity,label:CONFIG.PF2E.rarityTraits[s.rarity]},traits:s.value.map(m=>CONFIG.PF2E.hazardTraits[m]),stealth:q(r.value)},style:{["--max-width"]:g("hazard-width")+"em"}}}u(Bt,"getHazardData");function zt({el:t,actor:e}){t.find("[data-action=action-description]").on("click",i=>{i.preventDefault();let s=$(i.currentTarget).closest(".action");j(s,e)}),Le(t[0],e),e.isOwner&&t.find("[data-action=roll-initiative").on("click",i=>{i.preventDefault(),e.initiative.roll({event:i})})}u(zt,"addHazardListeners");var jt=new Set(["arcane","divine","occult","primal"]);function Bs(t){return t.traits.has("cursed")?"unique":t.rarity}u(Bs,"getDcRarity");function zs(t){let e=t.system.traits.value;return new Set(e.filter(i=>pt(jt,i)))}u(zs,"getMagicTraditions");function js(t,e,i){let s={occult:e,primal:e,divine:e,arcane:e},a=zs(t);for(let r of jt)a.size>0&&!a.has(r)&&(s[r]=e+i);return{arcana:s.arcane,nature:s.primal,religion:s.divine,occultism:s.occult}}u(js,"getIdentifyMagicDCs");function Gs(t,{proficiencyWithoutLevel:e=!1,notMatchingTraditionModifier:i}){let s=Te(t.level,{proficiencyWithoutLevel:e}),a=Bs(t),r=Se(s,a);return t.isMagical?js(t,r,i):t.isAlchemical?{crafting:r}:{dc:r}}u(Gs,"getItemIdentificationDCs");function qs(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}u(qs,"objectHasKey");var he=class extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let e=this.object,i=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),s=game.settings.get("pf2e","proficiencyVariant")==="ProficiencyWithoutLevel",a=Gs(e,{proficiencyWithoutLevel:s,notMatchingTraditionModifier:i});return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:a}}activateListeners(e){e.find("button.update-identification").on("click",i=>{let s=$(i.delegateTarget);this.submit({updateData:{status:s.val()}})}),e.find("button.post-skill-checks").on("click",async()=>{let i=this.item,s=i.system.identification.unidentified.img,a=i.system.identification.unidentified.name,r=i.system.identification.identified.name,l=$("div#identify-item").find("tr").toArray().flatMap(c=>{let d=c.dataset.skill,p=Number(c.dataset.dc);if(!(Number.isInteger(p)&&qs(CONFIG.PF2E.skillList,d)))return[];let f=game.i18n.localize(CONFIG.PF2E.skillList[d]);return{slug:d,name:f,dc:p}}),o=i.isMagical?"action:identify-magic":i.isAlchemical?"action:identify-alchemy":null,n=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:s,itemName:a,identifiedName:r,rollOptions:["concentrate","exploration","secret",o].filter(Boolean),skills:l});await J().create({user:game.user.id,content:n})})}async _updateObject(e,i){let s=i.status;s==="identified"&&await this.item.setIdentificationStatus(s)}};u(he,"IdentifyItemPopup");async function ke({target:t,selected:e,direction:i="DOWN",onCreate:s,onDismiss:a,onClick:r,content:l,cssClass:o=[],locked:n=!1}){return new Promise(c=>{let d=`${x}-tooltip`,p=document.body.querySelectorAll(`.${d}:not(#tooltip)`);for(let f of p)ye(f);requestAnimationFrame(()=>{o=typeof o=="string"?[o]:o,e&&o.push("selection-tooltip"),Array.isArray(l)&&(l=l.map(({value:k,label:m})=>`<li><a  ${k===e?'class="selected"':""} data-value="${k}">${m}</a></li>`).join(""));let f;l instanceof HTMLElement?f=l:(f=document.createElement("ul"),f.innerHTML=l),f.style.setProperty("--font-size",g("scale")+"px"),o.length&&f.classList.add(...o.map(k=>`${x}-${k}`)),a&&new MutationObserver(function(){document.body.contains(f)||(a(),this.disconnect())}).observe(document.body,{childList:!0}),r&&(n=!0,f.querySelectorAll("[data-value]").forEach(k=>{k.addEventListener("click",async m=>{m.preventDefault();let w=m.currentTarget;ye(w),r?.(w.dataset.value)})})),game.tooltip.activate(t,{content:f,direction:i,locked:n,cssClass:d}),s?.(f),c(f)})})}u(ke,"createTooltip");function ye(t){t=t.closest(`.${x}-tooltip`),game.tooltip.dismissLockedTooltip(t)}u(ye,"dismissTooltip");var Be={weaponAndShield:{order:0,label:"PF2E.Actor.Inventory.Section.WeaponsAndShields"},armor:{order:1,label:"TYPES.Item.armor"},consumable:{order:2,label:"PF2E.Item.Consumable.Plural"},equipment:{order:3,label:"TYPES.Item.equipment"},treasure:{order:4,label:"TYPES.Item.treasure"},backpack:{order:5,label:"PF2E.Item.Container.Plural"}};async function Gt({actor:t,filter:e}){let{contents:i,coins:s,totalWealth:a,bulk:r,invested:l}=t.inventory,o=t.isOfType("creature"),n=g("containers")||(Q(t,`containers.${game.user.id}`)??[]),c={},d={};for(let p of i){let f=p.type==="shield"||p.type==="weapon"?"weaponAndShield":p.type;if(!Be[f])continue;let k=p.system.containerId;f!=="backpack"&&k&&(n===!0||n.includes(k))?(c[k]??=[],c[k].push(p)):(d[f]??=[],d[f].push(p))}if(d=Object.entries(d).map(([p,f])=>{if(f.sort((k,m)=>M(k.name,m.name)),p==="backpack")for(let k=f.length-1;k>=0;k--){let m=f[k],w=c[m.id]?.filter(v=>H(v.name,e));if(!w?.length){H(m.name,e)||f.splice(k,1);continue}w.sort((v,b)=>M(v.name,b.name)),f.splice(k+1,0,...w)}else f=f.filter(k=>H(k.name,e));return{type:p,items:f,label:Be[p].label}}).filter(p=>p.items.length).sort((p,f)=>Be[p.type].order-Be[f.type].order),d.length)return{doubled:d.length>1&&g("items-columns"),contentData:{canCarry:!!t.adjustCarryType,categories:d,bulk:r,containers:n,i18n:p=>S(`items.${p}`),invested:l?`${game.i18n.localize("PF2E.InvestedLabel")}: ${l.value} / ${l.max}`:"",wealth:{coins:s.goldValue,total:a.goldValue},canUseItem:p=>o&&p.type==="consumable"&&p.isIdentified&&p.uses.max&&!p.isAmmunition,itemDisabled:p=>!p.quantity||!p.uses.value||p.system.equipped.carryType==="dropped"}}}u(Gt,"getItemsData");function qt({el:t,actor:e,token:i,hud:s}){let a=t.find(".item");V(a),a.find("[data-action=item-description]").on("click",async r=>{r.preventDefault();let l=$(r.currentTarget).closest(".item");await j(l,e)}),a.find("[data-action=toggle-contains-items]").on("click",async r=>{r.preventDefault();let l=`containers.${game.user.id}`,o=r.currentTarget.closest(".item").dataset.itemId,n=Q(e,l)?.slice()??[],c=n.indexOf(o);c===-1?n.push(o):n.splice(c,1),await se(e,l,n)}),e.isOwner&&(a.find("[data-action=use-item]").on("click",r=>{let l=B(r,e);l&&(l.consume(),g("use-close")&&s.close())}),a.find("[data-action=item-chat]").on("click",async r=>{let l=B(r,e);l&&(l.toMessage(r,{create:!0}),g("chat-close")&&s.close())}),a.on("dragstart",r=>{let l=r.target.closest(".item"),{itemType:o,uuid:n}=l.dataset,c=new Image;c.src=l.querySelector(".item-img img").src,c.style.width="32px",c.style.height="32px",c.style.borderRadius="4px",c.style.position="absolute",c.style.left="-1000px",document.body.append(c),r.originalEvent.dataTransfer.setDragImage(c,16,16),r.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:o,uuid:n})),l.addEventListener("dragend",()=>c.remove(),{once:!0})}),t.find(".quantity input").on("change",async r=>{await B(r,e)?.update({"system.quantity":r.currentTarget.valueAsNumber})}),t.find("[data-action=toggle-item-invest]").on("click",r=>{r.preventDefault();let{itemId:l}=r.currentTarget.closest(".item").dataset;e.toggleInvested(l)}),t.find("[data-action=repair-item]").on("click",r=>{r.preventDefault();let l=B(r,e);l&&game.pf2e.actions.repair({item:l,actors:[e],tokens:[i]})}),t.find("[data-action=toggle-identified]").on("click",r=>{r.preventDefault();let l=B(r,e);l&&(l.isIdentified?l.setIdentificationStatus("unidentified"):new he(l).render(!0))}),t.find("[data-action=edit-item]").on("click",r=>{r.preventDefault(),wt(r,e)}),t.find("[data-action=delete-item]").on("click",r=>{r.preventDefault(),vt(r,e)}),t.find("[data-action=toggle-item-worn").on("click",async r=>{let l=B(r,e);if(!l)return;let o=document.createElement("div");o.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:l});let n=o.children[1].firstElementChild;if(n.querySelectorAll("[data-carry-type]").forEach(c=>{c.addEventListener("click",async d=>{let p=d.currentTarget,f=l.system.equipped,k=p.dataset.inSlot==="true",m=Number(p.dataset.handsHeld)||0,w=p.dataset.carryType;ye(p),(w!==f.carryType||k!==f.inSlot||w==="held"&&m!==f.handsHeld)&&e.adjustCarryType(l,{carryType:w,handsHeld:m,inSlot:k})})}),l.type!=="backpack"){let c=e.itemTypes.backpack.filter(d=>d.isIdentified);if(c.length){let d="";for(let p of c)d+='<li><a class="item-control item-location-option',p===l.container&&(d+=" selected"),d+=`" data-action="send-to-container" data-container-id="${p.id}">`,d+=`<i class="fas fa-box"></i>${p.name}</a></li>`;n.insertAdjacentHTML("beforeend",d),n.querySelectorAll("[data-action=send-to-container]").forEach(p=>{p.addEventListener("click",f=>{let k=f.currentTarget,m=k.dataset.containerId;e.items.has(m)&&(ye(k),l.update({"system.containerId":m}))})})}}ke({target:r.currentTarget,content:n,locked:!0,direction:"UP",selected:!0})}))}u(qt,"addItemsListeners");async function Wt({actor:t,filter:e}){let i=t.system.resources.focus??{value:0,max:0},s=t.spellcasting.regular,a=g("tradition"),r=game.modules.get("pf2e-staves")?.active,l=game.modules.get("pf2e-dailies"),o=l?.active,n=r||o&&isNewerVersion(l.version,"2.14.0"),c=r?"flags.pf2e-staves.charges":o?"flags.pf2e-dailies.staff.charges":"",d=[],p=[],f=!1;if(await Promise.all(s.map(async w=>{let v=w.id,b=a&&w.statistic.label[0],h=await w.getSheetData(),E=h.isFocusPool,A=w.system?.prepared?.value==="charge",R=(()=>{if(!A)return;let D=o&&l.api.getSpellcastingEntryStaffData(w),{charges:_,max:W,canPayCost:N}=D??getProperty(w,"flags.pf2e-staves.charges")??{charges:0,max:0};return{value:_,max:W,noMax:!0,canPayCost:N??(()=>!0)}})();for(let D of h.levels){if(!D.active.length||D.uses?.max===0)continue;let _=[],W=D.isCantrip;for(let N=0;N<D.active.length;N++){let U=D.active[N];if(!U||U.uses?.max===0)continue;let{spell:K,expended:P,virtual:G,uses:ce,castLevel:Ie}=U;H(K.name,e)&&_.push({name:K.name,img:K.img,tradition:b,castLevel:Ie??K.level,slotId:N,entryId:v,itemId:K.id,inputId:h.isInnate?K.id:h.id,inputPath:A?c:h.isInnate?"system.location.uses.value":`system.slots.slot${D.level}.value`,isCharge:A,isActiveCharge:A&&n,isVirtual:G,isInnate:h.isInnate,isCantrip:W,isFocus:E,isPrepared:h.isPrepared,isSpontaneous:h.isSpontaneous||h.isFlexible,slotLevel:D.level,uses:ce??(A?R:D.uses),expended:A?!R.canPayCost(D.level):P??(E&&!W?i.value<=0:!1),action:K.system.time.value,type:A?`${x}.spells.staff`:h.isInnate?"PF2E.PreparationTypeInnate":h.isSpontaneous?"PF2E.PreparationTypeSpontaneous":h.isFlexible?"PF2E.SpellFlexibleLabel":E?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:A?0:h.isPrepared?1:E?2:h.isInnate?3:h.isSpontaneous?4:5})}if(_.length){if(E)if(W)f=!0;else{p.push(..._);continue}d[D.level]??=[],d[D.level].push(..._)}}})),d.length){let w=g("spells-sort"),v=w==="type"?(b,h)=>b.order===h.order?M(b.name,h.name):b.order-h.order:w==="entry"?(b,h)=>{let E=M(b.entryId,h.entryId);return E!==0?E:M(b.name,h.name)}:(b,h)=>M(b.name,h.name);d.forEach(b=>b.sort(v))}p.length&&(p.sort((w,v)=>M(w.name,v.name)),d[12]=p,f=!1);let m=(await t.spellcasting.ritual?.getSheetData())?.levels.flatMap((w,v)=>w.active.map(({spell:b})=>{if(H(b.name,e))return{name:b.name,img:b.img,slotId:v,itemId:b.id,level:b.level,time:b.system.time.value}}).filter(Boolean));if(d.length||m?.length){let w=Kt(t),v=d.length+ +((m?.length??0)>0);return{contentData:{spells:d,rituals:m,focusPool:i,hasFocusCantrips:f,attackMod:Vt(w)?w[0].mod:null,entryRank:b=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:mt(b)})},doubled:v>1&&g("spells-columns")}}}u(Wt,"getSpellsData");function Kt(t){return t.spellcasting.filter(e=>e.statistic).map(({statistic:e,name:i,id:s})=>({name:i,id:s,mod:q(e.mod),statistic:e}))}u(Kt,"getSpellAttacks");function Vt(t){return new Set(t.map(({mod:e})=>e)).size===1}u(Vt,"hasSingleSpellAttack");function Yt({el:t,actor:e,hud:i}){V(t.find(".spell")),t.find("[data-action=spell-description]").on("click",async s=>{s.preventDefault();let a=$(s.currentTarget).closest(".spell");j(a,e)}),e.isOwner&&(t.find("[data-action=spell-attack]").on("click",async s=>{s.preventDefault();let a=Kt(e);if(!a.length)return;let r;if(Vt(a))r=a[0].statistic;else{let n=await Dialog.wait({buttons:{ok:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:S("spells.attacks.ok"),callback:c=>c.find("input:checked").val()}},title:S("spells.attacks.title"),content:await renderTemplate(F("dialogs/spell-attacks"),{attacks:a}),close:()=>null});n&&(r=e.items.get(n)?.statistic)}let l=Ae(s,{type:"check"}),{map:o}=s.currentTarget.dataset;o&&(l.modifiers=[new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:Number(o)})]),r?.check.roll(l)}),t.find("[data-action=spell-chat]").on("click",async s=>{s.preventDefault();let a=B(s,e);a&&(a.toMessage(s),g("chat-close")&&i.close())}),t.find("[data-action=toggle-pips]").on("click contextmenu",async s=>{s.preventDefault();let a=s.type==="click"?1:-1,r=(e.system.resources.focus?.value??0)+a;await e.update({"system.resources.focus.value":r})}),t.find("[data-action=toggle-prepared]").on("click",s=>{s.preventDefault();let{slotLevel:a,slotId:r,entryId:l,expended:o}=$(s.currentTarget).closest(".spell").data();e.spellcasting.collections.get(l)?.setSlotExpendedState(a??0,r??0,o!==!0)}),t.find("[data-action=cast-spell]").on("click",s=>{s.preventDefault();let{slotLevel:a,slotId:r,entryId:l,itemId:o}=$(s.currentTarget).closest(".spell").data(),n=e.spellcasting.collections.get(l,{strict:!0});if(!n)return;let c=n.get(o,{strict:!0});c&&(n.entry.cast(c,{slot:r,level:a}),g("cast-close")&&i.close())}),t.find("[data-input-path]").on("change",async s=>{let{inputPath:a,entryId:r}=$(s.currentTarget).data(),l=s.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:r,[a]:l}])}))}u(Yt,"addSpellsListeners");var Ws=["#combat-popout","#sidebar","#mini-tracker","#combat-dock","#combat-carousel","[id^=pf2e-perception]"].join(", "),Jt={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},be={opposition:{icon:"fa-solid fa-face-angry-horns",label:"PF2E.Actor.Creature.Alliance.Opposition"},party:{icon:"fa-solid fa-face-smile-halo",label:"PF2E.Actor.Creature.Alliance.Party"},neutral:{icon:"fa-solid fa-face-meh",label:"PF2E.Actor.Creature.Alliance.Neutral"}},Ks=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],Vs={actions:{getData:Rt,addListeners:Ut},items:{getData:Gt,addListeners:qt},spells:{getData:Wt,addListeners:Yt},skills:{getData:Ft,addListeners:Pt},extras:{getData:Nt,addListeners:$t},hazard:{getData:Bt,addListeners:zt}},we={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},Ys={perception:{icon:"fa-solid fa-eye",label:"PF2E.PerceptionLabel"},stealth:{icon:"fa-duotone fa-eye-slash",label:"PF2E.SkillStealth"},athletics:{icon:"fa-solid fa-hand-fist",label:"PF2E.SkillAthletics"}},ve=class extends Application{#e=null;#d=null;#s=null;#a=null;#c=!1;#o=null;#u=[!1,!1,!1];#t=!1;#i=!1;#n=!1;#p;#r;#f;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#p=(e,i)=>{i?this.#y(e):this.#k(e)},this.#r=e=>{let i=e.button;if(![0,2].includes(i))return;if(e.type==="mouseup"){this.#u[i]=!1;return}this.#u[i]=!0;let s=e.target,a=this.element[0];if(a){let r=a.querySelector(".popup");if(r&&!r.contains(s))if(!a.querySelector(".sidebar"))this.forceClose();else return r.remove();s.closest("canvas")&&this.forceClose();return}else this.#g();this.unlock(!0)},this.#f=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#r),window.addEventListener("mouseup",this.#r),Hooks.on("hoverToken",this.#p),Hooks.on("deleteToken",this.#f),Hooks.on("canvasPan",this.forceClose)}setToken(e,i){if(e!==this.#e){delete this.#e?.actor?.apps[this.appId],this.#e=e;let s=e?.actor;s&&(s.apps[this.appId]=this)}this.#n=i??this.#m(e)}setHolding(e){let i=g("key-holding");if(i!=="none"&&(this.#c=e,!(this.#i||this.#t)))if(e){if(!this.#s)return;let s=this.#m(this.#s);if(i==="half"&&!game.user.isGM&&!s){this.#g(),this.render();return}this.setToken(this.#s,s),this.render()}else i==="all"?this.close():game.user.isGM?(this.setToken(this.#s),this.render()):this.#n&&this.close()}#m(e){let i=e?.actor;if(!i)return!1;let s,a=i.system.details.alliance==="party";return game.user.isGM&&g("key-holding")==="half"&&!this.#c||i.isOfType("familiar")&&!i.master?s=!1:s=e.isOwner||g("observer")&&(e.observer||a&&g("party")),s}#y(e){if($(window.document).find(":hover").filter(Ws).length)return;let i=e.actor;if(!i||i.isOfType("loot","party")||e.document.disposition===CONST.TOKEN_DISPOSITIONS.SECRET&&!i.isOwner||i.isOfType("npc")&&g("no-dead")&&i.isDead||(this.#s=e,e!==this.#d&&!this.#t&&this.close(),this.mousedown||this.#t||this.#i||e===this.#e))return;let s=g("key-holding"),a=this.#m(e);s!=="none"&&!this.#c&&(s==="all"||a)||(this.#b(!0),this.setToken(e,a),s==="none"||!this.#c?this.renderWithDelay():this.render())}#k(e){this.#s=null,!(this.mousedown||this.#t||this.#i)&&(this.#o=setTimeout(()=>{this.#o=null,!(this.#i||this.#t)&&this.close()},10))}renderWithDelay(){let e=g("delay");e?(e<10&&(e=10),this.#a=setTimeout(()=>{this.#a=null,this.render()},e)):this.render()}#b(e){this.#o!==null&&(clearTimeout(this.#o),this.#o=null,e&&this.close())}#g(){this.#a!==null&&(clearTimeout(this.#a),this.#a=null)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#r),window.removeEventListener("mouseup",this.#r),Hooks.off("hoverToken",this.#p),Hooks.off("deleteToken",this.#f),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,minimizable:!1,template:F("hud")})}get mousedown(){return this.#u[0]||this.#u[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return!!Ke(this.actor)}get sidebar(){return this.element?.find("> .sidebar")??[]}get popup(){return this.element?.find("> .popup")??[]}get inner(){return this.element?.find("> .inner")??[]}async getData(){let e=this.#e,i=this.#e?.actor;if(!i)return{};let s=null,a=g("saves"),r=g("others"),l=i.isOfType("character"),{attributes:o}=i,{hp:n,ac:c}=o,d=n.sp??{max:0,value:0},p=game.settings.get("pf2e","staminaVariant"),f=g("distance"),k=g("scale");if(f==="all"||f==="self"&&this.#n){let I=g("unit").split(","),L=Number(I[0]?.trim())||1,O=I[1]?.trim()||game.system.gridUnits,T=Number(I[2]?.trim())||0,z=canvas.tokens.controlled,Z=!1,ee=z.length===1?z[0]:null;(!ee||ee===e)&&(ee=$e(),Z=!0),ee&&ee!==e&&(s={unit:O,icon:Z?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(ee)*L).toFixed(T)})}let m;if(!this.#n||g("see-status")){let I=g("status").split(",").map(L=>L.trim()).filter(Boolean);if(I.length&&n.max){let L=n.max+(p?d.max:0),O=n.value+(p?d.value:0),T=Math.clamped(O/L,0,1),z=(()=>{let Z=I.length;return g("last-status")?T===1?Z:Math.ceil(T*(Z-1)):Math.ceil(T*Z)})();m={hue:T*T*122+3,value:z===0?game.i18n.localize("EFFECT.StatusDead"):I.at(z-1)}}}let w={status:m,distance:s,fontSize:k,tokenId:e.id,type:i.isOfType("creature")?"creature":i.type};if(!this.#n||i.isOfType("familiar")&&!i.master)return w;let{level:v,saves:b,isOwner:h,system:E,itemTypes:A}=i,{resistances:R,weaknesses:D,immunities:_}=o;if(w={...w,isOwner:h,isObserver:this.#n,name:e.document.name,hp:n,level:v},i.isOfType("army")){let I="Vqp8b64uH35zkncy",O=(await game.packs.get("pf2e.kingmaker-features")?.getDocuments({type:"campaignFeature"})??[]).filter(T=>T instanceof Item&&T.isOfType("campaignFeature"));return w={...w,basicWarActions:O.filter(T=>T.system.category==="army-war-action"&&T.folder?.id===I).map(T=>new CONFIG.Item.documentClass(T.toObject(!0),{parent:this.actor})).filter(T=>T.isOfType("campaignFeature"))},w}w={...w,ac:c.value,hasActions:A.action.length||E.actions?.filter(I=>I.visible!==!1).length};let W=g("ranks");function N(I,L,O){let T=I.slug,z=L==="bonus"?q(I.mod):I.dc.value;return{slug:T,value:z,label:O[T].label,icon:O[T].icon,rank:W&&Fe[I.rank]}}u(N,"getStatistic");function U(I,L){if(!I.length)return"";let O=I.map(T=>Ge(T.label.replace("-"," ").titleCase())).join("");return L?`<li>${game.i18n.localize(L)}<ul>`+O+"</ul></li>":O}if(u(U,"toIWR"),i.isOfType("hazard")){let{hardness:I,emitsSound:L,stealth:O}=o;return{...w,hardness:I,emitsSound:L.toString().capitalize(),immunities:U(_),weaknesses:U(D),resistances:U(R),stealth:{value:O.value,details:await te(O.details,i)},saves:a!=="none"&&["fortitude","reflex","will"].map(T=>{let z=b[T];return z?N(z,a,we):{slug:T,label:we[T].label,icon:we[T].icon}})}}if(w={...w,sidebarTitles:{actions:`${x}.actions.title`,items:`${x}.items.title`,spells:`${x}.spells.title`,skills:`${x}.skills.title`,extras:`${x}.extras.title`},hasItems:i.inventory.size},i.isOfType("vehicle")){let{hardness:I,collisionDC:L,collisionDamage:O}=o,{details:T}=E,{crew:z,passengers:Z,pilotingCheck:ee,speed:us}=T;return{...w,hardness:I,crew:z,passengers:Z,pilotingCheck:ee,speed:us,collisionDC:L.value,collisionDamage:O.value,immunities:U(_),weaknesses:U(D),resistances:U(R),fortitude:N(b.fortitude,a,we)}}let K=g("show-death"),{heroPoints:P}=i,{traits:G,resources:ce}=E,{wounded:Ie,dying:st,shield:ns,speed:Ce,adjustment:as}=o;function Ge(I){return`<li>${I.trim()}</li>`}u(Ge,"toInfo");function os(I,L){return M(I,L)}u(os,"sort");let rs=G?.languages?.value.map(I=>game.i18n.localize(CONFIG.PF2E.languages[I])).filter(Boolean).sort(os).map(Ge).join(""),ls=l?G.senses.map(I=>I.label):G.senses.value?.split(","),ue=Ks.map(({type:I,icon:L},O)=>({index:O,icon:L,label:game.i18n.localize(CONFIG.PF2E.speedTypes[I]??"PF2E.SpeedTypesLand"),value:(O===0?Ce.total:Ce.otherSpeeds.find(T=>T.type===I)?.total)||0})),it=Q(i,`speeds.selected.${game.user.id}`),cs=(()=>{let I=0;if(it!==void 0)I=it;else if(g("force-speed")||ue[0].value===0){let L={index:0,value:ue[0].value};I=ue.reduce((O,{value:T},z)=>T>O.value?{index:z,value:T}:O,L).index}return ue.splice(I,1)[0]})(),nt=ue.map(({value:I,label:L,index:O})=>`<li><a data-value="${O}">${L}: ${I}</a></li>`).join("");return Ce.details&&(nt+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${Ce.details}</li>`),{...w,sp:p?d:{max:0},hero:P,dying:st,wounded:Ie,shield:ns,resolve:ce.resolve,adjustment:as,alliance:be[Xt(i).alliance],isCharacter:l,showDeathLine:l&&(K==="always"||st.value||Ie.value),digitalPips:g("pips"),hasCover:this.hasCover,saves:a!=="none"&&["fortitude","reflex","will"].map(I=>N(b[I],a,we)),others:r!=="none"&&["perception","stealth","athletics"].map(I=>N(i.getStatistic(I),r,Ys)),speeds:{main:cs,others:nt},iwr:U(_,"PF2E.ImmunitiesLabel")+U(D,"PF2E.WeaknessesLabel")+U(R,"PF2E.ResistancesLabel"),senses:ls?.filter(Boolean).map(Ge).join(""),languages:rs,hasSpells:i.spellcasting.some(I=>I.category!=="items"),hasNotes:!l&&(E.details.publicNotes||E.details.privateNotes&&h)}}close(e={}){this.setToken(null),this.unlock(!0),this.#i=!1,this.#g();let i=Application.RENDER_STATES;if(!e.force&&![i.RENDERED,i.ERROR].includes(this._state))return;this._state=i.CLOSING;let s=this.element;if(!s)return this._state=i.CLOSED;s.css({minHeight:0});for(let a of this.constructor._getInheritanceChain())Hooks.call(`close${a.name}`,this,s);s.remove(),this._element=null,this._state=i.CLOSED,delete ui.windows[this.appId]}async _render(e=!1,i={}){let s,a,r,l,o;if(this.#d===this.#e){let n=this.sidebar[0];if(n){s=n.dataset.type,a=n.scrollTop;let c=n.querySelector(".sidebar-header");c.classList.contains("show")&&(o=c.querySelector(" input").value.trim())}r=this.popup[0],r&&(l=r.scrollTop)}if(await super._render(e,i),ui.windows[this.appId]=this,s){let n=await this.#l(s,o);a>0&&n.scrollTop(a)}r&&(this.element.append(r),l>0&&(r.scrollTop=l)),this.#d=this.#e,this.inner.length&&g("autolock")==="render"&&this.lock()}render(){this.actor&&super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let i=this.element[0],s=e.worldTransform.a,a=i.getBoundingClientRect(),r=canvas.clientCoordinatesFromCanvas(e.document._source),l={x:r.x,y:r.y,width:e.hitArea.width*s,height:e.hitArea.height*s,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},o,n=this.#n?Jt[g("position")].slice():Jt[g("small-position")].slice();for(;n.length&&!o;){let c=n.shift();c==="left"?(o={x:l.x-a.width,y:tt(a,l)},o.x<0&&(o=void 0)):c==="right"?(o={x:l.right,y:tt(a,l)},o.x+a.width>window.innerWidth&&(o=void 0)):c==="top"?(o={x:Qt(a,l),y:l.y-a.height},o.y<0&&(o=void 0)):c==="bottom"&&(o={x:Qt(a,l),y:l.bottom},o.y+a.height>window.innerHeight&&(o=void 0))}return o&&(i.style.left=`${o.x}px`,i.style.top=`${o.y}px`),o}lock(){this.#t=!0}unlock(e){!e&&(this.sidebar.length||g("autolock")!=="none")||(this.#t=!1)}activateListeners(e){let i=this.#e,s=i?.actor;if(!s)return;let a=i.isOwner,r=J();g("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.find("[data-action=show-notes").on("click",async n=>{n.preventDefault();let{publicNotes:c,privateNotes:d,blurb:p}=s.system.details,f=s.system.traits.value.map(m=>({label:game.i18n.localize(CONFIG.PF2E.creatureTraits[m])??m,description:game.i18n.localize(CONFIG.PF2E.traitsDescriptions[m])??""})),k=await renderTemplate(F("show-notes"),{traits:f,blurb:p.trim(),publicNotes:c.trim(),privateNotes:a&&d.trim()});ie(`${s.name} - ${game.i18n.localize("PF2E.NPC.NotesTab")}`,k,s)}),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(g("autolock")==="hover"&&this.lock(),this.#i=!0)}),e.on("mouseleave",()=>{this.#i=!1,!(this.#t||this.#s)&&this.close()}),e.on("dragover",()=>{i.isOwner&&e.find("> .sidebar.extras").length&&!e.find("> .popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let l=e.find("[data-action=show-info]");(a?l.filter(":not(.speeds)"):l).on("click",n=>{let c=n.currentTarget,d=c.dataset.tooltipContent;c.classList.contains("stealth")?this.#h({content:d,event:n,direction:"DOWN"}):ke({target:c,content:d,direction:"UP"})}),e.find("[data-action=open-sidebar]").on("click",this.#l.bind(this)),a&&(e.find("[data-action=toggle-adjustment]").on("click contextmenu",n=>{n.preventDefault();let c=n.type==="click"?"elite":"weak";s.applyAdjustment(s.system.attributes.adjustment===c?null:c)}),e.find("[data-action=toggle-alliance]").on("click",n=>{let{originalAlliance:c,defaultAlliance:d}=Xt(s),p=[{value:"default",label:game.i18n.format("PF2E.Actor.Creature.Alliance.Default",{alliance:game.i18n.localize(be[d].label)})},{value:"opposition",label:game.i18n.localize(be.opposition.label)},{value:"party",label:game.i18n.localize(be.party.label)},{value:"neutral",label:game.i18n.localize(be.neutral.label)}];this.#h({content:p,event:n,selected:c,onClick:f=>{f==="default"?s.update({"system.details.-=alliance":null}):s.update({"system.details.alliance":f==="neutral"?null:f})}})}),e.find("[data-action=collision-dc]").on("click",n=>{n.preventDefault();let c=s.system.attributes.collisionDC.value||15;r.create({content:`@Check[type:reflex|dc:${c}]`,speaker:r.getSpeaker({actor:s})})}),e.find("[data-action=collision-damage]").on("click",async n=>{n.preventDefault();let c=(s.system.attributes.collisionDamage.value||"1d6").trim();isNaN(Number(c.at(-1)))||(c+="[bludgeoning]");let d=ot(),p=await new d(c).evaluate({async:!0});r.create({flavor:`<strong>${game.i18n.localize("PF2E.vehicle.collisionDamageLabel")}</strong>`,speaker:r.getSpeaker({actor:s}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:"sounds/dice.wav",rolls:[p]})}),e.find("input").on("change",async n=>{let c=n.currentTarget,d=c.valueAsNumber,p=c.name;c.blur(),p!=="shield.value"?await s.update({[p]:d}):await s.heldShield.update({"system.hp.value":d})}),e.find("[data-action=toggle-hero]").on("click contextmenu",n=>{n.preventDefault();let{max:c,value:d}=s.heroPoints,p=n.type==="click"?1:-1,f=Math.clamped(d+p,0,c);f!==d&&s.update({"system.resources.heroPoints.value":f})}),e.find("[data-action=raise-shield]").on("click",n=>{n.preventDefault(),game.pf2e.actions.raiseAShield({actors:[s],tokens:[i]})}),e.find("[data-action=take-cover]").on("click",async n=>{n.preventDefault();let c=Ke(s);c?c.delete():game.pf2e.actions.get("take-cover").use({actors:[s],tokens:[i]})}),e.find("[data-action=roll-save]").on("click",n=>{n.preventDefault();let c=n.currentTarget.dataset.save;s.saves[c].roll({event:n})}),e.find("[data-action=roll-other]").on("click",n=>{n.preventDefault();let c=n.currentTarget.dataset.slug;if(c!=="athletics"){let{ctrlKey:d,metaKey:p,shiftKey:f}=n;n=new MouseEvent("click",{ctrlKey:!d,metaKey:p,shiftKey:f})}s.getStatistic(c)?.roll({event:n})}),e.find("[data-action=recovery-check]").on("click",n=>{n.preventDefault(),s.rollRecovery(n)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",n=>{n.preventDefault();let c=n.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",d=s.system.attributes[c]?.max;d&&(n.type==="click"?s.increaseCondition(c,{max:d}):s.decreaseCondition(c))}),e.find("[data-action=use-resolve]").on("click",n=>{n.preventDefault(),at(s)}),l.filter(".speeds").on("click",n=>{this.#h({event:n,content:n.currentTarget.dataset.tooltipContent,direction:"UP",onClick:c=>{se(s,`speeds.selected.${game.user.id}`,Number(c))}})}))}#h({content:e,event:i,onClick:s,selected:a,direction:r,locked:l}){ke({content:e,target:i.currentTarget,direction:r,selected:a,locked:!0,onCreate:()=>this.lock(),onClick:s,onDismiss:()=>this.unlock()})}async showFilter(){let e=this.sidebar;e.length&&(e.find(".sidebar-header").hasClass("show")||(e=await this.#l(e.data().type,"")),e.find(".sidebar-header").find("input").focus().select(),e.scrollTop(0))}async#l(e,i){e=typeof e=="string"?e:e.currentTarget.dataset.type;let s=this.element,a=this.sidebar,r=a[0]?.dataset.type;if(a.remove(),s.find("[data-action=open-sidebar]").removeClass("active"),r===e&&i===void 0){this.unlock();return}let l=this.#e,o=l.actor,n=i!==void 0||g("filter"),{getData:c,addListeners:d}=Vs[e],p=await c({hud:this,actor:o,token:l,filter:i?.toLowerCase()})??{};if(!p.contentData&&!n)return ui.notifications.warn(S(`${e}.empty`,{name:this.#e.name}));let f={...p.contentData??{},isGM:game.user.isGM,isCharacter:o.isOfType("character"),isOwner:o.isOwner,isCreature:o.isOfType("creature")};this.lock(),s.find(`[data-action=open-sidebar][data-type=${e}]`).addClass("active"),s=s[0];let k=p.classes??[];k.push(e),g("scrollbar")||k.push("no-scrollbar"),p.doubled&&k.push("doubled");let m=p.style??{};m["--max-height"]=g("height").trim()||"100%";let w=document.createElement("div");w.innerHTML=await renderTemplate(F("sidebar"),{classes:k.join(" "),style:Object.entries(m).map(([D,_])=>`${D}: ${_}`).join("; "),type:e,filter:i,filterLabel:S("filter"),showFilter:n,content:(await renderTemplate(F(`sidebars/${e}`),f)).trim()}),a=w.firstElementChild,s.append(a);let v=a.getBoundingClientRect(),b=s.getBoundingClientRect(),h;g("position")==="left"?(h=b.x-v.width,h<0&&(h=b.right)):(h=b.right,h+v.width>window.innerWidth&&(h=b.x-v.width));let A=parseInt(window.getComputedStyle(s).padding),R=tt(v,b,A);return a.style.left=`${h}px`,a.style.top=`${R}px`,a=$(a),a.find(".sidebar-header [data-action=sidebar-filter-clear]").on("click",D=>{D.preventDefault(),a.find(".sidebar-header [data-action=sidebar-filter]").val(""),this.#l(e,"")}),a.find(".sidebar-header [data-action=sidebar-filter]").on("keydown",D=>{D.key==="Enter"&&this.#l(e,D.currentTarget.value.trim())}),d({el:a,actor:o,token:l,hud:this}),Hooks.callAll("renderHUDSidebar",e,a,this),a}};u(ve,"HUD");function tt(t,e,i=0){let s=e.y+e.height/2-t.height/2;return s+t.height>window.innerHeight&&(s=window.innerHeight-t.height-i),s<0&&(s=i),s}u(tt,"postionFromTargetY");function Qt(t,e){let i=e.x+e.width/2-t.width/2;return i+t.width>window.innerWidth&&(y=window.innerWidth-t.width),i<0&&(i=0),i}u(Qt,"postionFromTargetX");function Xt(t){let e=t._source.system.details?.alliance,i=e===null?"neutral":e??"default",s=t.hasPlayerOwner?"party":"opposition";return{defaultAlliance:s,originalAlliance:i,alliance:i==="default"?s:i}}u(Xt,"getAlliance");var x="pf2e-token-hud",ae=null;function X(t=!1){return t?ae?.element:ae}u(X,"getHud");function ze(t){t&&!ae?ae=new ve:!t&&ae&&(ae.delete(),ae=null)}u(ze,"enableModule");function g(t){return game.settings.get(x,t)}u(g,"getSetting");function S(...t){let e=t.at(-1),i=typeof e=="object",s=i?t.slice(0,-1):t;return s.unshift(x),game.i18n[i?"format":"localize"](s.join("."),e)}u(S,"localize");function Je(t,e){return t.itemTypes.feat.some(i=>i.sourceId===e)}u(Je,"hasFeat");function F(t){return`modules/${x}/templates/${t}.hbs`}u(F,"templatePath");function q(t){return t>=0?`+${t}`:t}u(q,"modifier");function Q(t,e){return t.getFlag(x,e)}u(Q,"getFlag");function se(t,e,i){return t.setFlag(x,e,i)}u(se,"setFlag");async function te(t,e,{isOwner:i=e.isOwner,rollData:s=e.getRollData()}={}){return t=t?.trim(),t?await TextEditor.enrichHTML(t,{async:!0,secrets:i,rollData:s}):""}u(te,"enrichHTML");function me(t,e){if(typeof t!="object")return!1;for(;t=Reflect.getPrototypeOf(t);)if(t.constructor.name===e)return!0;return!1}u(me,"isInstanceOf");function ts(){es("hold",{onDown:()=>{g("key-holding")!=="none"&&X()?.setHolding(!0)},onUp:()=>{X()?.setHolding(!1)}}),es("filter",{onUp:()=>{X()?.showFilter()},editable:[{key:"KeyQ",modifiers:["Control"]}]})}u(ts,"registerKeybindings");function Zt(t,e){return`${x}.keybinds.${t}.${e}`}u(Zt,"path");function es(t,e={}){game.keybindings.register(x,t,{name:Zt(t,"name"),hint:Zt(t,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}u(es,"register");function ss(){let t=game.data.users.find(i=>i._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(i=>S(`settings.status.statuses.${i}`)).join(", ");C("status",String,e,{scope:"world"}),C("last-status",Boolean,!1,{scope:"world"}),C("party",Boolean,!1,{scope:"world"}),C("rk-dice",Boolean,!1,{scope:"world"}),C("enabled",Boolean,!0,{onChange:ze}),C("position",String,"right",{choices:["left","right","top","bottom"]}),C("small-position",String,"top",{choices:["left","right","top","bottom"]}),C("delay",Number,250,{range:{min:0,max:2e3,step:50}}),C("scale",Number,14,{range:{min:10,max:30,step:1}}),C("key-holding",String,"none",{hint:oe("key-holding",t?"choices.gm.hint":"choices.player.hint"),choices:{none:oe("key-holding","choices.none"),half:oe("key-holding",t?"choices.gm.half":"choices.player.half"),all:oe("key-holding",t?"choices.gm.all":"choices.player.all")}}),C("autolock",String,"none",{choices:["none","hover","render"]}),C("chat-close",Boolean,!1),C("attack-close",Boolean,!1),C("action-close",Boolean,!1),C("cast-close",Boolean,!1),C("skill-close",Boolean,!1),C("macro-close",Boolean,!1),C("use-close",Boolean,!1),C("no-dead",Boolean,!1),C("observer",Boolean,!0),C("see-status",Boolean,!1),C("saves",String,"bonus",{choices:["none","bonus","dc"]}),C("others",String,"none",{choices:["none","bonus","dc"]}),C("ranks",Boolean,!1),C("show-death",String,"always",{choices:["none","always","only"]}),C("force-speed",Boolean,!1),C("tooltips",Boolean,!1),C("pips",Boolean,!1),C("distance",String,"all",{choices:["none","self","all"]}),C("unit",String,""),C("height",String,""),C("filter",Boolean,!1),C("scrollbar",Boolean,!0),C("hazard-width",Number,32,{range:{min:14,max:50,step:1}}),C("actions-columns",Boolean,!1),C("items-columns",Boolean,!1),C("spells-columns",Boolean,!1),C("skills-columns",Boolean,!1),C("actions",String,"split",{choices:["name","type","split"]}),C("actions-colors",Boolean,!0),C("action-effect",Boolean,!1),C("containers",Boolean,!1),C("spells-sort",String,"disabled",{choices:["disabled","type","entry"]}),C("tradition",Boolean,!1),C("untrained",Boolean,!0)}u(ss,"registerSettings");function is(t,e){let i=e.find(`.tab[data-tab=${x}]`);function s(a,r,l="h3"){let o=S(`menu.${r}`);i.find(`[name="${x}.${a}"]`).closest(".form-group").before(`<${l}>${o}</${l}>`)}u(s,"beforeGroup"),game.user.isGM&&s("enabled","client.header","h2"),s("saves","client.tooltip"),s("distance","client.distance"),s("height","client.sidebar"),s("actions","client.actions"),s("containers","client.items"),s("spells","client.spells"),s("untrained","client.skills")}u(is,"renderSettingsConfig");function oe(t,e){return`${x}.settings.${t}.${e}`}u(oe,"path");function C(t,e,i,s={}){Array.isArray(s.choices)&&(s.choices=s.choices.reduce((a,r)=>(a[r]=oe(t,`choices.${r}`),a),{})),game.settings.register(x,t,{name:oe(t,"name"),hint:oe(t,"hint"),scope:"client",config:!0,type:e,default:i,...s})}u(C,"register");Hooks.once("setup",async()=>{ss(),ts(),await loadTemplates({creature:F("tooltips/creature"),hazard:F("tooltips/hazard"),vehicle:F("tooltips/vehicle"),army:F("tooltips/army")})});Hooks.once("ready",()=>{g("enabled")&&ze(!0),game.modules.get("pf2e-token-hud").api={getHud:X}});Hooks.on("renderSettingsConfig",is);Hooks.on("drawMeasuredTemplate",t=>{t.isPreview&&X()?.close()});Hooks.on("getActorDirectoryEntryContext",(t,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${x}.actor.macros.contextmenu`,condition:i=>{let{documentId:s}=i.data();return g("enabled")&&game.actors.get(s)?.isOwner},callback:i=>{let{documentId:s}=i.data();Js(s)}})});var je=class extends Dialog{async getData(e={}){let i=super.getData(e);return typeof i.content=="function"&&(i.content=await i.content()),i}};u(je,"DataDialog");function Js(t){let e=game.actors.get(t);if(!e)return;let i=new je({title:`${e.name} - ${S("actor.macros.title")}`,content:async()=>{let s=Pe(e)??[];return renderTemplate(F("dialogs/macros"),{macros:s,noMacro:S("extras.no-macro")})},buttons:{},render:s=>{e.apps[i.appId]=i,s.on("drop",a=>Me(a,e)),s.find("[data-action=delete-macro]").on("click",a=>Ne(a,e))},close:()=>{delete e.apps[i.appId]}},{height:"auto"}).render(!0)}u(Js,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
