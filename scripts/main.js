(()=>{var li=Object.defineProperty;var u=(t,e)=>li(t,"name",{value:e,configurable:!0});var di="Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo";async function nt(t){function e(d){ChatMessage.create({user:game.user.id,content:d,speaker:ChatMessage.getSpeaker({actor:t})})}u(e,"toChat");let{name:s,attributes:i,system:c}=t,r=i.hp.sp,o=c.resources.resolve,a=C("hud.resolve.full",{name:s}),n=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:s});if(r.value===r.max)return ui.notifications.warn(a);if(o.value<1)return ui.notifications.warn(n);let l=t.itemTypes.feat.find(d=>d.sourceId===di),f=await renderTemplate(F("dialogs/resolve"),{hasSteel:l,i18n:d=>C(`hud.resolve.${d}`)});new Dialog({title:C("hud.resolve.title"),content:f,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:C("hud.resolve.yes"),callback:async d=>{let{attributes:p,system:k}=t,m=p.hp.sp,g=k.resources.resolve;if(m.value===m.max)return e(a);if(g.value<1)return e(n);let I=d.find("input:checked").val(),b=`${m.value}/${m.max}`;if(I==="breather")e(C("hud.resolve.breather.used",{name:s,ratio:b})),await t.update({"system.attributes.hp.sp.value":m.max,"system.resources.resolve.value":g.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:s,ratio:b}));let w=m.value+Math.floor(m.max/2);await t.update({"system.attributes.hp.sp.value":Math.min(w,m.max),"system.resources.resolve.value":g.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:C("hud.resolve.no")}}}).render(!0)}u(nt,"useResolve");function at(){return CONFIG.Dice.rolls.find(t=>t.name==="DamageRoll")}u(at,"getDamageRollClass");var pi=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),fi=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function mi(t,e="normal"){return t+(pi.get(e)??0)}u(mi,"adjustDC");function gi(t="common"){switch(t){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}u(gi,"rarityToDCAdjustment");function Te(t,e="common"){return mi(t,gi(e))}u(Te,"adjustDCByRarity");function Se(t,{pwol:e,rarity:s="common"}={}){e??=game.pf2e.settings.variants.pwol.enabled;let i=fi.get(t)??14;return Te(e?i-Math.max(t,0):i,s)}u(Se,"calculateDC");function pe(t,e){return t instanceof Element||t instanceof Document?Array.from(t.querySelectorAll(e)):[]}u(pe,"htmlQueryAll");function re(t,e){return t instanceof Element?t.closest(e):null}u(re,"htmlClosest");var ot={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"},hi={0:"F",free:"F",1:"A",2:"D",3:"T","1 or 2":"A/D","1 to 3":"A - T","2 or 3":"D/T",reaction:"R"};function rt(t,e="systems/pf2e/icons/actions/Empty.webp"){if(t===null)return ot.passive;let s=typeof t!="object"?t:t.type==="action"?t.value:t.type,i=String(s??"").toLowerCase().trim();return ot[i]??e}u(rt,"getActionIcon");function Ce(t){if(!t&&t!==0)return"";let e=typeof t!="object"?t:t.type==="action"?t.value:t.type,s=String(e??"").toLowerCase().trim();return hi[s]??""}u(Ce,"getActionGlyph");function Ee(t){return Error(`PF2e System | ${t}`)}u(Ee,"ErrorPF2e");function ct(t,e){return t.includes(e)}u(ct,"tupleHasValue");function ce(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}u(ce,"objectHasKey");function De(t,e){return game.pf2e.system.sluggify(t,e)}u(De,"sluggify");function lt(t,e){return t.has(e)}u(lt,"setHasElement");function ut(t,e){let s={name:t,label:game.i18n.localize(e[t]??t)};return ce(CONFIG.PF2E.traitsDescriptions,t)&&(s.description=CONFIG.PF2E.traitsDescriptions[t]),s}u(ut,"traitSlugToObject");function dt(t){let e=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),s=game.i18n.localize(`PF2E.OrdinalSuffixes.${e.select(t)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:t,suffix:s})}u(dt,"ordinalString");function pt(t){if(t==="cantrips")return 0;let e=Number(t??NaN);return e.between(0,10)?e:null}u(pt,"spellSlotGroupIdToNumber");function ft(t){if(t==="cantrips")return t;let e=Number(t)||NaN;return e.between(1,10)?e:null}u(ft,"coerceToSpellGroupId");function mt(t){return!!t&&"ctrlKey"in t&&"metaKey"in t&&"shiftKey"in t}u(mt,"isRelevantEvent");function xe(t,e){let s=e.type==="check"?"showCheckDialogs":"showDamageDialogs",i=!game.user.settings[s];if(!mt(t))return{skipDialog:i};let c={skipDialog:t.shiftKey?!i:i};return(t.ctrlKey||t.metaKey)&&(c.rollMode=game.user.isGM?"gmroll":"blindroll"),c}u(xe,"eventToRollParams");function Ae(t){return!mt(t)||!(t.ctrlKey||t.metaKey)?"roll":game.user.isGM?"gmroll":"blindroll"}u(Ae,"eventToRollMode");var yi=["fortitude","reflex","will"],ht=["action","check","effect-area"].map(t=>`[data-pf2-${t}]`).join(",");function ki(t,e){for(let s of t){(!e||e.isOwner)&&s.classList.add("with-repost");let i=pe(s,"i[data-pf2-repost]");if(i.length>0){if(e&&!e.isOwner){for(let o of i)o.remove();s.classList.remove("with-repost")}continue}if(e&&!e.isOwner)continue;let c=document.createElement("i"),r=s.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";c.classList.add("fa-solid",r),c.dataset.pf2Repost="",c.title=game.i18n.localize("PF2E.Repost"),s.appendChild(c),c.addEventListener("click",o=>{o.stopPropagation();let a=o.target;if(!(a instanceof HTMLElement))return;let n=a?.parentElement;if(!n)return;let l=yt(a,e);wi(n,l)})}}u(ki,"injectRepostElement");function bi(t,e=null){for(let s of pe(t,"a.inline-roll[data-damage-roll]")){let i=re(s,"[data-item-id]")?.dataset.itemId,c=e?.items.get(i??"");c&&(s.dataset.flavor||=c.name)}}u(bi,"flavorDamageRolls");function gt(t,e){let s=t.attributes.getNamedItem("data-pf2-repost-flavor")?.value??"";return`<span data-visibility="${t.attributes.getNamedItem("data-pf2-show-dc")?.value??e}">${s}</span> ${t.outerHTML}`.trim()}u(gt,"makeRepostHtml");function wi(t,e=null){if(!["pf2Action","pf2Check","pf2EffectArea"].some(l=>l in t.dataset))return;let s=Ge(e,t),i=(s??e)?.hasPlayerOwner?"all":"gm",c=(()=>t.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${pe(t.parentElement,ht).map(f=>gt(f,i)).join("<br>")}</div>`:gt(t,i))(),r=ChatMessage.implementation,o=s?r.getSpeaker({actor:s,token:s.getActiveTokens(!1,!0).shift()}):r.getSpeaker(),a=game.messages.get(re(t,"[data-message-id]")?.dataset.messageId??""),n=e instanceof JournalEntry?{pf2e:{journalEntry:e.uuid}}:a?.flags.pf2e.origin?{pf2e:{origin:deepClone(a.flags.pf2e.origin)}}:{};r.create({speaker:o,content:c,flags:n})}u(wi,"repostAction");function Oe(t,e){let s=e??yt(t,e),i=pe(t,ht).filter(r=>["A","SPAN"].includes(r.nodeName));ki(i,s),bi(t,s instanceof Actor?s:null);for(let r of i.filter(o=>o.dataset.pf2Action)){let{pf2Action:o,pf2Glyph:a,pf2Variant:n,pf2Dc:l,pf2ShowDc:f,pf2Skill:d}=r.dataset;r.addEventListener("click",p=>{let k=game.pf2e.actions[o?De(o,{camel:"dromedary"}):""],m=f??"all";o&&k?k({event:p,glyph:a,variant:n,difficultyClass:l?{scope:"check",value:Number(l)||0,visibility:m}:void 0,skill:d}):console.warn(`PF2e System | Skip executing unknown action '${o}'`)})}for(let r of i.filter(o=>o.dataset.pf2Check&&!o.dataset.invalid)){let{pf2Check:o,pf2Dc:a,pf2Traits:n,pf2Label:l,pf2Defense:f,pf2Adjustment:d,pf2Roller:p,pf2RollOptions:k}=r.dataset;if(!o)return;r.addEventListener("click",async m=>{let g=Ge(s,r),I=[g],b=[...n?.split(",").map(T=>T.trim())??[],...k?.split(",").map(T=>T.trim())??[]],w=xe(m,{type:"check"});switch(o){case"flat":{for(let T of I){let P=new T.saves.reflex.constructor(T,{label:"",slug:"flat",modifiers:[],check:{type:"flat-check"}}),N=Number.isInteger(Number(a))?{label:l,value:Number(a)}:null;P.roll({...w,extraRollOptions:b,dc:N})}break}default:{let T=ct(yi,o),P=T?[]:b.filter(N=>N in CONFIG.PF2E.actionTraits)??[];for(let N of I){let O=(()=>{if(o in CONFIG.PF2E.magicTraditions){let R=N.spellcasting.filter(Y=>Y.tradition===o).flatMap(Y=>Y.statistic??[]).sort((Y,ue)=>ue.check.mod-Y.check.mod).shift()??null;if(R)return R}return N.getStatistic(o)})();if(!O){console.warn(Ee(`Skip rolling unknown statistic ${o}`).message);continue}let L=f?game.user.targets.first()?.actor:null,G=(()=>{let R=Number(d)||0;return a==="@self.level"?Se(N.level)+R:Number(a??"NaN")+R})(),_=(()=>{if(Number.isInteger(G))return{label:l,value:G};if(f){let R=L?.getStatistic(f);return R?{statistic:R.dc,scope:"check",value:R.dc.value}:null}return null})(),M=(()=>{let R=s instanceof Item?s:s instanceof ChatMessage?s.item:null;return R?.isOfType("action","feat","campaignFeature")||T&&!R?.isOfType("weapon")?R:null})(),X={...w,extraRollOptions:b,origin:T&&g instanceof Actor?g:null,dc:_,target:!T&&_?.statistic?L:null,item:M,traits:P};if(!!(M?.isOfType("action","feat")&&M.actionCost)&&f){let R=o in CONFIG.PF2E.magicTraditions?"PF2E.ActionsCheck.spell":O.check.type==="attack-roll"?"PF2E.ActionsCheck.x-attack-roll":"PF2E.ActionsCheck.x";X.label=await renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:Ce(M.actionCost),subtitle:game.i18n.format(R,{type:O.label}),title:M.name})}O.roll(X)}}}})}let c={burst:"circle",cone:"cone",cube:"rect",emanation:"circle",line:"ray",rect:"rect",square:"rect"};for(let r of i.filter(o=>o.hasAttribute("data-pf2-effect-area"))){let{pf2EffectArea:o,pf2Distance:a,pf2TemplateData:n,pf2Traits:l,pf2Width:f}=r.dataset;r.addEventListener("click",()=>{if(!canvas.ready)return;if(typeof o!="string"){console.warn("PF2e System | Could not create template'");return}let d=JSON.parse(n??"{}");switch(d.distance||=Number(a),d.fillColor||=game.user.color,d.t=c[o],d.t){case"ray":d.width=Number(f)||CONFIG.MeasuredTemplate.defaults.width*canvas.dimensions.distance;break;case"cone":d.angle||=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let g=d.distance??0;d.distance=Math.hypot(g,g),d.width=g,d.direction=45;break}}let p={pf2e:{}};ce(CONFIG.PF2E.areaTypes,o)&&ce(CONFIG.PF2E.areaSizes,d.distance)&&(p.pf2e.areaType=o);let k=fe(s,"ChatMessagePF2e")?s.id:re(t,"[data-message-id]")?.dataset.messageId??null;k&&(p.pf2e.messageId=k);let m=Ge(s,r);if(m||l){let g={};m&&(g.actor=m.uuid),l&&(g.traits=l.split(",")),p.pf2e.origin=g}isEmpty(p.pf2e)||(d.flags=p),canvas.templates.createPreview(d)})}for(let r of t.querySelectorAll("a[data-damage-roll]"))r.dataset.itemUuid=s.uuid}u(Oe,"listenInlineRoll");function yt(t,e){if(e)return e;let i=(ui.windows[Number(t.closest(".app.sheet")?.dataset.appid)]??null)?.document;return i instanceof Actor||i instanceof JournalEntry?i:null}u(yt,"resolveDocument");function Ge(t,e){if(fe(t,"ActorPF2e"))return t;if(fe(t,"ItemPF2e")||fe(t,"ChatMessagePF2e"))return t.actor;let s=e.dataset.itemUuid,i=s&&!s.startsWith("Compendium.")?fromUuidSync(s):null;return i instanceof Item?i.actor:null}u(Ge,"resolveActor");var Fe=["U","T","E","M","L"],Ii="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi";async function kt(t,e){let s=t.data(),i=s.itemId?e.items.get(s.itemId):await fromUuid(s.uuid),c=await i?.getChatData({secrets:e.isOwner},s);if(!c)return;let r=document.createElement("div");return r.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(r,i,c),Oe(r,i),s.castRank&&(r.dataset.castRank=s.castRank),r}u(kt,"getItemSummary");function W(t){let e=t.find(".name");e.on("mouseenter",s=>{s.preventDefault();let i=s.currentTarget,{width:c}=i.getBoundingClientRect();if(i.scrollWidth<=Math.ceil(c))return;let r=i.innerHTML.trim();game.tooltip.activate(s.currentTarget,{text:r,direction:TooltipManager.TOOLTIP_DIRECTIONS.UP})}),e.on("mouseleave",s=>{s.preventDefault(),game.tooltip.deactivate()}),e.on("mousedown",s=>{game.tooltip.deactivate()})}u(W,"addNameTooltipListeners");function bt(t,e){t.preventDefault(),z(t,e)?.sheet.render(!0,{focus:!0})}u(bt,"editItem");async function wt(t,e){t.preventDefault();let s=z(t,e);if(s){if(t.ctrlKey)return s.delete();new Dialog({title:C("deleteItem.title"),content:`<p>${game.i18n.format("PF2E.DeleteQuestion",{name:s.name})}</p>`,buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:C("deleteItem.ok"),callback:()=>s.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:C("deleteItem.cancel")}}}).render(!0)}}u(wt,"deleteItem");function z(t,e){let{itemId:s}=t.currentTarget.closest("[data-item-id]").dataset;return e.items.get(s)}u(z,"getItemFromEvent");function Pe(t){return t.isOwner?Q(t,`macros.${game.user.id}`)?.map(e=>{let s=fromUuidSync(e);return s?{img:s.img,name:s.name,uuid:e}:null}).filter(Boolean):void 0}u(Pe,"getMacros");function Le(t,e){let{type:s,uuid:i}=TextEditor.getDragEventData(t.originalEvent)??{};if(s!=="Macro"||!fromUuidSync(i))return;let c=`macros.${game.user.id}`,r=Q(e,c)?.slice()??[];r.includes(i)||(r.push(i),ie(e,c,r))}u(Le,"onDroppedMacro");function Me(t,e){let s=`macros.${game.user.id}`,i=Q(e,s)?.slice();if(!i?.length)return;let{uuid:c}=t.currentTarget.closest(".macro").dataset,r=i.indexOf(c);r!==-1&&(i.splice(r,1),ie(e,s,i))}u(Me,"deleteMacro");function Ne(t=()=>!0){let e=game.user.targets,s=e.size===1?e.first():null;return s&&t(s)?s:null}u(Ne,"getUniqueTarget");function H(t,e){return e?t.toLowerCase().includes(e):!0}u(H,"filterIn");function U(t,e){return t.localeCompare(e,game.i18n.lang)}u(U,"localeCompare");function qe(t){return t?.itemTypes.effect.find(e=>e.flags.core?.sourceId===Ii)}u(qe,"getCoverEffect");async function se(t,e,s){let i=J(),c=i?.element;if(!c)return;c.find("> .popup").remove();let r=document.createElement("div");r.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${t}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${C("popup.close")}</a>
    </div>
</div>`;let o=r.firstElementChild;if(typeof e=="string"){let a=await te(e,s);o.insertAdjacentHTML("beforeend",a)}else o.append(e);o.querySelector("[data-action=close-popup]").addEventListener("click",()=>o.remove()),c.append(o),i.lock()}u(se,"popup");async function B(t,e,s){let i=await kt(t,e);if(i){let c=s??t.find(".name").html();se(c.trim(),i,e)}}u(B,"showItemSummary");async function $e(t,e,s,i){let c=ChatMessage.implementation,r=`systems/pf2e/templates/chat/${De(e.type)}-card.hbs`,o=s.token,a=re(t?.target,".item"),n=i.data??{...a?.dataset??{}},l={actor:s,tokenId:o?`${o.parent?.id}.${o.id}`:null,item:e,data:await e.getChatData(void 0,n)},f=t instanceof MouseEvent?t:t?.originalEvent,d=i.rollMode??Ae(f),p=c.applyRollMode({type:CONST.CHAT_MESSAGE_TYPES.OTHER,speaker:c.getSpeaker({actor:s,token:s.getActiveTokens(!1,!0).at(0)}),content:await renderTemplate(r,l),flags:{pf2e:{origin:e.getOriginData()}}},d);return i.create??!0?c.create(p,{rollMode:d,renderSheet:!1}):new c(p,{rollMode:d})}u($e,"unownedItemToMessage");async function It(t,e="roll"){if(!t.system.selfEffect)throw Ee(["Only actions with self-applied effects can be passed to `ActorPF2e#useAction`.","Support will be expanded at a later time."].join(" "));let{actor:s,actionCost:i}=t,c=s.getActiveTokens(!0,!0).shift()??null,r=ChatMessage.implementation,o=r.getSpeaker({actor:s,token:c}),a=await renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{title:t.name,glyph:Ce(i)},item:t,traits:t.system.traits.value.map(m=>ut(m,CONFIG.PF2E.actionTraits))}),n=100,l=(()=>{if(t.actor.pack)return null;let m=document.createElement("div"),g=[...CONST.DOCUMENT_LINK_TYPES,"Compendium","UUID"],I=new RegExp(`@(${g.join("|")})\\[([^#\\]]+)(?:#([^\\]]+))?](?:{([^}]+)})?`,"g");return m.innerHTML=t.description.replace(I,(b,...w)=>w[3]),m.innerText.slice(0,n)})(),f={full:l&&l.length<n?t.description:null,preview:l},d=await renderTemplate("systems/pf2e/templates/chat/action/self-effect.hbs",{actor:t.actor,description:f}),p={pf2e:{context:{type:"self-effect",item:t.id}}},k=r.applyRollMode({speaker:o,flavor:a,content:d,flags:p},e);return r.create(k)}u(It,"createSelfEffectMessage");async function vt({weapon:t,trait:e,selection:s}){if(t.system.traits.toggles[e].selection===s)return!1;let c=t.actor?.items.get(t.id);return c?.isOfType("weapon")&&c===t?await c.update({[`system.traits.toggles.${e}.selection`]:s}):c?.isOfType("weapon")&&t.altUsageType==="melee"?c.update({[`system.meleeUsage.traitToggles.${e}`]:s}):e==="versatile"&&c?.isOfType("shield")?c.update({"system.traits.integrated.versatile.selection":s}):await c?.rules.find(o=>o.key==="Strike"&&!o.ignored&&o.slug===t.slug)?.toggleTrait({trait:e,selection:s}),!0}u(vt,"toggleWeaponTrait");var Re={CRITICAL_FAILURE:0,FAILURE:1,SUCCESS:2,CRITICAL_SUCCESS:3},Tt={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"};function St(t,e){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(e+t,0,3)}}u(St,"adjustDegreeOfSuccess");function Ue(t,e){return t===20?St(Tt.INCREASE,e):t===1?St(Tt.LOWER,e):e}u(Ue,"adjustDegreeByDieValue");function Ct(t,e,s){return t-s>=10?Ue(e,Re.CRITICAL_SUCCESS):s-t>=10?Ue(e,Re.CRITICAL_FAILURE):t>=s?Ue(e,Re.SUCCESS):Ue(e,Re.FAILURE)}u(Ct,"calculateDegreeOfSuccess");var vi=["arcana","crafting","medicine","nature","occultism","religion","society"],Et={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function Dt(t){let e=await new Roll("1d20").evaluate({async:!0}),s=e.dice[0].total,i=s===1?"0":s===20?"3":"",c=Object.values(t.skills).filter(l=>l.lore),r=Ne(l=>l.actor?.identificationDCs)?.actor,o={dieSuccess:i,dieResult:s,target:r,i18n:l=>C(`actions.recall-knowledge.${l}`)};if(r){let{standard:l,skills:f,lore:d}=r.identificationDCs,p=l.progression.slice();p.length=4,p=[...p];let k=d.map(({progression:m})=>{let g=m;return g.length=6,[...g]});o.skillsDCs=p,o.loresDCs=k,o.skills=await Promise.all(f.map(m=>{let g=t.skills[m];return Ke(g,s,p)})),o.lores=await Promise.all(c.map(m=>Ke(m,s)))}else o.skills=await Promise.all([...vi.map(l=>t.skills[l]),...c].map(l=>Ke(l,s)));let a=h("rk-dice"),n={speaker:ChatMessage.getSpeaker({actor:t}),rollMode:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL};a&&(n.rolls=[e],o.rkDice=!0),n.flavor=await renderTemplate(F("chat/recall-knowledge"),o),ChatMessage.create(n)}u(Dt,"rollRecallKnowledges");async function Ke(t,e,s){let{rank:i,label:c}=t,r=await t.roll({createMessage:!1,skipDialog:!0,extraRollOptions:["action:recall-knowledge"]}),o=r.total-r.dice[0].total,a=e+o;return{mod:o,rank:i,label:c,total:a,modifier:q(o),rankLabel:Fe[i],checks:s?.map(n=>{if(!n)return"-";let l=Ct(a,e,n);return{success:l,icon:Et[l].icon,title:Et[l].name}})}}u(Ke,"rollSkill");var V="pf2e-token-hud",Ti="Compendium.pf2e.feats-srd.Item.9jGaBxLUtevZYcZO",Si=new Set(["Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk"]),xt="Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf",Ci="Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu",We="Compendium.pf2e.other-effects.Item.VCSpuc3Tf3XWMkd3",Ei={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${V}.skills.actions.earnIncome`,treatWounds:`${V}.skills.actions.treatWounds`,"borrow-arcane-spell":`${V}.skills.actions.borrow-arcane-spell`,"identify-magic":`${V}.skills.actions.identify-magic`,"identify-alchemy":`${V}.skills.actions.identify-alchemy`,"learn-spell":`${V}.skills.actions.learn-spell`,"crafting-goods":`${V}.skills.actions.crafting-goods`,"staging-performance":`${V}.skills.actions.staging-performance`},At={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW","sense-motive":"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","follow-the-expert":"Compendium.pf2e.actionspf2e.Item.tfa4Sh7wcxCEqL29","tumble-through":"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2",reposition:"Compendium.pf2e.actionspf2e.Item.lOE4yjUnETTdaf2T",shove:"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X",bonMot:xt,gatherInformation:"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H"},Di={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},me=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:t=>!t.itemTypes.equipment.some(e=>e.isHeld&&Si.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0,agile:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"reposition",cost:"1",type:2,map:!0,agile:!0},{slug:"shove",cost:"1",type:1,map:!0,agile:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0,agile:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0,agile:!0}]},{slug:"crafting",actions:[{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:t=>Ve(t,xt)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"],rollOption:"administer-first-aid"},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"identify-magic","learn-spell",{slug:"treatWounds",type:1,trained:!0,condition:t=>Ve(t,Ci)}]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:[{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];for(let t of me){t.actions=t.actions.map(i=>typeof i=="string"?Di[i]:i);let{slug:e,actions:s}=t;for(let i of s){let c=i.slug.replace(/-(.)/g,(r,o)=>o.toUpperCase()).capitalize();if(i.skillSlug=e,i.uuid=At[i.slug],i.label=Ei[i.slug]??`PF2E.Actions.${c}.Title`,i.variants)i.variants=i.variants.map(r=>({slug:r,label:`${V}.skills.actions.${r}`}));else if(i.map){let r=!!i.agile;i.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:1,agile:r,mapValue:r?-4:-5},{label:"PF2E.MAPAbbreviationLabel",map:2,agile:r,mapValue:r?-8:-10}]}for(let{modifiers:r}of i.modifiers??[])for(let o of r)o.label=`${V}.skills.modifiers.${o.slug}`}}var Ye=me.map(t=>t.slug),xi=me.reduce((t,{slug:e,actions:s})=>(t[e]={slug:e,actions:s.reduce((i,c)=>(i[c.slug]=c,i),{})},t),{}),Ot=new Set(Object.values(At).filter(Boolean));function Qe(t){return game.i18n.localize(t==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[t])}u(Qe,"getSkillLabel");async function Ft({actor:t,filter:e}){let s=[],i=t.isOfType("character"),c=i&&h("untrained")&&!t.itemTypes.feat.some(a=>a.sourceId===Ti);for(let a=0;a<me.length;a++){let{slug:n,actions:l}=me[a],{label:f,rank:d,mod:p}=t.getStatistic(n),k=game.i18n.localize(f),m=l.filter(({condition:b,trained:w})=>(!c||!i||!w||t.skills[n].rank>=1)&&(!b||b(t))).map(b=>({...b,name:game.i18n.localize(b.label),variants:b.variants?.map(w=>({...w,name:game.i18n.localize(w.label)}))})),g=H(k,e),I=m;!g&&(I=m.filter(({name:b,variants:w})=>H(b,e)||w?.some(T=>H(T.name,e))),!I.length)||(s[a]={slug:n,name:k,rank:d,modifier:q(p),actions:g?m:I})}s.sort((a,n)=>a.slug==="perception"?-1:n.slug==="perception"?1:U(a.name,n.name));let r=Object.values(t.skills).filter(({lore:a,label:n})=>a&&H(n,e)).map(({label:a,rank:n,mod:l,slug:f})=>({slug:f,label:a,rank:n,modifier:q(l)})),o=r.reduce((a,n)=>n.modifier.length>a?n.modifier.length:a,2);return{contentData:{follow:C(`skills.actions.${Lt(t)?"following":"follow"}`),skills:s,lores:r,loresModifierWidth:o},doubled:h("skills-columns")}}u(Ft,"getSkillsData");function Pt({el:t,actor:e,token:s,hud:i}){t.find("[data-action=action-description]").on("click",c=>{c.preventDefault();let r=$(c.currentTarget).closest(".action");B(r,e,r.find(".name").children().html())}),e.isOwner&&(t.find("[data-action=follow-the-expert]").on("click",async c=>{c.preventDefault();let r=Lt(e);if(r)return await r.delete();let o=(await fromUuid(We)).toObject();setProperty(o,"flags.core.sourceId",We),await e.createEmbeddedDocuments("Item",[o])}),t.find("[data-action=roll-skill]").on("click",c=>{c.preventDefault();let{slug:r}=c.currentTarget.dataset;e.getStatistic(r)?.roll({event:c}),h("skill-close")&&i.close()}),t.find("[data-action=roll-action]").on("click contextmenu",async c=>{c.preventDefault();let r=$(c.currentTarget),{skillSlug:o,slug:a,actionName:n}=r.closest(".action").data(),{variant:l,map:f,agile:d}=r.data(),p=c.type==="contextmenu"?await He(n,{skill:o,agile:d}):void 0;p!==null&&(Ai({event:c,actor:e,token:s,skillSlug:o,slug:a,variant:l,map:f,skill:p?.skill,agile:p?.agile??d}),h("skill-close")&&i.close())}),t.find("[data-action=action-chat]").on("click",async c=>{c.preventDefault();let{uuid:r}=c.currentTarget.closest(".action").dataset,o=await fromUuid(r);o&&($e(c,o,e,{create:!0}),h("chat-close")&&i.close())}))}u(Pt,"addSkillsListeners");function Lt(t){return t.itemTypes.effect.find(e=>e.sourceId===We)}u(Lt,"isFollowingAnExpert");async function He(t,{dc:e,agile:s,skill:i}={}){let c=Ye.map(o=>({slug:o,label:Qe(o)})),r=await renderTemplate(F("dialogs/variant"),{i18n:o=>C(`skills.variant.${o}`),dc:e,skill:i,agile:s,skills:c});return Dialog.prompt({title:t,label:C("skills.variant.button"),callback:o=>({skill:o.find("select").val(),dc:Number(o.find("[name=dc]").val()),agile:o.find("[name=agile]").is(":checked")}),rejectClose:!1,content:r,options:{width:280}})}u(He,"variantsDialog");function Je(t,e){let s=t===1?e?-4:-5:e?-8:-10;return new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:s})}u(Je,"getMapModifier");function Ai({event:t,actor:e,skillSlug:s,slug:i,variant:c,map:r,agile:o,skill:a,token:n}){let l=xi[s].actions[i],f=l.type===3?3:game.pf2e.actions.has(i)?2:1;a??=l.noSkill?void 0:s;let d=l.rollOption?[`action:${l.rollOption}`]:void 0;d&&c&&d.push(`action:${l.rollOption}:${c}`);let p={event:t,actors:[e],tokens:[n],variant:c,rollOptions:d,rollMode:l.secret?"blindroll":"roll"};if(p.modifiers=[],l.modifiers){for(let{condition:k,modifiers:m}of l.modifiers)if(!(k&&!k(e)))for(let g of m)p.modifiers.push(new game.pf2e.Modifier(g))}if(r){let k=Je(r,o);p.modifiers.push(k)}if(l.custom){l.custom(e,p);return}if(!f){e.getStatistic(a)?.roll(p);return}f===1?(p.skill=a,game.pf2e.actions[i](p)):f===2?(p.statistic=a,game.pf2e.actions.get(i).use(p)):f===3&&game.pf2e.actions[i](e)}u(Ai,"rollAction");var Xe={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","point-out":"Compendium.pf2e.actionspf2e.Item.sn2hIy1iIJX9Vpgj"};async function Mt({actor:t,filter:e}){let s=t.system.initiative;return{contentData:{noMacro:C("extras.no-macro"),macros:Pe(t)?.filter(i=>H(i.name,e)),initiative:s&&{selected:s.statistic,skills:Ye.map(i=>({slug:i,label:Qe(i)}))},hasDailies:game.modules.get("pf2e-dailies")?.active,hasPerception:game.modules.get("pf2e-perception")?.active,uuids:Xe}}}u(Mt,"getExtrasData");function Nt({el:t,actor:e,token:s,hud:i}){function c(o,a,n="click"){t.find(`[data-action=${o}]`).on(n,l=>{l.preventDefault(),a(l)})}if(u(c,"action"),c("action-description",o=>{let a=$(o.currentTarget).closest(".row");B(a,e)}),!e.isOwner)return;W(t.find(".macro"));async function r(o){let{uuid:a}=o.currentTarget.closest(".macro").dataset;return fromUuid(a)}u(r,"getMacro"),c("delete-macro",o=>Me(o,e)),c("edit-macro",async o=>{(await r(o))?.sheet.render(!0)}),c("use-macro",async o=>{(await r(o))?.execute({actor:e,token:s}),h("macro-close")&&i.close()}),t.on("drop",o=>Le(o,e)),c("action-chat",async o=>{let{uuid:a}=o.currentTarget.closest(".row").dataset,n=await fromUuid(a);n&&($e(o,n,e,{create:!0}),h("chat-close")&&i.close())}),t.find("input[name], select[name]").on("change",async o=>{let a=o.currentTarget,n=a.type==="number"?a.valueAsNumber:a.value;await e.update({[a.name]:n})}),c("roll-initiative",async o=>{await e.initiative.roll({event:o}),h("skill-close")&&i.close()}),c("prepare-dailies",o=>{let a=game.modules.get("pf2e-dailies");a?.active&&a.api.openDailiesInterface(e)}),c("rest-for-the-night",o=>{game.pf2e.actions.restForTheNight({actors:[e],tokens:[s]})}),c("roll-recall-knowledge",o=>{Dt(e),h("skill-close")&&i.close()}),c("roll-aid",async o=>{let a=await He(game.i18n.localize("PF2E.Actions.Aid.Title"),{dc:15}),n={text:"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]"};a!==null&&(game.pf2e.actions.get("aid").use({event:o,actors:[e],tokens:[s],statistic:a?.skill,difficultyClass:{value:a?.dc},notes:[n]}),h("skill-close")&&i.close())},"click contextmenu"),c("roll-point-out",o=>{game.pf2e.actions.get("point-out").use({event:o,actors:[e],tokens:[s]}),h("skill-close")&&i.close()}),c("roll-escape",async o=>{let a=$(o.currentTarget).data().map,n=o.type==="contextmenu"?await He(game.i18n.localize("PF2E.Actions.Escape.Title"),{agile:a?!1:void 0}):void 0;if(n===null)return;let l=[];if(a){let f=n?.agile,d=Je(a,f);l.push(d)}game.pf2e.actions.get("escape").use({event:o,actors:[e],tokens:[s],statistic:n?.skill,modifiers:l}),h("skill-close")&&i.close()},"click contextmenu")}u(Nt,"addExtrasListeners");var le={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionsReactionsHeader",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionsFreeActionsHeader",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.NPC.PassivesLabel",actionLabel:"PF2E.ActionTypePassive"},exploration:{order:3,label:"PF2E.TravelSpeed.ExplorationActivity",actionLabel:"PF2E.TabActionsExplorationLabel"}};async function $t({hud:t,actor:e,filter:s}){let i=e.isOfType("character"),c=e.synthetics.toggles.slice(),r=h("actions"),o=(await Ze()?.getStances(e))?.sort((I,b)=>U(I.name,b.name)),a=i?await ne()?.getHeroActions(e):void 0,n=a?e.heroPoints.value-a.length:void 0,l=e.isOwner,f=e.getRollData(),d=e.system.actions?await Promise.all(e.system.actions.map(async(I,b)=>({...I,index:b,visible:!i||I.visible,damageFormula:await I.damage?.({getFormula:!0}),criticalFormula:await I.critical?.({getFormula:!0}),description:I.description?await te(I.description,e,{rollData:f,isOwner:l}):void 0,altUsages:I.altUsages&&await Promise.all(I.altUsages.map(async w=>({...w,usage:w.item.isThrown?"thrown":"melee",damageFormula:await w.damage?.({getFormula:!0}),criticalFormula:await w.critical?.({getFormula:!0})})))}))):void 0,p=i?new game.pf2e.ElementalBlast(e):void 0,k=p?(await Promise.all(p.configs.map(async I=>{let b=I.damageTypes.find(T=>T.selected)?.value??"untyped",w=u((T,P=!0)=>p.damage({element:I.element,damageType:b,melee:P,outcome:T,getFormula:!0}),"formulaFor");return{...I,damageType:b,formula:{melee:{damage:await w("success"),critical:await w("criticalSuccess")},ranged:{damage:await w("success",!1),critical:await w("criticalSuccess",!1)}}}}))).sort((I,b)=>U(I.label,b.label)):void 0,m={},g=i?Fi(e,o):Pi(e);for(let I of g)H(I.name,s)&&(r!=="split"?(m.action??=[],m.action.push(I)):(m[I.type]??=[],m[I.type].push(I)));if(m=Object.entries(m).map(([I,b])=>{for(let w of b)w.img=rt(w.cost),w.typeLabel=le[w.type].actionLabel;return r!=="type"?b.sort((w,T)=>U(w.name,T.name)):b.sort((w,T)=>{let P=le[w.type].order,N=le[T.type].order;return P===N?U(w.name,T.name):P-N}),{type:I,actions:b,label:le[I].label}}),r==="split"&&m.sort((I,b)=>le[I.type].order-le[b.type].order),c.length||o?.length||d?.length||k?.length||m.length||a?.length){let I=+((o?.length??0)>0)+ +((d?.length??0)>0)+ +((k?.length??0)>0)+m.length+ +((a?.length??0)>0);return{contentData:{toggles:c,stances:o,strikes:d,blasts:k,sections:m,heroActions:a&&{actions:a,draw:Math.max(n,0),discard:Math.abs(Math.min(n,0)),canTrade:a.length&&Oi()},i18n:b=>C(`actions.${b}`),variantLabel:b=>b.replace(/.+\((.+)\)/,"$1"),damageTypes:CONFIG.PF2E.damageTypes},doubled:I>1&&h("actions-columns")}}}u($t,"getActionsData");function Rt({el:t,actor:e,hud:s}){W(t.find(".toggle")),W(t.find(".strike")),W(t.find(".action"));function i(a,n,l="click"){let d=(typeof a=="string"?[a]:a).map(p=>`[data-action=${p}]`).join(", ");return t.find(d).on(l,p=>{p.preventDefault(),n(p)})}u(i,"action");function c(a){let n=a.currentTarget.closest(".strike"),l=e.system.actions[n.dataset.index];if(!l)return null;let{altUsage:f}=a.currentTarget.dataset;return["melee","thrown"].includes(f)?l.altUsages?.find(d=>f==="thrown"?d.item.isThrown:d.item.isMelee)??null:l}u(c,"getStrike");function r(a){return $(a.currentTarget).closest(".action").data().uuid}if(u(r,"getUuid"),i("action-description",async a=>{let n=$(a.currentTarget).closest(".action");B(n,e)}),i("hero-action-description",async a=>{let n=r(a),{description:l,name:f}=await ne()?.getHeroActionDetails(n)??{};l&&se(f,l,e)}),i("strike-description",async a=>{let n=c(a);if(!n)return;let l=document.createElement("div");l.classList.add("description"),l.innerHTML=await renderTemplate(F("strike-description"),n),se(n.label,l,e)}),i("blast-description",async a=>{let n=a.currentTarget.closest(".blast");B($(n),e)}),i("trait-description",a=>{let n=c(a);if(!n)return;let{index:l}=a.currentTarget.dataset,f=n.traits[l];if(!f)return;let d=game.i18n.localize(f.description);d&&se(game.i18n.localize(f.label),d,e)}),i("stance-description",a=>{let n=$(a.currentTarget).closest(".action");B(n,e,n.data().itemName)}),!e.isOwner||(i("use-action",a=>{let n=z(a,e);n?.isOfType("action","feat")&&(It(n,Ae(a)),h("action-effect")&&Li(e,n),h("action-close")&&s.close())}),i("stance-chat",a=>{let n=z(a,e);n&&(n.toMessage(a,{create:!0}),h("chat-close")&&s.close())}),i("stance-toggle",a=>{let{effectUuid:n}=a.currentTarget.closest(".action").dataset;Ze()?.toggleStance(e,n)}),i("exploration-toggle",a=>{let n=a.currentTarget.closest(".action").dataset.itemId,l=e.system.exploration.filter(f=>e.items.has(f));l.findSplice(f=>f===n)||l.push(n),e.update({"system.exploration":l})}),i("action-chat",a=>{let n=z(a,e);n&&(n.toMessage(a,{create:!0}),h("chat-close")&&s.close())}),i("hero-action-chat",async a=>{let n=ne();n&&(n.sendActionToChat(e,r(a)),h("chat-close")&&s.close())}),i("draw-hero-action",async a=>{await ne()?.drawHeroActions(e)}),i("use-hero-action",async a=>{let n=ne();n&&(n.useHeroAction(e,r(a)),h("action-close")&&s.close())}),i("discard-hero-action",async a=>{await ne()?.discardHeroActions(e,r(a))}),i("trade-hero-action",async a=>{ne()?.tradeHeroAction(e)}),i("strike-attack",a=>{let{index:n,altUsage:l}=a.currentTarget.dataset;c(a)?.variants[n].roll({event:a,altUsage:l}),h("attack-close")&&s.close()}),i(["strike-damage","strike-critical"],a=>{let{action:n}=a.currentTarget.dataset;c(a)?.[n==="strike-damage"?"damage":"critical"]({event:a}),h("attack-close")&&s.close()}),i(["toggle-roll-option","set-suboption"],a=>{let n=a.currentTarget.closest(".toggle"),{domain:l,option:f,itemId:d}=n.dataset,p=n.querySelector("select")?.value??null;e.toggleRollOption(l,f,d??null,n.querySelector("input").checked,p)}),i("strike-auxiliary",a=>{if(a.currentTarget!==a.target)return;let n=c(a);if(!n)return;let{index:l}=a.currentTarget.dataset,f=a.currentTarget.querySelector("select")?.value??null;n.auxiliaryActions?.[l]?.execute({selection:f})}),i("toggle-versatile",a=>{let n=c(a)?.item;if(!n)return;let l=a.currentTarget,{value:f}=l.dataset,d=n?.system.damage.damageType??null,p=l.classList.contains("selected")||f===d?null:f;vt({trait:"versatile",weapon:n,selection:p})}),i("strike-ammo",async a=>{let n=c(a)?.item;if(!n)return;let l=e.items.get(a.currentTarget.value);await n.update({system:{selectedAmmoId:l?.id??null}})},"change"),!e.isOfType("character")))return;let o=["roll-attack","roll-damage","set-damage-type"].map(a=>`[data-action=${a}]`).join(",");t.find(".blast").each((a,n)=>{let{element:l,damageType:f}=n.dataset,d=new game.pf2e.ElementalBlast(e);$(n).find(o).on("click",async p=>{p.preventDefault();let k=p.currentTarget.dataset,m=k.melee==="true";switch(k.action){case"roll-attack":{let g=Math.clamped(Number(k.mapIncreases),0,2);d.attack({mapIncreases:Math.clamped(g,0,2),element:l,damageType:f,melee:m,event:p});break}case"roll-damage":{d.damage({element:l,damageType:f,melee:m,outcome:k.outcome,event:p});break}case"set-damage-type":d.setDamageType({element:l,damageType:k.value})}["roll-attack","roll-damage"].includes(k.action)&&h("attack-close")&&s.close()})})}u(Rt,"addActionsListeners");function Ut(t){let e=game.modules.get("pf2e-toolbelt");return e?.active&&game.settings.get("pf2e-toolbelt",t)?e:void 0}u(Ut,"getToolBeltModule");function Ht(t){return Ut(t)?.api}u(Ht,"getToolBeltApi");function Ze(){let t=game.modules.get("pf2e-stances");return t?.active?t.api:Ht("stances")?.stances}u(Ze,"getStancesModuleApi");function ne(){let t=game.modules.get("pf2e-hero-actions");return t?.active?t.api:Ht("hero")?.heroActions}u(ne,"getHeroActionsApi");function Oi(){if(game.modules.get("pf2e-hero-actions")?.active)return game.settings.get("pf2e-hero-actions","trade");if(Ut("hero"))return game.settings.get("pf2e-toolbelt","hero-trade")}u(Oi,"canTradeHeroActions");function Fi(t,e){let s=Ze()?.getActionsUUIDS?.()??(e?.some(n=>n.actionUUID)?new Set(e.map(({actionUUID:n})=>n)):void 0)??new Set,i=new Set([...s,...Ot,...Object.values(Xe)]),c=t.itemTypes.action,r=t.itemTypes.feat.filter(n=>n.actionCost),o=t.parties.size>0,a=t.system.exploration;return[...c,...r].map(n=>{let l=n.sourceId,f=n.id,d=n.actionCost,p=n.system.traits.value,k=p.includes("exploration");return{sourceId:l,id:f,type:d?.type??(k?"exploration":"free"),cost:d,name:n.name,isExploration:k,isDowntime:p.includes("downtime"),isActive:k&&a.includes(f),hasEffect:!!n.system.selfEffect}}).filter(n=>!n.isDowntime&&(o||!n.isExploration)&&(n.isExploration||!i.has(n.sourceId)))}u(Fi,"getCharacterActions");function Pi(t){return t.itemTypes.action.map(e=>{let s=e.actionCost,i=s?.type??"passive",c=i==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(r=>r.key==="Aura"));return{id:e.id,type:i,cost:s,name:e.name,hasDeathNote:e.system.deathNote,hasAura:c,hasEffect:!!e.system.selfEffect}})}u(Pi,"getNpcActions");async function Li(t,e){let s=e.system.selfEffect?.uuid;if(!s)return;let i=(await fromUuid(s))?.toObject();i&&t.createEmbeddedDocuments("Item",[i])}u(Li,"applyActionEffect");async function zt({actor:t}){let{system:e}=t,{details:s,traits:i,attributes:c}=e,{stealth:r}=c,{description:o,disable:a,routine:n,reset:l,isComplex:f}=s,d=t.getRollData(),p=t.isOwner,k=u(async m=>te(m,t,{isOwner:p,rollData:d}),"enrich");return{contentData:{description:await k(o),disable:await k(a),routine:await k(n),reset:await k(l),isComplex:f,rarity:{value:i.rarity,label:CONFIG.PF2E.rarityTraits[i.rarity]},traits:i.value.map(m=>CONFIG.PF2E.hazardTraits[m]),stealth:q(r.value)},style:{"--max-width":`${h("hazard-width")}em`}}}u(zt,"getHazardData");function _t({el:t,actor:e}){t.find("[data-action=action-description]").on("click",s=>{s.preventDefault();let i=$(s.currentTarget).closest(".action");B(i,e)}),Oe(t[0],e),e.isOwner&&t.find("[data-action=roll-initiative").on("click",s=>{s.preventDefault(),e.initiative.roll({event:s})})}u(_t,"addHazardListeners");var jt=new Set(["arcane","divine","occult","primal"]);function Mi(t){return t.traits.has("cursed")?"unique":t.rarity}u(Mi,"getDcRarity");function Ni(t){let e=t.system.traits.value;return new Set(e.filter(s=>lt(jt,s)))}u(Ni,"getMagicTraditions");function $i(t,e,s){let i={occult:e,primal:e,divine:e,arcane:e},c=Ni(t);for(let r of jt)c.size>0&&!c.has(r)&&(i[r]=e+s);return{arcana:i.arcane,nature:i.primal,religion:i.divine,occultism:i.occult}}u($i,"getIdentifyMagicDCs");function Ri(t,{pwol:e=!1,notMatchingTraditionModifier:s}){let i=Se(t.level,{pwol:e}),c=Mi(t),r=Te(i,c);return t.isMagical?$i(t,r,s):t.isAlchemical?{crafting:r}:{dc:r}}u(Ri,"getItemIdentificationDCs");var ge=class extends FormApplication{static get defaultOptions(){return{...FormApplication.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let e=this.object,s=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),i=game.pf2e.settings.variants.pwol.enabled,c=Ri(e,{pwol:i,notMatchingTraditionModifier:s});return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:c}}activateListeners(e){e.find("button.update-identification").on("click",s=>{let i=$(s.delegateTarget);this.submit({updateData:{status:i.val()}})}),e.find("button.post-skill-checks").on("click",async()=>{let s=this.item,i=s.system.identification.unidentified.img,c=s.system.identification.unidentified.name,r=s.system.identification.identified.name,o=$("div#identify-item").find("tr").toArray().flatMap(l=>{let f=l.dataset.skill,d=Number(l.dataset.dc);if(!(Number.isInteger(d)&&ce(CONFIG.PF2E.skillList,f)))return[];let p=game.i18n.localize(CONFIG.PF2E.skillList[f]);return{slug:f,name:p,dc:d}}),a=s.isMagical?"action:identify-magic":s.isAlchemical?"action:identify-alchemy":null,n=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:i,itemName:c,identifiedName:r,rollOptions:["concentrate","exploration","secret",a].filter(Boolean),skills:o});await ChatMessage.implementation.create({user:game.user.id,content:n})})}async _updateObject(e,s){let i=s.status;i==="identified"&&await this.item.setIdentificationStatus(i)}};u(ge,"IdentifyItemPopup");async function ye({target:t,selected:e,direction:s="DOWN",onCreate:i,onDismiss:c,onClick:r,content:o,cssClass:a=[],locked:n=!1}){return new Promise(l=>{let f=`${D}-tooltip`,d=document.body.querySelectorAll(`.${f}:not(#tooltip)`);for(let p of d)he(p);requestAnimationFrame(()=>{a=typeof a=="string"?[a]:a,e&&a.push("selection-tooltip"),Array.isArray(o)&&(o=o.map(({value:k,label:m})=>`<li><a ${k===e?'class="selected"':""} data-value="${k}">${m}</a></li>`).join(""));let p;if(o instanceof HTMLElement?p=o:(p=document.createElement("ul"),p.innerHTML=o),p.style.setProperty("--font-size",`${h("scale")}px`),a.length&&p.classList.add(...a.map(k=>`${D}-${k}`)),c&&new MutationObserver(function(){document.body.contains(p)||(c(),this.disconnect())}).observe(document.body,{childList:!0}),r){n=!0;for(let k of p.querySelectorAll("[data-value]"))k.addEventListener("click",async m=>{m.preventDefault();let g=m.currentTarget;he(g),r?.(g.dataset.value)})}game.tooltip.activate(t,{content:p,direction:s,locked:n,cssClass:f}),i?.(p),l(p)})})}u(ye,"createTooltip");function he(t){let e=t.closest(`.${D}-tooltip`);game.tooltip.dismissLockedTooltip(e)}u(he,"dismissTooltip");var ze={weaponAndShield:{order:0,label:"PF2E.Actor.Inventory.Section.WeaponsAndShields"},armor:{order:1,label:"TYPES.Item.armor"},consumable:{order:2,label:"PF2E.Item.Consumable.Plural"},equipment:{order:3,label:"TYPES.Item.equipment"},treasure:{order:4,label:"TYPES.Item.treasure"},backpack:{order:5,label:"PF2E.Item.Container.Plural"}};async function Bt({actor:t,filter:e}){let{contents:s,coins:i,totalWealth:c,bulk:r,invested:o}=t.inventory,a=t.isOfType("creature"),n=h("containers")||(Q(t,`containers.${game.user.id}`)??[]),l={},f={};for(let d of s){let p=d.type==="shield"||d.type==="weapon"?"weaponAndShield":d.type;if(!ze[p])continue;let k=d.system.containerId;p!=="backpack"&&k&&(n===!0||n.includes(k))?(l[k]??=[],l[k].push(d)):(f[p]??=[],f[p].push(d))}if(f=Object.entries(f).map(([d,p])=>{if(p.sort((k,m)=>U(k.name,m.name)),d==="backpack")for(let k=p.length-1;k>=0;k--){let m=p[k],g=l[m.id]?.filter(I=>H(I.name,e));if(!g?.length){H(m.name,e)||p.splice(k,1);continue}g.sort((I,b)=>U(I.name,b.name)),p.splice(k+1,0,...g)}else p=p.filter(k=>H(k.name,e));return{type:d,items:p,label:ze[d].label}}).filter(d=>d.items.length).sort((d,p)=>ze[d.type].order-ze[p.type].order),f.length)return{doubled:f.length>1&&h("items-columns"),contentData:{canCarry:!!t.adjustCarryType,categories:f,bulk:r,containers:n,i18n:d=>C(`items.${d}`),invested:o?`${game.i18n.localize("PF2E.InvestedLabel")}: ${o.value} / ${o.max}`:"",wealth:{coins:i.goldValue,total:c.goldValue},canUseItem:d=>a&&d.type==="consumable"&&d.isIdentified&&d.uses.max&&!d.isAmmunition,itemDisabled:d=>!d.quantity||!d.uses.value||d.system.equipped.carryType==="dropped"}}}u(Bt,"getItemsData");function Gt({el:t,actor:e,token:s,hud:i}){let c=t.find(".item");W(c),c.find("[data-action=item-description]").on("click",async r=>{r.preventDefault();let o=$(r.currentTarget).closest(".item");await B(o,e)}),c.find("[data-action=toggle-contains-items]").on("click",async r=>{r.preventDefault();let o=`containers.${game.user.id}`,a=r.currentTarget.closest(".item").dataset.itemId,n=Q(e,o)?.slice()??[],l=n.indexOf(a);l===-1?n.push(a):n.splice(l,1),await ie(e,o,n)}),e.isOwner&&(c.find("[data-action=use-item]").on("click",r=>{let o=z(r,e);o&&(o.consume(),h("use-close")&&i.close())}),c.find("[data-action=item-chat]").on("click",async r=>{let o=z(r,e);o&&(o.toMessage(r,{create:!0}),h("chat-close")&&i.close())}),c.on("dragstart",r=>{let o=r.target.closest(".item"),{itemType:a,uuid:n}=o.dataset,l=new Image;l.src=o.querySelector(".item-img img").src,l.style.width="32px",l.style.height="32px",l.style.borderRadius="4px",l.style.position="absolute",l.style.left="-1000px",document.body.append(l),r.originalEvent.dataTransfer.setDragImage(l,16,16),r.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:a,uuid:n})),o.addEventListener("dragend",()=>l.remove(),{once:!0})}),t.find(".quantity input").on("change",async r=>{await z(r,e)?.update({"system.quantity":r.currentTarget.valueAsNumber})}),t.find("[data-action=toggle-item-invest]").on("click",r=>{r.preventDefault();let{itemId:o}=r.currentTarget.closest(".item").dataset;e.toggleInvested(o)}),t.find("[data-action=repair-item]").on("click",r=>{r.preventDefault();let o=z(r,e);o&&game.pf2e.actions.repair({item:o,actors:[e],tokens:[s]})}),t.find("[data-action=toggle-identified]").on("click",r=>{r.preventDefault();let o=z(r,e);o&&(o.isIdentified?o.setIdentificationStatus("unidentified"):new ge(o).render(!0))}),t.find("[data-action=edit-item]").on("click",r=>{r.preventDefault(),bt(r,e)}),t.find("[data-action=delete-item]").on("click",r=>{r.preventDefault(),wt(r,e)}),t.find("[data-action=toggle-item-worn").on("click",async r=>{let o=z(r,e);if(!o)return;let a=document.createElement("div");a.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:o});let n=a.children[1].firstElementChild;for(let l of n.querySelectorAll("[data-carry-type]"))l.addEventListener("click",async f=>{let d=f.currentTarget,p=o.system.equipped,k=d.dataset.inSlot==="true",m=Number(d.dataset.handsHeld)||0,g=d.dataset.carryType;he(d),(g!==p.carryType||k!==p.inSlot||g==="held"&&m!==p.handsHeld)&&e.adjustCarryType(o,{carryType:g,handsHeld:m,inSlot:k})});if(o.type!=="backpack"){let l=e.itemTypes.backpack.filter(f=>f.isIdentified);if(l.length){let f="";for(let p of l)f+='<li><a class="item-control item-location-option',p===o.container&&(f+=" selected"),f+=`" data-action="send-to-container" data-container-id="${p.id}">`,f+=`<i class="fas fa-box"></i>${p.name}</a></li>`;n.insertAdjacentHTML("beforeend",f);let d=n.querySelectorAll("[data-action=send-to-container]");for(let p of d)p.addEventListener("click",k=>{let m=k.currentTarget,g=m.dataset.containerId,I=e.items.get(g);I&&(he(m),e.stowOrUnstow(o,I))})}}ye({target:r.currentTarget,content:n,locked:!0,direction:"UP",selected:!0})}))}u(Gt,"addItemsListeners");async function qt({actor:t,filter:e}){let s=t.system.resources.focus??{value:0,max:0},i=t.spellcasting.regular,c=h("tradition"),r=game.modules.get("pf2e-staves")?.active,o=game.modules.get("pf2e-dailies"),a=o?.active,n=r||a&&isNewerVersion(o.version,"2.14.0"),l=r?"flags.pf2e-staves.charges":a?"flags.pf2e-dailies.staff.charges":"",f=[],d=[],p=!1;if(await Promise.all(i.map(async g=>{let I=g.id,b=c&&g.statistic.label[0],w=await g.getSheetData(),T=w.isFocusPool,P=g.system?.prepared?.value==="charge",N=(()=>{if(!P)return;let O=a&&o.api.getSpellcastingEntryStaffData(g),{charges:L,max:G,canPayCost:_}=O??getProperty(g,"flags.pf2e-staves.charges")??{charges:0,max:0};return{value:L,max:G,noMax:!0,canPayCost:_??(()=>!0)}})();for(let O of w.groups){if(!O.active.length||O.uses?.max===0)continue;let L=[],G=O.id==="cantrips",_=pt(O.id);for(let M=0;M<O.active.length;M++){let X=O.active[M];if(!X||X.uses?.max===0)continue;let{spell:K,expended:R,virtual:Y,uses:ue,castRank:Ie}=X;H(K.name,e)&&L.push({name:K.name,img:K.img,tradition:b,castRank:Ie??K.rank,slotId:M,entryId:I,itemId:K.id,inputId:w.isInnate?K.id:w.id,inputPath:P?l:w.isInnate?"system.location.uses.value":`system.slots.slot${_}.value`,isCharge:P,isActiveCharge:P&&n,isVirtual:Y,isInnate:w.isInnate,isCantrip:G,isFocus:T,isPrepared:w.isPrepared,isSpontaneous:w.isSpontaneous||w.isFlexible,groupId:O.id,uses:ue??(P?N:O.uses),expended:P?!N.canPayCost(_):R??(T&&!G?s.value<=0:!1),action:K.system.time.value,type:P?`${D}.spells.staff`:w.isInnate?"PF2E.PreparationTypeInnate":w.isSpontaneous?"PF2E.PreparationTypeSpontaneous":w.isFlexible?"PF2E.SpellFlexibleLabel":T?"PF2E.TraitFocus":"PF2E.SpellPreparedLabel",order:P?0:w.isPrepared?1:T?2:w.isInnate?3:w.isSpontaneous?4:5})}if(L.length){if(T)if(G)p=!0;else{d.push(...L);continue}f[_]??=[],f[_].push(...L)}}})),f.length){let g=h("spells-sort"),I=g==="type"?(b,w)=>b.order===w.order?U(b.name,w.name):b.order-w.order:g==="entry"?(b,w)=>{let T=U(b.entryId,w.entryId);return T!==0?T:U(b.name,w.name)}:(b,w)=>U(b.name,w.name);for(let b of f)b&&b.sort(I)}d.length&&(d.sort((g,I)=>U(g.name,I.name)),f[12]=d,p=!1);let m=(await t.spellcasting.ritual?.getSheetData())?.groups.flatMap((g,I)=>g.active.map(({spell:b})=>{if(H(b.name,e))return{name:b.name,img:b.img,slotId:I,itemId:b.id,rank:b.rank,time:b.system.time.value}}).filter(Boolean));if(f.length||m?.length){let g=Kt(t),I=f.length+ +((m?.length??0)>0);return{contentData:{spells:f,rituals:m,focusPool:s,hasFocusCantrips:p,attackMod:Wt(g)?g[0].mod:null,entryRank:b=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:dt(b)})},doubled:I>1&&h("spells-columns")}}}u(qt,"getSpellsData");function Kt(t){return t.spellcasting.filter(e=>e.statistic).map(({statistic:e,name:s,id:i})=>({name:s,id:i,mod:q(e.mod),statistic:e}))}u(Kt,"getSpellAttacks");function Wt(t){return new Set(t.map(({mod:e})=>e)).size===1}u(Wt,"hasSingleSpellAttack");function Vt({el:t,actor:e,hud:s}){W(t.find(".spell")),t.find("[data-action=spell-description]").on("click",async i=>{i.preventDefault();let c=$(i.currentTarget).closest(".spell");B(c,e)}),e.isOwner&&(t.find("[data-action=spell-attack]").on("click",async i=>{i.preventDefault();let c=Kt(e);if(!c.length)return;let r;if(Wt(c))r=c[0].statistic;else{let n=await Dialog.wait({buttons:{ok:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:C("spells.attacks.ok"),callback:l=>l.find("input:checked").val()}},title:C("spells.attacks.title"),content:await renderTemplate(F("dialogs/spell-attacks"),{attacks:c}),close:()=>null});n&&(r=e.items.get(n)?.statistic)}let o=xe(i,{type:"check"}),{map:a}=i.currentTarget.dataset;a&&(o.modifiers=[new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:Number(a)})]),r?.check.roll(o)}),t.find("[data-action=spell-chat]").on("click",async i=>{i.preventDefault();let c=z(i,e);c&&(c.toMessage(i),h("chat-close")&&s.close())}),t.find("[data-action=toggle-pips]").on("click contextmenu",async i=>{i.preventDefault();let c=i.type==="click"?1:-1,r=(e.system.resources.focus?.value??0)+c;await e.update({"system.resources.focus.value":r})}),t.find("[data-action=toggle-prepared]").on("click",i=>{i.preventDefault();let{groupId:c,slotId:r,entryId:o,expended:a}=$(i.currentTarget).closest(".spell").data();e.spellcasting.collections.get(o)?.setSlotExpendedState(ft(c),r||0,a!==!0)}),t.find("[data-action=cast-spell]").on("click",i=>{i.preventDefault();let{castRank:c,slotId:r,entryId:o,itemId:a}=$(i.currentTarget).closest(".spell").data(),n=e.spellcasting.collections.get(o);if(!n)return;let l=n.get(a);l&&(n.entry.cast(l,{rank:c,slotId:r}),h("cast-close")&&s.close())}),t.find("[data-input-path]").on("change",async i=>{let{inputPath:c,entryId:r}=$(i.currentTarget).data(),o=i.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:r,[c]:o}])}))}u(Vt,"addSpellsListeners");var Ui=["#combat-popout","#sidebar","#mini-tracker","#combat-dock","#combat-carousel","[id^=pf2e-perception]"].join(", "),Yt={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},ke={opposition:{icon:"fa-solid fa-face-angry-horns",label:"PF2E.Actor.Creature.Alliance.Opposition"},party:{icon:"fa-solid fa-face-smile-halo",label:"PF2E.Actor.Creature.Alliance.Party"},neutral:{icon:"fa-solid fa-face-meh",label:"PF2E.Actor.Creature.Alliance.Neutral"}},Hi=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],zi={actions:{getData:$t,addListeners:Rt},items:{getData:Bt,addListeners:Gt},spells:{getData:qt,addListeners:Vt},skills:{getData:Ft,addListeners:Pt},extras:{getData:Mt,addListeners:Nt},hazard:{getData:zt,addListeners:_t}},be={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},_i={perception:{icon:"fa-solid fa-eye",label:"PF2E.PerceptionLabel"},stealth:{icon:"fa-duotone fa-eye-slash",label:"PF2E.SkillStealth"},athletics:{icon:"fa-solid fa-hand-fist",label:"PF2E.SkillAthletics"}},we=class extends Application{#e=null;#d=null;#i=null;#a=null;#l=!1;#o=null;#u=[!1,!1,!1];#t=!1;#s=!1;#n=!1;#p;#r;#f;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#p=(e,s)=>{s?this.#y(e):this.#k(e)},this.#r=e=>{let s=e.button;if(![0,2].includes(s))return;if(e.type==="mouseup"){this.#u[s]=!1;return}this.#u[s]=!0;let i=e.target,c=this.element[0];if(c){let r=c.querySelector(".popup");if(r&&!r.contains(i))if(!c.querySelector(".sidebar"))this.forceClose();else return r.remove();i.closest("canvas")&&this.forceClose();return}this.#g(),this.unlock(!0)},this.#f=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#r),window.addEventListener("mouseup",this.#r),Hooks.on("hoverToken",this.#p),Hooks.on("deleteToken",this.#f),Hooks.on("canvasPan",this.forceClose)}setToken(e,s){if(e!==this.#e){delete this.#e?.actor?.apps[this.appId],this.#e=e;let i=e?.actor;i&&(i.apps[this.appId]=this)}this.#n=s??this.#m(e)}setHolding(e){let s=h("key-holding");if(s!=="none"&&(this.#l=e,!(this.#s||this.#t)))if(e){if(!this.#i)return;let i=this.#m(this.#i);if(s==="half"&&!game.user.isGM&&!i){this.#g(),this.render();return}this.setToken(this.#i,i),this.render()}else s==="all"?this.close():game.user.isGM?(this.setToken(this.#i),this.render()):this.#n&&this.close()}#m(e){let s=e?.actor;if(!s)return!1;let i,c=s.system.details.alliance==="party";return game.user.isGM&&h("key-holding")==="half"&&!this.#l||s.isOfType("familiar")&&!s.master?i=!1:i=e.isOwner||h("observer")&&(e.observer||c&&h("party")),i}#y(e){if($(window.document).find(":hover").filter(Ui).length)return;let s=e.actor;if(!s||s.isOfType("loot","party")||e.document.disposition===CONST.TOKEN_DISPOSITIONS.SECRET&&!s.isOwner||s.isOfType("npc")&&h("no-dead")&&s.isDead||(this.#i=e,e!==this.#d&&!this.#t&&this.close(),this.mousedown||this.#t||this.#s||e===this.#e))return;let i=h("key-holding"),c=this.#m(e);i!=="none"&&!this.#l&&(i==="all"||c)||(this.#b(!0),this.setToken(e,c),i==="none"||!this.#l?this.renderWithDelay():this.render())}#k(e){this.#i=null,!(this.mousedown||this.#t||this.#s)&&(this.#o=setTimeout(()=>{this.#o=null,!(this.#s||this.#t)&&this.close()},10))}renderWithDelay(){let e=h("delay");e?(e<10&&(e=10),this.#a=setTimeout(()=>{this.#a=null,this.render()},e)):this.render()}#b(e){this.#o!==null&&(clearTimeout(this.#o),this.#o=null,e&&this.close())}#g(){this.#a!==null&&(clearTimeout(this.#a),this.#a=null)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#r),window.removeEventListener("mouseup",this.#r),Hooks.off("hoverToken",this.#p),Hooks.off("deleteToken",this.#f),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(Application.defaultOptions,{popOut:!1,minimizable:!1,template:F("hud")})}get mousedown(){return this.#u[0]||this.#u[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return!!qe(this.actor)}get sidebar(){return this.element?.find("> .sidebar")??[]}get popup(){return this.element?.find("> .popup")??[]}get inner(){return this.element?.find("> .inner")??[]}async getData(){let e=this.#e,s=this.#e?.actor;if(!s)return{};let i=null,c=h("saves"),r=h("others"),o=s.isOfType("character"),{attributes:a}=s,{hp:n,ac:l}=a,f=n.sp??{max:0,value:0},d=game.settings.get("pf2e","staminaVariant"),p=h("distance"),k=h("scale");if(p==="all"||p==="self"&&this.#n){let v=h("unit").split(","),A=Number(v[0]?.trim())||1,x=v[1]?.trim()||game.system.gridUnits,E=Number(v[2]?.trim())||0,j=canvas.tokens.controlled,Z=!1,ee=j.length===1?j[0]:null;(!ee||ee===e)&&(ee=Ne(),Z=!0),ee&&ee!==e&&(i={unit:x,icon:Z?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(ee)*A).toFixed(E)})}let m;if(!this.#n||h("see-status")){let v=h("status").split(",").map(A=>A.trim()).filter(Boolean);if(v.length&&n.max){let A=n.max+(d?f.max:0),x=n.value+(d?f.value:0),E=Math.clamped(x/A,0,1),j=(()=>{let Z=v.length;return h("last-status")?E===1?Z:Math.ceil(E*(Z-1)):Math.ceil(E*Z)})();m={hue:E*E*122+3,value:j===0?game.i18n.localize("EFFECT.StatusDead"):v.at(j-1)}}}let g={status:m,distance:i,fontSize:k,tokenId:e.id,type:s.isOfType("creature")?"creature":s.type};if(!this.#n||s.isOfType("familiar")&&!s.master)return g;let{level:I,saves:b,isOwner:w,system:T,itemTypes:P}=s,{resistances:N,weaknesses:O,immunities:L}=a;if(g={...g,isOwner:w,isObserver:this.#n,name:e.document.name,hp:n,level:I},s.isOfType("army")){let v="Vqp8b64uH35zkncy",x=(await game.packs.get("pf2e.kingmaker-features")?.getDocuments({type:"campaignFeature"})??[]).filter(E=>E instanceof Item&&E.isOfType("campaignFeature"));return g={...g,basicWarActions:x.filter(E=>E.system.category==="army-war-action"&&E.folder?.id===v).map(E=>new CONFIG.Item.documentClass(E.toObject(!0),{parent:this.actor})).filter(E=>E.isOfType("campaignFeature"))},g}g={...g,ac:l.value,hasActions:P.action.length||T.actions?.filter(v=>v.visible!==!1).length};let G=h("ranks");function _(v,A,x){let E=v.slug,j=A==="bonus"?q(v.mod):v.dc.value;return{slug:E,value:j,label:x[E].label,icon:x[E].icon,rank:G&&Fe[v.rank]}}u(_,"getStatistic");function M(v,A){if(!v.length)return"";let x=v.map(E=>Be(E.label.replace("-"," ").titleCase())).join("");return A?`<li>${game.i18n.localize(A)}<ul>${x}</ul></li>`:x}if(u(M,"toIWR"),s.isOfType("hazard")){let{hardness:v,emitsSound:A,stealth:x}=a;return{...g,hardness:v,emitsSound:A.toString().capitalize(),immunities:M(L),weaknesses:M(O),resistances:M(N),stealth:{value:x.value,details:await te(x.details,s)},saves:c!=="none"&&["fortitude","reflex","will"].map(E=>{let j=b[E];return j?_(j,c,be):{slug:E,label:be[E].label,icon:be[E].icon}})}}if(g={...g,sidebarTitles:{actions:`${D}.actions.title`,items:`${D}.items.title`,spells:`${D}.spells.title`,skills:`${D}.skills.title`,extras:`${D}.extras.title`},hasItems:s.inventory.size},s.isOfType("vehicle")){let{hardness:v,collisionDC:A,collisionDamage:x}=a,{details:E}=T,{crew:j,passengers:Z,pilotingCheck:ee,speed:ci}=E;return{...g,hardness:v,crew:j,passengers:Z,pilotingCheck:ee,speed:ci,collisionDC:A.value,collisionDamage:x.value,immunities:M(L),weaknesses:M(O),resistances:M(N),fortitude:_(b.fortitude,c,be)}}let X=h("show-death"),{heroPoints:K}=s,{resources:R,perception:Y,details:ue}=T,{wounded:Ie,dying:tt,shield:si,speed:ve,adjustment:ni}=a;function Be(v){return`<li>${v.trim()}</li>`}u(Be,"toInfo");function ai(v,A){return U(v,A)}u(ai,"sort");let oi=ue?.languages?.value.map(v=>game.i18n.localize(CONFIG.PF2E.languages[v])).filter(Boolean).sort(ai).map(Be).join(""),de=Hi.map(({type:v,icon:A},x)=>({index:x,icon:A,label:game.i18n.localize(CONFIG.PF2E.speedTypes[v]??"PF2E.SpeedTypesLand"),value:(x===0?ve.total:ve.otherSpeeds.find(E=>E.type===v)?.total)||0})),it=Q(s,`speeds.selected.${game.user.id}`),ri=(()=>{let v=0;if(it!==void 0)v=it;else if(h("force-speed")||de[0].value===0){let A={index:0,value:de[0].value};v=de.reduce((x,{value:E},j)=>E>x.value?{index:j,value:E}:x,A).index}return de.splice(v,1)[0]})(),st=de.map(({value:v,label:A,index:x})=>`<li><a data-value="${x}">${A}: ${v}</a></li>`).join("");return ve.details&&(st+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${ve.details}</li>`),{...g,sp:d?f:{max:0},hero:K,dying:tt,wounded:Ie,shield:si,resolve:R.resolve,adjustment:ni,alliance:ke[Jt(s).alliance],isCharacter:o,showDeathLine:o&&(X==="always"||tt.value||Ie.value),digitalPips:h("pips"),hasCover:this.hasCover,saves:c!=="none"&&["fortitude","reflex","will"].map(v=>_(b[v],c,be)),others:r!=="none"&&["perception","stealth","athletics"].map(v=>_(s.getStatistic(v),r,_i)),speeds:{main:ri,others:st},iwr:M(L,"PF2E.ImmunitiesLabel")+M(O,"PF2E.WeaknessesLabel")+M(N,"PF2E.ResistancesLabel"),senses:Y.senses.map(v=>v.label)?.map(Be).join(""),languages:oi,hasSpells:s.spellcasting.some(v=>v.category!=="items"),hasNotes:!o&&(T.details.publicNotes||T.details.privateNotes&&w)}}close(e={}){this.setToken(null),this.unlock(!0),this.#s=!1,this.#g();let s=Application.RENDER_STATES;if(!e.force&&![s.RENDERED,s.ERROR].includes(this._state))return;this._state=s.CLOSING;let i=this.element;if(!i)return this._state=s.CLOSED,this._state;i.css({minHeight:0});for(let c of this.constructor._getInheritanceChain())Hooks.call(`close${c.name}`,this,i);i.remove(),this._element=null,this._state=s.CLOSED,delete ui.windows[this.appId]}async _render(e=!1,s={}){let i,c,r,o,a;if(this.#d===this.#e){let n=this.sidebar[0];if(n){i=n.dataset.type,c=n.scrollTop;let l=n.querySelector(".sidebar-header");l.classList.contains("show")&&(a=l.querySelector(" input").value.trim())}r=this.popup[0],r&&(o=r.scrollTop)}if(await super._render(e,s),ui.windows[this.appId]=this,i){let n=await this.#c(i,a);c>0&&n.scrollTop(c)}r&&(this.element.append(r),o>0&&(r.scrollTop=o)),this.#d=this.#e,this.inner.length&&h("autolock")==="render"&&this.lock()}render(){this.actor&&super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let s=this.element[0],i=e.worldTransform.a,c=s.getBoundingClientRect(),r=canvas.clientCoordinatesFromCanvas(e.document._source),o={x:r.x,y:r.y,width:e.hitArea.width*i,height:e.hitArea.height*i,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},a,n=this.#n?Yt[h("position")].slice():Yt[h("small-position")].slice();for(;n.length&&!a;){let l=n.shift();l==="left"?(a={x:o.x-c.width,y:et(c,o)},a.x<0&&(a=void 0)):l==="right"?(a={x:o.right,y:et(c,o)},a.x+c.width>window.innerWidth&&(a=void 0)):l==="top"?(a={x:Qt(c,o),y:o.y-c.height},a.y<0&&(a=void 0)):l==="bottom"&&(a={x:Qt(c,o),y:o.bottom},a.y+c.height>window.innerHeight&&(a=void 0))}return a&&(s.style.left=`${a.x}px`,s.style.top=`${a.y}px`),a}lock(){this.#t=!0}unlock(e){!e&&(this.sidebar.length||h("autolock")!=="none")||(this.#t=!1)}activateListeners(e){let s=this.#e,i=s?.actor;if(!i)return;let c=s.isOwner,r=ChatMessage.implementation;h("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.find("[data-action=show-notes").on("click",async n=>{n.preventDefault();let{publicNotes:l,privateNotes:f,blurb:d}=i.system.details,p=i.system.traits.value.map(m=>({label:game.i18n.localize(CONFIG.PF2E.creatureTraits[m])??m,description:game.i18n.localize(CONFIG.PF2E.traitsDescriptions[m])??""})),k=await renderTemplate(F("show-notes"),{traits:p,blurb:d.trim(),publicNotes:l.trim(),privateNotes:c&&f.trim()});se(`${i.name} - ${game.i18n.localize("PF2E.NPC.NotesTab")}`,k,i)}),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(h("autolock")==="hover"&&this.lock(),this.#s=!0)}),e.on("mouseleave",()=>{this.#s=!1,!(this.#t||this.#i)&&this.close()}),e.on("dragover",()=>{s.isOwner&&e.find("> .sidebar.extras").length&&!e.find("> .popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let o=e.find("[data-action=show-info]");(c?o.filter(":not(.speeds)"):o).on("click",n=>{let l=n.currentTarget,f=l.dataset.tooltipContent;l.classList.contains("stealth")?this.#h({content:f,event:n,direction:"DOWN"}):ye({target:l,content:f,direction:"UP"})}),e.find("[data-action=open-sidebar]").on("click",this.#c.bind(this)),c&&(e.find("[data-action=toggle-adjustment]").on("click contextmenu",n=>{n.preventDefault();let l=n.type==="click"?"elite":"weak";i.applyAdjustment(i.system.attributes.adjustment===l?null:l)}),e.find("[data-action=toggle-alliance]").on("click",n=>{let{originalAlliance:l,defaultAlliance:f}=Jt(i),d=[{value:"default",label:game.i18n.format("PF2E.Actor.Creature.Alliance.Default",{alliance:game.i18n.localize(ke[f].label)})},{value:"opposition",label:game.i18n.localize(ke.opposition.label)},{value:"party",label:game.i18n.localize(ke.party.label)},{value:"neutral",label:game.i18n.localize(ke.neutral.label)}];this.#h({content:d,event:n,selected:l,onClick:p=>{p==="default"?i.update({"system.details.-=alliance":!0}):i.update({"system.details.alliance":p==="neutral"?null:p})}})}),e.find("[data-action=collision-dc]").on("click",n=>{n.preventDefault();let l=i.system.attributes.collisionDC.value||15;r.create({content:`@Check[type:reflex|dc:${l}]`,speaker:r.getSpeaker({actor:i})})}),e.find("[data-action=collision-damage]").on("click",async n=>{n.preventDefault();let l=(i.system.attributes.collisionDamage.value||"1d6").trim();Number.isNaN(Number(l.at(-1)))||(l+="[bludgeoning]");let f=at(),d=await new f(l).evaluate({async:!0});r.create({flavor:`<strong>${game.i18n.localize("PF2E.vehicle.collisionDamageLabel")}</strong>`,speaker:r.getSpeaker({actor:i}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:"sounds/dice.wav",rolls:[d]})}),e.find("input").on("change",async n=>{let l=n.currentTarget,f=l.valueAsNumber,d=l.name;l.blur(),d!=="shield.value"?await i.update({[d]:f}):await i.heldShield.update({"system.hp.value":f})}),e.find("[data-action=toggle-hero]").on("click contextmenu",n=>{n.preventDefault();let{max:l,value:f}=i.heroPoints,d=n.type==="click"?1:-1,p=Math.clamped(f+d,0,l);p!==f&&i.update({"system.resources.heroPoints.value":p})}),e.find("[data-action=raise-shield]").on("click",n=>{n.preventDefault(),game.pf2e.actions.raiseAShield({actors:[i],tokens:[s]})}),e.find("[data-action=take-cover]").on("click",async n=>{n.preventDefault();let l=qe(i);l?l.delete():game.pf2e.actions.get("take-cover").use({actors:[i],tokens:[s]})}),e.find("[data-action=roll-save]").on("click",n=>{n.preventDefault();let l=n.currentTarget.dataset.save;i.saves[l].roll({event:n})}),e.find("[data-action=roll-other]").on("click",n=>{n.preventDefault();let l=n.currentTarget.dataset.slug;if(l!=="athletics"){let{ctrlKey:f,metaKey:d,shiftKey:p}=n;n=new MouseEvent("click",{ctrlKey:!f,metaKey:d,shiftKey:p})}i.getStatistic(l)?.roll({event:n})}),e.find("[data-action=recovery-check]").on("click",n=>{n.preventDefault(),i.rollRecovery(n)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",n=>{n.preventDefault();let l=n.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",f=i.system.attributes[l]?.max;f&&(n.type==="click"?i.increaseCondition(l,{max:f}):i.decreaseCondition(l))}),e.find("[data-action=use-resolve]").on("click",n=>{n.preventDefault(),nt(i)}),o.filter(".speeds").on("click",n=>{this.#h({event:n,content:n.currentTarget.dataset.tooltipContent,direction:"UP",onClick:l=>{ie(i,`speeds.selected.${game.user.id}`,Number(l))}})}))}#h({content:e,event:s,onClick:i,selected:c,direction:r}){ye({content:e,target:s.currentTarget,direction:r,selected:c,locked:!0,onCreate:()=>this.lock(),onClick:i,onDismiss:()=>this.unlock()})}async showFilter(){let e=this.sidebar;e.length&&(e.find(".sidebar-header").hasClass("show")||(e=await this.#c(e.data().type,"")),e.find(".sidebar-header").find("input").focus().select(),e.scrollTop(0))}async#c(e,s){let i=typeof e=="string"?e:e.currentTarget.dataset.type,c=this.element,r=this.sidebar,o=r[0]?.dataset.type;if(r.remove(),c.find("[data-action=open-sidebar]").removeClass("active"),o===i&&s===void 0){this.unlock();return}let a=this.#e,n=a.actor,l=s!==void 0||h("filter"),{getData:f,addListeners:d}=zi[i],p=await f({hud:this,actor:n,token:a,filter:s?.toLowerCase()})??{};if(!p.contentData&&!l)return ui.notifications.warn(C(`${i}.empty`,{name:this.#e.name}));let k={...p.contentData??{},isGM:game.user.isGM,isCharacter:n.isOfType("character"),isOwner:n.isOwner,isCreature:n.isOfType("creature")};this.lock(),c.find(`[data-action=open-sidebar][data-type=${i}]`).addClass("active"),c=c[0];let m=p.classes??[];m.push(i),h("scrollbar")||m.push("no-scrollbar"),p.doubled&&m.push("doubled");let g=p.style??{};g["--max-height"]=h("height").trim()||"100%";let I=document.createElement("div");I.innerHTML=await renderTemplate(F("sidebar"),{classes:m.join(" "),style:Object.entries(g).map(([L,G])=>`${L}: ${G}`).join("; "),type:i,filter:s,filterLabel:C("filter"),showFilter:l,content:(await renderTemplate(F(`sidebars/${i}`),k)).trim()}),r=I.firstElementChild,c.append(r);let b=r.getBoundingClientRect(),w=c.getBoundingClientRect(),T;h("position")==="left"?(T=w.x-b.width,T<0&&(T=w.right)):(T=w.right,T+b.width>window.innerWidth&&(T=w.x-b.width));let N=parseInt(window.getComputedStyle(c).padding),O=et(b,w,N);return r.style.left=`${T}px`,r.style.top=`${O}px`,r=$(r),r.find(".sidebar-header [data-action=sidebar-filter-clear]").on("click",L=>{L.preventDefault(),r.find(".sidebar-header [data-action=sidebar-filter]").val(""),this.#c(i,"")}),r.find(".sidebar-header [data-action=sidebar-filter]").on("keydown",L=>{L.key==="Enter"&&this.#c(i,L.currentTarget.value.trim())}),d({el:r,actor:n,token:a,hud:this}),Hooks.callAll("renderHUDSidebar",i,r,this),r}};u(we,"HUD");function et(t,e,s=0){let i=e.y+e.height/2-t.height/2;return i+t.height>window.innerHeight&&(i=window.innerHeight-t.height-s),i<0&&(i=s),i}u(et,"postionFromTargetY");function Qt(t,e){let s=e.x+e.width/2-t.width/2;return s+t.width>window.innerWidth&&(y=window.innerWidth-t.width),s<0&&(s=0),s}u(Qt,"postionFromTargetX");function Jt(t){let e=t._source.system.details?.alliance,s=e===null?"neutral":e??"default",i=t.hasPlayerOwner?"party":"opposition";return{defaultAlliance:i,originalAlliance:s,alliance:s==="default"?i:s}}u(Jt,"getAlliance");var D="pf2e-token-hud",ae=null;function J(t=!1){return t?ae?.element:ae}u(J,"getHud");function _e(t){t&&!ae?ae=new we:!t&&ae&&(ae.delete(),ae=null)}u(_e,"enableModule");function h(t){return game.settings.get(D,t)}u(h,"getSetting");function C(...t){let e=t.at(-1),s=typeof e=="object",i=s?t.slice(0,-1):t;return i.unshift(D),game.i18n[s?"format":"localize"](i.join("."),e)}u(C,"localize");function Ve(t,e){return t.itemTypes.feat.some(s=>s.sourceId===e)}u(Ve,"hasFeat");function F(t){return`modules/${D}/templates/${t}.hbs`}u(F,"templatePath");function q(t){return t>=0?`+${t}`:t}u(q,"modifier");function Q(t,e){return t.getFlag(D,e)}u(Q,"getFlag");function ie(t,e,s){return t.setFlag(D,e,s)}u(ie,"setFlag");async function te(t,e,{isOwner:s=e.isOwner,rollData:i=e.getRollData()}={}){let c=t?.trim();return c?await TextEditor.enrichHTML(c,{async:!0,secrets:s,rollData:i}):""}u(te,"enrichHTML");function fe(t,e){if(typeof t!="object")return!1;let s=Reflect.getPrototypeOf(t);for(;s;){if(s.constructor.name===e)return!0;s=Reflect.getPrototypeOf(s)}return!1}u(fe,"isInstanceOf");function ei(){Zt("hold",{onDown:()=>{h("key-holding")!=="none"&&J()?.setHolding(!0)},onUp:()=>{J()?.setHolding(!1)}}),Zt("filter",{onUp:()=>{J()?.showFilter()},editable:[{key:"KeyQ",modifiers:["Control"]}]})}u(ei,"registerKeybindings");function Xt(t,e){return`${D}.keybinds.${t}.${e}`}u(Xt,"path");function Zt(t,e={}){game.keybindings.register(D,t,{name:Xt(t,"name"),hint:Xt(t,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}u(Zt,"register");function ti(){let t=game.data.users.find(s=>s._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(s=>C(`settings.status.statuses.${s}`)).join(", ");S("status",String,e,{scope:"world"}),S("last-status",Boolean,!1,{scope:"world"}),S("party",Boolean,!1,{scope:"world"}),S("rk-dice",Boolean,!1,{scope:"world"}),S("enabled",Boolean,!0,{onChange:_e}),S("position",String,"right",{choices:["left","right","top","bottom"]}),S("small-position",String,"top",{choices:["left","right","top","bottom"]}),S("delay",Number,250,{range:{min:0,max:2e3,step:50}}),S("scale",Number,14,{range:{min:10,max:30,step:1}}),S("key-holding",String,"none",{hint:oe("key-holding",t?"choices.gm.hint":"choices.player.hint"),choices:{none:oe("key-holding","choices.none"),half:oe("key-holding",t?"choices.gm.half":"choices.player.half"),all:oe("key-holding",t?"choices.gm.all":"choices.player.all")}}),S("autolock",String,"none",{choices:["none","hover","render"]}),S("chat-close",Boolean,!1),S("attack-close",Boolean,!1),S("action-close",Boolean,!1),S("cast-close",Boolean,!1),S("skill-close",Boolean,!1),S("macro-close",Boolean,!1),S("use-close",Boolean,!1),S("no-dead",Boolean,!1),S("observer",Boolean,!0),S("see-status",Boolean,!1),S("saves",String,"bonus",{choices:["none","bonus","dc"]}),S("others",String,"none",{choices:["none","bonus","dc"]}),S("ranks",Boolean,!1),S("show-death",String,"always",{choices:["none","always","only"]}),S("force-speed",Boolean,!1),S("tooltips",Boolean,!1),S("pips",Boolean,!1),S("distance",String,"all",{choices:["none","self","all"]}),S("unit",String,""),S("height",String,""),S("filter",Boolean,!1),S("scrollbar",Boolean,!0),S("hazard-width",Number,32,{range:{min:14,max:50,step:1}}),S("actions-columns",Boolean,!1),S("items-columns",Boolean,!1),S("spells-columns",Boolean,!1),S("skills-columns",Boolean,!1),S("actions",String,"split",{choices:["name","type","split"]}),S("action-effect",Boolean,!1),S("containers",Boolean,!1),S("spells-sort",String,"disabled",{choices:["disabled","type","entry"]}),S("tradition",Boolean,!1),S("untrained",Boolean,!0)}u(ti,"registerSettings");function ii(t,e){let s=e.find(`.tab[data-tab=${D}]`);function i(c,r,o="h3"){let a=C(`menu.${r}`);s.find(`[name="${D}.${c}"]`).closest(".form-group").before(`<${o}>${a}</${o}>`)}u(i,"beforeGroup"),game.user.isGM&&i("enabled","client.header","h2"),i("saves","client.tooltip"),i("distance","client.distance"),i("height","client.sidebar"),i("actions","client.actions"),i("containers","client.items"),i("spells-sort","client.spells"),i("untrained","client.skills")}u(ii,"renderSettingsConfig");function oe(t,e){return`${D}.settings.${t}.${e}`}u(oe,"path");function S(t,e,s,i={}){Array.isArray(i.choices)&&(i.choices=i.choices.reduce((c,r)=>(c[r]=oe(t,`choices.${r}`),c),{})),game.settings.register(D,t,{name:oe(t,"name"),hint:oe(t,"hint"),scope:"client",config:!0,type:e,default:s,...i})}u(S,"register");Hooks.once("setup",async()=>{ti(),ei(),await loadTemplates({creature:F("tooltips/creature"),hazard:F("tooltips/hazard"),vehicle:F("tooltips/vehicle"),army:F("tooltips/army")})});Hooks.once("ready",()=>{h("enabled")&&_e(!0),game.modules.get("pf2e-token-hud").api={getHud:J}});Hooks.on("renderSettingsConfig",ii);Hooks.on("drawMeasuredTemplate",t=>{t.isPreview&&J()?.close()});Hooks.on("getActorDirectoryEntryContext",(t,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${D}.actor.macros.contextmenu`,condition:s=>{let{documentId:i}=s.data();return h("enabled")&&game.actors.get(i)?.isOwner},callback:s=>{let{documentId:i}=s.data();ji(i)}})});var je=class extends Dialog{async getData(e={}){let s=super.getData(e);return typeof s.content=="function"&&(s.content=await s.content()),s}};u(je,"DataDialog");function ji(t){let e=game.actors.get(t);if(!e)return;let s=new je({title:`${e.name} - ${C("actor.macros.title")}`,content:async()=>{let i=Pe(e)??[];return renderTemplate(F("dialogs/macros"),{macros:i,noMacro:C("extras.no-macro")})},buttons:{},render:i=>{e.apps[s.appId]=s,i.on("drop",c=>Le(c,e)),i.find("[data-action=delete-macro]").on("click",c=>Me(c,e))},close:()=>{delete e.apps[s.appId]}},{height:"auto"}).render(!0)}u(ji,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
