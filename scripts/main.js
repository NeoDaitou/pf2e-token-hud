(()=>{var ls=Object.defineProperty;var u=(t,e)=>ls(t,"name",{value:e,configurable:!0});var us="Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo";async function st(t){function e(p){ChatMessage.create({user:game.user.id,content:p,speaker:ChatMessage.getSpeaker({actor:t})})}u(e,"toChat");let{name:s,attributes:i,system:a}=t,c=i.hp.sp,r=a.resources.resolve,o=C("hud.resolve.full",{name:s}),n=game.i18n.format("PF2E.Actions.SteelYourResolve.NoStamina",{name:s});if(c.value===c.max)return ui.notifications.warn(o);if(r.value<1)return ui.notifications.warn(n);let l=t.itemTypes.feat.find(p=>p.sourceId===us),d=await renderTemplate(F("dialogs/resolve"),{hasSteel:l,i18n:p=>C(`hud.resolve.${p}`)});new Dialog({title:C("hud.resolve.title"),content:d,buttons:{yes:{icon:"<i class='fas fa-check'></i>",label:C("hud.resolve.yes"),callback:async p=>{let{attributes:f,system:m}=t,g=f.hp.sp,v=m.resources.resolve;if(g.value===g.max)return e(o);if(v.value<1)return e(n);let b=p.find("input:checked").val(),k=`${g.value}/${g.max}`;if(b==="breather")e(C("hud.resolve.breather.used",{name:s,ratio:k})),await t.update({"system.attributes.hp.sp.value":g.max,"system.resources.resolve.value":v.value-1});else{e(game.i18n.format("PF2E.Actions.SteelYourResolve.RecoverStamina",{name:s,ratio:k}));let w=g.value+Math.floor(g.max/2);await t.update({"system.attributes.hp.sp.value":Math.min(w,g.max),"system.resources.resolve.value":v.value-1})}}},no:{icon:"<i class='fas fa-times'></i>",label:C("hud.resolve.no")}}}).render(!0)}u(st,"useResolve");function it(){return CONFIG.Dice.rolls.find(t=>t.name==="DamageRoll")}u(it,"getDamageRollClass");function Q(){return CONFIG.ChatMessage.documentClass}u(Q,"getChatMessageClass");function nt(){return CONFIG.MeasuredTemplate.documentClass}u(nt,"getMeasuredTemplateDocumentClass");function at(){return CONFIG.MeasuredTemplate.objectClass}u(at,"getMeasuredTemplateObjectClass");var ds=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),ps=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function fs(t,e="normal"){return t+(ds.get(e)??0)}u(fs,"adjustDC");function ms(t="common"){switch(t){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}u(ms,"rarityToDCAdjustment");function we(t,e="common"){return fs(t,ms(e))}u(we,"adjustDCByRarity");function ke(t,{proficiencyWithoutLevel:e,rarity:s="common"}={}){let i=game.settings.get("pf2e","proficiencyVariant");e??=i==="ProficiencyWithoutLevel";let a=ps.get(t)??14;return we(e?a-Math.max(t,0):a,s)}u(ke,"calculateDC");function ce(t,e){return t instanceof Element||t instanceof Document?Array.from(t.querySelectorAll(e)):[]}u(ce,"htmlQueryAll");function _e(t,e){return t instanceof Element?t.closest(e):null}u(_e,"htmlClosest");var ot={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"},gs={0:"F",free:"F",1:"A",2:"D",3:"T","1 or 2":"A/D","1 to 3":"A - T","2 or 3":"D/T",reaction:"R"};function rt(t,e="systems/pf2e/icons/actions/Empty.webp"){if(t===null)return ot.passive;let s=typeof t!="object"?t:t.type==="action"?t.value:t.type,i=String(s??"").toLowerCase().trim();return ot[i]??e}u(rt,"getActionIcon");function Ie(t){if(!t&&t!==0)return"";let e=typeof t!="object"?t:t.type==="action"?t.value:t.type,s=String(e??"").toLowerCase().trim();return gs[s]??""}u(Ie,"getActionGlyph");function le(t){return Error(`PF2e System | ${t}`)}u(le,"ErrorPF2e");function ct(t,e){return t.includes(e)}u(ct,"tupleHasValue");function hs(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}u(hs,"objectHasKey");var ve=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,je=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,ys=new RegExp(je,"gu"),bs=String.raw`(?:${ve})(?=${je})|(?:${je})(?=${ve})`,ws=String.raw`(?:${ve})(?=${ve})`,lt=String.raw`\p{Lowercase_Letter}`,ut=String.raw`\p{Uppercase_Letter}`,ks=new RegExp(`(${lt})(${ut}${ws})`,"gu"),vs=/[^-\p{White_Space}\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]/gu,Is=new RegExp(`${ut}|(?:${bs})${lt}`,"gu");function ze(t,{camel:e=null}={}){if(typeof t!="string")return console.warn("Non-string argument passed to `sluggify`"),"";if(t==="-")return t;switch(e){case null:return t.replace(ks,"$1-$2").toLowerCase().replace(/['â€™]/g,"").replace(ys," ").trim().replace(/[-\s]+/g,"-");case"bactrian":{let s=ze(t,{camel:"dromedary"});return s.charAt(0).toUpperCase()+s.slice(1)}case"dromedary":return t.replace(vs,"").replace(/[-_]+/g," ").replace(Is,(s,i)=>i===0?s.toLowerCase():s.toUpperCase()).replace(/\s+/g,"");default:throw le("I don't think that's a real camel.")}}u(ze,"sluggify");function dt(t,e){let s={name:t,label:game.i18n.localize(e[t]??t)};return hs(CONFIG.PF2E.traitsDescriptions,t)&&(s.description=CONFIG.PF2E.traitsDescriptions[t]),s}u(dt,"traitSlugToObject");function pt(t){let e=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),s=game.i18n.localize(`PF2E.OrdinalSuffixes.${e.select(t)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:t,suffix:s})}u(pt,"ordinalString");function Cs(t){return!!t&&"ctrlKey"in t&&"metaKey"in t&&"shiftKey"in t}u(Cs,"isRelevantEvent");function Ce(t){let e=!game.user.settings.showRollDialogs;if(!Cs(t))return{skipDialog:e};let s={skipDialog:t.shiftKey?!e:e};return(t.ctrlKey||t.metaKey)&&(s.rollMode=game.user.isGM?"gmroll":"blindroll"),s}u(Ce,"eventToRollParams");var Ss=["fortitude","reflex","will"],mt=["action","check","effect-area"].map(t=>`[data-pf2-${t}]`).join(",");function Ts(t,e){for(let s of t){(!e||e.isOwner)&&s.classList.add("with-repost");let i=ce(s,"i[data-pf2-repost]");if(i.length>0){if(e&&!e.isOwner){for(let r of i)r.remove();s.classList.remove("with-repost")}continue}if(e&&!e.isOwner)continue;let a=document.createElement("i"),c=s.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";a.classList.add("fa-solid",c),a.dataset.pf2Repost="",a.title=game.i18n.localize("PF2E.Repost"),s.appendChild(a),a.addEventListener("click",r=>{r.stopPropagation();let o=r.target;if(!(o instanceof HTMLElement))return;let n=o?.parentElement;if(!n)return;let l=gt(o,e);Ds(n,l)})}}u(Ts,"injectRepostElement");function Es(t,e=null){for(let s of ce(t,"a.inline-roll[data-damage-roll]")){let i=_e(s,"[data-item-id]")?.dataset.itemId,a=e?.items.get(i??"");a&&(s.dataset.flavor||=a.name)}}u(Es,"flavorDamageRolls");function ft(t,e){let s=t.attributes.getNamedItem("data-pf2-repost-flavor")?.value??"";return`<span data-visibility="${t.attributes.getNamedItem("data-pf2-show-dc")?.value??e}">${s}</span> ${t.outerHTML}`.trim()}u(ft,"makeRepostHtml");function Ds(t,e=null){if(!["pf2Action","pf2Check","pf2EffectArea"].some(l=>l in t.dataset))return;let s=ht(e,t),i=(s??e)?.hasPlayerOwner?"all":"gm",a=(()=>t.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${ce(t.parentElement,mt).map(d=>ft(d,i)).join("<br>")}</div>`:ft(t,i))(),c=Q(),r=s?c.getSpeaker({actor:s,token:s.getActiveTokens(!1,!0).shift()}):c.getSpeaker(),o=game.messages.get(_e(t,"[data-message-id]")?.dataset.messageId??""),n=e instanceof JournalEntry?{pf2e:{journalEntry:e.uuid}}:o?.flags.pf2e.origin?{pf2e:{origin:deepClone(o.flags.pf2e.origin)}}:{};c.create({speaker:r,content:a,flags:n})}u(Ds,"repostAction");function Te(t,e){e??=gt(t,e);let s=ce(t,mt).filter(a=>["A","SPAN"].includes(a.nodeName));Ts(s,e),Es(t,e instanceof Actor?e:null);for(let a of s.filter(c=>c.dataset.pf2Action)){let{pf2Action:c,pf2Glyph:r,pf2Variant:o,pf2Dc:n,pf2ShowDc:l,pf2Skill:d}=a.dataset;a.addEventListener("click",p=>{let f=game.pf2e.actions[c?ze(c,{camel:"dromedary"}):""],m=l??"all";c&&f?f({event:p,glyph:r,variant:o,difficultyClass:n?{scope:"check",value:Number(n)||0,visibility:m}:void 0,skill:d}):console.warn(`PF2e System | Skip executing unknown action '${c}'`)})}for(let a of s.filter(c=>c.dataset.pf2Check&&!c.dataset.invalid)){let{pf2Check:c,pf2Dc:r,pf2Traits:o,pf2Label:n,pf2Defense:l,pf2Adjustment:d,pf2Roller:p,pf2RollOptions:f}=a.dataset;if(!c)return;a.addEventListener("click",async m=>{let g=ht(e,a),v=[g],b=[...o?.split(",").map(w=>w.trim())??[],...f?.split(",").map(w=>w.trim())??[]],k=Ce(m);switch(c){case"flat":{for(let w of v){let E=new Statistic(w,{label:"",slug:"flat",modifiers:[],check:{type:"flat-check"}}),O=Number.isInteger(Number(r))?{label:n,value:Number(r)}:null;E.roll({...k,extraRollOptions:b,dc:O})}break}default:{let w=ct(Ss,c),E=w?[]:b.filter(O=>O in CONFIG.PF2E.actionTraits)??[];for(let O of v){let M=(()=>{if(c in CONFIG.PF2E.magicTraditions){let P=O.spellcasting.filter(J=>J.tradition===c).flatMap(J=>J.statistic??[]).sort((J,Ue)=>Ue.check.mod-J.check.mod).shift()??null;if(P)return P}return O.getStatistic(c)})();if(!M){console.warn(le(`Skip rolling unknown statistic ${c}`).message);continue}let N=l?game.user.targets.first()?.actor:null,R=(()=>{let P=Number(d)||0;return r==="@self.level"?ke(O.level)+P:Number(r??"NaN")+P})(),G=(()=>{if(Number.isInteger(R))return{label:n,value:R};if(l){let P=N?.getStatistic(l);return P?{statistic:P.dc,scope:"check",value:P.dc.value}:null}return null})(),W=(()=>{let P=e instanceof Item?e:e instanceof ChatMessage?e.item:null;return P?.isOfType("action","feat","campaignFeature")||w&&!P?.isOfType("weapon")?P:null})(),_={...k,extraRollOptions:b,origin:w&&g instanceof Actor?g:null,dc:G,target:!w&&G?.statistic?N:null,item:W,traits:E};if(!!(W?.isOfType("action","feat")&&W.actionCost)&&l){let P=c in CONFIG.PF2E.magicTraditions?"PF2E.ActionsCheck.spell":M.check.type==="attack-roll"?"PF2E.ActionsCheck.x-attack-roll":"PF2E.ActionsCheck.x";_.label=await renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:Ie(W.actionCost),subtitle:game.i18n.format(P,{type:M.label}),title:W.name})}M.roll(_)}}}})}let i={burst:"circle",cone:"cone",cube:"rect",emanation:"circle",line:"ray",rect:"rect",square:"rect"};for(let a of s.filter(c=>c.hasAttribute("data-pf2-effect-area"))){let{pf2EffectArea:c,pf2Distance:r,pf2TemplateData:o,pf2Traits:n,pf2Width:l}=a.dataset;a.addEventListener("click",()=>{if(typeof c!="string"){console.warn("PF2e System | Could not create template'");return}let d=JSON.parse(o??"{}");switch(d.distance||=Number(r),d.fillColor||=game.user.color,d.t=i[c],d.t){case"ray":d.width=Number(l)||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1);break;case"cone":d.angle=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let f=d.distance??0;d.distance=Math.hypot(f,f),d.width=f,d.direction=45;break}}n&&(d.flags={pf2e:{origin:{traits:n.split(",")}}});let p=new(nt())(d,{parent:canvas.scene});new(at())(p).drawPreview()})}for(let a of t.querySelectorAll("a[data-damage-roll]"))a.dataset.itemUuid=e.uuid}u(Te,"listenInlineRoll");function gt(t,e){if(e)return e;let i=(ui.windows[Number(t.closest(".app.sheet")?.dataset.appid)]??null)?.document;return i instanceof Actor||i instanceof JournalEntry?i:null}u(gt,"resolveDocument");function ht(t,e){if(Se(t,"ActorPF2e"))return t;if(Se(t,"ItemPF2e")||Se(t,"ChatMessagePF2e"))return t.actor;let s=e.dataset.itemUuid,i=s&&!s.startsWith("Compendium.")?fromUuidSync(s):null;return i instanceof Item?i.actor:null}u(ht,"resolveActor");var Ee=["U","T","E","M","L"],xs="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi";async function yt(t,e){let s=t.data(),i=s.itemId?e.items.get(s.itemId):await fromUuid(s.uuid),a=await i?.getChatData({secrets:e.isOwner},s);if(!a)return;let c=document.createElement("div");return c.classList.add("description"),await e.sheet.itemRenderer.renderItemSummary(c,i,a),Te(c,i),c}u(yt,"getItemSummary");function K(t){t.on("mouseenter",e=>{e.preventDefault();let s=e.currentTarget.querySelector(".name"),{width:i}=s.getBoundingClientRect();if(s.scrollWidth<=Math.ceil(i))return;let a=s.innerHTML.trim();game.tooltip.activate(e.currentTarget,{text:a})}),t.on("mouseleave",e=>{e.preventDefault(),game.tooltip.deactivate()}),t.on("mousedown",e=>{game.tooltip.deactivate()})}u(K,"addNameTooltipListeners");function bt(t,e){t.preventDefault(),z(t,e)?.sheet.render(!0,{focus:!0})}u(bt,"editItem");async function wt(t,e){t.preventDefault();let s=z(t,e);if(s){if(t.ctrlKey)return s.delete();new Dialog({title:C("deleteItem.title"),content:`<p>${game.i18n.format("PF2E.DeleteQuestion",{name:s.name})}</p>`,buttons:{ok:{icon:'<i class="fa-solid fa-trash"></i>',label:C("deleteItem.ok"),callback:()=>s.delete()},cancel:{icon:'<i class="fas fa-times"></i>',label:C("deleteItem.cancel")}}}).render(!0)}}u(wt,"deleteItem");function z(t,e){let{itemId:s}=t.currentTarget.closest("[data-item-id]").dataset;return e.items.get(s)}u(z,"getItemFromEvent");function De(t){return t.isOwner?Y(t,`macros.${game.user.id}`)?.map(e=>{let s=fromUuidSync(e);return s?{img:s.img,name:s.name,uuid:e}:null}).filter(Boolean):void 0}u(De,"getMacros");function xe(t,e){let{type:s,uuid:i}=TextEditor.getDragEventData(t.originalEvent)??{};if(s!=="Macro"||!fromUuidSync(i))return;let a=`macros.${game.user.id}`,c=Y(e,a)?.slice()??[];c.includes(i)||(c.push(i),se(e,a,c))}u(xe,"onDroppedMacro");function Ae(t,e){let s=`macros.${game.user.id}`,i=Y(e,s)?.slice();if(!i?.length)return;let{uuid:a}=t.currentTarget.closest(".macro").dataset,c=i.indexOf(a);c!==-1&&(i.splice(c,1),se(e,s,i))}u(Ae,"deleteMacro");function Le(t=()=>!0){let e=game.user.targets,s=e.size===1?e.first():null;return s&&t(s)?s:null}u(Le,"getUniqueTarget");function U(t,e){return e?t.toLowerCase().includes(e):!0}u(U,"filterIn");function H(t,e){return t.localeCompare(e,game.i18n.lang)}u(H,"localeCompare");function Be(t){return t?.itemTypes.effect.find(e=>e.flags.core?.sourceId===xs)}u(Be,"getCoverEffect");async function ie(t,e,s){let i=X(),a=i?.element;if(!a)return;a.find("> .popup").remove();let c=document.createElement("div");c.innerHTML=`<div class="popup">
    <div class="header">
        <div class="title">${t}</div>
        <a class="observable" data-action="close-popup"><i class="fas fa-times"></i> ${C("popup.close")}</a>
    </div>
</div>`;let r=c.firstElementChild;typeof e=="string"?(e=await te(e,s),r.insertAdjacentHTML("beforeend",e)):r.append(e),r.querySelector("[data-action=close-popup]").addEventListener("click",()=>r.remove()),a.append(r),i.lock()}u(ie,"popup");async function B(t,e,s){s??=t.find(".name").html();let i=await yt(t,e);i&&ie(s.trim(),i,e)}u(B,"showItemSummary");async function Oe(t,e,s,{rollMode:i=void 0,create:a=!0,data:c={}}){let r=`systems/pf2e/templates/chat/${e.type}-card.hbs`,o=s.token,n=t?.currentTarget.closest(".item")??{},l=Q(),d=Object.keys(c).length>0?c:n.dataset||{},p={actor:s,tokenId:o?`${o.parent?.id}.${o.id}`:null,item:e,data:await e.getChatData(void 0,d)},f={speaker:l.getSpeaker({actor:s,token:s.getActiveTokens(!1,!0)[0]??null}),flags:{core:{canPopout:!0},pf2e:{origin:{uuid:e.uuid,type:e.type}}},type:CONST.CHAT_MESSAGE_TYPES.OTHER};return i??=t?.ctrlKey||t?.metaKey?"blindroll":game.settings.get("core","rollMode"),["gmroll","blindroll"].includes(i)&&(f.whisper=l.getWhisperRecipients("GM").map(m=>m.id)),i==="blindroll"&&(f.blind=!0),f.content=await renderTemplate(r,p),a?l.create(f,{renderSheet:!1}):new l(f)}u(Oe,"unownedItemToMessage");async function kt(t){if(!t.system.selfEffect)throw le(["Only actions with self-applied effects can be passed to `ActorPF2e#useAction`.","Support will be expanded at a later time."].join(" "));let{actor:e,actionCost:s}=t,i=e.getActiveTokens(!0,!0).shift()??null,a=Q(),c=a.getSpeaker({actor:e,token:i}),r=await renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{glyph:Ie(s),title:t.name},item:t,traits:t.system.traits.value.map(f=>dt(f,CONFIG.PF2E.actionTraits))}),o=100,n=(()=>{if(t.actor.pack)return null;let f=document.createElement("div"),m=[...CONST.DOCUMENT_LINK_TYPES,"Compendium","UUID"],g=new RegExp(`@(${m.join("|")})\\[([^#\\]]+)(?:#([^\\]]+))?](?:{([^}]+)})?`,"g");return f.innerHTML=t.description.replace(g,(v,...b)=>b[3]),f.innerText.slice(0,o)})(),l={full:n&&n.length<o?t.description:null,preview:n},d=await renderTemplate("systems/pf2e/templates/chat/action/self-effect.hbs",{actor:t.actor,description:l}),p={pf2e:{context:{type:"self-effect",item:t.id}}};return a.create({speaker:c,flavor:r,content:d,flags:p})}u(kt,"createSelfEffectMessage");async function vt({weapon:t,trait:e,selection:s}){if(t.system.traits.toggles[e].selection===s)return!1;let a=t.actor?.items.get(t.id);return a?.isOfType("weapon")&&a===t?await a.update({[`system.traits.toggles.${e}.selection`]:s}):a?.isOfType("weapon")&&t.altUsageType==="melee"?await a.update({[`system.meleeUsage.traitToggles.${e}`]:s}):await a?.rules.find(r=>r.key==="Strike"&&!r.ignored&&r.slug===t.slug)?.toggleTrait({trait:e,selection:s}),!0}u(vt,"toggleWeaponTrait");var Fe={CRITICAL_FAILURE:0,FAILURE:1,SUCCESS:2,CRITICAL_SUCCESS:3},It={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"};function Ct(t,e){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(e+t,0,3)}}u(Ct,"adjustDegreeOfSuccess");function Pe(t,e){return t===20?Ct(It.INCREASE,e):t===1?Ct(It.LOWER,e):e}u(Pe,"adjustDegreeByDieValue");function St(t,e,s){return t-s>=10?Pe(e,Fe.CRITICAL_SUCCESS):s-t>=10?Pe(e,Fe.CRITICAL_FAILURE):t>=s?Pe(e,Fe.SUCCESS):Pe(e,Fe.FAILURE)}u(St,"calculateDegreeOfSuccess");var As=["arcana","crafting","medicine","nature","occultism","religion","society"],Tt={0:{icon:'<i class="fa-solid fa-xmark-large"></i><i class="fa-solid fa-xmark-large"></i>',name:"criticalFailure"},1:{icon:'<i class="fa-solid fa-xmark-large"></i>',name:"failure"},2:{icon:'<i class="fa-solid fa-check"></i>',name:"success"},3:{icon:'<i class="fa-solid fa-check"></i><i class="fa-solid fa-check"></i>',name:"criticalSuccess"}};async function Et(t){let s=(await new Roll("1d20").evaluate({async:!0})).dice[0].total,i=s===1?"0":s===20?"3":"",a=Object.values(t.skills).filter(n=>n.lore),c=Le(n=>n.actor?.identificationDCs)?.actor,r={dieSuccess:i,dieResult:s,target:c,i18n:n=>C(`actions.recall-knowledge.${n}`)};if(c){let{standard:n,skills:l,lore:d}=c.identificationDCs,p=n.progression.slice();p.length=4,p=[...p];let f=d.map(({progression:m})=>{let g=m;return g.length=6,[...g]});r.skillsDCs=p,r.loresDCs=f,r.skills=await Promise.all(l.map(m=>{let g=t.skills[m];return Ge(g,s,p)})),r.lores=await Promise.all(a.map(m=>Ge(m,s)))}else r.skills=await Promise.all([...As.map(n=>t.skills[n]),...a].map(n=>Ge(n,s)));let o=await renderTemplate(F("chat/recall-knowledge"),r);ChatMessage.create({flavor:o,speaker:ChatMessage.getSpeaker({actor:t}),rollMode:CONST.DICE_ROLL_MODES.BLIND,type:CONST.CHAT_MESSAGE_TYPES.ROLL})}u(Et,"rollRecallKnowledges");async function Ge(t,e,s){let{rank:i,label:a}=t,c=await t.roll({createMessage:!1,skipDialog:!0,extraRollOptions:["action:recall-knowledge"]}),r=c.total-c.dice[0].total,o=e+r;return{mod:r,rank:i,label:a,total:o,modifier:q(r),rankLabel:Ee[i],checks:s?.map(n=>{if(!n)return"-";let l=St(o,e,n);return{success:l,icon:Tt[l].icon,title:Tt[l].name}})}}u(Ge,"rollSkill");var V="pf2e-token-hud",Ls="Compendium.pf2e.feats-srd.Item.9jGaBxLUtevZYcZO",Os=new Set(["Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X","Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk"]),Dt="Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf",Fs="Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu",We="Compendium.pf2e.other-effects.Item.VCSpuc3Tf3XWMkd3",Ps={initiative:"PF2E.InitiativeLabel","recall-knowledge":"PF2E.RecallKnowledge.Label","cover-tracks":"PF2E.TravelSpeed.ExplorationActivities.CoverTracks",earnIncome:`${V}.skills.actions.earnIncome`,treatWounds:`${V}.skills.actions.treatWounds`,"borrow-arcane-spell":`${V}.skills.actions.borrow-arcane-spell`,"identify-magic":`${V}.skills.actions.identify-magic`,"identify-alchemy":`${V}.skills.actions.identify-alchemy`,"learn-spell":`${V}.skills.actions.learn-spell`,"crafting-goods":`${V}.skills.actions.crafting-goods`,"staging-performance":`${V}.skills.actions.staging-performance`},xt={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW","sense-motive":"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw",seek:"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ",balance:"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","follow-the-expert":"Compendium.pf2e.actionspf2e.Item.tfa4Sh7wcxCEqL29","tumble-through":"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8","maneuver-in-flight":"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M",squeeze:"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","borrow-arcane-spell":"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh","decipher-writing":"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L","identify-magic":"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G","learn-spell":"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW",climb:"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy",forceOpen:"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx",grapple:"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD",highJump:"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h",longJump:"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2",shove:"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731",swim:"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx",trip:"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP",disarm:"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9",repair:"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME",craft:"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl","crafting-goods":"",earnIncome:"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j","identify-alchemy":"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1",createADiversion:"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA",impersonate:"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE",lie:"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72",feint:"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X",bonMot:Dt,gatherInformation:"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8",makeAnImpression:"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q",request:"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6",coerce:"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd",demoralize:"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF","administer-first-aid":"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1","treat-disease":"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN","treat-poison":"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh",treatWounds:"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9","command-an-animal":"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe",perform:"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx","staging-performance":"",subsist:"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3","create-forgery":"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD","conceal-an-object":"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV",hide:"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa",sneak:"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4",senseDirection:"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk","cover-tracks":"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk",track:"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD","palm-an-object":"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd",steal:"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k","disable-device":"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6","pick-a-lock":"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H"},Ms={escape:{slug:"escape",cost:"1",type:2,noSkill:!0},"recall-knowledge":{slug:"recall-knowledge",cost:"1",secret:!0},"decipher-writing":{slug:"decipher-writing",type:2,trained:!0},"identify-magic":{slug:"identify-magic",trained:!0},"learn-spell":{slug:"learn-spell",trained:!0}},ue=[{slug:"perception",actions:[{slug:"sense-motive",cost:"1",type:2},{slug:"seek",cost:"1",type:2}]},{slug:"acrobatics",actions:[{slug:"balance",cost:"1",type:2},{slug:"tumble-through",cost:"1",type:2},{slug:"maneuver-in-flight",cost:"1",type:2,trained:!0},{slug:"squeeze",type:2,trained:!0}]},{slug:"arcana",actions:[{slug:"borrow-arcane-spell",trained:!0},"decipher-writing","identify-magic","learn-spell"]},{slug:"athletics",actions:[{slug:"climb",cost:"1",type:1},{slug:"forceOpen",cost:"1",type:1,map:!0,modifiers:[{condition:t=>!t.itemTypes.equipment.some(e=>e.isHeld&&Os.has(e.sourceId)),modifiers:[{slug:"crowbar-missing",modifier:-2,type:"circumstance"}]}]},{slug:"grapple",cost:"1",type:1,map:!0},{slug:"highJump",cost:"1",type:1},{slug:"longJump",cost:"1",type:1},{slug:"shove",cost:"1",type:1,map:!0},{slug:"swim",cost:"1",type:1},{slug:"trip",cost:"1",type:2,map:!0},{slug:"disarm",cost:"1",type:1,map:!0,trained:!0}]},{slug:"crafting",actions:[{slug:"repair",type:1},{slug:"craft",type:1,trained:!0},{slug:"crafting-goods",trained:!0},{slug:"earnIncome",type:3,trained:!0},{slug:"identify-alchemy",trained:!0}]},{slug:"deception",actions:[{slug:"createADiversion",cost:"1",type:1,variants:["distracting-words","gesture","trick"]},{slug:"impersonate",type:1},{slug:"lie",type:1},{slug:"feint",cost:"1",type:1,trained:!0}]},{slug:"diplomacy",actions:[{slug:"bonMot",cost:"1",type:1,condition:t=>qe(t,Dt)},{slug:"gatherInformation",type:1},{slug:"makeAnImpression",type:1},{slug:"request",cost:"1",type:1}]},{slug:"intimidation",actions:[{slug:"coerce",type:2},{slug:"demoralize",cost:"1",type:2}]},{slug:"medicine",actions:[{slug:"administer-first-aid",cost:"2",type:2,variants:["stabilize","stop-bleeding"],rollOption:"administer-first-aid"},{slug:"treat-disease",type:2,trained:!0},{slug:"treat-poison",cost:"1",type:2,trained:!0},{slug:"treatWounds",type:1,trained:!0}]},{slug:"nature",actions:[{slug:"command-an-animal",cost:"1",type:2},"identify-magic","learn-spell",{slug:"treatWounds",type:1,trained:!0,condition:t=>qe(t,Fs)}]},{slug:"occultism",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"performance",actions:[{slug:"perform",cost:"1",type:1,variants:["acting","comedy","dance","keyboards","oratory","percussion","singing","strings","winds"]},{slug:"staging-performance",trained:!0}]},{slug:"religion",actions:["decipher-writing","identify-magic","learn-spell"]},{slug:"society",actions:[{slug:"subsist",type:2},{slug:"create-forgery",type:2,trained:!0},"decipher-writing"]},{slug:"stealth",actions:[{slug:"conceal-an-object",cost:"1",type:2},{slug:"hide",cost:"1",type:2},{slug:"sneak",cost:"1",type:2}]},{slug:"survival",actions:[{slug:"senseDirection",type:1},{slug:"subsist",type:2},{slug:"cover-tracks",trained:!0},{slug:"track",type:1,trained:!0}]},{slug:"thievery",actions:[{slug:"palm-an-object",cost:"1",type:2},{slug:"steal",cost:"1",type:2},{slug:"disable-device",cost:"2",type:2,trained:!0},{slug:"pick-a-lock",cost:"2",type:2,trained:!0}]}];ue.forEach(t=>{t.actions=t.actions.map(i=>typeof i=="string"?Ms[i]:i);let{slug:e,actions:s}=t;for(let i of s){let a=i.slug.replace(/-(.)/g,(c,r)=>r.toUpperCase()).capitalize();i.skillSlug=e,i.uuid=xt[i.slug],i.label=Ps[i.slug]??`PF2E.Actions.${a}.Title`,i.variants?i.variants=i.variants.map(c=>({slug:c,label:`${V}.skills.actions.${c}`})):i.map&&(i.variants=[{label:"PF2E.Roll.Normal"},{label:"PF2E.MAPAbbreviationLabel",map:-5},{label:"PF2E.MAPAbbreviationLabel",map:-10}]),i.modifiers?.forEach(({modifiers:c})=>{c.forEach(r=>{r.label=`${V}.skills.modifiers.${r.slug}`})})}});var Ke=ue.map(t=>t.slug),$s=ue.reduce((t,{slug:e,actions:s})=>(t[e]={slug:e,actions:s.reduce((i,a)=>(i[a.slug]=a,i),{})},t),{}),At=new Set(Object.values(xt).filter(Boolean));function Ve(t){return game.i18n.localize(t==="perception"?"PF2E.PerceptionLabel":CONFIG.PF2E.skillList[t])}u(Ve,"getSkillLabel");async function Lt({actor:t,filter:e}){let s=[],i=t.isOfType("character"),a=i&&h("untrained")&&!t.itemTypes.feat.some(o=>o.sourceId===Ls);for(let o=0;o<ue.length;o++){let{slug:n,actions:l}=ue[o],{label:d,rank:p,mod:f}=t.getStatistic(n),m=game.i18n.localize(d),g=l.filter(({condition:k,trained:w})=>(!a||!i||!w||t.skills[n].rank>=1)&&(!k||k(t))).map(k=>({...k,name:game.i18n.localize(k.label),variants:k.variants?.map(w=>({...w,name:game.i18n.localize(w.label)}))})),v=U(m,e),b=g;!v&&(b=g.filter(({name:k,variants:w})=>U(k,e)||w?.some(E=>U(E.name,e))),!b.length)||(s[o]={slug:n,name:m,rank:p,modifier:q(f),actions:v?g:b})}s.sort((o,n)=>o.slug==="perception"?-1:n.slug==="perception"?1:H(o.name,n.name));let c=Object.values(t.skills).filter(({lore:o,label:n})=>o&&U(n,e)).map(({label:o,rank:n,mod:l,slug:d})=>({slug:d,label:o,rank:n,modifier:q(l)})),r=c.reduce((o,n)=>n.modifier.length>o?n.modifier.length:o,2);return{contentData:{follow:C(`skills.actions.${Ft(t)?"following":"follow"}`),skills:s,lores:c,loresModifierWidth:r},doubled:h("skills-columns")}}u(Lt,"getSkillsData");function Ot({el:t,actor:e,token:s,hud:i}){t.find("[data-action=action-description]").on("click",a=>{a.preventDefault();let c=$(a.currentTarget).closest(".action");B(c,e,c.find(".name").children().html())}),e.isOwner&&(t.find("[data-action=follow-the-expert]").on("click",async a=>{a.preventDefault();let c=Ft(e);if(c)return await c.delete();let r=(await fromUuid(We)).toObject();setProperty(r,"flags.core.sourceId",We),await e.createEmbeddedDocuments("Item",[r])}),t.find("[data-action=roll-skill]").on("click",a=>{a.preventDefault();let{slug:c}=a.currentTarget.dataset;e.getStatistic(c)?.roll({event:a})}),t.find("[data-action=roll-action]").on("click contextmenu",async a=>{a.preventDefault();let c=$(a.currentTarget),{skillSlug:r,slug:o}=c.closest(".action").data(),{variant:n,map:l}=c.data(),d=a.type==="contextmenu"?await Me(r):void 0;d!==null&&Ns({event:a,actor:e,token:s,skillSlug:r,slug:o,variant:n,map:l,skill:d?.selected})}),t.find("[data-action=action-chat]").on("click",async a=>{a.preventDefault();let{uuid:c}=a.currentTarget.closest(".action").dataset,r=await fromUuid(c);r&&(Oe(a,r,e,{create:!0}),h("chat-close")&&i.close())}))}u(Ot,"addSkillsListeners");function Ft(t){return t.itemTypes.effect.find(e=>e.sourceId===We)}u(Ft,"isFollowingAnExpert");async function Me(t,e){let s=Ke.map(a=>({slug:a,label:Ve(a)})),i=await renderTemplate(F("dialogs/variant"),{i18n:a=>C(`skills.variant.${a}`),dc:e,skills:s,selected:t});return Dialog.prompt({title:C("skills.variant.title"),label:C("skills.variant.button"),callback:a=>({selected:a.find("select").val(),dc:Number(a.find("input").val())}),rejectClose:!1,content:i,options:{width:280}})}u(Me,"variantsDialog");function Ns({event:t,actor:e,skillSlug:s,slug:i,variant:a,map:c,skill:r,token:o}){let n=$s[s].actions[i],l=n.type===3?3:game.pf2e.actions.has(i)?2:1;r??=n.noSkill?void 0:s;let d=n.rollOption?[`action:${n.rollOption}`]:void 0;d&&a&&d.push(`action:${n.rollOption}:${a}`);let p={event:t,actors:[e],tokens:[o],variant:a,rollOptions:d,rollMode:n.secret?"blindroll":"roll"};if(p.modifiers=[],n.modifiers){for(let{condition:f,modifiers:m}of n.modifiers)if(!(f&&!f(e)))for(let g of m)p.modifiers.push(new game.pf2e.Modifier(g))}if(n.custom){n.custom(e,p);return}else if(!l){e.getStatistic(r)?.roll(p);return}l===1?(p.skill=r,c&&p.modifiers.push(new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:c})),game.pf2e.actions[i](p)):l===2?(p.statistic=r,c&&(p.multipleAttackPenalty=c/-5),game.pf2e.actions.get(i).use(p)):l===3&&game.pf2e.actions[i](e)}u(Ns,"rollAction");var Je={aid:"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW",escape:"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9","recall-knowledge":"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo","point-out":"Compendium.pf2e.actionspf2e.Item.sn2hIy1iIJX9Vpgj"};async function Pt({actor:t,filter:e}){let{attributes:s}=t,{initiative:i}=s;return{contentData:{noMacro:C("extras.no-macro"),macros:De(t)?.filter(a=>U(a.name,e)),initiative:i&&{selected:i.statistic,skills:Ke.map(a=>({slug:a,label:Ve(a)}))},hasDailies:game.modules.get("pf2e-dailies")?.active,hasPerception:game.modules.get("pf2e-perception")?.active,uuids:Je}}}u(Pt,"getExtrasData");function Mt({el:t,actor:e,token:s,hud:i}){function a(r,o,n="click"){t.find(`[data-action=${r}]`).on(n,l=>{l.preventDefault(),o(l)})}if(u(a,"action"),a("action-description",r=>{let o=$(r.currentTarget).closest(".row");B(o,e)}),!e.isOwner)return;K(t.find(".macro"));async function c(r){let{uuid:o}=r.currentTarget.closest(".macro").dataset;return fromUuid(o)}u(c,"getMacro"),a("delete-macro",r=>Ae(r,e)),a("edit-macro",async r=>{(await c(r))?.sheet.render(!0)}),a("use-macro",async r=>{(await c(r))?.execute({actor:e,token:s})}),t.on("drop",r=>xe(r,e)),a("action-chat",async r=>{let{uuid:o}=r.currentTarget.closest(".row").dataset,n=await fromUuid(o);n&&(Oe(r,n,e,{create:!0}),h("chat-close")&&i.close())}),t.find("input[name], select[name]").on("change",async r=>{let o=r.currentTarget,n=o.type==="number"?o.valueAsNumber:o.value;await e.update({[o.name]:n})}),a("roll-initiative",async r=>{await e.initiative.roll({event:r})}),a("prepare-dailies",r=>{let o=game.modules.get("pf2e-dailies");o?.active&&o.api.openDailiesInterface(e)}),a("rest-for-the-night",r=>{game.pf2e.actions.restForTheNight({actors:[e],tokens:[s]})}),a("roll-recall-knowledge",r=>{Et(e)}),a("roll-aid",async r=>{let o=await Me(null,15),n={text:"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]"};o!==null&&game.pf2e.actions.get("aid").use({event:r,actors:[e],tokens:[s],statistic:o?.selected,difficultyClass:{value:o?.dc},notes:[n]})},"click contextmenu"),a("roll-point-out",r=>{game.pf2e.actions.get("point-out").use({event:r,actors:[e],tokens:[s]})}),a("roll-escape",async r=>{let o=r.type==="contextmenu"?await Me():void 0,n=$(r.currentTarget).data().map;o!==null&&game.pf2e.actions.get("escape").use({event:r,actors:[e],tokens:[s],statistic:o?.selected,multipleAttackPenalty:n})},"click contextmenu")}u(Mt,"addExtrasListeners");var oe={action:{order:0,label:"PF2E.ActionsActionsHeader",actionLabel:"PF2E.ActionTypeAction"},reaction:{order:1,label:"PF2E.ActionsReactionsHeader",actionLabel:"PF2E.ActionTypeReaction"},free:{order:2,label:"PF2E.ActionsFreeActionsHeader",actionLabel:"PF2E.ActionTypeFree"},passive:{order:3,label:"PF2E.NPC.PassivesLabel",actionLabel:"PF2E.ActionTypePassive"},exploration:{order:3,label:"PF2E.TravelSpeed.ExplorationActivity",actionLabel:"PF2E.TabActionsExplorationLabel"}};async function $t({hud:t,actor:e,filter:s}){let i=e.isOfType("character"),a=e.synthetics.toggles.slice(),c=h("actions"),r=(await Qe()?.getStances(e))?.sort((b,k)=>H(b.name,k.name)),o=i?await ne()?.getHeroActions(e):void 0,n=o?e.heroPoints.value-o.length:void 0,l=e.isOwner,d=e.getRollData(),p=e.system.actions?await Promise.all(e.system.actions.map(async(b,k)=>({...b,index:k,visible:!i||b.visible,damageFormula:await b.damage?.({getFormula:!0}),criticalFormula:await b.critical?.({getFormula:!0}),description:b.description?await te(b.description,e,{rollData:d,isOwner:l}):void 0,altUsages:b.altUsages&&await Promise.all(b.altUsages.map(async w=>({...w,usage:w.item.isThrown?"thrown":"melee",damageFormula:await w.damage?.({getFormula:!0}),criticalFormula:await w.critical?.({getFormula:!0})})))}))):void 0,f=i?new game.pf2e.ElementalBlast(e):void 0,m=f?(await Promise.all(f.configs.map(async b=>{let k=b.damageTypes.find(E=>E.selected)?.value??"untyped",w=u((E,O=!0)=>f.damage({element:b.element,damageType:k,melee:O,outcome:E,getFormula:!0}),"formulaFor");return{...b,damageType:k,formula:{melee:{damage:await w("success"),critical:await w("criticalSuccess")},ranged:{damage:await w("success",!1),critical:await w("criticalSuccess",!1)}}}}))).sort((b,k)=>H(b.label,k.label)):void 0,g={},v=i?Us(e,r):Hs(e);for(let b of v)U(b.name,s)&&(c!=="split"?(g.action??=[],g.action.push(b)):(g[b.type]??=[],g[b.type].push(b)));if(g=Object.entries(g).map(([b,k])=>(k.forEach(w=>{w.img=rt(w.cost),w.typeLabel=oe[w.type].actionLabel}),c!=="type"?k.sort((w,E)=>H(w.name,E.name)):k.sort((w,E)=>{let O=oe[w.type].order,M=oe[E.type].order;return O===M?H(w.name,E.name):O-M}),{type:b,actions:k,label:oe[b].label})),c==="split"&&g.sort((b,k)=>oe[b.type].order-oe[k.type].order),a.length||r?.length||p?.length||m?.length||g.length||o?.length){let b=+((r?.length??0)>0)+ +((p?.length??0)>0)+ +((m?.length??0)>0)+g.length+ +((o?.length??0)>0);return{contentData:{toggles:a,stances:r,strikes:p,blasts:m,sections:g,heroActions:o&&{actions:o,draw:Math.max(n,0),discard:Math.abs(Math.min(n,0)),canTrade:o.length&&Rs()},i18n:k=>C(`actions.${k}`),variantLabel:k=>k.replace(/.+\((.+)\)/,"$1"),damageTypes:CONFIG.PF2E.damageTypes},doubled:b>1&&h("actions-columns"),classes:[h("actions-colors")?"attack-damage-system-colors":""]}}}u($t,"getActionsData");function Nt({el:t,actor:e,hud:s}){K(t.find(".toggle")),K(t.find(".strike")),K(t.find(".action"));function i(o,n,l="click"){return o=typeof o=="string"?[o]:o,o=o.map(d=>`[data-action=${d}]`).join(", "),t.find(o).on(l,d=>{d.preventDefault(),n(d)})}u(i,"action");function a(o){let n=o.currentTarget.closest(".strike"),l=e.system.actions[n.dataset.index];if(!l)return null;let{altUsage:d}=o.currentTarget.dataset;return["melee","thrown"].includes(d)?l.altUsages?.find(p=>d==="thrown"?p.item.isThrown:p.item.isMelee)??null:l}u(a,"getStrike");function c(o){return $(o.currentTarget).closest(".action").data().uuid}if(u(c,"getUuid"),i("action-description",async o=>{let n=$(o.currentTarget).closest(".action");B(n,e)}),i("hero-action-description",async o=>{let n=c(o),{description:l,name:d}=await ne()?.getHeroActionDetails(n)??{};l&&ie(d,l,e)}),i("strike-description",async o=>{let n=a(o);if(!n)return;let l=document.createElement("div");l.classList.add("description"),l.innerHTML=await renderTemplate(F("strike-description"),n),ie(n.label,l,e)}),i("blast-description",async o=>{let n=o.currentTarget.closest(".blast");B($(n),e)}),i("trait-description",o=>{let n=a(o);if(!n)return;let{index:l}=o.currentTarget.dataset,d=n.traits[l];if(!d)return;let p=game.i18n.localize(d.description);p&&ie(game.i18n.localize(d.label),p,e)}),i("stance-description",o=>{let n=$(o.currentTarget).closest(".action");B(n,e,n.data().itemName)}),!e.isOwner||(i("use-action",o=>{let n=z(o,e);n?.isOfType("action","feat")&&kt(n)}),i("stance-chat",o=>{let n=z(o,e);n&&(n.toMessage(o,{create:!0}),h("chat-close")&&s.close())}),i("stance-toggle",o=>{let{effectUuid:n}=o.currentTarget.closest(".action").dataset;Qe()?.toggleStance(e,n)}),i("exploration-toggle",o=>{let n=o.currentTarget.closest(".action").dataset.itemId,l=e.system.exploration.filter(d=>e.items.has(d));l.findSplice(d=>d===n)||l.push(n),e.update({"system.exploration":l})}),i("action-chat",o=>{let n=z(o,e);n&&(n.toMessage(o,{create:!0}),h("chat-close")&&s.close())}),i("hero-action-chat",async o=>{let n=ne();n&&(n.sendActionToChat(e,c(o)),h("chat-close")&&s.close())}),i("draw-hero-action",async o=>{await ne()?.drawHeroActions(e)}),i("use-hero-action",async o=>{await ne()?.useHeroAction(e,c(o))}),i("discard-hero-action",async o=>{await ne()?.discardHeroActions(e,c(o))}),i("trade-hero-action",async o=>{ne()?.tradeHeroAction(e)}),i("strike-attack",o=>{let{index:n,altUsage:l}=o.currentTarget.dataset;a(o)?.variants[n].roll({event:o,altUsage:l}),h("attack-close")&&s.close()}),i(["strike-damage","strike-critical"],o=>{let{action:n}=o.currentTarget.dataset;a(o)?.[n==="strike-damage"?"damage":"critical"]({event:o}),h("attack-close")&&s.close()}),i(["toggle-roll-option","set-suboption"],o=>{let n=o.currentTarget.closest(".toggle"),{domain:l,option:d,itemId:p}=n.dataset,f=n.querySelector("select")?.value??null;e.toggleRollOption(l,d,p??null,n.querySelector("input").checked,f)}),i("strike-auxiliary",o=>{if(o.currentTarget!==o.target)return;let n=a(o);if(!n)return;let{index:l}=o.currentTarget.dataset,d=o.currentTarget.querySelector("select")?.value??null;n.auxiliaryActions?.[l]?.execute({selection:d})}),i("toggle-versatile",o=>{let n=a(o)?.item;if(!n)return;let l=o.currentTarget,{value:d}=l.dataset,p=n?.system.damage.damageType??null,f=l.classList.contains("selected")||d===p?null:d;vt({trait:"versatile",weapon:n,selection:f})}),i("strike-ammo",async o=>{let n=a(o)?.item;if(!n)return;let l=e.items.get(o.currentTarget.value);await n.update({system:{selectedAmmoId:l?.id??null}})},"change"),!e.isOfType("character")))return;let r=["roll-attack","roll-damage","set-damage-type"].map(o=>`[data-action=${o}]`).join(",");t.find(".blast").each((o,n)=>{let{element:l,damageType:d}=n.dataset,p=new game.pf2e.ElementalBlast(e);$(n).find(r).on("click",async f=>{f.preventDefault();let m=f.currentTarget.dataset,g=m.melee==="true";switch(m.action){case"roll-attack":{let v=Math.clamped(Number(m.mapIncreases),0,2);p.attack({mapIncreases:Math.clamped(v,0,2),element:l,damageType:d,melee:g,event:f});break}case"roll-damage":{p.damage({element:l,damageType:d,melee:g,outcome:m.outcome,event:f});break}case"set-damage-type":p.setDamageType({element:l,damageType:m.value})}["roll-attack","roll-damage"].includes(m.action)&&h("attack-close")&&s.close()})})}u(Nt,"addActionsListeners");function Rt(t){let e=game.modules.get("pf2e-toolbelt");return e?.active&&game.settings.get("pf2e-toolbelt",t)?e:void 0}u(Rt,"getToolBeltModule");function Ut(t){return Rt(t)?.api}u(Ut,"getToolBeltApi");function Qe(){let t=game.modules.get("pf2e-stances");return t?.active?t.api:Ut("stances")?.stances}u(Qe,"getStancesModuleApi");function ne(){let t=game.modules.get("pf2e-hero-actions");return t?.active?t.api:Ut("hero")?.heroActions}u(ne,"getHeroActionsApi");function Rs(){if(game.modules.get("pf2e-hero-actions")?.active)return game.settings.get("pf2e-hero-actions","trade");if(Rt("hero"))return game.settings.get("pf2e-toolbelt","hero-trade")}u(Rs,"canTradeHeroActions");function Us(t,e){let s=Qe()?.getActionsUUIDS?.()??(e?.some(n=>n.actionUUID)?new Set(e.map(({actionUUID:n})=>n)):void 0)??new Set,i=new Set([...s,...At,...Object.values(Je)]),a=t.itemTypes.action,c=t.itemTypes.feat.filter(n=>n.actionCost),r=t.parties.size>0,o=t.system.exploration;return[...a,...c].map(n=>{let l=n.sourceId,d=n.id,p=n.actionCost,f=n.system.traits.value,m=f.includes("exploration");return{sourceId:l,id:d,type:p?.type??(m?"exploration":"free"),cost:p,name:n.name,isExploration:m,isDowntime:f.includes("downtime"),isActive:m&&o.includes(d),hasEffect:!!n.system.selfEffect}}).filter(n=>!n.isDowntime&&(r||!n.isExploration)&&(n.isExploration||!i.has(n.sourceId)))}u(Us,"getCharacterActions");function Hs(t){return t.itemTypes.action.map(e=>{let s=e.actionCost,i=s?.type??"passive",a=i==="passive"&&(e.system.traits.value.includes("aura")||!!e.system.rules.find(c=>c.key==="Aura"));return{id:e.id,type:i,cost:s,name:e.name,hasDeathNote:e.system.deathNote,hasAura:a,hasEffect:!!e.system.selfEffect}})}u(Hs,"getNpcActions");async function Ht({actor:t}){let{system:e}=t,{details:s,traits:i,attributes:a}=e,{stealth:c}=a,{description:r,disable:o,routine:n,reset:l,isComplex:d}=s,p=t.getRollData(),f=t.isOwner,m=u(async g=>te(g,t,{isOwner:f,rollData:p}),"enrich");return{contentData:{description:await m(r),disable:await m(o),routine:await m(n),reset:await m(l),isComplex:d,rarity:{value:i.rarity,label:CONFIG.PF2E.rarityTraits[i.rarity]},traits:i.value.map(g=>CONFIG.PF2E.hazardTraits[g]),stealth:q(c.value)},style:{["--max-width"]:h("hazard-width")+"em"}}}u(Ht,"getHazardData");function _t({el:t,actor:e}){t.find("[data-action=action-description]").on("click",s=>{s.preventDefault();let i=$(s.currentTarget).closest(".action");B(i,e)}),Te(t[0],e),e.isOwner&&t.find("[data-action=roll-initiative").on("click",s=>{s.preventDefault(),e.initiative.roll({event:s})})}u(_t,"addHazardListeners");var jt=new Set(["arcane","divine","occult","primal"]);function _s(t,e){return t.has(e)}u(_s,"setHasElement");function js(t){return t.traits.has("cursed")?"unique":t.rarity}u(js,"getDcRarity");function zs(t){let e=t.system.traits.value;return new Set(e.filter(s=>_s(jt,s)))}u(zs,"getMagicTraditions");function Bs(t,e,s){let i={occult:e,primal:e,divine:e,arcane:e},a=zs(t);for(let c of jt)a.size>0&&!a.has(c)&&(i[c]=e+s);return{arcana:i.arcane,nature:i.primal,religion:i.divine,occultism:i.occult}}u(Bs,"getIdentifyMagicDCs");function Gs(t,{proficiencyWithoutLevel:e=!1,notMatchingTraditionModifier:s}){let i=ke(t.level,{proficiencyWithoutLevel:e}),a=js(t),c=we(i,a);return t.isMagical?Bs(t,c,s):t.isAlchemical?{crafting:c}:{dc:c}}u(Gs,"getItemIdentificationDCs");function Ws(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}u(Ws,"objectHasKey");var de=class extends FormApplication{static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}get item(){return this.object}async getData(){let e=this.object,s=game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier"),i=game.settings.get("pf2e","proficiencyVariant")==="ProficiencyWithoutLevel",a=Gs(e,{proficiencyWithoutLevel:i,notMatchingTraditionModifier:s});return{...await super.getData(),isMagic:e.isMagical,isAlchemical:e.isAlchemical,dcs:a}}activateListeners(e){e.find("button.update-identification").on("click",s=>{let i=$(s.delegateTarget);this.submit({updateData:{status:i.val()}})}),e.find("button.post-skill-checks").on("click",async()=>{let s=this.item,i=s.system.identification.unidentified.img,a=s.system.identification.unidentified.name,c=s.system.identification.identified.name,r=$("div#identify-item").find("tr").toArray().flatMap(l=>{let d=l.dataset.skill,p=Number(l.dataset.dc);if(!(Number.isInteger(p)&&Ws(CONFIG.PF2E.skillList,d)))return[];let f=game.i18n.localize(CONFIG.PF2E.skillList[d]);return{slug:d,name:f,dc:p}}),o=s.isMagical?"action:identify-magic":s.isAlchemical?"action:identify-alchemy":null,n=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{itemImg:i,itemName:a,identifiedName:c,rollOptions:["concentrate","exploration","secret",o].filter(Boolean),skills:r});await Q().create({user:game.user.id,content:n})})}async _updateObject(e,s){let i=s.status;i==="identified"&&await this.item.setIdentificationStatus(i)}};u(de,"IdentifyItemPopup");async function fe({target:t,selected:e,direction:s="DOWN",onCreate:i,onDismiss:a,onClick:c,content:r,cssClass:o=[],locked:n=!1}){return new Promise(l=>{let d=`${D}-tooltip`,p=document.body.querySelectorAll(`.${d}:not(#tooltip)`);for(let f of p)pe(f);requestAnimationFrame(()=>{o=typeof o=="string"?[o]:o,e&&o.push("selection-tooltip"),Array.isArray(r)&&(r=r.map(({value:m,label:g})=>`<li><a  ${m===e?'class="selected"':""} data-value="${m}">${g}</a></li>`).join(""));let f;r instanceof HTMLElement?f=r:(f=document.createElement("ul"),f.innerHTML=r),f.style.setProperty("--font-size",h("scale")+"px"),o.length&&f.classList.add(...o.map(m=>`${D}-${m}`)),a&&new MutationObserver(function(){document.body.contains(f)||(a(),this.disconnect())}).observe(document.body,{childList:!0}),c&&(n=!0,f.querySelectorAll("[data-value]").forEach(m=>{m.addEventListener("click",async g=>{g.preventDefault();let v=g.currentTarget;pe(v),c?.(v.dataset.value)})})),game.tooltip.activate(t,{content:f,direction:s,locked:n,cssClass:d}),i?.(f),l(f)})})}u(fe,"createTooltip");function pe(t){t=t.closest(`.${D}-tooltip`),game.tooltip.dismissLockedTooltip(t)}u(pe,"dismissTooltip");var $e={weapon:{order:0,label:"PF2E.InventoryWeaponsHeader"},armor:{order:1,label:"PF2E.InventoryArmorHeader"},consumable:{order:2,label:"PF2E.InventoryConsumablesHeader"},equipment:{order:3,label:"PF2E.InventoryEquipmentHeader"},treasure:{order:4,label:"PF2E.InventoryTreasureHeader"},backpack:{order:5,label:"PF2E.InventoryBackpackHeader"}};async function zt({actor:t,filter:e}){let{contents:s,coins:i,totalWealth:a,bulk:c,invested:r}=t.inventory,o=h("containers")||(Y(t,`containers.${game.user.id}`)??[]),n={},l={};for(let d of s){if(!$e[d.type])continue;let p=d.system.containerId;d.type!=="backpack"&&p&&(o===!0||o.includes(p))?(n[p]??=[],n[p].push(d)):(l[d.type]??=[],l[d.type].push(d))}if(l=Object.entries(l).map(([d,p])=>{if(p.sort((f,m)=>H(f.name,m.name)),d==="backpack")for(let f=p.length-1;f>=0;f--){let m=p[f],g=n[m.id]?.filter(v=>U(v.name,e));if(!g?.length){U(m.name,e)||p.splice(f,1);continue}g.sort((v,b)=>H(v.name,b.name)),p.splice(f+1,0,...g)}else p=p.filter(f=>U(f.name,e));return{type:d,items:p,label:$e[d].label}}).filter(d=>d.items.length).sort((d,p)=>$e[d.type].order-$e[p.type].order),l.length)return{doubled:l.length>1&&h("items-columns"),contentData:{canCarry:!!t.adjustCarryType,categories:l,bulk:c,containers:o,i18n:d=>C(`items.${d}`),invested:r?`${game.i18n.localize("PF2E.InvestedLabel")}: ${r.value} / ${r.max}`:"",wealth:{coins:i.goldValue,total:a.goldValue}}}}u(zt,"getItemsData");function Bt({el:t,actor:e,token:s,hud:i}){let a=t.find(".item");K(a),a.find("[data-action=item-description]").on("click",async c=>{c.preventDefault();let r=$(c.currentTarget).closest(".item");await B(r,e)}),a.find("[data-action=toggle-contains-items]").on("click",async c=>{c.preventDefault();let r=`containers.${game.user.id}`,o=c.currentTarget.closest(".item").dataset.itemId,n=Y(e,r)?.slice()??[],l=n.indexOf(o);l===-1?n.push(o):n.splice(l,1),await se(e,r,n)}),e.isOwner&&(a.find("[data-action=item-chat]").on("click",async c=>{let r=z(c,e);r&&(r.toMessage(c,{create:!0}),h("chat-close")&&i.close())}),a.on("dragstart",c=>{let r=c.target.closest(".item"),{itemType:o,uuid:n}=r.dataset,l=new Image;l.src=r.querySelector(".item-img img").src,l.style.width="32px",l.style.height="32px",l.style.borderRadius="4px",l.style.position="absolute",l.style.left="-1000px",document.body.append(l),c.originalEvent.dataTransfer.setDragImage(l,16,16),c.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",fromInventory:!0,itemType:o,uuid:n})),r.addEventListener("dragend",()=>l.remove(),{once:!0})}),t.find(".quantity input").on("change",async c=>{await z(c,e)?.update({"system.quantity":c.currentTarget.valueAsNumber})}),t.find("[data-action=toggle-item-invest]").on("click",c=>{c.preventDefault();let{itemId:r}=c.currentTarget.closest(".item").dataset;e.toggleInvested(r)}),t.find("[data-action=repair-item]").on("click",c=>{c.preventDefault();let r=z(c,e);r&&game.pf2e.actions.repair({item:r,actors:[e],tokens:[s]})}),t.find("[data-action=toggle-identified]").on("click",c=>{c.preventDefault();let r=z(c,e);r&&(r.isIdentified?r.setIdentificationStatus("unidentified"):new de(r).render(!0))}),t.find("[data-action=edit-item]").on("click",c=>{c.preventDefault(),bt(c,e)}),t.find("[data-action=delete-item]").on("click",c=>{c.preventDefault(),wt(c,e)}),t.find("[data-action=toggle-item-worn").on("click",async c=>{let r=z(c,e);if(!r)return;let o=document.createElement("div");o.innerHTML=await renderTemplate("systems/pf2e/templates/actors/partials/carry-type.hbs",{item:r});let n=o.children[1].firstElementChild;if(n.querySelectorAll("[data-carry-type]").forEach(l=>{l.addEventListener("click",async d=>{let p=d.currentTarget,f=r.system.equipped,m=p.dataset.inSlot==="true",g=Number(p.dataset.handsHeld)||0,v=p.dataset.carryType;pe(p),(v!==f.carryType||m!==f.inSlot||v==="held"&&g!==f.handsHeld)&&e.adjustCarryType(r,{carryType:v,handsHeld:g,inSlot:m})})}),r.type!=="backpack"){let l=e.itemTypes.backpack.filter(d=>d.isIdentified);if(l.length){let d="";for(let p of l)d+='<li><a class="item-control item-location-option',p===r.container&&(d+=" selected"),d+=`" data-action="send-to-container" data-container-id="${p.id}">`,d+=`<i class="fas fa-box"></i>${p.name}</a></li>`;n.insertAdjacentHTML("beforeend",d),n.querySelectorAll("[data-action=send-to-container]").forEach(p=>{p.addEventListener("click",f=>{let m=f.currentTarget,g=m.dataset.containerId;e.items.has(g)&&(pe(m),r.update({"system.containerId":g}))})})}}fe({target:c.currentTarget,content:n,locked:!0,direction:"UP",selected:!0})}))}u(Bt,"addItemsListeners");async function Gt({actor:t,filter:e}){let s=t.system.resources.focus??{value:0,max:0},i=t.spellcasting.regular,a=h("tradition"),c=game.modules.get("pf2e-staves")?.active,r=[],o=[],n=!1;if(await Promise.all(i.map(async p=>{let f=p.id,m=a&&p.statistic.label[0],g=await p.getSheetData(),v=g.isFocusPool,b=p.system?.prepared?.value==="charge",k=getProperty(p,"flags.pf2e-staves.staveID")!==void 0,w={value:getProperty(p,"flags.pf2e-staves.charges")??0};for(let E of g.levels){if(!E.active.length||E.uses?.max===0)continue;let O=[],M=E.isCantrip,N=E.active.filter(R=>R&&R.uses?.max!==0);for(let R=0;R<N.length;R++){let{spell:G,expended:W,virtual:_,uses:ye,castLevel:P}=N[R];U(G.name,e)&&O.push({name:G.name,img:G.img,tradition:m,castLevel:P??G.level,slotId:R,entryId:f,itemId:G.id,inputId:g.isInnate?G.id:g.id,inputPath:b?"flags.pf2e-staves.charges":g.isInnate?"system.location.uses.value":`system.slots.slot${E.level}.value`,isCharge:b,isActiveCharge:b&&c,isVirtual:_,isInnate:g.isInnate,isCantrip:M,isFocus:v,isPrepared:g.isPrepared,isSpontaneous:g.isSpontaneous||g.isFlexible,slotLevel:E.level,uses:ye??(b?w:E.uses),expended:W??(v&&!M?s.value<=0:!1),action:G.system.time.value,type:b?k?`${D}.spells.staff`:`${D}.spells.charges`:g.isInnate?"PF2E.PreparationTypeInnate":g.isSpontaneous?"PF2E.PreparationTypeSpontaneous":g.isFlexible?"PF2E.SpellFlexibleLabel":v?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:b?0:g.isPrepared?1:v?2:g.isInnate?3:g.isSpontaneous?4:5})}if(O.length){if(v)if(M)n=!0;else{o.push(...O);continue}r[E.level]??=[],r[E.level].push(...O)}}})),r.length){let p=h("spells")?(f,m)=>f.order===m.order?H(f.name,m.name):f.order-m.order:(f,m)=>H(f.name,m.name);r.forEach(f=>f.sort(p))}o.length&&(o.sort((p,f)=>H(p.name,f.name)),r[12]=o,n=!1);let d=(await t.spellcasting.ritual?.getSheetData())?.levels.flatMap((p,f)=>p.active.map(({spell:m})=>{if(U(m.name,e))return{name:m.name,img:m.img,slotId:f,itemId:m.id,level:m.level,time:m.system.time.value}}).filter(Boolean));if(r.length||d?.length){let p=Wt(t),f=r.length+ +((d?.length??0)>0);return{contentData:{spells:r,rituals:d,focusPool:s,stavesActive:c,hasFocusCantrips:n,attackMod:qt(p)?p[0].mod:null,entryRank:m=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:pt(m)})},doubled:f>1&&h("spells-columns")}}}u(Gt,"getSpellsData");function Wt(t){return t.spellcasting.filter(e=>e.statistic).map(({statistic:e,name:s,id:i})=>({name:s,id:i,mod:q(e.mod),statistic:e}))}u(Wt,"getSpellAttacks");function qt(t){return new Set(t.map(({mod:e})=>e)).size===1}u(qt,"hasSingleSpellAttack");function Kt({el:t,actor:e,hud:s}){K(t.find(".spell")),t.find("[data-action=spell-description]").on("click",async i=>{i.preventDefault();let a=$(i.currentTarget).closest(".spell");B(a,e)}),e.isOwner&&(t.find("[data-action=spell-attack]").on("click",async i=>{i.preventDefault();let a=Wt(e);if(!a.length)return;let c;if(qt(a))c=a[0].statistic;else{let n=await Dialog.wait({buttons:{ok:{icon:'<i class="fa-solid fa-dice-d20"></i>',label:C("spells.attacks.ok"),callback:l=>l.find("input:checked").val()}},title:C("spells.attacks.title"),content:await renderTemplate(F("dialogs/spell-attacks"),{attacks:a}),close:()=>null});n&&(c=e.items.get(n)?.statistic)}let r=Ce(i),{map:o}=i.currentTarget.dataset;o&&(r.modifiers=[new game.pf2e.Modifier({label:"PF2E.MultipleAttackPenalty",modifier:Number(o)})]),c?.check.roll(r)}),t.find("[data-action=spell-chat]").on("click",async i=>{i.preventDefault();let a=z(i,e);a&&(a.toMessage(i,{create:!0}),h("chat-close")&&s.close())}),t.find("[data-action=toggle-pips]").on("click contextmenu",async i=>{i.preventDefault();let a=i.type==="click"?1:-1,c=(e.system.resources.focus?.value??0)+a;await e.update({"system.resources.focus.value":c})}),t.find("[data-action=toggle-prepared]").on("click",i=>{i.preventDefault();let{slotLevel:a,slotId:c,entryId:r,expended:o}=$(i.currentTarget).closest(".spell").data();e.spellcasting.collections.get(r)?.setSlotExpendedState(a??0,c??0,o!==!0)}),t.find("[data-action=cast-spell]").on("click",i=>{i.preventDefault();let{slotLevel:a,slotId:c,entryId:r,itemId:o}=$(i.currentTarget).closest(".spell").data(),n=e.spellcasting.collections.get(r,{strict:!0});if(!n)return;let l=n.get(o,{strict:!0});l&&(n.entry.cast(l,{slot:c,level:a}),h("cast-close")&&s.close())}),t.find("[data-input-path]").on("change",async i=>{let{inputPath:a,entryId:c}=$(i.currentTarget).data(),r=i.currentTarget.valueAsNumber;await e.updateEmbeddedDocuments("Item",[{_id:c,[a]:r}])}))}u(Kt,"addSpellsListeners");var qs=["#combat-popout","#sidebar","#mini-tracker","#combat-dock","#combat-carousel","[id^=pf2e-perception]"].join(", "),Vt={left:["left","right","top","bottom"],right:["right","left","top","bottom"],top:["top","bottom","left","right"],bottom:["bottom","top","left","right"]},me={opposition:{icon:"fa-solid fa-face-angry-horns",label:"PF2E.Actor.Creature.Alliance.Opposition"},party:{icon:"fa-solid fa-face-smile-halo",label:"PF2E.Actor.Creature.Alliance.Party"},neutral:{icon:"fa-solid fa-face-meh",label:"PF2E.Actor.Creature.Alliance.Neutral"}},Ks=[{type:"land",icon:"fa-solid fa-shoe-prints"},{type:"burrow",icon:"fa-solid fa-chevrons-down"},{type:"climb",icon:"fa-solid fa-spider"},{type:"fly",icon:"fa-solid fa-feather"},{type:"swim",icon:"fa-solid fa-person-swimming"}],Vs={actions:{getData:$t,addListeners:Nt},items:{getData:zt,addListeners:Bt},spells:{getData:Gt,addListeners:Kt},skills:{getData:Lt,addListeners:Ot},extras:{getData:Pt,addListeners:Mt},hazard:{getData:Ht,addListeners:_t}},ge={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},Js={perception:{icon:"fa-solid fa-eye",label:"PF2E.PerceptionLabel"},stealth:{icon:"fa-duotone fa-eye-slash",label:"PF2E.SkillStealth"},athletics:{icon:"fa-solid fa-hand-fist",label:"PF2E.SkillAthletics"}},he=class extends Application{#e=null;#d=null;#s=null;#a=null;#l=!1;#o=null;#u=[!1,!1,!1];#t=!1;#i=!1;#n=!1;#p;#r;#f;constructor(){super(),this.forceClose=()=>this.close({force:!0}),this.#p=(e,s)=>{s?this.#y(e):this.#b(e)},this.#r=e=>{let s=e.button;if(![0,2].includes(s))return;if(e.type==="mouseup"){this.#u[s]=!1;return}this.#u[s]=!0;let i=e.target,a=this.element[0];if(a){let c=a.querySelector(".popup");if(c&&!c.contains(i))if(!a.querySelector(".sidebar"))this.forceClose();else return c.remove();i.closest("canvas")&&this.forceClose();return}else this.#g();this.unlock(!0)},this.#f=e=>{this.#e&&e.id===this.#e.id&&this.forceClose()},window.addEventListener("mousedown",this.#r),window.addEventListener("mouseup",this.#r),Hooks.on("hoverToken",this.#p),Hooks.on("deleteToken",this.#f),Hooks.on("canvasPan",this.forceClose)}setToken(e,s){if(e!==this.#e){delete this.#e?.actor?.apps[this.appId],this.#e=e;let i=e?.actor;i&&(i.apps[this.appId]=this)}this.#n=s??this.#m(e)}setHolding(e){let s=h("use-holding");if(s!=="none"&&(this.#l=e,!(this.#i||this.#t)))if(e){if(!this.#s)return;let i=this.#m(this.#s);if(s==="half"&&!game.user.isGM&&!i){this.#g(),this.render();return}this.setToken(this.#s,i),this.render()}else s==="all"?this.close():game.user.isGM?(this.setToken(this.#s),this.render()):this.#n&&this.close()}#m(e){let s=e?.actor;if(!s)return!1;let i,a=s.system.details.alliance==="party";return game.user.isGM&&h("use-holding")==="half"&&!this.#l||s.isOfType("familiar")&&!s.master?i=!1:i=e.isOwner||h("observer")&&(e.observer||a&&h("party")),i}#y(e){if($(window.document).find(":hover").filter(qs).length)return;let s=e.actor;if(!s||s.isOfType("loot","party")||e.document.disposition===CONST.TOKEN_DISPOSITIONS.SECRET&&!s.isOwner||(this.#s=e,e!==this.#d&&!this.#t&&this.close(),this.mousedown||this.#t||this.#i||e===this.#e))return;let i=h("use-holding"),a=this.#m(e);i!=="none"&&!this.#l&&(i==="all"||a)||(this.#w(!0),this.setToken(e,a),i==="none"||!this.#l?this.renderWithDelay():this.render())}#b(e){this.#s=null,!(this.mousedown||this.#t||this.#i)&&(this.#o=setTimeout(()=>{this.#o=null,!(this.#i||this.#t)&&this.close()},10))}renderWithDelay(){let e=h("delay");e?(e<10&&(e=10),this.#a=setTimeout(()=>{this.#a=null,this.render()},e)):this.render()}#w(e){this.#o!==null&&(clearTimeout(this.#o),this.#o=null,e&&this.close())}#g(){this.#a!==null&&(clearTimeout(this.#a),this.#a=null)}delete(){this.forceClose(),window.removeEventListener("mousedown",this.#r),window.removeEventListener("mouseup",this.#r),Hooks.off("hoverToken",this.#p),Hooks.off("deleteToken",this.#f),Hooks.off("canvasPan",this.forceClose)}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,minimizable:!1,template:F("hud")})}get mousedown(){return this.#u[0]||this.#u[2]}get token(){return this.#e}get actor(){return this.#e?.actor}get hasCover(){return!!Be(this.actor)}get isCharacter(){return this.actor?.isOfType("character")}get sidebar(){return this.element?.find("> .sidebar")??[]}get popup(){return this.element?.find("> .popup")??[]}get inner(){return this.element?.find("> .inner")??[]}async getData(){let e=this.#e,s=this.#e?.actor;if(!s)return{};let i=null,a=h("saves"),c=h("others"),r=this.isCharacter,{attributes:o}=s,{hp:n,ac:l}=o,d=n.sp??{max:0,value:0},p=game.settings.get("pf2e","staminaVariant"),f=h("distance"),m=h("scale");if(f==="all"||f==="self"&&this.#n){let I=h("unit").split(","),A=Number(I[0]?.trim())||1,L=I[1]?.trim()||game.system.gridUnits,x=Number(I[2]?.trim())||0,j=canvas.tokens.controlled,Z=!1,ee=j.length===1?j[0]:null;(!ee||ee===e)&&(ee=Le(),Z=!0),ee&&ee!==e&&(i={unit:L,icon:Z?'<i class="fa-solid fa-crosshairs-simple"></i>':'<i class="fa-solid fa-expand"></i>',range:(e.distanceTo(ee)*A).toFixed(x)})}let g;if(!this.#n||h("see-status")){let I=h("status").split(",").map(A=>A.trim()).filter(Boolean);if(I.length&&n.max){let A=n.max+(p?d.max:0),L=n.value+(p?d.value:0),x=Math.clamped(L/A,0,1),j=(()=>{let Z=I.length;return h("last-status")?x===1?Z:Math.ceil(x*(Z-1)):Math.ceil(x*Z)})();g={hue:x*x*122+3,value:j===0?game.i18n.localize("EFFECT.StatusDead"):I.at(j-1)}}}let v={status:g,distance:i,fontSize:m,tokenId:e.id,type:s.isOfType("creature")?"creature":s.type};if(!this.#n||s.isOfType("familiar")&&!s.master)return v;let{level:b,saves:k,isOwner:w,system:E,itemTypes:O}=s,{resistances:M,weaknesses:N,immunities:R}=o;v={...v,isOwner:w,isObserver:this.#n,name:e.document.name,hp:n,ac:l.value,level:b,hasActions:O.action.length||E.actions?.filter(I=>I.visible!==!1).length};let G=h("ranks");function W(I,A,L){let x=I.slug,j=A==="bonus"?q(I.mod):I.dc.value;return{slug:x,value:j,label:L[x].label,icon:L[x].icon,rank:G&&Ee[I.rank]}}u(W,"getStatistic");function _(I,A){if(!I.length)return"";let L=I.map(x=>He(x.label.replace("-"," ").titleCase())).join("");return A?`<li>${game.i18n.localize(A)}<ul>`+L+"</ul></li>":L}if(u(_,"toIWR"),s.isOfType("hazard")){let{hardness:I,emitsSound:A,stealth:L}=o;return{...v,hardness:I,emitsSound:A.toString().capitalize(),immunities:_(R),weaknesses:_(N),resistances:_(M),stealth:{value:L.value,details:await te(L.details,s)},saves:a!=="none"&&["fortitude","reflex","will"].map(x=>{let j=k[x];return j?W(j,a,ge):{slug:x,label:ge[x].label,icon:ge[x].icon}})}}if(v={...v,sidebarTitles:{actions:`${D}.actions.title`,items:`${D}.items.title`,spells:`${D}.spells.title`,skills:`${D}.skills.title`,extras:`${D}.extras.title`},hasItems:s.inventory.size},s.isOfType("vehicle")){let{hardness:I,collisionDC:A,collisionDamage:L}=o,{details:x}=E,{crew:j,passengers:Z,pilotingCheck:ee,speed:cs}=x;return{...v,hardness:I,crew:j,passengers:Z,pilotingCheck:ee,speed:cs,collisionDC:A.value,collisionDamage:L.value,immunities:_(R),weaknesses:_(N),resistances:_(M),fortitude:W(k.fortitude,a,ge)}}let ye=h("show-death"),{heroPoints:P}=s,{traits:J,resources:Ue}=E,{wounded:Xe,dying:Ze,shield:ss,speed:be,adjustment:is}=o;function He(I){return`<li>${I.trim()}</li>`}u(He,"toInfo");function ns(I,A){return H(I,A)}u(ns,"sort");let as=J?.languages?.value.map(I=>game.i18n.localize(CONFIG.PF2E.languages[I])).filter(Boolean).sort(ns).map(He).join(""),os=r?J.senses.map(I=>I.label):J.senses.value?.split(","),re=Ks.map(({type:I,icon:A},L)=>({index:L,icon:A,label:game.i18n.localize(CONFIG.PF2E.speedTypes[I]??"PF2E.SpeedTypesLand"),value:(L===0?be.total:be.otherSpeeds.find(x=>x.type===I)?.total)||0})),et=Y(s,`speeds.selected.${game.user.id}`),rs=(()=>{let I=0;if(et!==void 0)I=et;else if(h("force-speed")||re[0].value===0){let A={index:0,value:re[0].value};I=re.reduce((L,{value:x},j)=>x>L.value?{index:j,value:x}:L,A).index}return re.splice(I,1)[0]})(),tt=re.map(({value:I,label:A,index:L})=>`<li><a data-value="${L}">${A}: ${I}</a></li>`).join("");return be.details&&(tt+=`<li>${game.i18n.localize("PF2E.DetailsHeading")}: ${be.details}</li>`),{...v,sp:p?d:{max:0},hero:P,dying:Ze,wounded:Xe,shield:ss,resolve:Ue.resolve,adjustment:is,alliance:me[Qt(s).alliance],isCharacter:r,showDeathLine:r&&(ye==="always"||Ze.value||Xe.value),digitalPips:h("pips"),hasCover:this.hasCover,saves:a!=="none"&&["fortitude","reflex","will"].map(I=>W(k[I],a,ge)),others:c!=="none"&&["perception","stealth","athletics"].map(I=>W(s.getStatistic(I),c,Js)),speeds:{main:rs,others:tt},iwr:_(R,"PF2E.ImmunitiesLabel")+_(N,"PF2E.WeaknessesLabel")+_(M,"PF2E.ResistancesLabel"),senses:os?.filter(Boolean).map(He).join(""),languages:as,hasSpells:s.spellcasting.some(I=>I.category!=="items"),hasNotes:!r&&(E.details.publicNotes||E.details.privateNotes&&w)}}close(e={}){this.setToken(null),this.unlock(!0),this.#i=!1,this.#g();let s=Application.RENDER_STATES;if(!e.force&&![s.RENDERED,s.ERROR].includes(this._state))return;this._state=s.CLOSING;let i=this.element;if(!i)return this._state=s.CLOSED;i.css({minHeight:0});for(let a of this.constructor._getInheritanceChain())Hooks.call(`close${a.name}`,this,i);i.remove(),this._element=null,this._state=s.CLOSED,delete ui.windows[this.appId]}async _render(e=!1,s={}){let i,a,c,r,o;if(this.#d===this.#e){let n=this.sidebar[0];if(n){i=n.dataset.type,a=n.scrollTop;let l=n.querySelector(".sidebar-header");l.classList.contains("show")&&(o=l.querySelector(" input").value.trim())}c=this.popup[0],c&&(r=c.scrollTop)}if(await super._render(e,s),ui.windows[this.appId]=this,i){let n=await this.#c(i,o);a>0&&n.scrollTop(a)}c&&(this.element.append(c),r>0&&(c.scrollTop=r)),this.#d=this.#e,this.inner.length&&h("autolock")==="render"&&this.lock()}render(){this.actor&&super.render(!0)}_injectHTML(e){$("body").append(e),this._element=e}setPosition(){let e=this.#e;if(!e)return;let s=this.element[0],i=e.worldTransform.a,a=s.getBoundingClientRect(),c=canvas.clientCoordinatesFromCanvas(e.document._source),r={x:c.x,y:c.y,width:e.hitArea.width*i,height:e.hitArea.height*i,get right(){return this.x+this.width},get bottom(){return this.y+this.height}},o,n=this.#n?Vt[h("position")].slice():Vt[h("small-position")].slice();for(;n.length&&!o;){let l=n.shift();l==="left"?(o={x:r.x-a.width,y:Ye(a,r)},o.x<0&&(o=void 0)):l==="right"?(o={x:r.right,y:Ye(a,r)},o.x+a.width>window.innerWidth&&(o=void 0)):l==="top"?(o={x:Jt(a,r),y:r.y-a.height},o.y<0&&(o=void 0)):l==="bottom"&&(o={x:Jt(a,r),y:r.bottom},o.y+a.height>window.innerHeight&&(o=void 0))}return o&&(s.style.left=`${o.x}px`,s.style.top=`${o.y}px`),o}lock(){this.#t=!0}unlock(e){!e&&(this.sidebar.length||h("autolock")!=="none")||(this.#t=!1)}activateListeners(e){let s=this.#e,i=s?.actor;if(!i)return;let a=s.isOwner,c=Q();h("tooltips")&&e.find(".inner [data-tooltip]").attr("data-tooltip",""),e.find("[data-action=show-notes").on("click",async n=>{n.preventDefault();let{publicNotes:l,privateNotes:d,blurb:p}=i.system.details,f=i.system.traits.value.map(g=>({label:game.i18n.localize(CONFIG.PF2E.creatureTraits[g])??g,description:game.i18n.localize(CONFIG.PF2E.traitsDescriptions[g])??""})),m=await renderTemplate(F("show-notes"),{traits:f,blurb:p.trim(),publicNotes:l.trim(),privateNotes:a&&d.trim()});ie(`${i.name} - ${game.i18n.localize("PF2E.NPC.NotesTab")}`,m,i)}),e.on("mousedown",()=>this.bringToTop()),e.on("mouseenter",()=>{e.find(".inner").length&&(h("autolock")==="hover"&&this.lock(),this.#i=!0)}),e.on("mouseleave",()=>{this.#i=!1,!(this.#t||this.#s)&&this.close()}),e.on("dragover",()=>{s.isOwner&&e.find("> .sidebar.extras").length&&!e.find("> .popup").length||(e.css("opacity",.1),e.css("pointerEvents","none"),window.addEventListener("dragend",()=>{e.css("opacity",1),e.css("pointerEvents","")},{once:!0}))});let r=e.find("[data-action=show-info]");(a?r.filter(":not(.speeds)"):r).on("click",n=>{let l=n.currentTarget,d=l.dataset.tooltipContent;l.classList.contains("stealth")?this.#h({content:d,event:n,direction:"DOWN"}):fe({target:l,content:d,direction:"UP"})}),e.find("[data-action=open-sidebar]").on("click",this.#c.bind(this)),a&&(e.find("[data-action=toggle-adjustment]").on("click contextmenu",n=>{n.preventDefault();let l=n.type==="click"?"elite":"weak";i.applyAdjustment(i.system.attributes.adjustment===l?null:l)}),e.find("[data-action=toggle-alliance]").on("click",n=>{let{originalAlliance:l,defaultAlliance:d}=Qt(i),p=[{value:"default",label:game.i18n.format("PF2E.Actor.Creature.Alliance.Default",{alliance:game.i18n.localize(me[d].label)})},{value:"opposition",label:game.i18n.localize(me.opposition.label)},{value:"party",label:game.i18n.localize(me.party.label)},{value:"neutral",label:game.i18n.localize(me.neutral.label)}];this.#h({content:p,event:n,selected:l,onClick:f=>{f==="default"?i.update({"system.details.-=alliance":null}):i.update({"system.details.alliance":f==="neutral"?null:f})}})}),e.find("[data-action=collision-dc]").on("click",n=>{n.preventDefault();let l=i.system.attributes.collisionDC.value||15;c.create({content:`@Check[type:reflex|dc:${l}]`,speaker:c.getSpeaker({actor:i})})}),e.find("[data-action=collision-damage]").on("click",async n=>{n.preventDefault();let l=(i.system.attributes.collisionDamage.value||"1d6").trim();isNaN(Number(l.at(-1)))||(l+="[bludgeoning]");let d=it(),p=await new d(l).evaluate({async:!0});c.create({flavor:`<strong>${game.i18n.localize("PF2E.vehicle.collisionDamageLabel")}</strong>`,speaker:c.getSpeaker({actor:i}),type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:"sounds/dice.wav",rolls:[p]})}),e.find("input").on("change",async n=>{let l=n.currentTarget,d=l.valueAsNumber,p=l.name;l.blur(),p!=="shield.value"?await i.update({[p]:d}):await i.heldShield.update({"system.hp.value":d})}),e.find("[data-action=toggle-hero]").on("click contextmenu",n=>{n.preventDefault();let{max:l,value:d}=i.heroPoints,p=n.type==="click"?1:-1,f=Math.clamped(d+p,0,l);f!==d&&i.update({"system.resources.heroPoints.value":f})}),e.find("[data-action=raise-shield]").on("click",n=>{n.preventDefault(),game.pf2e.actions.raiseAShield({actors:[i],tokens:[s]})}),e.find("[data-action=take-cover]").on("click",async n=>{n.preventDefault();let l=Be(i);l?l.delete():game.pf2e.actions.get("take-cover").use({actors:[i],tokens:[s]})}),e.find("[data-action=roll-save]").on("click",n=>{n.preventDefault();let l=n.currentTarget.dataset.save;i.saves[l].roll({event:n})}),e.find("[data-action=roll-other]").on("click",n=>{n.preventDefault();let l=n.currentTarget.dataset.slug;if(l!=="athletics"){let{ctrlKey:d,metaKey:p,shiftKey:f}=n;n=new MouseEvent("click",{ctrlKey:!d,metaKey:p,shiftKey:f})}i.getStatistic(l)?.roll({event:n})}),e.find("[data-action=recovery-check]").on("click",n=>{n.preventDefault(),i.rollRecovery(n)}),e.find("[data-action=toggle-dying], [data-action=toggle-wounded]").on("click contextmenu",n=>{n.preventDefault();let l=n.currentTarget.dataset.action==="toggle-dying"?"dying":"wounded",d=i.system.attributes[l]?.max;d&&(n.type==="click"?i.increaseCondition(l,{max:d}):i.decreaseCondition(l))}),e.find("[data-action=use-resolve]").on("click",n=>{n.preventDefault(),st(i)}),r.filter(".speeds").on("click",n=>{this.#h({event:n,content:n.currentTarget.dataset.tooltipContent,direction:"UP",onClick:l=>{se(i,`speeds.selected.${game.user.id}`,Number(l))}})}))}#h({content:e,event:s,onClick:i,selected:a,direction:c,locked:r}){fe({content:e,target:s.currentTarget,direction:c,selected:a,locked:!0,onCreate:()=>this.lock(),onClick:i,onDismiss:()=>this.unlock()})}async showFilter(){let e=this.sidebar;e.length&&(e.find(".sidebar-header").hasClass("show")||(e=await this.#c(e.data().type,"")),e.find(".sidebar-header").find("input").focus().select(),e.scrollTop(0))}async#c(e,s){e=typeof e=="string"?e:e.currentTarget.dataset.type;let i=this.element,a=this.sidebar,c=a[0]?.dataset.type;if(a.remove(),i.find("[data-action=open-sidebar]").removeClass("active"),c===e&&s===void 0){this.unlock();return}let r=this.#e,o=r.actor,n=s!==void 0||h("filter"),{getData:l,addListeners:d}=Vs[e],p=await l({hud:this,actor:o,token:r,filter:s?.toLowerCase()})??{};if(!p.contentData&&!n)return ui.notifications.warn(C(`${e}.empty`,{name:this.#e.name}));let f={...p.contentData??{},isGM:game.user.isGM,isCharacter:this.isCharacter,isOwner:o.isOwner};this.lock(),i.find(`[data-action=open-sidebar][data-type=${e}]`).addClass("active"),i=i[0];let m=p.classes??[];m.push(e),h("scrollbar")||m.push("no-scrollbar"),p.doubled&&m.push("doubled");let g=p.style??{};g["--max-height"]=h("height").trim()||"100%";let v=document.createElement("div");v.innerHTML=await renderTemplate(F("sidebar"),{classes:m.join(" "),style:Object.entries(g).map(([N,R])=>`${N}: ${R}`).join("; "),type:e,filter:s,filterLabel:C("filter"),showFilter:n,content:(await renderTemplate(F(`sidebars/${e}`),f)).trim()}),a=v.firstElementChild,i.append(a);let b=a.getBoundingClientRect(),k=i.getBoundingClientRect(),w;h("position")==="left"?(w=k.x-b.width,w<0&&(w=k.right)):(w=k.right,w+b.width>window.innerWidth&&(w=k.x-b.width));let O=parseInt(window.getComputedStyle(i).padding),M=Ye(b,k,O);return a.style.left=`${w}px`,a.style.top=`${M}px`,a=$(a),a.find(".sidebar-header [data-action=sidebar-filter-clear]").on("click",N=>{N.preventDefault(),a.find(".sidebar-header [data-action=sidebar-filter]").val(""),this.#c(e,"")}),a.find(".sidebar-header [data-action=sidebar-filter]").on("keydown",N=>{N.key==="Enter"&&this.#c(e,N.currentTarget.value.trim())}),d({el:a,actor:o,token:r,hud:this}),Hooks.callAll("renderHUDSidebar",e,a,this),a}};u(he,"HUD");function Ye(t,e,s=0){let i=e.y+e.height/2-t.height/2;return i+t.height>window.innerHeight&&(i=window.innerHeight-t.height-s),i<0&&(i=s),i}u(Ye,"postionFromTargetY");function Jt(t,e){let s=e.x+e.width/2-t.width/2;return s+t.width>window.innerWidth&&(y=window.innerWidth-t.width),s<0&&(s=0),s}u(Jt,"postionFromTargetX");function Qt(t){let e=t._source.system.details?.alliance,s=e===null?"neutral":e??"default",i=t.hasPlayerOwner?"party":"opposition";return{defaultAlliance:i,originalAlliance:s,alliance:s==="default"?i:s}}u(Qt,"getAlliance");var D="pf2e-token-hud",ae=null;function X(t=!1){return t?ae?.element:ae}u(X,"getHud");function Ne(t){t&&!ae?ae=new he:!t&&ae&&(ae.delete(),ae=null)}u(Ne,"enableModule");function h(t){return game.settings.get(D,t)}u(h,"getSetting");function C(...t){let e=t.at(-1),s=typeof e=="object",i=s?t.slice(0,-1):t;return i.unshift(D),game.i18n[s?"format":"localize"](i.join("."),e)}u(C,"localize");function qe(t,e){return t.itemTypes.feat.some(s=>s.sourceId===e)}u(qe,"hasFeat");function F(t){return`modules/${D}/templates/${t}.hbs`}u(F,"templatePath");function q(t){return t>=0?`+${t}`:t}u(q,"modifier");function Y(t,e){return t.getFlag(D,e)}u(Y,"getFlag");function se(t,e,s){return t.setFlag(D,e,s)}u(se,"setFlag");async function te(t,e,{isOwner:s=e.isOwner,rollData:i=e.getRollData()}={}){return t=t?.trim(),t?await TextEditor.enrichHTML(t,{async:!0,secrets:s,rollData:i}):""}u(te,"enrichHTML");function Se(t,e){if(typeof t!="object")return!1;for(;t=Reflect.getPrototypeOf(t);)if(t.constructor.name===e)return!0;return!1}u(Se,"isInstanceOf");function Zt(){Xt("hold",{onDown:()=>{h("use-holding")!=="none"&&X()?.setHolding(!0)},onUp:()=>{X()?.setHolding(!1)}}),Xt("filter",{onUp:()=>{X()?.showFilter()},editable:[{key:"KeyQ",modifiers:["Control"]}]})}u(Zt,"registerKeybindings");function Yt(t,e){return`${D}.keybinds.${t}.${e}`}u(Yt,"path");function Xt(t,e={}){game.keybindings.register(D,t,{name:Yt(t,"name"),hint:Yt(t,"hint"),precedence:CONST.KEYBINDING_PRECEDENCE.PRIORITY,...e})}u(Xt,"register");function es(){let t=game.data.users.find(s=>s._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER,e=["first","second","third","fourth"].map(s=>C(`settings.status.statuses.${s}`)).join(", ");S("status",String,e,{scope:"world"}),S("last-status",Boolean,!1,{scope:"world"}),S("party",Boolean,!1,{scope:"world"}),S("enabled",Boolean,!0,{onChange:Ne}),S("position",String,"right",{choices:{left:T("position","choices.left"),right:T("position","choices.right"),top:T("position","choices.top"),bottom:T("position","choices.bottom")}}),S("small-position",String,"top",{choices:{left:T("position","choices.left"),right:T("position","choices.right"),top:T("position","choices.top"),bottom:T("position","choices.bottom")}}),S("delay",Number,250,{range:{min:0,max:2e3,step:50}}),S("scale",Number,14,{range:{min:10,max:30,step:1}}),S("use-holding",String,"none",{hint:T("use-holding",t?"choices.gm.hint":"choices.player.hint"),choices:{none:T("use-holding","choices.none"),half:T("use-holding",t?"choices.gm.half":"choices.player.half"),all:T("use-holding",t?"choices.gm.all":"choices.player.all")}}),S("autolock",String,"none",{choices:{none:T("autolock","choices.none"),hover:T("autolock","choices.hover"),render:T("autolock","choices.render")}}),S("chat-close",Boolean,!1),S("observer",Boolean,!0),S("see-status",Boolean,!1),S("saves",String,"bonus",{choices:{none:T("saves","choices.none"),bonus:T("saves","choices.bonus"),dc:T("saves","choices.dc")}}),S("others",String,"none",{choices:{none:T("saves","choices.none"),bonus:T("saves","choices.bonus"),dc:T("saves","choices.dc")}}),S("ranks",Boolean,!1),S("show-death",String,"always",{choices:{none:T("show-death","choices.none"),always:T("show-death","choices.always"),only:T("show-death","choices.only")}}),S("force-speed",Boolean,!1),S("tooltips",Boolean,!1),S("pips",Boolean,!1),S("distance",String,"all",{choices:{none:T("distance","choices.none"),self:T("distance","choices.self"),all:T("distance","choices.all")}}),S("unit",String,""),S("height",String,""),S("filter",Boolean,!1),S("scrollbar",Boolean,!0),S("hazard-width",Number,32,{range:{min:14,max:50,step:1}}),S("actions-columns",Boolean,!1),S("items-columns",Boolean,!1),S("spells-columns",Boolean,!1),S("skills-columns",Boolean,!1),S("actions",String,"split",{choices:{name:T("actions","choices.name"),type:T("actions","choices.type"),split:T("actions","choices.split")}}),S("actions-colors",Boolean,!0),S("attack-close",Boolean,!1),S("containers",Boolean,!1),S("spells",Boolean,!1),S("tradition",Boolean,!1),S("cast-close",Boolean,!1),S("untrained",Boolean,!0)}u(es,"registerSettings");function ts(t,e){let s=e.find(`.tab[data-tab=${D}]`);function i(a,c,r="h3"){let o=C(`menu.${c}`);s.find(`[name="${D}.${a}"]`).closest(".form-group").before(`<${r}>${o}</${r}>`)}u(i,"beforeGroup"),game.user.isGM&&i("enabled","client.header","h2"),i("saves","client.tooltip"),i("distance","client.distance"),i("height","client.sidebar"),i("actions","client.actions"),i("containers","client.items"),i("spells","client.spells"),i("untrained","client.skills")}u(ts,"renderSettingsConfig");function T(t,e){return`${D}.settings.${t}.${e}`}u(T,"path");function S(t,e,s,i={}){game.settings.register(D,t,{name:T(t,"name"),hint:T(t,"hint"),scope:"client",config:!0,type:e,default:s,...i})}u(S,"register");Hooks.once("setup",async()=>{es(),Zt(),await loadTemplates({creature:F("tooltips/creature"),hazard:F("tooltips/hazard"),vehicle:F("tooltips/vehicle")})});Hooks.once("ready",()=>{h("enabled")&&Ne(!0),game.modules.get("pf2e-token-hud").api={getHud:X}});Hooks.on("renderSettingsConfig",ts);Hooks.on("drawMeasuredTemplate",t=>{t.isPreview&&X()?.close()});Hooks.on("getActorDirectoryEntryContext",(t,e)=>{e.unshift({icon:'<i class="fa-solid fa-code"></i>',name:`${D}.actor.macros.contextmenu`,condition:s=>{let{documentId:i}=s.data();return h("enabled")&&game.actors.get(i)?.isOwner},callback:s=>{let{documentId:i}=s.data();Qs(i)}})});var Re=class extends Dialog{async getData(e={}){let s=super.getData(e);return typeof s.content=="function"&&(s.content=await s.content()),s}};u(Re,"DataDialog");function Qs(t){let e=game.actors.get(t);if(!e)return;let s=new Re({title:`${e.name} - ${C("actor.macros.title")}`,content:async()=>{let i=De(e)??[];return renderTemplate(F("dialogs/macros"),{macros:i,noMacro:C("extras.no-macro")})},buttons:{},render:i=>{e.apps[s.appId]=s,i.on("drop",a=>xe(a,e)),i.find("[data-action=delete-macro]").on("click",a=>Ae(a,e))},close:()=>{delete e.apps[s.appId]}},{height:"auto"}).render(!0)}u(Qs,"openMacrosDialog");})();
//# sourceMappingURL=main.js.map
