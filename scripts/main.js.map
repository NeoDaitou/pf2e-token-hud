{
  "version": 3,
  "sources": ["../../../../../dev/module-api/utils/array.js", "../../../../../dev/module-api/utils/object.js", "../../../../../dev/module-api/foundry/module.js", "../../../../../dev/module-api/foundry/settings.js", "../../../../../dev/module-api/foundry/tooltip.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/purry.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/isTruthy.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/compact.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/_reduceLazy.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/isArray.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/isObject.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/isString.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/isEmpty.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/isNil.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/uniq.js", "../../../../../dev/module-api/pf2e/actor.js", "../../../../../dev/module-api/pf2e/html.js", "../../../../../dev/module-api/pf2e/misc.js", "../../../../../dev/module-api/pf2e/tags.js", "../../../../../dev/module-api/pf2e/chat.js", "../../../../../dev/module-api/pf2e/classes.js", "../../../../../dev/module-api/pf2e/dc.js", "../../../../../dev/module-api/pf2e/spell.js", "../../../../../dev/module-api/pf2e/identify.js", "../../../../../dev/module-api/pf2e/scripts.js", "../../../../../dev/module-api/pf2e/inline-roll.js", "../../../../../dev/module-api/pf2e/item.js", "../../../../../dev/module-api/pf2e/success.js", "../src/actions/use-resolve.js", "../src/shared.js", "../src/popup.js", "../src/actions/recall-knowledge.js", "../src/sidebars/skills.js", "../src/sidebars/extras.js", "../src/sidebars/actions.js", "../src/sidebars/hazard.js", "../src/sidebars/items.js", "../src/sidebars/spells.js", "../src/hud.js", "../src/module.js", "../src/keybindings.js", "../src/settings.js", "../src/main.js"],
  "sourcesContent": ["/**\r\n * @template T\r\n *\r\n * @param {T[]} arr\r\n * @param {(value: T) => unknown} fn\r\n * @param {string | number} [key]\r\n * @returns {Record<T, unknown>}\r\n */\r\n\r\nexport function arrayToObject(arr, fn, key) {\r\n\tconst obj = {};\r\n\tfor (const entry of arr) {\r\n\t\tconst k = Array.isArray(entry)\r\n\t\t\t? entry[key ?? 0]\r\n\t\t\t: typeof entry === \"object\" && key != null\r\n\t\t\t  ? entry[key]\r\n\t\t\t  : entry;\r\n\t\tobj[k] = fn(entry);\r\n\t}\r\n\treturn obj;\r\n}\r\n\r\n/**\r\n *\r\n * @param {unknown[]} arr1\r\n * @param {unknown[]} arr2\r\n * @returns {boolean}\r\n */\r\nexport function compareArrays(arr1, arr2) {\r\n\tif (arr1.length !== arr2.length) return false;\r\n\r\n\tconst clonedArr2 = arr2.slice();\r\n\r\n\tfor (const arr1Value of arr1) {\r\n\t\tconst index = clonedArr2.findIndex((arr2Value) => arr1Value === arr2Value);\r\n\t\tif (index === -1) return false;\r\n\t\tclonedArr2.splice(index, 1);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\n/**\r\n * @param {number | undefined} index\r\n * @returns {boolean}\r\n */\r\nexport function indexIsValid(index) {\r\n\treturn index !== undefined && index !== -1;\r\n}\r\n\r\n/**\r\n * @param {number} start\r\n * @param {number} end\r\n * @returns {number[]}\r\n */\r\nexport function sequenceArray(start, end) {\r\n\tconst levels = [];\r\n\r\n\tif (start <= end) {\r\n\t\tfor (let i = start; i <= end; i++) levels.push(i);\r\n\t} else {\r\n\t\tfor (let i = start; i >= end; i--) levels.push(i);\r\n\t}\r\n\r\n\treturn levels;\r\n}\r\n", "export const AsyncFunction = (async () => {}).constructor;\r\n\r\n/**\r\n * @param {object} obj\r\n * @param {string} name\r\n * @returns {boolean}\r\n */\r\nexport function isInstanceOf(obj, name) {\r\n\tif (typeof obj !== \"object\") return false;\r\n\r\n\tlet cursor = Reflect.getPrototypeOf(obj);\r\n\twhile (cursor) {\r\n\t\tif (cursor.constructor.name === name) return true;\r\n\t\tcursor = Reflect.getPrototypeOf(cursor);\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n", "/**\r\n * @type {string}\r\n */\r\nlet MODULE_ID = null;\r\n\r\nexport const MODULE = {\r\n\tget id() {\r\n\t\tif (!MODULE_ID) {\r\n\t\t\tthrow new Error(\"Module id needs to be registered.\");\r\n\t\t}\r\n\t\treturn MODULE_ID;\r\n\t},\r\n\t/**\r\n\t * @param {string} str\r\n\t */\r\n\terror(str) {\r\n\t\tthrow new Error(`[${this.id}] ${str}`);\r\n\t},\r\n};\r\n\r\n/**\r\n * register the module id\r\n * @param {string} id\r\n */\r\nexport function registerModule(id) {\r\n\tMODULE_ID = id;\r\n}\r\n\r\n/**\r\n * @param {string} [id]\r\n * @returns {object}\r\n */\r\nexport function getModule(id) {\r\n\treturn game.modules.get(id ?? MODULE.id);\r\n}\r\n", "import { MODULE } from \".\";\r\nimport { arrayToObject } from \"../utils/array\";\r\n\r\n/**\r\n * @template {number | boolean | string} T\r\n * @param { {key: string, type: new (...args: unknkown[]) => T, default: T, [k: string]: unknown }} options\r\n */\r\nexport function registerSetting(options) {\r\n\toptions.key ??= options.name;\r\n\r\n\tif (Array.isArray(options.choices)) {\r\n\t\toptions.choices = arrayToObject(options.choices, (choice) =>\r\n\t\t\tsettingPath(options.key, \"choices\", choice),\r\n\t\t);\r\n\t}\r\n\r\n\toptions.name = settingPath(options.key, \"name\");\r\n\toptions.hint = settingPath(options.key, \"hint\");\r\n\toptions.scope ??= \"world\";\r\n\toptions.config ??= true;\r\n\r\n\tgame.settings.register(MODULE.id, options.key, options);\r\n}\r\n\r\nexport function registerSettingMenu(options) {\r\n\toptions.key ??= options.name;\r\n\r\n\toptions.name = settingPath(\"menus\", options.key, \"name\");\r\n\toptions.label = settingPath(\"menus\", options.key, \"label\");\r\n\toptions.hint = settingPath(\"menus\", options.key, \"hint\");\r\n\toptions.restricted ??= true;\r\n\toptions.icon ??= \"fas fa-cogs\";\r\n\r\n\tgame.settings.registerMenu(MODULE.id, options.key, options);\r\n}\r\n\r\n/**\r\n * @param {string[]} path\r\n * @returns\r\n */\r\nexport function settingPath(...path) {\r\n\treturn `${MODULE.id}.settings.${path.join(\".\")}`;\r\n}\r\n\r\n/**\r\n * @param {string} setting\r\n * @returns {unknown}\r\n */\r\nexport function getSetting(setting) {\r\n\treturn game.settings.get(MODULE.id, setting);\r\n}\r\n\r\n/**\r\n * @param {string} setting\r\n * @returns {boolean}\r\n */\r\nexport function isChoiceSetting(setting) {\r\n\treturn !!game.settings.settings.get(`${MODULE.id}.${setting}`)?.choices;\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {string} setting\r\n * @param {T} value\r\n * @returns {Promise<T>}\r\n */\r\nexport function setSetting(setting, value) {\r\n\treturn game.settings.set(MODULE.id, setting, value);\r\n}\r\n", "import { MODULE } from \"./module\";\r\nimport { getSetting } from \"./settings\";\r\n\r\n/**\r\n *\r\n * @param {object} options\r\n * @param {HTMLElement} options.target\r\n * @param {HTMLElement} options.selected\r\n * @param {\"DOWN\"|\"UP\"|\"LEFT\"|\"RIGHT\"} [options.direction]\r\n * @param {(tooltip: HTMLElement) => void} [options.onCreate]\r\n * @param {() => void} options.onDismiss\r\n * @param {(value: string) => void} options.onClick\r\n * @param {HTMLElement|string} options.content\r\n * @param {string[]} [options.cssClass]\r\n * @param {boolean} [options.locked]\r\n * @returns {Promise<HTMLElement>}\r\n */\r\nexport async function createTooltip({\r\n\ttarget,\r\n\tselected,\r\n\tdirection = \"DOWN\",\r\n\tonCreate,\r\n\tonDismiss,\r\n\tonClick,\r\n\tcontent,\r\n\tcssClass = [],\r\n\tlocked = false,\r\n}) {\r\n\treturn new Promise((resolve) => {\r\n\t\tconst tooltipClass = `${MODULE.id}-tooltip`;\r\n\r\n\t\tconst exist = document.body.querySelectorAll(\r\n\t\t\t`.${tooltipClass}:not(#tooltip)`,\r\n\t\t);\r\n\t\tfor (const el of exist) {\r\n\t\t\tdismissTooltip(el);\r\n\t\t}\r\n\r\n\t\trequestAnimationFrame(() => {\r\n\t\t\tcssClass = typeof cssClass === \"string\" ? [cssClass] : cssClass;\r\n\t\t\tif (selected) cssClass.push(\"selection-tooltip\");\r\n\r\n\t\t\tif (Array.isArray(content)) {\r\n\t\t\t\tcontent = content\r\n\t\t\t\t\t.map(({ value, label }) => {\r\n\t\t\t\t\t\tconst selectedClass = value === selected ? 'class=\"selected\"' : \"\";\r\n\t\t\t\t\t\treturn `<li><a ${selectedClass} data-value=\"${value}\">${label}</a></li>`;\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.join(\"\");\r\n\t\t\t}\r\n\r\n\t\t\tlet tooltip;\r\n\r\n\t\t\tif (content instanceof HTMLElement) {\r\n\t\t\t\ttooltip = content;\r\n\t\t\t} else {\r\n\t\t\t\ttooltip = document.createElement(\"ul\");\r\n\t\t\t\ttooltip.innerHTML = content;\r\n\t\t\t}\r\n\r\n\t\t\ttooltip.style.setProperty(\"--font-size\", `${getSetting(\"scale\")}px`);\r\n\r\n\t\t\tif (cssClass.length) {\r\n\t\t\t\ttooltip.classList.add(...cssClass.map((c) => `${MODULE.id}-${c}`));\r\n\t\t\t}\r\n\r\n\t\t\tif (onDismiss) {\r\n\t\t\t\tnew MutationObserver(function () {\r\n\t\t\t\t\tif (!document.body.contains(tooltip)) {\r\n\t\t\t\t\t\tonDismiss();\r\n\t\t\t\t\t\tthis.disconnect();\r\n\t\t\t\t\t}\r\n\t\t\t\t}).observe(document.body, { childList: true });\r\n\t\t\t}\r\n\r\n\t\t\tif (onClick) {\r\n\t\t\t\tlocked = true;\r\n\r\n\t\t\t\tfor (const el of tooltip.querySelectorAll(\"[data-value]\")) {\r\n\t\t\t\t\tel.addEventListener(\"click\", async (event) => {\r\n\t\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\t\tdismissTooltip(event.currentTarget);\r\n\t\t\t\t\t\tonClick?.(event.currentTarget.dataset.value);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tgame.tooltip.activate(target, {\r\n\t\t\t\tcontent: tooltip,\r\n\t\t\t\tdirection,\r\n\t\t\t\tlocked,\r\n\t\t\t\tcssClass: tooltipClass,\r\n\t\t\t});\r\n\r\n\t\t\tonCreate?.(tooltip);\r\n\r\n\t\t\tresolve(tooltip);\r\n\t\t});\r\n\t});\r\n}\r\n\r\nexport function dismissTooltip(el) {\r\n\tconst tooltip = el.closest(`.${MODULE.id}-tooltip`);\r\n\tgame.tooltip.dismissLockedTooltip(tooltip);\r\n}\r\n", "var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {\n    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n        if (ar || !(i in from)) {\n            if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n            ar[i] = from[i];\n        }\n    }\n    return to.concat(ar || Array.prototype.slice.call(from));\n};\nexport function purry(fn, args, lazy) {\n    var diff = fn.length - args.length;\n    var arrayArgs = Array.from(args);\n    if (diff === 0) {\n        return fn.apply(void 0, arrayArgs);\n    }\n    if (diff === 1) {\n        var ret = function (data) { return fn.apply(void 0, __spreadArray([data], arrayArgs, false)); };\n        if (lazy || fn.lazy) {\n            ret.lazy = lazy || fn.lazy;\n            ret.lazyArgs = args;\n        }\n        return ret;\n    }\n    throw new Error('Wrong number of arguments');\n}\n", "export function isTruthy(data) {\n    return !!data;\n}\n", "import { isTruthy } from './isTruthy';\nexport function compact(items) {\n    return items.filter(isTruthy);\n}\n", "export function _reduceLazy(array, lazy, indexed) {\n    var newArray = [];\n    for (var index = 0; index < array.length; index++) {\n        var item = array[index];\n        var result = indexed ? lazy(item, index, array) : lazy(item);\n        if (result.hasMany === true) {\n            newArray.push.apply(newArray, result.next);\n        }\n        else if (result.hasNext) {\n            newArray.push(result.next);\n        }\n    }\n    return newArray;\n}\n", "export function isArray(data) {\n    return Array.isArray(data);\n}\n", "export function isObject(data) {\n    return !!data && !Array.isArray(data) && typeof data === 'object';\n}\n", "export function isString(data) {\n    return typeof data === 'string';\n}\n", "import { isArray } from './isArray';\nimport { isObject } from './isObject';\nimport { isString } from './isString';\nexport function isEmpty(data) {\n    if (data === undefined) {\n        return true;\n    }\n    if (isArray(data) || isString(data)) {\n        return data.length === 0;\n    }\n    if (isObject(data)) {\n        return Object.keys(data).length === 0;\n    }\n    return false;\n}\n", "export function isNil(data) {\n    return data == null;\n}\n", "import { purry } from './purry';\nimport { _reduceLazy } from './_reduceLazy';\nexport function uniq() {\n    return purry(_uniq, arguments, uniq.lazy);\n}\nfunction _uniq(array) {\n    return _reduceLazy(array, uniq.lazy());\n}\n(function (uniq) {\n    function lazy() {\n        var set = new Set();\n        return function (value) {\n            if (set.has(value)) {\n                return {\n                    done: false,\n                    hasNext: false,\n                };\n            }\n            set.add(value);\n            return {\n                done: false,\n                hasNext: true,\n                next: value,\n            };\n        };\n    }\n    uniq.lazy = lazy;\n})(uniq || (uniq = {}));\n", "import * as R from \"remeda\";\r\n\r\n/** A comparison which rates the first modifier as better than the second if it's modifier is at least as large. */\r\nconst HIGHER_BONUS = (a, b) => a.modifier >= b.modifier;\r\n/** A comparison which rates the first modifier as better than the second if it's modifier is at least as small. */\r\nconst LOWER_PENALTY = (a, b) => a.modifier <= b.modifier;\r\n\r\n/**\r\n * @param {object[]} modifiers\r\n * @returns {number}\r\n */\r\nexport function applyStackingRules(modifiers) {\r\n\tlet total = 0;\r\n\tconst highestBonus = {};\r\n\tconst lowestPenalty = {};\r\n\r\n\t// There are no ability bonuses or penalties, so always take the highest ability modifier.\r\n\tconst abilityModifiers = modifiers.filter(\r\n\t\t(m) => m.type === \"ability\" && !m.ignored,\r\n\t);\r\n\tconst bestAbility = abilityModifiers.reduce((best, modifier) => {\r\n\t\tif (best === null) {\r\n\t\t\treturn modifier;\r\n\t\t}\r\n\r\n\t\treturn modifier.force\r\n\t\t\t? modifier\r\n\t\t\t: best.force\r\n\t\t\t  ? best\r\n\t\t\t  : modifier.modifier > best.modifier\r\n\t\t\t\t  ? modifier\r\n\t\t\t\t  : best;\r\n\t}, null);\r\n\tfor (const modifier of abilityModifiers) {\r\n\t\tmodifier.ignored = modifier !== bestAbility;\r\n\t}\r\n\r\n\tfor (const modifier of modifiers) {\r\n\t\t// Always disable ignored modifiers and don't do anything further with them.\r\n\t\tif (modifier.ignored) {\r\n\t\t\tmodifier.enabled = false;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Untyped modifiers always stack, so enable them and add their modifier.\r\n\t\tif (modifier.type === \"untyped\") {\r\n\t\t\tmodifier.enabled = true;\r\n\t\t\ttotal += modifier.modifier;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Otherwise, apply stacking rules to positive modifiers and negative modifiers separately.\r\n\t\tif (modifier.modifier < 0) {\r\n\t\t\ttotal += applyStacking(lowestPenalty, modifier, LOWER_PENALTY);\r\n\t\t} else {\r\n\t\t\ttotal += applyStacking(highestBonus, modifier, HIGHER_BONUS);\r\n\t\t}\r\n\t}\r\n\r\n\treturn total;\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {Record<string, T>} best\r\n * @param {T} modifier\r\n * @param {(a: object, b:object) => boolean} isBetter\r\n * @returns {number}\r\n */\r\nfunction applyStacking(best, modifier, isBetter) {\r\n\t// If there is no existing bonus of this type, then add ourselves.\r\n\tconst existing = best[modifier.type];\r\n\tif (existing === undefined) {\r\n\t\tmodifier.enabled = true;\r\n\t\tbest[modifier.type] = modifier;\r\n\t\treturn modifier.modifier;\r\n\t}\r\n\r\n\tif (isBetter(modifier, existing)) {\r\n\t\t// If we are a better modifier according to the comparison, then we become the new 'best'.\r\n\t\texisting.enabled = false;\r\n\t\tmodifier.enabled = true;\r\n\t\tbest[modifier.type] = modifier;\r\n\t\treturn modifier.modifier - existing.modifier;\r\n\t}\r\n\r\n\t// Otherwise, the existing modifier is better, so do nothing.\r\n\tmodifier.enabled = false;\r\n\treturn 0;\r\n}\r\n\r\nexport function getSelectedActors(options = {}) {\r\n\tconst {\r\n\t\tinclude = actorTypes,\r\n\t\texclude = [],\r\n\t\tassignedFallback = false,\r\n\t} = options;\r\n\tconst actors = R.uniq(\r\n\t\tgame.user\r\n\t\t\t.getActiveTokens()\r\n\t\t\t.flatMap((t) =>\r\n\t\t\t\tt.actor &&\r\n\t\t\t\t(include.length === 0 || t.actor.isOfType(...include)) &&\r\n\t\t\t\t(exclude.length === 0 || !t.actor.isOfType(...exclude))\r\n\t\t\t\t\t? t.actor\r\n\t\t\t\t\t: [],\r\n\t\t\t),\r\n\t);\r\n\tconst assigned = game.user.character;\r\n\tif (actors.length > 0 || !assignedFallback || !assigned) {\r\n\t\treturn actors;\r\n\t}\r\n\r\n\tif (\r\n\t\t(include.length === 0 || assigned.isOfType(...include)) &&\r\n\t\t(exclude.length === 0 || !assigned.isOfType(...exclude))\r\n\t) {\r\n\t\treturn [assigned];\r\n\t}\r\n\r\n\treturn [];\r\n}\r\n", "import * as R from \"remeda\";\r\n\r\n/**\r\n * @param {HTMLElement} parent\r\n * @param {string} selectors\r\n * @returns {HTMLElement|null}\r\n */\r\nexport function htmlQuery(parent, selectors) {\r\n\tif (!(parent instanceof Element || parent instanceof Document)) return null;\r\n\treturn parent.querySelector(selectors);\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} parent\r\n * @param {string} selectors\r\n * @returns {NodeListOf<HTMLElement>}\r\n */\r\nexport function htmlQueryAll(parent, selectors) {\r\n\tif (!(parent instanceof Element || parent instanceof Document)) return [];\r\n\treturn Array.from(parent.querySelectorAll(selectors));\r\n}\r\n\r\n/**\r\n * @param {string} nodeName\r\n * @param {{\r\n *   classes?: string[];\r\n *   dataset?: Record<string, string | number | boolean | null | undefined>;\r\n *   children?: (HTMLElement | string)[];\r\n *   innerHTML?: string;\r\n * }}\r\n * @returns {HTMLElement}\r\n */\r\nexport function createHTMLElement(\r\n\tnodeName,\r\n\t{ classes = [], dataset = {}, children = [], innerHTML } = {},\r\n) {\r\n\tconst element = document.createElement(nodeName);\r\n\tif (classes.length > 0) element.classList.add(...classes);\r\n\r\n\tfor (const [key, value] of Object.entries(dataset).filter(\r\n\t\t([, v]) => !R.isNil(v) && v !== false,\r\n\t)) {\r\n\t\telement.dataset[key] = value === true ? \"\" : String(value);\r\n\t}\r\n\r\n\tif (innerHTML) {\r\n\t\telement.innerHTML = innerHTML;\r\n\t} else {\r\n\t\tfor (const child of children) {\r\n\t\t\tconst childElement =\r\n\t\t\t\tchild instanceof HTMLElement ? child : new Text(child);\r\n\t\t\telement.appendChild(childElement);\r\n\t\t}\r\n\t}\r\n\r\n\treturn element;\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} child\r\n * @param {string} selectors\r\n * @returns {HTMLElement|null}\r\n */\r\nexport function htmlClosest(child, selectors) {\r\n\tif (!(child instanceof Element)) return null;\r\n\treturn child.closest(selectors);\r\n}\r\n", "/**\r\n * @param {number} value\r\n * @returns {string}\r\n */\r\nexport function ordinalString(value) {\r\n\tconst pluralRules = new Intl.PluralRules(game.i18n.lang, { type: \"ordinal\" });\r\n\tconst suffix = game.i18n.localize(\r\n\t\t`PF2E.OrdinalSuffixes.${pluralRules.select(value)}`,\r\n\t);\r\n\treturn game.i18n.format(\"PF2E.OrdinalNumber\", { value, suffix });\r\n}\r\n\r\n/**\r\n * @param {string} message\r\n * @returns {Error}\r\n */\r\nexport function ErrorPF2e(message) {\r\n\treturn Error(`PF2e System | ${message}`);\r\n}\r\n\r\n/**\r\n * @type {Intl.NumberFormat}\r\n */\r\nlet intlNumberFormat;\r\n/**\r\n * @param {number} value\r\n * @param {object} [options]\r\n * @param {boolean} [options.emptyStringZero]\r\n * @param {boolean} [options.zeroIsNegative]\r\n * @returns {string}\r\n */\r\nexport function signedInteger(\r\n\tvalue,\r\n\t{ emptyStringZero = false, zeroIsNegative = false } = {},\r\n) {\r\n\tif (value === 0 && emptyStringZero) return \"\";\r\n\r\n\tintlNumberFormat ??= new Intl.NumberFormat(game.i18n.lang, {\r\n\t\tmaximumFractionDigits: 0,\r\n\t\tsignDisplay: \"always\",\r\n\t});\r\n\r\n\tconst maybeNegativeZero = zeroIsNegative && value === 0 ? -0 : value;\r\n\r\n\treturn intlNumberFormat.format(maybeNegativeZero);\r\n}\r\n\r\n/**\r\n * @param {object} obj\r\n * @param {unknown} key\r\n * @returns {boolean}\r\n */\r\nexport function objectHasKey(obj, key) {\r\n\treturn (typeof key === \"string\" || typeof key === \"number\") && key in obj;\r\n}\r\n\r\n/**\r\n * @param {string} prefix\r\n * @returns {(...args: (string|Record<string, unknown>)[]) => string}\r\n */\r\nexport function localizer(prefix) {\r\n\treturn (...[suffix, formatArgs]) =>\r\n\t\tformatArgs\r\n\t\t\t? game.i18n.format(`${prefix}.${suffix}`, formatArgs)\r\n\t\t\t: game.i18n.localize(`${prefix}.${suffix}`);\r\n}\r\n\r\nconst actionGlyphMap = {\r\n\t0: \"F\",\r\n\tfree: \"F\",\r\n\t1: \"A\",\r\n\t2: \"D\",\r\n\t3: \"T\",\r\n\t\"1 or 2\": \"A/D\",\r\n\t\"1 to 3\": \"A - T\",\r\n\t\"2 or 3\": \"D/T\",\r\n\treaction: \"R\",\r\n};\r\n\r\n/**\r\n * @param {typeof actionGlyphMap} action\r\n * @returns {string}\r\n */\r\nexport function getActionGlyph(action) {\r\n\tif (!action && action !== 0) return \"\";\r\n\r\n\tconst value =\r\n\t\ttypeof action !== \"object\"\r\n\t\t\t? action\r\n\t\t\t: action.type === \"action\"\r\n\t\t\t  ? action.value\r\n\t\t\t  : action.type;\r\n\tconst sanitized = String(value ?? \"\")\r\n\t\t.toLowerCase()\r\n\t\t.trim();\r\n\r\n\treturn actionGlyphMap[sanitized]?.replace(\"-\", \"\u2013\") ?? \"\";\r\n}\r\n\r\nconst actionImgMap = {\r\n\t0: \"systems/pf2e/icons/actions/FreeAction.webp\",\r\n\tfree: \"systems/pf2e/icons/actions/FreeAction.webp\",\r\n\t1: \"systems/pf2e/icons/actions/OneAction.webp\",\r\n\t2: \"systems/pf2e/icons/actions/TwoActions.webp\",\r\n\t3: \"systems/pf2e/icons/actions/ThreeActions.webp\",\r\n\t\"1 or 2\": \"systems/pf2e/icons/actions/OneTwoActions.webp\",\r\n\t\"1 to 3\": \"systems/pf2e/icons/actions/OneThreeActions.webp\",\r\n\t\"2 or 3\": \"systems/pf2e/icons/actions/TwoThreeActions.webp\",\r\n\treaction: \"systems/pf2e/icons/actions/Reaction.webp\",\r\n\tpassive: \"systems/pf2e/icons/actions/Passive.webp\",\r\n};\r\n\r\n/**\r\n *\r\n * @param {string | {type: string, value: 1|2|3|null} | null} action\r\n * @param {string} [fallback]\r\n * @returns {string|null}\r\n */\r\nexport function getActionIcon(\r\n\taction,\r\n\tfallback = \"systems/pf2e/icons/actions/Empty.webp\",\r\n) {\r\n\tif (action === null) return actionImgMap.passive;\r\n\tconst value =\r\n\t\ttypeof action !== \"object\"\r\n\t\t\t? action\r\n\t\t\t: action.type === \"action\"\r\n\t\t\t  ? action.value\r\n\t\t\t  : action.type;\r\n\tconst sanitized = String(value ?? \"\")\r\n\t\t.toLowerCase()\r\n\t\t.trim();\r\n\treturn actionImgMap[sanitized] ?? fallback;\r\n}\r\n\r\n/**\r\n * @param {string} text\r\n * @param {object} [options]\r\n * @param {boolean|null} [options.camel]\r\n * @returns {string}\r\n */\r\nexport function sluggify(text, options) {\r\n\treturn game.pf2e.system.sluggify(text, options);\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {Set<T>} set\r\n * @param {T} value\r\n * @returns {boolean}\r\n */\r\nexport function setHasElement(set, value) {\r\n\treturn set.has(value);\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {[T, T]} array\r\n * @param {T} value\r\n * @returns {boolean}\r\n */\r\nexport function tupleHasValue(array, value) {\r\n\treturn array.includes(value);\r\n}\r\n\r\n/**\r\n * @param {unknown} value\r\n * @returns {boolean}\r\n */\r\nexport function isObject(value) {\r\n\treturn typeof value === \"object\" && value !== null;\r\n}\r\n", "import { objectHasKey } from \"./misc\";\r\n\r\nexport function traitSlugToObject(trait, dictionary) {\r\n\t// Look up trait labels from `npcAttackTraits` instead of `weaponTraits` in case a battle form attack is\r\n\t// in use, which can include what are normally NPC-only traits\r\n\tconst traitObject = {\r\n\t\tname: trait,\r\n\t\tlabel: game.i18n.localize(dictionary[trait] ?? trait),\r\n\t\tdescription: null,\r\n\t};\r\n\tif (objectHasKey(CONFIG.PF2E.traitsDescriptions, trait)) {\r\n\t\ttraitObject.description = CONFIG.PF2E.traitsDescriptions[trait];\r\n\t}\r\n\r\n\treturn traitObject;\r\n}\r\n", "import { getHighestName } from \"../foundry\";\r\nimport { isInstanceOf } from \"../utils\";\r\nimport { htmlQuery } from \"./html\";\r\nimport { ErrorPF2e, getActionGlyph } from \"./misc\";\r\nimport { extractEphemeralEffects } from \"./rules\";\r\nimport { traitSlugToObject } from \"./tags\";\r\n\r\n/**\r\n * @typedef {(message: object, tokens: object[], rollIndex: number) => void} OnDamageApplied\r\n *\r\n * @param {object} options\r\n * @param {object} options.message\r\n * @param {number} options.multiplier\r\n * @param {number} options.addend\r\n * @param {boolean} options.promptModifier\r\n * @param {number} options.rollIndex\r\n * @param {object[]} [options.tokens]\r\n * @param {OnDamageApplied} [options.onDamageApplied]\r\n */\r\nexport async function applyDamageFromMessage({\r\n\tmessage,\r\n\tmultiplier = 1,\r\n\taddend = 0,\r\n\tpromptModifier = false,\r\n\trollIndex = 0,\r\n\t// added\r\n\ttokens,\r\n\tonDamageApplied,\r\n}) {\r\n\tif (promptModifier) {\r\n\t\treturn shiftAdjustDamage({\r\n\t\t\tmessage,\r\n\t\t\tmultiplier,\r\n\t\t\trollIndex,\r\n\t\t\t// added\r\n\t\t\ttokens,\r\n\t\t\tonDamageApplied,\r\n\t\t});\r\n\t}\r\n\r\n\t// changed\r\n\ttokens ??= (() => {\r\n\t\tconst html = htmlQuery(\r\n\t\t\tui.chat.element[0],\r\n\t\t\t`li.chat-message[data-message-id=\"${message.id}\"]`,\r\n\t\t);\r\n\t\treturn html?.dataset.actorIsTarget && message.token\r\n\t\t\t? [message.token]\r\n\t\t\t: game.user.getActiveTokens();\r\n\t})();\r\n\tif (tokens.length === 0) {\r\n\t\tui.notifications.error(\"PF2E.ErrorMessage.NoTokenSelected\", {\r\n\t\t\tlocalize: true,\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst shieldBlockRequest = CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\tconst roll = message.rolls.at(rollIndex);\r\n\tif (!isInstanceOf(roll, \"DamageRoll\"))\r\n\t\tthrow ErrorPF2e(\"Unexpected error retrieving damage roll\");\r\n\r\n\tconst damage =\r\n\t\tmultiplier < 0\r\n\t\t\t? multiplier * roll.total + addend\r\n\t\t\t: roll.alter(multiplier, addend);\r\n\r\n\t// Get origin roll options and apply damage to a contextual clone: this may influence condition IWR, for example\r\n\tconst messageRollOptions = [...(message.flags.pf2e.context?.options ?? [])];\r\n\tconst originRollOptions = messageRollOptions\r\n\t\t.filter((o) => o.startsWith(\"self:\"))\r\n\t\t.map((o) => o.replace(/^self/, \"origin\"));\r\n\tconst messageItem = message.item;\r\n\tconst effectRollOptions = messageItem?.isOfType(\r\n\t\t\"affliction\",\r\n\t\t\"condition\",\r\n\t\t\"effect\",\r\n\t)\r\n\t\t? messageItem.getRollOptions(\"item\")\r\n\t\t: [];\r\n\r\n\tfor (const token of tokens) {\r\n\t\tif (!token.actor) continue;\r\n\r\n\t\t// If no target was acquired during a roll, set roll options for it during damage application\r\n\t\tif (!messageRollOptions.some((o) => o.startsWith(\"target\"))) {\r\n\t\t\tmessageRollOptions.push(...token.actor.getSelfRollOptions(\"target\"));\r\n\t\t}\r\n\t\tconst domain = multiplier > 0 ? \"damage-received\" : \"healing-received\";\r\n\t\tconst ephemeralEffects =\r\n\t\t\tmultiplier > 0\r\n\t\t\t\t? await extractEphemeralEffects({\r\n\t\t\t\t\t\taffects: \"target\",\r\n\t\t\t\t\t\torigin: message.actor,\r\n\t\t\t\t\t\ttarget: token.actor,\r\n\t\t\t\t\t\titem: message.item,\r\n\t\t\t\t\t\tdomains: [domain],\r\n\t\t\t\t\t\toptions: messageRollOptions,\r\n\t\t\t\t  })\r\n\t\t\t\t: [];\r\n\t\tconst contextClone = token.actor.getContextualClone(\r\n\t\t\toriginRollOptions,\r\n\t\t\tephemeralEffects,\r\n\t\t);\r\n\t\tconst rollOptions = new Set([\r\n\t\t\t...messageRollOptions.filter((o) => !/^(?:self|target):/.test(o)),\r\n\t\t\t...effectRollOptions,\r\n\t\t\t...originRollOptions,\r\n\t\t\t...contextClone.getSelfRollOptions(),\r\n\t\t]);\r\n\r\n\t\tawait contextClone.applyDamage({\r\n\t\t\tdamage,\r\n\t\t\ttoken,\r\n\t\t\titem: message.item,\r\n\t\t\tskipIWR: multiplier <= 0,\r\n\t\t\trollOptions,\r\n\t\t\tshieldBlockRequest,\r\n\t\t\toutcome: message.flags.pf2e.context?.outcome,\r\n\t\t});\r\n\t}\r\n\ttoggleOffShieldBlock(message.id);\r\n\r\n\t// added\r\n\tonDamageApplied?.(message, tokens, rollIndex);\r\n}\r\n\r\n/**\r\n * @param {object} target\r\n * @param {HTMLElement} shieldButton\r\n * @param {HTMLElement} messageEl\r\n */\r\nexport function onClickShieldBlock(target, shieldButton, messageEl) {\r\n\t// changed\r\n\tconst getTokens = () => {\r\n\t\treturn [target];\r\n\t};\r\n\tconst getNonBrokenShields = (tokens) => {\r\n\t\tconst actor = tokens[0]?.actor;\r\n\t\treturn (\r\n\t\t\tactor?.itemTypes.shield.filter(\r\n\t\t\t\t(s) => s.isEquipped && !s.isBroken && !s.isDestroyed,\r\n\t\t\t) ?? []\r\n\t\t);\r\n\t};\r\n\r\n\t// Add a tooltipster instance to the shield button if needed.\r\n\tif (!shieldButton.classList.contains(\"tooltipstered\")) {\r\n\t\t$(shieldButton)\r\n\t\t\t.tooltipster({\r\n\t\t\t\tanimation: \"fade\",\r\n\t\t\t\ttrigger: \"click\",\r\n\t\t\t\tarrow: false,\r\n\t\t\t\tcontent: htmlQuery(messageEl, \"div.hover-content\"),\r\n\t\t\t\tcontentAsHTML: true,\r\n\t\t\t\tcontentCloning: true,\r\n\t\t\t\tdebug: false,\r\n\t\t\t\tinteractive: true,\r\n\t\t\t\tside: [\"top\"],\r\n\t\t\t\ttheme: \"crb-hover\",\r\n\t\t\t\tfunctionBefore: () => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tif (!tokens.length) return false;\r\n\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst hasMultipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// More than one shield and no selection. Show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && !shieldActivated) {\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// More than one shield and one was previously selected. Remove selection and show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && shieldButton.dataset.shieldId) {\r\n\t\t\t\t\t\tshieldButton.attributes.removeNamedItem(\"data-shield-id\");\r\n\t\t\t\t\t\tshieldButton.classList.remove(\"shield-activated\");\r\n\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Normal toggle behaviour. Tooltip is suppressed.\r\n\t\t\t\t\tshieldButton.classList.toggle(\"shield-activated\");\r\n\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle =\r\n\t\t\t\t\t\t!CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t},\r\n\t\t\t\tfunctionFormat: (instance, _helper, contentEl) => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst multipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// If the actor is wielding more than one shield, have the user pick which shield to use for blocking.\r\n\t\t\t\t\tif (multipleShields && !shieldActivated) {\r\n\t\t\t\t\t\t// Populate the list with the shield options\r\n\t\t\t\t\t\tconst listEl = htmlQuery(contentEl, \"ul.shield-options\");\r\n\t\t\t\t\t\tif (!listEl) return $(contentEl);\r\n\r\n\t\t\t\t\t\tconst shieldList = nonBrokenShields.map((shield) => {\r\n\t\t\t\t\t\t\tconst input = document.createElement(\"input\");\r\n\t\t\t\t\t\t\tinput.classList.add(\"data\");\r\n\t\t\t\t\t\t\tinput.type = \"radio\";\r\n\t\t\t\t\t\t\tinput.name = \"shield-id\";\r\n\t\t\t\t\t\t\tinput.value = shield.id;\r\n\t\t\t\t\t\t\tinput.addEventListener(\"click\", () => {\r\n\t\t\t\t\t\t\t\tshieldButton.dataset.shieldId = input.value;\r\n\t\t\t\t\t\t\t\tshieldButton.classList.add(\"shield-activated\");\r\n\t\t\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = true;\r\n\t\t\t\t\t\t\t\tinstance.close();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tconst shieldName = document.createElement(\"span\");\r\n\t\t\t\t\t\t\tshieldName.classList.add(\"label\");\r\n\t\t\t\t\t\t\tshieldName.innerHTML = shield.name;\r\n\r\n\t\t\t\t\t\t\tconst hardness = document.createElement(\"span\");\r\n\t\t\t\t\t\t\thardness.classList.add(\"tag\");\r\n\t\t\t\t\t\t\tconst hardnessLabel = game.i18n.localize(\"PF2E.HardnessLabel\");\r\n\t\t\t\t\t\t\thardness.innerHTML = `${hardnessLabel}: ${shield.hardness}`;\r\n\r\n\t\t\t\t\t\t\tconst itemLi = document.createElement(\"li\");\r\n\t\t\t\t\t\t\titemLi.classList.add(\"item\");\r\n\t\t\t\t\t\t\titemLi.append(input, shieldName, hardness);\r\n\r\n\t\t\t\t\t\t\treturn itemLi;\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tlistEl.replaceChildren(...shieldList);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn $(contentEl);\r\n\t\t\t\t},\r\n\t\t\t})\r\n\t\t\t.tooltipster(\"open\");\r\n\t}\r\n}\r\n\r\n/**\r\n * adapted to toggle multiple buttons\r\n * @param {string} messageId\r\n */\r\nexport function toggleOffShieldBlock(messageId) {\r\n\tfor (const app of [\"#chat-log\", \"#chat-popout\"]) {\r\n\t\tconst selector = `${app} > li.chat-message[data-message-id=\"${messageId}\"] button[data-action$=shield-block]`;\r\n\t\tfor (const button of document.body.querySelectorAll(selector)) {\r\n\t\t\tbutton?.classList.remove(\"shield-activated\");\r\n\t\t}\r\n\t}\r\n\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n}\r\n\r\n/**\r\n * @param {object} options\r\n * @param {object} options.message\r\n * @param {number} options.multiplier\r\n * @param {number} options.rollIndex\r\n * @param {object[]} [options.tokens]\r\n * @param {OnDamageApplied} [options.onDamageApplied]\r\n */\r\nasync function shiftAdjustDamage({\r\n\tmessage,\r\n\tmultiplier,\r\n\trollIndex,\r\n\t// added\r\n\ttokens,\r\n\tonDamageApplied,\r\n}) {\r\n\tconst content = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/damage/adjustment-dialog.hbs\",\r\n\t);\r\n\tconst AdjustmentDialog = class extends Dialog {\r\n\t\tactivateListeners($html) {\r\n\t\t\tsuper.activateListeners($html);\r\n\t\t\t$html[0].querySelector(\"input\")?.focus();\r\n\t\t}\r\n\t};\r\n\tconst isHealing = multiplier < 0;\r\n\tnew AdjustmentDialog({\r\n\t\ttitle: game.i18n.localize(\r\n\t\t\tisHealing\r\n\t\t\t\t? \"PF2E.UI.shiftModifyHealingTitle\"\r\n\t\t\t\t: \"PF2E.UI.shiftModifyDamageTitle\",\r\n\t\t),\r\n\t\tcontent,\r\n\t\tbuttons: {\r\n\t\t\tok: {\r\n\t\t\t\tlabel: game.i18n.localize(\"PF2E.OK\"),\r\n\t\t\t\tcallback: async ($dialog) => {\r\n\t\t\t\t\t// In case of healing, multipler will have negative sign. The user will expect that positive\r\n\t\t\t\t\t// modifier would increase healing value, while negative would decrease.\r\n\t\t\t\t\tconst adjustment =\r\n\t\t\t\t\t\t(Number($dialog[0].querySelector(\"input\")?.value) || 0) *\r\n\t\t\t\t\t\tMath.sign(multiplier);\r\n\t\t\t\t\tapplyDamageFromMessage({\r\n\t\t\t\t\t\tmessage,\r\n\t\t\t\t\t\tmultiplier,\r\n\t\t\t\t\t\taddend: adjustment,\r\n\t\t\t\t\t\tpromptModifier: false,\r\n\t\t\t\t\t\trollIndex,\r\n\t\t\t\t\t\t// added\r\n\t\t\t\t\t\ttokens,\r\n\t\t\t\t\t\tonDamageApplied,\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tcancel: {\r\n\t\t\t\tlabel: \"Cancel\",\r\n\t\t\t},\r\n\t\t},\r\n\t\tdefault: \"ok\",\r\n\t\tclose: () => {\r\n\t\t\ttoggleOffShieldBlock(message.id);\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n\r\n/**\r\n * @param {Item} item\r\n * @param {string} rollMode\r\n * @returns {ChatMessage}\r\n */\r\nexport async function createSelfEffectMessage(item, rollMode = \"roll\") {\r\n\tif (!item.system.selfEffect) {\r\n\t\tthrow ErrorPF2e(\r\n\t\t\t[\r\n\t\t\t\t\"Only actions with self-applied effects can be passed to `ActorPF2e#useAction`.\",\r\n\t\t\t\t\"Support will be expanded at a later time.\",\r\n\t\t\t].join(\" \"),\r\n\t\t);\r\n\t}\r\n\r\n\tconst { actor, actionCost } = item;\r\n\tconst token = actor.getActiveTokens(true, true).shift() ?? null;\r\n\r\n\tconst ChatMessagePF2e = ChatMessage.implementation;\r\n\tconst speaker = ChatMessagePF2e.getSpeaker({ actor, token });\r\n\tconst flavor = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/action/flavor.hbs\",\r\n\t\t{\r\n\t\t\taction: { title: item.name, glyph: getActionGlyph(actionCost) },\r\n\t\t\titem,\r\n\t\t\ttraits: item.system.traits.value.map((t) =>\r\n\t\t\t\ttraitSlugToObject(t, CONFIG.PF2E.actionTraits),\r\n\t\t\t),\r\n\t\t},\r\n\t);\r\n\r\n\t// Get a preview slice of the message\r\n\tconst previewLength = 100;\r\n\tconst descriptionPreview = (() => {\r\n\t\tif (item.actor.pack) return null;\r\n\t\tconst tempDiv = document.createElement(\"div\");\r\n\t\tconst documentTypes = [...CONST.DOCUMENT_LINK_TYPES, \"Compendium\", \"UUID\"];\r\n\t\tconst linkPattern = new RegExp(\r\n\t\t\t`@(${documentTypes.join(\r\n\t\t\t\t\"|\",\r\n\t\t\t)})\\\\[([^#\\\\]]+)(?:#([^\\\\]]+))?](?:{([^}]+)})?`,\r\n\t\t\t\"g\",\r\n\t\t);\r\n\t\ttempDiv.innerHTML = item.description.replace(\r\n\t\t\tlinkPattern,\r\n\t\t\t(_match, ...args) => args[3],\r\n\t\t);\r\n\r\n\t\treturn tempDiv.innerText.slice(0, previewLength);\r\n\t})();\r\n\tconst description = {\r\n\t\tfull:\r\n\t\t\tdescriptionPreview && descriptionPreview.length < previewLength\r\n\t\t\t\t? item.description\r\n\t\t\t\t: null,\r\n\t\tpreview: descriptionPreview,\r\n\t};\r\n\tconst content = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/action/self-effect.hbs\",\r\n\t\t{\r\n\t\t\tactor: item.actor,\r\n\t\t\tdescription,\r\n\t\t},\r\n\t);\r\n\tconst flags = { pf2e: { context: { type: \"self-effect\", item: item.id } } };\r\n\tconst messageData = ChatMessagePF2e.applyRollMode(\r\n\t\t{ speaker, flavor, content, flags },\r\n\t\trollMode,\r\n\t);\r\n\r\n\treturn ChatMessagePF2e.create(messageData);\r\n}\r\n\r\n/**\r\n * @param {string} subtitle\r\n * @returns {Promise<string>}\r\n */\r\nexport function createManipulateFlavor(subtitle) {\r\n\treturn renderTemplate(\"systems/pf2e/templates/chat/action/flavor.hbs\", {\r\n\t\taction: {\r\n\t\t\ttitle: \"PF2E.Actions.Interact.Title\",\r\n\t\t\tsubtitle: subtitle,\r\n\t\t\tglyph: getActionGlyph(1),\r\n\t\t},\r\n\t\ttraits: [\r\n\t\t\t{\r\n\t\t\t\tname: \"manipulate\",\r\n\t\t\t\tlabel: CONFIG.PF2E.featTraits.manipulate,\r\n\t\t\t\tdescription: CONFIG.PF2E.traitsDescriptions.manipulate,\r\n\t\t\t},\r\n\t\t],\r\n\t});\r\n}\r\n\r\n/**\r\n * @param {string} message\r\n * @param {string} img\r\n * @returns {Promise<string>}\r\n */\r\nexport function createTradeContent(message, img) {\r\n\treturn renderTemplate(\"systems/pf2e/templates/chat/action/content.hbs\", {\r\n\t\timgPath: img,\r\n\t\tmessage: message.replace(/\\b1 \u00D7 /, \"\"),\r\n\t});\r\n}\r\n\r\n/**\r\n * @param {foundry.Document|string} docOrUuid\r\n * @param {object} [options]\r\n * @param {boolean} [options.async]\r\n * @param {string} [options.label]\r\n * @returns {Promise<string>}\r\n */\r\nexport function createFancyLink(docOrUuid, { async = true, label } = {}) {\r\n\tlet link =\r\n\t\tdocOrUuid instanceof foundry.abstract.Document\r\n\t\t\t? docOrUuid.link\r\n\t\t\t: `@UUID[${docOrUuid}]`;\r\n\tif (label) {\r\n\t\tlink = link.replace(/\\{.+?\\}$/, \"\");\r\n\t\tlink = `${link}{${label}}`;\r\n\t}\r\n\treturn TextEditor.enrichHTML(link, { async });\r\n}\r\n\r\n/**\r\n *\r\n * @param {string} subtitle\r\n * @param {string} content\r\n * @param {Actor} actor\r\n * @param {string} [senderId]\r\n * @returns {Promise<ChatMessage>}\r\n */\r\nexport async function createManipulationMessage(\r\n\tsubtitle,\r\n\tcontent,\r\n\tactor,\r\n\tsenderId,\r\n) {\r\n\treturn ChatMessage.implementation.create({\r\n\t\tuser: senderId ?? game.user.id,\r\n\t\tspeaker: ChatMessage.getSpeaker({\r\n\t\t\tactor,\r\n\t\t\talias: getHighestName(actor),\r\n\t\t}),\r\n\t\tflavor: await createManipulateFlavor(subtitle),\r\n\t\tcontent: content,\r\n\t\ttype: CONST.CHAT_MESSAGE_TYPES.EMOTE,\r\n\t});\r\n}\r\n\r\n/**\r\n *\r\n * @param {string} subtitle\r\n * @param {string} message\r\n * @param {Actor} actor\r\n * @param {Item} item\r\n * @param {string} [senderId]\r\n * @returns {Promise<ChatMessage>}\r\n */\r\nexport async function createTradeMessage(\r\n\tsubtitle,\r\n\tmessage,\r\n\tactor,\r\n\titem,\r\n\tsenderId,\r\n) {\r\n\tconst content = await createTradeContent(message, item.img);\r\n\treturn createManipulationMessage(subtitle, content, actor, senderId);\r\n}\r\n", "/**\r\n * @returns { new (...args: unknkown[]) => object}\r\n */\r\nexport function getDamageRollClass() {\r\n\treturn CONFIG.Dice.rolls.find((Roll) => Roll.name === \"DamageRoll\");\r\n}\r\n", "export const adjustmentScale = [\r\n\t\"incredibly-easy\",\r\n\t\"very-easy\",\r\n\t\"easy\",\r\n\t\"normal\",\r\n\t\"hard\",\r\n\t\"very-hard\",\r\n\t\"incredibly-hard\",\r\n];\r\n\r\nexport const dcAdjustments = new Map([\r\n\t[\"incredibly-easy\", -10],\r\n\t[\"very-easy\", -5],\r\n\t[\"easy\", -2],\r\n\t[\"normal\", 0],\r\n\t[\"hard\", 2],\r\n\t[\"very-hard\", 5],\r\n\t[\"incredibly-hard\", 10],\r\n]);\r\n\r\nexport const dcByLevel = new Map([\r\n\t[-1, 13],\r\n\t[0, 14],\r\n\t[1, 15],\r\n\t[2, 16],\r\n\t[3, 18],\r\n\t[4, 19],\r\n\t[5, 20],\r\n\t[6, 22],\r\n\t[7, 23],\r\n\t[8, 24],\r\n\t[9, 26],\r\n\t[10, 27],\r\n\t[11, 28],\r\n\t[12, 30],\r\n\t[13, 31],\r\n\t[14, 32],\r\n\t[15, 34],\r\n\t[16, 35],\r\n\t[17, 36],\r\n\t[18, 38],\r\n\t[19, 39],\r\n\t[20, 40],\r\n\t[21, 42],\r\n\t[22, 44],\r\n\t[23, 46],\r\n\t[24, 48],\r\n\t[25, 50],\r\n]);\r\n\r\nexport const simpleDCs = new Map([\r\n\t[\"untrained\", 10],\r\n\t[\"trained\", 15],\r\n\t[\"expert\", 20],\r\n\t[\"master\", 30],\r\n\t[\"legendary\", 40],\r\n]);\r\n\r\nexport const simpleDCsWithoutLevel = new Map([\r\n\t[\"untrained\", 10],\r\n\t[\"trained\", 15],\r\n\t[\"expert\", 20],\r\n\t[\"master\", 25],\r\n\t[\"legendary\", 30],\r\n]);\r\n\r\n/**\r\n * @typedef {\"untrained\" | \"trained\" | \"expert\" | \"master\" | \"legendary\"} Rank\r\n */\r\n\r\n/**\r\n * @typedef {\"common\" | \"uncommon\" | \"rare\" | \"unique\"} Rarity\r\n */\r\n\r\n/**\r\n * @param {number} level\r\n * @returns {number}\r\n */\r\nexport function getDcByLevel(level) {\r\n\tconst clamped = Math.clamped(level, -1, 25);\r\n\treturn dcByLevel.get(clamped);\r\n}\r\n\r\n/**\r\n * @param {number} level\r\n * @param {object} [options]\r\n * @param {boolean} [options.pwol]\r\n * @param {Rarity} [options.rarity]\r\n * @returns {number}\r\n */\r\nexport function calculateDC(level, { pwol, rarity = \"common\" } = {}) {\r\n\tpwol ??= game.pf2e.settings.variants.pwol.enabled;\r\n\r\n\t// assume level 0 if garbage comes in. We cast level to number because the backing data may actually have it\r\n\t// stored as a string, which we can't catch at compile time\r\n\tconst dc = dcByLevel.get(level) ?? 14;\r\n\tif (pwol) {\r\n\t\t// -1 shouldn't be subtracted since it's just\r\n\t\t// a creature level and not related to PC levels\r\n\t\treturn adjustDCByRarity(dc - Math.max(level, 0), rarity);\r\n\t}\r\n\r\n\treturn adjustDCByRarity(dc, rarity);\r\n}\r\n\r\n/**\r\n *\r\n * @param {Rank} rank\r\n * @param {object} [options]\r\n * @param {boolean} [options.pwol]\r\n * @returns {number}\r\n */\r\nexport function calculateSimpleDC(rank, { pwol = false } = {}) {\r\n\tif (pwol) {\r\n\t\treturn simpleDCsWithoutLevel.get(rank) ?? 10;\r\n\t}\r\n\r\n\treturn simpleDCs.get(rank) ?? 10;\r\n}\r\n\r\n/**\r\n *\r\n * @param {number} spellLevel\r\n * @param {object} [options]\r\n * @param {boolean} [options.pwol]\r\n * @returns {number}\r\n */\r\nexport function calculateSpellDC(spellLevel, { pwol = false } = {}) {\r\n\treturn calculateDC(spellLevel * 2 - 1, { pwol });\r\n}\r\n\r\n/**\r\n *\r\n * @param {number} dc\r\n * @param {Rarity} rarity\r\n * @returns {number}\r\n */\r\nexport function adjustDCByRarity(dc, rarity = \"common\") {\r\n\treturn adjustDC(dc, rarityToDCAdjustment(rarity));\r\n}\r\n\r\n/**\r\n *\r\n * @param {number} dc\r\n * @param {Rarity} adjustment\r\n * @returns {number}\r\n */\r\nexport function adjustDC(dc, adjustment = \"normal\") {\r\n\treturn dc + (dcAdjustments.get(adjustment) ?? 0);\r\n}\r\n\r\n/**\r\n * @param {Rarity} rarity\r\n * @returns {\"hard\" | \"normal\" | \"very-hard\" | \"incredibly-hard\"}\r\n */\r\nexport function rarityToDCAdjustment(rarity = \"common\") {\r\n\tswitch (rarity) {\r\n\t\tcase \"uncommon\":\r\n\t\t\treturn \"hard\";\r\n\t\tcase \"rare\":\r\n\t\t\treturn \"very-hard\";\r\n\t\tcase \"unique\":\r\n\t\t\treturn \"incredibly-hard\";\r\n\t\tdefault:\r\n\t\t\treturn \"normal\";\r\n\t}\r\n}\r\n", "export const EFFECT_AREA_SHAPES = [\r\n\t\"burst\",\r\n\t\"cone\",\r\n\t\"cube\",\r\n\t\"cylinder\",\r\n\t\"emanation\",\r\n\t\"line\",\r\n\t\"square\",\r\n];\r\n\r\nexport const MAGIC_TRADITIONS = new Set([\r\n\t\"arcane\",\r\n\t\"divine\",\r\n\t\"occult\",\r\n\t\"primal\",\r\n]);\r\n\r\nexport const traditionSkills = {\r\n\tarcane: \"arcana\",\r\n\tdivine: \"religion\",\r\n\toccult: \"occultism\",\r\n\tprimal: \"nature\",\r\n};\r\n\r\n/**\r\n * @param {string} groupId\r\n * @returns {number|null}\r\n */\r\nexport function spellSlotGroupIdToNumber(groupId) {\r\n\tif (groupId === \"cantrips\") return 0;\r\n\tconst numericValue = Number(groupId ?? NaN);\r\n\treturn numericValue.between(0, 10) ? numericValue : null;\r\n}\r\n\r\n/**\r\n * @param {string} value\r\n * @returns {number|null}\r\n */\r\nexport function coerceToSpellGroupId(value) {\r\n\tif (value === \"cantrips\") return value;\r\n\tconst numericValue = Number(value) || NaN;\r\n\treturn numericValue.between(1, 10) ? numericValue : null;\r\n}\r\n", "import { adjustDCByRarity, calculateDC } from \"./dc\";\r\nimport { setHasElement } from \"./misc\";\r\nimport { MAGIC_TRADITIONS } from \"./spell\";\r\n\r\nexport class IdentifyItemPopup extends FormApplication {\r\n\tstatic get defaultOptions() {\r\n\t\treturn {\r\n\t\t\t...FormApplication.defaultOptions,\r\n\t\t\tid: \"identify-item\",\r\n\t\t\ttitle: game.i18n.localize(\"PF2E.identification.Identify\"),\r\n\t\t\ttemplate: \"systems/pf2e/templates/actors/identify-item.hbs\",\r\n\t\t\twidth: \"auto\",\r\n\t\t\tclasses: [\"identify-popup\"],\r\n\t\t};\r\n\t}\r\n\r\n\tdcs = getItemIdentificationDCs(this.object, {\r\n\t\tpwol: game.pf2e.settings.variants.pwol.enabled,\r\n\t\tnotMatchingTraditionModifier: game.settings.get(\r\n\t\t\t\"pf2e\",\r\n\t\t\t\"identifyMagicNotMatchingTraditionModifier\",\r\n\t\t),\r\n\t});\r\n\r\n\tasync getData() {\r\n\t\tconst item = this.object;\r\n\t\treturn {\r\n\t\t\t...(await super.getData()),\r\n\t\t\tisMagic: item.isMagical,\r\n\t\t\tisAlchemical: item.isAlchemical,\r\n\t\t\tdcs: this.dcs,\r\n\t\t};\r\n\t}\r\n\r\n\tactivateListeners($html) {\r\n\t\tconst html = $html[0];\r\n\r\n\t\tconst updateButton =\r\n\t\t\thtml.querySelector < HTMLButtonElement > \"button.update-identification\";\r\n\t\tupdateButton?.addEventListener(\"click\", () => {\r\n\t\t\tthis.submit({ updateData: { status: updateButton.value } });\r\n\t\t});\r\n\r\n\t\t// Add listener on Post skill checks to chat button that posts item unidentified img and name and skill checks\r\n\t\thtml\r\n\t\t\t.querySelector(\"button.post-skill-checks\")\r\n\t\t\t?.addEventListener(\"click\", async () => {\r\n\t\t\t\tconst item = this.object;\r\n\t\t\t\tconst identifiedName = item.system.identification.identified.name;\r\n\t\t\t\tconst dcs = this.dcs;\r\n\t\t\t\tconst action = item.isMagical\r\n\t\t\t\t\t? \"identify-magic\"\r\n\t\t\t\t\t: item.isAlchemical\r\n\t\t\t\t\t  ? \"identify-alchemy\"\r\n\t\t\t\t\t  : \"recall-knowledge\";\r\n\r\n\t\t\t\tconst content = await renderTemplate(\r\n\t\t\t\t\t\"systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs\",\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tidentifiedName,\r\n\t\t\t\t\t\taction,\r\n\t\t\t\t\t\tskills: R.omit(dcs, [\"dc\"]),\r\n\t\t\t\t\t\tunidentified: item.system.identification.unidentified,\r\n\t\t\t\t\t\tuuid: item.uuid,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tawait ChatMessage.implementation.create({\r\n\t\t\t\t\tuser: game.user.id,\r\n\t\t\t\t\tcontent,\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t}\r\n\r\n\tasync _updateObject(_event, formData) {\r\n\t\tconst status = formData.status;\r\n\t\tif (status === \"identified\") {\r\n\t\t\treturn this.object.setIdentificationStatus(status);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function getItemIdentificationDCs(\r\n\titem,\r\n\t{ pwol = false, notMatchingTraditionModifier },\r\n) {\r\n\tconst baseDC = calculateDC(item.level, { pwol });\r\n\tconst rarity = getDcRarity(item);\r\n\tconst dc = adjustDCByRarity(baseDC, rarity);\r\n\tif (item.isMagical) {\r\n\t\treturn getIdentifyMagicDCs(item, dc, notMatchingTraditionModifier);\r\n\t}\r\n\r\n\treturn { crafting: dc };\r\n}\r\n\r\n/**\r\n *\r\n * @param {Item} item\r\n * @returns {import('./dc').Rarity}\r\n */\r\nfunction getDcRarity(item) {\r\n\treturn item.traits.has(\"cursed\") ? \"unique\" : item.rarity;\r\n}\r\n\r\n/**\r\n *\r\n * @param {PhysicalItemPF2e} item\r\n * @param {number} baseDC\r\n * @param {number} notMatchingTraditionModifier\r\n * @returns {{arcana: number; nature: number; occultism: number; religion: number;}}\r\n */\r\nfunction getIdentifyMagicDCs(item, baseDC, notMatchingTraditionModifier) {\r\n\tconst result = {\r\n\t\toccult: baseDC,\r\n\t\tprimal: baseDC,\r\n\t\tdivine: baseDC,\r\n\t\tarcane: baseDC,\r\n\t};\r\n\tconst traditions = getMagicTraditions(item);\r\n\tfor (const key of MAGIC_TRADITIONS) {\r\n\t\t// once an item has a magic tradition, all skills\r\n\t\t// that don't match the tradition are hard\r\n\t\tif (traditions.size > 0 && !traditions.has(key)) {\r\n\t\t\tresult[key] = baseDC + notMatchingTraditionModifier;\r\n\t\t}\r\n\t}\r\n\treturn {\r\n\t\tarcana: result.arcane,\r\n\t\tnature: result.primal,\r\n\t\treligion: result.divine,\r\n\t\toccultism: result.occult,\r\n\t};\r\n}\r\n\r\n/**\r\n * @param {PhysicalItemPF2e} item\r\n * @returns {MAGIC_TRADITIONS}\r\n */\r\nfunction getMagicTraditions(item) {\r\n\tconst traits = item.system.traits.value;\r\n\treturn new Set(traits.filter((t) => setHasElement(MAGIC_TRADITIONS, t)));\r\n}\r\n", "function isRelevantEvent(event) {\r\n\treturn (\r\n\t\t!!event && \"ctrlKey\" in event && \"metaKey\" in event && \"shiftKey\" in event\r\n\t);\r\n}\r\n\r\n/**\r\n * @param {Event} event\r\n * @param {string} rollType\r\n * @returns {skipDialog: boolean, rollMode?: string}\r\n */\r\nexport function eventToRollParams(event, rollType) {\r\n\tconst key =\r\n\t\trollType.type === \"check\" ? \"showCheckDialogs\" : \"showDamageDialogs\";\r\n\tconst skipDefault = !game.user.settings[key];\r\n\tif (!isRelevantEvent(event)) return { skipDialog: skipDefault };\r\n\r\n\tconst params = { skipDialog: event.shiftKey ? !skipDefault : skipDefault };\r\n\tif (event.ctrlKey || event.metaKey) {\r\n\t\tparams.rollMode = game.user.isGM ? \"gmroll\" : \"blindroll\";\r\n\t}\r\n\r\n\treturn params;\r\n}\r\n\r\n/**\r\n * @param {Event} event\r\n * @returns {string}\r\n */\r\nexport function eventToRollMode(event) {\r\n\tif (!isRelevantEvent(event) || !(event.ctrlKey || event.metaKey))\r\n\t\treturn \"roll\";\r\n\treturn game.user.isGM ? \"gmroll\" : \"blindroll\";\r\n}\r\n", "import * as R from \"remeda\";\r\nimport { getSelectedActors } from \"./actor\";\r\nimport { calculateDC } from \"./dc\";\r\nimport { htmlClosest, htmlQueryAll } from \"./html\";\r\nimport { ErrorPF2e, getActionGlyph, sluggify, tupleHasValue } from \"./misc\";\r\nimport { eventToRollParams } from \"./scripts\";\r\nimport { EFFECT_AREA_SHAPES } from \"./spell\";\r\n\r\nconst SAVE_TYPES = [\"fortitude\", \"reflex\", \"will\"];\r\nconst inlineSelector = [\"action\", \"check\", \"effect-area\"]\r\n\t.map((keyword) => `[data-pf2-${keyword}]`)\r\n\t.join(\",\");\r\n\r\nexport const InlineRollLinks = {\r\n\tinjectRepostElement: (links, foundryDoc) => {\r\n\t\tfor (const link of links) {\r\n\t\t\tif (!foundryDoc || foundryDoc.isOwner) link.classList.add(\"with-repost\");\r\n\r\n\t\t\tconst repostButtons = htmlQueryAll(link, \"i[data-pf2-repost]\");\r\n\t\t\tif (repostButtons.length > 0) {\r\n\t\t\t\tif (foundryDoc && !foundryDoc.isOwner) {\r\n\t\t\t\t\tfor (const button of repostButtons) {\r\n\t\t\t\t\t\tbutton.remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlink.classList.remove(\"with-repost\");\r\n\t\t\t\t}\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (foundryDoc && !foundryDoc.isOwner) continue;\r\n\r\n\t\t\tconst newButton = document.createElement(\"i\");\r\n\t\t\tconst icon =\r\n\t\t\t\tlink.parentElement?.dataset?.pf2Checkgroup !== undefined\r\n\t\t\t\t\t? \"fa-comment-alt-dots\"\r\n\t\t\t\t\t: \"fa-comment-alt\";\r\n\t\t\tnewButton.classList.add(\"fa-solid\", icon);\r\n\t\t\tnewButton.dataset.pf2Repost = \"\";\r\n\t\t\tnewButton.title = game.i18n.localize(\"PF2E.Repost\");\r\n\t\t\tlink.appendChild(newButton);\r\n\r\n\t\t\tnewButton.addEventListener(\"click\", (event) => {\r\n\t\t\t\tevent.stopPropagation();\r\n\t\t\t\tconst target = event.target;\r\n\t\t\t\tif (!(target instanceof HTMLElement)) return;\r\n\t\t\t\tconst parent = target?.parentElement;\r\n\t\t\t\tif (!parent) return;\r\n\r\n\t\t\t\tconst document = resolveDocument(target, foundryDoc);\r\n\t\t\t\tInlineRollLinks.repostAction(parent, document);\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n\r\n\tlisten: (html, foundryDoc = resolveDocument(html)) => {\r\n\t\tconst links = htmlQueryAll(html, inlineSelector).filter((l) =>\r\n\t\t\t[\"A\", \"SPAN\"].includes(l.nodeName),\r\n\t\t);\r\n\t\tInlineRollLinks.injectRepostElement(links, foundryDoc);\r\n\r\n\t\tInlineRollLinks.flavorDamageRolls(\r\n\t\t\thtml,\r\n\t\t\tfoundryDoc instanceof Actor ? foundryDoc : null,\r\n\t\t);\r\n\r\n\t\tfor (const link of links.filter((l) => l.dataset.pf2Action)) {\r\n\t\t\tconst { pf2Action, pf2Glyph, pf2Variant, pf2Dc, pf2ShowDc, pf2Skill } =\r\n\t\t\t\tlink.dataset;\r\n\t\t\tlink.addEventListener(\"click\", (event) => {\r\n\t\t\t\tconst slug = sluggify(pf2Action ?? \"\");\r\n\t\t\t\tconst visibility = pf2ShowDc ?? \"all\";\r\n\t\t\t\tconst difficultyClass = Number.isNumeric(pf2Dc)\r\n\t\t\t\t\t? { scope: \"check\", value: Number(pf2Dc) || 0, visibility }\r\n\t\t\t\t\t: pf2Dc;\r\n\t\t\t\tif (slug && game.pf2e.actions.has(slug)) {\r\n\t\t\t\t\tgame.pf2e.actions\r\n\t\t\t\t\t\t.get(slug)\r\n\t\t\t\t\t\t?.use({\r\n\t\t\t\t\t\t\tevent,\r\n\t\t\t\t\t\t\tvariant: pf2Variant,\r\n\t\t\t\t\t\t\tdifficultyClass,\r\n\t\t\t\t\t\t\tstatistic: pf2Skill,\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\t.catch((reason) => ui.notifications.warn(reason));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst action =\r\n\t\t\t\t\t\tgame.pf2e.actions[\r\n\t\t\t\t\t\t\tpf2Action ? sluggify(pf2Action, { camel: \"dromedary\" }) : \"\"\r\n\t\t\t\t\t\t];\r\n\t\t\t\t\tif (pf2Action && action) {\r\n\t\t\t\t\t\taction({\r\n\t\t\t\t\t\t\tevent,\r\n\t\t\t\t\t\t\tglyph: pf2Glyph,\r\n\t\t\t\t\t\t\tvariant: pf2Variant,\r\n\t\t\t\t\t\t\tdifficultyClass,\r\n\t\t\t\t\t\t\tskill: pf2Skill,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\t\t`PF2e System | Skip executing unknown action '${pf2Action}'`,\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfor (const link of links.filter(\r\n\t\t\t(l) => l.dataset.pf2Check && !l.dataset.invalid,\r\n\t\t)) {\r\n\t\t\tconst {\r\n\t\t\t\tpf2Check,\r\n\t\t\t\tpf2Dc,\r\n\t\t\t\tpf2Traits,\r\n\t\t\t\tpf2Label,\r\n\t\t\t\tpf2Defense,\r\n\t\t\t\tpf2Adjustment,\r\n\t\t\t\tpf2Roller,\r\n\t\t\t\tpf2RollOptions,\r\n\t\t\t} = link.dataset;\r\n\t\t\tconst overrideTraits = \"overrideTraits\" in link.dataset;\r\n\t\t\tconst targetOwner = \"targetOwner\" in link.dataset;\r\n\r\n\t\t\tif (!pf2Check) return;\r\n\r\n\t\t\tlink.addEventListener(\"click\", async (event) => {\r\n\t\t\t\tconst parent = resolveActor(foundryDoc, link);\r\n\t\t\t\t// const actors = [parent];\r\n\t\t\t\tconst actors = (() => {\r\n\t\t\t\t\tswitch (pf2Roller) {\r\n\t\t\t\t\t\tcase \"self\":\r\n\t\t\t\t\t\t\treturn parent?.canUserModify(game.user, \"update\") ? [parent] : [];\r\n\t\t\t\t\t\tcase \"party\":\r\n\t\t\t\t\t\t\tif (parent?.isOfType(\"party\")) return [parent];\r\n\t\t\t\t\t\t\treturn R.compact([game.actors.party]);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Use the DOM document as a fallback if it's an actor and the check isn't a saving throw\r\n\t\t\t\t\tconst sheetActor = (() => {\r\n\t\t\t\t\t\tconst maybeActor =\r\n\t\t\t\t\t\t\tfoundryDoc instanceof Actor\r\n\t\t\t\t\t\t\t\t? foundryDoc\r\n\t\t\t\t\t\t\t\t: foundryDoc instanceof Item && foundryDoc.actor\r\n\t\t\t\t\t\t\t\t  ? foundryDoc.actor\r\n\t\t\t\t\t\t\t\t  : null;\r\n\t\t\t\t\t\treturn maybeActor?.isOwner && !maybeActor.isOfType(\"loot\", \"party\")\r\n\t\t\t\t\t\t\t? maybeActor\r\n\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t})();\r\n\t\t\t\t\tconst rollingActors = [\r\n\t\t\t\t\t\tsheetActor ??\r\n\t\t\t\t\t\t\tgetSelectedActors({ exclude: [\"loot\"], assignedFallback: true }),\r\n\t\t\t\t\t].flat();\r\n\r\n\t\t\t\t\tconst isSave = tupleHasValue(SAVE_TYPES, pf2Check);\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tparent?.isOfType(\"party\") ||\r\n\t\t\t\t\t\t(rollingActors.length === 0 && parent && !isSave)\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\treturn [parent];\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn rollingActors;\r\n\t\t\t\t})();\r\n\r\n\t\t\t\tif (actors.length === 0) {\r\n\t\t\t\t\tui.notifications.error(\"PF2E.ErrorMessage.NoTokenSelected\", {\r\n\t\t\t\t\t\tlocalize: true,\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst extraRollOptions = [\r\n\t\t\t\t\t...(pf2Traits?.split(\",\").map((o) => o.trim()) ?? []),\r\n\t\t\t\t\t...(pf2RollOptions?.split(\",\").map((o) => o.trim()) ?? []),\r\n\t\t\t\t];\r\n\t\t\t\tconst eventRollParams = eventToRollParams(event, { type: \"check\" });\r\n\t\t\t\tconst checkSlug = link.dataset.slug\r\n\t\t\t\t\t? sluggify(link.dataset.slug)\r\n\t\t\t\t\t: null;\r\n\r\n\t\t\t\tswitch (pf2Check) {\r\n\t\t\t\t\tcase \"flat\": {\r\n\t\t\t\t\t\tfor (const actor of actors) {\r\n\t\t\t\t\t\t\tconst flatCheck = new actor.saves.reflex.constructor(actor, {\r\n\t\t\t\t\t\t\t\tlabel: \"\",\r\n\t\t\t\t\t\t\t\tslug: \"flat\",\r\n\t\t\t\t\t\t\t\tmodifiers: [],\r\n\t\t\t\t\t\t\t\tcheck: { type: \"flat-check\" },\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tconst dc = Number.isInteger(Number(pf2Dc))\r\n\t\t\t\t\t\t\t\t? { label: pf2Label, value: Number(pf2Dc) }\r\n\t\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t\t\tflatCheck.roll({\r\n\t\t\t\t\t\t\t\t...eventRollParams,\r\n\t\t\t\t\t\t\t\tslug: checkSlug,\r\n\t\t\t\t\t\t\t\textraRollOptions,\r\n\t\t\t\t\t\t\t\tdc,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdefault: {\r\n\t\t\t\t\t\tconst isSavingThrow = tupleHasValue(SAVE_TYPES, pf2Check);\r\n\r\n\t\t\t\t\t\t// Get actual traits for display in chat cards\r\n\t\t\t\t\t\tconst traits = isSavingThrow\r\n\t\t\t\t\t\t\t? []\r\n\t\t\t\t\t\t\t: extraRollOptions.filter((t) => t in CONFIG.PF2E.actionTraits) ??\r\n\t\t\t\t\t\t\t  [];\r\n\r\n\t\t\t\t\t\tfor (const actor of actors) {\r\n\t\t\t\t\t\t\tconst statistic = (() => {\r\n\t\t\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\t\t\tpf2Check in CONFIG.PF2E.magicTraditions &&\r\n\t\t\t\t\t\t\t\t\tactor.isOfType(\"creature\")\r\n\t\t\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\t\t\tconst bestSpellcasting =\r\n\t\t\t\t\t\t\t\t\t\tactor.spellcasting\r\n\t\t\t\t\t\t\t\t\t\t\t.filter((c) => c.tradition === pf2Check)\r\n\t\t\t\t\t\t\t\t\t\t\t.flatMap((s) => s.statistic ?? [])\r\n\t\t\t\t\t\t\t\t\t\t\t.sort((a, b) => b.check.mod - a.check.mod)\r\n\t\t\t\t\t\t\t\t\t\t\t.shift() ?? null;\r\n\t\t\t\t\t\t\t\t\tif (bestSpellcasting) return bestSpellcasting;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\treturn actor.getStatistic(pf2Check);\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\tif (!statistic) {\r\n\t\t\t\t\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\t\t\t\tErrorPF2e(`Skip rolling unknown statistic ${pf2Check}`)\r\n\t\t\t\t\t\t\t\t\t\t.message,\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tconst targetActor = pf2Defense\r\n\t\t\t\t\t\t\t\t? targetOwner\r\n\t\t\t\t\t\t\t\t\t? parent\r\n\t\t\t\t\t\t\t\t\t: game.user.targets.first()?.actor\r\n\t\t\t\t\t\t\t\t: null;\r\n\r\n\t\t\t\t\t\t\tconst dcValue = (() => {\r\n\t\t\t\t\t\t\t\tconst adjustment = Number(pf2Adjustment) || 0;\r\n\t\t\t\t\t\t\t\tif (pf2Dc === \"@self.level\") {\r\n\t\t\t\t\t\t\t\t\treturn calculateDC(actor.level) + adjustment;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\treturn Number(pf2Dc ?? \"NaN\") + adjustment;\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\tconst dc = (() => {\r\n\t\t\t\t\t\t\t\tif (Number.isInteger(dcValue)) {\r\n\t\t\t\t\t\t\t\t\treturn { label: pf2Label, value: dcValue };\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\tif (pf2Defense) {\r\n\t\t\t\t\t\t\t\t\tconst defenseStat = targetActor?.getStatistic(pf2Defense);\r\n\t\t\t\t\t\t\t\t\treturn defenseStat\r\n\t\t\t\t\t\t\t\t\t\t? {\r\n\t\t\t\t\t\t\t\t\t\t\t\tstatistic: defenseStat.dc,\r\n\t\t\t\t\t\t\t\t\t\t\t\tscope: \"check\",\r\n\t\t\t\t\t\t\t\t\t\t\t\tvalue: defenseStat.dc.value,\r\n\t\t\t\t\t\t\t\t\t\t  }\r\n\t\t\t\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\t// Retrieve the item if:\r\n\t\t\t\t\t\t\t// (2) The item is an action or,\r\n\t\t\t\t\t\t\t// (1) The check is a saving throw and the item is not a weapon.\r\n\t\t\t\t\t\t\t// Exclude weapons so that roll notes on strikes from incapacitation abilities continue to work.\r\n\t\t\t\t\t\t\tconst item = (() => {\r\n\t\t\t\t\t\t\t\tconst itemFromDoc =\r\n\t\t\t\t\t\t\t\t\tfoundryDoc instanceof Item\r\n\t\t\t\t\t\t\t\t\t\t? foundryDoc\r\n\t\t\t\t\t\t\t\t\t\t: foundryDoc instanceof ChatMessage\r\n\t\t\t\t\t\t\t\t\t\t  ? foundryDoc.item\r\n\t\t\t\t\t\t\t\t\t\t  : null;\r\n\r\n\t\t\t\t\t\t\t\treturn itemFromDoc?.isOfType(\r\n\t\t\t\t\t\t\t\t\t\"action\",\r\n\t\t\t\t\t\t\t\t\t\"feat\",\r\n\t\t\t\t\t\t\t\t\t\"campaignFeature\",\r\n\t\t\t\t\t\t\t\t) ||\r\n\t\t\t\t\t\t\t\t\t(isSavingThrow && !itemFromDoc?.isOfType(\"weapon\"))\r\n\t\t\t\t\t\t\t\t\t? itemFromDoc\r\n\t\t\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\tconst args = {\r\n\t\t\t\t\t\t\t\t...eventRollParams,\r\n\t\t\t\t\t\t\t\textraRollOptions,\r\n\t\t\t\t\t\t\t\torigin:\r\n\t\t\t\t\t\t\t\t\tisSavingThrow && parent instanceof Actor ? parent : null,\r\n\t\t\t\t\t\t\t\tdc,\r\n\t\t\t\t\t\t\t\ttarget: !isSavingThrow && dc?.statistic ? targetActor : null,\r\n\t\t\t\t\t\t\t\titem,\r\n\t\t\t\t\t\t\t\ttraits,\r\n\t\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\t\t// Use a special header for checks against defenses\r\n\t\t\t\t\t\t\tconst itemIsEncounterAction =\r\n\t\t\t\t\t\t\t\t!overrideTraits &&\r\n\t\t\t\t\t\t\t\t!!(item?.isOfType(\"action\", \"feat\") && item.actionCost) &&\r\n\t\t\t\t\t\t\t\t![\"flat-check\", \"saving-throw\"].includes(statistic.check.type);\r\n\t\t\t\t\t\t\tif (itemIsEncounterAction) {\r\n\t\t\t\t\t\t\t\tconst subtitleLocKey =\r\n\t\t\t\t\t\t\t\t\tpf2Check in CONFIG.PF2E.magicTraditions\r\n\t\t\t\t\t\t\t\t\t\t? \"PF2E.ActionsCheck.spell\"\r\n\t\t\t\t\t\t\t\t\t\t: statistic.check.type === \"attack-roll\"\r\n\t\t\t\t\t\t\t\t\t\t  ? \"PF2E.ActionsCheck.x-attack-roll\"\r\n\t\t\t\t\t\t\t\t\t\t  : \"PF2E.ActionsCheck.x\";\r\n\t\t\t\t\t\t\t\targs.label = await renderTemplate(\r\n\t\t\t\t\t\t\t\t\t\"systems/pf2e/templates/chat/action/header.hbs\",\r\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\tglyph: getActionGlyph(item.actionCost),\r\n\t\t\t\t\t\t\t\t\t\tsubtitle: game.i18n.format(subtitleLocKey, {\r\n\t\t\t\t\t\t\t\t\t\t\ttype: statistic.label,\r\n\t\t\t\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t\t\t\t\t\ttitle: item.name,\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\textraRollOptions.push(...createActionOptions(item));\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tstatistic.roll(args);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst templateConversion = {\r\n\t\t\tburst: \"circle\",\r\n\t\t\tcone: \"cone\",\r\n\t\t\tcube: \"rect\",\r\n\t\t\temanation: \"circle\",\r\n\t\t\tline: \"ray\",\r\n\t\t\trect: \"rect\",\r\n\t\t\tsquare: \"rect\",\r\n\t\t};\r\n\r\n\t\tfor (const link of links.filter((l) =>\r\n\t\t\tl.hasAttribute(\"data-pf2-effect-area\"),\r\n\t\t)) {\r\n\t\t\tconst {\r\n\t\t\t\tpf2EffectArea,\r\n\t\t\t\tpf2Distance,\r\n\t\t\t\tpf2TemplateData,\r\n\t\t\t\tpf2Traits,\r\n\t\t\t\tpf2Width,\r\n\t\t\t} = link.dataset;\r\n\t\t\tlink.addEventListener(\"click\", () => {\r\n\t\t\t\tif (!canvas.ready) return;\r\n\r\n\t\t\t\tif (typeof pf2EffectArea !== \"string\") {\r\n\t\t\t\t\tconsole.warn(`PF2e System | Could not create template'`);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst data = JSON.parse(pf2TemplateData ?? \"{}\");\r\n\t\t\t\tdata.distance ||= Number(pf2Distance);\r\n\t\t\t\tdata.fillColor ||= game.user.color;\r\n\t\t\t\tdata.t = templateConversion[pf2EffectArea];\r\n\r\n\t\t\t\tswitch (data.t) {\r\n\t\t\t\t\tcase \"ray\":\r\n\t\t\t\t\t\tdata.width =\r\n\t\t\t\t\t\t\tNumber(pf2Width) ||\r\n\t\t\t\t\t\t\tCONFIG.MeasuredTemplate.defaults.width *\r\n\t\t\t\t\t\t\t\tcanvas.dimensions.distance;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"cone\":\r\n\t\t\t\t\t\tdata.angle ||= CONFIG.MeasuredTemplate.defaults.angle;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"rect\": {\r\n\t\t\t\t\t\tconst distance = data.distance ?? 0;\r\n\t\t\t\t\t\tdata.distance = Math.hypot(distance, distance);\r\n\t\t\t\t\t\tdata.width = distance;\r\n\t\t\t\t\t\tdata.direction = 45;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst flags = {\r\n\t\t\t\t\tpf2e: {},\r\n\t\t\t\t};\r\n\r\n\t\t\t\tconst normalSize = (Math.ceil(data.distance) / 5) * 5 || 5;\r\n\t\t\t\tif (\r\n\t\t\t\t\ttupleHasValue(EFFECT_AREA_SHAPES, pf2EffectArea) &&\r\n\t\t\t\t\tdata.distance === normalSize\r\n\t\t\t\t) {\r\n\t\t\t\t\tflags.pf2e.areaShape = pf2EffectArea;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst messageId =\r\n\t\t\t\t\tfoundryDoc instanceof ChatMessage\r\n\t\t\t\t\t\t? foundryDoc.id\r\n\t\t\t\t\t\t: htmlClosest(html, \"[data-message-id]\")?.dataset.messageId ?? null;\r\n\t\t\t\tif (messageId) {\r\n\t\t\t\t\tflags.pf2e.messageId = messageId;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst actor = resolveActor(foundryDoc, link);\r\n\t\t\t\tif (actor || pf2Traits) {\r\n\t\t\t\t\tconst origin = {};\r\n\t\t\t\t\tif (actor) {\r\n\t\t\t\t\t\torigin.actor = actor.uuid;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (pf2Traits) {\r\n\t\t\t\t\t\torigin.traits = pf2Traits.split(\",\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tflags.pf2e.origin = origin;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!R.isEmpty(flags.pf2e)) {\r\n\t\t\t\t\tdata.flags = flags;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcanvas.templates.createPreview(data);\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfor (const link of html.querySelectorAll(\"a[data-damage-roll]\")) {\r\n\t\t\tlink.dataset.itemUuid = foundryDoc.uuid;\r\n\t\t}\r\n\t},\r\n\r\n\tmakeRepostHtml: (target, defaultVisibility) => {\r\n\t\tconst flavor = game.i18n.localize(target.dataset.pf2RepostFlavor ?? \"\");\r\n\t\tconst showDC = target.dataset.pf2ShowDc ?? defaultVisibility;\r\n\t\treturn `<span data-visibility=\"${showDC}\">${flavor}</span> ${target.outerHTML}`.trim();\r\n\t},\r\n\r\n\trepostAction: async (target, foundryDoc = null) => {\r\n\t\tif (\r\n\t\t\t![\"pf2Action\", \"pf2Check\", \"pf2EffectArea\"].some(\r\n\t\t\t\t(d) => d in target.dataset,\r\n\t\t\t)\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst actor = resolveActor(foundryDoc, target);\r\n\t\tconst defaultVisibility = (actor ?? foundryDoc)?.hasPlayerOwner\r\n\t\t\t? \"all\"\r\n\t\t\t: \"gm\";\r\n\t\tconst content = (() => {\r\n\t\t\tif (target.parentElement?.dataset?.pf2Checkgroup !== undefined) {\r\n\t\t\t\tconst content = htmlQueryAll(target.parentElement, inlineSelector)\r\n\t\t\t\t\t.map((target) =>\r\n\t\t\t\t\t\tInlineRollLinks.makeRepostHtml(target, defaultVisibility),\r\n\t\t\t\t\t)\r\n\t\t\t\t\t.join(\"<br>\");\r\n\r\n\t\t\t\treturn `<div data-pf2-checkgroup>${content}</div>`;\r\n\t\t\t}\r\n\r\n\t\t\treturn InlineRollLinks.makeRepostHtml(target, defaultVisibility);\r\n\t\t})();\r\n\r\n\t\tconst ChatMessagePF2e = ChatMessage.implementation;\r\n\t\tconst speaker = actor\r\n\t\t\t? ChatMessagePF2e.getSpeaker({\r\n\t\t\t\t\tactor,\r\n\t\t\t\t\ttoken: actor.getActiveTokens(true, true).shift(),\r\n\t\t\t  })\r\n\t\t\t: ChatMessagePF2e.getSpeaker();\r\n\r\n\t\t// If the originating document is a journal entry, include its UUID as a flag. If a chat message, copy over\r\n\t\t// the origin flag.\r\n\t\tconst message = game.messages.get(\r\n\t\t\thtmlClosest(target, \"[data-message-id]\")?.dataset.messageId ?? \"\",\r\n\t\t);\r\n\t\tconst flags =\r\n\t\t\tfoundryDoc instanceof JournalEntry\r\n\t\t\t\t? { pf2e: { journalEntry: foundryDoc.uuid } }\r\n\t\t\t\t: message?.flags.pf2e.origin\r\n\t\t\t\t  ? { pf2e: { origin: fu.deepClone(message.flags.pf2e.origin) } }\r\n\t\t\t\t  : {};\r\n\r\n\t\treturn ChatMessagePF2e.create({ speaker, content, flags });\r\n\t},\r\n\r\n\t/** Give inline damage-roll links from items flavor text of the item name */\r\n\tflavorDamageRolls(html, actor = null) {\r\n\t\tfor (const rollLink of htmlQueryAll(\r\n\t\t\thtml,\r\n\t\t\t\"a.inline-roll[data-damage-roll]\",\r\n\t\t)) {\r\n\t\t\tconst itemId = htmlClosest(rollLink, \"[data-item-id]\")?.dataset.itemId;\r\n\t\t\tconst item = actor?.items.get(itemId ?? \"\");\r\n\t\t\tif (item) rollLink.dataset.flavor ||= item.name;\r\n\t\t}\r\n\t},\r\n};\r\n\r\n/** If the provided document exists returns it, otherwise attempt to derive it from the sheet */\r\nfunction resolveDocument(html, foundryDoc) {\r\n\tif (foundryDoc) return foundryDoc;\r\n\r\n\tconst sheet =\r\n\t\tui.windows[Number(html.closest(\".app.sheet\")?.dataset.appid)] ?? null;\r\n\r\n\tconst document = sheet?.document;\r\n\treturn document instanceof Actor || document instanceof JournalEntry\r\n\t\t? document\r\n\t\t: null;\r\n}\r\n\r\n/** Retrieve an actor via a passed document or item UUID in the dataset of a link */\r\nfunction resolveActor(foundryDoc, anchor) {\r\n\tif (foundryDoc instanceof Actor) return foundryDoc;\r\n\tif (foundryDoc instanceof Item || foundryDoc instanceof ChatMessage)\r\n\t\treturn foundryDoc.actor;\r\n\r\n\t// Retrieve item/actor from anywhere via UUID\r\n\tconst itemUuid = anchor.dataset.itemUuid;\r\n\tconst itemByUUID =\r\n\t\titemUuid && !itemUuid.startsWith(\"Compendium.\")\r\n\t\t\t? fromUuidSync(itemUuid)\r\n\t\t\t: null;\r\n\treturn itemByUUID instanceof Item ? itemByUUID.actor : null;\r\n}\r\n\r\n/** Create roll options with information about the action being used */\r\nfunction createActionOptions(item, extra = []) {\r\n\tif (!item?.isOfType(\"action\", \"feat\") || !item.actionCost) return [];\r\n\r\n\tconst slug = item.slug ?? sluggify(item.name);\r\n\tconst traits = R.uniq(\r\n\t\t[\r\n\t\t\titem.system.traits.value,\r\n\t\t\textra.filter((t) => t in CONFIG.PF2E.actionTraits),\r\n\t\t].flat(),\r\n\t);\r\n\tconst actionCost = item.actionCost.value;\r\n\r\n\treturn R.compact([\r\n\t\t`action:${slug}`,\r\n\t\t`action:cost:${actionCost}`,\r\n\t\t`self:action:slug:${slug}`,\r\n\t\t`self:action:cost:${actionCost}`,\r\n\t\t...traits.map((t) => `self:action:trait:${t}`),\r\n\t]);\r\n}\r\n", "import { createHTMLElement, htmlClosest } from \"./html\";\r\nimport { ErrorPF2e, localizer, setHasElement, sluggify } from \"./misc\";\r\nimport { eventToRollMode } from \"./scripts\";\r\n\r\nexport const HANDWRAPS_SLUG = \"handwraps-of-mighty-blows\";\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function canBeInvested(item) {\r\n\treturn item.traits.has(\"invested\");\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function hasWornSlot(item) {\r\n\treturn item.system.equipped.inSlot != null;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nfunction isWornAs(item) {\r\n\treturn item.system.usage.type === \"worn\" && item.system.equipped.inSlot;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isInvestedOrWornAs(item) {\r\n\treturn item.isInvested || isWornAs(item);\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isHeld(item) {\r\n\treturn item.system.usage.type === \"held\";\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isTwoHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-two-hands\";\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isOneHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-one-hand\";\r\n}\r\n\r\n/**\r\n * @tempate T\r\n * @param {object} item\r\n * @param {T} value\r\n * @returns {T|undefined}\r\n */\r\nfunction inSlotValue(item, value) {\r\n\tconst usage = item.system.usage;\r\n\treturn usage.type === \"worn\" && usage.where ? value : undefined;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @param {boolean} [invest]\r\n * @returns {boolean|undefined}\r\n */\r\nfunction toggleInvestedValue(item, invest) {\r\n\tconst value = invest ?? !item.system.equipped.invested;\r\n\treturn item.traits.has(\"invested\") ? value : undefined;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @param {object} options\r\n * @param {string} [options.carryType]\r\n * @param {number} [options.handsHeld]\r\n * @param {boolean} [options.inSlot]\r\n * @param {boolean} [options.invested]\r\n * @param {string|null} [options.containerId]\r\n * @returns {object}\r\n */\r\nexport function itemCarryUpdate(\r\n\titem,\r\n\t{ carryType = \"worn\", handsHeld = 0, inSlot, invested, containerId },\r\n) {\r\n\tconst update = {\r\n\t\t_id: item.id,\r\n\t\tsystem: {\r\n\t\t\tequipped: {\r\n\t\t\t\tcarryType: carryType,\r\n\t\t\t\thandsHeld: handsHeld,\r\n\t\t\t\tinSlot: inSlotValue(item, inSlot),\r\n\t\t\t\tinvested: toggleInvestedValue(item, invested),\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\r\n\tif (containerId !== undefined) {\r\n\t\tupdate.system.containerId = containerId;\r\n\t}\r\n\r\n\treturn update;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isHandwrapsOfMightyBlows(item) {\r\n\treturn (\r\n\t\titem.isOfType(\"weapon\") &&\r\n\t\titem.slug === HANDWRAPS_SLUG &&\r\n\t\titem.category === \"unarmed\"\r\n\t);\r\n}\r\n\r\n/**\r\n * @param {Item} item\r\n * @param {number} [quantity]\r\n * @returns {Coins}\r\n */\r\nexport function calculateItemPrice(item, quantity = 1, ratio = 1) {\r\n\tconst coins = game.pf2e.Coins.fromPrice(item.price, quantity);\r\n\tif (ratio === 1) return coins;\r\n\treturn coins.scale(ratio);\r\n}\r\n\r\n/**\r\n * @param {Actor} target\r\n * @param {Item} item\r\n * @param {number} quantity\r\n * @param {string} [containerId]\r\n * @param {boolean} [newStack]\r\n * @returns {Promise<Item>}\r\n */\r\nexport async function transferItemToActor(\r\n\ttarget,\r\n\titem,\r\n\tquantity,\r\n\tcontainerId,\r\n\tnewStack,\r\n) {\r\n\tconst itemQuantity = Math.min(quantity, item.quantity);\r\n\tconst newQuantity = item.quantity - itemQuantity;\r\n\r\n\tif (newQuantity < 1) {\r\n\t\tawait item.delete();\r\n\t} else {\r\n\t\tawait item.update({ \"system.quantity\": newQuantity });\r\n\t}\r\n\r\n\tconst newItemData = item.toObject();\r\n\tnewItemData.system.quantity = itemQuantity;\r\n\tnewItemData.system.equipped.carryType = \"worn\";\r\n\tif (\"invested\" in newItemData.system.equipped) {\r\n\t\tnewItemData.system.equipped.invested = item.traits.has(\"invested\")\r\n\t\t\t? false\r\n\t\t\t: null;\r\n\t}\r\n\r\n\treturn target.addToInventory(newItemData, containerId, newStack);\r\n}\r\n\r\nexport class MoveLootPopup extends FormApplication {\r\n\t/**\r\n\t * @param {Actor} object\r\n\t * @param {object} options\r\n\t * @param {{default: number, max: number}} options.quantity\r\n\t * @param {boolean} options.newStack\r\n\t * @param {boolean} options.lockStack\r\n\t * @param {boolean} options.isPurchase\r\n\t * @param {(quantity: number, newStack: boolean) => void} callback\r\n\t */\r\n\tconstructor(object, options, callback) {\r\n\t\tsuper(object, options);\r\n\t\tthis.onSubmitCallback = callback;\r\n\t}\r\n\r\n\tasync getData() {\r\n\t\tconst [prompt, buttonLabel] = this.options.isPurchase\r\n\t\t\t? [\"PF2E.loot.PurchaseLootMessage\", \"PF2E.loot.PurchaseLoot\"]\r\n\t\t\t: [\"PF2E.loot.MoveLootMessage\", \"PF2E.loot.MoveLoot\"];\r\n\r\n\t\treturn {\r\n\t\t\t...(await super.getData()),\r\n\t\t\tquantity: {\r\n\t\t\t\tdefault: this.options.quantity.default,\r\n\t\t\t\tmax: this.options.quantity.max,\r\n\t\t\t},\r\n\t\t\tnewStack: this.options.newStack,\r\n\t\t\tlockStack: this.options.lockStack,\r\n\t\t\tprompt,\r\n\t\t\tbuttonLabel,\r\n\t\t};\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn {\r\n\t\t\t...FormApplication.defaultOptions,\r\n\t\t\tid: \"MoveLootPopup\",\r\n\t\t\tclasses: [],\r\n\t\t\ttitle: game.i18n.localize(\"PF2E.loot.MoveLootPopupTitle\"),\r\n\t\t\ttemplate: \"systems/pf2e/templates/popups/loot/move-loot-popup.hbs\",\r\n\t\t\twidth: \"auto\",\r\n\t\t\tquantity: {\r\n\t\t\t\tdefault: 1,\r\n\t\t\t\tmax: 1,\r\n\t\t\t},\r\n\t\t\tnewStack: false,\r\n\t\t\tlockStack: false,\r\n\t\t\tisPurchase: false,\r\n\t\t};\r\n\t}\r\n\r\n\tasync _updateObject(_event, formData) {\r\n\t\tthis.onSubmitCallback(formData.quantity, formData.newStack);\r\n\t}\r\n}\r\n\r\nexport async function detachSubitem(subitem, skipConfirm) {\r\n\tconst parentItem = subitem.parentItem;\r\n\tif (!parentItem) throw ErrorPF2e(\"Subitem has no parent item\");\r\n\r\n\tconst localize = localizer(\"PF2E.Item.Physical.Attach.Detach\");\r\n\tconst confirmed =\r\n\t\tskipConfirm ||\r\n\t\t(await Dialog.confirm({\r\n\t\t\ttitle: localize(\"Label\"),\r\n\t\t\tcontent: createHTMLElement(\"p\", {\r\n\t\t\t\tchildren: [localize(\"Prompt\", { attachable: subitem.name })],\r\n\t\t\t}).outerHTML,\r\n\t\t}));\r\n\tif (!confirmed) return;\r\n\r\n\tconst deletePromise = subitem.delete();\r\n\tconst createPromise = (async () => {\r\n\t\t// Find a stack match, cloning the subitem as worn so the search won't fail due to it being equipped\r\n\t\tconst stack = subitem.isOfType(\"consumable\")\r\n\t\t\t? parentItem.actor?.inventory.findStackableItem(\r\n\t\t\t\t\tsubitem.clone({ \"system.equipped.carryType\": \"worn\" }),\r\n\t\t\t  )\r\n\t\t\t: null;\r\n\t\tconst keepId =\r\n\t\t\t!!parentItem.actor && !parentItem.actor.items.has(subitem.id);\r\n\t\treturn (\r\n\t\t\tstack?.update({ \"system.quantity\": stack.quantity + 1 }) ??\r\n\t\t\tItem.implementation.create(\r\n\t\t\t\tmergeObject(subitem.toObject(), {\r\n\t\t\t\t\t\"system.containerId\": parentItem.system.containerId,\r\n\t\t\t\t}),\r\n\t\t\t\t{ parent: parentItem.actor, keepId },\r\n\t\t\t)\r\n\t\t);\r\n\t})();\r\n\r\n\tawait Promise.all([deletePromise, createPromise]);\r\n}\r\n\r\nexport async function unownedItemToMessage(event, item, actor, options = {}) {\r\n\tconst ChatMessagePF2e = ChatMessage.implementation;\r\n\r\n\t// Basic template rendering data\r\n\tconst type = sluggify(item.type);\r\n\tconst template = `systems/pf2e/templates/chat/${type}-card.hbs`;\r\n\tconst token = actor.token;\r\n\tconst nearestItem = htmlClosest(event?.target, \".item\");\r\n\tconst rollOptions = options.data ?? { ...(nearestItem?.dataset ?? {}) };\r\n\tconst templateData = {\r\n\t\tactor: actor,\r\n\t\ttokenId: token ? `${token.parent?.id}.${token.id}` : null,\r\n\t\titem: item,\r\n\t\tdata: await item.getChatData(undefined, rollOptions),\r\n\t};\r\n\r\n\t// Basic chat message data\r\n\tconst originalEvent =\r\n\t\tevent instanceof MouseEvent ? event : event?.originalEvent;\r\n\tconst rollMode = options.rollMode ?? eventToRollMode(originalEvent);\r\n\tconst chatData = ChatMessagePF2e.applyRollMode(\r\n\t\t{\r\n\t\t\ttype: CONST.CHAT_MESSAGE_TYPES.OTHER,\r\n\t\t\tspeaker: ChatMessagePF2e.getSpeaker({\r\n\t\t\t\tactor: actor,\r\n\t\t\t\ttoken: actor.getActiveTokens(false, true).at(0),\r\n\t\t\t}),\r\n\t\t\tcontent: await renderTemplate(template, templateData),\r\n\t\t\tflags: { pf2e: { origin: item.getOriginData() } },\r\n\t\t},\r\n\t\trollMode,\r\n\t);\r\n\r\n\t// Create the chat message\r\n\treturn options.create ?? true\r\n\t\t? ChatMessagePF2e.create(chatData, { rollMode, renderSheet: false })\r\n\t\t: new ChatMessagePF2e(chatData, { rollMode });\r\n}\r\n\r\n/**\r\n * @param {ItemOrSource} item\r\n * @param  {...any: string[]} types\r\n * @returns {boolean}\r\n */\r\nexport function itemIsOfType(item, ...types) {\r\n\treturn (\r\n\t\ttypeof item.name === \"string\" &&\r\n\t\ttypes.some((t) =>\r\n\t\t\tt === \"physical\"\r\n\t\t\t\t? setHasElement(PHYSICAL_ITEM_TYPES, item.type)\r\n\t\t\t\t: item.type === t,\r\n\t\t)\r\n\t);\r\n}\r\n", "export const DEGREE_OF_SUCCESS = {\r\n\tCRITICAL_SUCCESS: 3,\r\n\tSUCCESS: 2,\r\n\tFAILURE: 1,\r\n\tCRITICAL_FAILURE: 0,\r\n};\r\n\r\nexport const DEGREE_ADJUSTMENT_AMOUNTS = {\r\n\tLOWER_BY_TWO: -2,\r\n\tLOWER: -1,\r\n\tINCREASE: 1,\r\n\tINCREASE_BY_TWO: 2,\r\n\tTO_CRITICAL_FAILURE: \"criticalFailure\",\r\n\tTO_FAILURE: \"failure\",\r\n\tTO_SUCCESS: \"success\",\r\n\tTO_CRITICAL_SUCCESS: \"criticalSuccess\",\r\n};\r\n\r\nexport const DEGREE_OF_SUCCESS_STRINGS = [\r\n\t\"criticalFailure\",\r\n\t\"failure\",\r\n\t\"success\",\r\n\t\"criticalSuccess\",\r\n];\r\n\r\n/**\r\n * @class\r\n * @constructor\r\n */\r\nexport class DegreeOfSuccess {\r\n\t/**\r\n\t * @param {{dieResult: number, rollTotal: number}} roll\r\n\t * @param {number|{value: number}} dc\r\n\t * @param {object|null} [dosAdjustments]\r\n\t */\r\n\tconstructor(roll, dc, dosAdjustments = null) {\r\n\t\tif (roll instanceof Roll) {\r\n\t\t\tthis.dieResult =\r\n\t\t\t\t(roll.isDeterministic\r\n\t\t\t\t\t? roll.terms.find((t) => t instanceof NumericTerm)\r\n\t\t\t\t\t: roll.dice.find((d) => d instanceof Die && d.faces === 20)\r\n\t\t\t\t)?.total ?? 1;\r\n\t\t\tthis.rollTotal = roll.total;\r\n\t\t} else {\r\n\t\t\tthis.dieResult = roll.dieValue;\r\n\t\t\tthis.rollTotal = roll.dieValue + roll.modifier;\r\n\t\t}\r\n\r\n\t\tthis.dc = typeof dc === \"number\" ? { value: dc } : dc;\r\n\r\n\t\tthis.unadjusted = this.#calculateDegreeOfSuccess();\r\n\t\tthis.adjustment = this.#getDegreeAdjustment(\r\n\t\t\tthis.unadjusted,\r\n\t\t\tdosAdjustments,\r\n\t\t);\r\n\t\t/**\r\n\t\t * @type {0|1|2|3}\r\n\t\t */\r\n\t\tthis.value = this.adjustment\r\n\t\t\t? this.#adjustDegreeOfSuccess(this.adjustment.amount, this.unadjusted)\r\n\t\t\t: this.unadjusted;\r\n\t}\r\n\r\n\tstatic CRITICAL_FAILURE = 0;\r\n\tstatic FAILURE = 1;\r\n\tstatic SUCCESS = 2;\r\n\tstatic CRITICAL_SUCCESS = 3;\r\n\r\n\t#getDegreeAdjustment(degree, adjustments) {\r\n\t\tif (!adjustments) return null;\r\n\r\n\t\tfor (const outcome of [\"all\", ...DEGREE_OF_SUCCESS_STRINGS]) {\r\n\t\t\tconst { label, amount } = adjustments[outcome] ?? {};\r\n\t\t\tif (\r\n\t\t\t\tamount &&\r\n\t\t\t\tlabel &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tdegree === DegreeOfSuccess.CRITICAL_SUCCESS &&\r\n\t\t\t\t\tamount === DEGREE_ADJUSTMENT_AMOUNTS.INCREASE\r\n\t\t\t\t) &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tdegree === DegreeOfSuccess.CRITICAL_FAILURE &&\r\n\t\t\t\t\tamount === DEGREE_ADJUSTMENT_AMOUNTS.LOWER\r\n\t\t\t\t) &&\r\n\t\t\t\t(outcome === \"all\" ||\r\n\t\t\t\t\tDEGREE_OF_SUCCESS_STRINGS.indexOf(outcome) === degree)\r\n\t\t\t) {\r\n\t\t\t\treturn { label, amount };\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\t#adjustDegreeOfSuccess(amount, degreeOfSuccess) {\r\n\t\tswitch (amount) {\r\n\t\t\tcase \"criticalFailure\":\r\n\t\t\t\treturn 0;\r\n\t\t\tcase \"failure\":\r\n\t\t\t\treturn 1;\r\n\t\t\tcase \"success\":\r\n\t\t\t\treturn 2;\r\n\t\t\tcase \"criticalSuccess\":\r\n\t\t\t\treturn 3;\r\n\t\t\tdefault:\r\n\t\t\t\treturn Math.clamped(degreeOfSuccess + amount, 0, 3);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * @param degree The current success value\r\n\t * @return The new success value\r\n\t */\r\n\t#adjustDegreeByDieValue(degree) {\r\n\t\tif (this.dieResult === 20) {\r\n\t\t\treturn this.#adjustDegreeOfSuccess(\r\n\t\t\t\tDEGREE_ADJUSTMENT_AMOUNTS.INCREASE,\r\n\t\t\t\tdegree,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (this.dieResult === 1) {\r\n\t\t\treturn this.#adjustDegreeOfSuccess(\r\n\t\t\t\tDEGREE_ADJUSTMENT_AMOUNTS.LOWER,\r\n\t\t\t\tdegree,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn degree;\r\n\t}\r\n\r\n\t#calculateDegreeOfSuccess() {\r\n\t\tconst dc = this.dc.value;\r\n\r\n\t\tif (this.rollTotal - dc >= 10) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_SUCCESS);\r\n\t\t}\r\n\r\n\t\tif (dc - this.rollTotal >= 10) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_FAILURE);\r\n\t\t}\r\n\r\n\t\tif (this.rollTotal >= dc) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.SUCCESS);\r\n\t\t}\r\n\r\n\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.FAILURE);\r\n\t}\r\n}\r\n", "import { localize, templatePath } from \"../module.js\";\r\n\r\nconst RESOLVE_UUID = \"Compendium.pf2e.feats-srd.Item.jFmdevE4nKevovzo\";\r\n\r\nexport async function useResolve(actor) {\r\n\tfunction toChat(content) {\r\n\t\tChatMessage.create({\r\n\t\t\tuser: game.user.id,\r\n\t\t\tcontent,\r\n\t\t\tspeaker: ChatMessage.getSpeaker({ actor }),\r\n\t\t});\r\n\t}\r\n\r\n\tconst { name, attributes, system } = actor;\r\n\tconst sp = attributes.hp.sp;\r\n\tconst resolve = system.resources.resolve;\r\n\tconst fullStamina = localize(\"hud.resolve.full\", { name });\r\n\tconst noResolve = game.i18n.format(\r\n\t\t\"PF2E.Actions.SteelYourResolve.NoStamina\",\r\n\t\t{ name },\r\n\t);\r\n\r\n\tif (sp.value === sp.max) return ui.notifications.warn(fullStamina);\r\n\tif (resolve.value < 1) return ui.notifications.warn(noResolve);\r\n\r\n\tconst hasSteel = actor.itemTypes.feat.find(\r\n\t\t(item) => item.sourceId === RESOLVE_UUID,\r\n\t);\r\n\tconst content = await renderTemplate(templatePath(\"dialogs/resolve\"), {\r\n\t\thasSteel,\r\n\t\ti18n: (str) => localize(`hud.resolve.${str}`),\r\n\t});\r\n\r\n\tnew Dialog({\r\n\t\ttitle: localize(\"hud.resolve.title\"),\r\n\t\tcontent,\r\n\t\tbuttons: {\r\n\t\t\tyes: {\r\n\t\t\t\ticon: \"<i class='fas fa-check'></i>\",\r\n\t\t\t\tlabel: localize(\"hud.resolve.yes\"),\r\n\t\t\t\tcallback: async (html) => {\r\n\t\t\t\t\tconst { attributes, system } = actor;\r\n\t\t\t\t\tconst sp = attributes.hp.sp;\r\n\t\t\t\t\tconst resolve = system.resources.resolve;\r\n\r\n\t\t\t\t\tif (sp.value === sp.max) return toChat(fullStamina);\r\n\t\t\t\t\tif (resolve.value < 1) return toChat(noResolve);\r\n\r\n\t\t\t\t\tconst selected = html.find(\"input:checked\").val();\r\n\t\t\t\t\tconst ratio = `${sp.value}/${sp.max}`;\r\n\r\n\t\t\t\t\tif (selected === \"breather\") {\r\n\t\t\t\t\t\ttoChat(localize(\"hud.resolve.breather.used\", { name, ratio }));\r\n\t\t\t\t\t\tawait actor.update({\r\n\t\t\t\t\t\t\t\"system.attributes.hp.sp.value\": sp.max,\r\n\t\t\t\t\t\t\t\"system.resources.resolve.value\": resolve.value - 1,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttoChat(\r\n\t\t\t\t\t\t\tgame.i18n.format(\"PF2E.Actions.SteelYourResolve.RecoverStamina\", {\r\n\t\t\t\t\t\t\t\tname,\r\n\t\t\t\t\t\t\t\tratio,\r\n\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tconst newSP = sp.value + Math.floor(sp.max / 2);\r\n\t\t\t\t\t\tawait actor.update({\r\n\t\t\t\t\t\t\t\"system.attributes.hp.sp.value\": Math.min(newSP, sp.max),\r\n\t\t\t\t\t\t\t\"system.resources.resolve.value\": resolve.value - 1,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tno: {\r\n\t\t\t\ticon: \"<i class='fas fa-times'></i>\",\r\n\t\t\t\tlabel: localize(\"hud.resolve.no\"),\r\n\t\t\t},\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n", "import { getFlag, setFlag } from \"./module.js\";\r\n\r\nexport const RANKS = [\"U\", \"T\", \"E\", \"M\", \"L\"];\r\n\r\nconst COVER_UUID = \"Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi\";\r\n\r\nexport function addNameTooltipListeners(el) {\r\n\tconst targetEl = el.find(\".name\");\r\n\r\n\ttargetEl.on(\"mouseenter\", (event) => {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst target = event.currentTarget;\r\n\t\tconst { width } = target.getBoundingClientRect();\r\n\t\tif (target.scrollWidth <= Math.ceil(width)) return;\r\n\r\n\t\tconst name = target.innerHTML.trim();\r\n\t\tgame.tooltip.activate(event.currentTarget, {\r\n\t\t\ttext: name,\r\n\t\t\tdirection: TooltipManager.TOOLTIP_DIRECTIONS.UP,\r\n\t\t});\r\n\t});\r\n\r\n\ttargetEl.on(\"mouseleave\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tgame.tooltip.deactivate();\r\n\t});\r\n\r\n\ttargetEl.on(\"mousedown\", (event) => {\r\n\t\tgame.tooltip.deactivate();\r\n\t});\r\n}\r\n\r\nexport function getItemFromElement(el, actor) {\r\n\tconst { itemId, parentId, entryId, castRank } = el.dataset;\r\n\r\n\tif (entryId) {\r\n\t\tconst collection = actor.spellcasting.collections.get(entryId);\r\n\t\treturn collection?.get(itemId);\r\n\t}\r\n\r\n\tconst item = actor.items.get(parentId ?? itemId);\r\n\treturn parentId ? item?.subitems.get(itemId) : item;\r\n}\r\n\r\nexport function getItemFromEvent(event, actor) {\r\n\tconst el = event.currentTarget.closest(\"[data-item-id]\");\r\n\treturn getItemFromElement(el, actor);\r\n}\r\n\r\nexport function getMacros(actor) {\r\n\treturn actor.isOwner\r\n\t\t? getFlag(actor, `macros.${game.user.id}`)\r\n\t\t\t\t?.map((uuid) => {\r\n\t\t\t\t\tconst macro = fromUuidSync(uuid);\r\n\t\t\t\t\tif (!macro) return null;\r\n\t\t\t\t\treturn { img: macro.img, name: macro.name, uuid };\r\n\t\t\t\t})\r\n\t\t\t\t.filter(Boolean)\r\n\t\t: undefined;\r\n}\r\n\r\nexport function onDroppedMacro(event, actor) {\r\n\tconst { type, uuid } = TextEditor.getDragEventData(event.originalEvent) ?? {};\r\n\tif (type !== \"Macro\" || !fromUuidSync(uuid)) return;\r\n\r\n\tconst flag = `macros.${game.user.id}`;\r\n\tconst macros = getFlag(actor, flag)?.slice() ?? [];\r\n\tif (macros.includes(uuid)) return;\r\n\r\n\tmacros.push(uuid);\r\n\tsetFlag(actor, flag, macros);\r\n}\r\n\r\nexport function deleteMacro(event, actor) {\r\n\tconst flag = `macros.${game.user.id}`;\r\n\tconst macros = getFlag(actor, flag)?.slice();\r\n\tif (!macros?.length) return;\r\n\r\n\tconst { uuid } = event.currentTarget.closest(\".macro\").dataset;\r\n\tconst index = macros.indexOf(uuid);\r\n\tif (index === -1) return;\r\n\r\n\tmacros.splice(index, 1);\r\n\tsetFlag(actor, flag, macros);\r\n}\r\n\r\nexport function getUniqueTarget(condition = () => true) {\r\n\tconst targets = game.user.targets;\r\n\tconst target = targets.size === 1 ? targets.first() : null;\r\n\treturn target && condition(target) ? target : null;\r\n}\r\n\r\nexport function filterIn(value, filter) {\r\n\tif (!filter) return true;\r\n\treturn value.toLowerCase().includes(filter);\r\n}\r\n\r\nexport function localeCompare(a, b) {\r\n\treturn a.localeCompare(b, game.i18n.lang);\r\n}\r\n\r\nexport function getCoverEffect(actor) {\r\n\treturn actor?.itemTypes.effect.find(\r\n\t\t(effect) => effect.flags.core?.sourceId === COVER_UUID,\r\n\t);\r\n}\r\n", "import { InlineRollLinks } from \"module-api\";\r\nimport { enrichHTML, getHud, localize } from \"./module.js\";\r\nimport { getItemFromElement } from \"./shared.js\";\r\n\r\nexport async function popup(title, content, actor) {\r\n\tconst hud = getHud();\r\n\tconst el = hud?.element;\r\n\tif (!el) return;\r\n\r\n\tel.find(\"> .popup\").remove();\r\n\r\n\tconst tmp = document.createElement(\"div\");\r\n\ttmp.innerHTML = `<div class=\"popup\">\r\n    <div class=\"header\">\r\n        <div class=\"title\">${title}</div>\r\n        <a class=\"observable\" data-action=\"close-popup\"><i class=\"fas fa-times\"></i> ${localize(\r\n\t\t\t\t\t\"popup.close\",\r\n\t\t\t\t)}</a>\r\n    </div>\r\n</div>`;\r\n\r\n\tconst popup = tmp.firstElementChild;\r\n\tif (typeof content === \"string\") {\r\n\t\tconst enriched = await enrichHTML(content, actor);\r\n\t\tpopup.insertAdjacentHTML(\"beforeend\", enriched);\r\n\t} else {\r\n\t\tpopup.append(content);\r\n\t}\r\n\r\n\tpopup\r\n\t\t.querySelector(\"[data-action=close-popup]\")\r\n\t\t.addEventListener(\"click\", () => popup.remove());\r\n\r\n\tconst consumeLinks = popup.querySelectorAll(\"[data-action^='consume-']\");\r\n\tfor (const link of consumeLinks) {\r\n\t\tlink.addEventListener(\"click\", () => popup.remove());\r\n\t}\r\n\r\n\tel.append(popup);\r\n\thud.lock();\r\n}\r\n\r\nexport async function showItemSummary(el, actor, title) {\r\n\tconst dataset = el.data();\r\n\tconst item = dataset.itemId\r\n\t\t? getItemFromElement(el[0], actor)\r\n\t\t: await fromUuid(dataset.uuid);\r\n\r\n\tconst data = await item?.getChatData({ secrets: actor.isOwner }, dataset);\r\n\tif (!data) return;\r\n\r\n\tconst description = document.createElement(\"div\");\r\n\tdescription.classList.add(\"popup-description\");\r\n\r\n\tawait actor.sheet.itemRenderer.renderItemSummary(description, item, data);\r\n\tInlineRollLinks.listen(description, item);\r\n\r\n\tif (item.isOfType(\"consumable\")) {\r\n\t\tconst consumeLinks = description.querySelectorAll(\r\n\t\t\t\"[data-action='consume-item']\",\r\n\t\t);\r\n\t\tfor (const btn of consumeLinks) {\r\n\t\t\tbtn.addEventListener(\"click\", () => item.consume());\r\n\t\t}\r\n\t}\r\n\r\n\tif (dataset.castRank) {\r\n\t\tdescription.dataset.castRank = dataset.castRank;\r\n\t}\r\n\r\n\tconst popupTitle = title ?? el.find(\".name\").html();\r\n\tpopup(popupTitle.trim(), description, actor);\r\n}\r\n", "import { DegreeOfSuccess } from \"module-api\";\r\nimport { getSetting, localize, modifier, templatePath } from \"../module.js\";\r\nimport { RANKS, getUniqueTarget } from \"../shared.js\";\r\n\r\nconst SKILLS = [\r\n\t\"arcana\",\r\n\t\"crafting\",\r\n\t\"medicine\",\r\n\t\"nature\",\r\n\t\"occultism\",\r\n\t\"religion\",\r\n\t\"society\",\r\n];\r\n\r\nconst SUCCESS = {\r\n\t0: {\r\n\t\ticon: '<i class=\"fa-solid fa-xmark-large\"></i><i class=\"fa-solid fa-xmark-large\"></i>',\r\n\t\tname: \"criticalFailure\",\r\n\t},\r\n\t1: { icon: '<i class=\"fa-solid fa-xmark-large\"></i>', name: \"failure\" },\r\n\t2: { icon: '<i class=\"fa-solid fa-check\"></i>', name: \"success\" },\r\n\t3: {\r\n\t\ticon: '<i class=\"fa-solid fa-check\"></i><i class=\"fa-solid fa-check\"></i>',\r\n\t\tname: \"criticalSuccess\",\r\n\t},\r\n};\r\n\r\nexport async function rollRecallKnowledges(actor) {\r\n\tconst roll = await new Roll(\"1d20\").evaluate({ async: true });\r\n\tconst dieResult = roll.dice[0].total;\r\n\tconst dieSuccess = dieResult === 1 ? \"0\" : dieResult === 20 ? \"3\" : \"\";\r\n\tconst lores = Object.values(actor.skills).filter((skill) => skill.lore);\r\n\tconst target = getUniqueTarget(\r\n\t\t(target) => target.actor?.identificationDCs,\r\n\t)?.actor;\r\n\r\n\tconst data = {\r\n\t\tdieSuccess,\r\n\t\tdieResult,\r\n\t\ttarget,\r\n\t\ti18n: (str) => localize(`actions.recall-knowledge.${str}`),\r\n\t};\r\n\r\n\tif (target) {\r\n\t\tconst { standard, skills, lore } = target.identificationDCs;\r\n\r\n\t\tlet skillsDCs = standard.progression.slice();\r\n\t\tskillsDCs.length = 4;\r\n\t\tskillsDCs = [...skillsDCs];\r\n\r\n\t\tconst loresDCs = lore.map(({ progression }) => {\r\n\t\t\tconst dcs = progression;\r\n\t\t\tdcs.length = 6;\r\n\t\t\treturn [...dcs];\r\n\t\t});\r\n\r\n\t\tdata.skillsDCs = skillsDCs;\r\n\t\tdata.loresDCs = loresDCs;\r\n\r\n\t\tdata.skills = await Promise.all(\r\n\t\t\tskills.map((slug) => {\r\n\t\t\t\tconst skill = actor.skills[slug];\r\n\t\t\t\treturn rollSkill(skill, dieResult, skillsDCs);\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\tdata.lores = await Promise.all(\r\n\t\t\tlores.map((lore) => rollSkill(lore, dieResult)),\r\n\t\t);\r\n\t} else {\r\n\t\tdata.skills = await Promise.all(\r\n\t\t\t[...SKILLS.map((slug) => actor.skills[slug]), ...lores].map((skill) =>\r\n\t\t\t\trollSkill(skill, dieResult),\r\n\t\t\t),\r\n\t\t);\r\n\t}\r\n\r\n\tconst rkDice = getSetting(\"rk-dice\");\r\n\r\n\tconst options = {\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor }),\r\n\t\trollMode: game.pf2e.settings.metagame.secretChecks\r\n\t\t\t? CONST.DICE_ROLL_MODES.PUBLIC\r\n\t\t\t: CONST.DICE_ROLL_MODES.BLIND,\r\n\t\ttype: CONST.CHAT_MESSAGE_TYPES.ROLL,\r\n\t};\r\n\r\n\tif (rkDice) {\r\n\t\toptions.rolls = [roll];\r\n\t\tdata.rkDice = true;\r\n\t}\r\n\r\n\toptions.flavor = await renderTemplate(\r\n\t\ttemplatePath(\"chat/recall-knowledge\"),\r\n\t\tdata,\r\n\t);\r\n\r\n\tChatMessage.create(options);\r\n}\r\n\r\nasync function rollSkill(skill, dieResult, dcs) {\r\n\tconst { rank, label } = skill;\r\n\r\n\tconst roll = await skill.roll({\r\n\t\tcreateMessage: false,\r\n\t\tskipDialog: true,\r\n\t\textraRollOptions: [\"action:recall-knowledge\"],\r\n\t});\r\n\r\n\tconst mod = roll.total - roll.dice[0].total;\r\n\r\n\tconst fakeRoll = {\r\n\t\tdieValue: dieResult,\r\n\t\tmodifier: mod,\r\n\t};\r\n\r\n\treturn {\r\n\t\tmod,\r\n\t\trank,\r\n\t\tlabel,\r\n\t\ttotal: dieResult + mod,\r\n\t\tmodifier: modifier(mod),\r\n\t\trankLabel: RANKS[rank],\r\n\t\tchecks: dcs?.map((dc) => {\r\n\t\t\tif (!dc) return \"-\";\r\n\t\t\tconst success = new DegreeOfSuccess(fakeRoll, dc).value;\r\n\t\t\treturn {\r\n\t\t\t\tsuccess,\r\n\t\t\t\ticon: SUCCESS[success].icon,\r\n\t\t\t\ttitle: SUCCESS[success].name,\r\n\t\t\t};\r\n\t\t}),\r\n\t};\r\n}\r\n", "import { unownedItemToMessage } from \"module-api\";\r\nimport {\r\n\tgetSetting,\r\n\thasFeat,\r\n\tlocalize,\r\n\tmodifier,\r\n\ttemplatePath,\r\n} from \"../module.js\";\r\nimport { showItemSummary } from \"../popup.js\";\r\nimport { filterIn, localeCompare } from \"../shared.js\";\r\n\r\nconst MODULE_ID = \"pf2e-token-hud\";\r\n\r\nconst UNTRAINED_IMPROVISATION =\r\n\t\"Compendium.pf2e.feats-srd.Item.9jGaBxLUtevZYcZO\";\r\n\r\nconst CROWBAR_UUIDS = new Set([\r\n\t\"Compendium.pf2e.equipment-srd.Item.44F1mfJei4GY8f2X\",\r\n\t\"Compendium.pf2e.equipment-srd.Item.4kz3vhkKPUuXBpxk\",\r\n]);\r\nconst BON_MOT_UUID = \"Compendium.pf2e.feats-srd.Item.0GF2j54roPFIDmXf\";\r\nconst NATURAL_MEDICINE_UUID = \"Compendium.pf2e.feats-srd.Item.WC4xLBGmBsdOdHWu\";\r\nconst FOLLOW_THE_EXPERT_UUID =\r\n\t\"Compendium.pf2e.other-effects.Item.VCSpuc3Tf3XWMkd3\";\r\n\r\nconst LABELS = {\r\n\tinitiative: \"PF2E.InitiativeLabel\",\r\n\t\"recall-knowledge\": \"PF2E.RecallKnowledge.Label\",\r\n\t\"cover-tracks\": \"PF2E.TravelSpeed.ExplorationActivities.CoverTracks\",\r\n\tearnIncome: `${MODULE_ID}.skills.actions.earnIncome`,\r\n\ttreatWounds: `${MODULE_ID}.skills.actions.treatWounds`,\r\n\t\"borrow-arcane-spell\": `${MODULE_ID}.skills.actions.borrow-arcane-spell`,\r\n\t\"identify-magic\": `${MODULE_ID}.skills.actions.identify-magic`,\r\n\t\"identify-alchemy\": `${MODULE_ID}.skills.actions.identify-alchemy`,\r\n\t\"crafting-goods\": `${MODULE_ID}.skills.actions.crafting-goods`,\r\n\t\"staging-performance\": `${MODULE_ID}.skills.actions.staging-performance`,\r\n};\r\n\r\nconst ACTIONS_UUIDS = {\r\n\taid: \"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW\",\r\n\t\"sense-motive\": \"Compendium.pf2e.actionspf2e.Item.1xRFPTFtWtGJ9ELw\",\r\n\tseek: \"Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ\",\r\n\tbalance: \"Compendium.pf2e.actionspf2e.Item.M76ycLAqHoAgbcej\",\r\n\tescape: \"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9\",\r\n\t\"follow-the-expert\": \"Compendium.pf2e.actionspf2e.Item.tfa4Sh7wcxCEqL29\",\r\n\t\"tumble-through\": \"Compendium.pf2e.actionspf2e.Item.21WIfSu7Xd7uKqV8\",\r\n\t\"maneuver-in-flight\": \"Compendium.pf2e.actionspf2e.Item.Qf1ylAbdVi1rkc8M\",\r\n\tsqueeze: \"Compendium.pf2e.actionspf2e.Item.kMcV8e5EZUxa6evt\",\r\n\t\"recall-knowledge\": \"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo\",\r\n\t\"borrow-arcane-spell\": \"Compendium.pf2e.actionspf2e.Item.OizxuPb44g3eHPFh\",\r\n\t\"decipher-writing\": \"Compendium.pf2e.actionspf2e.Item.d9gbpiQjChYDYA2L\",\r\n\t\"identify-magic\": \"Compendium.pf2e.actionspf2e.Item.eReSHVEPCsdkSL4G\",\r\n\t\"learn-a-spell\": \"Compendium.pf2e.actionspf2e.Item.Q5iIYCFdqJFM31GW\",\r\n\tclimb: \"Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy\",\r\n\t\"force-open\": \"Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx\",\r\n\tgrapple: \"Compendium.pf2e.actionspf2e.Item.PMbdMWc2QroouFGD\",\r\n\t\"high-jump\": \"Compendium.pf2e.actionspf2e.Item.2HJ4yuEFY1Cast4h\",\r\n\t\"long-jump\": \"Compendium.pf2e.actionspf2e.Item.JUvAvruz7yRQXfz2\",\r\n\treposition: \"Compendium.pf2e.actionspf2e.Item.lOE4yjUnETTdaf2T\",\r\n\tshove: \"Compendium.pf2e.actionspf2e.Item.7blmbDrQFNfdT731\",\r\n\tswim: \"Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx\",\r\n\ttrip: \"Compendium.pf2e.actionspf2e.Item.ge56Lu1xXVFYUnLP\",\r\n\tdisarm: \"Compendium.pf2e.actionspf2e.Item.Dt6B1slsBy8ipJu9\",\r\n\trepair: \"Compendium.pf2e.actionspf2e.Item.bT3skovyLUtP22ME\",\r\n\tcraft: \"Compendium.pf2e.actionspf2e.Item.rmwa3OyhTZ2i2AHl\",\r\n\t\"crafting-goods\": \"\",\r\n\tearnIncome: \"Compendium.pf2e.actionspf2e.Item.QyzlsLrqM0EEwd7j\",\r\n\t\"identify-alchemy\": \"Compendium.pf2e.actionspf2e.Item.Q4kdWVOf2ztIBFg1\",\r\n\t\"create-a-diversion\": \"Compendium.pf2e.actionspf2e.Item.GkmbTGfg8KcgynOA\",\r\n\timpersonate: \"Compendium.pf2e.actionspf2e.Item.AJstokjdG6iDjVjE\",\r\n\tlie: \"Compendium.pf2e.actionspf2e.Item.ewwCglB7XOPLUz72\",\r\n\tfeint: \"Compendium.pf2e.actionspf2e.Item.QNAVeNKtHA0EUw4X\",\r\n\tbonMot: BON_MOT_UUID,\r\n\t\"gather-information\": \"Compendium.pf2e.actionspf2e.Item.plBGdZhqq5JBl1D8\",\r\n\t\"make-an-impression\": \"Compendium.pf2e.actionspf2e.Item.OX4fy22hQgUHDr0q\",\r\n\trequest: \"Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6\",\r\n\tcoerce: \"Compendium.pf2e.actionspf2e.Item.tHCqgwjtQtzNqVvd\",\r\n\tdemoralize: \"Compendium.pf2e.actionspf2e.Item.2u915NdUyQan6uKF\",\r\n\t\"administer-first-aid\": \"Compendium.pf2e.actionspf2e.Item.MHLuKy4nQO2Z4Am1\",\r\n\t\"treat-disease\": \"Compendium.pf2e.actionspf2e.Item.TC7OcDa7JlWbqMaN\",\r\n\t\"treat-poison\": \"Compendium.pf2e.actionspf2e.Item.KjoCEEmPGTeFE4hh\",\r\n\ttreatWounds: \"Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9\",\r\n\t\"command-an-animal\": \"Compendium.pf2e.actionspf2e.Item.q9nbyIF0PEBqMtYe\",\r\n\tperform: \"Compendium.pf2e.actionspf2e.Item.EEDElIyin4z60PXx\",\r\n\t\"staging-performance\": \"\",\r\n\tsubsist: \"Compendium.pf2e.actionspf2e.Item.49y9Ec4bDii8pcD3\",\r\n\t\"create-forgery\": \"Compendium.pf2e.actionspf2e.Item.ftG89SjTSa9DYDOD\",\r\n\t\"conceal-an-object\": \"Compendium.pf2e.actionspf2e.Item.qVNVSmsgpKFGk9hV\",\r\n\thide: \"Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa\",\r\n\tsneak: \"Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4\",\r\n\t\"sense-direction\": \"Compendium.pf2e.actionspf2e.Item.fJImDBQfqfjKJOhk\",\r\n\t\"cover-tracks\": \"Compendium.pf2e.actionspf2e.Item.SB7cMECVtE06kByk\",\r\n\ttrack: \"Compendium.pf2e.actionspf2e.Item.EA5vuSgJfiHH7plD\",\r\n\t\"palm-an-object\": \"Compendium.pf2e.actionspf2e.Item.ijZ0DDFpMkWqaShd\",\r\n\tsteal: \"Compendium.pf2e.actionspf2e.Item.RDXXE7wMrSPCLv5k\",\r\n\t\"disable-device\": \"Compendium.pf2e.actionspf2e.Item.cYdz2grcOcRt4jk6\",\r\n\t\"pick-a-lock\": \"Compendium.pf2e.actionspf2e.Item.2EE4aF4SZpYf0R6H\",\r\n};\r\n\r\nconst DUPLICATE_SKILLS = {\r\n\tescape: { slug: \"escape\", cost: \"1\", noSkill: true },\r\n\t\"recall-knowledge\": { slug: \"recall-knowledge\", cost: \"1\", secret: true },\r\n\t\"decipher-writing\": { slug: \"decipher-writing\", trained: true },\r\n\t\"identify-magic\": { slug: \"identify-magic\", trained: true },\r\n\t\"learn-a-spell\": { slug: \"learn-a-spell\", trained: true },\r\n};\r\n\r\nconst SKILLS = [\r\n\t{\r\n\t\tslug: \"perception\",\r\n\t\tactions: [\r\n\t\t\t{ slug: \"sense-motive\", cost: \"1\" },\r\n\t\t\t{ slug: \"seek\", cost: \"1\" },\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"acrobatics\",\r\n\t\tactions: [\r\n\t\t\t{ slug: \"balance\", cost: \"1\" },\r\n\t\t\t// 'escape',\r\n\t\t\t{ slug: \"tumble-through\", cost: \"1\" },\r\n\t\t\t{ slug: \"maneuver-in-flight\", cost: \"1\", trained: true },\r\n\t\t\t{ slug: \"squeeze\", trained: true },\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"arcana\",\r\n\t\tactions: [\r\n\t\t\t// 'recall-knowledge',\r\n\t\t\t{ slug: \"borrow-arcane-spell\", trained: true },\r\n\t\t\t\"decipher-writing\",\r\n\t\t\t\"identify-magic\",\r\n\t\t\t\"learn-a-spell\",\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"athletics\",\r\n\t\tactions: [\r\n\t\t\t{ slug: \"climb\", cost: \"1\" },\r\n\t\t\t// 'escape',\r\n\t\t\t{\r\n\t\t\t\tslug: \"force-open\",\r\n\t\t\t\tcost: \"1\",\r\n\t\t\t\tmap: true,\r\n\t\t\t\tmodifiers: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcondition: (actor) =>\r\n\t\t\t\t\t\t\t!actor.itemTypes.equipment.some(\r\n\t\t\t\t\t\t\t\t(item) => item.isHeld && CROWBAR_UUIDS.has(item.sourceId),\r\n\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\tmodifiers: [\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tslug: \"crowbar-missing\",\r\n\t\t\t\t\t\t\t\tmodifier: -2,\r\n\t\t\t\t\t\t\t\ttype: \"circumstance\",\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t],\r\n\t\t\t\t\t},\r\n\t\t\t\t],\r\n\t\t\t},\r\n\t\t\t{ slug: \"grapple\", cost: \"1\", map: true, agile: true },\r\n\t\t\t{ slug: \"high-jump\", cost: \"1\" },\r\n\t\t\t{ slug: \"long-jump\", cost: \"1\" },\r\n\t\t\t{ slug: \"reposition\", cost: \"1\", map: true, agile: true },\r\n\t\t\t{ slug: \"shove\", cost: \"1\", map: true, agile: true },\r\n\t\t\t{ slug: \"swim\", cost: \"1\" },\r\n\t\t\t{ slug: \"trip\", cost: \"1\", map: true, agile: true },\r\n\t\t\t{\r\n\t\t\t\tslug: \"disarm\",\r\n\t\t\t\tcost: \"1\",\r\n\t\t\t\tmap: true,\r\n\t\t\t\ttrained: true,\r\n\t\t\t\tagile: true,\r\n\t\t\t},\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"crafting\",\r\n\t\tactions: [\r\n\t\t\t// 'recall-knowledge',\r\n\t\t\t{ slug: \"repair\" },\r\n\t\t\t{ slug: \"craft\", trained: true },\r\n\t\t\t{ slug: \"crafting-goods\", trained: true },\r\n\t\t\t{ slug: \"earnIncome\", type: 3, trained: true },\r\n\t\t\t{ slug: \"identify-alchemy\", trained: true },\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"deception\",\r\n\t\tactions: [\r\n\t\t\t{\r\n\t\t\t\tslug: \"create-a-diversion\",\r\n\t\t\t\tcost: \"1\",\r\n\t\t\t\tvariants: [\"distracting-words\", \"gesture\", \"trick\"],\r\n\t\t\t},\r\n\t\t\t{ slug: \"impersonate\" },\r\n\t\t\t{ slug: \"lie\" },\r\n\t\t\t{ slug: \"feint\", cost: \"1\", trained: true },\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"diplomacy\",\r\n\t\tactions: [\r\n\t\t\t{\r\n\t\t\t\tslug: \"bonMot\",\r\n\t\t\t\tcost: \"1\",\r\n\t\t\t\tcondition: (actor) => hasFeat(actor, BON_MOT_UUID),\r\n\t\t\t},\r\n\t\t\t{ slug: \"gather-information\" },\r\n\t\t\t{ slug: \"make-an-impression\" },\r\n\t\t\t{ slug: \"request\", cost: \"1\" },\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"intimidation\",\r\n\t\tactions: [{ slug: \"coerce\" }, { slug: \"demoralize\", cost: \"1\" }],\r\n\t},\r\n\t{\r\n\t\tslug: \"medicine\",\r\n\t\tactions: [\r\n\t\t\t{\r\n\t\t\t\tslug: \"administer-first-aid\",\r\n\t\t\t\tcost: \"2\",\r\n\t\t\t\tvariants: [\"stabilize\", \"stop-bleeding\"],\r\n\t\t\t\trollOption: \"administer-first-aid\",\r\n\t\t\t},\r\n\t\t\t{ slug: \"treat-disease\", trained: true },\r\n\t\t\t{ slug: \"treat-poison\", cost: \"1\", trained: true },\r\n\t\t\t{ slug: \"treatWounds\", trained: true },\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"nature\",\r\n\t\tactions: [\r\n\t\t\t{ slug: \"command-an-animal\", cost: \"1\" }, //\r\n\t\t\t// 'recall-knowledge',\r\n\t\t\t\"identify-magic\",\r\n\t\t\t\"learn-a-spell\",\r\n\t\t\t{\r\n\t\t\t\tslug: \"treatWounds\",\r\n\t\t\t\ttrained: true,\r\n\t\t\t\tcondition: (actor) => hasFeat(actor, NATURAL_MEDICINE_UUID),\r\n\t\t\t},\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"occultism\",\r\n\t\tactions: [\r\n\t\t\t// 'recall-knowledge', //\r\n\t\t\t\"decipher-writing\",\r\n\t\t\t\"identify-magic\",\r\n\t\t\t\"learn-a-spell\",\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"performance\",\r\n\t\tactions: [\r\n\t\t\t{\r\n\t\t\t\tslug: \"perform\",\r\n\t\t\t\tcost: \"1\",\r\n\t\t\t\tvariants: [\r\n\t\t\t\t\t\"acting\",\r\n\t\t\t\t\t\"comedy\",\r\n\t\t\t\t\t\"dance\",\r\n\t\t\t\t\t\"keyboards\",\r\n\t\t\t\t\t\"oratory\",\r\n\t\t\t\t\t\"percussion\",\r\n\t\t\t\t\t\"singing\",\r\n\t\t\t\t\t\"strings\",\r\n\t\t\t\t\t\"winds\",\r\n\t\t\t\t],\r\n\t\t\t},\r\n\t\t\t{ slug: \"staging-performance\", trained: true },\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"religion\",\r\n\t\tactions: [\r\n\t\t\t// 'recall-knowledge', //\r\n\t\t\t\"decipher-writing\",\r\n\t\t\t\"identify-magic\",\r\n\t\t\t\"learn-a-spell\",\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"society\",\r\n\t\tactions: [\r\n\t\t\t// 'recall-knowledge', //\r\n\t\t\t{ slug: \"subsist\" },\r\n\t\t\t{ slug: \"create-forgery\", trained: true },\r\n\t\t\t\"decipher-writing\",\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"stealth\",\r\n\t\tactions: [\r\n\t\t\t{ slug: \"conceal-an-object\", cost: \"1\" },\r\n\t\t\t{ slug: \"hide\", cost: \"1\" },\r\n\t\t\t{ slug: \"sneak\", cost: \"1\" },\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"survival\",\r\n\t\tactions: [\r\n\t\t\t{ slug: \"sense-direction\" },\r\n\t\t\t{ slug: \"subsist\" },\r\n\t\t\t{ slug: \"cover-tracks\", trained: true },\r\n\t\t\t{ slug: \"track\", trained: true },\r\n\t\t],\r\n\t},\r\n\t{\r\n\t\tslug: \"thievery\",\r\n\t\tactions: [\r\n\t\t\t{ slug: \"palm-an-object\", cost: \"1\" },\r\n\t\t\t{ slug: \"steal\", cost: \"1\" },\r\n\t\t\t{ slug: \"disable-device\", cost: \"2\", trained: true },\r\n\t\t\t{ slug: \"pick-a-lock\", cost: \"2\", trained: true },\r\n\t\t],\r\n\t},\r\n];\r\n\r\nfor (const skill of SKILLS) {\r\n\tskill.actions = skill.actions.map((action) =>\r\n\t\ttypeof action === \"string\" ? DUPLICATE_SKILLS[action] : action,\r\n\t);\r\n\r\n\tconst { slug, actions } = skill;\r\n\tfor (const action of actions) {\r\n\t\tconst unslugged = action.slug\r\n\t\t\t.replace(/-(.)/g, (_, c) => c.toUpperCase())\r\n\t\t\t.capitalize();\r\n\r\n\t\taction.skillSlug = slug;\r\n\t\taction.uuid = ACTIONS_UUIDS[action.slug];\r\n\t\taction.label = LABELS[action.slug] ?? `PF2E.Actions.${unslugged}.Title`;\r\n\r\n\t\tif (action.variants) {\r\n\t\t\taction.variants = action.variants.map((variant) => ({\r\n\t\t\t\tslug: variant,\r\n\t\t\t\tlabel: `${MODULE_ID}.skills.actions.${variant}`,\r\n\t\t\t}));\r\n\t\t} else if (action.map) {\r\n\t\t\tconst agile = !!action.agile;\r\n\r\n\t\t\taction.variants = [\r\n\t\t\t\t{ label: \"PF2E.Roll.Normal\" },\r\n\t\t\t\t{\r\n\t\t\t\t\tlabel: \"PF2E.MAPAbbreviationLabel\",\r\n\t\t\t\t\tmap: 1,\r\n\t\t\t\t\tagile,\r\n\t\t\t\t\tmapValue: agile ? -4 : -5,\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\tlabel: \"PF2E.MAPAbbreviationLabel\",\r\n\t\t\t\t\tmap: 2,\r\n\t\t\t\t\tagile,\r\n\t\t\t\t\tmapValue: agile ? -8 : -10,\r\n\t\t\t\t},\r\n\t\t\t];\r\n\t\t}\r\n\r\n\t\tfor (const { modifiers } of action.modifiers ?? []) {\r\n\t\t\tfor (const modifier of modifiers) {\r\n\t\t\t\tmodifier.label = `${MODULE_ID}.skills.modifiers.${modifier.slug}`;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport const SKILLS_SLUGS = SKILLS.map((skill) => skill.slug);\r\n\r\nconst SKILLS_MAP = SKILLS.reduce((skills, { slug, actions }) => {\r\n\tskills[slug] = {\r\n\t\tslug,\r\n\t\tactions: actions.reduce((actions, action) => {\r\n\t\t\tactions[action.slug] = action;\r\n\t\t\treturn actions;\r\n\t\t}, {}),\r\n\t};\r\n\treturn skills;\r\n}, {});\r\n\r\nexport const skillActionsUUIDS = new Set(\r\n\tObject.values(ACTIONS_UUIDS).filter(Boolean),\r\n);\r\n\r\nexport function getSkillLabel(slug) {\r\n\treturn game.i18n.localize(\r\n\t\tslug === \"perception\"\r\n\t\t\t? \"PF2E.PerceptionLabel\"\r\n\t\t\t: CONFIG.PF2E.skillList[slug],\r\n\t);\r\n}\r\n\r\nexport async function getSkillsData({ actor, filter }) {\r\n\tconst skills = [];\r\n\tconst isCharacter = actor.isOfType(\"character\");\r\n\r\n\tconst noUntrained =\r\n\t\tisCharacter &&\r\n\t\tgetSetting(\"untrained\") &&\r\n\t\t!actor.itemTypes.feat.some(\r\n\t\t\t(feat) => feat.sourceId === UNTRAINED_IMPROVISATION,\r\n\t\t);\r\n\r\n\tfor (let i = 0; i < SKILLS.length; i++) {\r\n\t\tconst { slug, actions } = SKILLS[i];\r\n\t\tconst { label, rank, mod } = actor.getStatistic(slug);\r\n\r\n\t\tconst name = game.i18n.localize(label);\r\n\t\tconst actionsList = actions\r\n\t\t\t.filter(\r\n\t\t\t\t({ condition, trained }) =>\r\n\t\t\t\t\t(!noUntrained ||\r\n\t\t\t\t\t\t!isCharacter ||\r\n\t\t\t\t\t\t!trained ||\r\n\t\t\t\t\t\tactor.skills[slug].rank >= 1) &&\r\n\t\t\t\t\t(!condition || condition(actor)),\r\n\t\t\t)\r\n\t\t\t.map((action) => ({\r\n\t\t\t\t...action,\r\n\t\t\t\tname: game.i18n.localize(action.label),\r\n\t\t\t\tvariants: action.variants?.map((variant) => ({\r\n\t\t\t\t\t...variant,\r\n\t\t\t\t\tname: game.i18n.localize(variant.label),\r\n\t\t\t\t})),\r\n\t\t\t}));\r\n\r\n\t\tconst passedFilter = filterIn(name, filter);\r\n\t\tlet filteredActions = actionsList;\r\n\t\tif (!passedFilter) {\r\n\t\t\tfilteredActions = actionsList.filter(\r\n\t\t\t\t({ name, variants }) =>\r\n\t\t\t\t\tfilterIn(name, filter) ||\r\n\t\t\t\t\tvariants?.some((variant) => filterIn(variant.name, filter)),\r\n\t\t\t);\r\n\t\t\tif (!filteredActions.length) continue;\r\n\t\t}\r\n\r\n\t\tskills[i] = {\r\n\t\t\tslug,\r\n\t\t\tname,\r\n\t\t\trank,\r\n\t\t\tmodifier: modifier(mod),\r\n\t\t\tactions: passedFilter ? actionsList : filteredActions,\r\n\t\t};\r\n\t}\r\n\r\n\tskills.sort((a, b) =>\r\n\t\ta.slug === \"perception\"\r\n\t\t\t? -1\r\n\t\t\t: b.slug === \"perception\"\r\n\t\t\t  ? 1\r\n\t\t\t  : localeCompare(a.name, b.name),\r\n\t);\r\n\r\n\tconst lores = Object.values(actor.skills)\r\n\t\t.filter(({ lore, label }) => lore && filterIn(label, filter))\r\n\t\t.map(({ label, rank, mod, slug }) => ({\r\n\t\t\tslug,\r\n\t\t\tlabel,\r\n\t\t\trank,\r\n\t\t\tmodifier: modifier(mod),\r\n\t\t}));\r\n\r\n\tconst loresModifierWidth = lores.reduce(\r\n\t\t(width, lore) =>\r\n\t\t\tlore.modifier.length > width ? lore.modifier.length : width,\r\n\t\t2,\r\n\t);\r\n\r\n\treturn {\r\n\t\tcontentData: {\r\n\t\t\tfollow: localize(\r\n\t\t\t\t`skills.actions.${isFollowingAnExpert(actor) ? \"following\" : \"follow\"}`,\r\n\t\t\t),\r\n\t\t\tskills,\r\n\t\t\tlores,\r\n\t\t\tloresModifierWidth,\r\n\t\t},\r\n\t\tdoubled: getSetting(\"skills-columns\"),\r\n\t};\r\n}\r\n\r\nexport function addSkillsListeners({ el, actor, token, hud }) {\r\n\tel.find(\"[data-action=action-description]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst action = $(event.currentTarget).closest(\".action\");\r\n\t\tshowItemSummary(action, actor, action.find(\".name\").children().html());\r\n\t});\r\n\r\n\t// IS OWNER\r\n\tif (!actor.isOwner) return;\r\n\r\n\tel.find(\"[data-action=follow-the-expert]\").on(\"click\", async (event) => {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst following = isFollowingAnExpert(actor);\r\n\t\tif (following) return await following.delete();\r\n\r\n\t\tconst source = (await fromUuid(FOLLOW_THE_EXPERT_UUID)).toObject();\r\n\t\tsetProperty(source, \"flags.core.sourceId\", FOLLOW_THE_EXPERT_UUID);\r\n\t\tawait actor.createEmbeddedDocuments(\"Item\", [source]);\r\n\t});\r\n\r\n\tel.find(\"[data-action=roll-skill]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst { slug } = event.currentTarget.dataset;\r\n\t\tactor.getStatistic(slug)?.roll({ event });\r\n\t\tif (getSetting(\"skill-close\")) hud.close();\r\n\t});\r\n\r\n\tel.find(\"[data-action=roll-action]\").on(\r\n\t\t\"click contextmenu\",\r\n\t\tasync (event) => {\r\n\t\t\tevent.preventDefault();\r\n\r\n\t\t\tconst target = $(event.currentTarget);\r\n\t\t\tconst { skillSlug, slug, actionName } = target.closest(\".action\").data();\r\n\t\t\tconst { variant, map, agile } = target.data();\r\n\r\n\t\t\tconst variants =\r\n\t\t\t\tevent.type === \"contextmenu\"\r\n\t\t\t\t\t? await variantsDialog(actionName, { skill: skillSlug, agile })\r\n\t\t\t\t\t: undefined;\r\n\r\n\t\t\tif (variants !== null) {\r\n\t\t\t\trollAction({\r\n\t\t\t\t\tevent,\r\n\t\t\t\t\tactor,\r\n\t\t\t\t\ttoken,\r\n\t\t\t\t\tskillSlug,\r\n\t\t\t\t\tslug,\r\n\t\t\t\t\tvariant,\r\n\t\t\t\t\tmap,\r\n\t\t\t\t\tskill: variants?.skill,\r\n\t\t\t\t\tagile: variants?.agile ?? agile,\r\n\t\t\t\t});\r\n\t\t\t\tif (getSetting(\"skill-close\")) hud.close();\r\n\t\t\t}\r\n\t\t},\r\n\t);\r\n\r\n\tel.find(\"[data-action=action-chat]\").on(\"click\", async (event) => {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst { uuid } = event.currentTarget.closest(\".action\").dataset;\r\n\t\tconst item = await fromUuid(uuid);\r\n\t\tif (!item) return;\r\n\r\n\t\tunownedItemToMessage(event, item, actor, { create: true });\r\n\t\tif (getSetting(\"chat-close\")) hud.close();\r\n\t});\r\n}\r\n\r\nfunction isFollowingAnExpert(actor) {\r\n\treturn actor.itemTypes.effect.find(\r\n\t\t(effect) => effect.sourceId === FOLLOW_THE_EXPERT_UUID,\r\n\t);\r\n}\r\n\r\nexport async function variantsDialog(action, { dc, agile, skill } = {}) {\r\n\tconst skills = SKILLS_SLUGS.map((slug) => ({\r\n\t\tslug,\r\n\t\tlabel: getSkillLabel(slug),\r\n\t}));\r\n\r\n\tconst content = await renderTemplate(templatePath(\"dialogs/variant\"), {\r\n\t\ti18n: (str) => localize(`skills.variant.${str}`),\r\n\t\tdc,\r\n\t\tskill,\r\n\t\tagile,\r\n\t\tskills,\r\n\t});\r\n\r\n\treturn Dialog.prompt({\r\n\t\ttitle: action,\r\n\t\tlabel: localize(\"skills.variant.button\"),\r\n\t\tcallback: (html) => ({\r\n\t\t\tskill: html.find(\"select\").val(),\r\n\t\t\tdc: Number(html.find(\"[name=dc]\").val()),\r\n\t\t\tagile: html.find(\"[name=agile]\").is(\":checked\"),\r\n\t\t}),\r\n\t\trejectClose: false,\r\n\t\tcontent,\r\n\t\toptions: { width: 280 },\r\n\t});\r\n}\r\n\r\nexport function getMapModifier(map, agile) {\r\n\tconst modifier = map === 1 ? (agile ? -4 : -5) : agile ? -8 : -10;\r\n\treturn new game.pf2e.Modifier({\r\n\t\tlabel: \"PF2E.MultipleAttackPenalty\",\r\n\t\tmodifier,\r\n\t});\r\n}\r\n\r\nfunction rollAction({\r\n\tevent,\r\n\tactor,\r\n\tskillSlug,\r\n\tslug,\r\n\tvariant,\r\n\tmap,\r\n\tagile,\r\n\tskill,\r\n\ttoken,\r\n}) {\r\n\tconst action = SKILLS_MAP[skillSlug].actions[slug];\r\n\tconst type =\r\n\t\taction.type === 3\r\n\t\t\t? 3\r\n\t\t\t: game.pf2e.actions.has(slug)\r\n\t\t\t  ? 2\r\n\t\t\t  : slug in game.pf2e.actions\r\n\t\t\t\t  ? 1\r\n\t\t\t\t  : undefined;\r\n\r\n\tskill ??= action.noSkill ? undefined : skillSlug;\r\n\r\n\tconst rollOptions = action.rollOption\r\n\t\t? [`action:${action.rollOption}`]\r\n\t\t: undefined;\r\n\tif (rollOptions && variant)\r\n\t\trollOptions.push(`action:${action.rollOption}:${variant}`);\r\n\r\n\tconst options = {\r\n\t\tevent,\r\n\t\tactors: [actor],\r\n\t\ttokens: [token],\r\n\t\tvariant,\r\n\t\trollOptions,\r\n\t\trollMode: action.secret ? \"blindroll\" : \"roll\",\r\n\t};\r\n\r\n\toptions.modifiers = [];\r\n\r\n\tif (action.modifiers) {\r\n\t\tfor (const { condition, modifiers } of action.modifiers) {\r\n\t\t\tif (condition && !condition(actor)) continue;\r\n\t\t\tfor (const modifier of modifiers) {\r\n\t\t\t\toptions.modifiers.push(new game.pf2e.Modifier(modifier));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (map) {\r\n\t\tconst modifier = getMapModifier(map, agile);\r\n\t\toptions.modifiers.push(modifier);\r\n\t}\r\n\r\n\tif (action.custom) {\r\n\t\taction.custom(actor, options);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (!type) {\r\n\t\tactor.getStatistic(skill)?.roll(options);\r\n\t\treturn;\r\n\t}\r\n\r\n\t// old actions\r\n\tif (type === 1) {\r\n\t\toptions.skill = skill;\r\n\t\tgame.pf2e.actions[slug](options);\r\n\t}\r\n\t// new actions\r\n\telse if (type === 2) {\r\n\t\toptions.statistic = skill;\r\n\t\tgame.pf2e.actions.get(slug).use(options);\r\n\t}\r\n\t// exception for old actions that only accept one actor argument\r\n\telse if (type === 3) {\r\n\t\tgame.pf2e.actions[slug](actor);\r\n\t}\r\n}\r\n", "import { unownedItemToMessage } from \"module-api\";\r\nimport { rollRecallKnowledges } from \"../actions/recall-knowledge.js\";\r\nimport { getSetting, localize } from \"../module.js\";\r\nimport { showItemSummary } from \"../popup.js\";\r\nimport {\r\n\taddNameTooltipListeners,\r\n\tdeleteMacro,\r\n\tfilterIn,\r\n\tgetMacros,\r\n\tonDroppedMacro,\r\n} from \"../shared.js\";\r\nimport {\r\n\tSKILLS_SLUGS,\r\n\tgetMapModifier,\r\n\tgetSkillLabel,\r\n\tvariantsDialog,\r\n} from \"./skills.js\";\r\n\r\nexport const extrasUUIDS = {\r\n\taid: \"Compendium.pf2e.actionspf2e.Item.HCl3pzVefiv9ZKQW\",\r\n\tescape: \"Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9\",\r\n\t\"recall-knowledge\": \"Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo\",\r\n\t\"point-out\": \"Compendium.pf2e.actionspf2e.Item.sn2hIy1iIJX9Vpgj\",\r\n};\r\n\r\nexport async function getExtrasData({ actor, filter }) {\r\n\tconst initiative = actor.system.initiative;\r\n\r\n\treturn {\r\n\t\tcontentData: {\r\n\t\t\tnoMacro: localize(\"extras.no-macro\"),\r\n\t\t\tmacros: getMacros(actor)?.filter((macro) => filterIn(macro.name, filter)),\r\n\t\t\tinitiative: initiative && {\r\n\t\t\t\tselected: initiative.statistic,\r\n\t\t\t\tskills: SKILLS_SLUGS.map((slug) => ({\r\n\t\t\t\t\tslug,\r\n\t\t\t\t\tlabel: getSkillLabel(slug),\r\n\t\t\t\t})),\r\n\t\t\t},\r\n\t\t\thasDailies: game.modules.get(\"pf2e-dailies\")?.active,\r\n\t\t\thasPerception: game.modules.get(\"pf2e-perception\")?.active,\r\n\t\t\tuuids: extrasUUIDS,\r\n\t\t},\r\n\t};\r\n}\r\n\r\nexport function addExtrasListeners({ el, actor, token, hud }) {\r\n\tfunction action(action, callback, type = \"click\") {\r\n\t\tel.find(`[data-action=${action}]`).on(type, (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tcallback(event);\r\n\t\t});\r\n\t}\r\n\r\n\taction(\"action-description\", (event) => {\r\n\t\tconst action = $(event.currentTarget).closest(\".row\");\r\n\t\tshowItemSummary(action, actor);\r\n\t});\r\n\r\n\t// IS OWNER\r\n\tif (!actor.isOwner) return;\r\n\r\n\taddNameTooltipListeners(el.find(\".macro\"));\r\n\r\n\tasync function getMacro(event) {\r\n\t\tconst { uuid } = event.currentTarget.closest(\".macro\").dataset;\r\n\t\treturn fromUuid(uuid);\r\n\t}\r\n\r\n\taction(\"delete-macro\", (event) => deleteMacro(event, actor));\r\n\r\n\taction(\"edit-macro\", async (event) => {\r\n\t\tconst macro = await getMacro(event);\r\n\t\tmacro?.sheet.render(true);\r\n\t});\r\n\r\n\taction(\"use-macro\", async (event) => {\r\n\t\tconst macro = await getMacro(event);\r\n\t\tmacro?.execute({ actor, token });\r\n\t\tif (getSetting(\"macro-close\")) hud.close();\r\n\t});\r\n\r\n\tel.on(\"drop\", (event) => onDroppedMacro(event, actor));\r\n\r\n\taction(\"action-chat\", async (event) => {\r\n\t\tconst { uuid } = event.currentTarget.closest(\".row\").dataset;\r\n\t\tconst item = await fromUuid(uuid);\r\n\t\tif (!item) return;\r\n\r\n\t\tunownedItemToMessage(event, item, actor, { create: true });\r\n\t\tif (getSetting(\"chat-close\")) hud.close();\r\n\t});\r\n\r\n\tel.find(\"input[name], select[name]\").on(\"change\", async (event) => {\r\n\t\tconst target = event.currentTarget;\r\n\t\tconst value =\r\n\t\t\ttarget.type === \"number\" ? target.valueAsNumber : target.value;\r\n\t\tawait actor.update({ [target.name]: value });\r\n\t});\r\n\r\n\taction(\"roll-initiative\", async (event) => {\r\n\t\tawait actor.initiative.roll({ event });\r\n\t\tif (getSetting(\"skill-close\")) hud.close();\r\n\t});\r\n\r\n\taction(\"prepare-dailies\", (event) => {\r\n\t\tconst dailies = game.modules.get(\"pf2e-dailies\");\r\n\t\tif (dailies?.active) dailies.api.openDailiesInterface(actor);\r\n\t});\r\n\r\n\taction(\"rest-for-the-night\", (event) => {\r\n\t\tgame.pf2e.actions.restForTheNight({ actors: [actor], tokens: [token] });\r\n\t});\r\n\r\n\taction(\"roll-recall-knowledge\", (event) => {\r\n\t\trollRecallKnowledges(actor);\r\n\t\tif (getSetting(\"skill-close\")) hud.close();\r\n\t});\r\n\r\n\taction(\r\n\t\t\"roll-aid\",\r\n\t\tasync (event) => {\r\n\t\t\tconst variants = await variantsDialog(\r\n\t\t\t\tgame.i18n.localize(\"PF2E.Actions.Aid.Title\"),\r\n\t\t\t\t{ dc: 15 },\r\n\t\t\t);\r\n\t\t\tconst note = {\r\n\t\t\t\ttext: \"@UUID[Compendium.pf2e.other-effects.Item.AHMUpMbaVkZ5A1KX]\",\r\n\t\t\t};\r\n\t\t\tif (variants !== null) {\r\n\t\t\t\tgame.pf2e.actions.get(\"aid\").use({\r\n\t\t\t\t\tevent,\r\n\t\t\t\t\tactors: [actor],\r\n\t\t\t\t\ttokens: [token],\r\n\t\t\t\t\tstatistic: variants?.skill,\r\n\t\t\t\t\tdifficultyClass: { value: variants?.dc },\r\n\t\t\t\t\tnotes: [note],\r\n\t\t\t\t});\r\n\t\t\t\tif (getSetting(\"skill-close\")) hud.close();\r\n\t\t\t}\r\n\t\t},\r\n\t\t\"click contextmenu\",\r\n\t);\r\n\r\n\taction(\"roll-point-out\", (event) => {\r\n\t\tgame.pf2e.actions\r\n\t\t\t.get(\"point-out\")\r\n\t\t\t.use({ event, actors: [actor], tokens: [token] });\r\n\t\tif (getSetting(\"skill-close\")) hud.close();\r\n\t});\r\n\r\n\taction(\r\n\t\t\"roll-escape\",\r\n\t\tasync (event) => {\r\n\t\t\tconst map = $(event.currentTarget).data().map;\r\n\t\t\tconst variants =\r\n\t\t\t\tevent.type === \"contextmenu\"\r\n\t\t\t\t\t? await variantsDialog(\r\n\t\t\t\t\t\t\tgame.i18n.localize(\"PF2E.Actions.Escape.Title\"),\r\n\t\t\t\t\t\t\t{ agile: map ? false : undefined },\r\n\t\t\t\t\t  )\r\n\t\t\t\t\t: undefined;\r\n\t\t\tif (variants === null) return;\r\n\r\n\t\t\tconst modifiers = [];\r\n\r\n\t\t\tif (map) {\r\n\t\t\t\tconst agile = variants?.agile;\r\n\t\t\t\tconst modifier = getMapModifier(map, agile);\r\n\t\t\t\tmodifiers.push(modifier);\r\n\t\t\t}\r\n\r\n\t\t\tgame.pf2e.actions.get(\"escape\").use({\r\n\t\t\t\tevent,\r\n\t\t\t\tactors: [actor],\r\n\t\t\t\ttokens: [token],\r\n\t\t\t\tstatistic: variants?.skill,\r\n\t\t\t\tmodifiers,\r\n\t\t\t});\r\n\r\n\t\t\tif (getSetting(\"skill-close\")) hud.close();\r\n\t\t},\r\n\t\t\"click contextmenu\",\r\n\t);\r\n}\r\n", "import {\r\n\tcreateSelfEffectMessage,\r\n\teventToRollMode,\r\n\tgetActionIcon,\r\n\tobjectHasKey,\r\n} from \"module-api\";\r\nimport { enrichHTML, getSetting, localize, templatePath } from \"../module.js\";\r\nimport { popup, showItemSummary } from \"../popup.js\";\r\nimport {\r\n\taddNameTooltipListeners,\r\n\tfilterIn,\r\n\tgetItemFromEvent,\r\n\tlocaleCompare,\r\n} from \"../shared.js\";\r\nimport { extrasUUIDS } from \"./extras.js\";\r\nimport { skillActionsUUIDS } from \"./skills.js\";\r\n\r\nconst SECTIONS_TYPES = {\r\n\taction: {\r\n\t\torder: 0,\r\n\t\tlabel: \"PF2E.ActionsActionsHeader\",\r\n\t\tactionLabel: \"PF2E.ActionTypeAction\",\r\n\t},\r\n\treaction: {\r\n\t\torder: 1,\r\n\t\tlabel: \"PF2E.ActionsReactionsHeader\",\r\n\t\tactionLabel: \"PF2E.ActionTypeReaction\",\r\n\t},\r\n\tfree: {\r\n\t\torder: 2,\r\n\t\tlabel: \"PF2E.ActionsFreeActionsHeader\",\r\n\t\tactionLabel: \"PF2E.ActionTypeFree\",\r\n\t},\r\n\tpassive: {\r\n\t\torder: 3,\r\n\t\tlabel: \"PF2E.NPC.PassivesLabel\",\r\n\t\tactionLabel: \"PF2E.ActionTypePassive\",\r\n\t},\r\n\texploration: {\r\n\t\torder: 3,\r\n\t\tlabel: \"PF2E.TravelSpeed.ExplorationActivity\",\r\n\t\tactionLabel: \"PF2E.TabActionsExplorationLabel\",\r\n\t},\r\n};\r\n\r\nexport async function getActionsData({ hud, actor, filter }) {\r\n\tconst isCharacter = actor.isOfType(\"character\");\r\n\tconst sorting = getSetting(\"actions\");\r\n\r\n\tconst stances = (await getStancesModuleApi()?.getStances(actor))?.sort(\r\n\t\t(a, b) => localeCompare(a.name, b.name),\r\n\t);\r\n\r\n\tconst heroActions = isCharacter\r\n\t\t? await getHeroActionsApi()?.getHeroActions(actor)\r\n\t\t: undefined;\r\n\tconst heroDiff = heroActions\r\n\t\t? actor.heroPoints.value - heroActions.length\r\n\t\t: undefined;\r\n\r\n\tconst isOwner = actor.isOwner;\r\n\tconst rollData = actor.getRollData();\r\n\r\n\tconst strikes = actor.system.actions\r\n\t\t? await Promise.all(\r\n\t\t\t\tactor.system.actions.map(async (strike, index) => ({\r\n\t\t\t\t\t...strike,\r\n\t\t\t\t\tindex,\r\n\t\t\t\t\tvisible: !isCharacter || strike.visible,\r\n\t\t\t\t\tdamageFormula: await strike.damage?.({ getFormula: true }),\r\n\t\t\t\t\tcriticalFormula: await strike.critical?.({ getFormula: true }),\r\n\t\t\t\t\tdescription: strike.description\r\n\t\t\t\t\t\t? await enrichHTML(strike.description, actor, { rollData, isOwner })\r\n\t\t\t\t\t\t: undefined,\r\n\t\t\t\t\taltUsages:\r\n\t\t\t\t\t\tstrike.altUsages &&\r\n\t\t\t\t\t\t(await Promise.all(\r\n\t\t\t\t\t\t\tstrike.altUsages.map(async (altUsage) => ({\r\n\t\t\t\t\t\t\t\t...altUsage,\r\n\t\t\t\t\t\t\t\tusage: altUsage.item.isThrown ? \"thrown\" : \"melee\",\r\n\t\t\t\t\t\t\t\tdamageFormula: await altUsage.damage?.({ getFormula: true }),\r\n\t\t\t\t\t\t\t\tcriticalFormula: await altUsage.critical?.({\r\n\t\t\t\t\t\t\t\t\tgetFormula: true,\r\n\t\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t\t\t})),\r\n\t\t\t\t\t\t)),\r\n\t\t\t\t})),\r\n\t\t  )\r\n\t\t: undefined;\r\n\r\n\tconst blast = isCharacter ? new game.pf2e.ElementalBlast(actor) : undefined;\r\n\tconst blasts = blast\r\n\t\t? (\r\n\t\t\t\tawait Promise.all(\r\n\t\t\t\t\tblast.configs.map(async (config) => {\r\n\t\t\t\t\t\tconst damageType =\r\n\t\t\t\t\t\t\tconfig.damageTypes.find((damage) => damage.selected)?.value ??\r\n\t\t\t\t\t\t\t\"untyped\";\r\n\r\n\t\t\t\t\t\tconst formulaFor = (outcome, melee = true) => {\r\n\t\t\t\t\t\t\treturn blast.damage({\r\n\t\t\t\t\t\t\t\telement: config.element,\r\n\t\t\t\t\t\t\t\tdamageType,\r\n\t\t\t\t\t\t\t\tmelee,\r\n\t\t\t\t\t\t\t\toutcome,\r\n\t\t\t\t\t\t\t\tgetFormula: true,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\t...config,\r\n\t\t\t\t\t\t\tdamageType,\r\n\t\t\t\t\t\t\tformula: {\r\n\t\t\t\t\t\t\t\tmelee: {\r\n\t\t\t\t\t\t\t\t\tdamage: await formulaFor(\"success\"),\r\n\t\t\t\t\t\t\t\t\tcritical: await formulaFor(\"criticalSuccess\"),\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\tranged: {\r\n\t\t\t\t\t\t\t\t\tdamage: await formulaFor(\"success\", false),\r\n\t\t\t\t\t\t\t\t\tcritical: await formulaFor(\"criticalSuccess\", false),\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t}),\r\n\t\t\t\t)\r\n\t\t  ).sort((a, b) => localeCompare(a.label, b.label))\r\n\t\t: undefined;\r\n\r\n\tlet sections = {};\r\n\r\n\tconst actions = isCharacter\r\n\t\t? getCharacterActions(actor, stances)\r\n\t\t: getNpcActions(actor);\r\n\tfor (const action of actions) {\r\n\t\tif (!filterIn(action.name, filter)) continue;\r\n\r\n\t\tif (sorting !== \"split\") {\r\n\t\t\tsections.action ??= [];\r\n\t\t\tsections.action.push(action);\r\n\t\t} else {\r\n\t\t\tsections[action.type] ??= [];\r\n\t\t\tsections[action.type].push(action);\r\n\t\t}\r\n\t}\r\n\r\n\tsections = Object.entries(sections).map(([type, actions]) => {\r\n\t\tfor (const action of actions) {\r\n\t\t\taction.img = getActionIcon(action.cost);\r\n\t\t\taction.typeLabel = SECTIONS_TYPES[action.type].actionLabel;\r\n\t\t}\r\n\r\n\t\tif (sorting !== \"type\") {\r\n\t\t\tactions.sort((a, b) => localeCompare(a.name, b.name));\r\n\t\t} else {\r\n\t\t\tactions.sort((a, b) => {\r\n\t\t\t\tconst orderA = SECTIONS_TYPES[a.type].order;\r\n\t\t\t\tconst orderB = SECTIONS_TYPES[b.type].order;\r\n\t\t\t\treturn orderA === orderB\r\n\t\t\t\t\t? localeCompare(a.name, b.name)\r\n\t\t\t\t\t: orderA - orderB;\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\treturn { type, actions, label: SECTIONS_TYPES[type].label };\r\n\t});\r\n\r\n\tif (sorting === \"split\")\r\n\t\tsections.sort(\r\n\t\t\t(a, b) => SECTIONS_TYPES[a.type].order - SECTIONS_TYPES[b.type].order,\r\n\t\t);\r\n\r\n\tif (\r\n\t\tstances?.length ||\r\n\t\tstrikes?.length ||\r\n\t\tblasts?.length ||\r\n\t\tsections.length ||\r\n\t\theroActions?.length\r\n\t) {\r\n\t\tconst nb =\r\n\t\t\tNumber((stances?.length ?? 0) > 0) +\r\n\t\t\tNumber((strikes?.length ?? 0) > 0) +\r\n\t\t\tNumber((blasts?.length ?? 0) > 0) +\r\n\t\t\tsections.length +\r\n\t\t\tNumber((heroActions?.length ?? 0) > 0);\r\n\r\n\t\treturn {\r\n\t\t\tcontentData: {\r\n\t\t\t\tstances,\r\n\t\t\t\tstrikes,\r\n\t\t\t\tblasts,\r\n\t\t\t\tsections,\r\n\t\t\t\theroActions: heroActions && {\r\n\t\t\t\t\tactions: heroActions,\r\n\t\t\t\t\tdraw: Math.max(heroDiff, 0),\r\n\t\t\t\t\tdiscard: Math.abs(Math.min(heroDiff, 0)),\r\n\t\t\t\t\tcanTrade: heroActions.length && canTradeHeroActions(),\r\n\t\t\t\t},\r\n\t\t\t\ti18n: (str) => localize(`actions.${str}`),\r\n\t\t\t\tvariantLabel: (label) => label.replace(/.+\\((.+)\\)/, \"$1\"),\r\n\t\t\t\tdamageTypes: CONFIG.PF2E.damageTypes,\r\n\t\t\t},\r\n\t\t\tdoubled: nb > 1 && getSetting(\"actions-columns\"),\r\n\t\t};\r\n\t}\r\n}\r\n\r\nexport function addActionsListeners({ el, actor, hud }) {\r\n\taddNameTooltipListeners(el.find(\".toggle\"));\r\n\taddNameTooltipListeners(el.find(\".strike\"));\r\n\taddNameTooltipListeners(el.find(\".action\"));\r\n\r\n\tfunction action(action, callback, type = \"click\") {\r\n\t\tconst actions = typeof action === \"string\" ? [action] : action;\r\n\t\tconst selector = actions.map((x) => `[data-action=${x}]`).join(\", \");\r\n\t\treturn el.find(selector).on(type, (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tcallback(event);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction getStrike(event) {\r\n\t\tconst strikeEl = event.currentTarget.closest(\".strike\");\r\n\t\tconst strike = actor.system.actions[strikeEl.dataset.index];\r\n\t\tif (!strike) return null;\r\n\r\n\t\tconst { altUsage } = event.currentTarget.dataset;\r\n\t\treturn [\"melee\", \"thrown\"].includes(altUsage)\r\n\t\t\t? strike.altUsages?.find((s) =>\r\n\t\t\t\t\taltUsage === \"thrown\" ? s.item.isThrown : s.item.isMelee,\r\n\t\t\t  ) ?? null\r\n\t\t\t: strike;\r\n\t}\r\n\r\n\tfunction getUuid(event) {\r\n\t\treturn $(event.currentTarget).closest(\".action\").data().uuid;\r\n\t}\r\n\r\n\taction(\"action-description\", async (event) => {\r\n\t\tconst action = $(event.currentTarget).closest(\".action\");\r\n\t\tshowItemSummary(action, actor);\r\n\t});\r\n\r\n\taction(\"hero-action-description\", async (event) => {\r\n\t\tconst uuid = getUuid(event);\r\n\t\tconst { description, name } =\r\n\t\t\t(await getHeroActionsApi()?.getHeroActionDetails(uuid)) ?? {};\r\n\t\tif (description) popup(name, description, actor);\r\n\t});\r\n\r\n\taction(\"strike-description\", async (event) => {\r\n\t\tconst strike = getStrike(event);\r\n\t\tif (!strike) return;\r\n\r\n\t\tconst description = document.createElement(\"div\");\r\n\t\tdescription.classList.add(\"popup-description\");\r\n\t\t// this one is a copy of the system template, there is nothing to generate it\r\n\t\tdescription.innerHTML = await renderTemplate(\r\n\t\t\ttemplatePath(\"strike-description\"),\r\n\t\t\tstrike,\r\n\t\t);\r\n\r\n\t\tpopup(strike.label, description, actor);\r\n\t});\r\n\r\n\taction(\"blast-description\", async (event) => {\r\n\t\tconst blast = event.currentTarget.closest(\".blast\");\r\n\t\tshowItemSummary($(blast), actor);\r\n\t});\r\n\r\n\taction(\"trait-description\", (event) => {\r\n\t\tconst strike = getStrike(event);\r\n\t\tif (!strike) return;\r\n\r\n\t\tconst { index } = event.currentTarget.dataset;\r\n\t\tconst trait = strike.traits[index];\r\n\t\tif (!trait) return;\r\n\r\n\t\tconst description = game.i18n.localize(trait.description);\r\n\t\tif (description) popup(game.i18n.localize(trait.label), description, actor);\r\n\t});\r\n\r\n\taction(\"stance-description\", (event) => {\r\n\t\tconst stance = $(event.currentTarget).closest(\".action\");\r\n\t\tshowItemSummary(stance, actor, stance.data().itemName);\r\n\t});\r\n\r\n\t// IS OWNER\r\n\tif (!actor.isOwner) return;\r\n\r\n\taction(\"use-action\", (event) => {\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (item?.isOfType(\"action\", \"feat\")) {\r\n\t\t\tcreateSelfEffectMessage(item, eventToRollMode(event));\r\n\t\t\tif (getSetting(\"action-effect\")) applyActionEffect(actor, item);\r\n\t\t\tif (getSetting(\"action-close\")) hud.close();\r\n\t\t}\r\n\t});\r\n\r\n\taction(\"stance-chat\", (event) => {\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (!item) return;\r\n\r\n\t\titem.toMessage(event, { create: true });\r\n\t\tif (getSetting(\"chat-close\")) hud.close();\r\n\t});\r\n\r\n\taction(\"stance-toggle\", (event) => {\r\n\t\tconst { effectUuid } = event.currentTarget.closest(\".action\").dataset;\r\n\t\tgetStancesModuleApi()?.toggleStance(actor, effectUuid);\r\n\t});\r\n\r\n\taction(\"exploration-toggle\", (event) => {\r\n\t\tconst actionId = event.currentTarget.closest(\".action\").dataset.itemId;\r\n\r\n\t\tconst exploration = actor.system.exploration.filter((id) =>\r\n\t\t\tactor.items.has(id),\r\n\t\t);\r\n\t\tif (!exploration.findSplice((id) => id === actionId)) {\r\n\t\t\texploration.push(actionId);\r\n\t\t}\r\n\r\n\t\tactor.update({ \"system.exploration\": exploration });\r\n\t});\r\n\r\n\taction(\"action-chat\", (event) => {\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (!item) return;\r\n\r\n\t\titem.toMessage(event, { create: true });\r\n\t\tif (getSetting(\"chat-close\")) hud.close();\r\n\t});\r\n\r\n\taction(\"hero-action-chat\", async (event) => {\r\n\t\tconst api = getHeroActionsApi();\r\n\t\tif (!api) return;\r\n\r\n\t\tapi.sendActionToChat(actor, getUuid(event));\r\n\t\tif (getSetting(\"chat-close\")) hud.close();\r\n\t});\r\n\r\n\taction(\"draw-hero-action\", async (event) => {\r\n\t\tawait getHeroActionsApi()?.drawHeroActions(actor);\r\n\t});\r\n\r\n\taction(\"use-hero-action\", async (event) => {\r\n\t\tconst api = getHeroActionsApi();\r\n\t\tif (!api) return;\r\n\r\n\t\tapi.useHeroAction(actor, getUuid(event));\r\n\t\tif (getSetting(\"action-close\")) hud.close();\r\n\t});\r\n\r\n\taction(\"discard-hero-action\", async (event) => {\r\n\t\tawait getHeroActionsApi()?.discardHeroActions(actor, getUuid(event));\r\n\t});\r\n\r\n\taction(\"trade-hero-action\", async (event) => {\r\n\t\tgetHeroActionsApi()?.tradeHeroAction(actor);\r\n\t});\r\n\r\n\taction(\"strike-attack\", (event) => {\r\n\t\tconst { index, altUsage } = event.currentTarget.dataset;\r\n\t\tconst strike = getStrike(event);\r\n\r\n\t\tstrike?.variants[index].roll({ event, altUsage });\r\n\t\tif (getSetting(\"attack-close\")) hud.close();\r\n\t});\r\n\r\n\taction([\"strike-damage\", \"strike-critical\"], (event) => {\r\n\t\tconst { action } = event.currentTarget.dataset;\r\n\t\tconst strike = getStrike(event);\r\n\r\n\t\tstrike?.[action === \"strike-damage\" ? \"damage\" : \"critical\"]({ event });\r\n\t\tif (getSetting(\"attack-close\")) hud.close();\r\n\t});\r\n\r\n\taction(\"strike-auxiliary\", (event) => {\r\n\t\tif (event.currentTarget !== event.target) return;\r\n\r\n\t\tconst strike = getStrike(event);\r\n\t\tif (!strike) return;\r\n\r\n\t\tconst { index } = event.currentTarget.dataset;\r\n\t\tconst modular = event.currentTarget.querySelector(\"select\")?.value ?? null;\r\n\r\n\t\tstrike.auxiliaryActions?.[index]?.execute({ selection: modular });\r\n\t});\r\n\r\n\taction(\"toggle-versatile\", async (event) => {\r\n\t\tconst weapon = getStrike(event)?.item;\r\n\t\tif (!weapon) return;\r\n\r\n\t\tconst target = event.currentTarget;\r\n\t\tconst { value } = target.dataset;\r\n\t\tconst baseType = weapon.system.damage.damageType ?? null;\r\n\t\tconst selection =\r\n\t\t\ttarget.classList.contains(\"selected\") || value === baseType\r\n\t\t\t\t? null\r\n\t\t\t\t: value;\r\n\t\tconst selectionIsValid =\r\n\t\t\tobjectHasKey(CONFIG.PF2E.damageTypes, selection) || selection === null;\r\n\t\tif (!selectionIsValid) return;\r\n\r\n\t\tawait weapon.system.traits.toggles.update({\r\n\t\t\ttrait: \"versatile\",\r\n\t\t\tselected: selection,\r\n\t\t});\r\n\t});\r\n\r\n\taction(\r\n\t\t\"strike-ammo\",\r\n\t\tasync (event) => {\r\n\t\t\tconst weapon = getStrike(event)?.item;\r\n\t\t\tif (!weapon) return;\r\n\r\n\t\t\tconst ammo = actor.items.get(event.currentTarget.value);\r\n\t\t\tawait weapon.update({ system: { selectedAmmoId: ammo?.id ?? null } });\r\n\t\t},\r\n\t\t\"change\",\r\n\t);\r\n\r\n\tif (!actor.isOfType(\"character\")) return;\r\n\r\n\tconst selectors = [\"roll-attack\", \"roll-damage\", \"set-damage-type\"]\r\n\t\t.map((s) => `[data-action=${s}]`)\r\n\t\t.join(\",\");\r\n\tel.find(\".blast\").each((_, blastEl) => {\r\n\t\tconst { element, damageType } = blastEl.dataset;\r\n\t\tconst blast = new game.pf2e.ElementalBlast(actor);\r\n\r\n\t\t$(blastEl)\r\n\t\t\t.find(selectors)\r\n\t\t\t.on(\"click\", async (event) => {\r\n\t\t\t\tevent.preventDefault();\r\n\r\n\t\t\t\tconst dataset = event.currentTarget.dataset;\r\n\t\t\t\tconst melee = dataset.melee === \"true\";\r\n\r\n\t\t\t\tswitch (dataset.action) {\r\n\t\t\t\t\tcase \"roll-attack\": {\r\n\t\t\t\t\t\tconst mapIncreases = Math.clamped(\r\n\t\t\t\t\t\t\tNumber(dataset.mapIncreases),\r\n\t\t\t\t\t\t\t0,\r\n\t\t\t\t\t\t\t2,\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tblast.attack({\r\n\t\t\t\t\t\t\tmapIncreases: Math.clamped(mapIncreases, 0, 2),\r\n\t\t\t\t\t\t\telement,\r\n\t\t\t\t\t\t\tdamageType,\r\n\t\t\t\t\t\t\tmelee,\r\n\t\t\t\t\t\t\tevent,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcase \"roll-damage\": {\r\n\t\t\t\t\t\tblast.damage({\r\n\t\t\t\t\t\t\telement,\r\n\t\t\t\t\t\t\tdamageType,\r\n\t\t\t\t\t\t\tmelee,\r\n\t\t\t\t\t\t\toutcome: dataset.outcome,\r\n\t\t\t\t\t\t\tevent,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcase \"set-damage-type\": {\r\n\t\t\t\t\t\tblast.setDamageType({ element, damageType: dataset.value });\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\t[\"roll-attack\", \"roll-damage\"].includes(dataset.action) &&\r\n\t\t\t\t\tgetSetting(\"attack-close\")\r\n\t\t\t\t)\r\n\t\t\t\t\thud.close();\r\n\t\t\t});\r\n\t});\r\n}\r\n\r\nfunction getToolBeltModule(setting) {\r\n\tconst module = game.modules.get(\"pf2e-toolbelt\");\r\n\treturn module?.active && game.settings.get(\"pf2e-toolbelt\", setting)\r\n\t\t? module\r\n\t\t: undefined;\r\n}\r\n\r\nfunction getToolBeltApi(setting) {\r\n\treturn getToolBeltModule(setting)?.api;\r\n}\r\n\r\nfunction getStancesModuleApi() {\r\n\tconst module = game.modules.get(\"pf2e-stances\");\r\n\treturn module?.active ? module.api : getToolBeltApi(\"stances\")?.stances;\r\n}\r\n\r\nfunction getHeroActionsApi() {\r\n\tconst module = game.modules.get(\"pf2e-hero-actions\");\r\n\treturn module?.active ? module.api : getToolBeltApi(\"hero\")?.heroActions;\r\n}\r\n\r\nfunction canTradeHeroActions() {\r\n\tif (game.modules.get(\"pf2e-hero-actions\")?.active)\r\n\t\treturn game.settings.get(\"pf2e-hero-actions\", \"trade\");\r\n\tif (getToolBeltModule(\"hero\"))\r\n\t\treturn game.settings.get(\"pf2e-toolbelt\", \"hero-trade\");\r\n}\r\n\r\nfunction getCharacterActions(actor, stances) {\r\n\tconst stancesUUIDS =\r\n\t\tgetStancesModuleApi()?.getActionsUUIDS?.() ??\r\n\t\t(stances?.some((stance) => stance.actionUUID)\r\n\t\t\t? new Set(stances.map(({ actionUUID }) => actionUUID))\r\n\t\t\t: undefined) ??\r\n\t\tnew Set();\r\n\r\n\tconst actionsUUIDS = new Set([\r\n\t\t...stancesUUIDS,\r\n\t\t...skillActionsUUIDS,\r\n\t\t...Object.values(extrasUUIDS),\r\n\t]);\r\n\tconst actions = actor.itemTypes.action;\r\n\tconst feats = actor.itemTypes.feat.filter((item) => item.actionCost);\r\n\tconst inParty = actor.parties.size > 0;\r\n\tconst explorations = actor.system.exploration;\r\n\r\n\treturn [...actions, ...feats]\r\n\t\t.map((action) => {\r\n\t\t\tconst sourceId = action.sourceId;\r\n\t\t\tconst actionId = action.id;\r\n\t\t\tconst actionCost = action.actionCost;\r\n\t\t\tconst traits = action.system.traits.value;\r\n\t\t\tconst isExploration = traits.includes(\"exploration\");\r\n\r\n\t\t\treturn {\r\n\t\t\t\tsourceId,\r\n\t\t\t\tid: actionId,\r\n\t\t\t\ttype: actionCost?.type ?? (isExploration ? \"exploration\" : \"free\"),\r\n\t\t\t\tcost: actionCost,\r\n\t\t\t\tname: action.name,\r\n\t\t\t\tisExploration,\r\n\t\t\t\tisDowntime: traits.includes(\"downtime\"),\r\n\t\t\t\tisActive: isExploration && explorations.includes(actionId),\r\n\t\t\t\thasEffect: !!action.system.selfEffect,\r\n\t\t\t};\r\n\t\t})\r\n\t\t.filter(\r\n\t\t\t(action) =>\r\n\t\t\t\t!action.isDowntime &&\r\n\t\t\t\t(inParty || !action.isExploration) &&\r\n\t\t\t\t(action.isExploration || !actionsUUIDS.has(action.sourceId)),\r\n\t\t);\r\n}\r\n\r\nfunction getNpcActions(actor) {\r\n\treturn actor.itemTypes.action.map((item) => {\r\n\t\tconst actionCost = item.actionCost;\r\n\t\tconst actionType = actionCost?.type ?? \"passive\";\r\n\t\tconst hasAura =\r\n\t\t\tactionType === \"passive\" &&\r\n\t\t\t(item.system.traits.value.includes(\"aura\") ||\r\n\t\t\t\t!!item.system.rules.find((r) => r.key === \"Aura\"));\r\n\r\n\t\treturn {\r\n\t\t\tid: item.id,\r\n\t\t\ttype: actionType,\r\n\t\t\tcost: actionCost,\r\n\t\t\tname: item.name,\r\n\t\t\thasDeathNote: item.system.deathNote,\r\n\t\t\thasAura,\r\n\t\t\thasEffect: !!item.system.selfEffect,\r\n\t\t};\r\n\t});\r\n}\r\n\r\nasync function applyActionEffect(actor, item) {\r\n\tconst uuid = item.system.selfEffect?.uuid;\r\n\tif (!uuid) return;\r\n\r\n\tconst source = (await fromUuid(uuid))?.toObject();\r\n\tif (!source) return;\r\n\r\n\tactor.createEmbeddedDocuments(\"Item\", [source]);\r\n}\r\n", "import { InlineRollLinks } from \"module-api\";\r\nimport { enrichHTML, getSetting, modifier } from \"../module.js\";\r\nimport { showItemSummary } from \"../popup.js\";\r\n\r\nexport async function getHazardData({ actor }) {\r\n\tconst { system } = actor;\r\n\tconst { details, traits, attributes } = system;\r\n\tconst { stealth } = attributes;\r\n\tconst { description, disable, routine, reset, isComplex } = details;\r\n\tconst rollData = actor.getRollData();\r\n\tconst isOwner = actor.isOwner;\r\n\r\n\tconst enrich = async (str) => {\r\n\t\treturn enrichHTML(str, actor, { isOwner, rollData });\r\n\t};\r\n\r\n\treturn {\r\n\t\tcontentData: {\r\n\t\t\tdescription: await enrich(description),\r\n\t\t\tdisable: await enrich(disable),\r\n\t\t\troutine: await enrich(routine),\r\n\t\t\treset: await enrich(reset),\r\n\t\t\tisComplex,\r\n\t\t\trarity: {\r\n\t\t\t\tvalue: traits.rarity,\r\n\t\t\t\tlabel: CONFIG.PF2E.rarityTraits[traits.rarity],\r\n\t\t\t},\r\n\t\t\ttraits: traits.value.map((trait) => CONFIG.PF2E.hazardTraits[trait]),\r\n\t\t\tstealth: modifier(stealth.value),\r\n\t\t},\r\n\t\tstyle: { \"--max-width\": `${getSetting(\"hazard-width\")}em` },\r\n\t};\r\n}\r\n\r\nexport function addHazardListeners({ el, actor }) {\r\n\tel.find(\"[data-action=action-description]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst action = $(event.currentTarget).closest(\".action\");\r\n\t\tshowItemSummary(action, actor);\r\n\t});\r\n\r\n\tInlineRollLinks.listen(el[0], actor);\r\n\r\n\t// IS OWNER\r\n\tif (!actor.isOwner) return;\r\n\r\n\tel.find(\"[data-action=roll-initiative\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tactor.initiative.roll({ event });\r\n\t});\r\n}\r\n", "import {\r\n\tIdentifyItemPopup,\r\n\tcreateTooltip,\r\n\tdetachSubitem,\r\n\tdismissTooltip,\r\n} from \"module-api\";\r\nimport { getFlag, getSetting, localize, setFlag } from \"../module.js\";\r\nimport { showItemSummary } from \"../popup.js\";\r\nimport {\r\n\taddNameTooltipListeners,\r\n\tfilterIn,\r\n\tgetItemFromEvent,\r\n\tlocaleCompare,\r\n} from \"../shared.js\";\r\n\r\nconst ITEMS_TYPES = {\r\n\tweaponAndShield: {\r\n\t\torder: 0,\r\n\t\tlabel: \"PF2E.Actor.Inventory.Section.WeaponsAndShields\",\r\n\t},\r\n\tarmor: { order: 1, label: \"TYPES.Item.armor\" },\r\n\tconsumable: { order: 2, label: \"PF2E.Item.Consumable.Plural\" },\r\n\tequipment: { order: 3, label: \"TYPES.Item.equipment\" },\r\n\ttreasure: { order: 4, label: \"TYPES.Item.treasure\" },\r\n\tbackpack: { order: 5, label: \"PF2E.Item.Container.Plural\" },\r\n};\r\n\r\nexport async function getItemsData({ actor, filter }) {\r\n\tconst { contents, coins, totalWealth, bulk, invested } = actor.inventory;\r\n\tconst isCreature = actor.isOfType(\"creature\");\r\n\tconst openedContainers =\r\n\t\tgetSetting(\"containers\") ||\r\n\t\t(getFlag(actor, `containers.${game.user.id}`) ?? []);\r\n\tconst containers = {};\r\n\tlet categories = {};\r\n\r\n\tfor (const item of contents) {\r\n\t\tconst type =\r\n\t\t\titem.type === \"shield\" || item.type === \"weapon\"\r\n\t\t\t\t? \"weaponAndShield\"\r\n\t\t\t\t: item.type;\r\n\t\tif (!ITEMS_TYPES[type]) continue;\r\n\r\n\t\tconst containerId = item.system.containerId;\r\n\t\tif (\r\n\t\t\ttype !== \"backpack\" &&\r\n\t\t\tcontainerId &&\r\n\t\t\t(openedContainers === true || openedContainers.includes(containerId))\r\n\t\t) {\r\n\t\t\tcontainers[containerId] ??= [];\r\n\t\t\tcontainers[containerId].push(item);\r\n\t\t} else {\r\n\t\t\tcategories[type] ??= [];\r\n\t\t\tcategories[type].push(item);\r\n\t\t}\r\n\t}\r\n\r\n\tcategories = Object.entries(categories)\r\n\t\t.map(([type, items]) => {\r\n\t\t\titems.sort((a, b) => localeCompare(a.name, b.name));\r\n\t\t\tif (type === \"backpack\") {\r\n\t\t\t\tfor (let i = items.length - 1; i >= 0; i--) {\r\n\t\t\t\t\tconst container = items[i];\r\n\t\t\t\t\tconst contained = containers[container.id]?.filter((item) =>\r\n\t\t\t\t\t\tfilterIn(item.name, filter),\r\n\t\t\t\t\t);\r\n\t\t\t\t\tif (!contained?.length) {\r\n\t\t\t\t\t\tif (!filterIn(container.name, filter)) items.splice(i, 1);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcontained.sort((a, b) => localeCompare(a.name, b.name));\r\n\t\t\t\t\titems.splice(i + 1, 0, ...contained);\r\n\t\t\t\t}\r\n\t\t\t} else items = items.filter((item) => filterIn(item.name, filter));\r\n\t\t\treturn {\r\n\t\t\t\ttype,\r\n\t\t\t\titems,\r\n\t\t\t\tlabel: ITEMS_TYPES[type].label,\r\n\t\t\t};\r\n\t\t})\r\n\t\t.filter((category) => category.items.length)\r\n\t\t.sort((a, b) => ITEMS_TYPES[a.type].order - ITEMS_TYPES[b.type].order);\r\n\r\n\tif (categories.length) {\r\n\t\treturn {\r\n\t\t\tdoubled: categories.length > 1 && getSetting(\"items-columns\"),\r\n\t\t\tcontentData: {\r\n\t\t\t\tcanCarry: !!actor.changeCarryType,\r\n\t\t\t\tcategories,\r\n\t\t\t\tbulk,\r\n\t\t\t\tcontainers: openedContainers,\r\n\t\t\t\ti18n: (str) => localize(`items.${str}`),\r\n\t\t\t\tinvested: invested\r\n\t\t\t\t\t? `${game.i18n.localize(\"PF2E.InvestedLabel\")}: ${invested.value} / ${\r\n\t\t\t\t\t\t\tinvested.max\r\n\t\t\t\t\t  }`\r\n\t\t\t\t\t: \"\",\r\n\t\t\t\twealth: { coins: coins.goldValue, total: totalWealth.goldValue },\r\n\t\t\t\tcanUseItem: (item) =>\r\n\t\t\t\t\tisCreature &&\r\n\t\t\t\t\titem.isOfType(\"consumable\") &&\r\n\t\t\t\t\titem.isIdentified &&\r\n\t\t\t\t\titem.uses.max &&\r\n\t\t\t\t\t!item.isAmmo,\r\n\t\t\t\titemDisabled: (item) =>\r\n\t\t\t\t\t!item.quantity ||\r\n\t\t\t\t\t!item.uses.value ||\r\n\t\t\t\t\titem.system.equipped.carryType === \"dropped\",\r\n\t\t\t\tisInContainer: (category, item) => {\r\n\t\t\t\t\tif (category.type !== \"backpack\") return false;\r\n\t\t\t\t\treturn !item.isOfType(\"backpack\") && item.isInContainer;\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t};\r\n\t}\r\n}\r\n\r\nexport function addItemsListeners({ el, actor, token, hud }) {\r\n\tconst item = el.find(\".item\");\r\n\r\n\taddNameTooltipListeners(item);\r\n\r\n\titem.find(\"[data-action=item-description]\").on(\"click\", async (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst item = $(event.currentTarget).closest(\".item\");\r\n\t\tawait showItemSummary(item, actor);\r\n\t});\r\n\r\n\titem\r\n\t\t.find(\"[data-action=toggle-contains-items]\")\r\n\t\t.on(\"click\", async (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tconst flag = `containers.${game.user.id}`;\r\n\t\t\tconst containerId = event.currentTarget.closest(\".item\").dataset.itemId;\r\n\t\t\tconst containers = getFlag(actor, flag)?.slice() ?? [];\r\n\t\t\tconst index = containers.indexOf(containerId);\r\n\t\t\tif (index === -1) containers.push(containerId);\r\n\t\t\telse containers.splice(index, 1);\r\n\t\t\tawait setFlag(actor, flag, containers);\r\n\t\t});\r\n\r\n\t// IS OWNER\r\n\tif (!actor.isOwner) return;\r\n\r\n\titem.find(\"[data-action=use-item]\").on(\"click\", (event) => {\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (!item) return;\r\n\r\n\t\titem.consume();\r\n\t\tif (getSetting(\"use-close\")) hud.close();\r\n\t});\r\n\r\n\titem.find(\"[data-action=item-chat]\").on(\"click\", async (event) => {\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (!item) return;\r\n\r\n\t\titem.toMessage(event, { create: true });\r\n\t\tif (getSetting(\"chat-close\")) hud.close();\r\n\t});\r\n\r\n\titem.on(\"dragstart\", (event) => {\r\n\t\tconst target = event.target.closest(\".item\");\r\n\t\tconst { itemType, uuid } = target.dataset;\r\n\r\n\t\tconst img = new Image();\r\n\t\timg.src = target.querySelector(\".item-img img\").src;\r\n\t\timg.style.width = \"32px\";\r\n\t\timg.style.height = \"32px\";\r\n\t\timg.style.borderRadius = \"4px\";\r\n\t\timg.style.position = \"absolute\";\r\n\t\timg.style.left = \"-1000px\";\r\n\t\tdocument.body.append(img);\r\n\r\n\t\tevent.originalEvent.dataTransfer.setDragImage(img, 16, 16);\r\n\t\tevent.originalEvent.dataTransfer.setData(\r\n\t\t\t\"text/plain\",\r\n\t\t\tJSON.stringify({ type: \"Item\", fromInventory: true, itemType, uuid }),\r\n\t\t);\r\n\r\n\t\ttarget.addEventListener(\"dragend\", () => img.remove(), { once: true });\r\n\t});\r\n\r\n\tel.find(\".quantity input\").on(\"change\", async (event) => {\r\n\t\tawait getItemFromEvent(event, actor)?.update({\r\n\t\t\t\"system.quantity\": event.currentTarget.valueAsNumber,\r\n\t\t});\r\n\t});\r\n\r\n\tel.find(\"[data-action=toggle-item-invest]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst { itemId } = event.currentTarget.closest(\".item\").dataset;\r\n\t\tactor.toggleInvested(itemId);\r\n\t});\r\n\r\n\tel.find(\"[data-action=repair-item]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (item)\r\n\t\t\tgame.pf2e.actions.repair({ item, actors: [actor], tokens: [token] });\r\n\t});\r\n\r\n\tel.find(\"[data-action=toggle-identified]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (!item) return;\r\n\t\tif (item.isIdentified) item.setIdentificationStatus(\"unidentified\");\r\n\t\telse new IdentifyItemPopup(item).render(true);\r\n\t});\r\n\r\n\tel.find(\"[data-action=detach-item]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst { itemId, parentId } =\r\n\t\t\tevent.currentTarget.closest(\"[data-item-id]\").dataset;\r\n\r\n\t\tconst parent = actor.items.get(parentId);\r\n\t\tif (!parent) return;\r\n\r\n\t\tconst subitem = parent.subitems.get(itemId);\r\n\t\tif (!subitem) return;\r\n\r\n\t\tdetachSubitem(subitem, event.ctrlKey);\r\n\t});\r\n\r\n\tel.find(\"[data-action=edit-item]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\titem?.sheet.render(true, { focus: true });\r\n\t});\r\n\r\n\tel.find(\"[data-action=delete-item]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (!item) return;\r\n\r\n\t\tif (event.ctrlKey) item.delete();\r\n\t\telse item.deleteDialog();\r\n\t});\r\n\r\n\tel.find(\"[data-action=toggle-item-worn]\").on(\"click\", async (event) => {\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (!item) return;\r\n\r\n\t\tconst content = document.createElement(\"div\");\r\n\t\tcontent.innerHTML = await renderTemplate(\r\n\t\t\t\"systems/pf2e/templates/actors/partials/carry-type.hbs\",\r\n\t\t\t{ item },\r\n\t\t);\r\n\r\n\t\tfor (const el of content.querySelectorAll(\"[data-carry-type]\")) {\r\n\t\t\tel.addEventListener(\"click\", async (event) => {\r\n\t\t\t\tconst menu = event.currentTarget;\r\n\t\t\t\tconst carryType = menu.dataset.carryType;\r\n\t\t\t\tconst handsHeld = Number(menu.dataset.handsHeld) || 0;\r\n\t\t\t\tconst inSlot = menu.dataset.inSlot !== undefined;\r\n\t\t\t\tconst current = item.system.equipped;\r\n\r\n\t\t\t\tdismissTooltip(menu);\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\tcarryType !== current.carryType ||\r\n\t\t\t\t\tinSlot !== current.inSlot ||\r\n\t\t\t\t\t(carryType === \"held\" && handsHeld !== current.handsHeld)\r\n\t\t\t\t) {\r\n\t\t\t\t\tactor.changeCarryType(item, { carryType, handsHeld, inSlot });\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (item.type !== \"backpack\") {\r\n\t\t\tconst containers = actor.itemTypes.backpack.filter(\r\n\t\t\t\t(container) => container.isIdentified,\r\n\t\t\t);\r\n\r\n\t\t\tif (containers.length) {\r\n\t\t\t\tlet rows = \"\";\r\n\t\t\t\tfor (const container of containers) {\r\n\t\t\t\t\trows += '<li><a class=\"item-control item-location-option';\r\n\t\t\t\t\tif (container === item.container) rows += \" selected\";\r\n\t\t\t\t\trows += `\" data-action=\"send-to-container\" data-container-id=\"${container.id}\">`;\r\n\t\t\t\t\trows += `<i class=\"fas fa-box\"></i>${container.name}</a></li>`;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcontent.insertAdjacentHTML(\"beforeend\", rows);\r\n\r\n\t\t\t\tconst sendToContainers = content.querySelectorAll(\r\n\t\t\t\t\t\"[data-action=send-to-container]\",\r\n\t\t\t\t);\r\n\t\t\t\tfor (const el of sendToContainers) {\r\n\t\t\t\t\tel.addEventListener(\"click\", (event) => {\r\n\t\t\t\t\t\tconst menu = event.currentTarget;\r\n\t\t\t\t\t\tconst containerId = menu.dataset.containerId;\r\n\t\t\t\t\t\tconst container = actor.items.get(containerId);\r\n\t\t\t\t\t\tif (!container) return;\r\n\r\n\t\t\t\t\t\tdismissTooltip(menu);\r\n\t\t\t\t\t\tactor.stowOrUnstow(item, container);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tcreateTooltip({\r\n\t\t\ttarget: event.currentTarget,\r\n\t\t\tcontent,\r\n\t\t\tlocked: true,\r\n\t\t\tdirection: \"UP\",\r\n\t\t\tselected: true,\r\n\t\t\tcssClass: \"carry-type\",\r\n\t\t});\r\n\t});\r\n}\r\n", "import {\r\n\tcoerceToSpellGroupId,\r\n\teventToRollParams,\r\n\tordinalString,\r\n\tspellSlotGroupIdToNumber,\r\n} from \"module-api\";\r\nimport {\r\n\tMODULE_ID,\r\n\tgetSetting,\r\n\tlocalize,\r\n\tmodifier,\r\n\ttemplatePath,\r\n} from \"../module.js\";\r\nimport { showItemSummary } from \"../popup.js\";\r\nimport {\r\n\taddNameTooltipListeners,\r\n\tfilterIn,\r\n\tgetItemFromEvent,\r\n\tlocaleCompare,\r\n} from \"../shared.js\";\r\n\r\nexport async function getSpellsData({ actor, filter }) {\r\n\tconst focusPool = actor.system.resources.focus ?? { value: 0, max: 0 };\r\n\tconst showTradition = getSetting(\"tradition\");\r\n\r\n\tconst pf2eStavesActive = game.modules.get(\"pf2e-staves\")?.active;\r\n\tconst pf2eDailies = game.modules.get(\"pf2e-dailies\");\r\n\tconst pf2eDailiesActive = pf2eDailies?.active;\r\n\tconst stavesActive =\r\n\t\tpf2eStavesActive ||\r\n\t\t(pf2eDailiesActive && isNewerVersion(pf2eDailies.version, \"2.14.0\"));\r\n\tconst chargesPath = pf2eStavesActive\r\n\t\t? \"flags.pf2e-staves.charges\"\r\n\t\t: pf2eDailiesActive\r\n\t\t  ? \"flags.pf2e-dailies.staff.charges\"\r\n\t\t  : \"\";\r\n\r\n\tconst spells = [];\r\n\tconst focuses = [];\r\n\r\n\tlet rituals;\r\n\tlet hasFocusCantrips = false;\r\n\r\n\tconst entries = await Promise.all(\r\n\t\tactor.spellcasting.collections.map(async (spells) => {\r\n\t\t\treturn {\r\n\t\t\t\tentry: spells.entry,\r\n\t\t\t\tdata: await spells.entry.getSheetData({ spells }),\r\n\t\t\t};\r\n\t\t}),\r\n\t);\r\n\r\n\tfor (const { entry, data } of entries) {\r\n\t\tif (data.isRitual) {\r\n\t\t\trituals = data.groups.flatMap((group, slotId) =>\r\n\t\t\t\tgroup.active\r\n\t\t\t\t\t.map(({ spell }) => {\r\n\t\t\t\t\t\tif (!filterIn(spell.name, filter)) return;\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\tname: spell.name,\r\n\t\t\t\t\t\t\timg: spell.img,\r\n\t\t\t\t\t\t\tslotId,\r\n\t\t\t\t\t\t\titemId: spell.id,\r\n\t\t\t\t\t\t\trank: spell.rank,\r\n\t\t\t\t\t\t\ttime: spell.system.time.value,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.filter(Boolean),\r\n\t\t\t);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst entryId = data.id;\r\n\t\tconst tradition = showTradition && data.statistic.label[0];\r\n\t\tconst isFocus = data.isFocusPool;\r\n\t\tconst isCharge = entry.system?.prepared?.value === \"charge\";\r\n\t\tconst isInnate = data.isInnate;\r\n\t\tconst isPrepared = data.isPrepared;\r\n\t\tconst isSpontaneous = data.isSpontaneous;\r\n\t\tconst isFlexible = data.isFlexible;\r\n\r\n\t\tconst consumable = (() => {\r\n\t\t\tif (data.category !== \"items\") return;\r\n\t\t\tconst itemId = entry.id.split(\"-\")[0];\r\n\t\t\treturn actor.items.get(itemId);\r\n\t\t})();\r\n\r\n\t\tconst charges = (() => {\r\n\t\t\tif (!isCharge) return;\r\n\r\n\t\t\tconst dailiesData =\r\n\t\t\t\tpf2eDailiesActive &&\r\n\t\t\t\tpf2eDailies.api.getSpellcastingEntryStaffData(entry);\r\n\t\t\tconst { charges, max, canPayCost } = dailiesData ??\r\n\t\t\t\tgetProperty(entry, \"flags.pf2e-staves.charges\") ?? {\r\n\t\t\t\t\tcharges: 0,\r\n\t\t\t\t\tmax: 0,\r\n\t\t\t\t};\r\n\r\n\t\t\treturn {\r\n\t\t\t\tvalue: charges,\r\n\t\t\t\tmax,\r\n\t\t\t\tnoMax: true,\r\n\t\t\t\tcanPayCost: canPayCost ?? (() => true),\r\n\t\t\t};\r\n\t\t})();\r\n\r\n\t\tfor (const group of data.groups) {\r\n\t\t\tif (!group.active.length || group.uses?.max === 0) continue;\r\n\r\n\t\t\tconst slotSpells = [];\r\n\t\t\tconst isCantrip = group.id === \"cantrips\";\r\n\t\t\tconst groupNumber = spellSlotGroupIdToNumber(group.id);\r\n\r\n\t\t\tfor (let slotId = 0; slotId < group.active.length; slotId++) {\r\n\t\t\t\tconst active = group.active[slotId];\r\n\t\t\t\tif (!active || active.uses?.max === 0) continue;\r\n\r\n\t\t\t\tconst { spell, expended, virtual, uses, castRank } = active;\r\n\t\t\t\tif (!filterIn(spell.name, filter)) continue;\r\n\r\n\t\t\t\tslotSpells.push({\r\n\t\t\t\t\tname: spell.name,\r\n\t\t\t\t\timg: spell.img,\r\n\t\t\t\t\ttradition,\r\n\t\t\t\t\tcastRank: castRank ?? spell.rank,\r\n\t\t\t\t\tslotId,\r\n\t\t\t\t\tentryId,\r\n\t\t\t\t\titemId: spell.id,\r\n\t\t\t\t\tinputId: isInnate ? spell.id : data.id,\r\n\t\t\t\t\tinputPath: consumable\r\n\t\t\t\t\t\t? \"system.uses.value\"\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? chargesPath\r\n\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t  ? \"system.location.uses.value\"\r\n\t\t\t\t\t\t\t  : `system.slots.slot${groupNumber}.value`,\r\n\t\t\t\t\tisCharge,\r\n\t\t\t\t\tisActiveCharge: isCharge && stavesActive,\r\n\t\t\t\t\tisVirtual: virtual,\r\n\t\t\t\t\tisInnate,\r\n\t\t\t\t\tisCantrip,\r\n\t\t\t\t\tisFocus,\r\n\t\t\t\t\tisPrepared,\r\n\t\t\t\t\tisSpontaneous: isSpontaneous || isFlexible,\r\n\t\t\t\t\tgroupId: group.id,\r\n\t\t\t\t\tconsumable,\r\n\t\t\t\t\tuses: consumable\r\n\t\t\t\t\t\t? consumable.system.uses\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? charges\r\n\t\t\t\t\t\t  : uses ?? group.uses,\r\n\t\t\t\t\texpended: isCharge\r\n\t\t\t\t\t\t? !charges.canPayCost(groupNumber)\r\n\t\t\t\t\t\t: expended ??\r\n\t\t\t\t\t\t  (isFocus && !isCantrip ? focusPool.value <= 0 : false),\r\n\t\t\t\t\taction: spell.system.time.value,\r\n\t\t\t\t\ttype: consumable\r\n\t\t\t\t\t\t? `PF2E.Item.Consumable.Category.${consumable.category}`\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? `${MODULE_ID}.spells.staff`\r\n\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t  ? \"PF2E.PreparationTypeInnate\"\r\n\t\t\t\t\t\t\t  : isSpontaneous\r\n\t\t\t\t\t\t\t\t  ? \"PF2E.PreparationTypeSpontaneous\"\r\n\t\t\t\t\t\t\t\t  : isFlexible\r\n\t\t\t\t\t\t\t\t\t  ? \"PF2E.SpellFlexibleLabel\"\r\n\t\t\t\t\t\t\t\t\t  : isFocus\r\n\t\t\t\t\t\t\t\t\t\t  ? \"PF2E.TraitFocus\"\r\n\t\t\t\t\t\t\t\t\t\t  : \"PF2E.SpellPreparedLabel\",\r\n\t\t\t\t\torder: isCharge\r\n\t\t\t\t\t\t? 0\r\n\t\t\t\t\t\t: isPrepared\r\n\t\t\t\t\t\t  ? 1\r\n\t\t\t\t\t\t  : isFocus\r\n\t\t\t\t\t\t\t  ? 2\r\n\t\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t\t  ? 3\r\n\t\t\t\t\t\t\t\t  : isSpontaneous\r\n\t\t\t\t\t\t\t\t\t  ? 4\r\n\t\t\t\t\t\t\t\t\t  : 5,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (slotSpells.length) {\r\n\t\t\t\tif (isFocus) {\r\n\t\t\t\t\tif (isCantrip) hasFocusCantrips = true;\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tfocuses.push(...slotSpells);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tspells[groupNumber] ??= [];\r\n\t\t\t\tspells[groupNumber].push(...slotSpells);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (spells.length) {\r\n\t\tconst sortingSetting = getSetting(\"spells-sort\");\r\n\t\tconst sort =\r\n\t\t\tsortingSetting === \"type\"\r\n\t\t\t\t? (a, b) =>\r\n\t\t\t\t\t\ta.order === b.order\r\n\t\t\t\t\t\t\t? localeCompare(a.name, b.name)\r\n\t\t\t\t\t\t\t: a.order - b.order\r\n\t\t\t\t: sortingSetting === \"entry\"\r\n\t\t\t\t  ? (a, b) => {\r\n\t\t\t\t\t\t\tconst compareEntries = localeCompare(a.entryId, b.entryId);\r\n\t\t\t\t\t\t\tif (compareEntries !== 0) return compareEntries;\r\n\t\t\t\t\t\t\treturn localeCompare(a.name, b.name);\r\n\t\t\t\t\t  }\r\n\t\t\t\t  : (a, b) => localeCompare(a.name, b.name);\r\n\r\n\t\tfor (const entry of spells) {\r\n\t\t\tif (!entry) continue;\r\n\t\t\tentry.sort(sort);\r\n\t\t}\r\n\t}\r\n\r\n\tif (focuses.length) {\r\n\t\tfocuses.sort((a, b) => localeCompare(a.name, b.name));\r\n\t\tspells[12] = focuses;\r\n\t\thasFocusCantrips = false;\r\n\t}\r\n\r\n\tif (spells.length || rituals?.length) {\r\n\t\tconst attacks = getSpellAttacks(actor);\r\n\r\n\t\tconst nb = spells.length + Number((rituals?.length ?? 0) > 0);\r\n\t\treturn {\r\n\t\t\tcontentData: {\r\n\t\t\t\tspells,\r\n\t\t\t\trituals,\r\n\t\t\t\tfocusPool,\r\n\t\t\t\thasFocusCantrips,\r\n\t\t\t\ti18n: (str) => localize(`spells.${str}`),\r\n\t\t\t\tattackMod: hasSingleSpellAttack(attacks) ? attacks[0].mod : null,\r\n\t\t\t\tentryRank: (rank) =>\r\n\t\t\t\t\tgame.i18n.format(\"PF2E.Item.Spell.Rank.Ordinal\", {\r\n\t\t\t\t\t\trank: ordinalString(rank),\r\n\t\t\t\t\t}),\r\n\t\t\t},\r\n\t\t\tdoubled: nb > 1 && getSetting(\"spells-columns\"),\r\n\t\t};\r\n\t}\r\n}\r\n\r\nfunction getSpellAttacks(actor) {\r\n\treturn actor.spellcasting\r\n\t\t.filter((entry) => entry.statistic)\r\n\t\t.map(({ statistic, name, id }) => ({\r\n\t\t\tname,\r\n\t\t\tid,\r\n\t\t\tmod: modifier(statistic.mod),\r\n\t\t\tstatistic,\r\n\t\t}));\r\n}\r\n\r\nfunction hasSingleSpellAttack(attacks) {\r\n\treturn new Set(attacks.map(({ mod }) => mod)).size === 1;\r\n}\r\n\r\nexport function addSpellsListeners({ el, actor, hud }) {\r\n\taddNameTooltipListeners(el.find(\".spell\"));\r\n\r\n\tel.find(\"[data-action=spell-description]\").on(\"click\", async (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst spell = $(event.currentTarget).closest(\".spell\");\r\n\t\tshowItemSummary(spell, actor);\r\n\t});\r\n\r\n\t// IS OWNER\r\n\tif (!actor.isOwner) return;\r\n\r\n\tel.find(\"[data-action=spell-attack]\").on(\"click\", async (event) => {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst attacks = getSpellAttacks(actor);\r\n\t\tif (!attacks.length) return;\r\n\r\n\t\tlet statistic;\r\n\t\tif (!hasSingleSpellAttack(attacks)) {\r\n\t\t\tconst id = await Dialog.wait({\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tok: {\r\n\t\t\t\t\t\ticon: '<i class=\"fa-solid fa-dice-d20\"></i>',\r\n\t\t\t\t\t\tlabel: localize(\"spells.attacks.ok\"),\r\n\t\t\t\t\t\tcallback: (html) => html.find(\"input:checked\").val(),\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\ttitle: localize(\"spells.attacks.title\"),\r\n\t\t\t\tcontent: await renderTemplate(templatePath(\"dialogs/spell-attacks\"), {\r\n\t\t\t\t\tattacks,\r\n\t\t\t\t}),\r\n\t\t\t\tclose: () => null,\r\n\t\t\t});\r\n\r\n\t\t\tif (id) statistic = actor.items.get(id)?.statistic;\r\n\t\t} else {\r\n\t\t\tstatistic = attacks[0].statistic;\r\n\t\t}\r\n\r\n\t\tconst rollParams = eventToRollParams(event, { type: \"check\" });\r\n\t\tconst { map } = event.currentTarget.dataset;\r\n\t\tif (map) {\r\n\t\t\trollParams.modifiers = [\r\n\t\t\t\tnew game.pf2e.Modifier({\r\n\t\t\t\t\tlabel: \"PF2E.MultipleAttackPenalty\",\r\n\t\t\t\t\tmodifier: Number(map),\r\n\t\t\t\t}),\r\n\t\t\t];\r\n\t\t}\r\n\r\n\t\tstatistic?.check.roll(rollParams);\r\n\t});\r\n\r\n\tel.find(\"[data-action=draw-item]\").on(\"click\", async (event) => {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (!item) return;\r\n\r\n\t\tactor.changeCarryType(item, { carryType: \"held\", handsHeld: 1 });\r\n\t});\r\n\r\n\tel.find(\"[data-action=spell-chat]\").on(\"click\", async (event) => {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst item = getItemFromEvent(event, actor);\r\n\t\tif (!item) return;\r\n\r\n\t\titem.toMessage(event);\r\n\t\tif (getSetting(\"chat-close\")) hud.close();\r\n\t});\r\n\r\n\tel.find(\"[data-action=toggle-pips]\").on(\r\n\t\t\"click contextmenu\",\r\n\t\tasync (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tconst change = event.type === \"click\" ? 1 : -1;\r\n\t\t\tconst points = (actor.system.resources.focus?.value ?? 0) + change;\r\n\t\t\tawait actor.update({ \"system.resources.focus.value\": points });\r\n\t\t},\r\n\t);\r\n\r\n\tel.find(\"[data-action=toggle-prepared]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\t\tconst { groupId, slotId, entryId, expended } = $(event.currentTarget)\r\n\t\t\t.closest(\".spell\")\r\n\t\t\t.data();\r\n\t\tconst collection = actor.spellcasting.collections.get(entryId);\r\n\t\tcollection?.setSlotExpendedState(\r\n\t\t\tcoerceToSpellGroupId(groupId),\r\n\t\t\tslotId || 0,\r\n\t\t\texpended !== true,\r\n\t\t);\r\n\t});\r\n\r\n\tel.find(\"[data-action=cast-spell]\").on(\"click\", (event) => {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst { castRank, slotId, entryId, itemId } =\r\n\t\t\tevent.currentTarget.closest(\".spell\").dataset;\r\n\r\n\t\tconst collection = actor.spellcasting.collections.get(entryId);\r\n\t\tif (!collection) return;\r\n\r\n\t\tconst spell = collection.get(itemId);\r\n\t\tif (!spell) return;\r\n\r\n\t\tconst maybeCastRank = Number(castRank) || NaN;\r\n\t\tif (Number.isInteger(maybeCastRank) && maybeCastRank.between(1, 10)) {\r\n\t\t\tif (!spell.parentItem?.consume()) {\r\n\t\t\t\tcollection.entry.cast(spell, {\r\n\t\t\t\t\trank: maybeCastRank,\r\n\t\t\t\t\tslotId: Number(slotId),\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (getSetting(\"cast-close\")) hud.close();\r\n\t});\r\n\r\n\tel.find(\"[data-input-path]\").on(\"change\", async (event) => {\r\n\t\tconst { inputPath, entryId } = $(event.currentTarget).data();\r\n\t\tconst value = event.currentTarget.valueAsNumber;\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", [\r\n\t\t\t{ _id: entryId, [inputPath]: value },\r\n\t\t]);\r\n\t});\r\n}\r\n", "import { createTooltip, getDamageRollClass } from \"module-api\";\r\nimport { useResolve } from \"./actions/use-resolve.js\";\r\nimport {\r\n\tMODULE_ID,\r\n\tenrichHTML,\r\n\tgetFlag,\r\n\tgetSetting,\r\n\tlocalize,\r\n\tmodifier,\r\n\tsetFlag,\r\n\ttemplatePath,\r\n} from \"./module.js\";\r\nimport { popup } from \"./popup.js\";\r\nimport {\r\n\tRANKS,\r\n\tgetCoverEffect,\r\n\tgetUniqueTarget,\r\n\tlocaleCompare,\r\n} from \"./shared.js\";\r\nimport { addActionsListeners, getActionsData } from \"./sidebars/actions.js\";\r\nimport { addExtrasListeners, getExtrasData } from \"./sidebars/extras.js\";\r\nimport { addHazardListeners, getHazardData } from \"./sidebars/hazard.js\";\r\nimport { addItemsListeners, getItemsData } from \"./sidebars/items.js\";\r\nimport { addSkillsListeners, getSkillsData } from \"./sidebars/skills.js\";\r\nimport { addSpellsListeners, getSpellsData } from \"./sidebars/spells.js\";\r\n\r\nconst HOVER_EXCEPTIONS = [\r\n\t\"#combat-popout\",\r\n\t\"#sidebar\",\r\n\t\"#mini-tracker\",\r\n\t\"#combat-dock\",\r\n\t\"#combat-carousel\",\r\n\t\"[id^=pf2e-perception]\",\r\n].join(\", \");\r\n\r\nconst PLACEMENT_BY_TYPE = {\r\n\tactions: \"actions\",\r\n\tspells: \"spellcasting\",\r\n\titems: \"inventory\",\r\n\tskills: \"proficiencies\",\r\n};\r\n\r\nconst POSITIONS = {\r\n\tleft: [\"left\", \"right\", \"top\", \"bottom\"],\r\n\tright: [\"right\", \"left\", \"top\", \"bottom\"],\r\n\ttop: [\"top\", \"bottom\", \"left\", \"right\"],\r\n\tbottom: [\"bottom\", \"top\", \"left\", \"right\"],\r\n};\r\n\r\nconst ALLIANCES = {\r\n\topposition: {\r\n\t\ticon: \"fa-solid fa-face-angry-horns\",\r\n\t\tlabel: \"PF2E.Actor.Creature.Alliance.Opposition\",\r\n\t},\r\n\tparty: {\r\n\t\ticon: \"fa-solid fa-face-smile-halo\",\r\n\t\tlabel: \"PF2E.Actor.Creature.Alliance.Party\",\r\n\t},\r\n\tneutral: {\r\n\t\ticon: \"fa-solid fa-face-meh\",\r\n\t\tlabel: \"PF2E.Actor.Creature.Alliance.Neutral\",\r\n\t},\r\n};\r\n\r\nconst SPEEDS = [\r\n\t{ type: \"land\", icon: \"fa-solid fa-shoe-prints\" },\r\n\t{ type: \"burrow\", icon: \"fa-solid fa-chevrons-down\" },\r\n\t{ type: \"climb\", icon: \"fa-solid fa-spider\" },\r\n\t{ type: \"fly\", icon: \"fa-solid fa-feather\" },\r\n\t{ type: \"swim\", icon: \"fa-solid fa-person-swimming\" },\r\n];\r\n\r\nconst SIDEBARS = {\r\n\tactions: { getData: getActionsData, addListeners: addActionsListeners },\r\n\titems: { getData: getItemsData, addListeners: addItemsListeners },\r\n\tspells: { getData: getSpellsData, addListeners: addSpellsListeners },\r\n\tskills: { getData: getSkillsData, addListeners: addSkillsListeners },\r\n\textras: { getData: getExtrasData, addListeners: addExtrasListeners },\r\n\thazard: { getData: getHazardData, addListeners: addHazardListeners },\r\n};\r\n\r\nconst SAVES = {\r\n\tfortitude: { icon: \"fa-solid fa-chess-rook\", label: \"PF2E.SavesFortitude\" },\r\n\treflex: { icon: \"fa-solid fa-person-running\", label: \"PF2E.SavesReflex\" },\r\n\twill: { icon: \"fa-solid fa-brain\", label: \"PF2E.SavesWill\" },\r\n};\r\n\r\nconst SKILLS = {\r\n\tperception: { icon: \"fa-solid fa-eye\", label: \"PF2E.PerceptionLabel\" },\r\n\tstealth: { icon: \"fa-duotone fa-eye-slash\", label: \"PF2E.SkillStealth\" },\r\n\tathletics: { icon: \"fa-solid fa-hand-fist\", label: \"PF2E.SkillAthletics\" },\r\n};\r\n\r\nexport class HUD extends Application {\r\n\t#token = null;\r\n\t#lastToken = null;\r\n\t#hoveredToken = null;\r\n\t#delay = null;\r\n\t#holding = false;\r\n\t#closing = null;\r\n\t#mousedown = [false, false, false];\r\n\t#lock = false;\r\n\t#softLock = false;\r\n\t#isObserved = false;\r\n\t#hoverTokenHandler;\r\n\t#mouseeventHandler;\r\n\t#deleteTokenHandler;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.forceClose = () => this.close({ force: true });\r\n\r\n\t\tthis.#hoverTokenHandler = (token, hover) => {\r\n\t\t\tif (hover) this.#tokenEnter(token);\r\n\t\t\telse this.#tokenLeave(token);\r\n\t\t};\r\n\r\n\t\tthis.#mouseeventHandler = (event) => {\r\n\t\t\tconst button = event.button;\r\n\t\t\tif (![0, 2].includes(button)) return;\r\n\r\n\t\t\tif (event.type === \"mouseup\") {\r\n\t\t\t\tthis.#mousedown[button] = false;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tthis.#mousedown[button] = true;\r\n\r\n\t\t\tconst target = event.target;\r\n\t\t\tconst el = this.element[0];\r\n\r\n\t\t\tif (el) {\r\n\t\t\t\tconst popup = el.querySelector(\".popup\");\r\n\r\n\t\t\t\tif (popup && !popup.contains(target)) {\r\n\t\t\t\t\tif (!el.querySelector(\".sidebar\")) this.forceClose();\r\n\t\t\t\t\telse return popup.remove();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (target.closest(\"canvas\")) this.forceClose();\r\n\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tthis.#cancelDelay();\r\n\t\t\tthis.unlock(true);\r\n\t\t};\r\n\r\n\t\tthis.#deleteTokenHandler = (token) => {\r\n\t\t\tif (this.#token && token.id === this.#token.id) this.forceClose();\r\n\t\t};\r\n\r\n\t\twindow.addEventListener(\"mousedown\", this.#mouseeventHandler);\r\n\t\twindow.addEventListener(\"mouseup\", this.#mouseeventHandler);\r\n\r\n\t\tHooks.on(\"hoverToken\", this.#hoverTokenHandler);\r\n\t\tHooks.on(\"deleteToken\", this.#deleteTokenHandler);\r\n\t\tHooks.on(\"canvasPan\", this.forceClose);\r\n\t}\r\n\r\n\tsetToken(token, isObserved) {\r\n\t\tif (token !== this.#token) {\r\n\t\t\tdelete this.#token?.actor?.apps[this.appId];\r\n\r\n\t\t\tthis.#token = token;\r\n\t\t\tconst actor = token?.actor;\r\n\t\t\tif (actor) actor.apps[this.appId] = this;\r\n\t\t}\r\n\t\tthis.#isObserved = isObserved ?? this.#checkIfObserved(token);\r\n\t}\r\n\r\n\tsetHolding(held) {\r\n\t\tconst holding = getSetting(\"key-holding\");\r\n\t\tif (holding === \"none\") return;\r\n\r\n\t\tthis.#holding = held;\r\n\r\n\t\tif (this.#softLock || this.#lock) return;\r\n\r\n\t\tif (held) {\r\n\t\t\tif (!this.#hoveredToken) return;\r\n\t\t\tconst isObserved = this.#checkIfObserved(this.#hoveredToken);\r\n\t\t\tif (holding === \"half\" && !game.user.isGM && !isObserved) {\r\n\t\t\t\tthis.#cancelDelay();\r\n\t\t\t\tthis.render();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tthis.setToken(this.#hoveredToken, isObserved);\r\n\t\t\tthis.render();\r\n\t\t} else {\r\n\t\t\tif (holding === \"all\") this.close();\r\n\t\t\telse if (game.user.isGM) {\r\n\t\t\t\tthis.setToken(this.#hoveredToken);\r\n\t\t\t\tthis.render();\r\n\t\t\t} else if (this.#isObserved) this.close();\r\n\t\t}\r\n\t}\r\n\r\n\t#checkIfObserved(token) {\r\n\t\tconst actor = token?.actor;\r\n\t\tif (!actor) return false;\r\n\r\n\t\tlet isObserved;\r\n\t\tconst isParty = actor.system.details.alliance === \"party\";\r\n\r\n\t\tif (\r\n\t\t\tgame.user.isGM &&\r\n\t\t\tgetSetting(\"key-holding\") === \"half\" &&\r\n\t\t\t!this.#holding\r\n\t\t)\r\n\t\t\tisObserved = false;\r\n\t\telse if (actor.isOfType(\"familiar\") && !actor.master) isObserved = false;\r\n\t\telse\r\n\t\t\tisObserved =\r\n\t\t\t\ttoken.isOwner ||\r\n\t\t\t\t(getSetting(\"observer\") &&\r\n\t\t\t\t\t(token.observer || (isParty && getSetting(\"party\"))));\r\n\r\n\t\treturn isObserved;\r\n\t}\r\n\r\n\t#tokenEnter(token) {\r\n\t\tif ($(window.document).find(\":hover\").filter(HOVER_EXCEPTIONS).length)\r\n\t\t\treturn;\r\n\r\n\t\tconst actor = token.actor;\r\n\t\tif (!actor || actor.isOfType(\"loot\", \"party\")) return;\r\n\r\n\t\tif (\r\n\t\t\ttoken.document.disposition === CONST.TOKEN_DISPOSITIONS.SECRET &&\r\n\t\t\t!actor.isOwner\r\n\t\t)\r\n\t\t\treturn;\r\n\r\n\t\tif (actor.isOfType(\"npc\") && getSetting(\"no-dead\") && actor.isDead) return;\r\n\r\n\t\tthis.#hoveredToken = token;\r\n\r\n\t\tif (token !== this.#lastToken && !this.#lock) this.close();\r\n\r\n\t\tif (this.mousedown || this.#lock || this.#softLock || token === this.#token)\r\n\t\t\treturn;\r\n\r\n\t\tconst holding = getSetting(\"key-holding\");\r\n\t\tconst isObserved = this.#checkIfObserved(token);\r\n\t\tif (\r\n\t\t\tholding !== \"none\" &&\r\n\t\t\t!this.#holding &&\r\n\t\t\t(holding === \"all\" || isObserved)\r\n\t\t)\r\n\t\t\treturn;\r\n\r\n\t\tthis.#cancelClosing(true);\r\n\t\tthis.setToken(token, isObserved);\r\n\r\n\t\tif (holding === \"none\" || !this.#holding) this.renderWithDelay();\r\n\t\telse this.render();\r\n\t}\r\n\r\n\t#tokenLeave(token) {\r\n\t\tthis.#hoveredToken = null;\r\n\r\n\t\tif (this.mousedown || this.#lock || this.#softLock) return;\r\n\r\n\t\tthis.#closing = setTimeout(() => {\r\n\t\t\tthis.#closing = null;\r\n\t\t\tif (this.#softLock || this.#lock) return;\r\n\t\t\tthis.close();\r\n\t\t}, 10);\r\n\t}\r\n\r\n\trenderWithDelay() {\r\n\t\tlet delay = getSetting(\"delay\");\r\n\t\tif (delay) {\r\n\t\t\tif (delay < 10) delay = 10;\r\n\t\t\tthis.#delay = setTimeout(() => {\r\n\t\t\t\tthis.#delay = null;\r\n\t\t\t\tthis.render();\r\n\t\t\t}, delay);\r\n\t\t} else this.render();\r\n\t}\r\n\r\n\t#cancelClosing(close) {\r\n\t\tif (this.#closing === null) return;\r\n\t\tclearTimeout(this.#closing);\r\n\t\tthis.#closing = null;\r\n\t\tif (close) this.close();\r\n\t}\r\n\r\n\t#cancelDelay() {\r\n\t\tif (this.#delay === null) return;\r\n\t\tclearTimeout(this.#delay);\r\n\t\tthis.#delay = null;\r\n\t}\r\n\r\n\tdelete() {\r\n\t\tthis.forceClose();\r\n\r\n\t\twindow.removeEventListener(\"mousedown\", this.#mouseeventHandler);\r\n\t\twindow.removeEventListener(\"mouseup\", this.#mouseeventHandler);\r\n\r\n\t\tHooks.off(\"hoverToken\", this.#hoverTokenHandler);\r\n\t\tHooks.off(\"deleteToken\", this.#deleteTokenHandler);\r\n\t\tHooks.off(\"canvasPan\", this.forceClose);\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn mergeObject(Application.defaultOptions, {\r\n\t\t\tpopOut: false,\r\n\t\t\tminimizable: false,\r\n\t\t\ttemplate: templatePath(\"hud\"),\r\n\t\t});\r\n\t}\r\n\r\n\tget mousedown() {\r\n\t\treturn this.#mousedown[0] || this.#mousedown[2];\r\n\t}\r\n\r\n\tget token() {\r\n\t\treturn this.#token;\r\n\t}\r\n\r\n\tget actor() {\r\n\t\treturn this.#token?.actor;\r\n\t}\r\n\r\n\tget hasCover() {\r\n\t\treturn !!getCoverEffect(this.actor);\r\n\t}\r\n\r\n\tget sidebar() {\r\n\t\treturn this.element?.find(\"> .sidebar\") ?? [];\r\n\t}\r\n\r\n\tget popup() {\r\n\t\treturn this.element?.find(\"> .popup\") ?? [];\r\n\t}\r\n\r\n\tget inner() {\r\n\t\treturn this.element?.find(\"> .inner\") ?? [];\r\n\t}\r\n\r\n\tasync getData() {\r\n\t\tconst token = this.#token;\r\n\t\tconst actor = this.#token?.actor;\r\n\t\tif (!actor) return {};\r\n\r\n\t\tlet distance = null;\r\n\t\tconst savesSetting = getSetting(\"saves\");\r\n\t\tconst othersSetting = getSetting(\"others\");\r\n\t\tconst isCharacter = actor.isOfType(\"character\");\r\n\t\tconst { attributes } = actor;\r\n\t\tconst { hp, ac } = attributes;\r\n\t\tconst sp = hp.sp ?? { max: 0, value: 0 };\r\n\t\tconst useStamina = game.settings.get(\"pf2e\", \"staminaVariant\");\r\n\t\tconst showDistance = getSetting(\"distance\");\r\n\t\tconst fontSize = getSetting(\"scale\");\r\n\r\n\t\tif (\r\n\t\t\tshowDistance === \"all\" ||\r\n\t\t\t(showDistance === \"self\" && this.#isObserved)\r\n\t\t) {\r\n\t\t\tconst unitSplit = getSetting(\"unit\").split(\",\");\r\n\t\t\tconst multiplier = Number(unitSplit[0]?.trim()) || 1;\r\n\t\t\tconst unit = unitSplit[1]?.trim() || game.system.gridUnits;\r\n\t\t\tconst decimals = Number(unitSplit[2]?.trim()) || 0;\r\n\t\t\tconst selected = canvas.tokens.controlled;\r\n\r\n\t\t\tlet isTarget = false;\r\n\t\t\tlet target = selected.length === 1 ? selected[0] : null;\r\n\r\n\t\t\tif (!target || target === token) {\r\n\t\t\t\ttarget = getUniqueTarget();\r\n\t\t\t\tisTarget = true;\r\n\t\t\t}\r\n\r\n\t\t\tif (target && target !== token) {\r\n\t\t\t\tdistance = {\r\n\t\t\t\t\tunit,\r\n\t\t\t\t\ticon: isTarget\r\n\t\t\t\t\t\t? '<i class=\"fa-solid fa-crosshairs-simple\"></i>'\r\n\t\t\t\t\t\t: '<i class=\"fa-solid fa-expand\"></i>',\r\n\t\t\t\t\trange: (token.distanceTo(target) * multiplier).toFixed(decimals),\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet status;\r\n\t\tif (!this.#isObserved || getSetting(\"see-status\")) {\r\n\t\t\tconst statuses = getSetting(\"status\")\r\n\t\t\t\t.split(\",\")\r\n\t\t\t\t.map((x) => x.trim())\r\n\t\t\t\t.filter(Boolean);\r\n\r\n\t\t\tif (statuses.length && hp.max) {\r\n\t\t\t\tconst max = hp.max + (useStamina ? sp.max : 0);\r\n\t\t\t\tconst current = hp.value + (useStamina ? sp.value : 0);\r\n\t\t\t\tconst ratio = Math.clamped(current / max, 0, 1);\r\n\t\t\t\tconst pick = (() => {\r\n\t\t\t\t\tconst length = statuses.length;\r\n\t\t\t\t\tif (getSetting(\"last-status\")) {\r\n\t\t\t\t\t\tif (ratio === 1) return length;\r\n\t\t\t\t\t\treturn Math.ceil(ratio * (length - 1));\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn Math.ceil(ratio * length);\r\n\t\t\t\t})();\r\n\r\n\t\t\t\tstatus = {\r\n\t\t\t\t\thue: ratio * ratio * 122 + 3,\r\n\t\t\t\t\tvalue:\r\n\t\t\t\t\t\tpick === 0\r\n\t\t\t\t\t\t\t? game.i18n.localize(\"EFFECT.StatusDead\")\r\n\t\t\t\t\t\t\t: statuses.at(pick - 1),\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet sharedData = {\r\n\t\t\tstatus,\r\n\t\t\tdistance,\r\n\t\t\tfontSize,\r\n\t\t\ttokenId: token.id,\r\n\t\t\ttype: actor.isOfType(\"creature\") ? \"creature\" : actor.type,\r\n\t\t};\r\n\r\n\t\tif (!this.#isObserved || (actor.isOfType(\"familiar\") && !actor.master))\r\n\t\t\treturn sharedData;\r\n\r\n\t\tconst { level, saves, isOwner, system, itemTypes } = actor;\r\n\t\tconst { resistances, weaknesses, immunities } = attributes;\r\n\r\n\t\tsharedData = {\r\n\t\t\t...sharedData,\r\n\t\t\tisOwner,\r\n\t\t\tisObserver: this.#isObserved,\r\n\t\t\tname: token.document.name,\r\n\t\t\thp,\r\n\t\t\tlevel,\r\n\t\t};\r\n\r\n\t\tif (actor.isOfType(\"army\")) {\r\n\t\t\tconst BASIC_WAR_ACTIONS_FOLDER = \"Vqp8b64uH35zkncy\";\r\n\t\t\tconst pack = game.packs.get(\"pf2e.kingmaker-features\");\r\n\t\t\tconst compendiumFeatures = (\r\n\t\t\t\t(await pack?.getDocuments({ type: \"campaignFeature\" })) ?? []\r\n\t\t\t).filter((d) => d instanceof Item && d.isOfType(\"campaignFeature\"));\r\n\r\n\t\t\tsharedData = {\r\n\t\t\t\t...sharedData,\r\n\t\t\t\tbasicWarActions: compendiumFeatures\r\n\t\t\t\t\t.filter(\r\n\t\t\t\t\t\t(d) =>\r\n\t\t\t\t\t\t\td.system.category === \"army-war-action\" &&\r\n\t\t\t\t\t\t\td.folder?.id === BASIC_WAR_ACTIONS_FOLDER,\r\n\t\t\t\t\t)\r\n\t\t\t\t\t.map(\r\n\t\t\t\t\t\t(i) =>\r\n\t\t\t\t\t\t\tnew CONFIG.Item.documentClass(i.toObject(true), {\r\n\t\t\t\t\t\t\t\tparent: this.actor,\r\n\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t)\r\n\t\t\t\t\t.filter((i) => i.isOfType(\"campaignFeature\")),\r\n\t\t\t};\r\n\r\n\t\t\treturn sharedData;\r\n\t\t}\r\n\r\n\t\tsharedData = {\r\n\t\t\t...sharedData,\r\n\t\t\tac: ac.value,\r\n\t\t\thasActions:\r\n\t\t\t\titemTypes.action.length ||\r\n\t\t\t\tsystem.actions?.filter((action) => action.visible !== false).length,\r\n\t\t};\r\n\r\n\t\tconst showRanks = getSetting(\"ranks\");\r\n\r\n\t\tfunction getStatistic(stat, type, stats) {\r\n\t\t\tconst slug = stat.slug;\r\n\t\t\tconst value = type === \"bonus\" ? modifier(stat.mod) : stat.dc.value;\r\n\t\t\treturn {\r\n\t\t\t\tslug,\r\n\t\t\t\tvalue,\r\n\t\t\t\tlabel: stats[slug].label,\r\n\t\t\t\ticon: stats[slug].icon,\r\n\t\t\t\trank: showRanks && RANKS[stat.rank],\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tfunction toIWR(category, header) {\r\n\t\t\tif (!category.length) return \"\";\r\n\t\t\tconst rows = category\r\n\t\t\t\t.map((x) => toInfo(x.label.replace(\"-\", \" \").titleCase()))\r\n\t\t\t\t.join(\"\");\r\n\t\t\tif (!header) return rows;\r\n\t\t\treturn `<li>${game.i18n.localize(header)}<ul>${rows}</ul></li>`;\r\n\t\t}\r\n\r\n\t\tif (actor.isOfType(\"hazard\")) {\r\n\t\t\tconst { hardness, emitsSound, stealth } = attributes;\r\n\r\n\t\t\treturn {\r\n\t\t\t\t...sharedData,\r\n\t\t\t\thardness,\r\n\t\t\t\temitsSound: emitsSound.toString().capitalize(),\r\n\t\t\t\timmunities: toIWR(immunities),\r\n\t\t\t\tweaknesses: toIWR(weaknesses),\r\n\t\t\t\tresistances: toIWR(resistances),\r\n\t\t\t\tstealth: {\r\n\t\t\t\t\tvalue: stealth.value,\r\n\t\t\t\t\tdetails: await enrichHTML(stealth.details, actor),\r\n\t\t\t\t},\r\n\t\t\t\tsaves:\r\n\t\t\t\t\tsavesSetting !== \"none\" &&\r\n\t\t\t\t\t[\"fortitude\", \"reflex\", \"will\"].map((slug) => {\r\n\t\t\t\t\t\tconst save = saves[slug];\r\n\t\t\t\t\t\tif (!save)\r\n\t\t\t\t\t\t\treturn { slug, label: SAVES[slug].label, icon: SAVES[slug].icon };\r\n\t\t\t\t\t\treturn getStatistic(save, savesSetting, SAVES);\r\n\t\t\t\t\t}),\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tsharedData = {\r\n\t\t\t...sharedData,\r\n\t\t\tsidebarTitles: {\r\n\t\t\t\tactions: `${MODULE_ID}.actions.title`,\r\n\t\t\t\titems: `${MODULE_ID}.items.title`,\r\n\t\t\t\tspells: `${MODULE_ID}.spells.title`,\r\n\t\t\t\tskills: `${MODULE_ID}.skills.title`,\r\n\t\t\t\textras: `${MODULE_ID}.extras.title`,\r\n\t\t\t},\r\n\t\t\thasItems: actor.inventory.size,\r\n\t\t};\r\n\r\n\t\tif (actor.isOfType(\"vehicle\")) {\r\n\t\t\tconst { hardness, collisionDC, collisionDamage } = attributes;\r\n\t\t\tconst { details } = system;\r\n\t\t\tconst { crew, passengers, pilotingCheck, speed } = details;\r\n\r\n\t\t\treturn {\r\n\t\t\t\t...sharedData,\r\n\t\t\t\thardness,\r\n\t\t\t\tcrew,\r\n\t\t\t\tpassengers,\r\n\t\t\t\tpilotingCheck,\r\n\t\t\t\tspeed,\r\n\t\t\t\tcollisionDC: collisionDC.value,\r\n\t\t\t\tcollisionDamage: collisionDamage.value,\r\n\t\t\t\timmunities: toIWR(immunities),\r\n\t\t\t\tweaknesses: toIWR(weaknesses),\r\n\t\t\t\tresistances: toIWR(resistances),\r\n\t\t\t\tfortitude: getStatistic(saves.fortitude, savesSetting, SAVES),\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tconst showDeath = getSetting(\"show-death\");\r\n\t\tconst { heroPoints } = actor;\r\n\t\tconst { resources, perception, details } = system;\r\n\t\tconst { wounded, dying, shield, speed, adjustment } = attributes;\r\n\r\n\t\tfunction toInfo(str) {\r\n\t\t\treturn `<li>${str.trim()}</li>`;\r\n\t\t}\r\n\r\n\t\tfunction sort(a, b) {\r\n\t\t\treturn localeCompare(a, b);\r\n\t\t}\r\n\r\n\t\tconst languages = details?.languages?.value\r\n\t\t\t.map((x) => game.i18n.localize(CONFIG.PF2E.languages[x]))\r\n\t\t\t.filter(Boolean)\r\n\t\t\t.sort(sort)\r\n\t\t\t.map(toInfo)\r\n\t\t\t.join(\"\");\r\n\r\n\t\tconst speeds = SPEEDS.map(({ type, icon }, index) => ({\r\n\t\t\tindex,\r\n\t\t\ticon,\r\n\t\t\tlabel: game.i18n.localize(\r\n\t\t\t\tCONFIG.PF2E.speedTypes[type] ?? \"PF2E.SpeedTypesLand\",\r\n\t\t\t),\r\n\t\t\tvalue:\r\n\t\t\t\t(index === 0\r\n\t\t\t\t\t? speed.total\r\n\t\t\t\t\t: speed.otherSpeeds.find((s) => s.type === type)?.total) || 0,\r\n\t\t}));\r\n\r\n\t\tconst selectedSpeed = getFlag(actor, `speeds.selected.${game.user.id}`);\r\n\t\tconst mainSpeed = (() => {\r\n\t\t\tlet index = 0;\r\n\t\t\tif (selectedSpeed !== undefined) index = selectedSpeed;\r\n\t\t\telse if (getSetting(\"force-speed\") || speeds[0].value === 0) {\r\n\t\t\t\tconst base = { index: 0, value: speeds[0].value };\r\n\t\t\t\tindex = speeds.reduce(\r\n\t\t\t\t\t(prev, { value }, index) =>\r\n\t\t\t\t\t\tvalue > prev.value ? { index, value } : prev,\r\n\t\t\t\t\tbase,\r\n\t\t\t\t).index;\r\n\t\t\t}\r\n\t\t\treturn speeds.splice(index, 1)[0];\r\n\t\t})();\r\n\r\n\t\tlet otherSpeeds = speeds\r\n\t\t\t.map(\r\n\t\t\t\t({ value, label, index }) =>\r\n\t\t\t\t\t`<li><a data-value=\"${index}\">${label}: ${value}</a></li>`,\r\n\t\t\t)\r\n\t\t\t.join(\"\");\r\n\t\tif (speed.details)\r\n\t\t\totherSpeeds += `<li>${game.i18n.localize(\"PF2E.DetailsHeading\")}: ${\r\n\t\t\t\tspeed.details\r\n\t\t\t}</li>`;\r\n\r\n\t\treturn {\r\n\t\t\t...sharedData,\r\n\t\t\tsp: useStamina ? sp : { max: 0 },\r\n\t\t\thero: heroPoints,\r\n\t\t\tdying,\r\n\t\t\twounded,\r\n\t\t\tshield,\r\n\t\t\tresolve: resources.resolve,\r\n\t\t\tadjustment,\r\n\t\t\talliance: ALLIANCES[getAlliance(actor).alliance],\r\n\t\t\tisCharacter,\r\n\t\t\tshowDeathLine:\r\n\t\t\t\tisCharacter && (showDeath === \"always\" || dying.value || wounded.value),\r\n\t\t\tdigitalPips: getSetting(\"pips\"),\r\n\t\t\thasCover: this.hasCover,\r\n\t\t\tsaves:\r\n\t\t\t\tsavesSetting !== \"none\" &&\r\n\t\t\t\t[\"fortitude\", \"reflex\", \"will\"].map((slug) =>\r\n\t\t\t\t\tgetStatistic(saves[slug], savesSetting, SAVES),\r\n\t\t\t\t),\r\n\t\t\tothers:\r\n\t\t\t\tothersSetting !== \"none\" &&\r\n\t\t\t\t[\"perception\", \"stealth\", \"athletics\"].map((slug) =>\r\n\t\t\t\t\tgetStatistic(actor.getStatistic(slug), othersSetting, SKILLS),\r\n\t\t\t\t),\r\n\t\t\tspeeds: {\r\n\t\t\t\tmain: mainSpeed,\r\n\t\t\t\tothers: otherSpeeds,\r\n\t\t\t},\r\n\t\t\tiwr:\r\n\t\t\t\ttoIWR(immunities, \"PF2E.ImmunitiesLabel\") +\r\n\t\t\t\ttoIWR(weaknesses, \"PF2E.WeaknessesLabel\") +\r\n\t\t\t\ttoIWR(resistances, \"PF2E.ResistancesLabel\"),\r\n\t\t\tsenses: perception.senses\r\n\t\t\t\t.map((x) => x.label)\r\n\t\t\t\t?.map(toInfo)\r\n\t\t\t\t.join(\"\"),\r\n\t\t\tlanguages,\r\n\t\t\thasSpells: actor.spellcasting.some(\r\n\t\t\t\t(entry) => entry.category !== \"items\" || entry.id.endsWith(\"-casting\"),\r\n\t\t\t),\r\n\t\t\thasNotes:\r\n\t\t\t\t!isCharacter &&\r\n\t\t\t\t(system.details.publicNotes ||\r\n\t\t\t\t\t(system.details.privateNotes && isOwner)),\r\n\t\t};\r\n\t}\r\n\r\n\tclose(options = {}) {\r\n\t\tthis.setToken(null);\r\n\t\tthis.unlock(true);\r\n\t\tthis.#softLock = false;\r\n\r\n\t\tthis.#cancelDelay();\r\n\r\n\t\tconst states = Application.RENDER_STATES;\r\n\t\tif (\r\n\t\t\t!options.force &&\r\n\t\t\t![states.RENDERED, states.ERROR].includes(this._state)\r\n\t\t)\r\n\t\t\treturn;\r\n\r\n\t\tthis._state = states.CLOSING;\r\n\r\n\t\tconst el = this.element;\r\n\t\tif (!el) {\r\n\t\t\tthis._state = states.CLOSED;\r\n\t\t\treturn this._state;\r\n\t\t}\r\n\r\n\t\tel.css({ minHeight: 0 });\r\n\r\n\t\tfor (const cls of this.constructor._getInheritanceChain()) {\r\n\t\t\tHooks.call(`close${cls.name}`, this, el);\r\n\t\t}\r\n\r\n\t\tel.remove();\r\n\r\n\t\tthis._element = null;\r\n\t\tthis._state = states.CLOSED;\r\n\t\tdelete ui.windows[this.appId];\r\n\t}\r\n\r\n\tasync _render(force = false, options = {}) {\r\n\t\tlet sidebarType;\r\n\t\tlet sidebarScrolltop;\r\n\t\tlet popup;\r\n\t\tlet popupScrollTop;\r\n\t\tlet filter;\r\n\r\n\t\tif (this.#lastToken === this.#token) {\r\n\t\t\tconst sidebar = this.sidebar[0];\r\n\t\t\tif (sidebar) {\r\n\t\t\t\tsidebarType = sidebar.dataset.type;\r\n\t\t\t\tsidebarScrolltop = sidebar.scrollTop;\r\n\t\t\t\tconst filterHeader = sidebar.querySelector(\".sidebar-header\");\r\n\t\t\t\tif (filterHeader.classList.contains(\"show\"))\r\n\t\t\t\t\tfilter = filterHeader.querySelector(\" input\").value.trim();\r\n\t\t\t}\r\n\r\n\t\t\tpopup = this.popup[0];\r\n\t\t\tif (popup) popupScrollTop = popup.scrollTop;\r\n\t\t}\r\n\r\n\t\tawait super._render(force, options);\r\n\t\tui.windows[this.appId] = this;\r\n\r\n\t\tif (sidebarType) {\r\n\t\t\tconst sidebar = await this.#openSidebar(sidebarType, filter);\r\n\t\t\tif (sidebarScrolltop > 0) sidebar.scrollTop(sidebarScrolltop);\r\n\t\t}\r\n\r\n\t\tif (popup) {\r\n\t\t\tthis.element.append(popup);\r\n\t\t\tif (popupScrollTop > 0) popup.scrollTop = popupScrollTop;\r\n\t\t}\r\n\r\n\t\tthis.#lastToken = this.#token;\r\n\r\n\t\tif (!this.inner.length) return;\r\n\t\tif (getSetting(\"autolock\") === \"render\") this.lock();\r\n\t}\r\n\r\n\trender() {\r\n\t\tif (this.actor) super.render(true);\r\n\t}\r\n\r\n\t_injectHTML(html) {\r\n\t\t$(\"body\").append(html);\r\n\t\tthis._element = html;\r\n\t}\r\n\r\n\tsetPosition() {\r\n\t\tconst token = this.#token;\r\n\t\tif (!token) return;\r\n\r\n\t\tconst element = this.element[0];\r\n\t\tconst scale = token.worldTransform.a;\r\n\t\tconst hud = element.getBoundingClientRect();\r\n\t\tconst targetCoords = canvas.clientCoordinatesFromCanvas(\r\n\t\t\ttoken.document._source,\r\n\t\t);\r\n\t\tconst target = {\r\n\t\t\tx: targetCoords.x,\r\n\t\t\ty: targetCoords.y,\r\n\t\t\twidth: token.hitArea.width * scale,\r\n\t\t\theight: token.hitArea.height * scale,\r\n\t\t\tget right() {\r\n\t\t\t\treturn this.x + this.width;\r\n\t\t\t},\r\n\t\t\tget bottom() {\r\n\t\t\t\treturn this.y + this.height;\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\tlet coords;\r\n\r\n\t\tconst positions = this.#isObserved\r\n\t\t\t? POSITIONS[getSetting(\"position\")].slice()\r\n\t\t\t: POSITIONS[getSetting(\"small-position\")].slice();\r\n\r\n\t\twhile (positions.length && !coords) {\r\n\t\t\tconst position = positions.shift();\r\n\r\n\t\t\tif (position === \"left\") {\r\n\t\t\t\tcoords = {\r\n\t\t\t\t\tx: target.x - hud.width,\r\n\t\t\t\t\ty: postionFromTargetY(hud, target),\r\n\t\t\t\t};\r\n\t\t\t\tif (coords.x < 0) coords = undefined;\r\n\t\t\t} else if (position === \"right\") {\r\n\t\t\t\tcoords = {\r\n\t\t\t\t\tx: target.right,\r\n\t\t\t\t\ty: postionFromTargetY(hud, target),\r\n\t\t\t\t};\r\n\t\t\t\tif (coords.x + hud.width > window.innerWidth) coords = undefined;\r\n\t\t\t} else if (position === \"top\") {\r\n\t\t\t\tcoords = {\r\n\t\t\t\t\tx: postionFromTargetX(hud, target),\r\n\t\t\t\t\ty: target.y - hud.height,\r\n\t\t\t\t};\r\n\t\t\t\tif (coords.y < 0) coords = undefined;\r\n\t\t\t} else if (position === \"bottom\") {\r\n\t\t\t\tcoords = {\r\n\t\t\t\t\tx: postionFromTargetX(hud, target),\r\n\t\t\t\t\ty: target.bottom,\r\n\t\t\t\t};\r\n\t\t\t\tif (coords.y + hud.height > window.innerHeight) coords = undefined;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (coords) {\r\n\t\t\telement.style.left = `${coords.x}px`;\r\n\t\t\telement.style.top = `${coords.y}px`;\r\n\t\t}\r\n\r\n\t\treturn coords;\r\n\t}\r\n\r\n\tlock() {\r\n\t\tthis.#lock = true;\r\n\t}\r\n\r\n\tunlock(force) {\r\n\t\tif (!force && (this.sidebar.length || getSetting(\"autolock\") !== \"none\"))\r\n\t\t\treturn;\r\n\t\tthis.#lock = false;\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tconst token = this.#token;\r\n\t\tconst actor = token?.actor;\r\n\t\tif (!actor) return;\r\n\r\n\t\tconst isOwner = token.isOwner;\r\n\t\tconst ChatMessagePF2e = ChatMessage.implementation;\r\n\r\n\t\tif (getSetting(\"tooltips\")) {\r\n\t\t\thtml.find(\".inner [data-tooltip]\").attr(\"data-tooltip\", \"\");\r\n\t\t}\r\n\r\n\t\thtml.find(\"[data-action=show-notes\").on(\"click\", async (event) => {\r\n\t\t\tevent.preventDefault();\r\n\r\n\t\t\tconst { publicNotes, privateNotes, blurb } = actor.system.details;\r\n\t\t\tconst whitelist = Object.keys(CONFIG.PF2E.creatureTraits);\r\n\t\t\tconst traits = actor.system.traits.value\r\n\t\t\t\t.filter(whitelist.includes, whitelist)\r\n\t\t\t\t.map((trait) => ({\r\n\t\t\t\t\tlabel: game.i18n.localize(CONFIG.PF2E.creatureTraits[trait]) ?? trait,\r\n\t\t\t\t\tdescription:\r\n\t\t\t\t\t\tgame.i18n.localize(CONFIG.PF2E.traitsDescriptions[trait]) ?? \"\",\r\n\t\t\t\t}));\r\n\r\n\t\t\tconst content = await renderTemplate(templatePath(\"show-notes\"), {\r\n\t\t\t\ttraits,\r\n\t\t\t\tblurb: blurb.trim(),\r\n\t\t\t\tpublicNotes: publicNotes.trim(),\r\n\t\t\t\tprivateNotes: isOwner && privateNotes.trim(),\r\n\t\t\t});\r\n\r\n\t\t\tpopup(\r\n\t\t\t\t`${actor.name} - ${game.i18n.localize(\"PF2E.NPC.NotesTab\")}`,\r\n\t\t\t\tcontent,\r\n\t\t\t\tactor,\r\n\t\t\t);\r\n\t\t});\r\n\r\n\t\thtml.on(\"mousedown\", () => this.bringToTop());\r\n\r\n\t\thtml.on(\"mouseenter\", () => {\r\n\t\t\tif (!html.find(\".inner\").length) return;\r\n\t\t\tif (getSetting(\"autolock\") === \"hover\") this.lock();\r\n\t\t\tthis.#softLock = true;\r\n\t\t});\r\n\r\n\t\thtml.on(\"mouseleave\", () => {\r\n\t\t\tthis.#softLock = false;\r\n\t\t\tif (this.#lock || this.#hoveredToken) return;\r\n\t\t\tthis.close();\r\n\t\t});\r\n\r\n\t\thtml.on(\"dragover\", () => {\r\n\t\t\tif (\r\n\t\t\t\ttoken.isOwner &&\r\n\t\t\t\thtml.find(\"> .sidebar.extras\").length &&\r\n\t\t\t\t!html.find(\"> .popup\").length\r\n\t\t\t)\r\n\t\t\t\treturn;\r\n\t\t\thtml.css(\"opacity\", 0.1);\r\n\t\t\thtml.css(\"pointerEvents\", \"none\");\r\n\t\t\twindow.addEventListener(\r\n\t\t\t\t\"dragend\",\r\n\t\t\t\t() => {\r\n\t\t\t\t\thtml.css(\"opacity\", 1);\r\n\t\t\t\t\thtml.css(\"pointerEvents\", \"\");\r\n\t\t\t\t},\r\n\t\t\t\t{ once: true },\r\n\t\t\t);\r\n\t\t});\r\n\r\n\t\tconst infos = html.find(\"[data-action=show-info]\");\r\n\t\tconst infosElements = isOwner ? infos.filter(\":not(.speeds)\") : infos;\r\n\t\tinfosElements.on(\"click\", (event) => {\r\n\t\t\tconst target = event.currentTarget;\r\n\t\t\tconst content = target.dataset.tooltipContent;\r\n\r\n\t\t\tif (target.classList.contains(\"stealth\")) {\r\n\t\t\t\tthis.#createHUDLockedListTooltip({ content, event, direction: \"DOWN\" });\r\n\t\t\t} else {\r\n\t\t\t\tcreateTooltip({ target, content, direction: \"UP\" });\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\thtml\r\n\t\t\t.find(\"[data-action=open-sidebar]\")\r\n\t\t\t.on(\"click\", this.#openSidebar.bind(this));\r\n\r\n\t\t// IS OWNER\r\n\t\tif (!isOwner) return;\r\n\r\n\t\thtml\r\n\t\t\t.find(\"[data-action=toggle-adjustment]\")\r\n\t\t\t.on(\"click contextmenu\", (event) => {\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tconst adjustment = event.type === \"click\" ? \"elite\" : \"weak\";\r\n\t\t\t\tactor.applyAdjustment(\r\n\t\t\t\t\tactor.system.attributes.adjustment === adjustment ? null : adjustment,\r\n\t\t\t\t);\r\n\t\t\t});\r\n\r\n\t\thtml.find(\"[data-action=toggle-alliance]\").on(\"click\", (event) => {\r\n\t\t\tconst { originalAlliance, defaultAlliance } = getAlliance(actor);\r\n\r\n\t\t\tconst content = [\r\n\t\t\t\t{\r\n\t\t\t\t\tvalue: \"default\",\r\n\t\t\t\t\tlabel: game.i18n.format(\"PF2E.Actor.Creature.Alliance.Default\", {\r\n\t\t\t\t\t\talliance: game.i18n.localize(ALLIANCES[defaultAlliance].label),\r\n\t\t\t\t\t}),\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\tvalue: \"opposition\",\r\n\t\t\t\t\tlabel: game.i18n.localize(ALLIANCES.opposition.label),\r\n\t\t\t\t},\r\n\t\t\t\t{ value: \"party\", label: game.i18n.localize(ALLIANCES.party.label) },\r\n\t\t\t\t{\r\n\t\t\t\t\tvalue: \"neutral\",\r\n\t\t\t\t\tlabel: game.i18n.localize(ALLIANCES.neutral.label),\r\n\t\t\t\t},\r\n\t\t\t];\r\n\r\n\t\t\tthis.#createHUDLockedListTooltip({\r\n\t\t\t\tcontent,\r\n\t\t\t\tevent,\r\n\t\t\t\tselected: originalAlliance,\r\n\t\t\t\tonClick: (value) => {\r\n\t\t\t\t\tif (value === \"default\")\r\n\t\t\t\t\t\tactor.update({ \"system.details.-=alliance\": true });\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tactor.update({\r\n\t\t\t\t\t\t\t\"system.details.alliance\": value === \"neutral\" ? null : value,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\thtml.find(\"[data-action=collision-dc]\").on(\"click\", (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tconst dc = actor.system.attributes.collisionDC.value || 15;\r\n\t\t\tChatMessagePF2e.create({\r\n\t\t\t\tcontent: `@Check[type:reflex|dc:${dc}]`,\r\n\t\t\t\tspeaker: ChatMessagePF2e.getSpeaker({ actor }),\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\thtml.find(\"[data-action=collision-damage]\").on(\"click\", async (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tlet formula = (\r\n\t\t\t\tactor.system.attributes.collisionDamage.value || \"1d6\"\r\n\t\t\t).trim();\r\n\t\t\tif (!Number.isNaN(Number(formula.at(-1)))) formula += \"[bludgeoning]\";\r\n\t\t\tconst DamageRoll = getDamageRollClass();\r\n\t\t\tconst roll = await new DamageRoll(formula).evaluate({ async: true });\r\n\t\t\tChatMessagePF2e.create({\r\n\t\t\t\tflavor: `<strong>${game.i18n.localize(\r\n\t\t\t\t\t\"PF2E.vehicle.collisionDamageLabel\",\r\n\t\t\t\t)}</strong>`,\r\n\t\t\t\tspeaker: ChatMessagePF2e.getSpeaker({ actor }),\r\n\t\t\t\ttype: CONST.CHAT_MESSAGE_TYPES.ROLL,\r\n\t\t\t\tsound: \"sounds/dice.wav\",\r\n\t\t\t\trolls: [roll],\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\thtml.find(\"input\").on(\"change\", async (event) => {\r\n\t\t\tconst target = event.currentTarget;\r\n\t\t\tconst value = target.valueAsNumber;\r\n\t\t\tconst attr = target.name;\r\n\r\n\t\t\ttarget.blur();\r\n\r\n\t\t\tif (attr !== \"shield.value\") await actor.update({ [attr]: value });\r\n\t\t\telse await actor.heldShield.update({ \"system.hp.value\": value });\r\n\t\t});\r\n\r\n\t\thtml.find(\"[data-action=toggle-hero]\").on(\"click contextmenu\", (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tconst { max, value } = actor.heroPoints;\r\n\r\n\t\t\tconst change = event.type === \"click\" ? 1 : -1;\r\n\t\t\tconst newValue = Math.clamped(value + change, 0, max);\r\n\r\n\t\t\tif (newValue !== value)\r\n\t\t\t\tactor.update({ \"system.resources.heroPoints.value\": newValue });\r\n\t\t});\r\n\r\n\t\thtml.find(\"[data-action=raise-shield]\").on(\"click\", (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tgame.pf2e.actions.raiseAShield({ actors: [actor], tokens: [token] });\r\n\t\t});\r\n\r\n\t\thtml.find(\"[data-action=take-cover]\").on(\"click\", async (event) => {\r\n\t\t\tevent.preventDefault();\r\n\r\n\t\t\tconst existing = getCoverEffect(actor);\r\n\r\n\t\t\tif (existing) existing.delete();\r\n\t\t\telse\r\n\t\t\t\tgame.pf2e.actions\r\n\t\t\t\t\t.get(\"take-cover\")\r\n\t\t\t\t\t.use({ actors: [actor], tokens: [token] });\r\n\t\t});\r\n\r\n\t\thtml.find(\"[data-action=roll-save]\").on(\"click\", (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tconst save = event.currentTarget.dataset.save;\r\n\t\t\tactor.saves[save].roll({ event });\r\n\t\t});\r\n\r\n\t\thtml.find(\"[data-action=roll-other]\").on(\"click\", (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tconst slug = event.currentTarget.dataset.slug;\r\n\t\t\tif (slug !== \"athletics\") {\r\n\t\t\t\tconst { ctrlKey, metaKey, shiftKey } = event;\r\n\t\t\t\t// biome-ignore lint/style/noParameterAssign: i say so\r\n\t\t\t\tevent = new MouseEvent(\"click\", {\r\n\t\t\t\t\tctrlKey: !ctrlKey,\r\n\t\t\t\t\tmetaKey,\r\n\t\t\t\t\tshiftKey,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tactor.getStatistic(slug)?.roll({ event });\r\n\t\t});\r\n\r\n\t\thtml.find(\"[data-action=recovery-check]\").on(\"click\", (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tactor.rollRecovery(event);\r\n\t\t});\r\n\r\n\t\thtml\r\n\t\t\t.find(\"[data-action=toggle-dying], [data-action=toggle-wounded]\")\r\n\t\t\t.on(\"click contextmenu\", (event) => {\r\n\t\t\t\tevent.preventDefault();\r\n\r\n\t\t\t\tconst condition =\r\n\t\t\t\t\tevent.currentTarget.dataset.action === \"toggle-dying\"\r\n\t\t\t\t\t\t? \"dying\"\r\n\t\t\t\t\t\t: \"wounded\";\r\n\t\t\t\tconst max = actor.system.attributes[condition]?.max;\r\n\r\n\t\t\t\tif (!max) return;\r\n\t\t\t\tif (event.type === \"click\") actor.increaseCondition(condition, { max });\r\n\t\t\t\telse actor.decreaseCondition(condition);\r\n\t\t\t});\r\n\r\n\t\thtml.find(\"[data-action=use-resolve]\").on(\"click\", (event) => {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tuseResolve(actor);\r\n\t\t});\r\n\r\n\t\tinfos.filter(\".speeds\").on(\"click\", (event) => {\r\n\t\t\tthis.#createHUDLockedListTooltip({\r\n\t\t\t\tevent,\r\n\t\t\t\tcontent: event.currentTarget.dataset.tooltipContent,\r\n\t\t\t\tdirection: \"UP\",\r\n\t\t\t\tonClick: (index) => {\r\n\t\t\t\t\tsetFlag(actor, `speeds.selected.${game.user.id}`, Number(index));\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t#createHUDLockedListTooltip({\r\n\t\tcontent,\r\n\t\tevent,\r\n\t\tonClick,\r\n\t\tselected,\r\n\t\tdirection,\r\n\t}) {\r\n\t\tcreateTooltip({\r\n\t\t\tcontent,\r\n\t\t\ttarget: event.currentTarget,\r\n\t\t\tdirection,\r\n\t\t\tselected,\r\n\t\t\tlocked: true,\r\n\t\t\tonCreate: () => this.lock(),\r\n\t\t\tonClick,\r\n\t\t\tonDismiss: () => this.unlock(),\r\n\t\t});\r\n\t}\r\n\r\n\tasync showFilter() {\r\n\t\tlet sidebar = this.sidebar;\r\n\t\tif (!sidebar.length) return;\r\n\t\tif (!sidebar.find(\".sidebar-header\").hasClass(\"show\"))\r\n\t\t\tsidebar = await this.#openSidebar(sidebar.data().type, \"\");\r\n\t\tsidebar.find(\".sidebar-header\").find(\"input\").focus().select();\r\n\t\tsidebar.scrollTop(0);\r\n\t}\r\n\r\n\tasync #openSidebar(sidebarType, filter) {\r\n\t\tconst type =\r\n\t\t\ttypeof sidebarType === \"string\"\r\n\t\t\t\t? sidebarType\r\n\t\t\t\t: sidebarType.currentTarget.dataset.type;\r\n\r\n\t\tlet element = this.element;\r\n\t\tlet sidebar = this.sidebar;\r\n\t\tconst action = sidebar[0]?.dataset.type;\r\n\r\n\t\tsidebar.remove();\r\n\t\telement.find(\"[data-action=open-sidebar]\").removeClass(\"active\");\r\n\r\n\t\tif (action === type && filter === undefined) {\r\n\t\t\tthis.unlock();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst token = this.#token;\r\n\t\tconst actor = token.actor;\r\n\t\tconst showFilter = filter !== undefined || getSetting(\"filter\");\r\n\t\tconst { getData, addListeners } = SIDEBARS[type];\r\n\r\n\t\tconst toggles = (() => {\r\n\t\t\tconst placement = PLACEMENT_BY_TYPE[type];\r\n\t\t\tif (!placement) return;\r\n\r\n\t\t\treturn Object.values(this.actor.synthetics.toggles).flatMap((domain) =>\r\n\t\t\t\tObject.values(domain).filter(\r\n\t\t\t\t\t(toggle) => toggle.placement === placement,\r\n\t\t\t\t),\r\n\t\t\t);\r\n\t\t})();\r\n\r\n\t\tconst data =\r\n\t\t\t(await getData({\r\n\t\t\t\thud: this,\r\n\t\t\t\tactor,\r\n\t\t\t\ttoken,\r\n\t\t\t\tfilter: filter?.toLowerCase(),\r\n\t\t\t})) ?? {};\r\n\r\n\t\tif (!data.contentData && !showFilter && !toggles.length) {\r\n\t\t\treturn ui.notifications.warn(\r\n\t\t\t\tlocalize(`${type}.empty`, { name: this.#token.name }),\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tconst contentData = {\r\n\t\t\t...(data.contentData ?? {}),\r\n\t\t\tisGM: game.user.isGM,\r\n\t\t\tisCharacter: actor.isOfType(\"character\"),\r\n\t\t\tisOwner: actor.isOwner,\r\n\t\t\tisCreature: actor.isOfType(\"creature\"),\r\n\t\t};\r\n\r\n\t\tthis.lock();\r\n\r\n\t\telement\r\n\t\t\t.find(`[data-action=open-sidebar][data-type=${type}]`)\r\n\t\t\t.addClass(\"active\");\r\n\t\telement = element[0];\r\n\r\n\t\tconst classes = data.classes ?? [];\r\n\t\tclasses.push(type);\r\n\t\tif (!getSetting(\"scrollbar\")) classes.push(\"no-scrollbar\");\r\n\t\tif (data.doubled) classes.push(\"doubled\");\r\n\r\n\t\tconst style = data.style ?? {};\r\n\t\tstyle[\"--max-height\"] = getSetting(\"height\").trim() || \"100%\";\r\n\r\n\t\tconst tmp = document.createElement(\"div\");\r\n\t\ttmp.innerHTML = await renderTemplate(templatePath(\"sidebar\"), {\r\n\t\t\tclasses: classes.join(\" \"),\r\n\t\t\tstyle: Object.entries(style)\r\n\t\t\t\t.map(([key, value]) => `${key}: ${value}`)\r\n\t\t\t\t.join(\"; \"),\r\n\t\t\ttype,\r\n\t\t\tfilter,\r\n\t\t\tfilterLabel: localize(\"filter\"),\r\n\t\t\tshowFilter,\r\n\t\t\ttoggles,\r\n\t\t\tisOwner: actor.isOwner,\r\n\t\t\tcontent: (\r\n\t\t\t\tawait renderTemplate(templatePath(`sidebars/${type}`), contentData)\r\n\t\t\t).trim(),\r\n\t\t});\r\n\r\n\t\tsidebar = tmp.firstElementChild;\r\n\t\telement.append(sidebar);\r\n\r\n\t\tconst rect = sidebar.getBoundingClientRect();\r\n\t\tconst target = element.getBoundingClientRect();\r\n\r\n\t\tlet left;\r\n\t\tconst position = getSetting(\"position\");\r\n\t\tif (position === \"left\") {\r\n\t\t\tleft = target.x - rect.width;\r\n\t\t\tif (left < 0) left = target.right;\r\n\t\t} else {\r\n\t\t\tleft = target.right;\r\n\t\t\tif (left + rect.width > window.innerWidth) left = target.x - rect.width;\r\n\t\t}\r\n\r\n\t\tconst elPadding = parseInt(window.getComputedStyle(element).padding);\r\n\t\tconst top = postionFromTargetY(rect, target, elPadding);\r\n\r\n\t\tsidebar.style.left = `${left}px`;\r\n\t\tsidebar.style.top = `${top}px`;\r\n\r\n\t\tsidebar = $(sidebar);\r\n\r\n\t\tsidebar\r\n\t\t\t.find(\".sidebar-header [data-action=sidebar-filter-clear]\")\r\n\t\t\t.on(\"click\", (event) => {\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tsidebar.find(\".sidebar-header [data-action=sidebar-filter]\").val(\"\");\r\n\t\t\t\tthis.#openSidebar(type, \"\");\r\n\t\t\t});\r\n\r\n\t\tsidebar\r\n\t\t\t.find(\".sidebar-header [data-action=sidebar-filter]\")\r\n\t\t\t.on(\"keydown\", (event) => {\r\n\t\t\t\tif (event.key === \"Enter\")\r\n\t\t\t\t\tthis.#openSidebar(type, event.currentTarget.value.trim());\r\n\t\t\t});\r\n\r\n\t\tsidebar.find(\".sidebar-toggles [data-action]\").on(\"change\", (event) => {\r\n\t\t\tconst toggle = event.currentTarget.closest(\".toggle\");\r\n\t\t\tconst { domain, option, itemId } = toggle.dataset;\r\n\t\t\tconst suboption = toggle.querySelector(\"select\")?.value ?? null;\r\n\t\t\tactor.toggleRollOption(\r\n\t\t\t\tdomain,\r\n\t\t\t\toption,\r\n\t\t\t\titemId ?? null,\r\n\t\t\t\ttoggle.querySelector(\"input\").checked,\r\n\t\t\t\tsuboption,\r\n\t\t\t);\r\n\t\t});\r\n\r\n\t\taddListeners({ el: sidebar, actor, token, hud: this });\r\n\r\n\t\tHooks.callAll(\"renderHUDSidebar\", type, sidebar, this);\r\n\r\n\t\treturn sidebar;\r\n\t}\r\n}\r\n\r\nfunction postionFromTargetY(el, target, margin = 0) {\r\n\tlet y = target.y + target.height / 2 - el.height / 2;\r\n\tif (y + el.height > window.innerHeight)\r\n\t\ty = window.innerHeight - el.height - margin;\r\n\tif (y < 0) y = margin;\r\n\treturn y;\r\n}\r\n\r\nfunction postionFromTargetX(el, target) {\r\n\tlet x = target.x + target.width / 2 - el.width / 2;\r\n\tif (x + el.width > window.innerWidth) y = window.innerWidth - el.width;\r\n\tif (x < 0) x = 0;\r\n\treturn x;\r\n}\r\n\r\nfunction getAlliance(actor) {\r\n\tconst allianceSource = actor._source.system.details?.alliance;\r\n\tconst alliance =\r\n\t\tallianceSource === null ? \"neutral\" : allianceSource ?? \"default\";\r\n\tconst defaultAlliance = actor.hasPlayerOwner ? \"party\" : \"opposition\";\r\n\treturn {\r\n\t\tdefaultAlliance,\r\n\t\toriginalAlliance: alliance,\r\n\t\talliance: alliance === \"default\" ? defaultAlliance : alliance,\r\n\t};\r\n}\r\n", "import { HUD } from \"./hud.js\";\r\n\r\nexport const MODULE_ID = \"pf2e-token-hud\";\r\n\r\nlet hud = null;\r\nexport function getHud(element = false) {\r\n\treturn element ? hud?.element : hud;\r\n}\r\n\r\nexport function enableModule(enabled) {\r\n\tif (enabled && !hud) {\r\n\t\thud = new HUD();\r\n\t} else if (!enabled && hud) {\r\n\t\thud.delete();\r\n\t\thud = null;\r\n\t}\r\n}\r\n\r\nexport function getSetting(setting) {\r\n\treturn game.settings.get(MODULE_ID, setting);\r\n}\r\n\r\nexport function localize(...args) {\r\n\tconst data = args.at(-1);\r\n\tconst useFormat = typeof data === \"object\";\r\n\r\n\tconst keys = useFormat ? args.slice(0, -1) : args;\r\n\tkeys.unshift(MODULE_ID);\r\n\r\n\treturn game.i18n[useFormat ? \"format\" : \"localize\"](keys.join(\".\"), data);\r\n}\r\n\r\nexport function hasFeat(actor, uuid) {\r\n\treturn actor.itemTypes.feat.some((feat) => feat.sourceId === uuid);\r\n}\r\n\r\nexport function templatePath(template) {\r\n\treturn `modules/${MODULE_ID}/templates/${template}.hbs`;\r\n}\r\n\r\nexport function modifier(mod) {\r\n\treturn mod >= 0 ? `+${mod}` : mod;\r\n}\r\n\r\nexport function getFlag(doc, flag) {\r\n\treturn doc.getFlag(MODULE_ID, flag);\r\n}\r\n\r\nexport function setFlag(doc, flag, value) {\r\n\treturn doc.setFlag(MODULE_ID, flag, value);\r\n}\r\n\r\nexport async function enrichHTML(\r\n\tstr,\r\n\tactor,\r\n\t{ isOwner = actor.isOwner, rollData = actor.getRollData() } = {},\r\n) {\r\n\tconst htmlStr = str?.trim();\r\n\tif (!htmlStr) return \"\";\r\n\r\n\tconst enriched = await TextEditor.enrichHTML(htmlStr, {\r\n\t\tasync: true,\r\n\t\tsecrets: isOwner,\r\n\t\trollData,\r\n\t});\r\n\treturn enriched;\r\n}\r\n\r\nexport function isInstanceOf(obj, name) {\r\n\tif (typeof obj !== \"object\") return false;\r\n\r\n\tlet cursor = Reflect.getPrototypeOf(obj);\r\n\twhile (cursor) {\r\n\t\tif (cursor.constructor.name === name) return true;\r\n\t\tcursor = Reflect.getPrototypeOf(cursor);\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n", "import { MODULE_ID, getHud, getSetting } from \"./module.js\";\r\n\r\nexport function registerKeybindings() {\r\n\tregister(\"hold\", {\r\n\t\tonDown: () => {\r\n\t\t\tif (getSetting(\"key-holding\") !== \"none\") getHud()?.setHolding(true);\r\n\t\t},\r\n\t\tonUp: () => {\r\n\t\t\tgetHud()?.setHolding(false);\r\n\t\t},\r\n\t});\r\n\r\n\tregister(\"filter\", {\r\n\t\tonUp: () => {\r\n\t\t\tgetHud()?.showFilter();\r\n\t\t},\r\n\t\teditable: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"KeyQ\",\r\n\t\t\t\tmodifiers: [\"Control\"],\r\n\t\t\t},\r\n\t\t],\r\n\t});\r\n}\r\n\r\nfunction path(bind, key) {\r\n\treturn `${MODULE_ID}.keybinds.${bind}.${key}`;\r\n}\r\n\r\nfunction register(name, extras = {}) {\r\n\tgame.keybindings.register(MODULE_ID, name, {\r\n\t\tname: path(name, \"name\"),\r\n\t\thint: path(name, \"hint\"),\r\n\t\tprecedence: CONST.KEYBINDING_PRECEDENCE.PRIORITY,\r\n\t\t...extras,\r\n\t});\r\n}\r\n", "import { registerSetting, settingPath } from \"module-api\";\r\nimport { MODULE_ID, enableModule, localize } from \"./module.js\";\r\n\r\nexport function registerSettings() {\r\n\tconst isGM =\r\n\t\tgame.data.users.find((x) => x._id === game.data.userId).role >=\r\n\t\tCONST.USER_ROLES.GAMEMASTER;\r\n\r\n\t/**\r\n\t * GM\r\n\t */\r\n\tconst statuses = [\"first\", \"second\", \"third\", \"fourth\"]\r\n\t\t.map((x) => localize(`settings.status.statuses.${x}`))\r\n\t\t.join(\", \");\r\n\tregister(\"status\", String, statuses, { scope: \"world\" });\r\n\r\n\tregister(\"last-status\", Boolean, false, { scope: \"world\" });\r\n\r\n\tregister(\"party\", Boolean, false, { scope: \"world\" });\r\n\r\n\tregister(\"rk-dice\", Boolean, false, { scope: \"world\" });\r\n\r\n\t/**\r\n\t * CLIENT\r\n\t */\r\n\tregister(\"enabled\", Boolean, true, { onChange: enableModule });\r\n\r\n\tregister(\"position\", String, \"right\", {\r\n\t\tchoices: [\"left\", \"right\", \"top\", \"bottom\"],\r\n\t});\r\n\r\n\tregister(\"small-position\", String, \"top\", {\r\n\t\tchoices: [\"left\", \"right\", \"top\", \"bottom\"],\r\n\t});\r\n\r\n\tregister(\"delay\", Number, 250, {\r\n\t\trange: {\r\n\t\t\tmin: 0,\r\n\t\t\tmax: 2000,\r\n\t\t\tstep: 50,\r\n\t\t},\r\n\t});\r\n\r\n\tregister(\"scale\", Number, 14, {\r\n\t\trange: {\r\n\t\t\tmin: 10,\r\n\t\t\tmax: 30,\r\n\t\t\tstep: 1,\r\n\t\t},\r\n\t});\r\n\r\n\tregister(\"key-holding\", String, \"none\", {\r\n\t\thint: settingPath(\r\n\t\t\t\"key-holding\",\r\n\t\t\tisGM ? \"choices.gm.hint\" : \"choices.player.hint\",\r\n\t\t),\r\n\t\tchoices: {\r\n\t\t\tnone: settingPath(\"key-holding\", \"choices.none\"),\r\n\t\t\thalf: settingPath(\r\n\t\t\t\t\"key-holding\",\r\n\t\t\t\tisGM ? \"choices.gm.half\" : \"choices.player.half\",\r\n\t\t\t),\r\n\t\t\tall: settingPath(\r\n\t\t\t\t\"key-holding\",\r\n\t\t\t\tisGM ? \"choices.gm.all\" : \"choices.player.all\",\r\n\t\t\t),\r\n\t\t},\r\n\t});\r\n\r\n\tregister(\"autolock\", String, \"none\", {\r\n\t\tchoices: [\"none\", \"hover\", \"render\"],\r\n\t});\r\n\r\n\tregister(\"chat-close\", Boolean, false);\r\n\tregister(\"attack-close\", Boolean, false);\r\n\tregister(\"action-close\", Boolean, false);\r\n\tregister(\"cast-close\", Boolean, false);\r\n\tregister(\"skill-close\", Boolean, false);\r\n\tregister(\"macro-close\", Boolean, false);\r\n\tregister(\"use-close\", Boolean, false);\r\n\r\n\tregister(\"no-dead\", Boolean, false);\r\n\r\n\tregister(\"observer\", Boolean, true);\r\n\r\n\tregister(\"see-status\", Boolean, false);\r\n\r\n\t// tooltip\r\n\r\n\tregister(\"saves\", String, \"bonus\", { choices: [\"none\", \"bonus\", \"dc\"] });\r\n\r\n\tregister(\"others\", String, \"none\", { choices: [\"none\", \"bonus\", \"dc\"] });\r\n\r\n\tregister(\"ranks\", Boolean, false);\r\n\r\n\tregister(\"show-death\", String, \"always\", {\r\n\t\tchoices: [\"none\", \"always\", \"only\"],\r\n\t});\r\n\r\n\tregister(\"force-speed\", Boolean, false);\r\n\r\n\tregister(\"tooltips\", Boolean, false);\r\n\r\n\tregister(\"pips\", Boolean, false);\r\n\r\n\t// distance\r\n\r\n\tregister(\"distance\", String, \"all\", { choices: [\"none\", \"self\", \"all\"] });\r\n\r\n\tregister(\"unit\", String, \"\");\r\n\r\n\t// sidebar\r\n\r\n\tregister(\"height\", String, \"\");\r\n\r\n\tregister(\"filter\", Boolean, false);\r\n\r\n\tregister(\"scrollbar\", Boolean, true);\r\n\r\n\tregister(\"hazard-width\", Number, 32, {\r\n\t\trange: {\r\n\t\t\tmin: 14,\r\n\t\t\tmax: 50,\r\n\t\t\tstep: 1,\r\n\t\t},\r\n\t});\r\n\r\n\tregister(\"actions-columns\", Boolean, false);\r\n\r\n\tregister(\"items-columns\", Boolean, false);\r\n\r\n\tregister(\"spells-columns\", Boolean, false);\r\n\r\n\tregister(\"skills-columns\", Boolean, false);\r\n\r\n\t// actions\r\n\r\n\tregister(\"actions\", String, \"split\", { choices: [\"name\", \"type\", \"split\"] });\r\n\r\n\t// register('actions-colors', Boolean, true)\r\n\r\n\tregister(\"action-effect\", Boolean, false);\r\n\r\n\t// items\r\n\r\n\tregister(\"containers\", Boolean, false);\r\n\r\n\t// spells\r\n\r\n\tregister(\"spells-sort\", String, \"disabled\", {\r\n\t\tchoices: [\"disabled\", \"type\", \"entry\"],\r\n\t});\r\n\r\n\tregister(\"tradition\", Boolean, false);\r\n\r\n\t// skills\r\n\r\n\tregister(\"untrained\", Boolean, true);\r\n}\r\n\r\nexport function renderSettingsConfig(_, html) {\r\n\tconst tab = html.find(`.tab[data-tab=${MODULE_ID}]`);\r\n\r\n\tfunction beforeGroup(name, key, dom = \"h3\") {\r\n\t\tconst localized = localize(`menu.${key}`);\r\n\t\ttab\r\n\t\t\t.find(`[name=\"${MODULE_ID}.${name}\"]`)\r\n\t\t\t.closest(\".form-group\")\r\n\t\t\t.before(`<${dom}>${localized}</${dom}>`);\r\n\t}\r\n\r\n\tif (game.user.isGM) {\r\n\t\tbeforeGroup(\"enabled\", \"client.header\", \"h2\");\r\n\t}\r\n\r\n\tbeforeGroup(\"saves\", \"client.tooltip\");\r\n\tbeforeGroup(\"distance\", \"client.distance\");\r\n\tbeforeGroup(\"height\", \"client.sidebar\");\r\n\tbeforeGroup(\"actions\", \"client.actions\");\r\n\tbeforeGroup(\"containers\", \"client.items\");\r\n\tbeforeGroup(\"spells-sort\", \"client.spells\");\r\n\tbeforeGroup(\"untrained\", \"client.skills\");\r\n\t// beforeGroup('', 'client.extras')\r\n}\r\n\r\nfunction register(name, type, defValue, extra = {}) {\r\n\tregisterSetting({\r\n\t\tname,\r\n\t\tscope: \"client\",\r\n\t\tconfig: true,\r\n\t\ttype,\r\n\t\tdefault: defValue,\r\n\t\t...extra,\r\n\t});\r\n}\r\n", "import { registerModule } from \"module-api\";\r\nimport { registerKeybindings } from \"./keybindings.js\";\r\nimport {\r\n\tMODULE_ID,\r\n\tenableModule,\r\n\tgetHud,\r\n\tgetSetting,\r\n\tlocalize,\r\n\ttemplatePath,\r\n} from \"./module.js\";\r\nimport { registerSettings, renderSettingsConfig } from \"./settings.js\";\r\nimport { deleteMacro, getMacros, onDroppedMacro } from \"./shared.js\";\r\n\r\nregisterModule(\"pf2e-token-hud\");\r\n\r\nHooks.once(\"setup\", async () => {\r\n\tregisterSettings();\r\n\tregisterKeybindings();\r\n\r\n\tawait loadTemplates({\r\n\t\tcreature: templatePath(\"tooltips/creature\"),\r\n\t\thazard: templatePath(\"tooltips/hazard\"),\r\n\t\tvehicle: templatePath(\"tooltips/vehicle\"),\r\n\t\tarmy: templatePath(\"tooltips/army\"),\r\n\t});\r\n});\r\n\r\nHooks.once(\"ready\", () => {\r\n\tif (getSetting(\"enabled\")) enableModule(true);\r\n\r\n\tgame.modules.get(\"pf2e-token-hud\").api = {\r\n\t\tgetHud,\r\n\t};\r\n});\r\n\r\nHooks.on(\"renderSettingsConfig\", renderSettingsConfig);\r\n\r\nHooks.on(\"drawMeasuredTemplate\", (template) => {\r\n\tif (template.isPreview) getHud()?.close();\r\n});\r\n\r\nHooks.on(\"getActorDirectoryEntryContext\", (_, data) => {\r\n\tdata.unshift({\r\n\t\ticon: '<i class=\"fa-solid fa-code\"></i>',\r\n\t\tname: `${MODULE_ID}.actor.macros.contextmenu`,\r\n\t\tcondition: (html) => {\r\n\t\t\tconst { documentId } = html.data();\r\n\t\t\treturn getSetting(\"enabled\") && game.actors.get(documentId)?.isOwner;\r\n\t\t},\r\n\t\tcallback: (html) => {\r\n\t\t\tconst { documentId } = html.data();\r\n\t\t\topenMacrosDialog(documentId);\r\n\t\t},\r\n\t});\r\n});\r\n\r\nclass DataDialog extends Dialog {\r\n\tasync getData(options = {}) {\r\n\t\tconst data = super.getData(options);\r\n\t\tif (typeof data.content === \"function\") data.content = await data.content();\r\n\t\treturn data;\r\n\t}\r\n}\r\n\r\nfunction openMacrosDialog(actorId) {\r\n\tconst actor = game.actors.get(actorId);\r\n\tif (!actor) return;\r\n\r\n\tconst dialog = new DataDialog(\r\n\t\t{\r\n\t\t\ttitle: `${actor.name} - ${localize(\"actor.macros.title\")}`,\r\n\t\t\tcontent: async () => {\r\n\t\t\t\tconst macros = getMacros(actor) ?? [];\r\n\t\t\t\treturn renderTemplate(templatePath(\"dialogs/macros\"), {\r\n\t\t\t\t\tmacros,\r\n\t\t\t\t\tnoMacro: localize(\"extras.no-macro\"),\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tbuttons: {},\r\n\t\t\trender: (html) => {\r\n\t\t\t\tactor.apps[dialog.appId] = dialog;\r\n\t\t\t\thtml.on(\"drop\", (event) => onDroppedMacro(event, actor));\r\n\t\t\t\thtml\r\n\t\t\t\t\t.find(\"[data-action=delete-macro]\")\r\n\t\t\t\t\t.on(\"click\", (event) => deleteMacro(event, actor));\r\n\t\t\t},\r\n\t\t\tclose: () => {\r\n\t\t\t\tdelete actor.apps[dialog.appId];\r\n\t\t\t},\r\n\t\t},\r\n\t\t{ height: \"auto\" },\r\n\t).render(true);\r\n}\r\n"],
  "mappings": "8dASO,SAASA,GAAcC,EAAKC,EAAIC,EAAK,CAC3C,IAAMC,EAAM,CAAC,EACb,QAAWC,KAASJ,EAAK,CACxB,IAAMK,EAAI,MAAM,QAAQD,CAAK,EAC1BA,EAAMF,GAAO,CAAC,EACd,OAAOE,GAAU,UAAYF,GAAO,KAClCE,EAAMF,CAAG,EACTE,EACLD,EAAIE,CAAC,EAAIJ,EAAGG,CAAK,EAElB,OAAOD,CACR,CAXgBG,EAAAP,GAAA,iBCTT,IAAMQ,IAAiB,SAAY,CAAC,GAAG,YCG9C,IAAIC,GAAY,KAEHC,EAAS,CACrB,IAAI,IAAK,CACR,GAAI,CAACD,GACJ,MAAM,IAAI,MAAM,mCAAmC,EAEpD,OAAOA,EACR,EAIA,MAAME,EAAK,CACV,MAAM,IAAI,MAAM,IAAI,KAAK,OAAOA,GAAK,CACtC,CACD,EAMO,SAASC,GAAeC,EAAI,CAClCJ,GAAYI,CACb,CAFgBC,EAAAF,GAAA,kBCjBT,SAASG,GAAgBC,EAAS,CACxCA,EAAQ,MAAQA,EAAQ,KAEpB,MAAM,QAAQA,EAAQ,OAAO,IAChCA,EAAQ,QAAUC,GAAcD,EAAQ,QAAUE,GACjDC,GAAYH,EAAQ,IAAK,UAAWE,CAAM,CAC3C,GAGDF,EAAQ,KAAOG,GAAYH,EAAQ,IAAK,MAAM,EAC9CA,EAAQ,KAAOG,GAAYH,EAAQ,IAAK,MAAM,EAC9CA,EAAQ,QAAU,QAClBA,EAAQ,SAAW,GAEnB,KAAK,SAAS,SAASI,EAAO,GAAIJ,EAAQ,IAAKA,CAAO,CACvD,CAfgBK,EAAAN,GAAA,mBAiCT,SAASO,MAAeC,EAAM,CACpC,MAAO,GAAGC,EAAO,eAAeD,EAAK,KAAK,GAAG,GAC9C,CAFgBE,EAAAH,GAAA,eAQT,SAASI,GAAWC,EAAS,CACnC,OAAO,KAAK,SAAS,IAAIH,EAAO,GAAIG,CAAO,CAC5C,CAFgBF,EAAAC,GAAA,cC/BhB,eAAsBE,GAAc,CACnC,OAAAC,EACA,SAAAC,EACA,UAAAC,EAAY,OACZ,SAAAC,EACA,UAAAC,EACA,QAAAC,EACA,QAAAC,EACA,SAAAC,EAAW,CAAC,EACZ,OAAAC,EAAS,EACV,EAAG,CACF,OAAO,IAAI,QAASC,GAAY,CAC/B,IAAMC,EAAe,GAAGC,EAAO,aAEzBC,EAAQ,SAAS,KAAK,iBAC3B,IAAIF,iBACL,EACA,QAAWG,KAAMD,EAChBE,GAAeD,CAAE,EAGlB,sBAAsB,IAAM,CAC3BN,EAAW,OAAOA,GAAa,SAAW,CAACA,CAAQ,EAAIA,EACnDN,GAAUM,EAAS,KAAK,mBAAmB,EAE3C,MAAM,QAAQD,CAAO,IACxBA,EAAUA,EACR,IAAI,CAAC,CAAE,MAAAS,EAAO,MAAAC,CAAM,IAEb,UADeD,IAAUd,EAAW,mBAAqB,kBAClBc,MAAUC,YACxD,EACA,KAAK,EAAE,GAGV,IAAIC,EAwBJ,GAtBIX,aAAmB,YACtBW,EAAUX,GAEVW,EAAU,SAAS,cAAc,IAAI,EACrCA,EAAQ,UAAYX,GAGrBW,EAAQ,MAAM,YAAY,cAAe,GAAGC,GAAW,OAAO,KAAK,EAE/DX,EAAS,QACZU,EAAQ,UAAU,IAAI,GAAGV,EAAS,IAAKY,GAAM,GAAGR,EAAO,MAAMQ,GAAG,CAAC,EAG9Df,GACH,IAAI,iBAAiB,UAAY,CAC3B,SAAS,KAAK,SAASa,CAAO,IAClCb,EAAU,EACV,KAAK,WAAW,EAElB,CAAC,EAAE,QAAQ,SAAS,KAAM,CAAE,UAAW,EAAK,CAAC,EAG1CC,EAAS,CACZG,EAAS,GAET,QAAWK,KAAMI,EAAQ,iBAAiB,cAAc,EACvDJ,EAAG,iBAAiB,QAAS,MAAOO,GAAU,CAC7CA,EAAM,eAAe,EACrBN,GAAeM,EAAM,aAAa,EAClCf,IAAUe,EAAM,cAAc,QAAQ,KAAK,CAC5C,CAAC,EAIH,KAAK,QAAQ,SAASpB,EAAQ,CAC7B,QAASiB,EACT,UAAAf,EACA,OAAAM,EACA,SAAUE,CACX,CAAC,EAEDP,IAAWc,CAAO,EAElBR,EAAQQ,CAAO,CAChB,CAAC,CACF,CAAC,CACF,CAlFsBI,EAAAtB,GAAA,iBAoFf,SAASe,GAAeD,EAAI,CAClC,IAAMI,EAAUJ,EAAG,QAAQ,IAAIF,EAAO,YAAY,EAClD,KAAK,QAAQ,qBAAqBM,CAAO,CAC1C,CAHgBI,EAAAP,GAAA,kBCrGhB,IAAIQ,GAAgD,SAAUC,EAAIC,EAAMC,EAAM,CAC1E,GAAIA,GAAQ,UAAU,SAAW,EAAG,QAASC,EAAI,EAAGC,EAAIH,EAAK,OAAQI,EAAIF,EAAIC,EAAGD,KACxEE,GAAM,EAAEF,KAAKF,MACRI,IAAIA,EAAK,MAAM,UAAU,MAAM,KAAKJ,EAAM,EAAGE,CAAC,GACnDE,EAAGF,CAAC,EAAIF,EAAKE,CAAC,GAGtB,OAAOH,EAAG,OAAOK,GAAM,MAAM,UAAU,MAAM,KAAKJ,CAAI,CAAC,CAC3D,EACO,SAASK,GAAMC,EAAIC,EAAMC,EAAM,CAClC,IAAIC,EAAOH,EAAG,OAASC,EAAK,OACxBG,EAAY,MAAM,KAAKH,CAAI,EAC/B,GAAIE,IAAS,EACT,OAAOH,EAAG,MAAM,OAAQI,CAAS,EAErC,GAAID,IAAS,EAAG,CACZ,IAAIE,EAAMC,EAAA,SAAUC,EAAM,CAAE,OAAOP,EAAG,MAAM,OAAQR,GAAc,CAACe,CAAI,EAAGH,EAAW,EAAK,CAAC,CAAG,EAApF,OACV,OAAIF,GAAQF,EAAG,QACXK,EAAI,KAAOH,GAAQF,EAAG,KACtBK,EAAI,SAAWJ,GAEZI,EAEX,MAAM,IAAI,MAAM,2BAA2B,CAC/C,CAfgBC,EAAAP,GAAA,SCTT,SAASS,GAASC,EAAM,CAC3B,MAAO,CAAC,CAACA,CACb,CAFgBC,EAAAF,GAAA,YCCT,SAASG,GAAQC,EAAO,CAC3B,OAAOA,EAAM,OAAOC,EAAQ,CAChC,CAFgBC,EAAAH,GAAA,WCDT,SAASI,GAAYC,EAAOC,EAAMC,EAAS,CAE9C,QADIC,EAAW,CAAC,EACPC,EAAQ,EAAGA,EAAQJ,EAAM,OAAQI,IAAS,CAC/C,IAAIC,EAAOL,EAAMI,CAAK,EAClBE,EAASJ,EAAUD,EAAKI,EAAMD,EAAOJ,CAAK,EAAIC,EAAKI,CAAI,EACvDC,EAAO,UAAY,GACnBH,EAAS,KAAK,MAAMA,EAAUG,EAAO,IAAI,EAEpCA,EAAO,SACZH,EAAS,KAAKG,EAAO,IAAI,EAGjC,OAAOH,CACX,CAbgBI,EAAAR,GAAA,eCAT,SAASS,GAAQC,EAAM,CAC1B,OAAO,MAAM,QAAQA,CAAI,CAC7B,CAFgBC,EAAAF,GAAA,WCAT,SAASG,GAASC,EAAM,CAC3B,MAAO,CAAC,CAACA,GAAQ,CAAC,MAAM,QAAQA,CAAI,GAAK,OAAOA,GAAS,QAC7D,CAFgBC,EAAAF,GAAA,YCAT,SAASG,GAASC,EAAM,CAC3B,OAAO,OAAOA,GAAS,QAC3B,CAFgBC,EAAAF,GAAA,YCGT,SAASG,GAAQC,EAAM,CAC1B,OAAIA,IAAS,OACF,GAEPC,GAAQD,CAAI,GAAKE,GAASF,CAAI,EACvBA,EAAK,SAAW,EAEvBG,GAASH,CAAI,EACN,OAAO,KAAKA,CAAI,EAAE,SAAW,EAEjC,EACX,CAXgBI,EAAAL,GAAA,WCHT,SAASM,GAAMC,EAAM,CACxB,OAAOA,GAAQ,IACnB,CAFgBC,EAAAF,GAAA,SCET,SAASG,IAAO,CACnB,OAAOC,GAAMC,GAAO,UAAWF,GAAK,IAAI,CAC5C,CAFgBG,EAAAH,GAAA,QAGhB,SAASE,GAAME,EAAO,CAClB,OAAOC,GAAYD,EAAOJ,GAAK,KAAK,CAAC,CACzC,CAFSG,EAAAD,GAAA,UAGR,SAAUF,EAAM,CACb,SAASM,GAAO,CACZ,IAAIC,EAAM,IAAI,IACd,OAAO,SAAUC,EAAO,CACpB,OAAID,EAAI,IAAIC,CAAK,EACN,CACH,KAAM,GACN,QAAS,EACb,GAEJD,EAAI,IAAIC,CAAK,EACN,CACH,KAAM,GACN,QAAS,GACT,KAAMA,CACV,EACJ,CACJ,CAhBSL,EAAAG,EAAA,QAiBTN,EAAK,KAAOM,CAChB,GAAGN,KAASA,GAAO,CAAC,EAAE,ECgEf,SAASS,GAAkBC,EAAU,CAAC,EAAG,CAC/C,GAAM,CACL,QAAAC,EAAU,WACV,QAAAC,EAAU,CAAC,EACX,iBAAAC,EAAmB,EACpB,EAAIH,EACEI,EAAWC,GAChB,KAAK,KACH,gBAAgB,EAChB,QAASC,GACTA,EAAE,QACDL,EAAQ,SAAW,GAAKK,EAAE,MAAM,SAAS,GAAGL,CAAO,KACnDC,EAAQ,SAAW,GAAK,CAACI,EAAE,MAAM,SAAS,GAAGJ,CAAO,GAClDI,EAAE,MACF,CAAC,CACL,CACF,EACMC,EAAW,KAAK,KAAK,UAC3B,OAAIH,EAAO,OAAS,GAAK,CAACD,GAAoB,CAACI,EACvCH,GAINH,EAAQ,SAAW,GAAKM,EAAS,SAAS,GAAGN,CAAO,KACpDC,EAAQ,SAAW,GAAK,CAACK,EAAS,SAAS,GAAGL,CAAO,GAE/C,CAACK,CAAQ,EAGV,CAAC,CACT,CA9BgBC,EAAAT,GAAA,qBC1ET,SAASU,GAAaC,EAAQC,EAAW,CAC/C,OAAMD,aAAkB,SAAWA,aAAkB,SAC9C,MAAM,KAAKA,EAAO,iBAAiBC,CAAS,CAAC,EADmB,CAAC,CAEzE,CAHgBC,EAAAH,GAAA,gBAeT,SAASI,GACfC,EACA,CAAE,QAAAC,EAAU,CAAC,EAAG,QAAAC,EAAU,CAAC,EAAG,SAAAC,EAAW,CAAC,EAAG,UAAAC,CAAU,EAAI,CAAC,EAC3D,CACD,IAAMC,EAAU,SAAS,cAAcL,CAAQ,EAC3CC,EAAQ,OAAS,GAAGI,EAAQ,UAAU,IAAI,GAAGJ,CAAO,EAExD,OAAW,CAACK,EAAKC,CAAK,IAAK,OAAO,QAAQL,CAAO,EAAE,OAClD,CAAC,CAAC,CAAEM,CAAC,IAAM,CAAGC,GAAMD,CAAC,GAAKA,IAAM,EACjC,EACCH,EAAQ,QAAQC,CAAG,EAAIC,IAAU,GAAO,GAAK,OAAOA,CAAK,EAG1D,GAAIH,EACHC,EAAQ,UAAYD,MAEpB,SAAWM,KAASP,EAAU,CAC7B,IAAMQ,EACLD,aAAiB,YAAcA,EAAQ,IAAI,KAAKA,CAAK,EACtDL,EAAQ,YAAYM,CAAY,EAIlC,OAAON,CACR,CAxBgBP,EAAAC,GAAA,qBA+BT,SAASa,GAAYF,EAAOb,EAAW,CAC7C,OAAMa,aAAiB,QAChBA,EAAM,QAAQb,CAAS,EADU,IAEzC,CAHgBC,EAAAc,GAAA,eC3DT,SAASC,GAAcC,EAAO,CACpC,IAAMC,EAAc,IAAI,KAAK,YAAY,KAAK,KAAK,KAAM,CAAE,KAAM,SAAU,CAAC,EACtEC,EAAS,KAAK,KAAK,SACxB,wBAAwBD,EAAY,OAAOD,CAAK,GACjD,EACA,OAAO,KAAK,KAAK,OAAO,qBAAsB,CAAE,MAAAA,EAAO,OAAAE,CAAO,CAAC,CAChE,CANgBC,EAAAJ,GAAA,iBAYT,SAASK,GAAUC,EAAS,CAClC,OAAO,MAAM,iBAAiBA,GAAS,CACxC,CAFgBF,EAAAC,GAAA,aAoCT,SAASE,GAAaC,EAAKC,EAAK,CACtC,OAAQ,OAAOA,GAAQ,UAAY,OAAOA,GAAQ,WAAaA,KAAOD,CACvE,CAFgBE,EAAAH,GAAA,gBAQT,SAASI,GAAUC,EAAQ,CACjC,MAAO,IAAI,CAACC,EAAQC,CAAU,IAC7BA,EACG,KAAK,KAAK,OAAO,GAAGF,KAAUC,IAAUC,CAAU,EAClD,KAAK,KAAK,SAAS,GAAGF,KAAUC,GAAQ,CAC7C,CALgBH,EAAAC,GAAA,aAOhB,IAAMI,GAAiB,CACtB,EAAG,IACH,KAAM,IACN,EAAG,IACH,EAAG,IACH,EAAG,IACH,SAAU,MACV,SAAU,QACV,SAAU,MACV,SAAU,GACX,EAMO,SAASC,GAAeC,EAAQ,CACtC,GAAI,CAACA,GAAUA,IAAW,EAAG,MAAO,GAEpC,IAAMC,EACL,OAAOD,GAAW,SACfA,EACAA,EAAO,OAAS,SACdA,EAAO,MACPA,EAAO,KACPE,EAAY,OAAOD,GAAS,EAAE,EAClC,YAAY,EACZ,KAAK,EAEP,OAAOH,GAAeI,CAAS,GAAG,QAAQ,IAAK,QAAG,GAAK,EACxD,CAdgBT,EAAAM,GAAA,kBAgBhB,IAAMI,GAAe,CACpB,EAAG,6CACH,KAAM,6CACN,EAAG,4CACH,EAAG,6CACH,EAAG,+CACH,SAAU,gDACV,SAAU,kDACV,SAAU,kDACV,SAAU,2CACV,QAAS,yCACV,EAQO,SAASC,GACfJ,EACAK,EAAW,wCACV,CACD,GAAIL,IAAW,KAAM,OAAOG,GAAa,QACzC,IAAMF,EACL,OAAOD,GAAW,SACfA,EACAA,EAAO,OAAS,SACdA,EAAO,MACPA,EAAO,KACPE,EAAY,OAAOD,GAAS,EAAE,EAClC,YAAY,EACZ,KAAK,EACP,OAAOE,GAAaD,CAAS,GAAKG,CACnC,CAfgBZ,EAAAW,GAAA,iBAuBT,SAASE,GAASC,EAAMC,EAAS,CACvC,OAAO,KAAK,KAAK,OAAO,SAASD,EAAMC,CAAO,CAC/C,CAFgBf,EAAAa,GAAA,YAUT,SAASG,GAAcC,EAAKT,EAAO,CACzC,OAAOS,EAAI,IAAIT,CAAK,CACrB,CAFgBR,EAAAgB,GAAA,iBAUT,SAASE,GAAcC,EAAOX,EAAO,CAC3C,OAAOW,EAAM,SAASX,CAAK,CAC5B,CAFgBR,EAAAkB,GAAA,iBC/JT,SAASE,GAAkBC,EAAOC,EAAY,CAGpD,IAAMC,EAAc,CACnB,KAAMF,EACN,MAAO,KAAK,KAAK,SAASC,EAAWD,CAAK,GAAKA,CAAK,EACpD,YAAa,IACd,EACA,OAAIG,GAAa,OAAO,KAAK,mBAAoBH,CAAK,IACrDE,EAAY,YAAc,OAAO,KAAK,mBAAmBF,CAAK,GAGxDE,CACR,CAbgBE,EAAAL,GAAA,qBCmUhB,eAAsBM,GAAwBC,EAAMC,EAAW,OAAQ,CACtE,GAAI,CAACD,EAAK,OAAO,WAChB,MAAME,GACL,CACC,iFACA,2CACD,EAAE,KAAK,GAAG,CACX,EAGD,GAAM,CAAE,MAAAC,EAAO,WAAAC,CAAW,EAAIJ,EACxBK,EAAQF,EAAM,gBAAgB,GAAM,EAAI,EAAE,MAAM,GAAK,KAErDG,EAAkB,YAAY,eAC9BC,EAAUD,EAAgB,WAAW,CAAE,MAAAH,EAAO,MAAAE,CAAM,CAAC,EACrDG,EAAS,MAAM,eACpB,gDACA,CACC,OAAQ,CAAE,MAAOR,EAAK,KAAM,MAAOS,GAAeL,CAAU,CAAE,EAC9D,KAAAJ,EACA,OAAQA,EAAK,OAAO,OAAO,MAAM,IAAKU,GACrCC,GAAkBD,EAAG,OAAO,KAAK,YAAY,CAC9C,CACD,CACD,EAGME,EAAgB,IAChBC,GAAsB,IAAM,CACjC,GAAIb,EAAK,MAAM,KAAM,OAAO,KAC5B,IAAMc,EAAU,SAAS,cAAc,KAAK,EACtCC,EAAgB,CAAC,GAAG,MAAM,oBAAqB,aAAc,MAAM,EACnEC,EAAc,IAAI,OACvB,KAAKD,EAAc,KAClB,GACD,gDACA,GACD,EACA,OAAAD,EAAQ,UAAYd,EAAK,YAAY,QACpCgB,EACA,CAACC,KAAWC,IAASA,EAAK,CAAC,CAC5B,EAEOJ,EAAQ,UAAU,MAAM,EAAGF,CAAa,CAChD,GAAG,EACGO,EAAc,CACnB,KACCN,GAAsBA,EAAmB,OAASD,EAC/CZ,EAAK,YACL,KACJ,QAASa,CACV,EACMO,EAAU,MAAM,eACrB,qDACA,CACC,MAAOpB,EAAK,MACZ,YAAAmB,CACD,CACD,EACME,EAAQ,CAAE,KAAM,CAAE,QAAS,CAAE,KAAM,cAAe,KAAMrB,EAAK,EAAG,CAAE,CAAE,EACpEsB,EAAchB,EAAgB,cACnC,CAAE,QAAAC,EAAS,OAAAC,EAAQ,QAAAY,EAAS,MAAAC,CAAM,EAClCpB,CACD,EAEA,OAAOK,EAAgB,OAAOgB,CAAW,CAC1C,CAlEsBC,EAAAxB,GAAA,2BClUf,SAASyB,IAAqB,CACpC,OAAO,OAAO,KAAK,MAAM,KAAMC,GAASA,EAAK,OAAS,YAAY,CACnE,CAFgBC,EAAAF,GAAA,sBCOT,IAAMG,GAAgB,IAAI,IAAI,CACpC,CAAC,kBAAmB,GAAG,EACvB,CAAC,YAAa,EAAE,EAChB,CAAC,OAAQ,EAAE,EACX,CAAC,SAAU,CAAC,EACZ,CAAC,OAAQ,CAAC,EACV,CAAC,YAAa,CAAC,EACf,CAAC,kBAAmB,EAAE,CACvB,CAAC,EAEYC,GAAY,IAAI,IAAI,CAChC,CAAC,GAAI,EAAE,EACP,CAAC,EAAG,EAAE,EACN,CAAC,EAAG,EAAE,EACN,CAAC,EAAG,EAAE,EACN,CAAC,EAAG,EAAE,EACN,CAAC,EAAG,EAAE,EACN,CAAC,EAAG,EAAE,EACN,CAAC,EAAG,EAAE,EACN,CAAC,EAAG,EAAE,EACN,CAAC,EAAG,EAAE,EACN,CAAC,EAAG,EAAE,EACN,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,EACP,CAAC,GAAI,EAAE,CACR,CAAC,EA0CM,SAASC,GAAYC,EAAO,CAAE,KAAAC,EAAM,OAAAC,EAAS,QAAS,EAAI,CAAC,EAAG,CACpED,IAAS,KAAK,KAAK,SAAS,SAAS,KAAK,QAI1C,IAAME,EAAKC,GAAU,IAAIJ,CAAK,GAAK,GACnC,OAGQK,GAHJJ,EAGqBE,EAAK,KAAK,IAAIH,EAAO,CAAC,EAGvBG,EAH0BD,CAAM,CAIzD,CAbgBI,EAAAP,GAAA,eA+CT,SAASQ,GAAiBC,EAAIC,EAAS,SAAU,CACvD,OAAOC,GAASF,EAAIG,GAAqBF,CAAM,CAAC,CACjD,CAFgBG,EAAAL,GAAA,oBAUT,SAASG,GAASF,EAAIK,EAAa,SAAU,CACnD,OAAOL,GAAMM,GAAc,IAAID,CAAU,GAAK,EAC/C,CAFgBD,EAAAF,GAAA,YAQT,SAASC,GAAqBF,EAAS,SAAU,CACvD,OAAQA,EAAQ,CACf,IAAK,WACJ,MAAO,OACR,IAAK,OACJ,MAAO,YACR,IAAK,SACJ,MAAO,kBACR,QACC,MAAO,QACT,CACD,CAXgBG,EAAAD,GAAA,wBC3JT,IAAMI,GAAqB,CACjC,QACA,OACA,OACA,WACA,YACA,OACA,QACD,EAEaC,GAAmB,IAAI,IAAI,CACvC,SACA,SACA,SACA,QACD,CAAC,EAaM,SAASC,GAAyBC,EAAS,CACjD,GAAIA,IAAY,WAAY,MAAO,GACnC,IAAMC,EAAe,OAAOD,GAAW,GAAG,EAC1C,OAAOC,EAAa,QAAQ,EAAG,EAAE,EAAIA,EAAe,IACrD,CAJgBC,EAAAH,GAAA,4BAUT,SAASI,GAAqBC,EAAO,CAC3C,GAAIA,IAAU,WAAY,OAAOA,EACjC,IAAMH,EAAe,OAAOG,CAAK,GAAK,IACtC,OAAOH,EAAa,QAAQ,EAAG,EAAE,EAAIA,EAAe,IACrD,CAJgBC,EAAAC,GAAA,wBClCT,IAAME,GAAN,cAAgC,eAAgB,CACtD,WAAW,gBAAiB,CAC3B,MAAO,CACN,GAAG,gBAAgB,eACnB,GAAI,gBACJ,MAAO,KAAK,KAAK,SAAS,8BAA8B,EACxD,SAAU,kDACV,MAAO,OACP,QAAS,CAAC,gBAAgB,CAC3B,CACD,CAEA,IAAMC,GAAyB,KAAK,OAAQ,CAC3C,KAAM,KAAK,KAAK,SAAS,SAAS,KAAK,QACvC,6BAA8B,KAAK,SAAS,IAC3C,OACA,2CACD,CACD,CAAC,EAED,MAAM,SAAU,CACf,IAAMC,EAAO,KAAK,OAClB,MAAO,CACN,GAAI,MAAM,MAAM,QAAQ,EACxB,QAASA,EAAK,UACd,aAAcA,EAAK,aACnB,IAAK,KAAK,GACX,CACD,CAEA,kBAAkBC,EAAO,CACxB,IAAMC,EAAOD,EAAM,CAAC,EAEdE,EACLD,EAAK,cAAgB,kBAAoB,+BAC1CC,GAAc,iBAAiB,QAAS,IAAM,CAC7C,KAAK,OAAO,CAAE,WAAY,CAAE,OAAQA,EAAa,KAAM,CAAE,CAAC,CAC3D,CAAC,EAGDD,EACE,cAAc,0BAA0B,GACvC,iBAAiB,QAAS,SAAY,CACvC,IAAMF,EAAO,KAAK,OACZI,EAAiBJ,EAAK,OAAO,eAAe,WAAW,KACvDK,EAAM,KAAK,IACXC,EAASN,EAAK,UACjB,iBACAA,EAAK,aACH,mBACA,mBAECO,EAAU,MAAM,eACrB,oEACA,CACC,eAAAH,EACA,OAAAE,EACA,OAAQ,EAAE,KAAKD,EAAK,CAAC,IAAI,CAAC,EAC1B,aAAcL,EAAK,OAAO,eAAe,aACzC,KAAMA,EAAK,IACZ,CACD,EAEA,MAAM,YAAY,eAAe,OAAO,CACvC,KAAM,KAAK,KAAK,GAChB,QAAAO,CACD,CAAC,CACF,CAAC,CACH,CAEA,MAAM,cAAcC,EAAQC,EAAU,CACrC,IAAMC,EAASD,EAAS,OACxB,GAAIC,IAAW,aACd,OAAO,KAAK,OAAO,wBAAwBA,CAAM,CAEnD,CACD,EA5EaC,EAAAb,GAAA,qBA8EN,SAASC,GACfC,EACA,CAAE,KAAAY,EAAO,GAAO,6BAAAC,CAA6B,EAC5C,CACD,IAAMC,EAASC,GAAYf,EAAK,MAAO,CAAE,KAAAY,CAAK,CAAC,EACzCI,EAASC,GAAYjB,CAAI,EACzBkB,EAAKC,GAAiBL,EAAQE,CAAM,EAC1C,OAAIhB,EAAK,UACDoB,GAAoBpB,EAAMkB,EAAIL,CAA4B,EAG3D,CAAE,SAAUK,CAAG,CACvB,CAZgBP,EAAAZ,GAAA,4BAmBhB,SAASkB,GAAYjB,EAAM,CAC1B,OAAOA,EAAK,OAAO,IAAI,QAAQ,EAAI,SAAWA,EAAK,MACpD,CAFSW,EAAAM,GAAA,eAWT,SAASG,GAAoBpB,EAAMc,EAAQD,EAA8B,CACxE,IAAMQ,EAAS,CACd,OAAQP,EACR,OAAQA,EACR,OAAQA,EACR,OAAQA,CACT,EACMQ,EAAaC,GAAmBvB,CAAI,EAC1C,QAAWwB,KAAOC,GAGbH,EAAW,KAAO,GAAK,CAACA,EAAW,IAAIE,CAAG,IAC7CH,EAAOG,CAAG,EAAIV,EAASD,GAGzB,MAAO,CACN,OAAQQ,EAAO,OACf,OAAQA,EAAO,OACf,SAAUA,EAAO,OACjB,UAAWA,EAAO,MACnB,CACD,CArBSV,EAAAS,GAAA,uBA2BT,SAASG,GAAmBvB,EAAM,CACjC,IAAM0B,EAAS1B,EAAK,OAAO,OAAO,MAClC,OAAO,IAAI,IAAI0B,EAAO,OAAQC,GAAMC,GAAcH,GAAkBE,CAAC,CAAC,CAAC,CACxE,CAHShB,EAAAY,GAAA,sBC3IT,SAASM,GAAgBC,EAAO,CAC/B,MACC,CAAC,CAACA,GAAS,YAAaA,GAAS,YAAaA,GAAS,aAAcA,CAEvE,CAJSC,EAAAF,GAAA,mBAWF,SAASG,GAAkBF,EAAOG,EAAU,CAClD,IAAMC,EACLD,EAAS,OAAS,QAAU,mBAAqB,oBAC5CE,EAAc,CAAC,KAAK,KAAK,SAASD,CAAG,EAC3C,GAAI,CAACL,GAAgBC,CAAK,EAAG,MAAO,CAAE,WAAYK,CAAY,EAE9D,IAAMC,EAAS,CAAE,WAAYN,EAAM,SAAW,CAACK,EAAcA,CAAY,EACzE,OAAIL,EAAM,SAAWA,EAAM,WAC1BM,EAAO,SAAW,KAAK,KAAK,KAAO,SAAW,aAGxCA,CACR,CAZgBL,EAAAC,GAAA,qBAkBT,SAASK,GAAgBP,EAAO,CACtC,MAAI,CAACD,GAAgBC,CAAK,GAAK,EAAEA,EAAM,SAAWA,EAAM,SAChD,OACD,KAAK,KAAK,KAAO,SAAW,WACpC,CAJgBC,EAAAM,GAAA,mBCrBhB,IAAMC,GAAa,CAAC,YAAa,SAAU,MAAM,EAC3CC,GAAiB,CAAC,SAAU,QAAS,aAAa,EACtD,IAAKC,GAAY,aAAaA,IAAU,EACxC,KAAK,GAAG,EAEGC,GAAkB,CAC9B,oBAAqB,CAACC,EAAOC,IAAe,CAC3C,QAAWC,KAAQF,EAAO,EACrB,CAACC,GAAcA,EAAW,UAASC,EAAK,UAAU,IAAI,aAAa,EAEvE,IAAMC,EAAgBC,GAAaF,EAAM,oBAAoB,EAC7D,GAAIC,EAAc,OAAS,EAAG,CAC7B,GAAIF,GAAc,CAACA,EAAW,QAAS,CACtC,QAAWI,KAAUF,EACpBE,EAAO,OAAO,EAEfH,EAAK,UAAU,OAAO,aAAa,EAEpC,SAGD,GAAID,GAAc,CAACA,EAAW,QAAS,SAEvC,IAAMK,EAAY,SAAS,cAAc,GAAG,EACtCC,EACLL,EAAK,eAAe,SAAS,gBAAkB,OAC5C,sBACA,iBACJI,EAAU,UAAU,IAAI,WAAYC,CAAI,EACxCD,EAAU,QAAQ,UAAY,GAC9BA,EAAU,MAAQ,KAAK,KAAK,SAAS,aAAa,EAClDJ,EAAK,YAAYI,CAAS,EAE1BA,EAAU,iBAAiB,QAAUE,GAAU,CAC9CA,EAAM,gBAAgB,EACtB,IAAMC,EAASD,EAAM,OACrB,GAAI,EAAEC,aAAkB,aAAc,OACtC,IAAMC,EAASD,GAAQ,cACvB,GAAI,CAACC,EAAQ,OAEb,IAAMC,EAAWC,GAAgBH,EAAQR,CAAU,EACnDF,GAAgB,aAAaW,EAAQC,CAAQ,CAC9C,CAAC,EAEH,EAEA,OAAQ,CAACE,EAAMZ,EAAaW,GAAgBC,CAAI,IAAM,CACrD,IAAMb,EAAQI,GAAaS,EAAMhB,EAAc,EAAE,OAAQiB,GACxD,CAAC,IAAK,MAAM,EAAE,SAASA,EAAE,QAAQ,CAClC,EACAf,GAAgB,oBAAoBC,EAAOC,CAAU,EAErDF,GAAgB,kBACfc,EACAZ,aAAsB,MAAQA,EAAa,IAC5C,EAEA,QAAWC,KAAQF,EAAM,OAAQc,GAAMA,EAAE,QAAQ,SAAS,EAAG,CAC5D,GAAM,CAAE,UAAAC,EAAW,SAAAC,EAAU,WAAAC,EAAY,MAAAC,EAAO,UAAAC,EAAW,SAAAC,CAAS,EACnElB,EAAK,QACNA,EAAK,iBAAiB,QAAUM,GAAU,CACzC,IAAMa,EAAOC,GAASP,GAAa,EAAE,EAC/BQ,EAAaJ,GAAa,MAC1BK,EAAkB,OAAO,UAAUN,CAAK,EAC3C,CAAE,MAAO,QAAS,MAAO,OAAOA,CAAK,GAAK,EAAG,WAAAK,CAAW,EACxDL,EACH,GAAIG,GAAQ,KAAK,KAAK,QAAQ,IAAIA,CAAI,EACrC,KAAK,KAAK,QACR,IAAIA,CAAI,GACP,IAAI,CACL,MAAAb,EACA,QAASS,EACT,gBAAAO,EACA,UAAWJ,CACZ,CAAC,EACA,MAAOK,GAAW,GAAG,cAAc,KAAKA,CAAM,CAAC,MAC3C,CACN,IAAMC,EACL,KAAK,KAAK,QACTX,EAAYO,GAASP,EAAW,CAAE,MAAO,WAAY,CAAC,EAAI,EAC3D,EACGA,GAAaW,EAChBA,EAAO,CACN,MAAAlB,EACA,MAAOQ,EACP,QAASC,EACT,gBAAAO,EACA,MAAOJ,CACR,CAAC,EAED,QAAQ,KACP,gDAAgDL,IACjD,EAGH,CAAC,EAGF,QAAWb,KAAQF,EAAM,OACvBc,GAAMA,EAAE,QAAQ,UAAY,CAACA,EAAE,QAAQ,OACzC,EAAG,CACF,GAAM,CACL,SAAAa,EACA,MAAAT,EACA,UAAAU,EACA,SAAAC,EACA,WAAAC,EACA,cAAAC,EACA,UAAAC,EACA,eAAAC,CACD,EAAI/B,EAAK,QACHgC,EAAiB,mBAAoBhC,EAAK,QAC1CiC,EAAc,gBAAiBjC,EAAK,QAE1C,GAAI,CAACyB,EAAU,OAEfzB,EAAK,iBAAiB,QAAS,MAAOM,GAAU,CAC/C,IAAME,EAAS0B,GAAanC,EAAYC,CAAI,EAEtCmC,GAAU,IAAM,CACrB,OAAQL,EAAW,CAClB,IAAK,OACJ,OAAOtB,GAAQ,cAAc,KAAK,KAAM,QAAQ,EAAI,CAACA,CAAM,EAAI,CAAC,EACjE,IAAK,QACJ,OAAIA,GAAQ,SAAS,OAAO,EAAU,CAACA,CAAM,EACpC4B,GAAQ,CAAC,KAAK,OAAO,KAAK,CAAC,CACtC,CAcA,IAAMC,EAAgB,EAXF,IAAM,CACzB,IAAMC,EACLvC,aAAsB,MACnBA,EACAA,aAAsB,MAAQA,EAAW,MACvCA,EAAW,MACX,KACN,OAAOuC,GAAY,SAAW,CAACA,EAAW,SAAS,OAAQ,OAAO,EAC/DA,EACA,IACJ,GAAG,GAGDC,GAAkB,CAAE,QAAS,CAAC,MAAM,EAAG,iBAAkB,EAAK,CAAC,CACjE,EAAE,KAAK,EAEDC,EAASC,GAAc/C,GAAY+B,CAAQ,EACjD,OACCjB,GAAQ,SAAS,OAAO,GACvB6B,EAAc,SAAW,GAAK7B,GAAU,CAACgC,EAEnC,CAAChC,CAAM,EAGR6B,CACR,GAAG,EAEH,GAAIF,EAAO,SAAW,EAAG,CACxB,GAAG,cAAc,MAAM,oCAAqC,CAC3D,SAAU,EACX,CAAC,EACD,OAGD,IAAMO,EAAmB,CACxB,GAAIhB,GAAW,MAAM,GAAG,EAAE,IAAKiB,GAAMA,EAAE,KAAK,CAAC,GAAK,CAAC,EACnD,GAAIZ,GAAgB,MAAM,GAAG,EAAE,IAAKY,GAAMA,EAAE,KAAK,CAAC,GAAK,CAAC,CACzD,EACMC,EAAkBC,GAAkBvC,EAAO,CAAE,KAAM,OAAQ,CAAC,EAC5DwC,EAAY9C,EAAK,QAAQ,KAC5BoB,GAASpB,EAAK,QAAQ,IAAI,EAC1B,KAEH,OAAQyB,EAAU,CACjB,IAAK,OAAQ,CACZ,QAAWsB,KAASZ,EAAQ,CAC3B,IAAMa,EAAY,IAAID,EAAM,MAAM,OAAO,YAAYA,EAAO,CAC3D,MAAO,GACP,KAAM,OACN,UAAW,CAAC,EACZ,MAAO,CAAE,KAAM,YAAa,CAC7B,CAAC,EACKE,EAAK,OAAO,UAAU,OAAOjC,CAAK,CAAC,EACtC,CAAE,MAAOW,EAAU,MAAO,OAAOX,CAAK,CAAE,EACxC,KACHgC,EAAU,KAAK,CACd,GAAGJ,EACH,KAAME,EACN,iBAAAJ,EACA,GAAAO,CACD,CAAC,EAEF,KACD,CACA,QAAS,CACR,IAAMC,EAAgBT,GAAc/C,GAAY+B,CAAQ,EAGlD0B,EAASD,EACZ,CAAC,EACDR,EAAiB,OAAQU,GAAMA,KAAK,OAAO,KAAK,YAAY,GAC5D,CAAC,EAEJ,QAAWL,KAASZ,EAAQ,CAC3B,IAAMkB,GAAa,IAAM,CACxB,GACC5B,KAAY,OAAO,KAAK,iBACxBsB,EAAM,SAAS,UAAU,EACxB,CACD,IAAMO,EACLP,EAAM,aACJ,OAAQQ,GAAMA,EAAE,YAAc9B,CAAQ,EACtC,QAAS+B,GAAMA,EAAE,WAAa,CAAC,CAAC,EAChC,KAAK,CAACC,EAAGC,KAAMA,GAAE,MAAM,IAAMD,EAAE,MAAM,GAAG,EACxC,MAAM,GAAK,KACd,GAAIH,EAAkB,OAAOA,EAE9B,OAAOP,EAAM,aAAatB,CAAQ,CACnC,GAAG,EAEH,GAAI,CAAC4B,EAAW,CACf,QAAQ,KACPM,GAAU,kCAAkClC,GAAU,EACpD,OACH,EACA,SAGD,IAAMmC,EAAchC,EACjBK,EACCzB,EACA,KAAK,KAAK,QAAQ,MAAM,GAAG,MAC5B,KAEGqD,GAAW,IAAM,CACtB,IAAMC,EAAa,OAAOjC,CAAa,GAAK,EAC5C,OAAIb,IAAU,cACN+C,GAAYhB,EAAM,KAAK,EAAIe,EAE5B,OAAO9C,GAAS,KAAK,EAAI8C,CACjC,GAAG,EAEGb,GAAM,IAAM,CACjB,GAAI,OAAO,UAAUY,CAAO,EAC3B,MAAO,CAAE,MAAOlC,EAAU,MAAOkC,CAAQ,EAG1C,GAAIjC,EAAY,CACf,IAAMoC,EAAcJ,GAAa,aAAahC,CAAU,EACxD,OAAOoC,EACJ,CACA,UAAWA,EAAY,GACvB,MAAO,QACP,MAAOA,EAAY,GAAG,KACtB,EACA,KAGJ,OAAO,IACR,GAAG,EAMGC,GAAQ,IAAM,CACnB,IAAMC,EACLnE,aAAsB,KACnBA,EACAA,aAAsB,YACpBA,EAAW,KACX,KAEN,OAAOmE,GAAa,SACnB,SACA,OACA,iBACD,GACEhB,GAAiB,CAACgB,GAAa,SAAS,QAAQ,EAC/CA,EACA,IACJ,GAAG,EAEGC,EAAO,CACZ,GAAGvB,EACH,iBAAAF,EACA,OACCQ,GAAiB1C,aAAkB,MAAQA,EAAS,KACrD,GAAAyC,EACA,OAAQ,CAACC,GAAiBD,GAAI,UAAYW,EAAc,KACxD,KAAAK,EACA,OAAAd,CACD,EAOA,GAHC,CAACnB,GACD,CAAC,EAAEiC,GAAM,SAAS,SAAU,MAAM,GAAKA,EAAK,aAC5C,CAAC,CAAC,aAAc,cAAc,EAAE,SAASZ,EAAU,MAAM,IAAI,EACnC,CAC1B,IAAMe,EACL3C,KAAY,OAAO,KAAK,gBACrB,0BACA4B,EAAU,MAAM,OAAS,cACvB,kCACA,sBACNc,EAAK,MAAQ,MAAM,eAClB,gDACA,CACC,MAAOE,GAAeJ,EAAK,UAAU,EACrC,SAAU,KAAK,KAAK,OAAOG,EAAgB,CAC1C,KAAMf,EAAU,KACjB,CAAC,EACD,MAAOY,EAAK,IACb,CACD,EACAvB,EAAiB,KAAK,GAAG4B,GAAoBL,CAAI,CAAC,EAGnDZ,EAAU,KAAKc,CAAI,EAErB,CACD,CACD,CAAC,EAGF,IAAMI,EAAqB,CAC1B,MAAO,SACP,KAAM,OACN,KAAM,OACN,UAAW,SACX,KAAM,MACN,KAAM,OACN,OAAQ,MACT,EAEA,QAAWvE,KAAQF,EAAM,OAAQc,GAChCA,EAAE,aAAa,sBAAsB,CACtC,EAAG,CACF,GAAM,CACL,cAAA4D,EACA,YAAAC,EACA,gBAAAC,EACA,UAAAhD,EACA,SAAAiD,CACD,EAAI3E,EAAK,QACTA,EAAK,iBAAiB,QAAS,IAAM,CACpC,GAAI,CAAC,OAAO,MAAO,OAEnB,GAAI,OAAOwE,GAAkB,SAAU,CACtC,QAAQ,KAAK,0CAA0C,EACvD,OAGD,IAAMI,EAAO,KAAK,MAAMF,GAAmB,IAAI,EAK/C,OAJAE,EAAK,WAAa,OAAOH,CAAW,EACpCG,EAAK,YAAc,KAAK,KAAK,MAC7BA,EAAK,EAAIL,EAAmBC,CAAa,EAEjCI,EAAK,EAAG,CACf,IAAK,MACJA,EAAK,MACJ,OAAOD,CAAQ,GACf,OAAO,iBAAiB,SAAS,MAChC,OAAO,WAAW,SACpB,MACD,IAAK,OACJC,EAAK,QAAU,OAAO,iBAAiB,SAAS,MAChD,MACD,IAAK,OAAQ,CACZ,IAAMC,EAAWD,EAAK,UAAY,EAClCA,EAAK,SAAW,KAAK,MAAMC,EAAUA,CAAQ,EAC7CD,EAAK,MAAQC,EACbD,EAAK,UAAY,GACjB,KACD,CACD,CAEA,IAAME,EAAQ,CACb,KAAM,CAAC,CACR,EAEMC,EAAc,KAAK,KAAKH,EAAK,QAAQ,EAAI,EAAK,GAAK,EAExDnC,GAAcuC,GAAoBR,CAAa,GAC/CI,EAAK,WAAaG,IAElBD,EAAM,KAAK,UAAYN,GAGxB,IAAMS,EACLlF,aAAsB,YACnBA,EAAW,GACXmF,GAAYvE,EAAM,mBAAmB,GAAG,QAAQ,WAAa,KAC7DsE,IACHH,EAAM,KAAK,UAAYG,GAGxB,IAAMlC,EAAQb,GAAanC,EAAYC,CAAI,EAC3C,GAAI+C,GAASrB,EAAW,CACvB,IAAMyD,EAAS,CAAC,EACZpC,IACHoC,EAAO,MAAQpC,EAAM,MAElBrB,IACHyD,EAAO,OAASzD,EAAU,MAAM,GAAG,GAEpCoD,EAAM,KAAK,OAASK,EAGdC,GAAQN,EAAM,IAAI,IACxBF,EAAK,MAAQE,GAGd,OAAO,UAAU,cAAcF,CAAI,CACpC,CAAC,EAGF,QAAW5E,KAAQW,EAAK,iBAAiB,qBAAqB,EAC7DX,EAAK,QAAQ,SAAWD,EAAW,IAErC,EAEA,eAAgB,CAACQ,EAAQ8E,IAAsB,CAC9C,IAAMC,EAAS,KAAK,KAAK,SAAS/E,EAAO,QAAQ,iBAAmB,EAAE,EAEtE,MAAO,0BADQA,EAAO,QAAQ,WAAa8E,MACCC,YAAiB/E,EAAO,YAAY,KAAK,CACtF,EAEA,aAAc,MAAOA,EAAQR,EAAa,OAAS,CAClD,GACC,CAAC,CAAC,YAAa,WAAY,eAAe,EAAE,KAC1CwF,GAAMA,KAAKhF,EAAO,OACpB,EAEA,OAGD,IAAMwC,EAAQb,GAAanC,EAAYQ,CAAM,EACvC8E,GAAqBtC,GAAShD,IAAa,eAC9C,MACA,KACGyF,GAAW,IACZjF,EAAO,eAAe,SAAS,gBAAkB,OAO7C,4BANSL,GAAaK,EAAO,cAAeZ,EAAc,EAC/D,IAAKY,GACLV,GAAgB,eAAeU,EAAQ8E,CAAiB,CACzD,EACC,KAAK,MAAM,UAKPxF,GAAgB,eAAeU,EAAQ8E,CAAiB,GAC7D,EAEGI,EAAkB,YAAY,eAC9BC,EAAU3C,EACb0C,EAAgB,WAAW,CAC3B,MAAA1C,EACA,MAAOA,EAAM,gBAAgB,GAAM,EAAI,EAAE,MAAM,CAC/C,CAAC,EACD0C,EAAgB,WAAW,EAIxBE,EAAU,KAAK,SAAS,IAC7BT,GAAY3E,EAAQ,mBAAmB,GAAG,QAAQ,WAAa,EAChE,EACMuE,EACL/E,aAAsB,aACnB,CAAE,KAAM,CAAE,aAAcA,EAAW,IAAK,CAAE,EAC1C4F,GAAS,MAAM,KAAK,OAClB,CAAE,KAAM,CAAE,OAAQ,GAAG,UAAUA,EAAQ,MAAM,KAAK,MAAM,CAAE,CAAE,EAC5D,CAAC,EAEP,OAAOF,EAAgB,OAAO,CAAE,QAAAC,EAAS,QAAAF,EAAS,MAAAV,CAAM,CAAC,CAC1D,EAGA,kBAAkBnE,EAAMoC,EAAQ,KAAM,CACrC,QAAW6C,KAAY1F,GACtBS,EACA,iCACD,EAAG,CACF,IAAMkF,EAASX,GAAYU,EAAU,gBAAgB,GAAG,QAAQ,OAC1D3B,EAAOlB,GAAO,MAAM,IAAI8C,GAAU,EAAE,EACtC5B,IAAM2B,EAAS,QAAQ,SAAW3B,EAAK,MAE7C,CACD,EAGA,SAASvD,GAAgBC,EAAMZ,EAAY,CAC1C,GAAIA,EAAY,OAAOA,EAKvB,IAAMU,GAFL,GAAG,QAAQ,OAAOE,EAAK,QAAQ,YAAY,GAAG,QAAQ,KAAK,CAAC,GAAK,OAE1C,SACxB,OAAOF,aAAoB,OAASA,aAAoB,aACrDA,EACA,IACJ,CAVSqF,EAAApF,GAAA,mBAaT,SAASwB,GAAanC,EAAYgG,EAAQ,CACzC,GAAIhG,aAAsB,MAAO,OAAOA,EACxC,GAAIA,aAAsB,MAAQA,aAAsB,YACvD,OAAOA,EAAW,MAGnB,IAAMiG,EAAWD,EAAO,QAAQ,SAC1BE,EACLD,GAAY,CAACA,EAAS,WAAW,aAAa,EAC3C,aAAaA,CAAQ,EACrB,KACJ,OAAOC,aAAsB,KAAOA,EAAW,MAAQ,IACxD,CAZSH,EAAA5D,GAAA,gBAeT,SAASoC,GAAoBL,EAAMiC,EAAQ,CAAC,EAAG,CAC9C,GAAI,CAACjC,GAAM,SAAS,SAAU,MAAM,GAAK,CAACA,EAAK,WAAY,MAAO,CAAC,EAEnE,IAAM9C,EAAO8C,EAAK,MAAQ7C,GAAS6C,EAAK,IAAI,EACtCd,EAAWgD,GAChB,CACClC,EAAK,OAAO,OAAO,MACnBiC,EAAM,OAAQ9C,GAAMA,KAAK,OAAO,KAAK,YAAY,CAClD,EAAE,KAAK,CACR,EACMgD,EAAanC,EAAK,WAAW,MAEnC,OAAS7B,GAAQ,CAChB,UAAUjB,IACV,eAAeiF,IACf,oBAAoBjF,IACpB,oBAAoBiF,IACpB,GAAGjD,EAAO,IAAKC,GAAM,qBAAqBA,GAAG,CAC9C,CAAC,CACF,CAnBS0C,EAAAxB,GAAA,uBCjWF,IAAM+B,GAAN,cAA4B,eAAgB,CAUlD,YAAYC,EAAQC,EAASC,EAAU,CACtC,MAAMF,EAAQC,CAAO,EACrB,KAAK,iBAAmBC,CACzB,CAEA,MAAM,SAAU,CACf,GAAM,CAACC,EAAQC,CAAW,EAAI,KAAK,QAAQ,WACxC,CAAC,gCAAiC,wBAAwB,EAC1D,CAAC,4BAA6B,oBAAoB,EAErD,MAAO,CACN,GAAI,MAAM,MAAM,QAAQ,EACxB,SAAU,CACT,QAAS,KAAK,QAAQ,SAAS,QAC/B,IAAK,KAAK,QAAQ,SAAS,GAC5B,EACA,SAAU,KAAK,QAAQ,SACvB,UAAW,KAAK,QAAQ,UACxB,OAAAD,EACA,YAAAC,CACD,CACD,CAEA,WAAW,gBAAiB,CAC3B,MAAO,CACN,GAAG,gBAAgB,eACnB,GAAI,gBACJ,QAAS,CAAC,EACV,MAAO,KAAK,KAAK,SAAS,8BAA8B,EACxD,SAAU,yDACV,MAAO,OACP,SAAU,CACT,QAAS,EACT,IAAK,CACN,EACA,SAAU,GACV,UAAW,GACX,WAAY,EACb,CACD,CAEA,MAAM,cAAcC,EAAQC,EAAU,CACrC,KAAK,iBAAiBA,EAAS,SAAUA,EAAS,QAAQ,CAC3D,CACD,EAtDaC,EAAAR,GAAA,iBAwDb,eAAsBS,GAAcC,EAASC,EAAa,CACzD,IAAMC,EAAaF,EAAQ,WAC3B,GAAI,CAACE,EAAY,MAAMC,GAAU,4BAA4B,EAE7D,IAAMC,EAAWC,GAAU,kCAAkC,EAS7D,GAAI,EAPHJ,GACC,MAAM,OAAO,QAAQ,CACrB,MAAOG,EAAS,OAAO,EACvB,QAASE,GAAkB,IAAK,CAC/B,SAAU,CAACF,EAAS,SAAU,CAAE,WAAYJ,EAAQ,IAAK,CAAC,CAAC,CAC5D,CAAC,EAAE,SACJ,CAAC,GACc,OAEhB,IAAMO,EAAgBP,EAAQ,OAAO,EAC/BQ,GAAiB,SAAY,CAElC,IAAMC,EAAQT,EAAQ,SAAS,YAAY,EACxCE,EAAW,OAAO,UAAU,kBAC5BF,EAAQ,MAAM,CAAE,4BAA6B,MAAO,CAAC,CACrD,EACA,KACGU,EACL,CAAC,CAACR,EAAW,OAAS,CAACA,EAAW,MAAM,MAAM,IAAIF,EAAQ,EAAE,EAC7D,OACCS,GAAO,OAAO,CAAE,kBAAmBA,EAAM,SAAW,CAAE,CAAC,GACvD,KAAK,eAAe,OACnB,YAAYT,EAAQ,SAAS,EAAG,CAC/B,qBAAsBE,EAAW,OAAO,WACzC,CAAC,EACD,CAAE,OAAQA,EAAW,MAAO,OAAAQ,CAAO,CACpC,CAEF,GAAG,EAEH,MAAM,QAAQ,IAAI,CAACH,EAAeC,CAAa,CAAC,CACjD,CArCsBV,EAAAC,GAAA,iBAuCtB,eAAsBY,GAAqBC,EAAOC,EAAMC,EAAOtB,EAAU,CAAC,EAAG,CAC5E,IAAMuB,EAAkB,YAAY,eAI9BC,EAAW,+BADJC,GAASJ,EAAK,IAAI,aAEzBK,EAAQJ,EAAM,MACdK,EAAcC,GAAYR,GAAO,OAAQ,OAAO,EAChDS,EAAc7B,EAAQ,MAAQ,CAAE,GAAI2B,GAAa,SAAW,CAAC,CAAG,EAChEG,EAAe,CACpB,MAAOR,EACP,QAASI,EAAQ,GAAGA,EAAM,QAAQ,MAAMA,EAAM,KAAO,KACrD,KAAML,EACN,KAAM,MAAMA,EAAK,YAAY,OAAWQ,CAAW,CACpD,EAGME,EACLX,aAAiB,WAAaA,EAAQA,GAAO,cACxCY,EAAWhC,EAAQ,UAAYiC,GAAgBF,CAAa,EAC5DG,EAAWX,EAAgB,cAChC,CACC,KAAM,MAAM,mBAAmB,MAC/B,QAASA,EAAgB,WAAW,CACnC,MAAOD,EACP,MAAOA,EAAM,gBAAgB,GAAO,EAAI,EAAE,GAAG,CAAC,CAC/C,CAAC,EACD,QAAS,MAAM,eAAeE,EAAUM,CAAY,EACpD,MAAO,CAAE,KAAM,CAAE,OAAQT,EAAK,cAAc,CAAE,CAAE,CACjD,EACAW,CACD,EAGA,OAAOhC,EAAQ,QAAU,GACtBuB,EAAgB,OAAOW,EAAU,CAAE,SAAAF,EAAU,YAAa,EAAM,CAAC,EACjE,IAAIT,EAAgBW,EAAU,CAAE,SAAAF,CAAS,CAAC,CAC9C,CArCsB1B,EAAAa,GAAA,wBCvQf,IAAMgB,GAA4B,CACxC,aAAc,GACd,MAAO,GACP,SAAU,EACV,gBAAiB,EACjB,oBAAqB,kBACrB,WAAY,UACZ,WAAY,UACZ,oBAAqB,iBACtB,EAEaC,GAA4B,CACxC,kBACA,UACA,UACA,iBACD,EAvBAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GAAAC,GA6BaC,GAAN,KAAsB,CAM5B,YAAYC,EAAMC,EAAIC,EAAiB,KAAM,CAiC7CC,GAAA,KAAAZ,IA0BAY,GAAA,KAAAV,IAmBAU,GAAA,KAAAR,IAkBAQ,GAAA,KAAAN,IA/FKG,aAAgB,MACnB,KAAK,WACHA,EAAK,gBACHA,EAAK,MAAM,KAAMI,GAAMA,aAAa,WAAW,EAC/CJ,EAAK,KAAK,KAAMK,GAAMA,aAAa,KAAOA,EAAE,QAAU,EAAE,IACxD,OAAS,EACb,KAAK,UAAYL,EAAK,QAEtB,KAAK,UAAYA,EAAK,SACtB,KAAK,UAAYA,EAAK,SAAWA,EAAK,UAGvC,KAAK,GAAK,OAAOC,GAAO,SAAW,CAAE,MAAOA,CAAG,EAAIA,EAEnD,KAAK,WAAaK,EAAA,KAAKT,GAAAC,IAAL,WAClB,KAAK,WAAaQ,EAAA,KAAKf,GAAAC,IAAL,UACjB,KAAK,WACLU,GAKD,KAAK,MAAQ,KAAK,WACfI,EAAA,KAAKb,GAAAC,IAAL,UAA4B,KAAK,WAAW,OAAQ,KAAK,YACzD,KAAK,UACT,CAuFD,EAvHaa,GAANR,GAAMS,EAAAD,GAAA,mBAuCZhB,GAAA,YAAAC,GAAoBgB,EAAA,SAACC,EAAQC,EAAa,CACzC,GAAI,CAACA,EAAa,OAAO,KAEzB,QAAWC,IAAW,CAAC,MAAO,GAAGrB,EAAyB,EAAG,CAC5D,GAAM,CAAE,MAAAsB,EAAO,OAAAC,CAAO,EAAIH,EAAYC,CAAO,GAAK,CAAC,EACnD,GACCE,GACAD,GACA,EACCH,IAAWV,GAAgB,kBAC3Bc,IAAWxB,GAA0B,WAEtC,EACCoB,IAAWV,GAAgB,kBAC3Bc,IAAWxB,GAA0B,SAErCsB,IAAY,OACZrB,GAA0B,QAAQqB,CAAO,IAAMF,GAEhD,MAAO,CAAE,MAAAG,EAAO,OAAAC,CAAO,EAIzB,OAAO,IACR,EAxBoB,wBA0BpBpB,GAAA,YAAAC,GAAsBc,EAAA,SAACK,EAAQC,EAAiB,CAC/C,OAAQD,EAAQ,CACf,IAAK,kBACJ,MAAO,GACR,IAAK,UACJ,MAAO,GACR,IAAK,UACJ,MAAO,GACR,IAAK,kBACJ,MAAO,GACR,QACC,OAAO,KAAK,QAAQC,EAAkBD,EAAQ,EAAG,CAAC,CACpD,CACD,EAbsB,0BAmBtBlB,GAAA,YAAAC,GAAuBY,EAAA,SAACC,EAAQ,CAC/B,OAAI,KAAK,YAAc,GACfH,EAAA,KAAKb,GAAAC,IAAL,UACNL,GAA0B,SAC1BoB,GAIE,KAAK,YAAc,EACfH,EAAA,KAAKb,GAAAC,IAAL,UACNL,GAA0B,MAC1BoB,GAIKA,CACR,EAhBuB,2BAkBvBZ,GAAA,YAAAC,GAAyBU,EAAA,UAAG,CAC3B,IAAMP,EAAK,KAAK,GAAG,MAEnB,OAAI,KAAK,UAAYA,GAAM,GACnBK,EAAA,KAAKX,GAAAC,IAAL,UAA6BG,GAAgB,kBAGjDE,EAAK,KAAK,WAAa,GACnBK,EAAA,KAAKX,GAAAC,IAAL,UAA6BG,GAAgB,kBAGjD,KAAK,WAAaE,EACdK,EAAA,KAAKX,GAAAC,IAAL,UAA6BG,GAAgB,SAG9CO,EAAA,KAAKX,GAAAC,IAAL,UAA6BG,GAAgB,QACrD,EAhByB,6BApEzBgB,GAlCYR,GAkCL,mBAAmB,GAC1BQ,GAnCYR,GAmCL,UAAU,GACjBQ,GApCYR,GAoCL,UAAU,GACjBQ,GArCYR,GAqCL,mBAAmB,GChE3B,IAAMS,GAAe,kDAErB,eAAsBC,GAAWC,EAAO,CACvC,SAASC,EAAOC,EAAS,CACxB,YAAY,OAAO,CAClB,KAAM,KAAK,KAAK,GAChB,QAAAA,EACA,QAAS,YAAY,WAAW,CAAE,MAAAF,CAAM,CAAC,CAC1C,CAAC,CACF,CANSG,EAAAF,EAAA,UAQT,GAAM,CAAE,KAAAG,EAAM,WAAAC,EAAY,OAAAC,CAAO,EAAIN,EAC/BO,EAAKF,EAAW,GAAG,GACnBG,EAAUF,EAAO,UAAU,QAC3BG,EAAcC,EAAS,mBAAoB,CAAE,KAAAN,CAAK,CAAC,EACnDO,EAAY,KAAK,KAAK,OAC3B,0CACA,CAAE,KAAAP,CAAK,CACR,EAEA,GAAIG,EAAG,QAAUA,EAAG,IAAK,OAAO,GAAG,cAAc,KAAKE,CAAW,EACjE,GAAID,EAAQ,MAAQ,EAAG,OAAO,GAAG,cAAc,KAAKG,CAAS,EAE7D,IAAMC,EAAWZ,EAAM,UAAU,KAAK,KACpCa,GAASA,EAAK,WAAaf,EAC7B,EACMI,EAAU,MAAM,eAAeY,EAAa,iBAAiB,EAAG,CACrE,SAAAF,EACA,KAAOG,GAAQL,EAAS,eAAeK,GAAK,CAC7C,CAAC,EAED,IAAI,OAAO,CACV,MAAOL,EAAS,mBAAmB,EACnC,QAAAR,EACA,QAAS,CACR,IAAK,CACJ,KAAM,+BACN,MAAOQ,EAAS,iBAAiB,EACjC,SAAU,MAAOM,GAAS,CACzB,GAAM,CAAE,WAAAX,EAAY,OAAAC,CAAO,EAAIN,EACzBO,EAAKF,EAAW,GAAG,GACnBG,EAAUF,EAAO,UAAU,QAEjC,GAAIC,EAAG,QAAUA,EAAG,IAAK,OAAON,EAAOQ,CAAW,EAClD,GAAID,EAAQ,MAAQ,EAAG,OAAOP,EAAOU,CAAS,EAE9C,IAAMM,EAAWD,EAAK,KAAK,eAAe,EAAE,IAAI,EAC1CE,EAAQ,GAAGX,EAAG,SAASA,EAAG,MAEhC,GAAIU,IAAa,WAChBhB,EAAOS,EAAS,4BAA6B,CAAE,KAAAN,EAAM,MAAAc,CAAM,CAAC,CAAC,EAC7D,MAAMlB,EAAM,OAAO,CAClB,gCAAiCO,EAAG,IACpC,iCAAkCC,EAAQ,MAAQ,CACnD,CAAC,MACK,CACNP,EACC,KAAK,KAAK,OAAO,+CAAgD,CAChE,KAAAG,EACA,MAAAc,CACD,CAAC,CACF,EACA,IAAMC,EAAQZ,EAAG,MAAQ,KAAK,MAAMA,EAAG,IAAM,CAAC,EAC9C,MAAMP,EAAM,OAAO,CAClB,gCAAiC,KAAK,IAAImB,EAAOZ,EAAG,GAAG,EACvD,iCAAkCC,EAAQ,MAAQ,CACnD,CAAC,EAEH,CACD,EACA,GAAI,CACH,KAAM,+BACN,MAAOE,EAAS,gBAAgB,CACjC,CACD,CACD,CAAC,EAAE,OAAO,EAAI,CACf,CA1EsBP,EAAAJ,GAAA,cCFf,IAAMqB,GAAQ,CAAC,IAAK,IAAK,IAAK,IAAK,GAAG,EAEvCC,GAAa,sDAEZ,SAASC,EAAwBC,EAAI,CAC3C,IAAMC,EAAWD,EAAG,KAAK,OAAO,EAEhCC,EAAS,GAAG,aAAeC,GAAU,CACpCA,EAAM,eAAe,EAErB,IAAMC,EAASD,EAAM,cACf,CAAE,MAAAE,CAAM,EAAID,EAAO,sBAAsB,EAC/C,GAAIA,EAAO,aAAe,KAAK,KAAKC,CAAK,EAAG,OAE5C,IAAMC,EAAOF,EAAO,UAAU,KAAK,EACnC,KAAK,QAAQ,SAASD,EAAM,cAAe,CAC1C,KAAMG,EACN,UAAW,eAAe,mBAAmB,EAC9C,CAAC,CACF,CAAC,EAEDJ,EAAS,GAAG,aAAeC,GAAU,CACpCA,EAAM,eAAe,EACrB,KAAK,QAAQ,WAAW,CACzB,CAAC,EAEDD,EAAS,GAAG,YAAcC,GAAU,CACnC,KAAK,QAAQ,WAAW,CACzB,CAAC,CACF,CAzBgBI,EAAAP,EAAA,2BA2BT,SAASQ,GAAmBP,EAAIQ,EAAO,CAC7C,GAAM,CAAE,OAAAC,EAAQ,SAAAC,EAAU,QAAAC,EAAS,SAAAC,CAAS,EAAIZ,EAAG,QAEnD,GAAIW,EAEH,OADmBH,EAAM,aAAa,YAAY,IAAIG,CAAO,GAC1C,IAAIF,CAAM,EAG9B,IAAMI,EAAOL,EAAM,MAAM,IAAIE,GAAYD,CAAM,EAC/C,OAAOC,EAAWG,GAAM,SAAS,IAAIJ,CAAM,EAAII,CAChD,CAVgBP,EAAAC,GAAA,sBAYT,SAASO,EAAiBZ,EAAOM,EAAO,CAC9C,IAAMR,EAAKE,EAAM,cAAc,QAAQ,gBAAgB,EACvD,OAAOK,GAAmBP,EAAIQ,CAAK,CACpC,CAHgBF,EAAAQ,EAAA,oBAKT,SAASC,GAAUP,EAAO,CAChC,OAAOA,EAAM,QACVQ,GAAQR,EAAO,UAAU,KAAK,KAAK,IAAI,GACrC,IAAKS,GAAS,CACf,IAAMC,EAAQ,aAAaD,CAAI,EAC/B,OAAKC,EACE,CAAE,IAAKA,EAAM,IAAK,KAAMA,EAAM,KAAM,KAAAD,CAAK,EAD7B,IAEpB,CAAC,EACA,OAAO,OAAO,EACf,MACJ,CAVgBX,EAAAS,GAAA,aAYT,SAASI,GAAejB,EAAOM,EAAO,CAC5C,GAAM,CAAE,KAAAY,EAAM,KAAAH,CAAK,EAAI,WAAW,iBAAiBf,EAAM,aAAa,GAAK,CAAC,EAC5E,GAAIkB,IAAS,SAAW,CAAC,aAAaH,CAAI,EAAG,OAE7C,IAAMI,EAAO,UAAU,KAAK,KAAK,KAC3BC,EAASN,GAAQR,EAAOa,CAAI,GAAG,MAAM,GAAK,CAAC,EAC7CC,EAAO,SAASL,CAAI,IAExBK,EAAO,KAAKL,CAAI,EAChBM,GAAQf,EAAOa,EAAMC,CAAM,EAC5B,CAVgBhB,EAAAa,GAAA,kBAYT,SAASK,GAAYtB,EAAOM,EAAO,CACzC,IAAMa,EAAO,UAAU,KAAK,KAAK,KAC3BC,EAASN,GAAQR,EAAOa,CAAI,GAAG,MAAM,EAC3C,GAAI,CAACC,GAAQ,OAAQ,OAErB,GAAM,CAAE,KAAAL,CAAK,EAAIf,EAAM,cAAc,QAAQ,QAAQ,EAAE,QACjDuB,EAAQH,EAAO,QAAQL,CAAI,EAC7BQ,IAAU,KAEdH,EAAO,OAAOG,EAAO,CAAC,EACtBF,GAAQf,EAAOa,EAAMC,CAAM,EAC5B,CAXgBhB,EAAAkB,GAAA,eAaT,SAASE,GAAgBC,EAAY,IAAM,GAAM,CACvD,IAAMC,EAAU,KAAK,KAAK,QACpBzB,EAASyB,EAAQ,OAAS,EAAIA,EAAQ,MAAM,EAAI,KACtD,OAAOzB,GAAUwB,EAAUxB,CAAM,EAAIA,EAAS,IAC/C,CAJgBG,EAAAoB,GAAA,mBAMT,SAASG,EAASC,EAAOC,EAAQ,CACvC,OAAKA,EACED,EAAM,YAAY,EAAE,SAASC,CAAM,EADtB,EAErB,CAHgBzB,EAAAuB,EAAA,YAKT,SAASG,EAAcC,EAAGC,EAAG,CACnC,OAAOD,EAAE,cAAcC,EAAG,KAAK,KAAK,IAAI,CACzC,CAFgB5B,EAAA0B,EAAA,iBAIT,SAASG,GAAe3B,EAAO,CACrC,OAAOA,GAAO,UAAU,OAAO,KAC7B4B,GAAWA,EAAO,MAAM,MAAM,WAAatC,EAC7C,CACD,CAJgBQ,EAAA6B,GAAA,kBClGhB,eAAsBE,GAAMC,EAAOC,EAASC,EAAO,CAClD,IAAMC,EAAMC,GAAO,EACbC,EAAKF,GAAK,QAChB,GAAI,CAACE,EAAI,OAETA,EAAG,KAAK,UAAU,EAAE,OAAO,EAE3B,IAAMC,EAAM,SAAS,cAAc,KAAK,EACxCA,EAAI,UAAY;AAAA;AAAA,6BAEYN;AAAA,uFAC0DO,EAClF,aACD;AAAA;AAAA,QAIH,IAAMR,EAAQO,EAAI,kBAClB,GAAI,OAAOL,GAAY,SAAU,CAChC,IAAMO,EAAW,MAAMC,GAAWR,EAASC,CAAK,EAChDH,EAAM,mBAAmB,YAAaS,CAAQ,OAE9CT,EAAM,OAAOE,CAAO,EAGrBF,EACE,cAAc,2BAA2B,EACzC,iBAAiB,QAAS,IAAMA,EAAM,OAAO,CAAC,EAEhD,IAAMW,EAAeX,EAAM,iBAAiB,2BAA2B,EACvE,QAAWY,KAAQD,EAClBC,EAAK,iBAAiB,QAAS,IAAMZ,EAAM,OAAO,CAAC,EAGpDM,EAAG,OAAON,CAAK,EACfI,EAAI,KAAK,CACV,CApCsBS,EAAAb,GAAA,SAsCtB,eAAsBc,EAAgBR,EAAIH,EAAOF,EAAO,CACvD,IAAMc,EAAUT,EAAG,KAAK,EAClBU,EAAOD,EAAQ,OAClBE,GAAmBX,EAAG,CAAC,EAAGH,CAAK,EAC/B,MAAM,SAASY,EAAQ,IAAI,EAExBG,EAAO,MAAMF,GAAM,YAAY,CAAE,QAASb,EAAM,OAAQ,EAAGY,CAAO,EACxE,GAAI,CAACG,EAAM,OAEX,IAAMC,EAAc,SAAS,cAAc,KAAK,EAMhD,GALAA,EAAY,UAAU,IAAI,mBAAmB,EAE7C,MAAMhB,EAAM,MAAM,aAAa,kBAAkBgB,EAAaH,EAAME,CAAI,EACxEE,GAAgB,OAAOD,EAAaH,CAAI,EAEpCA,EAAK,SAAS,YAAY,EAAG,CAChC,IAAML,EAAeQ,EAAY,iBAChC,8BACD,EACA,QAAWE,KAAOV,EACjBU,EAAI,iBAAiB,QAAS,IAAML,EAAK,QAAQ,CAAC,EAIhDD,EAAQ,WACXI,EAAY,QAAQ,SAAWJ,EAAQ,UAGxC,IAAMO,EAAarB,GAASK,EAAG,KAAK,OAAO,EAAE,KAAK,EAClDN,GAAMsB,EAAW,KAAK,EAAGH,EAAahB,CAAK,CAC5C,CA9BsBU,EAAAC,EAAA,mBCtCtB,IAAMS,GAAS,CACd,SACA,WACA,WACA,SACA,YACA,WACA,SACD,EAEMC,GAAU,CACf,EAAG,CACF,KAAM,iFACN,KAAM,iBACP,EACA,EAAG,CAAE,KAAM,0CAA2C,KAAM,SAAU,EACtE,EAAG,CAAE,KAAM,oCAAqC,KAAM,SAAU,EAChE,EAAG,CACF,KAAM,qEACN,KAAM,iBACP,CACD,EAEA,eAAsBC,GAAqBC,EAAO,CACjD,IAAMC,EAAO,MAAM,IAAI,KAAK,MAAM,EAAE,SAAS,CAAE,MAAO,EAAK,CAAC,EACtDC,EAAYD,EAAK,KAAK,CAAC,EAAE,MACzBE,EAAaD,IAAc,EAAI,IAAMA,IAAc,GAAK,IAAM,GAC9DE,EAAQ,OAAO,OAAOJ,EAAM,MAAM,EAAE,OAAQK,GAAUA,EAAM,IAAI,EAChEC,EAASC,GACbD,GAAWA,EAAO,OAAO,iBAC3B,GAAG,MAEGE,EAAO,CACZ,WAAAL,EACA,UAAAD,EACA,OAAAI,EACA,KAAOG,GAAQC,EAAS,4BAA4BD,GAAK,CAC1D,EAEA,GAAIH,EAAQ,CACX,GAAM,CAAE,SAAAK,EAAU,OAAAC,EAAQ,KAAAC,CAAK,EAAIP,EAAO,kBAEtCQ,EAAYH,EAAS,YAAY,MAAM,EAC3CG,EAAU,OAAS,EACnBA,EAAY,CAAC,GAAGA,CAAS,EAEzB,IAAMC,EAAWF,EAAK,IAAI,CAAC,CAAE,YAAAG,CAAY,IAAM,CAC9C,IAAMC,EAAMD,EACZ,OAAAC,EAAI,OAAS,EACN,CAAC,GAAGA,CAAG,CACf,CAAC,EAEDT,EAAK,UAAYM,EACjBN,EAAK,SAAWO,EAEhBP,EAAK,OAAS,MAAM,QAAQ,IAC3BI,EAAO,IAAKM,GAAS,CACpB,IAAMb,EAAQL,EAAM,OAAOkB,CAAI,EAC/B,OAAOC,GAAUd,EAAOH,EAAWY,CAAS,CAC7C,CAAC,CACF,EAEAN,EAAK,MAAQ,MAAM,QAAQ,IAC1BJ,EAAM,IAAKS,GAASM,GAAUN,EAAMX,CAAS,CAAC,CAC/C,OAEAM,EAAK,OAAS,MAAM,QAAQ,IAC3B,CAAC,GAAGX,GAAO,IAAKqB,GAASlB,EAAM,OAAOkB,CAAI,CAAC,EAAG,GAAGd,CAAK,EAAE,IAAKC,GAC5Dc,GAAUd,EAAOH,CAAS,CAC3B,CACD,EAGD,IAAMkB,EAASC,EAAW,SAAS,EAE7BC,EAAU,CACf,QAAS,YAAY,WAAW,CAAE,MAAAtB,CAAM,CAAC,EACzC,SAAU,KAAK,KAAK,SAAS,SAAS,aACnC,MAAM,gBAAgB,OACtB,MAAM,gBAAgB,MACzB,KAAM,MAAM,mBAAmB,IAChC,EAEIoB,IACHE,EAAQ,MAAQ,CAACrB,CAAI,EACrBO,EAAK,OAAS,IAGfc,EAAQ,OAAS,MAAM,eACtBC,EAAa,uBAAuB,EACpCf,CACD,EAEA,YAAY,OAAOc,CAAO,CAC3B,CAvEsBE,EAAAzB,GAAA,wBAyEtB,eAAeoB,GAAUd,EAAOH,EAAWe,EAAK,CAC/C,GAAM,CAAE,KAAAQ,EAAM,MAAAC,CAAM,EAAIrB,EAElBJ,EAAO,MAAMI,EAAM,KAAK,CAC7B,cAAe,GACf,WAAY,GACZ,iBAAkB,CAAC,yBAAyB,CAC7C,CAAC,EAEKsB,EAAM1B,EAAK,MAAQA,EAAK,KAAK,CAAC,EAAE,MAEhC2B,EAAW,CAChB,SAAU1B,EACV,SAAUyB,CACX,EAEA,MAAO,CACN,IAAAA,EACA,KAAAF,EACA,MAAAC,EACA,MAAOxB,EAAYyB,EACnB,SAAUE,EAASF,CAAG,EACtB,UAAWG,GAAML,CAAI,EACrB,OAAQR,GAAK,IAAKc,GAAO,CACxB,GAAI,CAACA,EAAI,MAAO,IAChB,IAAMC,EAAU,IAAIC,GAAgBL,EAAUG,CAAE,EAAE,MAClD,MAAO,CACN,QAAAC,EACA,KAAMlC,GAAQkC,CAAO,EAAE,KACvB,MAAOlC,GAAQkC,CAAO,EAAE,IACzB,CACD,CAAC,CACF,CACD,CAjCeR,EAAAL,GAAA,aCzFf,IAAMe,GAAY,iBAEZC,GACL,kDAEKC,GAAgB,IAAI,IAAI,CAC7B,sDACA,qDACD,CAAC,EACKC,GAAe,kDACfC,GAAwB,kDACxBC,GACL,sDAEKC,GAAS,CACd,WAAY,uBACZ,mBAAoB,6BACpB,eAAgB,qDAChB,WAAY,GAAGN,+BACf,YAAa,GAAGA,gCAChB,sBAAuB,GAAGA,wCAC1B,iBAAkB,GAAGA,mCACrB,mBAAoB,GAAGA,qCACvB,iBAAkB,GAAGA,mCACrB,sBAAuB,GAAGA,uCAC3B,EAEMO,GAAgB,CACrB,IAAK,oDACL,eAAgB,oDAChB,KAAM,oDACN,QAAS,oDACT,OAAQ,oDACR,oBAAqB,oDACrB,iBAAkB,oDAClB,qBAAsB,oDACtB,QAAS,oDACT,mBAAoB,oDACpB,sBAAuB,oDACvB,mBAAoB,oDACpB,iBAAkB,oDAClB,gBAAiB,oDACjB,MAAO,oDACP,aAAc,oDACd,QAAS,oDACT,YAAa,oDACb,YAAa,oDACb,WAAY,oDACZ,MAAO,oDACP,KAAM,oDACN,KAAM,oDACN,OAAQ,oDACR,OAAQ,oDACR,MAAO,oDACP,iBAAkB,GAClB,WAAY,oDACZ,mBAAoB,oDACpB,qBAAsB,oDACtB,YAAa,oDACb,IAAK,oDACL,MAAO,oDACP,OAAQJ,GACR,qBAAsB,oDACtB,qBAAsB,oDACtB,QAAS,oDACT,OAAQ,oDACR,WAAY,oDACZ,uBAAwB,oDACxB,gBAAiB,oDACjB,eAAgB,oDAChB,YAAa,oDACb,oBAAqB,oDACrB,QAAS,oDACT,sBAAuB,GACvB,QAAS,oDACT,iBAAkB,oDAClB,oBAAqB,oDACrB,KAAM,oDACN,MAAO,oDACP,kBAAmB,oDACnB,eAAgB,oDAChB,MAAO,oDACP,iBAAkB,oDAClB,MAAO,oDACP,iBAAkB,oDAClB,cAAe,mDAChB,EAEMK,GAAmB,CACxB,OAAQ,CAAE,KAAM,SAAU,KAAM,IAAK,QAAS,EAAK,EACnD,mBAAoB,CAAE,KAAM,mBAAoB,KAAM,IAAK,OAAQ,EAAK,EACxE,mBAAoB,CAAE,KAAM,mBAAoB,QAAS,EAAK,EAC9D,iBAAkB,CAAE,KAAM,iBAAkB,QAAS,EAAK,EAC1D,gBAAiB,CAAE,KAAM,gBAAiB,QAAS,EAAK,CACzD,EAEMC,GAAS,CACd,CACC,KAAM,aACN,QAAS,CACR,CAAE,KAAM,eAAgB,KAAM,GAAI,EAClC,CAAE,KAAM,OAAQ,KAAM,GAAI,CAC3B,CACD,EACA,CACC,KAAM,aACN,QAAS,CACR,CAAE,KAAM,UAAW,KAAM,GAAI,EAE7B,CAAE,KAAM,iBAAkB,KAAM,GAAI,EACpC,CAAE,KAAM,qBAAsB,KAAM,IAAK,QAAS,EAAK,EACvD,CAAE,KAAM,UAAW,QAAS,EAAK,CAClC,CACD,EACA,CACC,KAAM,SACN,QAAS,CAER,CAAE,KAAM,sBAAuB,QAAS,EAAK,EAC7C,mBACA,iBACA,eACD,CACD,EACA,CACC,KAAM,YACN,QAAS,CACR,CAAE,KAAM,QAAS,KAAM,GAAI,EAE3B,CACC,KAAM,aACN,KAAM,IACN,IAAK,GACL,UAAW,CACV,CACC,UAAYC,GACX,CAACA,EAAM,UAAU,UAAU,KACzBC,GAASA,EAAK,QAAUT,GAAc,IAAIS,EAAK,QAAQ,CACzD,EACD,UAAW,CACV,CACC,KAAM,kBACN,SAAU,GACV,KAAM,cACP,CACD,CACD,CACD,CACD,EACA,CAAE,KAAM,UAAW,KAAM,IAAK,IAAK,GAAM,MAAO,EAAK,EACrD,CAAE,KAAM,YAAa,KAAM,GAAI,EAC/B,CAAE,KAAM,YAAa,KAAM,GAAI,EAC/B,CAAE,KAAM,aAAc,KAAM,IAAK,IAAK,GAAM,MAAO,EAAK,EACxD,CAAE,KAAM,QAAS,KAAM,IAAK,IAAK,GAAM,MAAO,EAAK,EACnD,CAAE,KAAM,OAAQ,KAAM,GAAI,EAC1B,CAAE,KAAM,OAAQ,KAAM,IAAK,IAAK,GAAM,MAAO,EAAK,EAClD,CACC,KAAM,SACN,KAAM,IACN,IAAK,GACL,QAAS,GACT,MAAO,EACR,CACD,CACD,EACA,CACC,KAAM,WACN,QAAS,CAER,CAAE,KAAM,QAAS,EACjB,CAAE,KAAM,QAAS,QAAS,EAAK,EAC/B,CAAE,KAAM,iBAAkB,QAAS,EAAK,EACxC,CAAE,KAAM,aAAc,KAAM,EAAG,QAAS,EAAK,EAC7C,CAAE,KAAM,mBAAoB,QAAS,EAAK,CAC3C,CACD,EACA,CACC,KAAM,YACN,QAAS,CACR,CACC,KAAM,qBACN,KAAM,IACN,SAAU,CAAC,oBAAqB,UAAW,OAAO,CACnD,EACA,CAAE,KAAM,aAAc,EACtB,CAAE,KAAM,KAAM,EACd,CAAE,KAAM,QAAS,KAAM,IAAK,QAAS,EAAK,CAC3C,CACD,EACA,CACC,KAAM,YACN,QAAS,CACR,CACC,KAAM,SACN,KAAM,IACN,UAAYD,GAAUE,GAAQF,EAAOP,EAAY,CAClD,EACA,CAAE,KAAM,oBAAqB,EAC7B,CAAE,KAAM,oBAAqB,EAC7B,CAAE,KAAM,UAAW,KAAM,GAAI,CAC9B,CACD,EACA,CACC,KAAM,eACN,QAAS,CAAC,CAAE,KAAM,QAAS,EAAG,CAAE,KAAM,aAAc,KAAM,GAAI,CAAC,CAChE,EACA,CACC,KAAM,WACN,QAAS,CACR,CACC,KAAM,uBACN,KAAM,IACN,SAAU,CAAC,YAAa,eAAe,EACvC,WAAY,sBACb,EACA,CAAE,KAAM,gBAAiB,QAAS,EAAK,EACvC,CAAE,KAAM,eAAgB,KAAM,IAAK,QAAS,EAAK,EACjD,CAAE,KAAM,cAAe,QAAS,EAAK,CACtC,CACD,EACA,CACC,KAAM,SACN,QAAS,CACR,CAAE,KAAM,oBAAqB,KAAM,GAAI,EAEvC,iBACA,gBACA,CACC,KAAM,cACN,QAAS,GACT,UAAYO,GAAUE,GAAQF,EAAON,EAAqB,CAC3D,CACD,CACD,EACA,CACC,KAAM,YACN,QAAS,CAER,mBACA,iBACA,eACD,CACD,EACA,CACC,KAAM,cACN,QAAS,CACR,CACC,KAAM,UACN,KAAM,IACN,SAAU,CACT,SACA,SACA,QACA,YACA,UACA,aACA,UACA,UACA,OACD,CACD,EACA,CAAE,KAAM,sBAAuB,QAAS,EAAK,CAC9C,CACD,EACA,CACC,KAAM,WACN,QAAS,CAER,mBACA,iBACA,eACD,CACD,EACA,CACC,KAAM,UACN,QAAS,CAER,CAAE,KAAM,SAAU,EAClB,CAAE,KAAM,iBAAkB,QAAS,EAAK,EACxC,kBACD,CACD,EACA,CACC,KAAM,UACN,QAAS,CACR,CAAE,KAAM,oBAAqB,KAAM,GAAI,EACvC,CAAE,KAAM,OAAQ,KAAM,GAAI,EAC1B,CAAE,KAAM,QAAS,KAAM,GAAI,CAC5B,CACD,EACA,CACC,KAAM,WACN,QAAS,CACR,CAAE,KAAM,iBAAkB,EAC1B,CAAE,KAAM,SAAU,EAClB,CAAE,KAAM,eAAgB,QAAS,EAAK,EACtC,CAAE,KAAM,QAAS,QAAS,EAAK,CAChC,CACD,EACA,CACC,KAAM,WACN,QAAS,CACR,CAAE,KAAM,iBAAkB,KAAM,GAAI,EACpC,CAAE,KAAM,QAAS,KAAM,GAAI,EAC3B,CAAE,KAAM,iBAAkB,KAAM,IAAK,QAAS,EAAK,EACnD,CAAE,KAAM,cAAe,KAAM,IAAK,QAAS,EAAK,CACjD,CACD,CACD,EAEA,QAAWS,KAASJ,GAAQ,CAC3BI,EAAM,QAAUA,EAAM,QAAQ,IAAKC,GAClC,OAAOA,GAAW,SAAWN,GAAiBM,CAAM,EAAIA,CACzD,EAEA,GAAM,CAAE,KAAAC,EAAM,QAAAC,CAAQ,EAAIH,EAC1B,QAAWC,KAAUE,EAAS,CAC7B,IAAMC,EAAYH,EAAO,KACvB,QAAQ,QAAS,CAACI,EAAGC,IAAMA,EAAE,YAAY,CAAC,EAC1C,WAAW,EAMb,GAJAL,EAAO,UAAYC,EACnBD,EAAO,KAAOP,GAAcO,EAAO,IAAI,EACvCA,EAAO,MAAQR,GAAOQ,EAAO,IAAI,GAAK,gBAAgBG,UAElDH,EAAO,SACVA,EAAO,SAAWA,EAAO,SAAS,IAAKM,IAAa,CACnD,KAAMA,EACN,MAAO,GAAGpB,qBAA4BoB,GACvC,EAAE,UACQN,EAAO,IAAK,CACtB,IAAMO,EAAQ,CAAC,CAACP,EAAO,MAEvBA,EAAO,SAAW,CACjB,CAAE,MAAO,kBAAmB,EAC5B,CACC,MAAO,4BACP,IAAK,EACL,MAAAO,EACA,SAAUA,EAAQ,GAAK,EACxB,EACA,CACC,MAAO,4BACP,IAAK,EACL,MAAAA,EACA,SAAUA,EAAQ,GAAK,GACxB,CACD,EAGD,OAAW,CAAE,UAAAC,CAAU,IAAKR,EAAO,WAAa,CAAC,EAChD,QAAWS,KAAYD,EACtBC,EAAS,MAAQ,GAAGvB,uBAA8BuB,EAAS,QAMxD,IAAMC,GAAef,GAAO,IAAKI,GAAUA,EAAM,IAAI,EAEtDY,GAAahB,GAAO,OAAO,CAACiB,EAAQ,CAAE,KAAAX,EAAM,QAAAC,CAAQ,KACzDU,EAAOX,CAAI,EAAI,CACd,KAAAA,EACA,QAASC,EAAQ,OAAO,CAACA,EAASF,KACjCE,EAAQF,EAAO,IAAI,EAAIA,EAChBE,GACL,CAAC,CAAC,CACN,EACOU,GACL,CAAC,CAAC,EAEQC,GAAoB,IAAI,IACpC,OAAO,OAAOpB,EAAa,EAAE,OAAO,OAAO,CAC5C,EAEO,SAASqB,GAAcb,EAAM,CACnC,OAAO,KAAK,KAAK,SAChBA,IAAS,aACN,uBACA,OAAO,KAAK,UAAUA,CAAI,CAC9B,CACD,CANgBc,EAAAD,GAAA,iBAQhB,eAAsBE,GAAc,CAAE,MAAApB,EAAO,OAAAqB,CAAO,EAAG,CACtD,IAAML,EAAS,CAAC,EACVM,EAActB,EAAM,SAAS,WAAW,EAExCuB,EACLD,GACAE,EAAW,WAAW,GACtB,CAACxB,EAAM,UAAU,KAAK,KACpByB,GAASA,EAAK,WAAalC,EAC7B,EAED,QAASmC,EAAI,EAAGA,EAAI3B,GAAO,OAAQ2B,IAAK,CACvC,GAAM,CAAE,KAAArB,EAAM,QAAAC,CAAQ,EAAIP,GAAO2B,CAAC,EAC5B,CAAE,MAAAC,EAAO,KAAAC,EAAM,IAAAC,CAAI,EAAI7B,EAAM,aAAaK,CAAI,EAE9CyB,EAAO,KAAK,KAAK,SAASH,CAAK,EAC/BI,EAAczB,EAClB,OACA,CAAC,CAAE,UAAA0B,EAAW,QAAAC,CAAQ,KACpB,CAACV,GACD,CAACD,GACD,CAACW,GACDjC,EAAM,OAAOK,CAAI,EAAE,MAAQ,KAC3B,CAAC2B,GAAaA,EAAUhC,CAAK,EAChC,EACC,IAAKI,IAAY,CACjB,GAAGA,EACH,KAAM,KAAK,KAAK,SAASA,EAAO,KAAK,EACrC,SAAUA,EAAO,UAAU,IAAKM,IAAa,CAC5C,GAAGA,EACH,KAAM,KAAK,KAAK,SAASA,EAAQ,KAAK,CACvC,EAAE,CACH,EAAE,EAEGwB,EAAeC,EAASL,EAAMT,CAAM,EACtCe,EAAkBL,EAClB,CAACG,IACJE,EAAkBL,EAAY,OAC7B,CAAC,CAAE,KAAAD,EAAM,SAAAO,CAAS,IACjBF,EAASL,EAAMT,CAAM,GACrBgB,GAAU,KAAM3B,GAAYyB,EAASzB,EAAQ,KAAMW,CAAM,CAAC,CAC5D,EACI,CAACe,EAAgB,UAGtBpB,EAAOU,CAAC,EAAI,CACX,KAAArB,EACA,KAAAyB,EACA,KAAAF,EACA,SAAUf,EAASgB,CAAG,EACtB,QAASK,EAAeH,EAAcK,CACvC,GAGDpB,EAAO,KAAK,CAACsB,EAAGC,IACfD,EAAE,OAAS,aACR,GACAC,EAAE,OAAS,aACT,EACAC,EAAcF,EAAE,KAAMC,EAAE,IAAI,CAClC,EAEA,IAAME,EAAQ,OAAO,OAAOzC,EAAM,MAAM,EACtC,OAAO,CAAC,CAAE,KAAA0C,EAAM,MAAAf,CAAM,IAAMe,GAAQP,EAASR,EAAON,CAAM,CAAC,EAC3D,IAAI,CAAC,CAAE,MAAAM,EAAO,KAAAC,EAAM,IAAAC,EAAK,KAAAxB,CAAK,KAAO,CACrC,KAAAA,EACA,MAAAsB,EACA,KAAAC,EACA,SAAUf,EAASgB,CAAG,CACvB,EAAE,EAEGc,EAAqBF,EAAM,OAChC,CAACG,EAAOF,IACPA,EAAK,SAAS,OAASE,EAAQF,EAAK,SAAS,OAASE,EACvD,CACD,EAEA,MAAO,CACN,YAAa,CACZ,OAAQC,EACP,kBAAkBC,GAAoB9C,CAAK,EAAI,YAAc,UAC9D,EACA,OAAAgB,EACA,MAAAyB,EACA,mBAAAE,CACD,EACA,QAASnB,EAAW,gBAAgB,CACrC,CACD,CAxFsBL,EAAAC,GAAA,iBA0Ff,SAAS2B,GAAmB,CAAE,GAAAC,EAAI,MAAAhD,EAAO,MAAAiD,EAAO,IAAAC,CAAI,EAAG,CAC7DF,EAAG,KAAK,kCAAkC,EAAE,GAAG,QAAUG,GAAU,CAClEA,EAAM,eAAe,EACrB,IAAM/C,EAAS,EAAE+C,EAAM,aAAa,EAAE,QAAQ,SAAS,EACvDC,EAAgBhD,EAAQJ,EAAOI,EAAO,KAAK,OAAO,EAAE,SAAS,EAAE,KAAK,CAAC,CACtE,CAAC,EAGIJ,EAAM,UAEXgD,EAAG,KAAK,iCAAiC,EAAE,GAAG,QAAS,MAAOG,GAAU,CACvEA,EAAM,eAAe,EAErB,IAAME,EAAYP,GAAoB9C,CAAK,EAC3C,GAAIqD,EAAW,OAAO,MAAMA,EAAU,OAAO,EAE7C,IAAMC,GAAU,MAAM,SAAS3D,EAAsB,GAAG,SAAS,EACjE,YAAY2D,EAAQ,sBAAuB3D,EAAsB,EACjE,MAAMK,EAAM,wBAAwB,OAAQ,CAACsD,CAAM,CAAC,CACrD,CAAC,EAEDN,EAAG,KAAK,0BAA0B,EAAE,GAAG,QAAUG,GAAU,CAC1DA,EAAM,eAAe,EACrB,GAAM,CAAE,KAAA9C,CAAK,EAAI8C,EAAM,cAAc,QACrCnD,EAAM,aAAaK,CAAI,GAAG,KAAK,CAAE,MAAA8C,CAAM,CAAC,EACpC3B,EAAW,aAAa,GAAG0B,EAAI,MAAM,CAC1C,CAAC,EAEDF,EAAG,KAAK,2BAA2B,EAAE,GACpC,oBACA,MAAOG,GAAU,CAChBA,EAAM,eAAe,EAErB,IAAMI,EAAS,EAAEJ,EAAM,aAAa,EAC9B,CAAE,UAAAK,EAAW,KAAAnD,EAAM,WAAAoD,CAAW,EAAIF,EAAO,QAAQ,SAAS,EAAE,KAAK,EACjE,CAAE,QAAA7C,EAAS,IAAAgD,EAAK,MAAA/C,CAAM,EAAI4C,EAAO,KAAK,EAEtClB,EACLc,EAAM,OAAS,cACZ,MAAMQ,GAAeF,EAAY,CAAE,MAAOD,EAAW,MAAA7C,CAAM,CAAC,EAC5D,OAEA0B,IAAa,OAChBuB,GAAW,CACV,MAAAT,EACA,MAAAnD,EACA,MAAAiD,EACA,UAAAO,EACA,KAAAnD,EACA,QAAAK,EACA,IAAAgD,EACA,MAAOrB,GAAU,MACjB,MAAOA,GAAU,OAAS1B,CAC3B,CAAC,EACGa,EAAW,aAAa,GAAG0B,EAAI,MAAM,EAE3C,CACD,EAEAF,EAAG,KAAK,2BAA2B,EAAE,GAAG,QAAS,MAAOG,GAAU,CACjEA,EAAM,eAAe,EAErB,GAAM,CAAE,KAAAU,CAAK,EAAIV,EAAM,cAAc,QAAQ,SAAS,EAAE,QAClDlD,EAAO,MAAM,SAAS4D,CAAI,EAC3B5D,IAEL6D,GAAqBX,EAAOlD,EAAMD,EAAO,CAAE,OAAQ,EAAK,CAAC,EACrDwB,EAAW,YAAY,GAAG0B,EAAI,MAAM,EACzC,CAAC,EACF,CArEgB/B,EAAA4B,GAAA,sBAuEhB,SAASD,GAAoB9C,EAAO,CACnC,OAAOA,EAAM,UAAU,OAAO,KAC5B+D,GAAWA,EAAO,WAAapE,EACjC,CACD,CAJSwB,EAAA2B,GAAA,uBAMT,eAAsBa,GAAevD,EAAQ,CAAE,GAAA4D,EAAI,MAAArD,EAAO,MAAAR,CAAM,EAAI,CAAC,EAAG,CACvE,IAAMa,EAASF,GAAa,IAAKT,IAAU,CAC1C,KAAAA,EACA,MAAOa,GAAcb,CAAI,CAC1B,EAAE,EAEI4D,EAAU,MAAM,eAAeC,EAAa,iBAAiB,EAAG,CACrE,KAAOC,GAAQtB,EAAS,kBAAkBsB,GAAK,EAC/C,GAAAH,EACA,MAAA7D,EACA,MAAAQ,EACA,OAAAK,CACD,CAAC,EAED,OAAO,OAAO,OAAO,CACpB,MAAOZ,EACP,MAAOyC,EAAS,uBAAuB,EACvC,SAAWuB,IAAU,CACpB,MAAOA,EAAK,KAAK,QAAQ,EAAE,IAAI,EAC/B,GAAI,OAAOA,EAAK,KAAK,WAAW,EAAE,IAAI,CAAC,EACvC,MAAOA,EAAK,KAAK,cAAc,EAAE,GAAG,UAAU,CAC/C,GACA,YAAa,GACb,QAAAH,EACA,QAAS,CAAE,MAAO,GAAI,CACvB,CAAC,CACF,CA1BsB9C,EAAAwC,GAAA,kBA4Bf,SAASU,GAAeX,EAAK/C,EAAO,CAC1C,IAAME,EAAW6C,IAAQ,EAAK/C,EAAQ,GAAK,GAAMA,EAAQ,GAAK,IAC9D,OAAO,IAAI,KAAK,KAAK,SAAS,CAC7B,MAAO,6BACP,SAAAE,CACD,CAAC,CACF,CANgBM,EAAAkD,GAAA,kBAQhB,SAAST,GAAW,CACnB,MAAAT,EACA,MAAAnD,EACA,UAAAwD,EACA,KAAAnD,EACA,QAAAK,EACA,IAAAgD,EACA,MAAA/C,EACA,MAAAR,EACA,MAAA8C,CACD,EAAG,CACF,IAAM7C,EAASW,GAAWyC,CAAS,EAAE,QAAQnD,CAAI,EAC3CiE,EACLlE,EAAO,OAAS,EACb,EACA,KAAK,KAAK,QAAQ,IAAIC,CAAI,EACxB,EACAA,KAAQ,KAAK,KAAK,QACjB,EACA,OAEPF,IAAUC,EAAO,QAAU,OAAYoD,EAEvC,IAAMe,EAAcnE,EAAO,WACxB,CAAC,UAAUA,EAAO,YAAY,EAC9B,OACCmE,GAAe7D,GAClB6D,EAAY,KAAK,UAAUnE,EAAO,cAAcM,GAAS,EAE1D,IAAM8D,EAAU,CACf,MAAArB,EACA,OAAQ,CAACnD,CAAK,EACd,OAAQ,CAACiD,CAAK,EACd,QAAAvC,EACA,YAAA6D,EACA,SAAUnE,EAAO,OAAS,YAAc,MACzC,EAIA,GAFAoE,EAAQ,UAAY,CAAC,EAEjBpE,EAAO,WACV,OAAW,CAAE,UAAA4B,EAAW,UAAApB,CAAU,IAAKR,EAAO,UAC7C,GAAI,EAAA4B,GAAa,CAACA,EAAUhC,CAAK,GACjC,QAAWa,KAAYD,EACtB4D,EAAQ,UAAU,KAAK,IAAI,KAAK,KAAK,SAAS3D,CAAQ,CAAC,EAK1D,GAAI6C,EAAK,CACR,IAAM7C,EAAWwD,GAAeX,EAAK/C,CAAK,EAC1C6D,EAAQ,UAAU,KAAK3D,CAAQ,EAGhC,GAAIT,EAAO,OAAQ,CAClBA,EAAO,OAAOJ,EAAOwE,CAAO,EAC5B,OAGD,GAAI,CAACF,EAAM,CACVtE,EAAM,aAAaG,CAAK,GAAG,KAAKqE,CAAO,EACvC,OAIGF,IAAS,GACZE,EAAQ,MAAQrE,EAChB,KAAK,KAAK,QAAQE,CAAI,EAAEmE,CAAO,GAGvBF,IAAS,GACjBE,EAAQ,UAAYrE,EACpB,KAAK,KAAK,QAAQ,IAAIE,CAAI,EAAE,IAAImE,CAAO,GAG/BF,IAAS,GACjB,KAAK,KAAK,QAAQjE,CAAI,EAAEL,CAAK,CAE/B,CA9ESmB,EAAAyC,GAAA,cCnkBF,IAAMa,GAAc,CAC1B,IAAK,oDACL,OAAQ,oDACR,mBAAoB,oDACpB,YAAa,mDACd,EAEA,eAAsBC,GAAc,CAAE,MAAAC,EAAO,OAAAC,CAAO,EAAG,CACtD,IAAMC,EAAaF,EAAM,OAAO,WAEhC,MAAO,CACN,YAAa,CACZ,QAASG,EAAS,iBAAiB,EACnC,OAAQC,GAAUJ,CAAK,GAAG,OAAQK,GAAUC,EAASD,EAAM,KAAMJ,CAAM,CAAC,EACxE,WAAYC,GAAc,CACzB,SAAUA,EAAW,UACrB,OAAQK,GAAa,IAAKC,IAAU,CACnC,KAAAA,EACA,MAAOC,GAAcD,CAAI,CAC1B,EAAE,CACH,EACA,WAAY,KAAK,QAAQ,IAAI,cAAc,GAAG,OAC9C,cAAe,KAAK,QAAQ,IAAI,iBAAiB,GAAG,OACpD,MAAOV,EACR,CACD,CACD,CAnBsBY,EAAAX,GAAA,iBAqBf,SAASY,GAAmB,CAAE,GAAAC,EAAI,MAAAZ,EAAO,MAAAa,EAAO,IAAAC,CAAI,EAAG,CAC7D,SAASC,EAAOA,EAAQC,EAAUC,EAAO,QAAS,CACjDL,EAAG,KAAK,gBAAgBG,IAAS,EAAE,GAAGE,EAAOC,GAAU,CACtDA,EAAM,eAAe,EACrBF,EAASE,CAAK,CACf,CAAC,CACF,CAQA,GAbSR,EAAAK,EAAA,UAOTA,EAAO,qBAAuBG,GAAU,CACvC,IAAMH,EAAS,EAAEG,EAAM,aAAa,EAAE,QAAQ,MAAM,EACpDC,EAAgBJ,EAAQf,CAAK,CAC9B,CAAC,EAGG,CAACA,EAAM,QAAS,OAEpBoB,EAAwBR,EAAG,KAAK,QAAQ,CAAC,EAEzC,eAAeS,EAASH,EAAO,CAC9B,GAAM,CAAE,KAAAI,CAAK,EAAIJ,EAAM,cAAc,QAAQ,QAAQ,EAAE,QACvD,OAAO,SAASI,CAAI,CACrB,CAHeZ,EAAAW,EAAA,YAKfN,EAAO,eAAiBG,GAAUK,GAAYL,EAAOlB,CAAK,CAAC,EAE3De,EAAO,aAAc,MAAOG,GAAU,EACvB,MAAMG,EAASH,CAAK,IAC3B,MAAM,OAAO,EAAI,CACzB,CAAC,EAEDH,EAAO,YAAa,MAAOG,GAAU,EACtB,MAAMG,EAASH,CAAK,IAC3B,QAAQ,CAAE,MAAAlB,EAAO,MAAAa,CAAM,CAAC,EAC3BW,EAAW,aAAa,GAAGV,EAAI,MAAM,CAC1C,CAAC,EAEDF,EAAG,GAAG,OAASM,GAAUO,GAAeP,EAAOlB,CAAK,CAAC,EAErDe,EAAO,cAAe,MAAOG,GAAU,CACtC,GAAM,CAAE,KAAAI,CAAK,EAAIJ,EAAM,cAAc,QAAQ,MAAM,EAAE,QAC/CQ,EAAO,MAAM,SAASJ,CAAI,EAC3BI,IAELC,GAAqBT,EAAOQ,EAAM1B,EAAO,CAAE,OAAQ,EAAK,CAAC,EACrDwB,EAAW,YAAY,GAAGV,EAAI,MAAM,EACzC,CAAC,EAEDF,EAAG,KAAK,2BAA2B,EAAE,GAAG,SAAU,MAAOM,GAAU,CAClE,IAAMU,EAASV,EAAM,cACfW,EACLD,EAAO,OAAS,SAAWA,EAAO,cAAgBA,EAAO,MAC1D,MAAM5B,EAAM,OAAO,CAAE,CAAC4B,EAAO,IAAI,EAAGC,CAAM,CAAC,CAC5C,CAAC,EAEDd,EAAO,kBAAmB,MAAOG,GAAU,CAC1C,MAAMlB,EAAM,WAAW,KAAK,CAAE,MAAAkB,CAAM,CAAC,EACjCM,EAAW,aAAa,GAAGV,EAAI,MAAM,CAC1C,CAAC,EAEDC,EAAO,kBAAoBG,GAAU,CACpC,IAAMY,EAAU,KAAK,QAAQ,IAAI,cAAc,EAC3CA,GAAS,QAAQA,EAAQ,IAAI,qBAAqB9B,CAAK,CAC5D,CAAC,EAEDe,EAAO,qBAAuBG,GAAU,CACvC,KAAK,KAAK,QAAQ,gBAAgB,CAAE,OAAQ,CAAClB,CAAK,EAAG,OAAQ,CAACa,CAAK,CAAE,CAAC,CACvE,CAAC,EAEDE,EAAO,wBAA0BG,GAAU,CAC1Ca,GAAqB/B,CAAK,EACtBwB,EAAW,aAAa,GAAGV,EAAI,MAAM,CAC1C,CAAC,EAEDC,EACC,WACA,MAAOG,GAAU,CAChB,IAAMc,EAAW,MAAMC,GACtB,KAAK,KAAK,SAAS,wBAAwB,EAC3C,CAAE,GAAI,EAAG,CACV,EACMC,EAAO,CACZ,KAAM,4DACP,EACIF,IAAa,OAChB,KAAK,KAAK,QAAQ,IAAI,KAAK,EAAE,IAAI,CAChC,MAAAd,EACA,OAAQ,CAAClB,CAAK,EACd,OAAQ,CAACa,CAAK,EACd,UAAWmB,GAAU,MACrB,gBAAiB,CAAE,MAAOA,GAAU,EAAG,EACvC,MAAO,CAACE,CAAI,CACb,CAAC,EACGV,EAAW,aAAa,GAAGV,EAAI,MAAM,EAE3C,EACA,mBACD,EAEAC,EAAO,iBAAmBG,GAAU,CACnC,KAAK,KAAK,QACR,IAAI,WAAW,EACf,IAAI,CAAE,MAAAA,EAAO,OAAQ,CAAClB,CAAK,EAAG,OAAQ,CAACa,CAAK,CAAE,CAAC,EAC7CW,EAAW,aAAa,GAAGV,EAAI,MAAM,CAC1C,CAAC,EAEDC,EACC,cACA,MAAOG,GAAU,CAChB,IAAMiB,EAAM,EAAEjB,EAAM,aAAa,EAAE,KAAK,EAAE,IACpCc,EACLd,EAAM,OAAS,cACZ,MAAMe,GACN,KAAK,KAAK,SAAS,2BAA2B,EAC9C,CAAE,MAAOE,EAAM,GAAQ,MAAU,CACjC,EACA,OACJ,GAAIH,IAAa,KAAM,OAEvB,IAAMI,EAAY,CAAC,EAEnB,GAAID,EAAK,CACR,IAAME,EAAQL,GAAU,MAClBM,EAAWC,GAAeJ,EAAKE,CAAK,EAC1CD,EAAU,KAAKE,CAAQ,EAGxB,KAAK,KAAK,QAAQ,IAAI,QAAQ,EAAE,IAAI,CACnC,MAAApB,EACA,OAAQ,CAAClB,CAAK,EACd,OAAQ,CAACa,CAAK,EACd,UAAWmB,GAAU,MACrB,UAAAI,CACD,CAAC,EAEGZ,EAAW,aAAa,GAAGV,EAAI,MAAM,CAC1C,EACA,mBACD,CACD,CA1IgBJ,EAAAC,GAAA,sBC7BhB,IAAM6B,GAAiB,CACtB,OAAQ,CACP,MAAO,EACP,MAAO,4BACP,YAAa,uBACd,EACA,SAAU,CACT,MAAO,EACP,MAAO,8BACP,YAAa,yBACd,EACA,KAAM,CACL,MAAO,EACP,MAAO,gCACP,YAAa,qBACd,EACA,QAAS,CACR,MAAO,EACP,MAAO,yBACP,YAAa,wBACd,EACA,YAAa,CACZ,MAAO,EACP,MAAO,uCACP,YAAa,iCACd,CACD,EAEA,eAAsBC,GAAe,CAAE,IAAAC,EAAK,MAAAC,EAAO,OAAAC,CAAO,EAAG,CAC5D,IAAMC,EAAcF,EAAM,SAAS,WAAW,EACxCG,EAAUC,EAAW,SAAS,EAE9BC,GAAW,MAAMC,GAAoB,GAAG,WAAWN,CAAK,IAAI,KACjE,CAACO,EAAGC,IAAMC,EAAcF,EAAE,KAAMC,EAAE,IAAI,CACvC,EAEME,EAAcR,EACjB,MAAMS,GAAkB,GAAG,eAAeX,CAAK,EAC/C,OACGY,EAAWF,EACdV,EAAM,WAAW,MAAQU,EAAY,OACrC,OAEGG,EAAUb,EAAM,QAChBc,EAAWd,EAAM,YAAY,EAE7Be,EAAUf,EAAM,OAAO,QAC1B,MAAM,QAAQ,IACdA,EAAM,OAAO,QAAQ,IAAI,MAAOgB,EAAQC,KAAW,CAClD,GAAGD,EACH,MAAAC,EACA,QAAS,CAACf,GAAec,EAAO,QAChC,cAAe,MAAMA,EAAO,SAAS,CAAE,WAAY,EAAK,CAAC,EACzD,gBAAiB,MAAMA,EAAO,WAAW,CAAE,WAAY,EAAK,CAAC,EAC7D,YAAaA,EAAO,YACjB,MAAME,GAAWF,EAAO,YAAahB,EAAO,CAAE,SAAAc,EAAU,QAAAD,CAAQ,CAAC,EACjE,OACH,UACCG,EAAO,WACN,MAAM,QAAQ,IACdA,EAAO,UAAU,IAAI,MAAOG,IAAc,CACzC,GAAGA,EACH,MAAOA,EAAS,KAAK,SAAW,SAAW,QAC3C,cAAe,MAAMA,EAAS,SAAS,CAAE,WAAY,EAAK,CAAC,EAC3D,gBAAiB,MAAMA,EAAS,WAAW,CAC1C,WAAY,EACb,CAAC,CACF,EAAE,CACH,CACF,EAAE,CACF,EACA,OAEGC,EAAQlB,EAAc,IAAI,KAAK,KAAK,eAAeF,CAAK,EAAI,OAC5DqB,EAASD,GAEZ,MAAM,QAAQ,IACbA,EAAM,QAAQ,IAAI,MAAOE,GAAW,CACnC,IAAMC,EACLD,EAAO,YAAY,KAAME,GAAWA,EAAO,QAAQ,GAAG,OACtD,UAEKC,EAAaC,EAAA,CAACC,EAASC,EAAQ,KAC7BR,EAAM,OAAO,CACnB,QAASE,EAAO,QAChB,WAAAC,EACA,MAAAK,EACA,QAAAD,EACA,WAAY,EACb,CAAC,EAPiB,cAUnB,MAAO,CACN,GAAGL,EACH,WAAAC,EACA,QAAS,CACR,MAAO,CACN,OAAQ,MAAME,EAAW,SAAS,EAClC,SAAU,MAAMA,EAAW,iBAAiB,CAC7C,EACA,OAAQ,CACP,OAAQ,MAAMA,EAAW,UAAW,EAAK,EACzC,SAAU,MAAMA,EAAW,kBAAmB,EAAK,CACpD,CACD,CACD,CACD,CAAC,CACF,GACE,KAAK,CAAClB,EAAGC,IAAMC,EAAcF,EAAE,MAAOC,EAAE,KAAK,CAAC,EAChD,OAECqB,EAAW,CAAC,EAEVC,EAAU5B,EACb6B,GAAoB/B,EAAOK,CAAO,EAClC2B,GAAchC,CAAK,EACtB,QAAWiC,KAAUH,EACfI,EAASD,EAAO,KAAMhC,CAAM,IAE7BE,IAAY,SACf0B,EAAS,SAAW,CAAC,EACrBA,EAAS,OAAO,KAAKI,CAAM,IAE3BJ,EAASI,EAAO,IAAI,IAAM,CAAC,EAC3BJ,EAASI,EAAO,IAAI,EAAE,KAAKA,CAAM,IA8BnC,GA1BAJ,EAAW,OAAO,QAAQA,CAAQ,EAAE,IAAI,CAAC,CAACM,EAAML,CAAO,IAAM,CAC5D,QAAWG,KAAUH,EACpBG,EAAO,IAAMG,GAAcH,EAAO,IAAI,EACtCA,EAAO,UAAYpC,GAAeoC,EAAO,IAAI,EAAE,YAGhD,OAAI9B,IAAY,OACf2B,EAAQ,KAAK,CAACvB,EAAGC,IAAMC,EAAcF,EAAE,KAAMC,EAAE,IAAI,CAAC,EAEpDsB,EAAQ,KAAK,CAACvB,EAAGC,IAAM,CACtB,IAAM6B,EAASxC,GAAeU,EAAE,IAAI,EAAE,MAChC+B,EAASzC,GAAeW,EAAE,IAAI,EAAE,MACtC,OAAO6B,IAAWC,EACf7B,EAAcF,EAAE,KAAMC,EAAE,IAAI,EAC5B6B,EAASC,CACb,CAAC,EAGK,CAAE,KAAAH,EAAM,QAAAL,EAAS,MAAOjC,GAAesC,CAAI,EAAE,KAAM,CAC3D,CAAC,EAEGhC,IAAY,SACf0B,EAAS,KACR,CAACtB,EAAGC,IAAMX,GAAeU,EAAE,IAAI,EAAE,MAAQV,GAAeW,EAAE,IAAI,EAAE,KACjE,EAGAH,GAAS,QACTU,GAAS,QACTM,GAAQ,QACRQ,EAAS,QACTnB,GAAa,OACZ,CACD,IAAM6B,EACL,GAAQlC,GAAS,QAAU,GAAK,IAChC,GAAQU,GAAS,QAAU,GAAK,IAChC,GAAQM,GAAQ,QAAU,GAAK,GAC/BQ,EAAS,QACT,GAAQnB,GAAa,QAAU,GAAK,GAErC,MAAO,CACN,YAAa,CACZ,QAAAL,EACA,QAAAU,EACA,OAAAM,EACA,SAAAQ,EACA,YAAanB,GAAe,CAC3B,QAASA,EACT,KAAM,KAAK,IAAIE,EAAU,CAAC,EAC1B,QAAS,KAAK,IAAI,KAAK,IAAIA,EAAU,CAAC,CAAC,EACvC,SAAUF,EAAY,QAAU8B,GAAoB,CACrD,EACA,KAAOC,GAAQC,EAAS,WAAWD,GAAK,EACxC,aAAeE,GAAUA,EAAM,QAAQ,aAAc,IAAI,EACzD,YAAa,OAAO,KAAK,WAC1B,EACA,QAASJ,EAAK,GAAKnC,EAAW,iBAAiB,CAChD,EAEF,CA/JsBsB,EAAA5B,GAAA,kBAiKf,SAAS8C,GAAoB,CAAE,GAAAC,EAAI,MAAA7C,EAAO,IAAAD,CAAI,EAAG,CACvD+C,EAAwBD,EAAG,KAAK,SAAS,CAAC,EAC1CC,EAAwBD,EAAG,KAAK,SAAS,CAAC,EAC1CC,EAAwBD,EAAG,KAAK,SAAS,CAAC,EAE1C,SAASZ,EAAOA,EAAQc,EAAUZ,EAAO,QAAS,CAEjD,IAAMa,GADU,OAAOf,GAAW,SAAW,CAACA,CAAM,EAAIA,GAC/B,IAAKgB,GAAM,gBAAgBA,IAAI,EAAE,KAAK,IAAI,EACnE,OAAOJ,EAAG,KAAKG,CAAQ,EAAE,GAAGb,EAAOe,GAAU,CAC5CA,EAAM,eAAe,EACrBH,EAASG,CAAK,CACf,CAAC,CACF,CAPSxB,EAAAO,EAAA,UAST,SAASkB,EAAUD,EAAO,CACzB,IAAME,EAAWF,EAAM,cAAc,QAAQ,SAAS,EAChDlC,EAAShB,EAAM,OAAO,QAAQoD,EAAS,QAAQ,KAAK,EAC1D,GAAI,CAACpC,EAAQ,OAAO,KAEpB,GAAM,CAAE,SAAAG,CAAS,EAAI+B,EAAM,cAAc,QACzC,MAAO,CAAC,QAAS,QAAQ,EAAE,SAAS/B,CAAQ,EACzCH,EAAO,WAAW,KAAMqC,GACxBlC,IAAa,SAAWkC,EAAE,KAAK,SAAWA,EAAE,KAAK,OACjD,GAAK,KACLrC,CACJ,CAXSU,EAAAyB,EAAA,aAaT,SAASG,EAAQJ,EAAO,CACvB,OAAO,EAAEA,EAAM,aAAa,EAAE,QAAQ,SAAS,EAAE,KAAK,EAAE,IACzD,CA0LA,GA5LSxB,EAAA4B,EAAA,WAITrB,EAAO,qBAAsB,MAAOiB,GAAU,CAC7C,IAAMjB,EAAS,EAAEiB,EAAM,aAAa,EAAE,QAAQ,SAAS,EACvDK,EAAgBtB,EAAQjC,CAAK,CAC9B,CAAC,EAEDiC,EAAO,0BAA2B,MAAOiB,GAAU,CAClD,IAAMM,EAAOF,EAAQJ,CAAK,EACpB,CAAE,YAAAO,EAAa,KAAAC,CAAK,EACxB,MAAM/C,GAAkB,GAAG,qBAAqB6C,CAAI,GAAM,CAAC,EACzDC,GAAaE,GAAMD,EAAMD,EAAazD,CAAK,CAChD,CAAC,EAEDiC,EAAO,qBAAsB,MAAOiB,GAAU,CAC7C,IAAMlC,EAASmC,EAAUD,CAAK,EAC9B,GAAI,CAAClC,EAAQ,OAEb,IAAMyC,EAAc,SAAS,cAAc,KAAK,EAChDA,EAAY,UAAU,IAAI,mBAAmB,EAE7CA,EAAY,UAAY,MAAM,eAC7BG,EAAa,oBAAoB,EACjC5C,CACD,EAEA2C,GAAM3C,EAAO,MAAOyC,EAAazD,CAAK,CACvC,CAAC,EAEDiC,EAAO,oBAAqB,MAAOiB,GAAU,CAC5C,IAAM9B,EAAQ8B,EAAM,cAAc,QAAQ,QAAQ,EAClDK,EAAgB,EAAEnC,CAAK,EAAGpB,CAAK,CAChC,CAAC,EAEDiC,EAAO,oBAAsBiB,GAAU,CACtC,IAAMlC,EAASmC,EAAUD,CAAK,EAC9B,GAAI,CAAClC,EAAQ,OAEb,GAAM,CAAE,MAAAC,CAAM,EAAIiC,EAAM,cAAc,QAChCW,EAAQ7C,EAAO,OAAOC,CAAK,EACjC,GAAI,CAAC4C,EAAO,OAEZ,IAAMJ,EAAc,KAAK,KAAK,SAASI,EAAM,WAAW,EACpDJ,GAAaE,GAAM,KAAK,KAAK,SAASE,EAAM,KAAK,EAAGJ,EAAazD,CAAK,CAC3E,CAAC,EAEDiC,EAAO,qBAAuBiB,GAAU,CACvC,IAAMY,EAAS,EAAEZ,EAAM,aAAa,EAAE,QAAQ,SAAS,EACvDK,EAAgBO,EAAQ9D,EAAO8D,EAAO,KAAK,EAAE,QAAQ,CACtD,CAAC,EAGG,CAAC9D,EAAM,UAEXiC,EAAO,aAAeiB,GAAU,CAC/B,IAAMa,EAAOC,EAAiBd,EAAOlD,CAAK,EACtC+D,GAAM,SAAS,SAAU,MAAM,IAClCE,GAAwBF,EAAMG,GAAgBhB,CAAK,CAAC,EAChD9C,EAAW,eAAe,GAAG+D,GAAkBnE,EAAO+D,CAAI,EAC1D3D,EAAW,cAAc,GAAGL,EAAI,MAAM,EAE5C,CAAC,EAEDkC,EAAO,cAAgBiB,GAAU,CAChC,IAAMa,EAAOC,EAAiBd,EAAOlD,CAAK,EACrC+D,IAELA,EAAK,UAAUb,EAAO,CAAE,OAAQ,EAAK,CAAC,EAClC9C,EAAW,YAAY,GAAGL,EAAI,MAAM,EACzC,CAAC,EAEDkC,EAAO,gBAAkBiB,GAAU,CAClC,GAAM,CAAE,WAAAkB,CAAW,EAAIlB,EAAM,cAAc,QAAQ,SAAS,EAAE,QAC9D5C,GAAoB,GAAG,aAAaN,EAAOoE,CAAU,CACtD,CAAC,EAEDnC,EAAO,qBAAuBiB,GAAU,CACvC,IAAMmB,EAAWnB,EAAM,cAAc,QAAQ,SAAS,EAAE,QAAQ,OAE1DoB,EAActE,EAAM,OAAO,YAAY,OAAQuE,GACpDvE,EAAM,MAAM,IAAIuE,CAAE,CACnB,EACKD,EAAY,WAAYC,GAAOA,IAAOF,CAAQ,GAClDC,EAAY,KAAKD,CAAQ,EAG1BrE,EAAM,OAAO,CAAE,qBAAsBsE,CAAY,CAAC,CACnD,CAAC,EAEDrC,EAAO,cAAgBiB,GAAU,CAChC,IAAMa,EAAOC,EAAiBd,EAAOlD,CAAK,EACrC+D,IAELA,EAAK,UAAUb,EAAO,CAAE,OAAQ,EAAK,CAAC,EAClC9C,EAAW,YAAY,GAAGL,EAAI,MAAM,EACzC,CAAC,EAEDkC,EAAO,mBAAoB,MAAOiB,GAAU,CAC3C,IAAMsB,EAAM7D,GAAkB,EACzB6D,IAELA,EAAI,iBAAiBxE,EAAOsD,EAAQJ,CAAK,CAAC,EACtC9C,EAAW,YAAY,GAAGL,EAAI,MAAM,EACzC,CAAC,EAEDkC,EAAO,mBAAoB,MAAOiB,GAAU,CAC3C,MAAMvC,GAAkB,GAAG,gBAAgBX,CAAK,CACjD,CAAC,EAEDiC,EAAO,kBAAmB,MAAOiB,GAAU,CAC1C,IAAMsB,EAAM7D,GAAkB,EACzB6D,IAELA,EAAI,cAAcxE,EAAOsD,EAAQJ,CAAK,CAAC,EACnC9C,EAAW,cAAc,GAAGL,EAAI,MAAM,EAC3C,CAAC,EAEDkC,EAAO,sBAAuB,MAAOiB,GAAU,CAC9C,MAAMvC,GAAkB,GAAG,mBAAmBX,EAAOsD,EAAQJ,CAAK,CAAC,CACpE,CAAC,EAEDjB,EAAO,oBAAqB,MAAOiB,GAAU,CAC5CvC,GAAkB,GAAG,gBAAgBX,CAAK,CAC3C,CAAC,EAEDiC,EAAO,gBAAkBiB,GAAU,CAClC,GAAM,CAAE,MAAAjC,EAAO,SAAAE,CAAS,EAAI+B,EAAM,cAAc,QACjCC,EAAUD,CAAK,GAEtB,SAASjC,CAAK,EAAE,KAAK,CAAE,MAAAiC,EAAO,SAAA/B,CAAS,CAAC,EAC5Cf,EAAW,cAAc,GAAGL,EAAI,MAAM,CAC3C,CAAC,EAEDkC,EAAO,CAAC,gBAAiB,iBAAiB,EAAIiB,GAAU,CACvD,GAAM,CAAE,OAAAjB,CAAO,EAAIiB,EAAM,cAAc,QACxBC,EAAUD,CAAK,IAErBjB,IAAW,gBAAkB,SAAW,UAAU,EAAE,CAAE,MAAAiB,CAAM,CAAC,EAClE9C,EAAW,cAAc,GAAGL,EAAI,MAAM,CAC3C,CAAC,EAEDkC,EAAO,mBAAqBiB,GAAU,CACrC,GAAIA,EAAM,gBAAkBA,EAAM,OAAQ,OAE1C,IAAMlC,EAASmC,EAAUD,CAAK,EAC9B,GAAI,CAAClC,EAAQ,OAEb,GAAM,CAAE,MAAAC,CAAM,EAAIiC,EAAM,cAAc,QAChCuB,EAAUvB,EAAM,cAAc,cAAc,QAAQ,GAAG,OAAS,KAEtElC,EAAO,mBAAmBC,CAAK,GAAG,QAAQ,CAAE,UAAWwD,CAAQ,CAAC,CACjE,CAAC,EAEDxC,EAAO,mBAAoB,MAAOiB,GAAU,CAC3C,IAAMwB,EAASvB,EAAUD,CAAK,GAAG,KACjC,GAAI,CAACwB,EAAQ,OAEb,IAAMC,EAASzB,EAAM,cACf,CAAE,MAAA0B,CAAM,EAAID,EAAO,QACnBE,EAAWH,EAAO,OAAO,OAAO,YAAc,KAC9CI,EACLH,EAAO,UAAU,SAAS,UAAU,GAAKC,IAAUC,EAChD,KACAD,GAEHG,GAAa,OAAO,KAAK,YAAaD,CAAS,GAAKA,IAAc,OAGnE,MAAMJ,EAAO,OAAO,OAAO,QAAQ,OAAO,CACzC,MAAO,YACP,SAAUI,CACX,CAAC,CACF,CAAC,EAED7C,EACC,cACA,MAAOiB,GAAU,CAChB,IAAMwB,EAASvB,EAAUD,CAAK,GAAG,KACjC,GAAI,CAACwB,EAAQ,OAEb,IAAMM,EAAOhF,EAAM,MAAM,IAAIkD,EAAM,cAAc,KAAK,EACtD,MAAMwB,EAAO,OAAO,CAAE,OAAQ,CAAE,eAAgBM,GAAM,IAAM,IAAK,CAAE,CAAC,CACrE,EACA,QACD,EAEI,CAAChF,EAAM,SAAS,WAAW,GAAG,OAElC,IAAMiF,EAAY,CAAC,cAAe,cAAe,iBAAiB,EAChE,IAAK5B,GAAM,gBAAgBA,IAAI,EAC/B,KAAK,GAAG,EACVR,EAAG,KAAK,QAAQ,EAAE,KAAK,CAACqC,EAAGC,IAAY,CACtC,GAAM,CAAE,QAAAC,EAAS,WAAA7D,CAAW,EAAI4D,EAAQ,QAClC/D,EAAQ,IAAI,KAAK,KAAK,eAAepB,CAAK,EAEhD,EAAEmF,CAAO,EACP,KAAKF,CAAS,EACd,GAAG,QAAS,MAAO/B,GAAU,CAC7BA,EAAM,eAAe,EAErB,IAAMmC,EAAUnC,EAAM,cAAc,QAC9BtB,EAAQyD,EAAQ,QAAU,OAEhC,OAAQA,EAAQ,OAAQ,CACvB,IAAK,cAAe,CACnB,IAAMC,EAAe,KAAK,QACzB,OAAOD,EAAQ,YAAY,EAC3B,EACA,CACD,EACAjE,EAAM,OAAO,CACZ,aAAc,KAAK,QAAQkE,EAAc,EAAG,CAAC,EAC7C,QAAAF,EACA,WAAA7D,EACA,MAAAK,EACA,MAAAsB,CACD,CAAC,EACD,KACD,CACA,IAAK,cAAe,CACnB9B,EAAM,OAAO,CACZ,QAAAgE,EACA,WAAA7D,EACA,MAAAK,EACA,QAASyD,EAAQ,QACjB,MAAAnC,CACD,CAAC,EACD,KACD,CACA,IAAK,kBACJ9B,EAAM,cAAc,CAAE,QAAAgE,EAAS,WAAYC,EAAQ,KAAM,CAAC,CAE5D,CAGC,CAAC,cAAe,aAAa,EAAE,SAASA,EAAQ,MAAM,GACtDjF,EAAW,cAAc,GAEzBL,EAAI,MAAM,CACZ,CAAC,CACH,CAAC,CACF,CA9QgB2B,EAAAkB,GAAA,uBAgRhB,SAAS2C,GAAkBC,EAAS,CACnC,IAAMC,EAAS,KAAK,QAAQ,IAAI,eAAe,EAC/C,OAAOA,GAAQ,QAAU,KAAK,SAAS,IAAI,gBAAiBD,CAAO,EAChEC,EACA,MACJ,CALS/D,EAAA6D,GAAA,qBAOT,SAASG,GAAeF,EAAS,CAChC,OAAOD,GAAkBC,CAAO,GAAG,GACpC,CAFS9D,EAAAgE,GAAA,kBAIT,SAASpF,IAAsB,CAC9B,IAAMmF,EAAS,KAAK,QAAQ,IAAI,cAAc,EAC9C,OAAOA,GAAQ,OAASA,EAAO,IAAMC,GAAe,SAAS,GAAG,OACjE,CAHShE,EAAApB,GAAA,uBAKT,SAASK,IAAoB,CAC5B,IAAM8E,EAAS,KAAK,QAAQ,IAAI,mBAAmB,EACnD,OAAOA,GAAQ,OAASA,EAAO,IAAMC,GAAe,MAAM,GAAG,WAC9D,CAHShE,EAAAf,GAAA,qBAKT,SAAS6B,IAAsB,CAC9B,GAAI,KAAK,QAAQ,IAAI,mBAAmB,GAAG,OAC1C,OAAO,KAAK,SAAS,IAAI,oBAAqB,OAAO,EACtD,GAAI+C,GAAkB,MAAM,EAC3B,OAAO,KAAK,SAAS,IAAI,gBAAiB,YAAY,CACxD,CALS7D,EAAAc,GAAA,uBAOT,SAAST,GAAoB/B,EAAOK,EAAS,CAC5C,IAAMsF,EACLrF,GAAoB,GAAG,kBAAkB,IACxCD,GAAS,KAAMyD,GAAWA,EAAO,UAAU,EACzC,IAAI,IAAIzD,EAAQ,IAAI,CAAC,CAAE,WAAAuF,CAAW,IAAMA,CAAU,CAAC,EACnD,SACH,IAAI,IAECC,EAAe,IAAI,IAAI,CAC5B,GAAGF,EACH,GAAGG,GACH,GAAG,OAAO,OAAOC,EAAW,CAC7B,CAAC,EACKjE,EAAU9B,EAAM,UAAU,OAC1BgG,EAAQhG,EAAM,UAAU,KAAK,OAAQ+D,GAASA,EAAK,UAAU,EAC7DkC,EAAUjG,EAAM,QAAQ,KAAO,EAC/BkG,EAAelG,EAAM,OAAO,YAElC,MAAO,CAAC,GAAG8B,EAAS,GAAGkE,CAAK,EAC1B,IAAK/D,GAAW,CAChB,IAAMkE,EAAWlE,EAAO,SAClBoC,EAAWpC,EAAO,GAClBmE,EAAanE,EAAO,WACpBoE,EAASpE,EAAO,OAAO,OAAO,MAC9BqE,EAAgBD,EAAO,SAAS,aAAa,EAEnD,MAAO,CACN,SAAAF,EACA,GAAI9B,EACJ,KAAM+B,GAAY,OAASE,EAAgB,cAAgB,QAC3D,KAAMF,EACN,KAAMnE,EAAO,KACb,cAAAqE,EACA,WAAYD,EAAO,SAAS,UAAU,EACtC,SAAUC,GAAiBJ,EAAa,SAAS7B,CAAQ,EACzD,UAAW,CAAC,CAACpC,EAAO,OAAO,UAC5B,CACD,CAAC,EACA,OACCA,GACA,CAACA,EAAO,aACPgE,GAAW,CAAChE,EAAO,iBACnBA,EAAO,eAAiB,CAAC4D,EAAa,IAAI5D,EAAO,QAAQ,EAC5D,CACF,CA5CSP,EAAAK,GAAA,uBA8CT,SAASC,GAAchC,EAAO,CAC7B,OAAOA,EAAM,UAAU,OAAO,IAAK+D,GAAS,CAC3C,IAAMqC,EAAarC,EAAK,WAClBwC,EAAaH,GAAY,MAAQ,UACjCI,EACLD,IAAe,YACdxC,EAAK,OAAO,OAAO,MAAM,SAAS,MAAM,GACxC,CAAC,CAACA,EAAK,OAAO,MAAM,KAAM0C,GAAMA,EAAE,MAAQ,MAAM,GAElD,MAAO,CACN,GAAI1C,EAAK,GACT,KAAMwC,EACN,KAAMH,EACN,KAAMrC,EAAK,KACX,aAAcA,EAAK,OAAO,UAC1B,QAAAyC,EACA,UAAW,CAAC,CAACzC,EAAK,OAAO,UAC1B,CACD,CAAC,CACF,CAnBSrC,EAAAM,GAAA,iBAqBT,eAAemC,GAAkBnE,EAAO+D,EAAM,CAC7C,IAAMP,EAAOO,EAAK,OAAO,YAAY,KACrC,GAAI,CAACP,EAAM,OAEX,IAAMkD,GAAU,MAAM,SAASlD,CAAI,IAAI,SAAS,EAC3CkD,GAEL1G,EAAM,wBAAwB,OAAQ,CAAC0G,CAAM,CAAC,CAC/C,CARehF,EAAAyC,GAAA,qBCzjBf,eAAsBwC,GAAc,CAAE,MAAAC,CAAM,EAAG,CAC9C,GAAM,CAAE,OAAAC,CAAO,EAAID,EACb,CAAE,QAAAE,EAAS,OAAAC,EAAQ,WAAAC,CAAW,EAAIH,EAClC,CAAE,QAAAI,CAAQ,EAAID,EACd,CAAE,YAAAE,EAAa,QAAAC,EAAS,QAAAC,EAAS,MAAAC,EAAO,UAAAC,CAAU,EAAIR,EACtDS,EAAWX,EAAM,YAAY,EAC7BY,EAAUZ,EAAM,QAEhBa,EAASC,EAAA,MAAOC,GACdC,GAAWD,EAAKf,EAAO,CAAE,QAAAY,EAAS,SAAAD,CAAS,CAAC,EADrC,UAIf,MAAO,CACN,YAAa,CACZ,YAAa,MAAME,EAAOP,CAAW,EACrC,QAAS,MAAMO,EAAON,CAAO,EAC7B,QAAS,MAAMM,EAAOL,CAAO,EAC7B,MAAO,MAAMK,EAAOJ,CAAK,EACzB,UAAAC,EACA,OAAQ,CACP,MAAOP,EAAO,OACd,MAAO,OAAO,KAAK,aAAaA,EAAO,MAAM,CAC9C,EACA,OAAQA,EAAO,MAAM,IAAKc,GAAU,OAAO,KAAK,aAAaA,CAAK,CAAC,EACnE,QAASC,EAASb,EAAQ,KAAK,CAChC,EACA,MAAO,CAAE,cAAe,GAAGc,EAAW,cAAc,KAAM,CAC3D,CACD,CA5BsBL,EAAAf,GAAA,iBA8Bf,SAASqB,GAAmB,CAAE,GAAAC,EAAI,MAAArB,CAAM,EAAG,CACjDqB,EAAG,KAAK,kCAAkC,EAAE,GAAG,QAAUC,GAAU,CAClEA,EAAM,eAAe,EACrB,IAAMC,EAAS,EAAED,EAAM,aAAa,EAAE,QAAQ,SAAS,EACvDE,EAAgBD,EAAQvB,CAAK,CAC9B,CAAC,EAEDyB,GAAgB,OAAOJ,EAAG,CAAC,EAAGrB,CAAK,EAG9BA,EAAM,SAEXqB,EAAG,KAAK,8BAA8B,EAAE,GAAG,QAAUC,GAAU,CAC9DA,EAAM,eAAe,EACrBtB,EAAM,WAAW,KAAK,CAAE,MAAAsB,CAAM,CAAC,CAChC,CAAC,CACF,CAhBgBR,EAAAM,GAAA,sBCnBhB,IAAMM,GAAc,CACnB,gBAAiB,CAChB,MAAO,EACP,MAAO,gDACR,EACA,MAAO,CAAE,MAAO,EAAG,MAAO,kBAAmB,EAC7C,WAAY,CAAE,MAAO,EAAG,MAAO,6BAA8B,EAC7D,UAAW,CAAE,MAAO,EAAG,MAAO,sBAAuB,EACrD,SAAU,CAAE,MAAO,EAAG,MAAO,qBAAsB,EACnD,SAAU,CAAE,MAAO,EAAG,MAAO,4BAA6B,CAC3D,EAEA,eAAsBC,GAAa,CAAE,MAAAC,EAAO,OAAAC,CAAO,EAAG,CACrD,GAAM,CAAE,SAAAC,EAAU,MAAAC,EAAO,YAAAC,EAAa,KAAAC,EAAM,SAAAC,CAAS,EAAIN,EAAM,UACzDO,EAAaP,EAAM,SAAS,UAAU,EACtCQ,EACLC,EAAW,YAAY,IACtBC,GAAQV,EAAO,cAAc,KAAK,KAAK,IAAI,GAAK,CAAC,GAC7CW,EAAa,CAAC,EAChBC,EAAa,CAAC,EAElB,QAAWC,KAAQX,EAAU,CAC5B,IAAMY,EACLD,EAAK,OAAS,UAAYA,EAAK,OAAS,SACrC,kBACAA,EAAK,KACT,GAAI,CAACf,GAAYgB,CAAI,EAAG,SAExB,IAAMC,EAAcF,EAAK,OAAO,YAE/BC,IAAS,YACTC,IACCP,IAAqB,IAAQA,EAAiB,SAASO,CAAW,IAEnEJ,EAAWI,CAAW,IAAM,CAAC,EAC7BJ,EAAWI,CAAW,EAAE,KAAKF,CAAI,IAEjCD,EAAWE,CAAI,IAAM,CAAC,EACtBF,EAAWE,CAAI,EAAE,KAAKD,CAAI,GA8B5B,GA1BAD,EAAa,OAAO,QAAQA,CAAU,EACpC,IAAI,CAAC,CAACE,EAAME,CAAK,IAAM,CAEvB,GADAA,EAAM,KAAK,CAACC,EAAGC,IAAMC,EAAcF,EAAE,KAAMC,EAAE,IAAI,CAAC,EAC9CJ,IAAS,WACZ,QAASM,EAAIJ,EAAM,OAAS,EAAGI,GAAK,EAAGA,IAAK,CAC3C,IAAMC,EAAYL,EAAMI,CAAC,EACnBE,EAAYX,EAAWU,EAAU,EAAE,GAAG,OAAQR,GACnDU,EAASV,EAAK,KAAMZ,CAAM,CAC3B,EACA,GAAI,CAACqB,GAAW,OAAQ,CAClBC,EAASF,EAAU,KAAMpB,CAAM,GAAGe,EAAM,OAAOI,EAAG,CAAC,EACxD,SAEDE,EAAU,KAAK,CAACL,EAAGC,IAAMC,EAAcF,EAAE,KAAMC,EAAE,IAAI,CAAC,EACtDF,EAAM,OAAOI,EAAI,EAAG,EAAG,GAAGE,CAAS,OAE9BN,EAAQA,EAAM,OAAQH,GAASU,EAASV,EAAK,KAAMZ,CAAM,CAAC,EACjE,MAAO,CACN,KAAAa,EACA,MAAAE,EACA,MAAOlB,GAAYgB,CAAI,EAAE,KAC1B,CACD,CAAC,EACA,OAAQU,GAAaA,EAAS,MAAM,MAAM,EAC1C,KAAK,CAACP,EAAGC,IAAMpB,GAAYmB,EAAE,IAAI,EAAE,MAAQnB,GAAYoB,EAAE,IAAI,EAAE,KAAK,EAElEN,EAAW,OACd,MAAO,CACN,QAASA,EAAW,OAAS,GAAKH,EAAW,eAAe,EAC5D,YAAa,CACZ,SAAU,CAAC,CAACT,EAAM,gBAClB,WAAAY,EACA,KAAAP,EACA,WAAYG,EACZ,KAAOiB,GAAQC,EAAS,SAASD,GAAK,EACtC,SAAUnB,EACP,GAAG,KAAK,KAAK,SAAS,oBAAoB,MAAMA,EAAS,WACzDA,EAAS,MAET,GACH,OAAQ,CAAE,MAAOH,EAAM,UAAW,MAAOC,EAAY,SAAU,EAC/D,WAAaS,GACZN,GACAM,EAAK,SAAS,YAAY,GAC1BA,EAAK,cACLA,EAAK,KAAK,KACV,CAACA,EAAK,OACP,aAAeA,GACd,CAACA,EAAK,UACN,CAACA,EAAK,KAAK,OACXA,EAAK,OAAO,SAAS,YAAc,UACpC,cAAe,CAACW,EAAUX,IACrBW,EAAS,OAAS,WAAmB,GAClC,CAACX,EAAK,SAAS,UAAU,GAAKA,EAAK,aAE5C,CACD,CAEF,CAxFsBc,EAAA5B,GAAA,gBA0Ff,SAAS6B,GAAkB,CAAE,GAAAC,EAAI,MAAA7B,EAAO,MAAA8B,EAAO,IAAAC,CAAI,EAAG,CAC5D,IAAMlB,EAAOgB,EAAG,KAAK,OAAO,EAE5BG,EAAwBnB,CAAI,EAE5BA,EAAK,KAAK,gCAAgC,EAAE,GAAG,QAAS,MAAOoB,GAAU,CACxEA,EAAM,eAAe,EACrB,IAAMpB,EAAO,EAAEoB,EAAM,aAAa,EAAE,QAAQ,OAAO,EACnD,MAAMC,EAAgBrB,EAAMb,CAAK,CAClC,CAAC,EAEDa,EACE,KAAK,qCAAqC,EAC1C,GAAG,QAAS,MAAOoB,GAAU,CAC7BA,EAAM,eAAe,EACrB,IAAME,EAAO,cAAc,KAAK,KAAK,KAC/BpB,EAAckB,EAAM,cAAc,QAAQ,OAAO,EAAE,QAAQ,OAC3DtB,EAAaD,GAAQV,EAAOmC,CAAI,GAAG,MAAM,GAAK,CAAC,EAC/CC,EAAQzB,EAAW,QAAQI,CAAW,EACxCqB,IAAU,GAAIzB,EAAW,KAAKI,CAAW,EACxCJ,EAAW,OAAOyB,EAAO,CAAC,EAC/B,MAAMC,GAAQrC,EAAOmC,EAAMxB,CAAU,CACtC,CAAC,EAGGX,EAAM,UAEXa,EAAK,KAAK,wBAAwB,EAAE,GAAG,QAAUoB,GAAU,CAC1D,IAAMpB,EAAOyB,EAAiBL,EAAOjC,CAAK,EACrCa,IAELA,EAAK,QAAQ,EACTJ,EAAW,WAAW,GAAGsB,EAAI,MAAM,EACxC,CAAC,EAEDlB,EAAK,KAAK,yBAAyB,EAAE,GAAG,QAAS,MAAOoB,GAAU,CACjE,IAAMpB,EAAOyB,EAAiBL,EAAOjC,CAAK,EACrCa,IAELA,EAAK,UAAUoB,EAAO,CAAE,OAAQ,EAAK,CAAC,EAClCxB,EAAW,YAAY,GAAGsB,EAAI,MAAM,EACzC,CAAC,EAEDlB,EAAK,GAAG,YAAcoB,GAAU,CAC/B,IAAMM,EAASN,EAAM,OAAO,QAAQ,OAAO,EACrC,CAAE,SAAAO,EAAU,KAAAC,CAAK,EAAIF,EAAO,QAE5BG,EAAM,IAAI,MAChBA,EAAI,IAAMH,EAAO,cAAc,eAAe,EAAE,IAChDG,EAAI,MAAM,MAAQ,OAClBA,EAAI,MAAM,OAAS,OACnBA,EAAI,MAAM,aAAe,MACzBA,EAAI,MAAM,SAAW,WACrBA,EAAI,MAAM,KAAO,UACjB,SAAS,KAAK,OAAOA,CAAG,EAExBT,EAAM,cAAc,aAAa,aAAaS,EAAK,GAAI,EAAE,EACzDT,EAAM,cAAc,aAAa,QAChC,aACA,KAAK,UAAU,CAAE,KAAM,OAAQ,cAAe,GAAM,SAAAO,EAAU,KAAAC,CAAK,CAAC,CACrE,EAEAF,EAAO,iBAAiB,UAAW,IAAMG,EAAI,OAAO,EAAG,CAAE,KAAM,EAAK,CAAC,CACtE,CAAC,EAEDb,EAAG,KAAK,iBAAiB,EAAE,GAAG,SAAU,MAAOI,GAAU,CACxD,MAAMK,EAAiBL,EAAOjC,CAAK,GAAG,OAAO,CAC5C,kBAAmBiC,EAAM,cAAc,aACxC,CAAC,CACF,CAAC,EAEDJ,EAAG,KAAK,kCAAkC,EAAE,GAAG,QAAUI,GAAU,CAClEA,EAAM,eAAe,EACrB,GAAM,CAAE,OAAAU,CAAO,EAAIV,EAAM,cAAc,QAAQ,OAAO,EAAE,QACxDjC,EAAM,eAAe2C,CAAM,CAC5B,CAAC,EAEDd,EAAG,KAAK,2BAA2B,EAAE,GAAG,QAAUI,GAAU,CAC3DA,EAAM,eAAe,EACrB,IAAMpB,EAAOyB,EAAiBL,EAAOjC,CAAK,EACtCa,GACH,KAAK,KAAK,QAAQ,OAAO,CAAE,KAAAA,EAAM,OAAQ,CAACb,CAAK,EAAG,OAAQ,CAAC8B,CAAK,CAAE,CAAC,CACrE,CAAC,EAEDD,EAAG,KAAK,iCAAiC,EAAE,GAAG,QAAUI,GAAU,CACjEA,EAAM,eAAe,EACrB,IAAMpB,EAAOyB,EAAiBL,EAAOjC,CAAK,EACrCa,IACDA,EAAK,aAAcA,EAAK,wBAAwB,cAAc,EAC7D,IAAI+B,GAAkB/B,CAAI,EAAE,OAAO,EAAI,EAC7C,CAAC,EAEDgB,EAAG,KAAK,2BAA2B,EAAE,GAAG,QAAUI,GAAU,CAC3DA,EAAM,eAAe,EACrB,GAAM,CAAE,OAAAU,EAAQ,SAAAE,CAAS,EACxBZ,EAAM,cAAc,QAAQ,gBAAgB,EAAE,QAEzCa,EAAS9C,EAAM,MAAM,IAAI6C,CAAQ,EACvC,GAAI,CAACC,EAAQ,OAEb,IAAMC,EAAUD,EAAO,SAAS,IAAIH,CAAM,EACrCI,GAELC,GAAcD,EAASd,EAAM,OAAO,CACrC,CAAC,EAEDJ,EAAG,KAAK,yBAAyB,EAAE,GAAG,QAAUI,GAAU,CACzDA,EAAM,eAAe,EACRK,EAAiBL,EAAOjC,CAAK,GACpC,MAAM,OAAO,GAAM,CAAE,MAAO,EAAK,CAAC,CACzC,CAAC,EAED6B,EAAG,KAAK,2BAA2B,EAAE,GAAG,QAAUI,GAAU,CAC3DA,EAAM,eAAe,EACrB,IAAMpB,EAAOyB,EAAiBL,EAAOjC,CAAK,EACrCa,IAEDoB,EAAM,QAASpB,EAAK,OAAO,EAC1BA,EAAK,aAAa,EACxB,CAAC,EAEDgB,EAAG,KAAK,gCAAgC,EAAE,GAAG,QAAS,MAAOI,GAAU,CACtE,IAAMpB,EAAOyB,EAAiBL,EAAOjC,CAAK,EAC1C,GAAI,CAACa,EAAM,OAEX,IAAMoC,EAAU,SAAS,cAAc,KAAK,EAC5CA,EAAQ,UAAY,MAAM,eACzB,wDACA,CAAE,KAAApC,CAAK,CACR,EAEA,QAAWgB,KAAMoB,EAAQ,iBAAiB,mBAAmB,EAC5DpB,EAAG,iBAAiB,QAAS,MAAOI,GAAU,CAC7C,IAAMiB,EAAOjB,EAAM,cACbkB,EAAYD,EAAK,QAAQ,UACzBE,EAAY,OAAOF,EAAK,QAAQ,SAAS,GAAK,EAC9CG,EAASH,EAAK,QAAQ,SAAW,OACjCI,EAAUzC,EAAK,OAAO,SAE5B0C,GAAeL,CAAI,GAGlBC,IAAcG,EAAQ,WACtBD,IAAWC,EAAQ,QAClBH,IAAc,QAAUC,IAAcE,EAAQ,YAE/CtD,EAAM,gBAAgBa,EAAM,CAAE,UAAAsC,EAAW,UAAAC,EAAW,OAAAC,CAAO,CAAC,CAE9D,CAAC,EAGF,GAAIxC,EAAK,OAAS,WAAY,CAC7B,IAAMF,EAAaX,EAAM,UAAU,SAAS,OAC1CqB,GAAcA,EAAU,YAC1B,EAEA,GAAIV,EAAW,OAAQ,CACtB,IAAI6C,EAAO,GACX,QAAWnC,KAAaV,EACvB6C,GAAQ,kDACJnC,IAAcR,EAAK,YAAW2C,GAAQ,aAC1CA,GAAQ,wDAAwDnC,EAAU,OAC1EmC,GAAQ,6BAA6BnC,EAAU,gBAGhD4B,EAAQ,mBAAmB,YAAaO,CAAI,EAE5C,IAAMC,EAAmBR,EAAQ,iBAChC,iCACD,EACA,QAAWpB,KAAM4B,EAChB5B,EAAG,iBAAiB,QAAUI,GAAU,CACvC,IAAMiB,EAAOjB,EAAM,cACblB,EAAcmC,EAAK,QAAQ,YAC3B7B,EAAYrB,EAAM,MAAM,IAAIe,CAAW,EACxCM,IAELkC,GAAeL,CAAI,EACnBlD,EAAM,aAAaa,EAAMQ,CAAS,EACnC,CAAC,GAKJqC,GAAc,CACb,OAAQzB,EAAM,cACd,QAAAgB,EACA,OAAQ,GACR,UAAW,KACX,SAAU,GACV,SAAU,YACX,CAAC,CACF,CAAC,EACF,CAjMgBtB,EAAAC,GAAA,qBChGhB,eAAsB+B,GAAc,CAAE,MAAAC,EAAO,OAAAC,CAAO,EAAG,CACtD,IAAMC,EAAYF,EAAM,OAAO,UAAU,OAAS,CAAE,MAAO,EAAG,IAAK,CAAE,EAC/DG,EAAgBC,EAAW,WAAW,EAEtCC,EAAmB,KAAK,QAAQ,IAAI,aAAa,GAAG,OACpDC,EAAc,KAAK,QAAQ,IAAI,cAAc,EAC7CC,EAAoBD,GAAa,OACjCE,EACLH,GACCE,GAAqB,eAAeD,EAAY,QAAS,QAAQ,EAC7DG,EAAcJ,EACjB,4BACAE,EACE,mCACA,GAECG,EAAS,CAAC,EACVC,EAAU,CAAC,EAEbC,EACAC,EAAmB,GAEjBC,EAAU,MAAM,QAAQ,IAC7Bd,EAAM,aAAa,YAAY,IAAI,MAAOU,IAClC,CACN,MAAOA,EAAO,MACd,KAAM,MAAMA,EAAO,MAAM,aAAa,CAAE,OAAAA,CAAO,CAAC,CACjD,EACA,CACF,EAEA,OAAW,CAAE,MAAAK,EAAO,KAAAC,CAAK,IAAKF,EAAS,CACtC,GAAIE,EAAK,SAAU,CAClBJ,EAAUI,EAAK,OAAO,QAAQ,CAACC,EAAOC,IACrCD,EAAM,OACJ,IAAI,CAAC,CAAE,MAAAE,CAAM,IAAM,CACnB,GAAKC,EAASD,EAAM,KAAMlB,CAAM,EAChC,MAAO,CACN,KAAMkB,EAAM,KACZ,IAAKA,EAAM,IACX,OAAAD,EACA,OAAQC,EAAM,GACd,KAAMA,EAAM,KACZ,KAAMA,EAAM,OAAO,KAAK,KACzB,CACD,CAAC,EACA,OAAO,OAAO,CACjB,EACA,SAGD,IAAME,EAAUL,EAAK,GACfM,EAAYnB,GAAiBa,EAAK,UAAU,MAAM,CAAC,EACnDO,EAAUP,EAAK,YACfQ,EAAWT,EAAM,QAAQ,UAAU,QAAU,SAC7CU,EAAWT,EAAK,SAChBU,EAAaV,EAAK,WAClBW,EAAgBX,EAAK,cACrBY,EAAaZ,EAAK,WAElBa,GAAc,IAAM,CACzB,GAAIb,EAAK,WAAa,QAAS,OAC/B,IAAMc,EAASf,EAAM,GAAG,MAAM,GAAG,EAAE,CAAC,EACpC,OAAOf,EAAM,MAAM,IAAI8B,CAAM,CAC9B,GAAG,EAEGC,GAAW,IAAM,CACtB,GAAI,CAACP,EAAU,OAEf,IAAMQ,EACLzB,GACAD,EAAY,IAAI,8BAA8BS,CAAK,EAC9C,CAAE,QAAAgB,EAAS,IAAAE,EAAK,WAAAC,CAAW,EAAIF,GACpC,YAAYjB,EAAO,2BAA2B,GAAK,CAClD,QAAS,EACT,IAAK,CACN,EAED,MAAO,CACN,MAAOgB,EACP,IAAAE,EACA,MAAO,GACP,WAAYC,IAAe,IAAM,GAClC,CACD,GAAG,EAEH,QAAWjB,KAASD,EAAK,OAAQ,CAChC,GAAI,CAACC,EAAM,OAAO,QAAUA,EAAM,MAAM,MAAQ,EAAG,SAEnD,IAAMkB,EAAa,CAAC,EACdC,EAAYnB,EAAM,KAAO,WACzBoB,EAAcC,GAAyBrB,EAAM,EAAE,EAErD,QAASC,GAAS,EAAGA,GAASD,EAAM,OAAO,OAAQC,KAAU,CAC5D,IAAMqB,EAAStB,EAAM,OAAOC,EAAM,EAClC,GAAI,CAACqB,GAAUA,EAAO,MAAM,MAAQ,EAAG,SAEvC,GAAM,CAAE,MAAApB,EAAO,SAAAqB,GAAU,QAAAC,GAAS,KAAAC,GAAM,SAAAC,EAAS,EAAIJ,EAChDnB,EAASD,EAAM,KAAMlB,CAAM,GAEhCkC,EAAW,KAAK,CACf,KAAMhB,EAAM,KACZ,IAAKA,EAAM,IACX,UAAAG,EACA,SAAUqB,IAAYxB,EAAM,KAC5B,OAAAD,GACA,QAAAG,EACA,OAAQF,EAAM,GACd,QAASM,EAAWN,EAAM,GAAKH,EAAK,GACpC,UAAWa,EACR,oBACAL,EACEf,EACAgB,EACC,6BACA,oBAAoBY,UAC1B,SAAAb,EACA,eAAgBA,GAAYhB,EAC5B,UAAWiC,GACX,SAAAhB,EACA,UAAAW,EACA,QAAAb,EACA,WAAAG,EACA,cAAeC,GAAiBC,EAChC,QAASX,EAAM,GACf,WAAAY,EACA,KAAMA,EACHA,EAAW,OAAO,KAClBL,EACEO,EACAW,IAAQzB,EAAM,KACnB,SAAUO,EACP,CAACO,EAAQ,WAAWM,CAAW,EAC/BG,KACCjB,GAAW,CAACa,EAAYlC,EAAU,OAAS,EAAI,IACnD,OAAQiB,EAAM,OAAO,KAAK,MAC1B,KAAMU,EACH,iCAAiCA,EAAW,WAC5CL,EACE,GAAGoB,iBACHnB,EACC,6BACAE,EACC,kCACAC,EACC,0BACAL,EACC,kBACA,0BACT,MAAOC,EACJ,EACAE,EACE,EACAH,EACC,EACAE,EACC,EACAE,EACC,EACA,CACT,CAAC,EAGF,GAAIQ,EAAW,OAAQ,CACtB,GAAIZ,EACH,GAAIa,EAAWvB,EAAmB,OAC7B,CACJF,EAAQ,KAAK,GAAGwB,CAAU,EAC1B,SAIFzB,EAAO2B,CAAW,IAAM,CAAC,EACzB3B,EAAO2B,CAAW,EAAE,KAAK,GAAGF,CAAU,IAKzC,GAAIzB,EAAO,OAAQ,CAClB,IAAMmC,EAAiBzC,EAAW,aAAa,EACzC0C,EACLD,IAAmB,OAChB,CAACE,EAAGC,IACJD,EAAE,QAAUC,EAAE,MACXC,EAAcF,EAAE,KAAMC,EAAE,IAAI,EAC5BD,EAAE,MAAQC,EAAE,MACfH,IAAmB,QACjB,CAACE,EAAGC,IAAM,CACX,IAAME,EAAiBD,EAAcF,EAAE,QAASC,EAAE,OAAO,EACzD,OAAIE,IAAmB,EAAUA,EAC1BD,EAAcF,EAAE,KAAMC,EAAE,IAAI,CACnC,EACC,CAACD,EAAGC,IAAMC,EAAcF,EAAE,KAAMC,EAAE,IAAI,EAE5C,QAAWjC,KAASL,EACdK,GACLA,EAAM,KAAK+B,CAAI,EAUjB,GANInC,EAAQ,SACXA,EAAQ,KAAK,CAACoC,EAAGC,IAAMC,EAAcF,EAAE,KAAMC,EAAE,IAAI,CAAC,EACpDtC,EAAO,EAAE,EAAIC,EACbE,EAAmB,IAGhBH,EAAO,QAAUE,GAAS,OAAQ,CACrC,IAAMuC,EAAUC,GAAgBpD,CAAK,EAE/BqD,EAAK3C,EAAO,QAAS,GAAQE,GAAS,QAAU,GAAK,GAC3D,MAAO,CACN,YAAa,CACZ,OAAAF,EACA,QAAAE,EACA,UAAAV,EACA,iBAAAW,EACA,KAAOyC,GAAQC,EAAS,UAAUD,GAAK,EACvC,UAAWE,GAAqBL,CAAO,EAAIA,EAAQ,CAAC,EAAE,IAAM,KAC5D,UAAYM,GACX,KAAK,KAAK,OAAO,+BAAgC,CAChD,KAAMC,GAAcD,CAAI,CACzB,CAAC,CACH,EACA,QAASJ,EAAK,GAAKjD,EAAW,gBAAgB,CAC/C,EAEF,CAlOsBuD,EAAA5D,GAAA,iBAoOtB,SAASqD,GAAgBpD,EAAO,CAC/B,OAAOA,EAAM,aACX,OAAQe,GAAUA,EAAM,SAAS,EACjC,IAAI,CAAC,CAAE,UAAA6C,EAAW,KAAAC,EAAM,GAAAC,CAAG,KAAO,CAClC,KAAAD,EACA,GAAAC,EACA,IAAKC,EAASH,EAAU,GAAG,EAC3B,UAAAA,CACD,EAAE,CACJ,CATSD,EAAAP,GAAA,mBAWT,SAASI,GAAqBL,EAAS,CACtC,OAAO,IAAI,IAAIA,EAAQ,IAAI,CAAC,CAAE,IAAAa,CAAI,IAAMA,CAAG,CAAC,EAAE,OAAS,CACxD,CAFSL,EAAAH,GAAA,wBAIF,SAASS,GAAmB,CAAE,GAAAC,EAAI,MAAAlE,EAAO,IAAAmE,CAAI,EAAG,CACtDC,EAAwBF,EAAG,KAAK,QAAQ,CAAC,EAEzCA,EAAG,KAAK,iCAAiC,EAAE,GAAG,QAAS,MAAOG,GAAU,CACvEA,EAAM,eAAe,EACrB,IAAMlD,EAAQ,EAAEkD,EAAM,aAAa,EAAE,QAAQ,QAAQ,EACrDC,EAAgBnD,EAAOnB,CAAK,CAC7B,CAAC,EAGIA,EAAM,UAEXkE,EAAG,KAAK,4BAA4B,EAAE,GAAG,QAAS,MAAOG,GAAU,CAClEA,EAAM,eAAe,EAErB,IAAMlB,EAAUC,GAAgBpD,CAAK,EACrC,GAAI,CAACmD,EAAQ,OAAQ,OAErB,IAAIS,EACJ,GAAKJ,GAAqBL,CAAO,EAkBhCS,EAAYT,EAAQ,CAAC,EAAE,cAlBY,CACnC,IAAMW,EAAK,MAAM,OAAO,KAAK,CAC5B,QAAS,CACR,GAAI,CACH,KAAM,uCACN,MAAOP,EAAS,mBAAmB,EACnC,SAAWgB,GAASA,EAAK,KAAK,eAAe,EAAE,IAAI,CACpD,CACD,EACA,MAAOhB,EAAS,sBAAsB,EACtC,QAAS,MAAM,eAAeiB,EAAa,uBAAuB,EAAG,CACpE,QAAArB,CACD,CAAC,EACD,MAAO,IAAM,IACd,CAAC,EAEGW,IAAIF,EAAY5D,EAAM,MAAM,IAAI8D,CAAE,GAAG,WAK1C,IAAMW,EAAaC,GAAkBL,EAAO,CAAE,KAAM,OAAQ,CAAC,EACvD,CAAE,IAAAM,CAAI,EAAIN,EAAM,cAAc,QAChCM,IACHF,EAAW,UAAY,CACtB,IAAI,KAAK,KAAK,SAAS,CACtB,MAAO,6BACP,SAAU,OAAOE,CAAG,CACrB,CAAC,CACF,GAGDf,GAAW,MAAM,KAAKa,CAAU,CACjC,CAAC,EAEDP,EAAG,KAAK,yBAAyB,EAAE,GAAG,QAAS,MAAOG,GAAU,CAC/DA,EAAM,eAAe,EAErB,IAAMO,EAAOC,EAAiBR,EAAOrE,CAAK,EACrC4E,GAEL5E,EAAM,gBAAgB4E,EAAM,CAAE,UAAW,OAAQ,UAAW,CAAE,CAAC,CAChE,CAAC,EAEDV,EAAG,KAAK,0BAA0B,EAAE,GAAG,QAAS,MAAOG,GAAU,CAChEA,EAAM,eAAe,EAErB,IAAMO,EAAOC,EAAiBR,EAAOrE,CAAK,EACrC4E,IAELA,EAAK,UAAUP,CAAK,EAChBjE,EAAW,YAAY,GAAG+D,EAAI,MAAM,EACzC,CAAC,EAEDD,EAAG,KAAK,2BAA2B,EAAE,GACpC,oBACA,MAAOG,GAAU,CAChBA,EAAM,eAAe,EACrB,IAAMS,EAAST,EAAM,OAAS,QAAU,EAAI,GACtCU,GAAU/E,EAAM,OAAO,UAAU,OAAO,OAAS,GAAK8E,EAC5D,MAAM9E,EAAM,OAAO,CAAE,+BAAgC+E,CAAO,CAAC,CAC9D,CACD,EAEAb,EAAG,KAAK,+BAA+B,EAAE,GAAG,QAAUG,GAAU,CAC/DA,EAAM,eAAe,EACrB,GAAM,CAAE,QAAAW,EAAS,OAAA9D,EAAQ,QAAAG,EAAS,SAAAmB,CAAS,EAAI,EAAE6B,EAAM,aAAa,EAClE,QAAQ,QAAQ,EAChB,KAAK,EACYrE,EAAM,aAAa,YAAY,IAAIqB,CAAO,GACjD,qBACX4D,GAAqBD,CAAO,EAC5B9D,GAAU,EACVsB,IAAa,EACd,CACD,CAAC,EAED0B,EAAG,KAAK,0BAA0B,EAAE,GAAG,QAAUG,GAAU,CAC1DA,EAAM,eAAe,EAErB,GAAM,CAAE,SAAA1B,EAAU,OAAAzB,EAAQ,QAAAG,EAAS,OAAAS,CAAO,EACzCuC,EAAM,cAAc,QAAQ,QAAQ,EAAE,QAEjCa,EAAalF,EAAM,aAAa,YAAY,IAAIqB,CAAO,EAC7D,GAAI,CAAC6D,EAAY,OAEjB,IAAM/D,EAAQ+D,EAAW,IAAIpD,CAAM,EACnC,GAAI,CAACX,EAAO,OAEZ,IAAMgE,EAAgB,OAAOxC,CAAQ,GAAK,IACtC,OAAO,UAAUwC,CAAa,GAAKA,EAAc,QAAQ,EAAG,EAAE,IAC5DhE,EAAM,YAAY,QAAQ,GAC9B+D,EAAW,MAAM,KAAK/D,EAAO,CAC5B,KAAMgE,EACN,OAAQ,OAAOjE,CAAM,CACtB,CAAC,GAICd,EAAW,YAAY,GAAG+D,EAAI,MAAM,CACzC,CAAC,EAEDD,EAAG,KAAK,mBAAmB,EAAE,GAAG,SAAU,MAAOG,GAAU,CAC1D,GAAM,CAAE,UAAAe,EAAW,QAAA/D,CAAQ,EAAI,EAAEgD,EAAM,aAAa,EAAE,KAAK,EACrDgB,EAAQhB,EAAM,cAAc,cAClC,MAAMrE,EAAM,wBAAwB,OAAQ,CAC3C,CAAE,IAAKqB,EAAS,CAAC+D,CAAS,EAAGC,CAAM,CACpC,CAAC,CACF,CAAC,EACF,CAhIgB1B,EAAAM,GAAA,sBC9OhB,IAAMqB,GAAmB,CACxB,iBACA,WACA,gBACA,eACA,mBACA,uBACD,EAAE,KAAK,IAAI,EAELC,GAAoB,CACzB,QAAS,UACT,OAAQ,eACR,MAAO,YACP,OAAQ,eACT,EAEMC,GAAY,CACjB,KAAM,CAAC,OAAQ,QAAS,MAAO,QAAQ,EACvC,MAAO,CAAC,QAAS,OAAQ,MAAO,QAAQ,EACxC,IAAK,CAAC,MAAO,SAAU,OAAQ,OAAO,EACtC,OAAQ,CAAC,SAAU,MAAO,OAAQ,OAAO,CAC1C,EAEMC,GAAY,CACjB,WAAY,CACX,KAAM,+BACN,MAAO,yCACR,EACA,MAAO,CACN,KAAM,8BACN,MAAO,oCACR,EACA,QAAS,CACR,KAAM,uBACN,MAAO,sCACR,CACD,EAEMC,GAAS,CACd,CAAE,KAAM,OAAQ,KAAM,yBAA0B,EAChD,CAAE,KAAM,SAAU,KAAM,2BAA4B,EACpD,CAAE,KAAM,QAAS,KAAM,oBAAqB,EAC5C,CAAE,KAAM,MAAO,KAAM,qBAAsB,EAC3C,CAAE,KAAM,OAAQ,KAAM,6BAA8B,CACrD,EAEMC,GAAW,CAChB,QAAS,CAAE,QAASC,GAAgB,aAAcC,EAAoB,EACtE,MAAO,CAAE,QAASC,GAAc,aAAcC,EAAkB,EAChE,OAAQ,CAAE,QAASC,GAAe,aAAcC,EAAmB,EACnE,OAAQ,CAAE,QAASC,GAAe,aAAcC,EAAmB,EACnE,OAAQ,CAAE,QAASC,GAAe,aAAcC,EAAmB,EACnE,OAAQ,CAAE,QAASC,GAAe,aAAcC,EAAmB,CACpE,EAEMC,GAAQ,CACb,UAAW,CAAE,KAAM,yBAA0B,MAAO,qBAAsB,EAC1E,OAAQ,CAAE,KAAM,6BAA8B,MAAO,kBAAmB,EACxE,KAAM,CAAE,KAAM,oBAAqB,MAAO,gBAAiB,CAC5D,EAEMC,GAAS,CACd,WAAY,CAAE,KAAM,kBAAmB,MAAO,sBAAuB,EACrE,QAAS,CAAE,KAAM,0BAA2B,MAAO,mBAAoB,EACvE,UAAW,CAAE,KAAM,wBAAyB,MAAO,qBAAsB,CAC1E,EAEaC,GAAN,cAAkB,WAAY,CACpCC,GAAS,KACTC,GAAa,KACbC,GAAgB,KAChBC,GAAS,KACTC,GAAW,GACXC,GAAW,KACXC,GAAa,CAAC,GAAO,GAAO,EAAK,EACjCC,GAAQ,GACRC,GAAY,GACZC,GAAc,GACdC,GACAC,GACAC,GAEA,aAAc,CACb,MAAM,EAEN,KAAK,WAAa,IAAM,KAAK,MAAM,CAAE,MAAO,EAAK,CAAC,EAElD,KAAKF,GAAqB,CAACG,EAAOC,IAAU,CACvCA,EAAO,KAAKC,GAAYF,CAAK,EAC5B,KAAKG,GAAYH,CAAK,CAC5B,EAEA,KAAKF,GAAsBM,GAAU,CACpC,IAAMC,EAASD,EAAM,OACrB,GAAI,CAAC,CAAC,EAAG,CAAC,EAAE,SAASC,CAAM,EAAG,OAE9B,GAAID,EAAM,OAAS,UAAW,CAC7B,KAAKX,GAAWY,CAAM,EAAI,GAC1B,OAGD,KAAKZ,GAAWY,CAAM,EAAI,GAE1B,IAAMC,EAASF,EAAM,OACfG,EAAK,KAAK,QAAQ,CAAC,EAEzB,GAAIA,EAAI,CACP,IAAMC,EAAQD,EAAG,cAAc,QAAQ,EAEvC,GAAIC,GAAS,CAACA,EAAM,SAASF,CAAM,EAClC,GAAI,CAACC,EAAG,cAAc,UAAU,EAAG,KAAK,WAAW,MAC9C,QAAOC,EAAM,OAAO,EAGtBF,EAAO,QAAQ,QAAQ,GAAG,KAAK,WAAW,EAE9C,OAGD,KAAKG,GAAa,EAClB,KAAK,OAAO,EAAI,CACjB,EAEA,KAAKV,GAAuBC,GAAU,CACjC,KAAKb,IAAUa,EAAM,KAAO,KAAKb,GAAO,IAAI,KAAK,WAAW,CACjE,EAEA,OAAO,iBAAiB,YAAa,KAAKW,EAAkB,EAC5D,OAAO,iBAAiB,UAAW,KAAKA,EAAkB,EAE1D,MAAM,GAAG,aAAc,KAAKD,EAAkB,EAC9C,MAAM,GAAG,cAAe,KAAKE,EAAmB,EAChD,MAAM,GAAG,YAAa,KAAK,UAAU,CACtC,CAEA,SAASC,EAAOU,EAAY,CAC3B,GAAIV,IAAU,KAAKb,GAAQ,CAC1B,OAAO,KAAKA,IAAQ,OAAO,KAAK,KAAK,KAAK,EAE1C,KAAKA,GAASa,EACd,IAAMW,EAAQX,GAAO,MACjBW,IAAOA,EAAM,KAAK,KAAK,KAAK,EAAI,MAErC,KAAKf,GAAcc,GAAc,KAAKE,GAAiBZ,CAAK,CAC7D,CAEA,WAAWa,EAAM,CAChB,IAAMC,EAAUC,EAAW,aAAa,EACxC,GAAID,IAAY,SAEhB,KAAKvB,GAAWsB,EAEZ,OAAKlB,IAAa,KAAKD,KAE3B,GAAImB,EAAM,CACT,GAAI,CAAC,KAAKxB,GAAe,OACzB,IAAMqB,EAAa,KAAKE,GAAiB,KAAKvB,EAAa,EAC3D,GAAIyB,IAAY,QAAU,CAAC,KAAK,KAAK,MAAQ,CAACJ,EAAY,CACzD,KAAKD,GAAa,EAClB,KAAK,OAAO,EACZ,OAED,KAAK,SAAS,KAAKpB,GAAeqB,CAAU,EAC5C,KAAK,OAAO,OAERI,IAAY,MAAO,KAAK,MAAM,EACzB,KAAK,KAAK,MAClB,KAAK,SAAS,KAAKzB,EAAa,EAChC,KAAK,OAAO,GACF,KAAKO,IAAa,KAAK,MAAM,CAE1C,CAEAgB,GAAiBZ,EAAO,CACvB,IAAMW,EAAQX,GAAO,MACrB,GAAI,CAACW,EAAO,MAAO,GAEnB,IAAID,EACEM,EAAUL,EAAM,OAAO,QAAQ,WAAa,QAElD,OACC,KAAK,KAAK,MACVI,EAAW,aAAa,IAAM,QAC9B,CAAC,KAAKxB,IAGEoB,EAAM,SAAS,UAAU,GAAK,CAACA,EAAM,OAD7CD,EAAa,GAGbA,EACCV,EAAM,SACLe,EAAW,UAAU,IACpBf,EAAM,UAAagB,GAAWD,EAAW,OAAO,GAE7CL,CACR,CAEAR,GAAYF,EAAO,CAClB,GAAI,EAAE,OAAO,QAAQ,EAAE,KAAK,QAAQ,EAAE,OAAOlC,EAAgB,EAAE,OAC9D,OAED,IAAM6C,EAAQX,EAAM,MAepB,GAdI,CAACW,GAASA,EAAM,SAAS,OAAQ,OAAO,GAG3CX,EAAM,SAAS,cAAgB,MAAM,mBAAmB,QACxD,CAACW,EAAM,SAIJA,EAAM,SAAS,KAAK,GAAKI,EAAW,SAAS,GAAKJ,EAAM,SAE5D,KAAKtB,GAAgBW,EAEjBA,IAAU,KAAKZ,IAAc,CAAC,KAAKM,IAAO,KAAK,MAAM,EAErD,KAAK,WAAa,KAAKA,IAAS,KAAKC,IAAaK,IAAU,KAAKb,IACpE,OAED,IAAM2B,EAAUC,EAAW,aAAa,EAClCL,EAAa,KAAKE,GAAiBZ,CAAK,EAE7Cc,IAAY,QACZ,CAAC,KAAKvB,KACLuB,IAAY,OAASJ,KAIvB,KAAKO,GAAe,EAAI,EACxB,KAAK,SAASjB,EAAOU,CAAU,EAE3BI,IAAY,QAAU,CAAC,KAAKvB,GAAU,KAAK,gBAAgB,EAC1D,KAAK,OAAO,EAClB,CAEAY,GAAYH,EAAO,CAClB,KAAKX,GAAgB,KAEjB,OAAK,WAAa,KAAKK,IAAS,KAAKC,MAEzC,KAAKH,GAAW,WAAW,IAAM,CAChC,KAAKA,GAAW,KACZ,OAAKG,IAAa,KAAKD,KAC3B,KAAK,MAAM,CACZ,EAAG,EAAE,EACN,CAEA,iBAAkB,CACjB,IAAIwB,EAAQH,EAAW,OAAO,EAC1BG,GACCA,EAAQ,KAAIA,EAAQ,IACxB,KAAK5B,GAAS,WAAW,IAAM,CAC9B,KAAKA,GAAS,KACd,KAAK,OAAO,CACb,EAAG4B,CAAK,GACF,KAAK,OAAO,CACpB,CAEAD,GAAeE,EAAO,CACjB,KAAK3B,KAAa,OACtB,aAAa,KAAKA,EAAQ,EAC1B,KAAKA,GAAW,KACZ2B,GAAO,KAAK,MAAM,EACvB,CAEAV,IAAe,CACV,KAAKnB,KAAW,OACpB,aAAa,KAAKA,EAAM,EACxB,KAAKA,GAAS,KACf,CAEA,QAAS,CACR,KAAK,WAAW,EAEhB,OAAO,oBAAoB,YAAa,KAAKQ,EAAkB,EAC/D,OAAO,oBAAoB,UAAW,KAAKA,EAAkB,EAE7D,MAAM,IAAI,aAAc,KAAKD,EAAkB,EAC/C,MAAM,IAAI,cAAe,KAAKE,EAAmB,EACjD,MAAM,IAAI,YAAa,KAAK,UAAU,CACvC,CAEA,WAAW,gBAAiB,CAC3B,OAAO,YAAY,YAAY,eAAgB,CAC9C,OAAQ,GACR,YAAa,GACb,SAAUqB,EAAa,KAAK,CAC7B,CAAC,CACF,CAEA,IAAI,WAAY,CACf,OAAO,KAAK3B,GAAW,CAAC,GAAK,KAAKA,GAAW,CAAC,CAC/C,CAEA,IAAI,OAAQ,CACX,OAAO,KAAKN,EACb,CAEA,IAAI,OAAQ,CACX,OAAO,KAAKA,IAAQ,KACrB,CAEA,IAAI,UAAW,CACd,MAAO,CAAC,CAACkC,GAAe,KAAK,KAAK,CACnC,CAEA,IAAI,SAAU,CACb,OAAO,KAAK,SAAS,KAAK,YAAY,GAAK,CAAC,CAC7C,CAEA,IAAI,OAAQ,CACX,OAAO,KAAK,SAAS,KAAK,UAAU,GAAK,CAAC,CAC3C,CAEA,IAAI,OAAQ,CACX,OAAO,KAAK,SAAS,KAAK,UAAU,GAAK,CAAC,CAC3C,CAEA,MAAM,SAAU,CACf,IAAMrB,EAAQ,KAAKb,GACbwB,EAAQ,KAAKxB,IAAQ,MAC3B,GAAI,CAACwB,EAAO,MAAO,CAAC,EAEpB,IAAIW,EAAW,KACTC,EAAeR,EAAW,OAAO,EACjCS,EAAgBT,EAAW,QAAQ,EACnCU,EAAcd,EAAM,SAAS,WAAW,EACxC,CAAE,WAAAe,CAAW,EAAIf,EACjB,CAAE,GAAAgB,EAAI,GAAAC,CAAG,EAAIF,EACbG,EAAKF,EAAG,IAAM,CAAE,IAAK,EAAG,MAAO,CAAE,EACjCG,EAAa,KAAK,SAAS,IAAI,OAAQ,gBAAgB,EACvDC,EAAehB,EAAW,UAAU,EACpCiB,EAAWjB,EAAW,OAAO,EAEnC,GACCgB,IAAiB,OAChBA,IAAiB,QAAU,KAAKnC,GAChC,CACD,IAAMqC,EAAYlB,EAAW,MAAM,EAAE,MAAM,GAAG,EACxCmB,EAAa,OAAOD,EAAU,CAAC,GAAG,KAAK,CAAC,GAAK,EAC7CE,EAAOF,EAAU,CAAC,GAAG,KAAK,GAAK,KAAK,OAAO,UAC3CG,EAAW,OAAOH,EAAU,CAAC,GAAG,KAAK,CAAC,GAAK,EAC3CI,EAAW,OAAO,OAAO,WAE3BC,GAAW,GACXhC,GAAS+B,EAAS,SAAW,EAAIA,EAAS,CAAC,EAAI,MAE/C,CAAC/B,IAAUA,KAAWN,KACzBM,GAASiC,GAAgB,EACzBD,GAAW,IAGRhC,IAAUA,KAAWN,IACxBsB,EAAW,CACV,KAAAa,EACA,KAAMG,GACH,gDACA,qCACH,OAAQtC,EAAM,WAAWM,EAAM,EAAI4B,GAAY,QAAQE,CAAQ,CAChE,GAIF,IAAII,EACJ,GAAI,CAAC,KAAK5C,IAAemB,EAAW,YAAY,EAAG,CAClD,IAAM0B,EAAW1B,EAAW,QAAQ,EAClC,MAAM,GAAG,EACT,IAAK2B,GAAMA,EAAE,KAAK,CAAC,EACnB,OAAO,OAAO,EAEhB,GAAID,EAAS,QAAUd,EAAG,IAAK,CAC9B,IAAMgB,EAAMhB,EAAG,KAAOG,EAAaD,EAAG,IAAM,GACtCe,EAAUjB,EAAG,OAASG,EAAaD,EAAG,MAAQ,GAC9CgB,EAAQ,KAAK,QAAQD,EAAUD,EAAK,EAAG,CAAC,EACxCG,GAAQ,IAAM,CACnB,IAAMC,GAASN,EAAS,OACxB,OAAI1B,EAAW,aAAa,EACvB8B,IAAU,EAAUE,GACjB,KAAK,KAAKF,GAASE,GAAS,EAAE,EAE/B,KAAK,KAAKF,EAAQE,EAAM,CAChC,GAAG,EAEHP,EAAS,CACR,IAAKK,EAAQA,EAAQ,IAAM,EAC3B,MACCC,IAAS,EACN,KAAK,KAAK,SAAS,mBAAmB,EACtCL,EAAS,GAAGK,EAAO,CAAC,CACzB,GAIF,IAAIE,EAAa,CAChB,OAAAR,EACA,SAAAlB,EACA,SAAAU,EACA,QAAShC,EAAM,GACf,KAAMW,EAAM,SAAS,UAAU,EAAI,WAAaA,EAAM,IACvD,EAEA,GAAI,CAAC,KAAKf,IAAgBe,EAAM,SAAS,UAAU,GAAK,CAACA,EAAM,OAC9D,OAAOqC,EAER,GAAM,CAAE,MAAAC,EAAO,MAAAC,EAAO,QAAAC,EAAS,OAAAC,EAAQ,UAAAC,CAAU,EAAI1C,EAC/C,CAAE,YAAA2C,EAAa,WAAAC,EAAY,WAAAC,CAAW,EAAI9B,EAWhD,GATAsB,EAAa,CACZ,GAAGA,EACH,QAAAG,EACA,WAAY,KAAKvD,GACjB,KAAMI,EAAM,SAAS,KACrB,GAAA2B,EACA,MAAAsB,CACD,EAEItC,EAAM,SAAS,MAAM,EAAG,CAC3B,IAAM8C,EAA2B,mBAE3BC,GACJ,MAFW,KAAK,MAAM,IAAI,yBAAyB,GAEvC,aAAa,CAAE,KAAM,iBAAkB,CAAC,GAAM,CAAC,GAC3D,OAAQC,GAAMA,aAAa,MAAQA,EAAE,SAAS,iBAAiB,CAAC,EAElE,OAAAX,EAAa,CACZ,GAAGA,EACH,gBAAiBU,EACf,OACCC,GACAA,EAAE,OAAO,WAAa,mBACtBA,EAAE,QAAQ,KAAOF,CACnB,EACC,IACCG,GACA,IAAI,OAAO,KAAK,cAAcA,EAAE,SAAS,EAAI,EAAG,CAC/C,OAAQ,KAAK,KACd,CAAC,CACH,EACC,OAAQA,GAAMA,EAAE,SAAS,iBAAiB,CAAC,CAC9C,EAEOZ,EAGRA,EAAa,CACZ,GAAGA,EACH,GAAIpB,EAAG,MACP,WACCyB,EAAU,OAAO,QACjBD,EAAO,SAAS,OAAQS,GAAWA,EAAO,UAAY,EAAK,EAAE,MAC/D,EAEA,IAAMC,EAAY/C,EAAW,OAAO,EAEpC,SAASgD,EAAaC,EAAMC,EAAMC,EAAO,CACxC,IAAMC,EAAOH,EAAK,KACZI,EAAQH,IAAS,QAAUI,EAASL,EAAK,GAAG,EAAIA,EAAK,GAAG,MAC9D,MAAO,CACN,KAAAG,EACA,MAAAC,EACA,MAAOF,EAAMC,CAAI,EAAE,MACnB,KAAMD,EAAMC,CAAI,EAAE,KAClB,KAAML,GAAaQ,GAAMN,EAAK,IAAI,CACnC,CACD,CAVSO,EAAAR,EAAA,gBAYT,SAASS,EAAMC,EAAUC,EAAQ,CAChC,GAAI,CAACD,EAAS,OAAQ,MAAO,GAC7B,IAAME,EAAOF,EACX,IAAK/B,GAAMkC,GAAOlC,EAAE,MAAM,QAAQ,IAAK,GAAG,EAAE,UAAU,CAAC,CAAC,EACxD,KAAK,EAAE,EACT,OAAKgC,EACE,OAAO,KAAK,KAAK,SAASA,CAAM,QAAQC,cAD3BA,CAErB,CAEA,GATSJ,EAAAC,EAAA,SASL7D,EAAM,SAAS,QAAQ,EAAG,CAC7B,GAAM,CAAE,SAAAkE,EAAU,WAAAC,EAAY,QAAAC,CAAQ,EAAIrD,EAE1C,MAAO,CACN,GAAGsB,EACH,SAAA6B,EACA,WAAYC,EAAW,SAAS,EAAE,WAAW,EAC7C,WAAYN,EAAMhB,CAAU,EAC5B,WAAYgB,EAAMjB,CAAU,EAC5B,YAAaiB,EAAMlB,CAAW,EAC9B,QAAS,CACR,MAAOyB,EAAQ,MACf,QAAS,MAAMC,GAAWD,EAAQ,QAASpE,CAAK,CACjD,EACA,MACCY,IAAiB,QACjB,CAAC,YAAa,SAAU,MAAM,EAAE,IAAK4C,GAAS,CAC7C,IAAMc,EAAO/B,EAAMiB,CAAI,EACvB,OAAKc,EAEElB,EAAakB,EAAM1D,EAAcvC,EAAK,EADrC,CAAE,KAAAmF,EAAM,MAAOnF,GAAMmF,CAAI,EAAE,MAAO,KAAMnF,GAAMmF,CAAI,EAAE,IAAK,CAElE,CAAC,CACH,EAeD,GAZAnB,EAAa,CACZ,GAAGA,EACH,cAAe,CACd,QAAS,GAAGkC,kBACZ,MAAO,GAAGA,gBACV,OAAQ,GAAGA,iBACX,OAAQ,GAAGA,iBACX,OAAQ,GAAGA,gBACZ,EACA,SAAUvE,EAAM,UAAU,IAC3B,EAEIA,EAAM,SAAS,SAAS,EAAG,CAC9B,GAAM,CAAE,SAAAkE,EAAU,YAAAM,EAAa,gBAAAC,CAAgB,EAAI1D,EAC7C,CAAE,QAAA2D,CAAQ,EAAIjC,EACd,CAAE,KAAAkC,EAAM,WAAAC,GAAY,cAAAC,GAAe,MAAAC,EAAM,EAAIJ,EAEnD,MAAO,CACN,GAAGrC,EACH,SAAA6B,EACA,KAAAS,EACA,WAAAC,GACA,cAAAC,GACA,MAAAC,GACA,YAAaN,EAAY,MACzB,gBAAiBC,EAAgB,MACjC,WAAYZ,EAAMhB,CAAU,EAC5B,WAAYgB,EAAMjB,CAAU,EAC5B,YAAaiB,EAAMlB,CAAW,EAC9B,UAAWS,EAAab,EAAM,UAAW3B,EAAcvC,EAAK,CAC7D,EAGD,IAAM0G,EAAY3E,EAAW,YAAY,EACnC,CAAE,WAAA4E,CAAW,EAAIhF,EACjB,CAAE,UAAAiF,EAAW,WAAAC,GAAY,QAAAR,CAAQ,EAAIjC,EACrC,CAAE,QAAA0C,EAAS,MAAAC,GAAO,OAAAC,GAAQ,MAAAP,GAAO,WAAAQ,EAAW,EAAIvE,EAEtD,SAASkD,GAAOsB,EAAK,CACpB,MAAO,OAAOA,EAAI,KAAK,QACxB,CAFS3B,EAAAK,GAAA,UAIT,SAASuB,GAAKC,EAAGC,EAAG,CACnB,OAAOC,EAAcF,EAAGC,CAAC,CAC1B,CAFS9B,EAAA4B,GAAA,QAIT,IAAMI,GAAYlB,GAAS,WAAW,MACpC,IAAK3C,GAAM,KAAK,KAAK,SAAS,OAAO,KAAK,UAAUA,CAAC,CAAC,CAAC,EACvD,OAAO,OAAO,EACd,KAAKyD,EAAI,EACT,IAAIvB,EAAM,EACV,KAAK,EAAE,EAEH4B,GAAStI,GAAO,IAAI,CAAC,CAAE,KAAA+F,EAAM,KAAAwC,CAAK,EAAGC,KAAW,CACrD,MAAAA,EACA,KAAAD,EACA,MAAO,KAAK,KAAK,SAChB,OAAO,KAAK,WAAWxC,CAAI,GAAK,qBACjC,EACA,OACEyC,IAAU,EACRjB,GAAM,MACNA,GAAM,YAAY,KAAMkB,GAAMA,EAAE,OAAS1C,CAAI,GAAG,QAAU,CAC/D,EAAE,EAEI2C,GAAgBC,GAAQlG,EAAO,mBAAmB,KAAK,KAAK,IAAI,EAChEmG,IAAa,IAAM,CACxB,IAAIJ,EAAQ,EACZ,GAAIE,KAAkB,OAAWF,EAAQE,WAChC7F,EAAW,aAAa,GAAKyF,GAAO,CAAC,EAAE,QAAU,EAAG,CAC5D,IAAMO,EAAO,CAAE,MAAO,EAAG,MAAOP,GAAO,CAAC,EAAE,KAAM,EAChDE,EAAQF,GAAO,OACd,CAACQ,EAAM,CAAE,MAAA5C,CAAM,EAAGsC,IACjBtC,EAAQ4C,EAAK,MAAQ,CAAE,MAAAN,EAAO,MAAAtC,CAAM,EAAI4C,EACzCD,CACD,EAAE,MAEH,OAAOP,GAAO,OAAOE,EAAO,CAAC,EAAE,CAAC,CACjC,GAAG,EAECO,GAAcT,GAChB,IACA,CAAC,CAAE,MAAApC,EAAO,MAAA8C,EAAO,MAAAR,CAAM,IACtB,sBAAsBA,MAAUQ,MAAU9C,YAC5C,EACC,KAAK,EAAE,EACT,OAAIqB,GAAM,UACTwB,IAAe,OAAO,KAAK,KAAK,SAAS,qBAAqB,MAC7DxB,GAAM,gBAGD,CACN,GAAGzC,EACH,GAAIlB,EAAaD,EAAK,CAAE,IAAK,CAAE,EAC/B,KAAM8D,EACN,MAAAI,GACA,QAAAD,EACA,OAAAE,GACA,QAASJ,EAAU,QACnB,WAAAK,GACA,SAAUhI,GAAUkJ,GAAYxG,CAAK,EAAE,QAAQ,EAC/C,YAAAc,EACA,cACCA,IAAgBiE,IAAc,UAAYK,GAAM,OAASD,EAAQ,OAClE,YAAa/E,EAAW,MAAM,EAC9B,SAAU,KAAK,SACf,MACCQ,IAAiB,QACjB,CAAC,YAAa,SAAU,MAAM,EAAE,IAAK4C,GACpCJ,EAAab,EAAMiB,CAAI,EAAG5C,EAAcvC,EAAK,CAC9C,EACD,OACCwC,IAAkB,QAClB,CAAC,aAAc,UAAW,WAAW,EAAE,IAAK2C,GAC3CJ,EAAapD,EAAM,aAAawD,CAAI,EAAG3C,EAAevC,EAAM,CAC7D,EACD,OAAQ,CACP,KAAM6H,GACN,OAAQG,EACT,EACA,IACCzC,EAAMhB,EAAY,sBAAsB,EACxCgB,EAAMjB,EAAY,sBAAsB,EACxCiB,EAAMlB,EAAa,uBAAuB,EAC3C,OAAQuC,GAAW,OACjB,IAAKnD,GAAMA,EAAE,KAAK,GACjB,IAAIkC,EAAM,EACX,KAAK,EAAE,EACT,UAAA2B,GACA,UAAW5F,EAAM,aAAa,KAC5ByG,GAAUA,EAAM,WAAa,SAAWA,EAAM,GAAG,SAAS,UAAU,CACtE,EACA,SACC,CAAC3F,IACA2B,EAAO,QAAQ,aACdA,EAAO,QAAQ,cAAgBD,EACnC,CACD,CAEA,MAAMkE,EAAU,CAAC,EAAG,CACnB,KAAK,SAAS,IAAI,EAClB,KAAK,OAAO,EAAI,EAChB,KAAK1H,GAAY,GAEjB,KAAKc,GAAa,EAElB,IAAM6G,EAAS,YAAY,cAC3B,GACC,CAACD,EAAQ,OACT,CAAC,CAACC,EAAO,SAAUA,EAAO,KAAK,EAAE,SAAS,KAAK,MAAM,EAErD,OAED,KAAK,OAASA,EAAO,QAErB,IAAM/G,EAAK,KAAK,QAChB,GAAI,CAACA,EACJ,YAAK,OAAS+G,EAAO,OACd,KAAK,OAGb/G,EAAG,IAAI,CAAE,UAAW,CAAE,CAAC,EAEvB,QAAWgH,KAAO,KAAK,YAAY,qBAAqB,EACvD,MAAM,KAAK,QAAQA,EAAI,OAAQ,KAAMhH,CAAE,EAGxCA,EAAG,OAAO,EAEV,KAAK,SAAW,KAChB,KAAK,OAAS+G,EAAO,OACrB,OAAO,GAAG,QAAQ,KAAK,KAAK,CAC7B,CAEA,MAAM,QAAQE,EAAQ,GAAOH,EAAU,CAAC,EAAG,CAC1C,IAAII,EACAC,EACAlH,EACAmH,EACAC,EAEJ,GAAI,KAAKxI,KAAe,KAAKD,GAAQ,CACpC,IAAM0I,EAAU,KAAK,QAAQ,CAAC,EAC9B,GAAIA,EAAS,CACZJ,EAAcI,EAAQ,QAAQ,KAC9BH,EAAmBG,EAAQ,UAC3B,IAAMC,EAAeD,EAAQ,cAAc,iBAAiB,EACxDC,EAAa,UAAU,SAAS,MAAM,IACzCF,EAASE,EAAa,cAAc,QAAQ,EAAE,MAAM,KAAK,GAG3DtH,EAAQ,KAAK,MAAM,CAAC,EAChBA,IAAOmH,EAAiBnH,EAAM,WAMnC,GAHA,MAAM,MAAM,QAAQgH,EAAOH,CAAO,EAClC,GAAG,QAAQ,KAAK,KAAK,EAAI,KAErBI,EAAa,CAChB,IAAMI,EAAU,MAAM,KAAKE,GAAaN,EAAaG,CAAM,EACvDF,EAAmB,GAAGG,EAAQ,UAAUH,CAAgB,EAGzDlH,IACH,KAAK,QAAQ,OAAOA,CAAK,EACrBmH,EAAiB,IAAGnH,EAAM,UAAYmH,IAG3C,KAAKvI,GAAa,KAAKD,GAElB,KAAK,MAAM,QACZ4B,EAAW,UAAU,IAAM,UAAU,KAAK,KAAK,CACpD,CAEA,QAAS,CACJ,KAAK,OAAO,MAAM,OAAO,EAAI,CAClC,CAEA,YAAYiH,EAAM,CACjB,EAAE,MAAM,EAAE,OAAOA,CAAI,EACrB,KAAK,SAAWA,CACjB,CAEA,aAAc,CACb,IAAMhI,EAAQ,KAAKb,GACnB,GAAI,CAACa,EAAO,OAEZ,IAAMiI,EAAU,KAAK,QAAQ,CAAC,EACxBC,EAAQlI,EAAM,eAAe,EAC7BmI,EAAMF,EAAQ,sBAAsB,EACpCG,EAAe,OAAO,4BAC3BpI,EAAM,SAAS,OAChB,EACMM,EAAS,CACd,EAAG8H,EAAa,EAChB,EAAGA,EAAa,EAChB,MAAOpI,EAAM,QAAQ,MAAQkI,EAC7B,OAAQlI,EAAM,QAAQ,OAASkI,EAC/B,IAAI,OAAQ,CACX,OAAO,KAAK,EAAI,KAAK,KACtB,EACA,IAAI,QAAS,CACZ,OAAO,KAAK,EAAI,KAAK,MACtB,CACD,EAEIG,EAEEC,EAAY,KAAK1I,GACpB5B,GAAU+C,EAAW,UAAU,CAAC,EAAE,MAAM,EACxC/C,GAAU+C,EAAW,gBAAgB,CAAC,EAAE,MAAM,EAEjD,KAAOuH,EAAU,QAAU,CAACD,GAAQ,CACnC,IAAME,EAAWD,EAAU,MAAM,EAE7BC,IAAa,QAChBF,EAAS,CACR,EAAG/H,EAAO,EAAI6H,EAAI,MAClB,EAAGK,GAAmBL,EAAK7H,CAAM,CAClC,EACI+H,EAAO,EAAI,IAAGA,EAAS,SACjBE,IAAa,SACvBF,EAAS,CACR,EAAG/H,EAAO,MACV,EAAGkI,GAAmBL,EAAK7H,CAAM,CAClC,EACI+H,EAAO,EAAIF,EAAI,MAAQ,OAAO,aAAYE,EAAS,SAC7CE,IAAa,OACvBF,EAAS,CACR,EAAGI,GAAmBN,EAAK7H,CAAM,EACjC,EAAGA,EAAO,EAAI6H,EAAI,MACnB,EACIE,EAAO,EAAI,IAAGA,EAAS,SACjBE,IAAa,WACvBF,EAAS,CACR,EAAGI,GAAmBN,EAAK7H,CAAM,EACjC,EAAGA,EAAO,MACX,EACI+H,EAAO,EAAIF,EAAI,OAAS,OAAO,cAAaE,EAAS,SAI3D,OAAIA,IACHJ,EAAQ,MAAM,KAAO,GAAGI,EAAO,MAC/BJ,EAAQ,MAAM,IAAM,GAAGI,EAAO,OAGxBA,CACR,CAEA,MAAO,CACN,KAAK3I,GAAQ,EACd,CAEA,OAAO8H,EAAO,CACT,CAACA,IAAU,KAAK,QAAQ,QAAUzG,EAAW,UAAU,IAAM,UAEjE,KAAKrB,GAAQ,GACd,CAEA,kBAAkBsI,EAAM,CACvB,IAAMhI,EAAQ,KAAKb,GACbwB,EAAQX,GAAO,MACrB,GAAI,CAACW,EAAO,OAEZ,IAAMwC,EAAUnD,EAAM,QAChB0I,EAAkB,YAAY,eAEhC3H,EAAW,UAAU,GACxBiH,EAAK,KAAK,uBAAuB,EAAE,KAAK,eAAgB,EAAE,EAG3DA,EAAK,KAAK,yBAAyB,EAAE,GAAG,QAAS,MAAO5H,GAAU,CACjEA,EAAM,eAAe,EAErB,GAAM,CAAE,YAAAuI,EAAa,aAAAC,EAAc,MAAAC,CAAM,EAAIlI,EAAM,OAAO,QACpDmI,EAAY,OAAO,KAAK,OAAO,KAAK,cAAc,EAClDC,EAASpI,EAAM,OAAO,OAAO,MACjC,OAAOmI,EAAU,SAAUA,CAAS,EACpC,IAAKE,IAAW,CAChB,MAAO,KAAK,KAAK,SAAS,OAAO,KAAK,eAAeA,CAAK,CAAC,GAAKA,EAChE,YACC,KAAK,KAAK,SAAS,OAAO,KAAK,mBAAmBA,CAAK,CAAC,GAAK,EAC/D,EAAE,EAEGC,EAAU,MAAM,eAAe7H,EAAa,YAAY,EAAG,CAChE,OAAA2H,EACA,MAAOF,EAAM,KAAK,EAClB,YAAaF,EAAY,KAAK,EAC9B,aAAcxF,GAAWyF,EAAa,KAAK,CAC5C,CAAC,EAEDpI,GACC,GAAGG,EAAM,UAAU,KAAK,KAAK,SAAS,mBAAmB,IACzDsI,EACAtI,CACD,CACD,CAAC,EAEDqH,EAAK,GAAG,YAAa,IAAM,KAAK,WAAW,CAAC,EAE5CA,EAAK,GAAG,aAAc,IAAM,CACtBA,EAAK,KAAK,QAAQ,EAAE,SACrBjH,EAAW,UAAU,IAAM,SAAS,KAAK,KAAK,EAClD,KAAKpB,GAAY,GAClB,CAAC,EAEDqI,EAAK,GAAG,aAAc,IAAM,CAC3B,KAAKrI,GAAY,GACb,OAAKD,IAAS,KAAKL,KACvB,KAAK,MAAM,CACZ,CAAC,EAED2I,EAAK,GAAG,WAAY,IAAM,CAExBhI,EAAM,SACNgI,EAAK,KAAK,mBAAmB,EAAE,QAC/B,CAACA,EAAK,KAAK,UAAU,EAAE,SAGxBA,EAAK,IAAI,UAAW,EAAG,EACvBA,EAAK,IAAI,gBAAiB,MAAM,EAChC,OAAO,iBACN,UACA,IAAM,CACLA,EAAK,IAAI,UAAW,CAAC,EACrBA,EAAK,IAAI,gBAAiB,EAAE,CAC7B,EACA,CAAE,KAAM,EAAK,CACd,EACD,CAAC,EAED,IAAMkB,EAAQlB,EAAK,KAAK,yBAAyB,GAC3B7E,EAAU+F,EAAM,OAAO,eAAe,EAAIA,GAClD,GAAG,QAAU9I,GAAU,CACpC,IAAME,EAASF,EAAM,cACf6I,EAAU3I,EAAO,QAAQ,eAE3BA,EAAO,UAAU,SAAS,SAAS,EACtC,KAAK6I,GAA4B,CAAE,QAAAF,EAAS,MAAA7I,EAAO,UAAW,MAAO,CAAC,EAEtEgJ,GAAc,CAAE,OAAA9I,EAAQ,QAAA2I,EAAS,UAAW,IAAK,CAAC,CAEpD,CAAC,EAEDjB,EACE,KAAK,4BAA4B,EACjC,GAAG,QAAS,KAAKD,GAAa,KAAK,IAAI,CAAC,EAGrC5E,IAEL6E,EACE,KAAK,iCAAiC,EACtC,GAAG,oBAAsB5H,GAAU,CACnCA,EAAM,eAAe,EACrB,IAAM6F,EAAa7F,EAAM,OAAS,QAAU,QAAU,OACtDO,EAAM,gBACLA,EAAM,OAAO,WAAW,aAAesF,EAAa,KAAOA,CAC5D,CACD,CAAC,EAEF+B,EAAK,KAAK,+BAA+B,EAAE,GAAG,QAAU5H,GAAU,CACjE,GAAM,CAAE,iBAAAiJ,EAAkB,gBAAAC,CAAgB,EAAInC,GAAYxG,CAAK,EAEzDsI,EAAU,CACf,CACC,MAAO,UACP,MAAO,KAAK,KAAK,OAAO,uCAAwC,CAC/D,SAAU,KAAK,KAAK,SAAShL,GAAUqL,CAAe,EAAE,KAAK,CAC9D,CAAC,CACF,EACA,CACC,MAAO,aACP,MAAO,KAAK,KAAK,SAASrL,GAAU,WAAW,KAAK,CACrD,EACA,CAAE,MAAO,QAAS,MAAO,KAAK,KAAK,SAASA,GAAU,MAAM,KAAK,CAAE,EACnE,CACC,MAAO,UACP,MAAO,KAAK,KAAK,SAASA,GAAU,QAAQ,KAAK,CAClD,CACD,EAEA,KAAKkL,GAA4B,CAChC,QAAAF,EACA,MAAA7I,EACA,SAAUiJ,EACV,QAAUjF,GAAU,CACfA,IAAU,UACbzD,EAAM,OAAO,CAAE,4BAA6B,EAAK,CAAC,EAElDA,EAAM,OAAO,CACZ,0BAA2ByD,IAAU,UAAY,KAAOA,CACzD,CAAC,CACH,CACD,CAAC,CACF,CAAC,EAED4D,EAAK,KAAK,4BAA4B,EAAE,GAAG,QAAU5H,GAAU,CAC9DA,EAAM,eAAe,EACrB,IAAMmJ,EAAK5I,EAAM,OAAO,WAAW,YAAY,OAAS,GACxD+H,EAAgB,OAAO,CACtB,QAAS,yBAAyBa,KAClC,QAASb,EAAgB,WAAW,CAAE,MAAA/H,CAAM,CAAC,CAC9C,CAAC,CACF,CAAC,EAEDqH,EAAK,KAAK,gCAAgC,EAAE,GAAG,QAAS,MAAO5H,GAAU,CACxEA,EAAM,eAAe,EACrB,IAAIoJ,GACH7I,EAAM,OAAO,WAAW,gBAAgB,OAAS,OAChD,KAAK,EACF,OAAO,MAAM,OAAO6I,EAAQ,GAAG,EAAE,CAAC,CAAC,IAAGA,GAAW,iBACtD,IAAMC,EAAaC,GAAmB,EAChCC,EAAO,MAAM,IAAIF,EAAWD,CAAO,EAAE,SAAS,CAAE,MAAO,EAAK,CAAC,EACnEd,EAAgB,OAAO,CACtB,OAAQ,WAAW,KAAK,KAAK,SAC5B,mCACD,aACA,QAASA,EAAgB,WAAW,CAAE,MAAA/H,CAAM,CAAC,EAC7C,KAAM,MAAM,mBAAmB,KAC/B,MAAO,kBACP,MAAO,CAACgJ,CAAI,CACb,CAAC,CACF,CAAC,EAED3B,EAAK,KAAK,OAAO,EAAE,GAAG,SAAU,MAAO5H,GAAU,CAChD,IAAME,EAASF,EAAM,cACfgE,EAAQ9D,EAAO,cACfsJ,EAAOtJ,EAAO,KAEpBA,EAAO,KAAK,EAERsJ,IAAS,eAAgB,MAAMjJ,EAAM,OAAO,CAAE,CAACiJ,CAAI,EAAGxF,CAAM,CAAC,EAC5D,MAAMzD,EAAM,WAAW,OAAO,CAAE,kBAAmByD,CAAM,CAAC,CAChE,CAAC,EAED4D,EAAK,KAAK,2BAA2B,EAAE,GAAG,oBAAsB5H,GAAU,CACzEA,EAAM,eAAe,EACrB,GAAM,CAAE,IAAAuC,EAAK,MAAAyB,CAAM,EAAIzD,EAAM,WAEvBkJ,EAASzJ,EAAM,OAAS,QAAU,EAAI,GACtC0J,EAAW,KAAK,QAAQ1F,EAAQyF,EAAQ,EAAGlH,CAAG,EAEhDmH,IAAa1F,GAChBzD,EAAM,OAAO,CAAE,oCAAqCmJ,CAAS,CAAC,CAChE,CAAC,EAED9B,EAAK,KAAK,4BAA4B,EAAE,GAAG,QAAU5H,GAAU,CAC9DA,EAAM,eAAe,EACrB,KAAK,KAAK,QAAQ,aAAa,CAAE,OAAQ,CAACO,CAAK,EAAG,OAAQ,CAACX,CAAK,CAAE,CAAC,CACpE,CAAC,EAEDgI,EAAK,KAAK,0BAA0B,EAAE,GAAG,QAAS,MAAO5H,GAAU,CAClEA,EAAM,eAAe,EAErB,IAAM2J,EAAW1I,GAAeV,CAAK,EAEjCoJ,EAAUA,EAAS,OAAO,EAE7B,KAAK,KAAK,QACR,IAAI,YAAY,EAChB,IAAI,CAAE,OAAQ,CAACpJ,CAAK,EAAG,OAAQ,CAACX,CAAK,CAAE,CAAC,CAC5C,CAAC,EAEDgI,EAAK,KAAK,yBAAyB,EAAE,GAAG,QAAU5H,GAAU,CAC3DA,EAAM,eAAe,EACrB,IAAM6E,EAAO7E,EAAM,cAAc,QAAQ,KACzCO,EAAM,MAAMsE,CAAI,EAAE,KAAK,CAAE,MAAA7E,CAAM,CAAC,CACjC,CAAC,EAED4H,EAAK,KAAK,0BAA0B,EAAE,GAAG,QAAU5H,GAAU,CAC5DA,EAAM,eAAe,EACrB,IAAM+D,EAAO/D,EAAM,cAAc,QAAQ,KACzC,GAAI+D,IAAS,YAAa,CACzB,GAAM,CAAE,QAAA6F,EAAS,QAAAC,EAAS,SAAAC,CAAS,EAAI9J,EAEvCA,EAAQ,IAAI,WAAW,QAAS,CAC/B,QAAS,CAAC4J,EACV,QAAAC,EACA,SAAAC,CACD,CAAC,EAEFvJ,EAAM,aAAawD,CAAI,GAAG,KAAK,CAAE,MAAA/D,CAAM,CAAC,CACzC,CAAC,EAED4H,EAAK,KAAK,8BAA8B,EAAE,GAAG,QAAU5H,GAAU,CAChEA,EAAM,eAAe,EACrBO,EAAM,aAAaP,CAAK,CACzB,CAAC,EAED4H,EACE,KAAK,0DAA0D,EAC/D,GAAG,oBAAsB5H,GAAU,CACnCA,EAAM,eAAe,EAErB,IAAM+J,EACL/J,EAAM,cAAc,QAAQ,SAAW,eACpC,QACA,UACEuC,EAAMhC,EAAM,OAAO,WAAWwJ,CAAS,GAAG,IAE3CxH,IACDvC,EAAM,OAAS,QAASO,EAAM,kBAAkBwJ,EAAW,CAAE,IAAAxH,CAAI,CAAC,EACjEhC,EAAM,kBAAkBwJ,CAAS,EACvC,CAAC,EAEFnC,EAAK,KAAK,2BAA2B,EAAE,GAAG,QAAU5H,GAAU,CAC7DA,EAAM,eAAe,EACrBgK,GAAWzJ,CAAK,CACjB,CAAC,EAEDuI,EAAM,OAAO,SAAS,EAAE,GAAG,QAAU9I,GAAU,CAC9C,KAAK+I,GAA4B,CAChC,MAAA/I,EACA,QAASA,EAAM,cAAc,QAAQ,eACrC,UAAW,KACX,QAAUsG,GAAU,CACnB2D,GAAQ1J,EAAO,mBAAmB,KAAK,KAAK,KAAM,OAAO+F,CAAK,CAAC,CAChE,CACD,CAAC,CACF,CAAC,EACF,CAEAyC,GAA4B,CAC3B,QAAAF,EACA,MAAA7I,EACA,QAAAkK,EACA,SAAAjI,EACA,UAAAkI,CACD,EAAG,CACFnB,GAAc,CACb,QAAAH,EACA,OAAQ7I,EAAM,cACd,UAAAmK,EACA,SAAAlI,EACA,OAAQ,GACR,SAAU,IAAM,KAAK,KAAK,EAC1B,QAAAiI,EACA,UAAW,IAAM,KAAK,OAAO,CAC9B,CAAC,CACF,CAEA,MAAM,YAAa,CAClB,IAAIzC,EAAU,KAAK,QACdA,EAAQ,SACRA,EAAQ,KAAK,iBAAiB,EAAE,SAAS,MAAM,IACnDA,EAAU,MAAM,KAAKE,GAAaF,EAAQ,KAAK,EAAE,KAAM,EAAE,GAC1DA,EAAQ,KAAK,iBAAiB,EAAE,KAAK,OAAO,EAAE,MAAM,EAAE,OAAO,EAC7DA,EAAQ,UAAU,CAAC,EACpB,CAEA,KAAME,GAAaN,EAAaG,EAAQ,CACvC,IAAM3D,EACL,OAAOwD,GAAgB,SACpBA,EACAA,EAAY,cAAc,QAAQ,KAElCQ,EAAU,KAAK,QACfJ,EAAU,KAAK,QACbhE,EAASgE,EAAQ,CAAC,GAAG,QAAQ,KAKnC,GAHAA,EAAQ,OAAO,EACfI,EAAQ,KAAK,4BAA4B,EAAE,YAAY,QAAQ,EAE3DpE,IAAWI,GAAQ2D,IAAW,OAAW,CAC5C,KAAK,OAAO,EACZ,OAGD,IAAM5H,EAAQ,KAAKb,GACbwB,EAAQX,EAAM,MACdwK,EAAa5C,IAAW,QAAa7G,EAAW,QAAQ,EACxD,CAAE,QAAA0J,EAAS,aAAAC,CAAa,EAAIvM,GAAS8F,CAAI,EAEzC0G,GAAW,IAAM,CACtB,IAAMC,EAAY7M,GAAkBkG,CAAI,EACxC,GAAK2G,EAEL,OAAO,OAAO,OAAO,KAAK,MAAM,WAAW,OAAO,EAAE,QAASC,GAC5D,OAAO,OAAOA,CAAM,EAAE,OACpBC,GAAWA,EAAO,YAAcF,CAClC,CACD,CACD,GAAG,EAEGG,EACJ,MAAMN,EAAQ,CACd,IAAK,KACL,MAAA9J,EACA,MAAAX,EACA,OAAQ4H,GAAQ,YAAY,CAC7B,CAAC,GAAM,CAAC,EAET,GAAI,CAACmD,EAAK,aAAe,CAACP,GAAc,CAACG,EAAQ,OAChD,OAAO,GAAG,cAAc,KACvBK,EAAS,GAAG/G,UAAc,CAAE,KAAM,KAAK9E,GAAO,IAAK,CAAC,CACrD,EAGD,IAAM8L,EAAc,CACnB,GAAIF,EAAK,aAAe,CAAC,EACzB,KAAM,KAAK,KAAK,KAChB,YAAapK,EAAM,SAAS,WAAW,EACvC,QAASA,EAAM,QACf,WAAYA,EAAM,SAAS,UAAU,CACtC,EAEA,KAAK,KAAK,EAEVsH,EACE,KAAK,wCAAwChE,IAAO,EACpD,SAAS,QAAQ,EACnBgE,EAAUA,EAAQ,CAAC,EAEnB,IAAMiD,EAAUH,EAAK,SAAW,CAAC,EACjCG,EAAQ,KAAKjH,CAAI,EACZlD,EAAW,WAAW,GAAGmK,EAAQ,KAAK,cAAc,EACrDH,EAAK,SAASG,EAAQ,KAAK,SAAS,EAExC,IAAMC,EAAQJ,EAAK,OAAS,CAAC,EAC7BI,EAAM,cAAc,EAAIpK,EAAW,QAAQ,EAAE,KAAK,GAAK,OAEvD,IAAMqK,EAAM,SAAS,cAAc,KAAK,EACxCA,EAAI,UAAY,MAAM,eAAehK,EAAa,SAAS,EAAG,CAC7D,QAAS8J,EAAQ,KAAK,GAAG,EACzB,MAAO,OAAO,QAAQC,CAAK,EACzB,IAAI,CAAC,CAACE,EAAKjH,CAAK,IAAM,GAAGiH,MAAQjH,GAAO,EACxC,KAAK,IAAI,EACX,KAAAH,EACA,OAAA2D,EACA,YAAaoD,EAAS,QAAQ,EAC9B,WAAAR,EACA,QAAAG,EACA,QAAShK,EAAM,QACf,SACC,MAAM,eAAeS,EAAa,YAAY6C,GAAM,EAAGgH,CAAW,GACjE,KAAK,CACR,CAAC,EAEDpD,EAAUuD,EAAI,kBACdnD,EAAQ,OAAOJ,CAAO,EAEtB,IAAMyD,EAAOzD,EAAQ,sBAAsB,EACrCvH,EAAS2H,EAAQ,sBAAsB,EAEzCsD,EACaxK,EAAW,UAAU,IACrB,QAChBwK,EAAOjL,EAAO,EAAIgL,EAAK,MACnBC,EAAO,IAAGA,EAAOjL,EAAO,SAE5BiL,EAAOjL,EAAO,MACViL,EAAOD,EAAK,MAAQ,OAAO,aAAYC,EAAOjL,EAAO,EAAIgL,EAAK,QAGnE,IAAME,EAAY,SAAS,OAAO,iBAAiBvD,CAAO,EAAE,OAAO,EAC7DwD,EAAMjD,GAAmB8C,EAAMhL,EAAQkL,CAAS,EAEtD,OAAA3D,EAAQ,MAAM,KAAO,GAAG0D,MACxB1D,EAAQ,MAAM,IAAM,GAAG4D,MAEvB5D,EAAU,EAAEA,CAAO,EAEnBA,EACE,KAAK,oDAAoD,EACzD,GAAG,QAAUzH,GAAU,CACvBA,EAAM,eAAe,EACrByH,EAAQ,KAAK,8CAA8C,EAAE,IAAI,EAAE,EACnE,KAAKE,GAAa9D,EAAM,EAAE,CAC3B,CAAC,EAEF4D,EACE,KAAK,8CAA8C,EACnD,GAAG,UAAYzH,GAAU,CACrBA,EAAM,MAAQ,SACjB,KAAK2H,GAAa9D,EAAM7D,EAAM,cAAc,MAAM,KAAK,CAAC,CAC1D,CAAC,EAEFyH,EAAQ,KAAK,gCAAgC,EAAE,GAAG,SAAWzH,GAAU,CACtE,IAAM0K,EAAS1K,EAAM,cAAc,QAAQ,SAAS,EAC9C,CAAE,OAAAyK,EAAQ,OAAAa,EAAQ,OAAAC,CAAO,EAAIb,EAAO,QACpCc,EAAYd,EAAO,cAAc,QAAQ,GAAG,OAAS,KAC3DnK,EAAM,iBACLkK,EACAa,EACAC,GAAU,KACVb,EAAO,cAAc,OAAO,EAAE,QAC9Bc,CACD,CACD,CAAC,EAEDlB,EAAa,CAAE,GAAI7C,EAAS,MAAAlH,EAAO,MAAAX,EAAO,IAAK,IAAK,CAAC,EAErD,MAAM,QAAQ,mBAAoBiE,EAAM4D,EAAS,IAAI,EAE9CA,CACR,CACD,EAjpCatD,EAAArF,GAAA,OAmpCb,SAASsJ,GAAmBjI,EAAID,EAAQuL,EAAS,EAAG,CACnD,IAAIC,EAAIxL,EAAO,EAAIA,EAAO,OAAS,EAAIC,EAAG,OAAS,EACnD,OAAIuL,EAAIvL,EAAG,OAAS,OAAO,cAC1BuL,EAAI,OAAO,YAAcvL,EAAG,OAASsL,GAClCC,EAAI,IAAGA,EAAID,GACRC,CACR,CANSvH,EAAAiE,GAAA,sBAQT,SAASC,GAAmBlI,EAAID,EAAQ,CACvC,IAAIoC,EAAIpC,EAAO,EAAIA,EAAO,MAAQ,EAAIC,EAAG,MAAQ,EACjD,OAAImC,EAAInC,EAAG,MAAQ,OAAO,aAAY,EAAI,OAAO,WAAaA,EAAG,OAC7DmC,EAAI,IAAGA,EAAI,GACRA,CACR,CALS6B,EAAAkE,GAAA,sBAOT,SAAStB,GAAYxG,EAAO,CAC3B,IAAMoL,EAAiBpL,EAAM,QAAQ,OAAO,SAAS,SAC/CqL,EACLD,IAAmB,KAAO,UAAYA,GAAkB,UACnDzC,EAAkB3I,EAAM,eAAiB,QAAU,aACzD,MAAO,CACN,gBAAA2I,EACA,iBAAkB0C,EAClB,SAAUA,IAAa,UAAY1C,EAAkB0C,CACtD,CACD,CAVSzH,EAAA4C,GAAA,eC7vCF,IAAM8E,EAAY,iBAErBC,GAAM,KACH,SAASC,GAAOC,EAAU,GAAO,CACvC,OAAOA,EAAUF,IAAK,QAAUA,EACjC,CAFgBG,EAAAF,GAAA,UAIT,SAASG,GAAaC,EAAS,CACjCA,GAAW,CAACL,GACfA,GAAM,IAAIM,GACA,CAACD,GAAWL,KACtBA,GAAI,OAAO,EACXA,GAAM,KAER,CAPgBG,EAAAC,GAAA,gBAST,SAASG,EAAWC,EAAS,CACnC,OAAO,KAAK,SAAS,IAAIT,EAAWS,CAAO,CAC5C,CAFgBL,EAAAI,EAAA,cAIT,SAASE,KAAYC,EAAM,CACjC,IAAMC,EAAOD,EAAK,GAAG,EAAE,EACjBE,EAAY,OAAOD,GAAS,SAE5BE,EAAOD,EAAYF,EAAK,MAAM,EAAG,EAAE,EAAIA,EAC7C,OAAAG,EAAK,QAAQd,CAAS,EAEf,KAAK,KAAKa,EAAY,SAAW,UAAU,EAAEC,EAAK,KAAK,GAAG,EAAGF,CAAI,CACzE,CARgBR,EAAAM,EAAA,YAUT,SAASK,GAAQC,EAAOC,EAAM,CACpC,OAAOD,EAAM,UAAU,KAAK,KAAME,GAASA,EAAK,WAAaD,CAAI,CAClE,CAFgBb,EAAAW,GAAA,WAIT,SAASI,EAAaC,EAAU,CACtC,MAAO,WAAWpB,eAAuBoB,OAC1C,CAFgBhB,EAAAe,EAAA,gBAIT,SAASE,EAASC,EAAK,CAC7B,OAAOA,GAAO,EAAI,IAAIA,IAAQA,CAC/B,CAFgBlB,EAAAiB,EAAA,YAIT,SAASE,GAAQC,EAAKC,EAAM,CAClC,OAAOD,EAAI,QAAQxB,EAAWyB,CAAI,CACnC,CAFgBrB,EAAAmB,GAAA,WAIT,SAASG,GAAQF,EAAKC,EAAME,EAAO,CACzC,OAAOH,EAAI,QAAQxB,EAAWyB,EAAME,CAAK,CAC1C,CAFgBvB,EAAAsB,GAAA,WAIhB,eAAsBE,GACrBC,EACAb,EACA,CAAE,QAAAc,EAAUd,EAAM,QAAS,SAAAe,EAAWf,EAAM,YAAY,CAAE,EAAI,CAAC,EAC9D,CACD,IAAMgB,EAAUH,GAAK,KAAK,EAC1B,OAAKG,EAEY,MAAM,WAAW,WAAWA,EAAS,CACrD,MAAO,GACP,QAASF,EACT,SAAAC,CACD,CAAC,EANoB,EAQtB,CAdsB3B,EAAAwB,GAAA,cClDf,SAASK,IAAsB,CACrCC,GAAS,OAAQ,CAChB,OAAQ,IAAM,CACTC,EAAW,aAAa,IAAM,QAAQC,GAAO,GAAG,WAAW,EAAI,CACpE,EACA,KAAM,IAAM,CACXA,GAAO,GAAG,WAAW,EAAK,CAC3B,CACD,CAAC,EAEDF,GAAS,SAAU,CAClB,KAAM,IAAM,CACXE,GAAO,GAAG,WAAW,CACtB,EACA,SAAU,CACT,CACC,IAAK,OACL,UAAW,CAAC,SAAS,CACtB,CACD,CACD,CAAC,CACF,CArBgBC,EAAAJ,GAAA,uBAuBhB,SAASK,GAAKC,EAAMC,EAAK,CACxB,MAAO,GAAGC,cAAsBF,KAAQC,GACzC,CAFSH,EAAAC,GAAA,QAIT,SAASJ,GAASQ,EAAMC,EAAS,CAAC,EAAG,CACpC,KAAK,YAAY,SAASF,EAAWC,EAAM,CAC1C,KAAMJ,GAAKI,EAAM,MAAM,EACvB,KAAMJ,GAAKI,EAAM,MAAM,EACvB,WAAY,MAAM,sBAAsB,SACxC,GAAGC,CACJ,CAAC,CACF,CAPSN,EAAAH,GAAA,YC1BF,SAASU,IAAmB,CAClC,IAAMC,EACL,KAAK,KAAK,MAAM,KAAMC,GAAMA,EAAE,MAAQ,KAAK,KAAK,MAAM,EAAE,MACxD,MAAM,WAAW,WAKZC,EAAW,CAAC,QAAS,SAAU,QAAS,QAAQ,EACpD,IAAKD,GAAME,EAAS,4BAA4BF,GAAG,CAAC,EACpD,KAAK,IAAI,EACXG,EAAS,SAAU,OAAQF,EAAU,CAAE,MAAO,OAAQ,CAAC,EAEvDE,EAAS,cAAe,QAAS,GAAO,CAAE,MAAO,OAAQ,CAAC,EAE1DA,EAAS,QAAS,QAAS,GAAO,CAAE,MAAO,OAAQ,CAAC,EAEpDA,EAAS,UAAW,QAAS,GAAO,CAAE,MAAO,OAAQ,CAAC,EAKtDA,EAAS,UAAW,QAAS,GAAM,CAAE,SAAUC,EAAa,CAAC,EAE7DD,EAAS,WAAY,OAAQ,QAAS,CACrC,QAAS,CAAC,OAAQ,QAAS,MAAO,QAAQ,CAC3C,CAAC,EAEDA,EAAS,iBAAkB,OAAQ,MAAO,CACzC,QAAS,CAAC,OAAQ,QAAS,MAAO,QAAQ,CAC3C,CAAC,EAEDA,EAAS,QAAS,OAAQ,IAAK,CAC9B,MAAO,CACN,IAAK,EACL,IAAK,IACL,KAAM,EACP,CACD,CAAC,EAEDA,EAAS,QAAS,OAAQ,GAAI,CAC7B,MAAO,CACN,IAAK,GACL,IAAK,GACL,KAAM,CACP,CACD,CAAC,EAEDA,EAAS,cAAe,OAAQ,OAAQ,CACvC,KAAME,GACL,cACAN,EAAO,kBAAoB,qBAC5B,EACA,QAAS,CACR,KAAMM,GAAY,cAAe,cAAc,EAC/C,KAAMA,GACL,cACAN,EAAO,kBAAoB,qBAC5B,EACA,IAAKM,GACJ,cACAN,EAAO,iBAAmB,oBAC3B,CACD,CACD,CAAC,EAEDI,EAAS,WAAY,OAAQ,OAAQ,CACpC,QAAS,CAAC,OAAQ,QAAS,QAAQ,CACpC,CAAC,EAEDA,EAAS,aAAc,QAAS,EAAK,EACrCA,EAAS,eAAgB,QAAS,EAAK,EACvCA,EAAS,eAAgB,QAAS,EAAK,EACvCA,EAAS,aAAc,QAAS,EAAK,EACrCA,EAAS,cAAe,QAAS,EAAK,EACtCA,EAAS,cAAe,QAAS,EAAK,EACtCA,EAAS,YAAa,QAAS,EAAK,EAEpCA,EAAS,UAAW,QAAS,EAAK,EAElCA,EAAS,WAAY,QAAS,EAAI,EAElCA,EAAS,aAAc,QAAS,EAAK,EAIrCA,EAAS,QAAS,OAAQ,QAAS,CAAE,QAAS,CAAC,OAAQ,QAAS,IAAI,CAAE,CAAC,EAEvEA,EAAS,SAAU,OAAQ,OAAQ,CAAE,QAAS,CAAC,OAAQ,QAAS,IAAI,CAAE,CAAC,EAEvEA,EAAS,QAAS,QAAS,EAAK,EAEhCA,EAAS,aAAc,OAAQ,SAAU,CACxC,QAAS,CAAC,OAAQ,SAAU,MAAM,CACnC,CAAC,EAEDA,EAAS,cAAe,QAAS,EAAK,EAEtCA,EAAS,WAAY,QAAS,EAAK,EAEnCA,EAAS,OAAQ,QAAS,EAAK,EAI/BA,EAAS,WAAY,OAAQ,MAAO,CAAE,QAAS,CAAC,OAAQ,OAAQ,KAAK,CAAE,CAAC,EAExEA,EAAS,OAAQ,OAAQ,EAAE,EAI3BA,EAAS,SAAU,OAAQ,EAAE,EAE7BA,EAAS,SAAU,QAAS,EAAK,EAEjCA,EAAS,YAAa,QAAS,EAAI,EAEnCA,EAAS,eAAgB,OAAQ,GAAI,CACpC,MAAO,CACN,IAAK,GACL,IAAK,GACL,KAAM,CACP,CACD,CAAC,EAEDA,EAAS,kBAAmB,QAAS,EAAK,EAE1CA,EAAS,gBAAiB,QAAS,EAAK,EAExCA,EAAS,iBAAkB,QAAS,EAAK,EAEzCA,EAAS,iBAAkB,QAAS,EAAK,EAIzCA,EAAS,UAAW,OAAQ,QAAS,CAAE,QAAS,CAAC,OAAQ,OAAQ,OAAO,CAAE,CAAC,EAI3EA,EAAS,gBAAiB,QAAS,EAAK,EAIxCA,EAAS,aAAc,QAAS,EAAK,EAIrCA,EAAS,cAAe,OAAQ,WAAY,CAC3C,QAAS,CAAC,WAAY,OAAQ,OAAO,CACtC,CAAC,EAEDA,EAAS,YAAa,QAAS,EAAK,EAIpCA,EAAS,YAAa,QAAS,EAAI,CACpC,CA3JgBG,EAAAR,GAAA,oBA6JT,SAASS,GAAqBC,EAAGC,EAAM,CAC7C,IAAMC,EAAMD,EAAK,KAAK,iBAAiBE,IAAY,EAEnD,SAASC,EAAYC,EAAMC,EAAKC,EAAM,KAAM,CAC3C,IAAMC,EAAYd,EAAS,QAAQY,GAAK,EACxCJ,EACE,KAAK,UAAUC,KAAaE,KAAQ,EACpC,QAAQ,aAAa,EACrB,OAAO,IAAIE,KAAOC,MAAcD,IAAM,CACzC,CANST,EAAAM,EAAA,eAQL,KAAK,KAAK,MACbA,EAAY,UAAW,gBAAiB,IAAI,EAG7CA,EAAY,QAAS,gBAAgB,EACrCA,EAAY,WAAY,iBAAiB,EACzCA,EAAY,SAAU,gBAAgB,EACtCA,EAAY,UAAW,gBAAgB,EACvCA,EAAY,aAAc,cAAc,EACxCA,EAAY,cAAe,eAAe,EAC1CA,EAAY,YAAa,eAAe,CAEzC,CAvBgBN,EAAAC,GAAA,wBAyBhB,SAASJ,EAASU,EAAMI,EAAMC,EAAUC,EAAQ,CAAC,EAAG,CACnDC,GAAgB,CACf,KAAAP,EACA,MAAO,SACP,OAAQ,GACR,KAAAI,EACA,QAASC,EACT,GAAGC,CACJ,CAAC,CACF,CATSb,EAAAH,EAAA,YC5KTkB,GAAe,gBAAgB,EAE/B,MAAM,KAAK,QAAS,SAAY,CAC/BC,GAAiB,EACjBC,GAAoB,EAEpB,MAAM,cAAc,CACnB,SAAUC,EAAa,mBAAmB,EAC1C,OAAQA,EAAa,iBAAiB,EACtC,QAASA,EAAa,kBAAkB,EACxC,KAAMA,EAAa,eAAe,CACnC,CAAC,CACF,CAAC,EAED,MAAM,KAAK,QAAS,IAAM,CACrBC,EAAW,SAAS,GAAGC,GAAa,EAAI,EAE5C,KAAK,QAAQ,IAAI,gBAAgB,EAAE,IAAM,CACxC,OAAAC,EACD,CACD,CAAC,EAED,MAAM,GAAG,uBAAwBC,EAAoB,EAErD,MAAM,GAAG,uBAAyBC,GAAa,CAC1CA,EAAS,WAAWF,GAAO,GAAG,MAAM,CACzC,CAAC,EAED,MAAM,GAAG,gCAAiC,CAACG,EAAGC,IAAS,CACtDA,EAAK,QAAQ,CACZ,KAAM,mCACN,KAAM,GAAGC,6BACT,UAAYC,GAAS,CACpB,GAAM,CAAE,WAAAC,CAAW,EAAID,EAAK,KAAK,EACjC,OAAOR,EAAW,SAAS,GAAK,KAAK,OAAO,IAAIS,CAAU,GAAG,OAC9D,EACA,SAAWD,GAAS,CACnB,GAAM,CAAE,WAAAC,CAAW,EAAID,EAAK,KAAK,EACjCE,GAAiBD,CAAU,CAC5B,CACD,CAAC,CACF,CAAC,EAED,IAAME,GAAN,cAAyB,MAAO,CAC/B,MAAM,QAAQC,EAAU,CAAC,EAAG,CAC3B,IAAMN,EAAO,MAAM,QAAQM,CAAO,EAClC,OAAI,OAAON,EAAK,SAAY,aAAYA,EAAK,QAAU,MAAMA,EAAK,QAAQ,GACnEA,CACR,CACD,EANMO,EAAAF,GAAA,cAQN,SAASD,GAAiBI,EAAS,CAClC,IAAMC,EAAQ,KAAK,OAAO,IAAID,CAAO,EACrC,GAAI,CAACC,EAAO,OAEZ,IAAMC,EAAS,IAAIL,GAClB,CACC,MAAO,GAAGI,EAAM,UAAUE,EAAS,oBAAoB,IACvD,QAAS,SAAY,CACpB,IAAMC,EAASC,GAAUJ,CAAK,GAAK,CAAC,EACpC,OAAO,eAAehB,EAAa,gBAAgB,EAAG,CACrD,OAAAmB,EACA,QAASD,EAAS,iBAAiB,CACpC,CAAC,CACF,EACA,QAAS,CAAC,EACV,OAAST,GAAS,CACjBO,EAAM,KAAKC,EAAO,KAAK,EAAIA,EAC3BR,EAAK,GAAG,OAASY,GAAUC,GAAeD,EAAOL,CAAK,CAAC,EACvDP,EACE,KAAK,4BAA4B,EACjC,GAAG,QAAUY,GAAUE,GAAYF,EAAOL,CAAK,CAAC,CACnD,EACA,MAAO,IAAM,CACZ,OAAOA,EAAM,KAAKC,EAAO,KAAK,CAC/B,CACD,EACA,CAAE,OAAQ,MAAO,CAClB,EAAE,OAAO,EAAI,CACd,CA5BSH,EAAAH,GAAA",
  "names": ["arrayToObject", "arr", "fn", "key", "obj", "entry", "k", "__name", "AsyncFunction", "MODULE_ID", "MODULE", "str", "registerModule", "id", "__name", "registerSetting", "options", "arrayToObject", "choice", "settingPath", "MODULE", "__name", "settingPath", "path", "MODULE", "__name", "getSetting", "setting", "createTooltip", "target", "selected", "direction", "onCreate", "onDismiss", "onClick", "content", "cssClass", "locked", "resolve", "tooltipClass", "MODULE", "exist", "el", "dismissTooltip", "value", "label", "tooltip", "getSetting", "c", "event", "__name", "__spreadArray", "to", "from", "pack", "i", "l", "ar", "purry", "fn", "args", "lazy", "diff", "arrayArgs", "ret", "__name", "data", "isTruthy", "data", "__name", "compact", "items", "isTruthy", "__name", "_reduceLazy", "array", "lazy", "indexed", "newArray", "index", "item", "result", "__name", "isArray", "data", "__name", "isObject", "data", "__name", "isString", "data", "__name", "isEmpty", "data", "isArray", "isString", "isObject", "__name", "isNil", "data", "__name", "uniq", "purry", "_uniq", "__name", "array", "_reduceLazy", "lazy", "set", "value", "getSelectedActors", "options", "include", "exclude", "assignedFallback", "actors", "uniq", "t", "assigned", "__name", "htmlQueryAll", "parent", "selectors", "__name", "createHTMLElement", "nodeName", "classes", "dataset", "children", "innerHTML", "element", "key", "value", "v", "isNil", "child", "childElement", "htmlClosest", "ordinalString", "value", "pluralRules", "suffix", "__name", "ErrorPF2e", "message", "objectHasKey", "obj", "key", "__name", "localizer", "prefix", "suffix", "formatArgs", "actionGlyphMap", "getActionGlyph", "action", "value", "sanitized", "actionImgMap", "getActionIcon", "fallback", "sluggify", "text", "options", "setHasElement", "set", "tupleHasValue", "array", "traitSlugToObject", "trait", "dictionary", "traitObject", "objectHasKey", "__name", "createSelfEffectMessage", "item", "rollMode", "ErrorPF2e", "actor", "actionCost", "token", "ChatMessagePF2e", "speaker", "flavor", "getActionGlyph", "t", "traitSlugToObject", "previewLength", "descriptionPreview", "tempDiv", "documentTypes", "linkPattern", "_match", "args", "description", "content", "flags", "messageData", "__name", "getDamageRollClass", "Roll", "__name", "dcAdjustments", "dcByLevel", "calculateDC", "level", "pwol", "rarity", "dc", "dcByLevel", "adjustDCByRarity", "__name", "adjustDCByRarity", "dc", "rarity", "adjustDC", "rarityToDCAdjustment", "__name", "adjustment", "dcAdjustments", "EFFECT_AREA_SHAPES", "MAGIC_TRADITIONS", "spellSlotGroupIdToNumber", "groupId", "numericValue", "__name", "coerceToSpellGroupId", "value", "IdentifyItemPopup", "getItemIdentificationDCs", "item", "$html", "html", "updateButton", "identifiedName", "dcs", "action", "content", "_event", "formData", "status", "__name", "pwol", "notMatchingTraditionModifier", "baseDC", "calculateDC", "rarity", "getDcRarity", "dc", "adjustDCByRarity", "getIdentifyMagicDCs", "result", "traditions", "getMagicTraditions", "key", "MAGIC_TRADITIONS", "traits", "t", "setHasElement", "isRelevantEvent", "event", "__name", "eventToRollParams", "rollType", "key", "skipDefault", "params", "eventToRollMode", "SAVE_TYPES", "inlineSelector", "keyword", "InlineRollLinks", "links", "foundryDoc", "link", "repostButtons", "htmlQueryAll", "button", "newButton", "icon", "event", "target", "parent", "document", "resolveDocument", "html", "l", "pf2Action", "pf2Glyph", "pf2Variant", "pf2Dc", "pf2ShowDc", "pf2Skill", "slug", "sluggify", "visibility", "difficultyClass", "reason", "action", "pf2Check", "pf2Traits", "pf2Label", "pf2Defense", "pf2Adjustment", "pf2Roller", "pf2RollOptions", "overrideTraits", "targetOwner", "resolveActor", "actors", "compact", "rollingActors", "maybeActor", "getSelectedActors", "isSave", "tupleHasValue", "extraRollOptions", "o", "eventRollParams", "eventToRollParams", "checkSlug", "actor", "flatCheck", "dc", "isSavingThrow", "traits", "t", "statistic", "bestSpellcasting", "c", "s", "a", "b", "ErrorPF2e", "targetActor", "dcValue", "adjustment", "calculateDC", "defenseStat", "item", "itemFromDoc", "args", "subtitleLocKey", "getActionGlyph", "createActionOptions", "templateConversion", "pf2EffectArea", "pf2Distance", "pf2TemplateData", "pf2Width", "data", "distance", "flags", "normalSize", "EFFECT_AREA_SHAPES", "messageId", "htmlClosest", "origin", "isEmpty", "defaultVisibility", "flavor", "d", "content", "ChatMessagePF2e", "speaker", "message", "rollLink", "itemId", "__name", "anchor", "itemUuid", "itemByUUID", "extra", "uniq", "actionCost", "MoveLootPopup", "object", "options", "callback", "prompt", "buttonLabel", "_event", "formData", "__name", "detachSubitem", "subitem", "skipConfirm", "parentItem", "ErrorPF2e", "localize", "localizer", "createHTMLElement", "deletePromise", "createPromise", "stack", "keepId", "unownedItemToMessage", "event", "item", "actor", "ChatMessagePF2e", "template", "sluggify", "token", "nearestItem", "htmlClosest", "rollOptions", "templateData", "originalEvent", "rollMode", "eventToRollMode", "chatData", "DEGREE_ADJUSTMENT_AMOUNTS", "DEGREE_OF_SUCCESS_STRINGS", "_getDegreeAdjustment", "getDegreeAdjustment_fn", "_adjustDegreeOfSuccess", "adjustDegreeOfSuccess_fn", "_adjustDegreeByDieValue", "adjustDegreeByDieValue_fn", "_calculateDegreeOfSuccess", "calculateDegreeOfSuccess_fn", "_DegreeOfSuccess", "roll", "dc", "dosAdjustments", "__privateAdd", "t", "d", "__privateMethod", "DegreeOfSuccess", "__name", "degree", "adjustments", "outcome", "label", "amount", "degreeOfSuccess", "__publicField", "RESOLVE_UUID", "useResolve", "actor", "toChat", "content", "__name", "name", "attributes", "system", "sp", "resolve", "fullStamina", "localize", "noResolve", "hasSteel", "item", "templatePath", "str", "html", "selected", "ratio", "newSP", "RANKS", "COVER_UUID", "addNameTooltipListeners", "el", "targetEl", "event", "target", "width", "name", "__name", "getItemFromElement", "actor", "itemId", "parentId", "entryId", "castRank", "item", "getItemFromEvent", "getMacros", "getFlag", "uuid", "macro", "onDroppedMacro", "type", "flag", "macros", "setFlag", "deleteMacro", "index", "getUniqueTarget", "condition", "targets", "filterIn", "value", "filter", "localeCompare", "a", "b", "getCoverEffect", "effect", "popup", "title", "content", "actor", "hud", "getHud", "el", "tmp", "localize", "enriched", "enrichHTML", "consumeLinks", "link", "__name", "showItemSummary", "dataset", "item", "getItemFromElement", "data", "description", "InlineRollLinks", "btn", "popupTitle", "SKILLS", "SUCCESS", "rollRecallKnowledges", "actor", "roll", "dieResult", "dieSuccess", "lores", "skill", "target", "getUniqueTarget", "data", "str", "localize", "standard", "skills", "lore", "skillsDCs", "loresDCs", "progression", "dcs", "slug", "rollSkill", "rkDice", "getSetting", "options", "templatePath", "__name", "rank", "label", "mod", "fakeRoll", "modifier", "RANKS", "dc", "success", "DegreeOfSuccess", "MODULE_ID", "UNTRAINED_IMPROVISATION", "CROWBAR_UUIDS", "BON_MOT_UUID", "NATURAL_MEDICINE_UUID", "FOLLOW_THE_EXPERT_UUID", "LABELS", "ACTIONS_UUIDS", "DUPLICATE_SKILLS", "SKILLS", "actor", "item", "hasFeat", "skill", "action", "slug", "actions", "unslugged", "_", "c", "variant", "agile", "modifiers", "modifier", "SKILLS_SLUGS", "SKILLS_MAP", "skills", "skillActionsUUIDS", "getSkillLabel", "__name", "getSkillsData", "filter", "isCharacter", "noUntrained", "getSetting", "feat", "i", "label", "rank", "mod", "name", "actionsList", "condition", "trained", "passedFilter", "filterIn", "filteredActions", "variants", "a", "b", "localeCompare", "lores", "lore", "loresModifierWidth", "width", "localize", "isFollowingAnExpert", "addSkillsListeners", "el", "token", "hud", "event", "showItemSummary", "following", "source", "target", "skillSlug", "actionName", "map", "variantsDialog", "rollAction", "uuid", "unownedItemToMessage", "effect", "dc", "content", "templatePath", "str", "html", "getMapModifier", "type", "rollOptions", "options", "extrasUUIDS", "getExtrasData", "actor", "filter", "initiative", "localize", "getMacros", "macro", "filterIn", "SKILLS_SLUGS", "slug", "getSkillLabel", "__name", "addExtrasListeners", "el", "token", "hud", "action", "callback", "type", "event", "showItemSummary", "addNameTooltipListeners", "getMacro", "uuid", "deleteMacro", "getSetting", "onDroppedMacro", "item", "unownedItemToMessage", "target", "value", "dailies", "rollRecallKnowledges", "variants", "variantsDialog", "note", "map", "modifiers", "agile", "modifier", "getMapModifier", "SECTIONS_TYPES", "getActionsData", "hud", "actor", "filter", "isCharacter", "sorting", "getSetting", "stances", "getStancesModuleApi", "a", "b", "localeCompare", "heroActions", "getHeroActionsApi", "heroDiff", "isOwner", "rollData", "strikes", "strike", "index", "enrichHTML", "altUsage", "blast", "blasts", "config", "damageType", "damage", "formulaFor", "__name", "outcome", "melee", "sections", "actions", "getCharacterActions", "getNpcActions", "action", "filterIn", "type", "getActionIcon", "orderA", "orderB", "nb", "canTradeHeroActions", "str", "localize", "label", "addActionsListeners", "el", "addNameTooltipListeners", "callback", "selector", "x", "event", "getStrike", "strikeEl", "s", "getUuid", "showItemSummary", "uuid", "description", "name", "popup", "templatePath", "trait", "stance", "item", "getItemFromEvent", "createSelfEffectMessage", "eventToRollMode", "applyActionEffect", "effectUuid", "actionId", "exploration", "id", "api", "modular", "weapon", "target", "value", "baseType", "selection", "objectHasKey", "ammo", "selectors", "_", "blastEl", "element", "dataset", "mapIncreases", "getToolBeltModule", "setting", "module", "getToolBeltApi", "stancesUUIDS", "actionUUID", "actionsUUIDS", "skillActionsUUIDS", "extrasUUIDS", "feats", "inParty", "explorations", "sourceId", "actionCost", "traits", "isExploration", "actionType", "hasAura", "r", "source", "getHazardData", "actor", "system", "details", "traits", "attributes", "stealth", "description", "disable", "routine", "reset", "isComplex", "rollData", "isOwner", "enrich", "__name", "str", "enrichHTML", "trait", "modifier", "getSetting", "addHazardListeners", "el", "event", "action", "showItemSummary", "InlineRollLinks", "ITEMS_TYPES", "getItemsData", "actor", "filter", "contents", "coins", "totalWealth", "bulk", "invested", "isCreature", "openedContainers", "getSetting", "getFlag", "containers", "categories", "item", "type", "containerId", "items", "a", "b", "localeCompare", "i", "container", "contained", "filterIn", "category", "str", "localize", "__name", "addItemsListeners", "el", "token", "hud", "addNameTooltipListeners", "event", "showItemSummary", "flag", "index", "setFlag", "getItemFromEvent", "target", "itemType", "uuid", "img", "itemId", "IdentifyItemPopup", "parentId", "parent", "subitem", "detachSubitem", "content", "menu", "carryType", "handsHeld", "inSlot", "current", "dismissTooltip", "rows", "sendToContainers", "createTooltip", "getSpellsData", "actor", "filter", "focusPool", "showTradition", "getSetting", "pf2eStavesActive", "pf2eDailies", "pf2eDailiesActive", "stavesActive", "chargesPath", "spells", "focuses", "rituals", "hasFocusCantrips", "entries", "entry", "data", "group", "slotId", "spell", "filterIn", "entryId", "tradition", "isFocus", "isCharge", "isInnate", "isPrepared", "isSpontaneous", "isFlexible", "consumable", "itemId", "charges", "dailiesData", "max", "canPayCost", "slotSpells", "isCantrip", "groupNumber", "spellSlotGroupIdToNumber", "active", "expended", "virtual", "uses", "castRank", "MODULE_ID", "sortingSetting", "sort", "a", "b", "localeCompare", "compareEntries", "attacks", "getSpellAttacks", "nb", "str", "localize", "hasSingleSpellAttack", "rank", "ordinalString", "__name", "statistic", "name", "id", "modifier", "mod", "addSpellsListeners", "el", "hud", "addNameTooltipListeners", "event", "showItemSummary", "html", "templatePath", "rollParams", "eventToRollParams", "map", "item", "getItemFromEvent", "change", "points", "groupId", "coerceToSpellGroupId", "collection", "maybeCastRank", "inputPath", "value", "HOVER_EXCEPTIONS", "PLACEMENT_BY_TYPE", "POSITIONS", "ALLIANCES", "SPEEDS", "SIDEBARS", "getActionsData", "addActionsListeners", "getItemsData", "addItemsListeners", "getSpellsData", "addSpellsListeners", "getSkillsData", "addSkillsListeners", "getExtrasData", "addExtrasListeners", "getHazardData", "addHazardListeners", "SAVES", "SKILLS", "HUD", "#token", "#lastToken", "#hoveredToken", "#delay", "#holding", "#closing", "#mousedown", "#lock", "#softLock", "#isObserved", "#hoverTokenHandler", "#mouseeventHandler", "#deleteTokenHandler", "token", "hover", "#tokenEnter", "#tokenLeave", "event", "button", "target", "el", "popup", "#cancelDelay", "isObserved", "actor", "#checkIfObserved", "held", "holding", "getSetting", "isParty", "#cancelClosing", "delay", "close", "templatePath", "getCoverEffect", "distance", "savesSetting", "othersSetting", "isCharacter", "attributes", "hp", "ac", "sp", "useStamina", "showDistance", "fontSize", "unitSplit", "multiplier", "unit", "decimals", "selected", "isTarget", "getUniqueTarget", "status", "statuses", "x", "max", "current", "ratio", "pick", "length", "sharedData", "level", "saves", "isOwner", "system", "itemTypes", "resistances", "weaknesses", "immunities", "BASIC_WAR_ACTIONS_FOLDER", "compendiumFeatures", "d", "i", "action", "showRanks", "getStatistic", "stat", "type", "stats", "slug", "value", "modifier", "RANKS", "__name", "toIWR", "category", "header", "rows", "toInfo", "hardness", "emitsSound", "stealth", "enrichHTML", "save", "MODULE_ID", "collisionDC", "collisionDamage", "details", "crew", "passengers", "pilotingCheck", "speed", "showDeath", "heroPoints", "resources", "perception", "wounded", "dying", "shield", "adjustment", "str", "sort", "a", "b", "localeCompare", "languages", "speeds", "icon", "index", "s", "selectedSpeed", "getFlag", "mainSpeed", "base", "prev", "otherSpeeds", "label", "getAlliance", "entry", "options", "states", "cls", "force", "sidebarType", "sidebarScrolltop", "popupScrollTop", "filter", "sidebar", "filterHeader", "#openSidebar", "html", "element", "scale", "hud", "targetCoords", "coords", "positions", "position", "postionFromTargetY", "postionFromTargetX", "ChatMessagePF2e", "publicNotes", "privateNotes", "blurb", "whitelist", "traits", "trait", "content", "infos", "#createHUDLockedListTooltip", "createTooltip", "originalAlliance", "defaultAlliance", "dc", "formula", "DamageRoll", "getDamageRollClass", "roll", "attr", "change", "newValue", "existing", "ctrlKey", "metaKey", "shiftKey", "condition", "useResolve", "setFlag", "onClick", "direction", "showFilter", "getData", "addListeners", "toggles", "placement", "domain", "toggle", "data", "localize", "contentData", "classes", "style", "tmp", "key", "rect", "left", "elPadding", "top", "option", "itemId", "suboption", "margin", "y", "allianceSource", "alliance", "MODULE_ID", "hud", "getHud", "element", "__name", "enableModule", "enabled", "HUD", "getSetting", "setting", "localize", "args", "data", "useFormat", "keys", "hasFeat", "actor", "uuid", "feat", "templatePath", "template", "modifier", "mod", "getFlag", "doc", "flag", "setFlag", "value", "enrichHTML", "str", "isOwner", "rollData", "htmlStr", "registerKeybindings", "register", "getSetting", "getHud", "__name", "path", "bind", "key", "MODULE_ID", "name", "extras", "registerSettings", "isGM", "x", "statuses", "localize", "register", "enableModule", "settingPath", "__name", "renderSettingsConfig", "_", "html", "tab", "MODULE_ID", "beforeGroup", "name", "key", "dom", "localized", "type", "defValue", "extra", "registerSetting", "registerModule", "registerSettings", "registerKeybindings", "templatePath", "getSetting", "enableModule", "getHud", "renderSettingsConfig", "template", "_", "data", "MODULE_ID", "html", "documentId", "openMacrosDialog", "DataDialog", "options", "__name", "actorId", "actor", "dialog", "localize", "macros", "getMacros", "event", "onDroppedMacro", "deleteMacro"]
}
